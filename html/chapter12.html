<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬ 12 ç« ï¼šå¯¼èˆªæ ˆ Nav2</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ROS2 å®Œå…¨æ•™ç¨‹ï¼šä»åŸç†åˆ°å®è·µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 1 ç« ï¼šROS1 æ ¸å¿ƒæ¦‚å¿µå›é¡¾</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 2 ç« ï¼šROS1 çš„å±€é™æ€§åˆ†æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 3 ç« ï¼šä» ROS1 åˆ° ROS2 çš„è¿ç§»ç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 4 ç« ï¼šROS2 æ¶æ„ä¸è®¾è®¡ç†å¿µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 5 ç« ï¼šèŠ‚ç‚¹ä¸æ‰§è¡Œå™¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 6 ç« ï¼šé€šä¿¡æœºåˆ¶æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 7 ç« ï¼šLaunch ç³»ç»Ÿä¸é…ç½®ç®¡ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 8 ç« ï¼štf2 åæ ‡å˜æ¢æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 9 ç« ï¼šæ—¶é—´åŒæ­¥ä¸å›æ”¾ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 10 ç« ï¼šä¼ æ„Ÿå™¨æ•°æ®å¤„ç†ç®¡é“</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 11 ç« ï¼šSLAM ä¸å®šä½ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 12 ç« ï¼šå¯¼èˆªæ ˆ Nav2</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 13 ç« ï¼šros2_control æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 14 ç« ï¼šMoveIt2 è¿åŠ¨è§„åˆ’</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 15 ç« ï¼šå®æ—¶ç³»ç»Ÿä¸æ€§èƒ½ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 16 ç« ï¼šå®‰å…¨æ€§ä¸è¯Šæ–­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 17 ç« ï¼šä»¿çœŸé›†æˆï¼ˆGazebo/Ignitionï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 18 ç« ï¼šå¤šæœºå™¨äººç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 19 ç« ï¼šè®¡ç®—æœºè§†è§‰ä¸æ·±åº¦å­¦ä¹ </span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 20 ç« ï¼šæœºå™¨äººå¼ºåŒ–å­¦ä¹ </span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 21 ç« ï¼šå¤§è¯­è¨€æ¨¡å‹ä¸å…·èº«æ™ºèƒ½</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 22 ç« ï¼šç¥ç»ç½‘ç»œè¿åŠ¨æ§åˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="12-nav2">ç¬¬ 12 ç« ï¼šå¯¼èˆªæ ˆ Nav2</h1>
<h2 id="_1">ç« èŠ‚å¤§çº²</h2>
<ol>
<li>å¼€ç¯‡æ®µè½</li>
<li>æ–‡å­—è®ºè¿°
   - 12.1 Nav2 æ¶æ„æ¦‚è§ˆ
   - 12.2 è¡Œä¸ºæ ‘ï¼ˆBehavior Treesï¼‰æ¶æ„
   - 12.3 è·¯å¾„è§„åˆ’å™¨è®¾è®¡
   - 12.4 æ§åˆ¶å™¨ä¸è½¨è¿¹è·Ÿè¸ª
   - 12.5 æ¢å¤è¡Œä¸ºä¸å¼‚å¸¸å¤„ç†
   - 12.6 åŠ¨æ€éšœç¢ç‰©å¤„ç†</li>
<li>äº§ä¸šæ¡ˆä¾‹ç ”ç©¶ï¼šFetch Robotics ä»“åº“å¯¼èˆªè§£å†³æ–¹æ¡ˆ</li>
<li>é«˜çº§è¯é¢˜ï¼šç¤¾ä¼šå¯¼èˆªä¸äººæœºå…±å­˜</li>
<li>æœ¬ç« å°ç»“</li>
<li>ç»ƒä¹ é¢˜</li>
<li>å¸¸è§é™·é˜±ä¸é”™è¯¯</li>
<li>æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</li>
</ol>
<hr />
<h2 id="_2">å¼€ç¯‡æ®µè½</h2>
<p>Nav2ï¼ˆNavigation2ï¼‰æ˜¯ ROS2 ä¸­ç”¨äºè‡ªä¸»å¯¼èˆªçš„å®Œæ•´è½¯ä»¶æ ˆï¼Œå®ƒç»§æ‰¿å¹¶æ”¹è¿›äº† ROS1 ä¸­çš„ move_base å¯¼èˆªæ¡†æ¶ã€‚æœ¬ç« å°†æ·±å…¥æ¢è®¨ Nav2 çš„æ ¸å¿ƒæ¶æ„ï¼Œé‡ç‚¹ä»‹ç»è¡Œä¸ºæ ‘ï¼ˆBehavior Treesï¼‰è¿™ä¸€é©å‘½æ€§çš„ä»»åŠ¡ç¼–æ’æœºåˆ¶ï¼Œä»¥åŠå„ç§è·¯å¾„è§„åˆ’å™¨å’Œæ§åˆ¶å™¨çš„è®¾è®¡åŸç†ã€‚é€šè¿‡å­¦ä¹ æœ¬ç« ï¼Œæ‚¨å°†æŒæ¡å¦‚ä½•è®¾è®¡å’Œè°ƒä¼˜å¤æ‚çš„æœºå™¨äººå¯¼èˆªç³»ç»Ÿï¼Œå¤„ç†åŠ¨æ€ç¯å¢ƒä¸­çš„å„ç§æŒ‘æˆ˜ï¼Œå¹¶äº†è§£å·¥ä¸šç•Œåœ¨å¤§è§„æ¨¡éƒ¨ç½²ä¸­çš„æœ€ä½³å®è·µã€‚</p>
<h2 id="121-nav2">12.1 Nav2 æ¶æ„æ¦‚è§ˆ</h2>
<h3 id="_3">ç³»ç»Ÿç»„æˆ</h3>
<p>Nav2 é‡‡ç”¨æ¨¡å—åŒ–è®¾è®¡ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š</p>
<div class="codehilite"><pre><span></span><code>                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Nav2 BT      â”‚
                    â”‚  Navigator     â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                    â”‚                    â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚ Planner â”‚         â”‚Controllerâ”‚         â”‚Recovery â”‚
   â”‚ Server  â”‚         â”‚  Server  â”‚         â”‚ Server  â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                    â”‚                    â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚ Global  â”‚         â”‚  Local   â”‚         â”‚  Spin   â”‚
   â”‚ Costmap â”‚         â”‚ Costmap  â”‚         â”‚ Clear   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="_4">ç”Ÿå‘½å‘¨æœŸç®¡ç†</h3>
<p>Nav2 çš„æ‰€æœ‰èŠ‚ç‚¹éƒ½å®ç°äº† ROS2 çš„ç”Ÿå‘½å‘¨æœŸæ¥å£ï¼Œæ”¯æŒä»¥ä¸‹çŠ¶æ€è½¬æ¢ï¼š</p>
<p>$$
\text{Unconfigured} \xrightarrow{\text{configure}} \text{Inactive} \xrightarrow{\text{activate}} \text{Active}
$$</p>
<p>è¿™ç§è®¾è®¡å…è®¸ç³»ç»Ÿåœ¨è¿è¡Œæ—¶åŠ¨æ€é‡é…ç½®ï¼Œæ— éœ€é‡å¯æ•´ä¸ªå¯¼èˆªæ ˆã€‚ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨ï¼ˆLifecycle Managerï¼‰è´Ÿè´£åè°ƒæ‰€æœ‰èŠ‚ç‚¹çš„çŠ¶æ€è½¬æ¢ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># ç”Ÿå‘½å‘¨æœŸè½¬æ¢åºåˆ—</span>
<span class="n">lifecycle_sequence</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;map_server&#39;</span><span class="p">,</span>
    <span class="s1">&#39;amcl&#39;</span><span class="p">,</span>
    <span class="s1">&#39;controller_server&#39;</span><span class="p">,</span>
    <span class="s1">&#39;planner_server&#39;</span><span class="p">,</span>
    <span class="s1">&#39;recoveries_server&#39;</span><span class="p">,</span>
    <span class="s1">&#39;bt_navigator&#39;</span>
<span class="p">]</span>
</code></pre></div>

<h3 id="_5">åæ ‡ç³»çº¦å®š</h3>
<p>Nav2 éµå¾ª REP-105 åæ ‡ç³»çº¦å®šï¼š</p>
<ul>
<li><strong>map</strong>: å…¨å±€å›ºå®šåæ ‡ç³»ï¼Œç”¨äºé•¿æœŸè·¯å¾„è§„åˆ’</li>
<li><strong>odom</strong>: é‡Œç¨‹è®¡åæ ‡ç³»ï¼ŒçŸ­æœŸå†…è¿ç»­ä½†é•¿æœŸä¼šæ¼‚ç§»</li>
<li><strong>base_link</strong>: æœºå™¨äººæœ¬ä½“åæ ‡ç³»</li>
<li><strong>base_footprint</strong>: æœºå™¨äººåœ¨åœ°é¢çš„æŠ•å½±</li>
</ul>
<p>åæ ‡å˜æ¢å…³ç³»ï¼š
$$
T_{map}^{base} = T_{map}^{odom} \cdot T_{odom}^{base}
$$</p>
<h2 id="122-behavior-trees">12.2 è¡Œä¸ºæ ‘ï¼ˆBehavior Treesï¼‰æ¶æ„</h2>
<h3 id="_6">è¡Œä¸ºæ ‘åŸºç¡€</h3>
<p>è¡Œä¸ºæ ‘æ˜¯ä¸€ç§ç”¨äºæè¿°ä»»åŠ¡æ‰§è¡Œæµç¨‹çš„å±‚æ¬¡åŒ–ç»“æ„ï¼Œç›¸æ¯”ä¼ ç»Ÿçš„æœ‰é™çŠ¶æ€æœºï¼ˆFSMï¼‰ï¼Œå…·æœ‰æ›´å¥½çš„æ¨¡å—åŒ–å’Œå¯é‡ç”¨æ€§ã€‚</p>
<p>åŸºæœ¬èŠ‚ç‚¹ç±»å‹ï¼š</p>
<ol>
<li>
<p><strong>æ§åˆ¶èŠ‚ç‚¹ï¼ˆControl Nodesï¼‰</strong>ï¼š
   - Sequence: é¡ºåºæ‰§è¡Œå­èŠ‚ç‚¹ï¼Œä»»ä¸€å¤±è´¥åˆ™å¤±è´¥
   - Fallback: ä¾æ¬¡å°è¯•å­èŠ‚ç‚¹ï¼Œä»»ä¸€æˆåŠŸåˆ™æˆåŠŸ<br />
   - Parallel: å¹¶è¡Œæ‰§è¡Œå¤šä¸ªå­èŠ‚ç‚¹</p>
</li>
<li>
<p><strong>è£…é¥°èŠ‚ç‚¹ï¼ˆDecorator Nodesï¼‰</strong>ï¼š
   - Inverter: åè½¬å­èŠ‚ç‚¹ç»“æœ
   - RetryUntilSuccessful: é‡è¯•ç›´åˆ°æˆåŠŸ
   - RateController: é™åˆ¶æ‰§è¡Œé¢‘ç‡</p>
</li>
<li>
<p><strong>åŠ¨ä½œèŠ‚ç‚¹ï¼ˆAction Nodesï¼‰</strong>ï¼š
   - ComputePathToPose: è®¡ç®—åˆ°ç›®æ ‡çš„è·¯å¾„
   - FollowPath: è·Ÿè¸ªè·¯å¾„
   - Spin: åŸåœ°æ—‹è½¬</p>
</li>
</ol>
<h3 id="nav2">Nav2 æ ‡å‡†è¡Œä¸ºæ ‘</h3>
<div class="codehilite"><pre><span></span><code><span class="nt">&lt;root</span><span class="w"> </span><span class="na">main_tree_to_execute=</span><span class="s">&quot;MainTree&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;BehaviorTree</span><span class="w"> </span><span class="na">ID=</span><span class="s">&quot;MainTree&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;RecoveryNode</span><span class="w"> </span><span class="na">number_of_retries=</span><span class="s">&quot;6&quot;</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;NavigateRecovery&quot;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;PipelineSequence</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;NavigateWithReplanning&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;RateController</span><span class="w"> </span><span class="na">hz=</span><span class="s">&quot;1.0&quot;</span><span class="nt">&gt;</span>
<span class="w">          </span><span class="nt">&lt;RecoveryNode</span><span class="w"> </span><span class="na">number_of_retries=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;ComputePathToPose</span><span class="w"> </span><span class="na">goal=</span><span class="s">&quot;{goal}&quot;</span><span class="w"> </span><span class="na">path=</span><span class="s">&quot;{path}&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;ClearEntireCostmap</span><span class="w"> </span><span class="na">service_name=</span><span class="s">&quot;global_costmap/clear_entirely&quot;</span><span class="nt">/&gt;</span>
<span class="w">          </span><span class="nt">&lt;/RecoveryNode&gt;</span>
<span class="w">        </span><span class="nt">&lt;/RateController&gt;</span>
<span class="w">        </span><span class="nt">&lt;RecoveryNode</span><span class="w"> </span><span class="na">number_of_retries=</span><span class="s">&quot;1&quot;</span><span class="nt">&gt;</span>
<span class="w">          </span><span class="nt">&lt;FollowPath</span><span class="w"> </span><span class="na">path=</span><span class="s">&quot;{path}&quot;</span><span class="nt">/&gt;</span>
<span class="w">          </span><span class="nt">&lt;ClearEntireCostmap</span><span class="w"> </span><span class="na">service_name=</span><span class="s">&quot;local_costmap/clear_entirely&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/RecoveryNode&gt;</span>
<span class="w">      </span><span class="nt">&lt;/PipelineSequence&gt;</span>
<span class="w">      </span><span class="nt">&lt;SequenceStar</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;RecoveryActions&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;ClearEntireCostmap</span><span class="w"> </span><span class="na">service_name=</span><span class="s">&quot;local_costmap/clear_entirely&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;ClearEntireCostmap</span><span class="w"> </span><span class="na">service_name=</span><span class="s">&quot;global_costmap/clear_entirely&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;Spin</span><span class="w"> </span><span class="na">spin_dist=</span><span class="s">&quot;1.57&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;Wait</span><span class="w"> </span><span class="na">wait_duration=</span><span class="s">&quot;5&quot;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;/SequenceStar&gt;</span>
<span class="w">    </span><span class="nt">&lt;/RecoveryNode&gt;</span>
<span class="w">  </span><span class="nt">&lt;/BehaviorTree&gt;</span>
<span class="nt">&lt;/root&gt;</span>
</code></pre></div>

<h3 id="_7">è‡ªå®šä¹‰è¡Œä¸ºæ ‘èŠ‚ç‚¹</h3>
<p>åˆ›å»ºè‡ªå®šä¹‰ BT èŠ‚ç‚¹éœ€è¦ç»§æ‰¿ç›¸åº”çš„åŸºç±»ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CheckBattery</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">BT</span><span class="o">::</span><span class="n">ConditionNode</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">CheckBattery</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span>
<span class="w">                </span><span class="k">const</span><span class="w"> </span><span class="n">BT</span><span class="o">::</span><span class="n">NodeConfiguration</span><span class="o">&amp;</span><span class="w"> </span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">BT</span><span class="o">::</span><span class="n">ConditionNode</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>

<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">BT</span><span class="o">::</span><span class="n">PortsList</span><span class="w"> </span><span class="n">providedPorts</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">BT</span><span class="o">::</span><span class="n">InputPort</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;min_battery&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">};</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">BT</span><span class="o">::</span><span class="n">NodeStatus</span><span class="w"> </span><span class="n">tick</span><span class="p">()</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">min_battery</span><span class="p">;</span>
<span class="w">    </span><span class="n">getInput</span><span class="p">(</span><span class="s">&quot;min_battery&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">min_battery</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">battery_level_</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">min_battery</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">BT</span><span class="o">::</span><span class="n">NodeStatus</span><span class="o">::</span><span class="n">FAILURE</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">BT</span><span class="o">::</span><span class="n">NodeStatus</span><span class="o">::</span><span class="n">SUCCESS</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="123">12.3 è·¯å¾„è§„åˆ’å™¨è®¾è®¡</h2>
<h3 id="_8">å…¨å±€è§„åˆ’å™¨</h3>
<p>Nav2 æä¾›å¤šç§å…¨å±€è·¯å¾„è§„åˆ’ç®—æ³•ï¼š</p>
<ol>
<li><strong>NavFn Planner</strong>ï¼ˆDijkstra/A*ï¼‰:</li>
</ol>
<p>A* å¯å‘å¼å‡½æ•°ï¼š
   $$
f(n) = g(n) + h(n)
$$
   å…¶ä¸­ $g(n)$ æ˜¯èµ·ç‚¹åˆ°èŠ‚ç‚¹ $n$ çš„å®é™…ä»£ä»·ï¼Œ$h(n)$ æ˜¯èŠ‚ç‚¹ $n$ åˆ°ç›®æ ‡çš„å¯å‘å¼ä¼°è®¡ã€‚</p>
<ol start="2">
<li><strong>Smac Planner</strong> (State Lattice/Hybrid-A*):</li>
</ol>
<p>Hybrid-A* ç»“åˆäº†è¿ç»­ç©ºé—´å’Œç¦»æ•£æœç´¢ï¼š
   $$
\text{State} = (x, y, \theta)
$$</p>
<p>è¿åŠ¨åŸè¯­åŸºäº Dubins æˆ– Reeds-Shepp æ›²çº¿ã€‚</p>
<ol start="3">
<li><strong>Theta* Planner</strong>ï¼ˆä»»æ„è§’åº¦è·¯å¾„ï¼‰:</li>
</ol>
<p>Line-of-sight æ£€æŸ¥å®ç°ä»»æ„è§’åº¦è·¯å¾„ï¼š
   $$
\text{parent}(s) = \begin{cases}
   \text{parent}(s') &amp; \text{if LOS}(\text{parent}(s'), s) \\
   s' &amp; \text{otherwise}
   \end{cases}
$$</p>
<h3 id="_9">è·¯å¾„å¹³æ»‘</h3>
<p>åŸå§‹è·¯å¾„é€šå¸¸éœ€è¦å¹³æ»‘å¤„ç†ä»¥æé«˜å¯æ‰§è¡Œæ€§ï¼š</p>
<ol>
<li>
<p><strong>Simple Smoother</strong>ï¼šåŸºäºæ¢¯åº¦ä¸‹é™çš„å¹³æ»‘
   $$
\min \sum_{i} \alpha |p_i - p_i^{orig}|^2 + \beta |p_{i-1} - 2p_i + p_{i+1}|^2
$$</p>
</li>
<li>
<p><strong>Constrained Smoother</strong>ï¼šä¿æŒéšœç¢ç‰©çº¦æŸçš„å¹³æ»‘</p>
</li>
</ol>
<p>çº¦æŸä¼˜åŒ–é—®é¢˜ï¼š
   $$
\begin{aligned}
   \min_{\{p_i\}} &amp; \sum_{i} w_{smooth} \cdot \text{curvature}(p_i) \\
   \text{s.t.} &amp; \quad \text{distance}(p_i, \text{obstacles}) &gt; d_{min}
   \end{aligned}
$$</p>
<h3 id="costmap">ä»£ä»·åœ°å›¾ï¼ˆCostmapï¼‰</h3>
<p>ä»£ä»·åœ°å›¾æ˜¯è·¯å¾„è§„åˆ’çš„åŸºç¡€ï¼Œå°†ä¼ æ„Ÿå™¨æ•°æ®è½¬æ¢ä¸ºè§„åˆ’å¯ç”¨çš„ä»£ä»·å€¼ï¼š</p>
<div class="codehilite"><pre><span></span><code>ä»£ä»·å€¼èŒƒå›´ï¼š

- 0: è‡ªç”±ç©ºé—´
- 1-252: ä¸åŒç¨‹åº¦çš„ä»£ä»·
- 253: è†¨èƒ€åŠå¾„å†…
- 254: è‡´å‘½éšœç¢ç‰©ï¼ˆç¢°æ’ï¼‰
- 255: æœªçŸ¥åŒºåŸŸ
</code></pre></div>

<p>è†¨èƒ€å‡½æ•°ï¼š
$$
\text{cost}(d) = \begin{cases}
254 &amp; d \leq r_{inscribed} \\
253 \cdot e^{-\alpha(d - r_{inscribed})} &amp; r_{inscribed} &lt; d \leq r_{inflation} \\
0 &amp; d &gt; r_{inflation}
\end{cases}
$$</p>
<h2 id="124">12.4 æ§åˆ¶å™¨ä¸è½¨è¿¹è·Ÿè¸ª</h2>
<h3 id="dwb">DWB æ§åˆ¶å™¨</h3>
<p>Dynamic Window Based (DWB) æ§åˆ¶å™¨åŸºäºåŠ¨æ€çª—å£æ–¹æ³•ï¼Œåœ¨é€Ÿåº¦ç©ºé—´ä¸­æœç´¢æœ€ä¼˜æ§åˆ¶ï¼š</p>
<p>é€Ÿåº¦æœç´¢ç©ºé—´ï¼š
$$
V_s = \{(v, \omega) | v \in [v_{min}, v_{max}], \omega \in [\omega_{min}, \omega_{max}]\}
$$</p>
<p>åŠ¨æ€çª—å£çº¦æŸï¼š
$$
V_d = \{(v, \omega) | v \in [v_c - \dot{v} \cdot \Delta t, v_c + \dot{v} \cdot \Delta t]\}
$$</p>
<p>è¯„ä»·å‡½æ•°ï¼š
$$
G(v, \omega) = \sigma(\alpha \cdot \text{heading}(v, \omega) + \beta \cdot \text{dist}(v, \omega) + \gamma \cdot \text{vel}(v, \omega))
$$</p>
<h3 id="mppi">MPPI æ§åˆ¶å™¨</h3>
<p>Model Predictive Path Integral (MPPI) æ§åˆ¶å™¨ä½¿ç”¨é‡‡æ ·ä¼˜åŒ–æ–¹æ³•ï¼š</p>
<p>æ§åˆ¶åºåˆ—ä¼˜åŒ–ï¼š
$$
u^* = \arg\min_{u} \mathbb{E}[\sum_{t=0}^{T} L(x_t, u_t) + \Phi(x_T)]
$$</p>
<p>æƒé‡æ›´æ–°ï¼š
$$
w_i = \frac{e^{-\frac{1}{\lambda}S_i}}{\sum_j e^{-\frac{1}{\lambda}S_j}}
$$</p>
<h3 id="_10">çº¯è¿½è¸ªæ§åˆ¶å™¨</h3>
<p>Pure Pursuit æ§åˆ¶å™¨é€šè¿‡è·Ÿè¸ªå‰è§†ç‚¹å®ç°è·¯å¾„è·Ÿè¸ªï¼š</p>
<p>è½¬å‘è§’è®¡ç®—ï¼š
$$
\delta = \arctan\left(\frac{2L\sin\alpha}{l_d}\right)
$$</p>
<p>å…¶ä¸­ $L$ æ˜¯è½´è·ï¼Œ$\alpha$ æ˜¯å‰è§†ç‚¹è§’åº¦ï¼Œ$l_d$ æ˜¯å‰è§†è·ç¦»ã€‚</p>
<p>è‡ªé€‚åº”å‰è§†è·ç¦»ï¼š
$$
l_d = k_v \cdot v + l_{d,min}
$$</p>
<h2 id="125">12.5 æ¢å¤è¡Œä¸ºä¸å¼‚å¸¸å¤„ç†</h2>
<h3 id="_11">æ¢å¤è¡Œä¸ºè®¾è®¡</h3>
<p>Nav2 æä¾›äº†å¤šå±‚æ¬¡çš„æ¢å¤æœºåˆ¶æ¥å¤„ç†å¯¼èˆªå¤±è´¥ï¼š</p>
<ol>
<li>
<p><strong>å±€éƒ¨æ¢å¤</strong>ï¼š
   - Clear Costmap: æ¸…é™¤ä»£ä»·åœ°å›¾ä¸­çš„åŠ¨æ€éšœç¢ç‰©
   - Spin: åŸåœ°æ—‹è½¬ä»¥è·å–æ›´å¤šç¯å¢ƒä¿¡æ¯
   - Back Up: åé€€ä¸€å®šè·ç¦»</p>
</li>
<li>
<p><strong>å…¨å±€æ¢å¤</strong>ï¼š
   - Wait: ç­‰å¾…åŠ¨æ€éšœç¢ç‰©ç¦»å¼€
   - Assisted Teleop: è¯·æ±‚äººå·¥å¹²é¢„</p>
</li>
</ol>
<p>æ¢å¤å†³ç­–æ ‘ï¼š</p>
<div class="codehilite"><pre><span></span><code>å¯¼èˆªå¤±è´¥
â”œâ”€â”€ è·¯å¾„è§„åˆ’å¤±è´¥ï¼Ÿ
â”‚   â”œâ”€â”€ æ¸…é™¤å…¨å±€ä»£ä»·åœ°å›¾
â”‚   â””â”€â”€ é‡æ–°è§„åˆ’
â”œâ”€â”€ è·¯å¾„è·Ÿè¸ªå¤±è´¥ï¼Ÿ
â”‚   â”œâ”€â”€ æ¸…é™¤å±€éƒ¨ä»£ä»·åœ°å›¾
â”‚   â”œâ”€â”€ åŸåœ°æ—‹è½¬
â”‚   â””â”€â”€ åé€€é‡è¯•
â””â”€â”€ å¤šæ¬¡å¤±è´¥ï¼Ÿ
    â””â”€â”€ è¯·æ±‚äººå·¥å¹²é¢„
</code></pre></div>

<h3 id="_12">å¼‚å¸¸æ£€æµ‹ä¸å¤„ç†</h3>
<p>å®æ—¶ç›‘æ§å¯¼èˆªçŠ¶æ€ï¼ŒåŠæ—¶æ£€æµ‹å¼‚å¸¸ï¼š</p>
<ol>
<li>
<p><strong>æŒ¯è¡æ£€æµ‹</strong>ï¼š
   $$
\text{oscillation} = \frac{1}{T} \int_0^T |\dot{\theta}(t)| dt &gt; \theta_{threshold}
$$</p>
</li>
<li>
<p><strong>å¡æ­»æ£€æµ‹</strong>ï¼š
   $$
\text{stuck} = |p_t - p_{t-\Delta t}| &lt; \epsilon \quad \forall t \in [t_0, t_0 + T_{stuck}]
$$</p>
</li>
<li>
<p><strong>è·¯å¾„åç¦»æ£€æµ‹</strong>ï¼š
   $$
d_{lateral} = \min_{p \in \text{path}} |p_{robot} - p| &gt; d_{max}
$$</p>
</li>
</ol>
<h3 id="_13">å¤šå±‚å®‰å…¨ä¿éšœ</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SafetyController</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nf">checkCollision</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Trajectory</span><span class="o">&amp;</span><span class="w"> </span><span class="n">traj</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// å±‚çº§1ï¼šå‡ ä½•ç¢°æ’æ£€æµ‹</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">geometricCollisionCheck</span><span class="p">(</span><span class="n">traj</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å±‚çº§2ï¼šåŠ¨æ€éšœç¢ç‰©é¢„æµ‹</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">predictiveCollisionCheck</span><span class="p">(</span><span class="n">traj</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å±‚çº§3ï¼šç´§æ€¥åˆ¶åŠ¨è·ç¦»</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">stop_dist</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">a_max</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">stop_dist</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">clearance</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="126">12.6 åŠ¨æ€éšœç¢ç‰©å¤„ç†</h2>
<h3 id="_14">éšœç¢ç‰©æ£€æµ‹ä¸è·Ÿè¸ª</h3>
<p>ä½¿ç”¨å¤šä¼ æ„Ÿå™¨èåˆè¿›è¡Œéšœç¢ç‰©æ£€æµ‹ï¼š</p>
<div class="codehilite"><pre><span></span><code>ä¼ æ„Ÿå™¨èåˆæ¶æ„ï¼š
LaserScan â”€â”€â”
            â”œâ”€â”€ Obstacle â”€â”€&gt; Tracking â”€â”€&gt; Prediction
PointCloud â”€â”˜    Layer
</code></pre></div>

<p>å¡å°”æ›¼æ»¤æ³¢å™¨è·Ÿè¸ªåŠ¨æ€éšœç¢ç‰©ï¼š</p>
<p>çŠ¶æ€å‘é‡ï¼š
$$
x = [p_x, p_y, v_x, v_y]^T
$$</p>
<p>é¢„æµ‹æ­¥éª¤ï¼š
$$
\begin{aligned}
x_{k|k-1} &amp;= F x_{k-1|k-1} \\
P_{k|k-1} &amp;= F P_{k-1|k-1} F^T + Q
\end{aligned}
$$</p>
<p>æ›´æ–°æ­¥éª¤ï¼š
$$
\begin{aligned}
K_k &amp;= P_{k|k-1} H^T (H P_{k|k-1} H^T + R)^{-1} \\
x_{k|k} &amp;= x_{k|k-1} + K_k(z_k - H x_{k|k-1})
\end{aligned}
$$</p>
<h3 id="_15">é€Ÿåº¦éšœç¢ç‰©æ–¹æ³•</h3>
<p>Velocity Obstacles (VO) ç”¨äºåŠ¨æ€é¿éšœï¼š</p>
<p>é€Ÿåº¦éšœç¢ç‰©é›†åˆï¼š
$$
VO_{A|B} = \{v_A | \exists t \geq 0: p_A + tv_A \in B \oplus -A\}
$$</p>
<p>å¯è¡Œé€Ÿåº¦ç©ºé—´ï¼š
$$
V_{feasible} = V_{reachable} \setminus \bigcup_i VO_{A|O_i}
$$</p>
<h3 id="_16">ç¤¾ä¼šåŠ›æ¨¡å‹</h3>
<p>åœ¨äººç¾¤ä¸­å¯¼èˆªæ—¶ä½¿ç”¨ç¤¾ä¼šåŠ›æ¨¡å‹ï¼š</p>
<p>$$
F_{total} = F_{goal} + \sum_i F_{obstacle}^i + \sum_j F_{social}^j
$$</p>
<p>ç›®æ ‡å¸å¼•åŠ›ï¼š
$$
F_{goal} = k_{goal} \cdot \frac{p_{goal} - p_{robot}}{|p_{goal} - p_{robot}|}
$$</p>
<p>ç¤¾ä¼šæ’æ–¥åŠ›ï¼š
$$
F_{social} = A \cdot e^{(r_{ij} - d_{ij})/B} \cdot \vec{n}_{ij}
$$</p>
<h3 id="_17">æ—¶ç©ºè§„åˆ’</h3>
<p>è€ƒè™‘æ—¶é—´ç»´åº¦çš„è·¯å¾„è§„åˆ’ï¼š</p>
<p>çŠ¶æ€ç©ºé—´æ‰©å±•ï¼š
$$
\text{State} = (x, y, t)
$$</p>
<p>æ—¶ç©ºä»£ä»·å‡½æ•°ï¼š
$$
C(x, y, t) = C_{static}(x, y) + \sum_i C_{dynamic}^i(x, y, t)
$$</p>
<p>åŠ¨æ€éšœç¢ç‰©é¢„æµ‹è½¨è¿¹ï¼š
$$
p_i(t) = p_i(0) + v_i \cdot t + \frac{1}{2} a_i \cdot t^2
$$</p>
<h2 id="fetch-robotics">äº§ä¸šæ¡ˆä¾‹ç ”ç©¶ï¼šFetch Robotics ä»“åº“å¯¼èˆªè§£å†³æ–¹æ¡ˆ</h2>
<h3 id="_18">é¡¹ç›®èƒŒæ™¯</h3>
<p>Fetch Robotics ä¸ºå¤§å‹ç”µå•†ä»“åº“æä¾›è‡ªä¸»ç§»åŠ¨æœºå™¨äººï¼ˆAMRï¼‰è§£å†³æ–¹æ¡ˆï¼Œå…¶ Freight ç³»åˆ—æœºå™¨äººéœ€è¦åœ¨å¤æ‚çš„ä»“åº“ç¯å¢ƒä¸­å®ç° 24/7 ä¸é—´æ–­è¿è¡Œã€‚ä¸»è¦æŒ‘æˆ˜åŒ…æ‹¬ï¼š</p>
<ul>
<li>é«˜å¯†åº¦åŠ¨æ€ç¯å¢ƒï¼ˆäººå‘˜ã€å‰è½¦ã€å…¶ä»–æœºå™¨äººï¼‰</li>
<li>ç‹­çª„é€šé“å¯¼èˆªï¼ˆè¿‡é“å®½åº¦ä»… 1.2mï¼‰</li>
<li>å®æ—¶ä»»åŠ¡è°ƒåº¦ï¼ˆå¹³å‡å“åº”æ—¶é—´ &lt; 30sï¼‰</li>
<li>å¤šæœºå™¨äººåè°ƒï¼ˆå•ä»“åº“ 50+ æœºå™¨äººï¼‰</li>
</ul>
<h3 id="_19">æŠ€æœ¯é€‰å‹å†³ç­–</h3>
<ol>
<li>
<p><strong>å¯¼èˆªæ¡†æ¶é€‰æ‹©</strong>ï¼š
   - ROS1 Navigation Stack â†’ Nav2 è¿ç§»
   - å†³ç­–åŸå› ï¼šç”Ÿå‘½å‘¨æœŸç®¡ç†ã€æ›´å¥½çš„å®æ—¶æ€§ã€è¡Œä¸ºæ ‘çµæ´»æ€§</p>
</li>
<li>
<p><strong>è§„åˆ’å™¨é…ç½®</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="nt">planner_server</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ros__parameters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">planner_plugins</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="s">&quot;GridBased&quot;</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="s">&quot;Lattice&quot;</span><span class="p p-Indicator">]</span>
<span class="w">    </span><span class="nt">GridBased</span><span class="p">:</span>
<span class="w">      </span><span class="nt">plugin</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nav2_navfn_planner/NavfnPlanner&quot;</span>
<span class="w">      </span><span class="nt">use_astar</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">      </span><span class="nt">allow_unknown</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">    </span><span class="nt">Lattice</span><span class="p">:</span>
<span class="w">      </span><span class="nt">plugin</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;nav2_smac_planner/SmacPlannerLattice&quot;</span>
<span class="w">      </span><span class="nt">lattice_filepath</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;warehouse_lattice.json&quot;</span>
<span class="w">      </span><span class="nt">w_smooth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.3</span>
<span class="w">      </span><span class="nt">w_data</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.2</span>
</code></pre></div>

<ol start="3">
<li><strong>æ§åˆ¶å™¨é€‰æ‹©</strong>ï¼š
   - ç›´çº¿æ®µï¼šRegulated Pure Pursuitï¼ˆæ•ˆç‡ä¼˜å…ˆï¼‰
   - è½¬å¼¯/å¯¹æ¥ï¼šMPPI Controllerï¼ˆç²¾åº¦ä¼˜å…ˆï¼‰</li>
</ol>
<h3 id="_20">æ€§èƒ½æŒ‡æ ‡ä¸ä¼˜åŒ–</h3>
<p>å…³é”®æ€§èƒ½æŒ‡æ ‡ï¼ˆKPIsï¼‰ï¼š</p>
<p>| æŒ‡æ ‡ | ç›®æ ‡å€¼ | å®é™…è¾¾æˆ | ä¼˜åŒ–æªæ–½ |</p>
<table>
<thead>
<tr>
<th>æŒ‡æ ‡</th>
<th>ç›®æ ‡å€¼</th>
<th>å®é™…è¾¾æˆ</th>
<th>ä¼˜åŒ–æªæ–½</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¹³å‡é€Ÿåº¦</td>
<td>1.2 m/s</td>
<td>1.15 m/s</td>
<td>åŠ¨æ€é€Ÿåº¦è°ƒèŠ‚</td>
</tr>
<tr>
<td>å®šä½ç²¾åº¦</td>
<td>Â±5 cm</td>
<td>Â±3 cm</td>
<td>UWB è¾…åŠ©å®šä½</td>
</tr>
<tr>
<td>è·¯å¾„æ•ˆç‡</td>
<td>&gt;85%</td>
<td>89%</td>
<td>A* å¯å‘å¼ä¼˜åŒ–</td>
</tr>
<tr>
<td>ç¢°æ’ç‡</td>
<td>&lt;0.01%</td>
<td>0.008%</td>
<td>å¤šå±‚å®‰å…¨æ£€æµ‹</td>
</tr>
<tr>
<td>ç³»ç»Ÿå¯ç”¨æ€§</td>
<td>&gt;99%</td>
<td>99.3%</td>
<td>è‡ªåŠ¨æ¢å¤æœºåˆ¶</td>
</tr>
</tbody>
</table>
<p>ä¼˜åŒ–å®è·µï¼š</p>
<ol>
<li><strong>ä»£ä»·åœ°å›¾åˆ†å±‚</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// é™æ€å±‚ï¼šä»“åº“å¸ƒå±€</span>
<span class="nl">static_layer</span><span class="p">:</span>
<span class="w">  </span><span class="nl">map_topic</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;warehouse_map&quot;</span>
<span class="w">  </span><span class="nl">subscribe_to_updates</span><span class="p">:</span><span class="w"> </span><span class="nb">false</span>

<span class="c1">// åŠ¨æ€å±‚ï¼šå®æ—¶éšœç¢ç‰©</span>
<span class="nl">obstacle_layer</span><span class="p">:</span>
<span class="w">  </span><span class="nl">observation_sources</span><span class="p">:</span><span class="w"> </span><span class="n">laser_scan</span><span class="w"> </span><span class="n">point_cloud</span>
<span class="w">  </span><span class="nl">laser_scan</span><span class="p">:</span>
<span class="w">    </span><span class="nl">clearing</span><span class="p">:</span><span class="w"> </span><span class="nb">true</span>
<span class="w">    </span><span class="nl">marking</span><span class="p">:</span><span class="w"> </span><span class="nb">true</span>
<span class="w">    </span><span class="nl">max_obstacle_height</span><span class="p">:</span><span class="w"> </span><span class="mf">1.8</span>

<span class="c1">// è†¨èƒ€å±‚ï¼šå®‰å…¨è·ç¦»</span>
<span class="nl">inflation_layer</span><span class="p">:</span>
<span class="w">  </span><span class="nl">inflation_radius</span><span class="p">:</span><span class="w"> </span><span class="mf">0.55</span>
<span class="w">  </span><span class="nl">cost_scaling_factor</span><span class="p">:</span><span class="w"> </span><span class="mf">3.0</span>
</code></pre></div>

<ol start="2">
<li><strong>è¡Œä¸ºæ ‘ä¼˜åŒ–</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="cm">&lt;!-- ä»“åº“ç‰¹å®šè¡Œä¸ºæ ‘ --&gt;</span>
<span class="nt">&lt;RecoveryNode</span><span class="w"> </span><span class="na">number_of_retries=</span><span class="s">&quot;3&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;Sequence&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- æ£€æŸ¥è´§æ¶å ç”¨ --&gt;</span>
<span class="w">    </span><span class="nt">&lt;CheckShelfOccupancy</span><span class="w"> </span><span class="na">shelf_id=</span><span class="s">&quot;{target_shelf}&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- åŠ¨æ€é‡è§„åˆ’ --&gt;</span>
<span class="w">    </span><span class="nt">&lt;RateController</span><span class="w"> </span><span class="na">hz=</span><span class="s">&quot;2.0&quot;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;ComputePathToPose</span><span class="w"> </span><span class="na">goal=</span><span class="s">&quot;{goal}&quot;</span><span class="w"> </span><span class="na">path=</span><span class="s">&quot;{path}&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/RateController&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- ç²¾ç¡®å¯¹æ¥ --&gt;</span>
<span class="w">    </span><span class="nt">&lt;PreciseDocking</span><span class="w"> </span><span class="na">tolerance=</span><span class="s">&quot;0.02&quot;</span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/Sequence&gt;</span>
<span class="w">  </span><span class="nt">&lt;ForceSuccess&gt;</span>
<span class="w">    </span><span class="nt">&lt;RequestHumanAssistance/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/ForceSuccess&gt;</span>
<span class="nt">&lt;/RecoveryNode&gt;</span>
</code></pre></div>

<h3 id="_21">è¸©å‘ä¸è§£å†³æ–¹æ¡ˆ</h3>
<ol>
<li><strong>é—®é¢˜ï¼šç‹­çª„é€šé“æŒ¯è¡</strong>
   - ç°è±¡ï¼šæœºå™¨äººåœ¨ 1.2m å®½é€šé“ä¸­å·¦å³æŒ¯è¡
   - åŸå› ï¼šDWB æ§åˆ¶å™¨è¯„åˆ†å‡½æ•°ä¸å¹³è¡¡
   - è§£å†³ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="nt">DWBLocalPlanner</span><span class="p">:</span>
<span class="w">  </span><span class="nt">critics</span><span class="p">:</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">RotateToGoal</span><span class="p">:</span><span class="w"> </span>
<span class="w">        </span><span class="nt">scale</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">32.0</span>
<span class="w">        </span><span class="nt">slowing_factor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5.0</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">Oscillation</span><span class="p">:</span>
<span class="w">        </span><span class="nt">scale</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1.0</span>
<span class="w">        </span><span class="nt">oscillation_reset_dist</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.05</span>
</code></pre></div>

<ol start="2">
<li><strong>é—®é¢˜ï¼šå¤šæœºå™¨äººæ­»é”</strong>
   - ç°è±¡ï¼šç‹­çª„é€šé“ä¸¤æœºå™¨äººç›¸å‘è€Œè¡Œæ­»é”
   - è§£å†³ï¼šå®ç°åˆ†å¸ƒå¼åè°ƒåè®®</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">resolve_deadlock</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">other_robot_id</span><span class="p">):</span>
    <span class="n">priority</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_priority</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">priority</span> <span class="o">&lt;</span> <span class="n">other_priority</span><span class="p">:</span>
        <span class="c1"># åé€€åˆ°æœ€è¿‘çš„é¿è®©ç‚¹</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">navigate_to_passing_zone</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># ç­‰å¾…å¯¹æ–¹é¿è®©</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_clearance</span><span class="p">()</span>
</code></pre></div>

<ol start="3">
<li><strong>é—®é¢˜ï¼šåŠ¨æ€éšœç¢ç‰©è¯¯æ£€</strong>
   - ç°è±¡ï¼šåœ°é¢åå…‰è¢«è¯¯è¯†åˆ«ä¸ºéšœç¢ç‰©
   - è§£å†³ï¼šå¤šä¼ æ„Ÿå™¨æŠ•ç¥¨æœºåˆ¶ + é«˜åº¦è¿‡æ»¤</li>
</ol>
<h3 id="_22">å¤§è§„æ¨¡éƒ¨ç½²ç»éªŒ</h3>
<ol>
<li>
<p><strong>é›†ä¸­å¼åœ°å›¾ç®¡ç†</strong>ï¼š
   - æ‰€æœ‰æœºå™¨äººå…±äº«åŒä¸€é«˜ç²¾åº¦åœ°å›¾
   - å¢é‡æ›´æ–°æœºåˆ¶ï¼ˆä»…ä¼ è¾“å˜åŒ–éƒ¨åˆ†ï¼‰
   - ç‰ˆæœ¬æ§åˆ¶ç¡®ä¿ä¸€è‡´æ€§</p>
</li>
<li>
<p><strong>åˆ†å¸ƒå¼è·¯å¾„åè°ƒ</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FleetCoordinator</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">coordinate_paths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot_paths</span><span class="p">):</span>
        <span class="c1"># æ—¶ç©ºé¢„ç•™è¡¨</span>
        <span class="n">spacetime_map</span> <span class="o">=</span> <span class="n">SpaceTimeMap</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">robot_id</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">robot_paths</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># æ£€æµ‹å†²çª</span>
            <span class="n">conflicts</span> <span class="o">=</span> <span class="n">spacetime_map</span><span class="o">.</span><span class="n">check_conflicts</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">conflicts</span><span class="p">:</span>
                <span class="c1"># åå•†è§£å†³</span>
                <span class="n">resolved_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">negotiate_path</span><span class="p">(</span>
                    <span class="n">robot_id</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">conflicts</span>
                <span class="p">)</span>
                <span class="n">spacetime_map</span><span class="o">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">robot_id</span><span class="p">,</span> <span class="n">resolved_path</span><span class="p">)</span>
</code></pre></div>

<ol start="3">
<li><strong>æ€§èƒ½ç›‘æ§ç³»ç»Ÿ</strong>ï¼š
   - Prometheus + Grafana å®æ—¶ç›‘æ§
   - å…³é”®æŒ‡æ ‡ï¼šCPU ä½¿ç”¨ç‡ã€è§„åˆ’å»¶è¿Ÿã€æ§åˆ¶é¢‘ç‡
   - è‡ªåŠ¨æ€§èƒ½é™çº§ï¼šé«˜è´Ÿè½½æ—¶é™ä½è§„åˆ’é¢‘ç‡</li>
</ol>
<h2 id="_23">é«˜çº§è¯é¢˜ï¼šç¤¾ä¼šå¯¼èˆªä¸äººæœºå…±å­˜</h2>
<h3 id="_24">å‰æ²¿ç ”ç©¶æ–¹å‘</h3>
<h4 id="1-socially-aware-navigation">1. ç¤¾ä¼šæ„ŸçŸ¥å¯¼èˆªï¼ˆSocially-Aware Navigationï¼‰</h4>
<p>ä¼ ç»Ÿå¯¼èˆªå°†äººç±»è§†ä¸ºé™æ€æˆ–åŠ¨æ€éšœç¢ç‰©ï¼Œè€Œç¤¾ä¼šå¯¼èˆªè€ƒè™‘äººç±»çš„ç¤¾ä¼šè§„èŒƒå’Œèˆ’é€‚åº¦ï¼š</p>
<p><strong>ç¤¾ä¼šä»£ä»·å‡½æ•°</strong>ï¼š
$$
C_{social} = w_1 \cdot C_{proximity} + w_2 \cdot C_{visibility} + w_3 \cdot C_{motion} + w_4 \cdot C_{personal_space}
$$</p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li>$C_{proximity}$ï¼šä¸äººçš„è·ç¦»ä»£ä»·</li>
<li>$C_{visibility}$ï¼šè¿›å…¥äººçš„è§†é‡ä»£ä»·  </li>
<li>$C_{motion}$ï¼šç›¸å¯¹è¿åŠ¨æ¨¡å¼ä»£ä»·</li>
<li>$C_{personal_space}$ï¼šä¸ªäººç©ºé—´ä¾µçŠ¯ä»£ä»·</li>
</ul>
<p><strong>Proxemics ç†è®ºåº”ç”¨</strong>ï¼š</p>
<p>Hall's Proxemics ç©ºé—´åŒºåŸŸï¼š</p>
<ul>
<li>äº²å¯†è·ç¦»ï¼ˆ0-0.45mï¼‰ï¼š$C = \infty$ï¼ˆç¦æ­¢è¿›å…¥ï¼‰</li>
<li>ä¸ªäººè·ç¦»ï¼ˆ0.45-1.2mï¼‰ï¼š$C = K_1 \cdot e^{-d/\sigma_1}$</li>
<li>ç¤¾äº¤è·ç¦»ï¼ˆ1.2-3.6mï¼‰ï¼š$C = K_2 \cdot e^{-d/\sigma_2}$</li>
<li>å…¬å…±è·ç¦»ï¼ˆ&gt;3.6mï¼‰ï¼š$C = 0$</li>
</ul>
<h4 id="2">2. äººç±»è¿åŠ¨é¢„æµ‹</h4>
<p><strong>Social LSTM æ¨¡å‹</strong>ï¼š</p>
<p>éšè—çŠ¶æ€æ›´æ–°è€ƒè™‘ç¤¾ä¼šæ± åŒ–ï¼š
$$
h_i^t = \text{LSTM}(h_i^{t-1}, e_i^t, S_i^t)
$$</p>
<p>ç¤¾ä¼šæ± åŒ–å±‚ï¼š
$$
S_i^t = \sum_{j \in \mathcal{N}_i} \phi(h_j^{t-1})
$$</p>
<p><strong>Trajectron++ å¤šæ¨¡æ€é¢„æµ‹</strong>ï¼š</p>
<p>æ¡ä»¶æ¦‚ç‡åˆ†å¸ƒï¼š
$$
p(\mathbf{y}^{t+1:t+T}_i | \mathbf{x}^{t-H:t}) = \sum_k \pi_k \mathcal{N}(\mu_k, \Sigma_k)
$$</p>
<h4 id="3">3. æ„å›¾è¯†åˆ«ä¸äº¤äº’</h4>
<p><strong>æ³¨è§†æ–¹å‘ä¼°è®¡</strong>ï¼š
$$
\vec{g} = R(\theta_{head}) \cdot R(\theta_{gaze}) \cdot \vec{e}_z
$$</p>
<p><strong>æ‰‹åŠ¿è¯†åˆ«çŠ¶æ€æœº</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>åœæ­¢æ‰‹åŠ¿ â†’ å‡é€Ÿ â†’ ç­‰å¾…ç¡®è®¤
æŒ¥æ‰‹å¬å”¤ â†’ æ¥è¿‘æ¨¡å¼ â†’ æœåŠ¡äº¤äº’
æŒ‡å‘æ‰‹åŠ¿ â†’ æ–¹å‘ç†è§£ â†’ è·¯å¾„è°ƒæ•´
</code></pre></div>

<h3 id="paper-reading-guide">Paper Reading Guide</h3>
<ol>
<li>
<p><strong>"Socially Aware Motion Planning with Deep Reinforcement Learning"</strong> (IROS 2017)
   - Chen, Chen, Liu et al.
   - å…³é”®è´¡çŒ®ï¼šCADRL ç®—æ³•ï¼Œå¤šæ™ºèƒ½ä½“é¿ç¢°
   - å®ç°è¦ç‚¹ï¼šå€¼å‡½æ•°åˆ†è§£ã€åˆ†å¸ƒå¼è®­ç»ƒ</p>
</li>
<li>
<p><strong>"Social GAN: Socially Acceptable Trajectories with GANs"</strong> (CVPR 2018)
   - Gupta, Johnson et al.
   - å…³é”®è´¡çŒ®ï¼šå¯¹æŠ—è®­ç»ƒç”Ÿæˆç¤¾ä¼šå…¼å®¹è½¨è¿¹
   - å®ç°è¦ç‚¹ï¼šæ± åŒ–æ¨¡å—ã€å˜åˆ†åˆ¤åˆ«å™¨</p>
</li>
<li>
<p><strong>"Robot Navigation in Constrained Pedestrian Environments using RL"</strong> (ICRA 2020)
   - Everett, Chen, How
   - å…³é”®è´¡çŒ®ï¼šSA-CADRLï¼Œè€ƒè™‘è¿åŠ¨å­¦çº¦æŸ
   - å®ç°è¦ç‚¹ï¼šæ³¨æ„åŠ›æœºåˆ¶ã€è¯¾ç¨‹å­¦ä¹ </p>
</li>
</ol>
<h3 id="_25">å¼€æºé¡¹ç›®æ¨è</h3>
<ol>
<li>
<p><strong>SPENCER Robot Platform</strong>
   - æœºåœºç¤¾ä¼šå¯¼èˆªå®Œæ•´æ–¹æ¡ˆ
   - äººç¾¤è·Ÿè¸ªã€ç¾¤ä½“æ£€æµ‹ã€ç¤¾ä¼šåŠ›æ¨¡å‹
   - GitHub: spencer-project/spencer_people_tracking</p>
</li>
<li>
<p><strong>Social Navigation Layers</strong>
   - Nav2 ç¤¾ä¼šå±‚æ’ä»¶
   - ä¸ªäººç©ºé—´å»ºæ¨¡ã€é€šè¿‡åŒºåŸŸæ ‡è®°
   - GitHub: SteveMacenski/social_navigation_layers</p>
</li>
<li>
<p><strong>CrowdNav</strong>
   - å¼ºåŒ–å­¦ä¹ ç¤¾ä¼šå¯¼èˆªä»¿çœŸ
   - å¤šç§ RL ç®—æ³•å®ç°å¯¹æ¯”
   - GitHub: vita-epfl/CrowdNav</p>
</li>
</ol>
<h3 id="_26">æ€§èƒ½æé™ä¼˜åŒ–æŠ€å·§</h3>
<h4 id="1-gpu">1. GPU åŠ é€Ÿäººç¾¤é¢„æµ‹</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// CUDA æ ¸å‡½æ•°ï¼šæ‰¹é‡è½¨è¿¹é¢„æµ‹</span>
<span class="n">__global__</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">predictTrajectories</span><span class="p">(</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">positions</span><span class="p">,</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">velocities</span><span class="p">,</span>
<span class="w">    </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">predictions</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">num_agents</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">horizon</span>
<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">blockIdx</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">blockDim</span><span class="p">.</span><span class="n">x</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">threadIdx</span><span class="p">.</span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">idx</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">num_agents</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ç¤¾ä¼šåŠ›è®¡ç®—</span>
<span class="w">        </span><span class="n">float3</span><span class="w"> </span><span class="n">social_force</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeSocialForce</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span><span class="w"> </span><span class="n">positions</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// è½¨è¿¹ç§¯åˆ†</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">horizon</span><span class="p">;</span><span class="w"> </span><span class="n">t</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">predictions</span><span class="p">[</span><span class="n">idx</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">horizon</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">t</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">                </span><span class="n">integrateMotion</span><span class="p">(</span><span class="n">positions</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="w"> </span>
<span class="w">                               </span><span class="n">velocities</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="w"> </span>
<span class="w">                               </span><span class="n">social_force</span><span class="p">,</span><span class="w"> </span><span class="n">t</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="2_1">2. å®æ—¶æ³¨æ„åŠ›æœºåˆ¶</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">EfficientSocialAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">d_model</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attention</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">MultiheadAttention</span><span class="p">(</span>
            <span class="n">d_model</span><span class="p">,</span> <span class="n">num_heads</span><span class="p">,</span> <span class="n">batch_first</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span>
        <span class="c1"># ç¨€ç–æ³¨æ„åŠ›æ¨¡å¼</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparsity_mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_sparse_mask</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">):</span>
        <span class="c1"># ä»…å…³æ³¨æœ€è¿‘çš„ K ä¸ªé‚»å±…</span>
        <span class="n">top_k</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">topk</span><span class="p">(</span><span class="n">distances</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="n">largest</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">sparse_attn</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention</span><span class="p">(</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">neighbors</span><span class="p">[</span><span class="n">top_k</span><span class="o">.</span><span class="n">indices</span><span class="p">],</span> 
            <span class="n">attn_mask</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sparsity_mask</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">sparse_attn</span>
</code></pre></div>

<h4 id="3_1">3. åˆ†å±‚å†³ç­–æ¶æ„</h4>
<div class="codehilite"><pre><span></span><code><span class="c1"># ä¸‰å±‚å†³ç­–æ¶æ„</span>
<span class="nt">high_level</span><span class="p">:</span>
<span class="w">  </span><span class="nt">frequency</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1 Hz</span>
<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">goal_selection</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">route_planning</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">social_context_analysis</span>

<span class="nt">mid_level</span><span class="p">:</span>
<span class="w">  </span><span class="nt">frequency</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10 Hz</span>
<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">local_planning</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">crowd_navigation</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">gesture_recognition</span>

<span class="nt">low_level</span><span class="p">:</span>
<span class="w">  </span><span class="nt">frequency</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">50 Hz</span>
<span class="w">  </span><span class="nt">tasks</span><span class="p">:</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">collision_avoidance</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">trajectory_tracking</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">emergency_stop</span>
</code></pre></div>

<h3 id="_27">å®é™…åº”ç”¨æ¡ˆä¾‹</h3>
<h4 id="_28">æœåŠ¡æœºå™¨äººå¯¼èˆª</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SocialNavigator</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">comfort_distance</span> <span class="o">=</span> <span class="mf">1.2</span>  <span class="c1"># ç±³</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">social_force_model</span> <span class="o">=</span> <span class="n">SocialForceModel</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">gesture_recognizer</span> <span class="o">=</span> <span class="n">GestureRecognizer</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">plan_social_path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">goal</span><span class="p">,</span> <span class="n">people_tracks</span><span class="p">):</span>
        <span class="c1"># é¢„æµ‹äººç¾¤æœªæ¥è½¨è¿¹</span>
        <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_crowd_motion</span><span class="p">(</span><span class="n">people_tracks</span><span class="p">)</span>

        <span class="c1"># ç”Ÿæˆç¤¾ä¼šå…¼å®¹è·¯å¾„</span>
        <span class="n">path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">astar_social</span><span class="p">(</span>
            <span class="n">start</span><span class="p">,</span> <span class="n">goal</span><span class="p">,</span> 
            <span class="n">static_costmap</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">costmap</span><span class="p">,</span>
            <span class="n">dynamic_costs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">compute_social_costs</span><span class="p">(</span><span class="n">predictions</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># é€Ÿåº¦è°ƒèŠ‚</span>
        <span class="n">velocity_profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adapt_velocity_to_crowd</span><span class="p">(</span>
            <span class="n">path</span><span class="p">,</span> <span class="n">predictions</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">path</span><span class="p">,</span> <span class="n">velocity_profile</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_social_costs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">predictions</span><span class="p">):</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">costmap</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">person_traj</span> <span class="ow">in</span> <span class="n">predictions</span><span class="p">:</span>
            <span class="c1"># Gaussian åˆ†å¸ƒä¸ªäººç©ºé—´</span>
            <span class="n">costs</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">gaussian_personal_space</span><span class="p">(</span>
                <span class="n">person_traj</span><span class="p">,</span> 
                <span class="n">sigma</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">comfort_distance</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">costs</span>
</code></pre></div>

<h2 id="_29">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº† ROS2 å¯¼èˆªæ ˆ Nav2 çš„æ ¸å¿ƒæ¶æ„å’Œå…³é”®æŠ€æœ¯ã€‚ä¸»è¦å†…å®¹åŒ…æ‹¬ï¼š</p>
<h3 id="_30">æ ¸å¿ƒæ¦‚å¿µ</h3>
<ol>
<li>
<p><strong>è¡Œä¸ºæ ‘æ¶æ„</strong>ï¼šç›¸æ¯”ä¼ ç»ŸçŠ¶æ€æœºï¼Œè¡Œä¸ºæ ‘æä¾›äº†æ›´å¥½çš„æ¨¡å—åŒ–ã€å¯é‡ç”¨æ€§å’Œå¯è¯»æ€§ï¼Œæˆä¸º Nav2 ä»»åŠ¡ç¼–æ’çš„æ ¸å¿ƒæœºåˆ¶ã€‚</p>
</li>
<li>
<p><strong>è·¯å¾„è§„åˆ’ç®—æ³•</strong>ï¼š
   - å…¨å±€è§„åˆ’ï¼šNavFn (A<em>/Dijkstra)ã€Smac (Hybrid-A</em>)ã€Theta*
   - è·¯å¾„å¹³æ»‘ï¼šæ¢¯åº¦ä¸‹é™å¹³æ»‘ã€çº¦æŸä¼˜åŒ–å¹³æ»‘
   - ä»£ä»·åœ°å›¾ï¼šåˆ†å±‚æ¶æ„ã€è†¨èƒ€å‡½æ•°è®¾è®¡</p>
</li>
<li>
<p><strong>æ§åˆ¶å™¨è®¾è®¡</strong>ï¼š
   - DWBï¼šåŸºäºåŠ¨æ€çª—å£çš„é€Ÿåº¦ç©ºé—´æœç´¢
   - MPPIï¼šæ¨¡å‹é¢„æµ‹è·¯å¾„ç§¯åˆ†ä¼˜åŒ–
   - Pure Pursuitï¼šå‡ ä½•è·¯å¾„è·Ÿè¸ª</p>
</li>
<li>
<p><strong>æ¢å¤æœºåˆ¶</strong>ï¼šå¤šå±‚æ¬¡æ¢å¤è¡Œä¸ºã€å¼‚å¸¸æ£€æµ‹ã€å®‰å…¨ä¿éšœ</p>
</li>
<li>
<p><strong>åŠ¨æ€é¿éšœ</strong>ï¼š
   - éšœç¢ç‰©è·Ÿè¸ªï¼šå¡å°”æ›¼æ»¤æ³¢
   - é€Ÿåº¦éšœç¢ç‰©ï¼šVO/RVO æ–¹æ³•
   - ç¤¾ä¼šåŠ›æ¨¡å‹ï¼šäººç¾¤å¯¼èˆª
   - æ—¶ç©ºè§„åˆ’ï¼šè€ƒè™‘æ—¶é—´ç»´åº¦</p>
</li>
</ol>
<h3 id="_31">å…³é”®å…¬å¼</h3>
<ul>
<li>A* å¯å‘å¼ï¼š$f(n) = g(n) + h(n)$</li>
<li>è†¨èƒ€å‡½æ•°ï¼š$\text{cost}(d) = 253 \cdot e^{-\alpha(d - r_{inscribed})}$</li>
<li>DWB è¯„ä»·ï¼š$G(v, \omega) = \alpha \cdot \text{heading} + \beta \cdot \text{dist} + \gamma \cdot \text{vel}$</li>
<li>MPPI ä¼˜åŒ–ï¼š$u^* = \arg\min_{u} \mathbb{E}[\sum_{t} L(x_t, u_t)]$</li>
<li>ç¤¾ä¼šåŠ›ï¼š$F_{total} = F_{goal} + \sum F_{obstacle} + \sum F_{social}$</li>
</ul>
<h3 id="_32">å·¥ç¨‹å®è·µè¦ç‚¹</h3>
<ol>
<li>æ ¹æ®ç¯å¢ƒç‰¹ç‚¹é€‰æ‹©åˆé€‚çš„è§„åˆ’å™¨å’Œæ§åˆ¶å™¨ç»„åˆ</li>
<li>åˆç†é…ç½®ä»£ä»·åœ°å›¾å±‚çº§å’Œå‚æ•°</li>
<li>è®¾è®¡é²æ£’çš„æ¢å¤ç­–ç•¥å¤„ç†å¼‚å¸¸</li>
<li>åœ¨äººæœºå…±å­˜ç¯å¢ƒä¸­è€ƒè™‘ç¤¾ä¼šè§„èŒƒ</li>
<li>é€šè¿‡åˆ†å±‚æ¶æ„å®ç°å®æ—¶æ€§èƒ½</li>
</ol>
<h2 id="_33">ç»ƒä¹ é¢˜</h2>
<h3 id="_34">åŸºç¡€é¢˜ï¼ˆç†è§£æ¦‚å¿µï¼‰</h3>
<p><strong>ç»ƒä¹  12.1</strong>ï¼šè§£é‡Šä¸ºä»€ä¹ˆ Nav2 é€‰æ‹©è¡Œä¸ºæ ‘è€Œä¸æ˜¯æœ‰é™çŠ¶æ€æœºä½œä¸ºä»»åŠ¡ç¼–æ’æœºåˆ¶ï¼Ÿè‡³å°‘ç»™å‡ºä¸‰ä¸ªæŠ€æœ¯ä¼˜åŠ¿ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘æ¨¡å—åŒ–ã€å¹¶è¡Œæ‰§è¡Œã€æ¡ä»¶å¤„ç†ã€å¯é‡ç”¨æ€§ç­‰æ–¹é¢ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>è¡Œä¸ºæ ‘ç›¸æ¯”æœ‰é™çŠ¶æ€æœºçš„ä¼˜åŠ¿ï¼š</p>
<ol>
<li>
<p><strong>æ¨¡å—åŒ–å’Œå¯é‡ç”¨æ€§</strong>ï¼šè¡Œä¸ºæ ‘çš„èŠ‚ç‚¹æ˜¯ç‹¬ç«‹çš„æ¨¡å—ï¼Œå¯ä»¥åœ¨ä¸åŒçš„æ ‘ä¸­é‡å¤ä½¿ç”¨ï¼Œè€Œ FSM çš„çŠ¶æ€è½¬æ¢æ˜¯ç´§è€¦åˆçš„ã€‚</p>
</li>
<li>
<p><strong>æ›´å¥½çš„å¹¶è¡Œå¤„ç†</strong>ï¼šParallel èŠ‚ç‚¹å¯ä»¥è‡ªç„¶åœ°è¡¨è¾¾å¹¶è¡Œä»»åŠ¡ï¼Œè€Œ FSM éœ€è¦å¤æ‚çš„çŠ¶æ€ç»„åˆæ¥å®ç°å¹¶è¡Œã€‚</p>
</li>
<li>
<p><strong>æ¡ä»¶å¤„ç†æ›´æ¸…æ™°</strong>ï¼šFallback èŠ‚ç‚¹æä¾›äº†ä¼˜é›…çš„å¤±è´¥å¤„ç†æœºåˆ¶ï¼Œé¿å…äº† FSM ä¸­çš„çŠ¶æ€çˆ†ç‚¸é—®é¢˜ã€‚</p>
</li>
<li>
<p><strong>æ˜“äºè°ƒè¯•å’Œå¯è§†åŒ–</strong>ï¼šæ ‘å½¢ç»“æ„ç›´è§‚å±•ç¤ºæ‰§è¡Œæµç¨‹ï¼Œæ¯ä¸ªèŠ‚ç‚¹è¿”å›æ˜ç¡®çš„çŠ¶æ€ï¼ˆæˆåŠŸ/å¤±è´¥/è¿è¡Œä¸­ï¼‰ã€‚</p>
</li>
<li>
<p><strong>åŠ¨æ€ä¿®æ”¹èƒ½åŠ›</strong>ï¼šå¯ä»¥åœ¨è¿è¡Œæ—¶ä¿®æ”¹è¡Œä¸ºæ ‘ç»“æ„ï¼Œè€Œ FSM é€šå¸¸éœ€è¦é‡æ–°ç¼–è¯‘ã€‚</p>
</li>
</ol>
</details>
<p><strong>ç»ƒä¹  12.2</strong>ï¼šåœ¨ DWB æ§åˆ¶å™¨ä¸­ï¼Œå¦‚æœæœºå™¨äººæœ€å¤§é€Ÿåº¦ä¸º 1.0 m/sï¼Œæœ€å¤§åŠ é€Ÿåº¦ä¸º 0.5 m/sÂ²ï¼Œæ—¶é—´æ­¥é•¿ä¸º 0.1sï¼Œè®¡ç®—åŠ¨æ€çª—å£çš„é€Ÿåº¦èŒƒå›´ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>åŠ¨æ€çª—å£è€ƒè™‘ä¸€ä¸ªæ—¶é—´æ­¥å†…å¯è¾¾çš„é€Ÿåº¦èŒƒå›´ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ç»™å®šï¼š</p>
<ul>
<li>å½“å‰é€Ÿåº¦ï¼š$v_c$ï¼ˆå‡è®¾ä¸º 0.8 m/sï¼‰</li>
<li>æœ€å¤§åŠ é€Ÿåº¦ï¼š$\dot{v} = 0.5$ m/sÂ²</li>
<li>æ—¶é—´æ­¥é•¿ï¼š$\Delta t = 0.1$ s</li>
</ul>
<p>åŠ¨æ€çª—å£é€Ÿåº¦èŒƒå›´ï¼š
$$v \in [v_c - \dot{v} \cdot \Delta t, v_c + \dot{v} \cdot \Delta t]$$
$$v \in [0.8 - 0.5 \times 0.1, 0.8 + 0.5 \times 0.1]$$
$$v \in [0.75, 0.85] \text{ m/s}$$
è€ƒè™‘ç‰©ç†é™åˆ¶ï¼š
$$v \in [\max(0, 0.75), \min(1.0, 0.85)] = [0.75, 0.85] \text{ m/s}$$</p>
</details>
<p><strong>ç»ƒä¹  12.3</strong>ï¼šç»™å®šæœºå™¨äººåŠå¾„ 0.3mï¼Œéšœç¢ç‰©åŠå¾„ 0.2mï¼Œè®¡ç®—ä»£ä»·åœ°å›¾çš„å†…åˆ‡åœ†åŠå¾„ï¼ˆinscribed radiusï¼‰å’Œè†¨èƒ€åŠå¾„ï¼ˆinflation radiusï¼‰ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>å†…åˆ‡åœ†æ˜¯æœºå™¨äººä¸­å¿ƒåˆ°è¾¹ç¼˜çš„è·ç¦»ï¼Œè†¨èƒ€åŠå¾„éœ€è¦è€ƒè™‘å®‰å…¨è£•åº¦ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<ol>
<li>
<p><strong>å†…åˆ‡åœ†åŠå¾„</strong>ï¼š
   - æœºå™¨äººåŠå¾„ï¼š$r_{robot} = 0.3$ m
   - å†…åˆ‡åœ†åŠå¾„ï¼š$r_{inscribed} = r_{robot} = 0.3$ m</p>
</li>
<li>
<p><strong>è†¨èƒ€åŠå¾„</strong>ï¼š
   - åŸºç¡€è†¨èƒ€ï¼š$r_{base} = r_{robot} + r_{obstacle} = 0.3 + 0.2 = 0.5$ m
   - å®‰å…¨è£•åº¦ï¼ˆé€šå¸¸ 20%ï¼‰ï¼š$r_{safety} = 0.2 \times r_{base} = 0.1$ m
   - è†¨èƒ€åŠå¾„ï¼š$r_{inflation} = r_{base} + r_{safety} = 0.6$ m</p>
</li>
<li>
<p><strong>ä»£ä»·åˆ†é…</strong>ï¼š
   - $d \leq 0.3$ mï¼šcost = 254ï¼ˆè‡´å‘½ï¼‰
   - $0.3 &lt; d \leq 0.6$ mï¼šcost = $253 \cdot e^{-\alpha(d-0.3)}$ï¼ˆæ¸å˜ï¼‰
   - $d &gt; 0.6$ mï¼šcost = 0ï¼ˆè‡ªç”±ï¼‰</p>
</li>
</ol>
</details>
<h3 id="_35">æŒ‘æˆ˜é¢˜ï¼ˆæ·±å…¥æ€è€ƒï¼‰</h3>
<p><strong>ç»ƒä¹  12.4</strong>ï¼šè®¾è®¡ä¸€ä¸ªè¡Œä¸ºæ ‘æ¥å¤„ç†ä»¥ä¸‹å¯¼èˆªåœºæ™¯ï¼šæœºå™¨äººéœ€è¦é€šè¿‡ä¸€ä¸ªå¯èƒ½è¢«å ç”¨çš„ç‹­çª„é€šé“ï¼Œå¦‚æœé€šé“è¢«å ç”¨è¶…è¿‡ 30 ç§’ï¼Œéœ€è¦å¯»æ‰¾æ›¿ä»£è·¯å¾„ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>ä½¿ç”¨ Fallbackã€Timeoutã€RetryUntilSuccessful ç­‰èŠ‚ç‚¹ç»„åˆã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="nt">&lt;BehaviorTree</span><span class="w"> </span><span class="na">ID=</span><span class="s">&quot;NarrowPassageNavigation&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;Fallback</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;MainStrategy&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- ç­–ç•¥1ï¼šå°è¯•é€šè¿‡ç‹­çª„é€šé“ --&gt;</span>
<span class="w">    </span><span class="nt">&lt;Sequence</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;TryNarrowPassage&quot;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;CheckPassageClear</span><span class="w"> </span><span class="na">passage_id=</span><span class="s">&quot;narrow_1&quot;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;Timeout</span><span class="w"> </span><span class="na">msec=</span><span class="s">&quot;30000&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;RetryUntilSuccessful</span><span class="w"> </span><span class="na">num_attempts=</span><span class="s">&quot;6&quot;</span><span class="nt">&gt;</span>
<span class="w">          </span><span class="nt">&lt;Sequence&gt;</span>
<span class="w">            </span><span class="nt">&lt;ComputePathThroughPassage</span><span class="w"> </span><span class="na">path=</span><span class="s">&quot;{path}&quot;</span><span class="nt">/&gt;</span>
<span class="w">            </span><span class="nt">&lt;FollowPath</span><span class="w"> </span><span class="na">path=</span><span class="s">&quot;{path}&quot;</span><span class="nt">/&gt;</span>
<span class="w">          </span><span class="nt">&lt;/Sequence&gt;</span>
<span class="w">        </span><span class="nt">&lt;/RetryUntilSuccessful&gt;</span>
<span class="w">      </span><span class="nt">&lt;/Timeout&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Sequence&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- ç­–ç•¥2ï¼šç­‰å¾…å¹¶é‡è¯• --&gt;</span>
<span class="w">    </span><span class="nt">&lt;Sequence</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;WaitAndRetry&quot;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;Wait</span><span class="w"> </span><span class="na">wait_duration=</span><span class="s">&quot;5.0&quot;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;CheckPassageClear</span><span class="w"> </span><span class="na">passage_id=</span><span class="s">&quot;narrow_1&quot;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;ComputePathThroughPassage</span><span class="w"> </span><span class="na">path=</span><span class="s">&quot;{path}&quot;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;FollowPath</span><span class="w"> </span><span class="na">path=</span><span class="s">&quot;{path}&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Sequence&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- ç­–ç•¥3ï¼šå¯»æ‰¾æ›¿ä»£è·¯å¾„ --&gt;</span>
<span class="w">    </span><span class="nt">&lt;Sequence</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;AlternativeRoute&quot;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;SetBlackboard</span><span class="w"> </span><span class="na">key=</span><span class="s">&quot;avoid_passage&quot;</span><span class="w"> </span><span class="na">value=</span><span class="s">&quot;narrow_1&quot;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;ComputePathToPose</span><span class="w"> </span><span class="na">goal=</span><span class="s">&quot;{goal}&quot;</span><span class="w"> </span><span class="na">path=</span><span class="s">&quot;{alt_path}&quot;</span>
<span class="w">                         </span><span class="na">blacklist=</span><span class="s">&quot;{avoid_passage}&quot;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;FollowPath</span><span class="w"> </span><span class="na">path=</span><span class="s">&quot;{alt_path}&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Sequence&gt;</span>
<span class="w">  </span><span class="nt">&lt;/Fallback&gt;</span>
<span class="nt">&lt;/BehaviorTree&gt;</span>
</code></pre></div>

</details>
<p><strong>ç»ƒä¹  12.5</strong>ï¼šå®ç°ä¸€ä¸ªç®€åŒ–çš„ MPPI æ§åˆ¶å™¨ï¼Œç»™å®šä»£ä»·å‡½æ•° $L(x,u) = |x - x_{goal}|^2 + 0.1|u|^2$ï¼Œé‡‡æ · 100 æ¡è½¨è¿¹ï¼Œè®¡ç®—æœ€ä¼˜æ§åˆ¶ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>ä½¿ç”¨é‡è¦æ€§é‡‡æ ·å’ŒåŠ æƒå¹³å‡è®¡ç®—æœ€ä¼˜æ§åˆ¶ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SimpleMPPI</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">lambda_</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">num_samples</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">T</span> <span class="o">=</span> <span class="n">horizon</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lambda_</span> <span class="o">=</span> <span class="n">lambda_</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_control</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">x_goal</span><span class="p">,</span> <span class="n">dynamics</span><span class="p">):</span>
        <span class="c1"># é‡‡æ ·æ§åˆ¶åºåˆ—</span>
        <span class="n">u_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.5</span>

        <span class="c1"># è¯„ä¼°æ¯æ¡è½¨è¿¹</span>
        <span class="n">costs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">)</span>
        <span class="n">trajectories</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x0</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>
            <span class="n">cost</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">T</span><span class="p">):</span>
                <span class="c1"># åº”ç”¨åŠ¨åŠ›å­¦</span>
                <span class="n">x</span> <span class="o">=</span> <span class="n">dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u_samples</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">])</span>
                <span class="n">traj</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

                <span class="c1"># è®¡ç®—ä»£ä»·</span>
                <span class="n">cost</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">x_goal</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
                <span class="n">cost</span> <span class="o">+=</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">u_samples</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">t</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span>

            <span class="n">costs</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">cost</span>
            <span class="n">trajectories</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span>

        <span class="c1"># è®¡ç®—æƒé‡</span>
        <span class="n">min_cost</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">costs</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">costs</span> <span class="o">-</span> <span class="n">min_cost</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">lambda_</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

        <span class="c1"># åŠ æƒå¹³å‡å¾—åˆ°æœ€ä¼˜æ§åˆ¶</span>
        <span class="n">u_optimal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">]</span> <span class="o">*</span> 
                          <span class="n">u_samples</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">u_optimal</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># è¿”å›ç¬¬ä¸€ä¸ªæ§åˆ¶</span>

<span class="c1"># ä½¿ç”¨ç¤ºä¾‹</span>
<span class="k">def</span><span class="w"> </span><span class="nf">simple_dynamics</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
    <span class="c1"># ç®€å•çš„åŒç§¯åˆ†å™¨æ¨¡å‹</span>
    <span class="k">return</span> <span class="n">x</span> <span class="o">+</span> <span class="n">u</span> <span class="o">*</span> <span class="n">dt</span>

<span class="n">mppi</span> <span class="o">=</span> <span class="n">SimpleMPPI</span><span class="p">()</span>
<span class="n">x_current</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">x_goal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">])</span>
<span class="n">u_optimal</span> <span class="o">=</span> <span class="n">mppi</span><span class="o">.</span><span class="n">compute_control</span><span class="p">(</span><span class="n">x_current</span><span class="p">,</span> <span class="n">x_goal</span><span class="p">,</span> <span class="n">simple_dynamics</span><span class="p">)</span>
</code></pre></div>

</details>
<p><strong>ç»ƒä¹  12.6</strong>ï¼šåœ¨ç¤¾ä¼šå¯¼èˆªåœºæ™¯ä¸­ï¼Œæœºå™¨äººæ£€æµ‹åˆ°å‰æ–¹ 2m å¤„æœ‰ä¸€ä¸ªäººä»¥ 0.5 m/s çš„é€Ÿåº¦æ¨ªç©¿ï¼Œè®¾è®¡ä¸€ä¸ªåŸºäºé€Ÿåº¦éšœç¢ç‰©ï¼ˆVOï¼‰çš„é¿è®©ç­–ç•¥ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>è®¡ç®— VO é”¥å½¢åŒºåŸŸï¼Œé€‰æ‹©é”¥å¤–çš„å¯è¡Œé€Ÿåº¦ã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">def</span><span class="w"> </span><span class="nf">compute_velocity_obstacle</span><span class="p">(</span><span class="n">robot_pos</span><span class="p">,</span> <span class="n">human_pos</span><span class="p">,</span> <span class="n">human_vel</span><span class="p">,</span> 
                              <span class="n">robot_radius</span><span class="o">=</span><span class="mf">0.3</span><span class="p">,</span> <span class="n">human_radius</span><span class="o">=</span><span class="mf">0.5</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    è®¡ç®—é€Ÿåº¦éšœç¢ç‰©åŒºåŸŸ</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># ç›¸å¯¹ä½ç½®</span>
    <span class="n">rel_pos</span> <span class="o">=</span> <span class="n">human_pos</span> <span class="o">-</span> <span class="n">robot_pos</span>
    <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rel_pos</span><span class="p">)</span>

    <span class="c1"># Minkowski å’ŒåŠå¾„</span>
    <span class="n">r_sum</span> <span class="o">=</span> <span class="n">robot_radius</span> <span class="o">+</span> <span class="n">human_radius</span>

    <span class="c1"># VO é”¥çš„åŠè§’</span>
    <span class="k">if</span> <span class="n">distance</span> <span class="o">&lt;=</span> <span class="n">r_sum</span><span class="p">:</span>
        <span class="c1"># å·²ç»ç¢°æ’</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">r_sum</span> <span class="o">/</span> <span class="n">distance</span><span class="p">)</span>

    <span class="c1"># VO é”¥çš„ä¸­å¿ƒæ–¹å‘</span>
    <span class="n">center_dir</span> <span class="o">=</span> <span class="n">rel_pos</span> <span class="o">/</span> <span class="n">distance</span>

    <span class="c1"># VO é”¥çš„è¾¹ç•Œæ–¹å‘</span>
    <span class="n">rot_matrix_left</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">theta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span><span class="p">)]</span>
    <span class="p">])</span>
    <span class="n">rot_matrix_right</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">theta</span><span class="p">),</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">theta</span><span class="p">)],</span>
        <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="o">-</span><span class="n">theta</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="o">-</span><span class="n">theta</span><span class="p">)]</span>
    <span class="p">])</span>

    <span class="n">left_bound</span> <span class="o">=</span> <span class="n">rot_matrix_left</span> <span class="o">@</span> <span class="n">center_dir</span>
    <span class="n">right_bound</span> <span class="o">=</span> <span class="n">rot_matrix_right</span> <span class="o">@</span> <span class="n">center_dir</span>

    <span class="c1"># å¹³ç§» VO é”¥ï¼ˆè€ƒè™‘äººçš„é€Ÿåº¦ï¼‰</span>
    <span class="n">vo_apex</span> <span class="o">=</span> <span class="n">human_vel</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="s1">&#39;apex&#39;</span><span class="p">:</span> <span class="n">vo_apex</span><span class="p">,</span>
        <span class="s1">&#39;left_bound&#39;</span><span class="p">:</span> <span class="n">left_bound</span><span class="p">,</span>
        <span class="s1">&#39;right_bound&#39;</span><span class="p">:</span> <span class="n">right_bound</span><span class="p">,</span>
        <span class="s1">&#39;center&#39;</span><span class="p">:</span> <span class="n">center_dir</span>
    <span class="p">}</span>

<span class="k">def</span><span class="w"> </span><span class="nf">select_collision_free_velocity</span><span class="p">(</span><span class="n">vo</span><span class="p">,</span> <span class="n">v_desired</span><span class="p">,</span> <span class="n">v_max</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    é€‰æ‹©é¿å¼€ VO çš„é€Ÿåº¦</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># æ£€æŸ¥æœŸæœ›é€Ÿåº¦æ˜¯å¦åœ¨ VO å†…</span>
    <span class="k">if</span> <span class="n">is_velocity_in_vo</span><span class="p">(</span><span class="n">v_desired</span><span class="p">,</span> <span class="n">vo</span><span class="p">):</span>
        <span class="c1"># å¯»æ‰¾æœ€è¿‘çš„å¯è¡Œé€Ÿåº¦</span>
        <span class="n">candidates</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># é€‰é¡¹1ï¼šæ²¿ VO å·¦è¾¹ç•Œ</span>
        <span class="n">v_left</span> <span class="o">=</span> <span class="n">vo</span><span class="p">[</span><span class="s1">&#39;apex&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">vo</span><span class="p">[</span><span class="s1">&#39;left_bound&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v_max</span>
        <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_left</span><span class="p">)</span>

        <span class="c1"># é€‰é¡¹2ï¼šæ²¿ VO å³è¾¹ç•Œ  </span>
        <span class="n">v_right</span> <span class="o">=</span> <span class="n">vo</span><span class="p">[</span><span class="s1">&#39;apex&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">vo</span><span class="p">[</span><span class="s1">&#39;right_bound&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v_max</span>
        <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_right</span><span class="p">)</span>

        <span class="c1"># é€‰é¡¹3ï¼šå‡é€Ÿ</span>
        <span class="n">v_slow</span> <span class="o">=</span> <span class="n">v_desired</span> <span class="o">*</span> <span class="mf">0.5</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_velocity_in_vo</span><span class="p">(</span><span class="n">v_slow</span><span class="p">,</span> <span class="n">vo</span><span class="p">):</span>
            <span class="n">candidates</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">v_slow</span><span class="p">)</span>

        <span class="c1"># é€‰æ‹©ä¸æœŸæœ›é€Ÿåº¦æœ€æ¥è¿‘çš„</span>
        <span class="n">best_v</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> 
                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">v</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="n">v_desired</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">best_v</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">v_desired</span>

<span class="c1"># åº”ç”¨ç¤ºä¾‹</span>
<span class="n">robot_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">human_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">human_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>  <span class="c1"># æ¨ªç©¿</span>
<span class="n">v_desired</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>   <span class="c1"># æœºå™¨äººæƒ³ç›´è¡Œ</span>

<span class="n">vo</span> <span class="o">=</span> <span class="n">compute_velocity_obstacle</span><span class="p">(</span><span class="n">robot_pos</span><span class="p">,</span> <span class="n">human_pos</span><span class="p">,</span> <span class="n">human_vel</span><span class="p">)</span>
<span class="n">v_safe</span> <span class="o">=</span> <span class="n">select_collision_free_velocity</span><span class="p">(</span><span class="n">vo</span><span class="p">,</span> <span class="n">v_desired</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;å®‰å…¨é€Ÿåº¦: </span><span class="si">{</span><span class="n">v_safe</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

</details>
<p><strong>ç»ƒä¹  12.7</strong>ï¼šè®¾è®¡ä¸€ä¸ªå¤šå±‚æ¢å¤ç­–ç•¥ï¼Œå¤„ç†æœºå™¨äººåœ¨ç”µæ¢¯é—¨å£ç­‰å¾…æ—¶çš„å„ç§å¼‚å¸¸æƒ…å†µã€‚</p>
<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘è¶…æ—¶ã€äººç¾¤æ‹¥æŒ¤ã€ç”µæ¢¯æ•…éšœç­‰æƒ…å†µã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ElevatorNavigationRecovery</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_wait_time</span> <span class="o">=</span> <span class="mi">120</span>  <span class="c1"># ç§’</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">crowd_threshold</span> <span class="o">=</span> <span class="mi">5</span>   <span class="c1"># äººæ•°</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute_recovery_strategy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        å¤šå±‚æ¢å¤ç­–ç•¥</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># å±‚çº§1ï¼šåŸºç¡€ç­‰å¾…</span>
        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;wait_time&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">30</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">basic_wait</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="c1"># å±‚çº§2ï¼šäººç¾¤å¤„ç†</span>
        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;crowd_size&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">crowd_threshold</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_crowded_elevator</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="c1"># å±‚çº§3ï¼šè¶…æ—¶å¤„ç†</span>
        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;wait_time&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_wait_time</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_timeout</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="c1"># å±‚çº§4ï¼šç”µæ¢¯æ•…éšœ</span>
        <span class="k">if</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;elevator_status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;fault&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_elevator_fault</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

        <span class="c1"># å±‚çº§5ï¼šè¯·æ±‚ååŠ©</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_assistance</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">basic_wait</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;wait&#39;</span><span class="p">,</span>
            <span class="s1">&#39;position&#39;</span><span class="p">:</span> <span class="s1">&#39;elevator_waiting_zone&#39;</span><span class="p">,</span>
            <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
            <span class="s1">&#39;monitor&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;door_status&#39;</span><span class="p">,</span> <span class="s1">&#39;crowd_size&#39;</span><span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_crowded_elevator</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;sequence&#39;</span><span class="p">,</span>
            <span class="s1">&#39;steps&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;announce&#39;</span><span class="p">,</span> 
                 <span class="s1">&#39;message&#39;</span><span class="p">:</span> <span class="s1">&#39;Waiting for next elevator&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;move_back&#39;</span><span class="p">,</span> <span class="s1">&#39;distance&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;wait&#39;</span><span class="p">,</span> <span class="s1">&#39;duration&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;retry&#39;</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_timeout</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;fallback&#39;</span><span class="p">,</span>
            <span class="s1">&#39;strategies&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;find_alternative_route&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;avoid&#39;</span><span class="p">:</span> <span class="s1">&#39;elevators&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;use_stairs&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;max_floors&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;reschedule_task&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;delay&#39;</span><span class="p">:</span> <span class="mi">300</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_elevator_fault</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;sequence&#39;</span><span class="p">,</span>
            <span class="s1">&#39;steps&#39;</span><span class="p">:</span> <span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;report_fault&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;system&#39;</span><span class="p">:</span> <span class="s1">&#39;building_management&#39;</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;update_map&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;mark_unavailable&#39;</span><span class="p">:</span> <span class="n">context</span><span class="p">[</span><span class="s1">&#39;elevator_id&#39;</span><span class="p">]},</span>
                <span class="p">{</span><span class="s1">&#39;action&#39;</span><span class="p">:</span> <span class="s1">&#39;find_alternative_route&#39;</span><span class="p">}</span>
            <span class="p">]</span>
        <span class="p">}</span>
</code></pre></div>

</details>
<p><strong>ç»ƒä¹  12.8</strong>ï¼šå®ç°ä¸€ä¸ªåŸºäºç¤¾ä¼šåŠ›æ¨¡å‹çš„äººç¾¤å¯¼èˆªç®—æ³•ï¼Œè€ƒè™‘ 5 ä¸ªè¡Œäººçš„ç›¸äº’ä½œç”¨ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>è®¡ç®—ç›®æ ‡å¸å¼•åŠ›ã€éšœç¢ç‰©æ’æ–¥åŠ›å’Œç¤¾ä¼šæ’æ–¥åŠ›çš„çŸ¢é‡å’Œã€‚</p>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SocialForceNavigator</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># ç¤¾ä¼šåŠ›å‚æ•°</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">=</span> <span class="mf">2.0</span>      <span class="c1"># æ’æ–¥åŠ›å¼ºåº¦</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">B</span> <span class="o">=</span> <span class="mf">0.8</span>      <span class="c1"># æ’æ–¥åŠ›èŒƒå›´</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k_goal</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># ç›®æ ‡å¸å¼•åŠ›ç³»æ•°</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tau</span> <span class="o">=</span> <span class="mf">0.5</span>    <span class="c1"># æ¾å¼›æ—¶é—´</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_goal_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">goal</span><span class="p">,</span> <span class="n">v_desired</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç›®æ ‡å¸å¼•åŠ›&quot;&quot;&quot;</span>
        <span class="n">direction</span> <span class="o">=</span> <span class="n">goal</span> <span class="o">-</span> <span class="n">pos</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">direction</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">distance</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">desired_velocity</span> <span class="o">=</span> <span class="p">(</span><span class="n">direction</span> <span class="o">/</span> <span class="n">distance</span><span class="p">)</span> <span class="o">*</span> <span class="n">v_desired</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">desired_velocity</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">tau</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_social_force</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">other_pos</span><span class="p">,</span> <span class="n">other_vel</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç¤¾ä¼šæ’æ–¥åŠ›&quot;&quot;&quot;</span>
        <span class="n">diff</span> <span class="o">=</span> <span class="n">pos</span> <span class="o">-</span> <span class="n">other_pos</span>
        <span class="n">distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">distance</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">distance</span> <span class="o">&lt;</span> <span class="mf">5.0</span><span class="p">:</span>  <span class="c1"># 5m å½±å“èŒƒå›´</span>
            <span class="c1"># æ–¹å‘å•ä½å‘é‡</span>
            <span class="n">n_ij</span> <span class="o">=</span> <span class="n">diff</span> <span class="o">/</span> <span class="n">distance</span>

            <span class="c1"># è€ƒè™‘ç›¸å¯¹é€Ÿåº¦çš„å„å‘å¼‚æ€§</span>
            <span class="n">v_rel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span> <span class="o">-</span> <span class="n">other_vel</span>
            <span class="c1"># æ—¶é—´åˆ°ç¢°æ’</span>
            <span class="n">ttc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_time_to_collision</span><span class="p">(</span>
                <span class="n">pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">,</span> <span class="n">other_pos</span><span class="p">,</span> <span class="n">other_vel</span>
            <span class="p">)</span>

            <span class="c1"># åŸºç¡€æ’æ–¥åŠ›</span>
            <span class="n">f_magnitude</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">((</span><span class="mf">0.5</span> <span class="o">-</span> <span class="n">distance</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">B</span><span class="p">)</span>

            <span class="c1"># å„å‘å¼‚æ€§å› å­ï¼ˆå‰æ–¹çš„äººå½±å“æ›´å¤§ï¼‰</span>
            <span class="n">cos_phi</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">n_ij</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">velocity</span><span class="p">)</span> <span class="o">+</span> <span class="mf">1e-6</span>
            <span class="p">)</span>
            <span class="n">anisotropy</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">cos_phi</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

            <span class="k">return</span> <span class="n">f_magnitude</span> <span class="o">*</span> <span class="n">n_ij</span> <span class="o">*</span> <span class="n">anisotropy</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">navigate_in_crowd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot_pos</span><span class="p">,</span> <span class="n">robot_vel</span><span class="p">,</span> <span class="n">goal</span><span class="p">,</span> 
                          <span class="n">pedestrians</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        åœ¨äººç¾¤ä¸­å¯¼èˆª</span>
<span class="sd">        pedestrians: [(pos, vel), ...]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">velocity</span> <span class="o">=</span> <span class="n">robot_vel</span>

        <span class="c1"># è®¡ç®—æ€»åŠ›</span>
        <span class="n">force_total</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># ç›®æ ‡å¸å¼•åŠ›</span>
        <span class="n">force_total</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_goal_force</span><span class="p">(</span><span class="n">robot_pos</span><span class="p">,</span> <span class="n">goal</span><span class="p">)</span>

        <span class="c1"># ç¤¾ä¼šæ’æ–¥åŠ›</span>
        <span class="k">for</span> <span class="n">ped_pos</span><span class="p">,</span> <span class="n">ped_vel</span> <span class="ow">in</span> <span class="n">pedestrians</span><span class="p">:</span>
            <span class="n">force_total</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_social_force</span><span class="p">(</span>
                <span class="n">robot_pos</span><span class="p">,</span> <span class="n">ped_pos</span><span class="p">,</span> <span class="n">ped_vel</span>
            <span class="p">)</span>

        <span class="c1"># é™åˆ¶æœ€å¤§åŠ›ï¼ˆåŠ é€Ÿåº¦ï¼‰</span>
        <span class="n">max_force</span> <span class="o">=</span> <span class="mf">2.0</span>  <span class="c1"># m/sÂ²</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">force_total</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_force</span><span class="p">:</span>
            <span class="n">force_total</span> <span class="o">=</span> <span class="n">force_total</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">force_total</span><span class="p">)</span>
            <span class="n">force_total</span> <span class="o">*=</span> <span class="n">max_force</span>

        <span class="c1"># æ›´æ–°é€Ÿåº¦</span>
        <span class="n">dt</span> <span class="o">=</span> <span class="mf">0.1</span>
        <span class="n">new_velocity</span> <span class="o">=</span> <span class="n">robot_vel</span> <span class="o">+</span> <span class="n">force_total</span> <span class="o">*</span> <span class="n">dt</span>

        <span class="c1"># é™åˆ¶æœ€å¤§é€Ÿåº¦</span>
        <span class="n">max_speed</span> <span class="o">=</span> <span class="mf">1.2</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">new_velocity</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_speed</span><span class="p">:</span>
            <span class="n">new_velocity</span> <span class="o">=</span> <span class="n">new_velocity</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">new_velocity</span><span class="p">)</span>
            <span class="n">new_velocity</span> <span class="o">*=</span> <span class="n">max_speed</span>

        <span class="k">return</span> <span class="n">new_velocity</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_time_to_collision</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">p1</span><span class="p">,</span> <span class="n">v1</span><span class="p">,</span> <span class="n">p2</span><span class="p">,</span> <span class="n">v2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è®¡ç®—ç¢°æ’æ—¶é—´&quot;&quot;&quot;</span>
        <span class="n">rel_pos</span> <span class="o">=</span> <span class="n">p2</span> <span class="o">-</span> <span class="n">p1</span>
        <span class="n">rel_vel</span> <span class="o">=</span> <span class="n">v2</span> <span class="o">-</span> <span class="n">v1</span>

        <span class="c1"># äºŒæ¬¡æ–¹ç¨‹ç³»æ•°</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rel_vel</span><span class="p">,</span> <span class="n">rel_vel</span><span class="p">)</span>
        <span class="n">b</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rel_pos</span><span class="p">,</span> <span class="n">rel_vel</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rel_pos</span><span class="p">,</span> <span class="n">rel_pos</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># å®‰å…¨è·ç¦»</span>

        <span class="k">if</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="mf">1e-6</span><span class="p">:</span>  <span class="c1"># ç›¸å¯¹é™æ­¢</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

        <span class="n">discriminant</span> <span class="o">=</span> <span class="n">b</span><span class="o">*</span><span class="n">b</span> <span class="o">-</span> <span class="mi">4</span><span class="o">*</span><span class="n">a</span><span class="o">*</span><span class="n">c</span>
        <span class="k">if</span> <span class="n">discriminant</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># ä¸ä¼šç¢°æ’</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="s1">&#39;inf&#39;</span><span class="p">)</span>

        <span class="n">t</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">b</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">discriminant</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

<span class="c1"># ä½¿ç”¨ç¤ºä¾‹</span>
<span class="n">navigator</span> <span class="o">=</span> <span class="n">SocialForceNavigator</span><span class="p">()</span>
<span class="n">robot_pos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">robot_vel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">goal</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>

<span class="c1"># 5ä¸ªè¡Œäºº</span>
<span class="n">pedestrians</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">3</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mi">0</span><span class="p">])),</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])),</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">])),</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])),</span>
    <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.4</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
<span class="p">]</span>

<span class="n">new_vel</span> <span class="o">=</span> <span class="n">navigator</span><span class="o">.</span><span class="n">navigate_in_crowd</span><span class="p">(</span>
    <span class="n">robot_pos</span><span class="p">,</span> <span class="n">robot_vel</span><span class="p">,</span> <span class="n">goal</span><span class="p">,</span> <span class="n">pedestrians</span>
<span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;è°ƒæ•´åé€Ÿåº¦: </span><span class="si">{</span><span class="n">new_vel</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

</details>
<h2 id="_36">å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<h3 id="1">1. ä»£ä»·åœ°å›¾é…ç½®é”™è¯¯</h3>
<p><strong>é—®é¢˜</strong>ï¼šæœºå™¨äººé¢‘ç¹ç¢°æ’æˆ–è¿‡åº¦ä¿å®ˆ</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># é”™è¯¯é…ç½®</span>
<span class="nt">inflation_layer</span><span class="p">:</span>
<span class="w">  </span><span class="nt">inflation_radius</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.1</span><span class="w">  </span><span class="c1"># å¤ªå°ï¼Œå®¹æ˜“ç¢°æ’</span>
<span class="w">  </span><span class="nt">cost_scaling_factor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0</span><span class="w">  </span><span class="c1"># å¤ªå¤§ï¼Œè¿‡åº¦ä¿å®ˆ</span>
</code></pre></div>

<p><strong>æ­£ç¡®é…ç½®</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nt">inflation_layer</span><span class="p">:</span>
<span class="w">  </span><span class="nt">inflation_radius</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.55</span><span class="w">  </span><span class="c1"># æœºå™¨äººåŠå¾„ + å®‰å…¨è£•åº¦</span>
<span class="w">  </span><span class="nt">cost_scaling_factor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3.0</span><span class="w">  </span><span class="c1"># å¹³æ»‘ä»£ä»·æ¸å˜</span>
</code></pre></div>

<h3 id="2_2">2. è¡Œä¸ºæ ‘æ­»é”</h3>
<p><strong>é—®é¢˜</strong>ï¼šæ¢å¤è¡Œä¸ºç›¸äº’è§¦å‘å¯¼è‡´æ­»é”</p>
<div class="codehilite"><pre><span></span><code><span class="cm">&lt;!-- é”™è¯¯ï¼šå¯èƒ½æ— é™å¾ªç¯ --&gt;</span>
<span class="nt">&lt;RecoveryNode</span><span class="w"> </span><span class="na">number_of_retries=</span><span class="s">&quot;-1&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;FollowPath</span><span class="w"> </span><span class="na">path=</span><span class="s">&quot;{path}&quot;</span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;ClearCostmap/&gt;</span>
<span class="nt">&lt;/RecoveryNode&gt;</span>
</code></pre></div>

<p><strong>è§£å†³</strong>ï¼šè®¾ç½®é‡è¯•æ¬¡æ•°é™åˆ¶å’Œè¶…æ—¶</p>
<div class="codehilite"><pre><span></span><code><span class="nt">&lt;RecoveryNode</span><span class="w"> </span><span class="na">number_of_retries=</span><span class="s">&quot;3&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;Timeout</span><span class="w"> </span><span class="na">msec=</span><span class="s">&quot;30000&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;FollowPath</span><span class="w"> </span><span class="na">path=</span><span class="s">&quot;{path}&quot;</span><span class="nt">/&gt;</span>
<span class="w">  </span><span class="nt">&lt;/Timeout&gt;</span>
<span class="w">  </span><span class="nt">&lt;ClearCostmap/&gt;</span>
<span class="nt">&lt;/RecoveryNode&gt;</span>
</code></pre></div>

<h3 id="3_2">3. æ§åˆ¶å™¨æŒ¯è¡</h3>
<p><strong>ç—‡çŠ¶</strong>ï¼šæœºå™¨äººå·¦å³æ‘‡æ‘†ï¼Œæ— æ³•ç¨³å®šè·Ÿè¸ªè·¯å¾„</p>
<p><strong>åŸå› </strong>ï¼š</p>
<ul>
<li>æ§åˆ¶å¢ç›Šè¿‡é«˜</li>
<li>å‰è§†è·ç¦»ä¸å½“</li>
<li>è¯„åˆ†å‡½æ•°æƒé‡å¤±è¡¡</li>
</ul>
<p><strong>è°ƒè¯•æ–¹æ³•</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># è®°å½•æ§åˆ¶å™¨è¾“å‡ºç”¨äºåˆ†æ</span>
<span class="k">def</span><span class="w"> </span><span class="nf">debug_controller_oscillation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="n">history</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">100</span><span class="p">):</span>
        <span class="n">cmd_vel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">controller</span><span class="o">.</span><span class="n">compute_velocity</span><span class="p">()</span>
        <span class="n">history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="n">cmd_vel</span><span class="o">.</span><span class="n">linear</span><span class="o">.</span><span class="n">x</span><span class="p">,</span>
            <span class="s1">&#39;angular&#39;</span><span class="p">:</span> <span class="n">cmd_vel</span><span class="o">.</span><span class="n">angular</span><span class="o">.</span><span class="n">z</span><span class="p">,</span>
            <span class="s1">&#39;error&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">path_error</span>
        <span class="p">})</span>

    <span class="c1"># æ£€æµ‹æŒ¯è¡</span>
    <span class="n">angular_changes</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">([</span><span class="n">h</span><span class="p">[</span><span class="s1">&#39;angular&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">h</span> <span class="ow">in</span> <span class="n">history</span><span class="p">])</span>
    <span class="n">oscillation_score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">angular_changes</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">oscillation_score</span> <span class="o">&gt;</span> <span class="n">threshold</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reduce_controller_gains</span><span class="p">()</span>
</code></pre></div>

<h3 id="4">4. åŠ¨æ€éšœç¢ç‰©å¤„ç†ä¸å½“</h3>
<p><strong>é—®é¢˜</strong>ï¼šå¯¹å¿«é€Ÿç§»åŠ¨ç‰©ä½“ååº”ä¸åŠæ—¶</p>
<p><strong>è§£å†³</strong>ï¼šæé«˜ä¼ æ„Ÿå™¨æ›´æ–°é¢‘ç‡å’Œé¢„æµ‹èŒƒå›´</p>
<div class="codehilite"><pre><span></span><code><span class="nt">obstacle_layer</span><span class="p">:</span>
<span class="w">  </span><span class="nt">observation_sources</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">laser</span>
<span class="w">  </span><span class="nt">laser</span><span class="p">:</span>
<span class="w">    </span><span class="nt">data_type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">LaserScan</span>
<span class="w">    </span><span class="nt">clearing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">marking</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">expected_update_rate</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span><span class="w">  </span><span class="c1"># ä¸æ£€æŸ¥æ›´æ–°ç‡</span>
<span class="w">    </span><span class="nt">observation_persistence</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span><span class="w">  </span><span class="c1"># ç«‹å³æ¸…é™¤æ—§æ•°æ®</span>
</code></pre></div>

<h3 id="5">5. å¤šæœºå™¨äººåè°ƒå¤±è´¥</h3>
<p><strong>é—®é¢˜</strong>ï¼šå¤šæœºå™¨äººåœ¨ç‹­çª„ç©ºé—´æ­»é”</p>
<p><strong>é¢„é˜²æªæ–½</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MultiRobotCoordinator</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">prevent_deadlock</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 1. ä¼˜å…ˆçº§åˆ†é…</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assign_dynamic_priorities</span><span class="p">()</span>

        <span class="c1"># 2. é¢„ç•™æ—¶ç©ºæ§½</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reserve_spacetime_slots</span><span class="p">()</span>

        <span class="c1"># 3. æ­»é”æ£€æµ‹</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_circular_wait</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">break_deadlock_by_backoff</span><span class="p">()</span>
</code></pre></div>

<h2 id="_37">æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_38">ç³»ç»Ÿè®¾è®¡å®¡æŸ¥</h3>
<ul>
<li>[ ] <strong>å¯¼èˆªéœ€æ±‚åˆ†æ</strong></li>
<li>ç¯å¢ƒç±»å‹ï¼ˆç»“æ„åŒ–/éç»“æ„åŒ–ï¼‰</li>
<li>åŠ¨æ€éšœç¢ç‰©å¯†åº¦</li>
<li>ç²¾åº¦è¦æ±‚ vs é€Ÿåº¦è¦æ±‚</li>
<li>
<p>å®‰å…¨ç­‰çº§è¦æ±‚</p>
</li>
<li>
<p>[ ] <strong>ç®—æ³•é€‰æ‹©</strong></p>
</li>
<li>å…¨å±€è§„åˆ’å™¨é€‚é…ç¯å¢ƒç‰¹ç‚¹</li>
<li>æ§åˆ¶å™¨åŒ¹é…æœºå™¨äººè¿åŠ¨å­¦</li>
<li>
<p>æ¢å¤ç­–ç•¥è¦†ç›–æ‰€æœ‰å¤±è´¥æ¨¡å¼</p>
</li>
<li>
<p>[ ] <strong>å‚æ•°è°ƒä¼˜</strong></p>
</li>
<li>ä»£ä»·åœ°å›¾åˆ†è¾¨ç‡ä¸è®¡ç®—èƒ½åŠ›å¹³è¡¡</li>
<li>æ§åˆ¶é¢‘ç‡æ»¡è¶³å®æ—¶è¦æ±‚</li>
<li>å®‰å…¨è·ç¦»è€ƒè™‘æœ€åæƒ…å†µ</li>
</ul>
<h3 id="_39">å®æ–½æ£€æŸ¥</h3>
<ul>
<li>[ ] <strong>è¡Œä¸ºæ ‘è®¾è®¡</strong></li>
<li>æ— æ­»é”å’Œæ— é™å¾ªç¯</li>
<li>æ¢å¤è¡Œä¸ºæœ‰é‡è¯•é™åˆ¶</li>
<li>
<p>å…³é”®åŠ¨ä½œæœ‰è¶…æ—¶ä¿æŠ¤</p>
</li>
<li>
<p>[ ] <strong>æ€§èƒ½ä¼˜åŒ–</strong></p>
</li>
<li>CPU ä½¿ç”¨ç‡ &lt; 80%</li>
<li>è§„åˆ’å»¶è¿Ÿ &lt; 100ms</li>
<li>
<p>æ§åˆ¶é¢‘ç‡ â‰¥ 20Hz</p>
</li>
<li>
<p>[ ] <strong>å®‰å…¨æœºåˆ¶</strong></p>
</li>
<li>ç´§æ€¥åœæ­¢å§‹ç»ˆå¯ç”¨</li>
<li>å¤šå±‚ç¢°æ’æ£€æµ‹</li>
<li>é€Ÿåº¦é™åˆ¶åŠ¨æ€è°ƒæ•´</li>
</ul>
<h3 id="_40">æµ‹è¯•éªŒè¯</h3>
<ul>
<li>[ ] <strong>å•å…ƒæµ‹è¯•</strong></li>
<li>å„è§„åˆ’å™¨ç‹¬ç«‹æµ‹è¯•</li>
<li>æ§åˆ¶å™¨æé™æƒ…å†µæµ‹è¯•</li>
<li>
<p>æ¢å¤è¡Œä¸ºè§¦å‘æµ‹è¯•</p>
</li>
<li>
<p>[ ] <strong>é›†æˆæµ‹è¯•</strong></p>
</li>
<li>é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§</li>
<li>å¤šæœºå™¨äººåè°ƒæµ‹è¯•</li>
<li>
<p>å¼‚å¸¸æƒ…å†µå¤„ç†æµ‹è¯•</p>
</li>
<li>
<p>[ ] <strong>ç°åœºæµ‹è¯•</strong></p>
</li>
<li>çœŸå®ç¯å¢ƒæ€§èƒ½éªŒè¯</li>
<li>äººæœºäº¤äº’å®‰å…¨æ€§</li>
<li>è¾¹ç¼˜æƒ…å†µå¤„ç†èƒ½åŠ›</li>
</ul>
<h3 id="_41">éƒ¨ç½²è¿ç»´</h3>
<ul>
<li>[ ] <strong>ç›‘æ§æŒ‡æ ‡</strong></li>
<li>å¯¼èˆªæˆåŠŸç‡</li>
<li>å¹³å‡å®Œæˆæ—¶é—´</li>
<li>
<p>ç¢°æ’/è¿‘å¤±äº‹ä»¶ç»Ÿè®¡</p>
</li>
<li>
<p>[ ] <strong>æ—¥å¿—è®°å½•</strong></p>
</li>
<li>å…³é”®å†³ç­–ç‚¹è®°å½•</li>
<li>å¼‚å¸¸æƒ…å†µè¯¦ç»†æ—¥å¿—</li>
<li>
<p>æ€§èƒ½æŒ‡æ ‡æ—¶åºæ•°æ®</p>
</li>
<li>
<p>[ ] <strong>æ›´æ–°ç»´æŠ¤</strong></p>
</li>
<li>å‚æ•°ç‰ˆæœ¬æ§åˆ¶</li>
<li>A/B æµ‹è¯•æ¡†æ¶</li>
<li>å›æ»šæœºåˆ¶å‡†å¤‡</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter11.html" class="nav-link prev">â† ç¬¬ 11 ç« ï¼šSLAM ä¸å®šä½ç³»ç»Ÿ</a><a href="chapter13.html" class="nav-link next">ç¬¬ 13 ç« ï¼šros2_control æ¡†æ¶ â†’</a></nav>
        </main>
    </div>
</body>
</html>