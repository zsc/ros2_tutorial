<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬ 6 ç« ï¼šé€šä¿¡æœºåˆ¶æ·±åº¦è§£æ</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ROS2 å®Œå…¨æ•™ç¨‹ï¼šä»åŸç†åˆ°å®è·µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 1 ç« ï¼šROS1 æ ¸å¿ƒæ¦‚å¿µå›é¡¾</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 2 ç« ï¼šROS1 çš„å±€é™æ€§åˆ†æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 3 ç« ï¼šä» ROS1 åˆ° ROS2 çš„è¿ç§»ç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 4 ç« ï¼šROS2 æ¶æ„ä¸è®¾è®¡ç†å¿µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 5 ç« ï¼šèŠ‚ç‚¹ä¸æ‰§è¡Œå™¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 6 ç« ï¼šé€šä¿¡æœºåˆ¶æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 7 ç« ï¼šLaunch ç³»ç»Ÿä¸é…ç½®ç®¡ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 8 ç« ï¼štf2 åæ ‡å˜æ¢æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 9 ç« ï¼šæ—¶é—´åŒæ­¥ä¸å›æ”¾ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 10 ç« ï¼šä¼ æ„Ÿå™¨æ•°æ®å¤„ç†ç®¡é“</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 11 ç« ï¼šSLAM ä¸å®šä½ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 12 ç« ï¼šå¯¼èˆªæ ˆ Nav2</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 13 ç« ï¼šros2_control æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 14 ç« ï¼šMoveIt2 è¿åŠ¨è§„åˆ’</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 15 ç« ï¼šå®æ—¶ç³»ç»Ÿä¸æ€§èƒ½ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 16 ç« ï¼šå®‰å…¨æ€§ä¸è¯Šæ–­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 17 ç« ï¼šä»¿çœŸé›†æˆï¼ˆGazebo/Ignitionï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 18 ç« ï¼šå¤šæœºå™¨äººç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 19 ç« ï¼šè®¡ç®—æœºè§†è§‰ä¸æ·±åº¦å­¦ä¹ </span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 20 ç« ï¼šæœºå™¨äººå¼ºåŒ–å­¦ä¹ </span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 21 ç« ï¼šå¤§è¯­è¨€æ¨¡å‹ä¸å…·èº«æ™ºèƒ½</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 22 ç« ï¼šç¥ç»ç½‘ç»œè¿åŠ¨æ§åˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="6">ç¬¬ 6 ç« ï¼šé€šä¿¡æœºåˆ¶æ·±åº¦è§£æ</h1>
<p>æœ¬ç« æ·±å…¥æ¢è®¨ ROS2 çš„æ ¸å¿ƒé€šä¿¡æœºåˆ¶ï¼ŒåŒ…æ‹¬è¯é¢˜ã€æœåŠ¡ã€åŠ¨ä½œå’Œå‚æ•°æœåŠ¡å™¨çš„å®ç°åŸç†ã€‚æˆ‘ä»¬å°†ä» DDS å±‚é¢å‰–ææ¶ˆæ¯ä¼ é€’æœºåˆ¶ï¼Œç†è§£ QoS ç­–ç•¥çš„åº”ç”¨åœºæ™¯ï¼ŒæŒæ¡é«˜æ€§èƒ½é€šä¿¡ç³»ç»Ÿçš„è®¾è®¡æ¨¡å¼ã€‚å¯¹äºæ„å»ºå¤æ‚æœºå™¨äººç³»ç»Ÿè€Œè¨€ï¼Œé€‰æ‹©åˆé€‚çš„é€šä¿¡æ¨¡å¼å’Œä¼˜åŒ–ç­–ç•¥è‡³å…³é‡è¦ã€‚</p>
<h2 id="61-topics">6.1 è¯é¢˜ï¼ˆTopicsï¼‰ä¸æ¶ˆæ¯ä¼ é€’</h2>
<h3 id="611-">6.1.1 å‘å¸ƒ-è®¢é˜…æ¨¡å¼åŸç†</h3>
<p>ROS2 çš„è¯é¢˜é€šä¿¡åŸºäº DDSï¼ˆData Distribution Serviceï¼‰æ ‡å‡†å®ç°ï¼Œé‡‡ç”¨å»ä¸­å¿ƒåŒ–çš„å‘å¸ƒ-è®¢é˜…æ¨¡å¼ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">Publisher</span><span class="w"> </span><span class="n">Node</span><span class="w">                    </span><span class="n">Subscriber</span><span class="w"> </span><span class="n">Nodes</span>
<span class="w">    </span><span class="p">[</span><span class="n">P1</span><span class="p">]</span><span class="w"> </span><span class="o">----</span><span class="err">\</span><span class="w">                    </span><span class="o">/---&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">S1</span><span class="p">]</span>
<span class="w">              </span><span class="err">\</span><span class="w">                  </span><span class="o">/</span>
<span class="w">               </span><span class="p">[</span><span class="n">DDS</span><span class="w"> </span><span class="n">Domain</span><span class="p">]</span><span class="w"> </span><span class="o">----+----&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">S2</span><span class="p">]</span>
<span class="w">              </span><span class="o">/</span><span class="w">                  </span>\
<span class="w">    </span><span class="p">[</span><span class="n">P2</span><span class="p">]</span><span class="w"> </span><span class="o">----/</span><span class="w">                    </span><span class="err">\</span><span class="o">---&gt;</span><span class="w"> </span><span class="p">[</span><span class="n">S3</span><span class="p">]</span>
</code></pre></div>

<p>æ ¸å¿ƒç‰¹å¾ï¼š</p>
<ul>
<li><strong>å¼‚æ­¥é€šä¿¡</strong>ï¼šå‘å¸ƒè€…å’Œè®¢é˜…è€…è§£è€¦ï¼Œæ— éœ€åŒæ­¥ç­‰å¾…</li>
<li><strong>å¤šå¯¹å¤šé€šä¿¡</strong>ï¼šæ”¯æŒå¤šä¸ªå‘å¸ƒè€…å’Œè®¢é˜…è€…</li>
<li><strong>ç±»å‹å®‰å…¨</strong>ï¼šåŸºäº IDL çš„æ¶ˆæ¯å®šä¹‰ç¡®ä¿ç±»å‹åŒ¹é…</li>
<li><strong>é›¶æ‹·è´ä¼˜åŒ–</strong>ï¼šåŒè¿›ç¨‹é€šä¿¡å¯å®ç°é›¶æ‹·è´ä¼ è¾“</li>
</ul>
<h3 id="612">6.1.2 æ¶ˆæ¯ç±»å‹ç³»ç»Ÿ</h3>
<p>ROS2 ä½¿ç”¨ IDLï¼ˆInterface Definition Languageï¼‰å®šä¹‰æ¶ˆæ¯ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="gh">#</span> geometry_msgs/msg/Twist.msg
Vector3 linear
  float64 x
  float64 y
  float64 z
Vector3 angular
  float64 x
  float64 y
  float64 z
</code></pre></div>

<p>æ¶ˆæ¯åºåˆ—åŒ–é‡‡ç”¨ CDRï¼ˆCommon Data Representationï¼‰æ ‡å‡†ï¼Œæ”¯æŒï¼š</p>
<ul>
<li>åŸºæœ¬ç±»å‹ï¼šint8-64, uint8-64, float32/64, bool, string</li>
<li>å¤åˆç±»å‹ï¼šarrays, sequences, nested messages</li>
<li>æ—¶é—´ç±»å‹ï¼šbuiltin_interfaces/Time, Duration</li>
</ul>
<h3 id="613">6.1.3 è¯é¢˜å‘ç°æœºåˆ¶</h3>
<p>DDS çš„ RTPSï¼ˆReal-Time Publish-Subscribeï¼‰åè®®å®ç°è‡ªåŠ¨å‘ç°ï¼š</p>
<ol>
<li>
<p><strong>å‚ä¸è€…å‘ç°</strong>ï¼ˆParticipant Discovery Protocol, PDPï¼‰
   - ä½¿ç”¨å¤šæ’­å‘é€ DATA(p) æ¶ˆæ¯å®£å‘Šå­˜åœ¨
   - é»˜è®¤å¤šæ’­åœ°å€ï¼š239.255.0.1:7400 + 250*domain_id</p>
</li>
<li>
<p><strong>ç«¯ç‚¹å‘ç°</strong>ï¼ˆEndpoint Discovery Protocol, EDPï¼‰
   - äº¤æ¢ PublicationBuiltinTopicData å’Œ SubscriptionBuiltinTopicData
   - åŒ…å« QoS ç­–ç•¥ã€ç±»å‹ä¿¡æ¯ã€ç«¯ç‚¹æ ‡è¯†</p>
</li>
<li>
<p><strong>ç±»å‹åå•†</strong>
   - æ¯”è¾ƒ type_hash ç¡®ä¿ç±»å‹å…¼å®¹
   - æ”¯æŒ type negotiation å®ç°ç‰ˆæœ¬å…¼å®¹</p>
</li>
</ol>
<h3 id="614">6.1.4 å†…å­˜ç®¡ç†ä¸é›¶æ‹·è´</h3>
<p>é«˜æ€§èƒ½åœºæ™¯ä¸‹çš„å†…å­˜ä¼˜åŒ–ç­–ç•¥ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="err">ä¼ ç»Ÿæ¨¡å¼ï¼š</span>
<span class="n">App</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">RMW</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">DDS</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Socket</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Kernel</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">Network</span>

<span class="err">é›¶æ‹·è´æ¨¡å¼ï¼ˆåŒè¿›ç¨‹ï¼‰ï¼š</span>
<span class="n">App</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kr">Shared</span><span class="w"> </span><span class="n">Memory</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">App</span>

<span class="err">é›¶æ‹·è´æ¨¡å¼ï¼ˆè·¨è¿›ç¨‹ï¼‰ï¼š</span>
<span class="n">App</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">POSIX</span><span class="w"> </span><span class="n">SHM</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">Iceoryx</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">App</span>
</code></pre></div>

<p>å®ç°é›¶æ‹·è´çš„æ¡ä»¶ï¼š</p>
<ul>
<li>ä½¿ç”¨ loaned messages API</li>
<li>æ¶ˆæ¯ç±»å‹ä¸º PODï¼ˆPlain Old Dataï¼‰</li>
<li>DDS å®ç°æ”¯æŒï¼ˆå¦‚ Cyclone DDS + iceoryxï¼‰</li>
</ul>
<h2 id="62-servicesactions">6.2 æœåŠ¡ï¼ˆServicesï¼‰ä¸åŠ¨ä½œï¼ˆActionsï¼‰</h2>
<h3 id="621">6.2.1 æœåŠ¡é€šä¿¡æ¨¡å¼</h3>
<p>æœåŠ¡é‡‡ç”¨è¯·æ±‚-å“åº”æ¨¡å¼ï¼Œé€‚ç”¨äºåŒæ­¥æ“ä½œï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">Client</span><span class="w">                          </span><span class="n">Server</span>
<span class="w">  </span><span class="o">|---</span><span class="w"> </span><span class="n">Request</span><span class="w"> </span><span class="p">(</span><span class="n">call_id</span><span class="p">)</span><span class="w"> </span><span class="o">--------&gt;|</span>
<span class="w">  </span><span class="o">|</span><span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="nf">process</span><span class="p">()</span>
<span class="w">  </span><span class="o">|&lt;------</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="p">(</span><span class="n">call_id</span><span class="p">)</span><span class="w"> </span><span class="o">----|</span>
</code></pre></div>

<p>å…³é”®ç‰¹æ€§ï¼š</p>
<ul>
<li><strong>åŒæ­¥é˜»å¡</strong>ï¼šå®¢æˆ·ç«¯ç­‰å¾…å“åº”</li>
<li><strong>ä¸€å¯¹ä¸€é€šä¿¡</strong>ï¼šå•ä¸ªæœåŠ¡å™¨å¤„ç†è¯·æ±‚</li>
<li><strong>è¶…æ—¶æœºåˆ¶</strong>ï¼šå¯è®¾ç½®ç­‰å¾…è¶…æ—¶</li>
<li><strong>å¹¶å‘å¤„ç†</strong>ï¼šæœåŠ¡å™¨å¯å¹¶å‘å¤„ç†å¤šä¸ªè¯·æ±‚</li>
</ul>
<p>æœåŠ¡å®šä¹‰ç¤ºä¾‹ï¼š</p>
<div class="codehilite"><pre><span></span><code># AddTwoInts.srv
int64 a
int64 b
---
int64 sum
</code></pre></div>

<h3 id="622">6.2.2 åŠ¨ä½œé€šä¿¡æ¶æ„</h3>
<p>åŠ¨ä½œç»“åˆäº†è¯é¢˜å’ŒæœåŠ¡ï¼Œæ”¯æŒé•¿æ—¶é—´è¿è¡Œçš„ä»»åŠ¡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">Action</span><span class="w"> </span><span class="n">Client</span><span class="w">                    </span><span class="n">Action</span><span class="w"> </span><span class="n">Server</span>
<span class="w">     </span><span class="o">|</span><span class="w">                                </span><span class="o">|</span>
<span class="w">     </span><span class="o">|------</span><span class="w"> </span><span class="n">Goal</span><span class="w"> </span><span class="n">Request</span><span class="w"> </span><span class="o">-----------&gt;|</span>
<span class="w">     </span><span class="o">|&lt;-----</span><span class="w"> </span><span class="n">Goal</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="o">-----------|</span>
<span class="w">     </span><span class="o">|</span><span class="w">                                </span><span class="o">|</span><span class="w"> </span><span class="n">execute</span><span class="p">()</span>
<span class="w">     </span><span class="o">|&lt;-----</span><span class="w"> </span><span class="n">Feedback</span><span class="w"> </span><span class="p">(</span><span class="n">Topic</span><span class="p">)</span><span class="w"> </span><span class="o">--------|</span>
<span class="w">     </span><span class="o">|&lt;-----</span><span class="w"> </span><span class="n">Feedback</span><span class="w"> </span><span class="p">(</span><span class="n">Topic</span><span class="p">)</span><span class="w"> </span><span class="o">--------|</span>

<span class="w">     </span><span class="o">|&lt;-----</span><span class="w"> </span><span class="n">Feedback</span><span class="w"> </span><span class="p">(</span><span class="n">Topic</span><span class="p">)</span><span class="w"> </span><span class="o">--------|</span>
<span class="w">     </span><span class="o">|</span><span class="w">                                </span><span class="o">|</span>
<span class="w">     </span><span class="o">|------</span><span class="w"> </span><span class="n">Cancel</span><span class="w"> </span><span class="n">Request</span><span class="w"> </span><span class="o">---------&gt;|</span>
<span class="w">     </span><span class="o">|&lt;-----</span><span class="w"> </span><span class="n">Cancel</span><span class="w"> </span><span class="n">Response</span><span class="w"> </span><span class="o">---------|</span>
<span class="w">     </span><span class="o">|</span><span class="w">                                </span><span class="o">|</span>
<span class="w">     </span><span class="o">|&lt;-----</span><span class="w"> </span><span class="n">Result</span><span class="w"> </span><span class="p">(</span><span class="kr">Service</span><span class="p">)</span><span class="w"> </span><span class="o">--------|</span>
</code></pre></div>

<p>åŠ¨ä½œç”±äº”ä¸ªæœåŠ¡å’Œä¸¤ä¸ªè¯é¢˜ç»„æˆï¼š</p>
<ul>
<li>æœåŠ¡ï¼šsend_goal, cancel_goal, get_result</li>
<li>è¯é¢˜ï¼šfeedback, status</li>
</ul>
<h3 id="623">6.2.3 åŠ¨ä½œçŠ¶æ€æœº</h3>
<p>åŠ¨ä½œæœåŠ¡å™¨ç»´æŠ¤ç›®æ ‡çŠ¶æ€æœºï¼š</p>
<div class="codehilite"><pre><span></span><code>     <span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
     <span class="err">â”‚</span> <span class="n">PENDING</span> <span class="err">â”‚</span>
     <span class="err">â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜</span>
          <span class="err">â”‚</span> <span class="n">accept</span>
     <span class="err">â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”</span>
     <span class="err">â”‚</span><span class="n">EXECUTING</span><span class="err">â”‚â—„â”€â”€â”€â”€â”</span>
     <span class="err">â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜</span>     <span class="err">â”‚</span>
       <span class="err">â”Œâ”€â”€â”´â”€â”€â”</span>    <span class="err">â”Œâ”€â”€â”´â”€â”€â”€â”€â”</span>
<span class="n">cancel</span> <span class="err">â”‚</span>     <span class="err">â”‚</span>    <span class="err">â”‚</span><span class="n">PREEMPT</span><span class="err">â”‚</span>
       <span class="err">â–¼</span>     <span class="err">â–¼</span>    <span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”˜</span>
  <span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”</span> <span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
  <span class="err">â”‚</span><span class="n">CANCELED</span><span class="err">â”‚</span> <span class="err">â”‚</span><span class="n">SUCCEEDED</span><span class="err">â”‚</span>
  <span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span> <span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<p>çŠ¶æ€è½¬æ¢è§„åˆ™ï¼š</p>
<ul>
<li>PENDING â†’ EXECUTINGï¼šç›®æ ‡è¢«æ¥å—</li>
<li>EXECUTING â†’ SUCCEEDEDï¼šæˆåŠŸå®Œæˆ</li>
<li>EXECUTING â†’ CANCELEDï¼šè¢«å–æ¶ˆ</li>
<li>EXECUTING â†’ ABORTEDï¼šæ‰§è¡Œå¤±è´¥</li>
</ul>
<h2 id="63">6.3 å‚æ•°æœåŠ¡å™¨æ¶æ„</h2>
<h3 id="631">6.3.1 åˆ†å¸ƒå¼å‚æ•°ç³»ç»Ÿ</h3>
<p>ROS2 é‡‡ç”¨åˆ†å¸ƒå¼å‚æ•°æ¶æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹ç»´æŠ¤è‡ªå·±çš„å‚æ•°ï¼š</p>
<div class="codehilite"><pre><span></span><code>Node A                    Node B
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Parameters:  â”‚         â”‚ Parameters:  â”‚
â”‚  - param1    â”‚         â”‚  - param3    â”‚
â”‚  - param2    â”‚         â”‚  - param4    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Services:    â”‚         â”‚ Services:    â”‚
â”‚  - get       â”‚         â”‚  - get       â”‚
â”‚  - set       â”‚         â”‚  - set       â”‚
â”‚  - list      â”‚         â”‚  - list      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p>å‚æ•°ç±»å‹æ”¯æŒï¼š</p>
<ul>
<li>bool, int64, double, string</li>
<li>bool[], int64[], double[], string[]</li>
<li>byte[] (äºŒè¿›åˆ¶æ•°æ®)</li>
</ul>
<h3 id="632">6.3.2 å‚æ•°äº‹ä»¶ç³»ç»Ÿ</h3>
<p>å‚æ•°å˜åŒ–é€šè¿‡äº‹ä»¶è¯é¢˜å¹¿æ’­ï¼š</p>
<div class="codehilite"><pre><span></span><code>/parameter_events (rcl_interfaces/msg/ParameterEvent)
â”œâ”€â”€ node: string
â”œâ”€â”€ new_parameters: Parameter[]
â”œâ”€â”€ changed_parameters: Parameter[]
â””â”€â”€ deleted_parameters: Parameter[]
</code></pre></div>

<p>ç›‘å¬å‚æ•°å˜åŒ–çš„æ¨¡å¼ï¼š</p>
<ol>
<li>æœ¬åœ°å›è°ƒï¼š<code>add_on_set_parameters_callback()</code></li>
<li>è¿œç¨‹ç›‘å¬ï¼šè®¢é˜… <code>/node_name/parameter_events</code></li>
<li>å…¨å±€ç›‘å¬ï¼šè®¢é˜… <code>/parameter_events</code></li>
</ol>
<h3 id="633">6.3.3 å‚æ•°æè¿°ç¬¦</h3>
<p>å‚æ•°æè¿°ç¬¦æä¾›å…ƒæ•°æ®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nt">parameter_descriptors</span><span class="p">:</span>
<span class="w">  </span><span class="nt">velocity_limit</span><span class="p">:</span>
<span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DOUBLE</span>
<span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Maximum</span><span class="nv"> </span><span class="s">velocity</span><span class="nv"> </span><span class="s">in</span><span class="nv"> </span><span class="s">m/s&quot;</span>
<span class="w">    </span><span class="nt">read_only</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">    </span><span class="nt">dynamic_typing</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
<span class="w">    </span><span class="nt">additional_constraints</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Must</span><span class="nv"> </span><span class="s">be</span><span class="nv"> </span><span class="s">positive&quot;</span>
<span class="w">    </span><span class="nt">floating_point_range</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">from_value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
<span class="w">        </span><span class="nt">to_value</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">10.0</span>
<span class="w">        </span><span class="nt">step</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.1</span>
</code></pre></div>

<h2 id="64">6.4 é€šä¿¡æ¨¡å¼é€‰æ‹©ç­–ç•¥</h2>
<h3 id="641">6.4.1 æ¨¡å¼å¯¹æ¯”çŸ©é˜µ</h3>
<p>| ç‰¹æ€§ | è¯é¢˜ | æœåŠ¡ | åŠ¨ä½œ | å‚æ•° |</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>è¯é¢˜</th>
<th>æœåŠ¡</th>
<th>åŠ¨ä½œ</th>
<th>å‚æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td>é€šä¿¡æ¨¡å¼</td>
<td>å¼‚æ­¥å¤šå¯¹å¤š</td>
<td>åŒæ­¥ä¸€å¯¹ä¸€</td>
<td>å¼‚æ­¥+åé¦ˆ</td>
<td>é”®å€¼å­˜å‚¨</td>
</tr>
<tr>
<td>æ•°æ®æµå‘</td>
<td>å•å‘</td>
<td>åŒå‘</td>
<td>åŒå‘+çŠ¶æ€</td>
<td>åŒå‘</td>
</tr>
<tr>
<td>é€‚ç”¨é¢‘ç‡</td>
<td>é«˜é¢‘(&gt;100Hz)</td>
<td>ä½é¢‘(&lt;10Hz)</td>
<td>é•¿ä»»åŠ¡</td>
<td>é…ç½®æ›´æ–°</td>
</tr>
<tr>
<td>ç¼“å†²æ”¯æŒ</td>
<td>æ˜¯</td>
<td>å¦</td>
<td>éƒ¨åˆ†</td>
<td>å¦</td>
</tr>
<tr>
<td>QoSé…ç½®</td>
<td>å®Œæ•´</td>
<td>æœ‰é™</td>
<td>æ··åˆ</td>
<td>æ— </td>
</tr>
<tr>
<td>å…¸å‹å»¶è¿Ÿ</td>
<td>&lt;1ms</td>
<td>1-10ms</td>
<td>å¯å˜</td>
<td>10-100ms</td>
</tr>
</tbody>
</table>
<h3 id="642">6.4.2 é€‰æ‹©å†³ç­–æ ‘</h3>
<div class="codehilite"><pre><span></span><code>éœ€è¦é€šä¿¡ï¼Ÿ
â”œâ”€ æ˜¯å‘¨æœŸæ€§æ•°æ®æµï¼Ÿ
â”‚  â”œâ”€ æ˜¯ â†’ ä½¿ç”¨è¯é¢˜
â”‚  â”‚  â”œâ”€ éœ€è¦å¯é ä¼ è¾“ï¼Ÿâ†’ RELIABLE QoS
â”‚  â”‚  â””â”€ å®¹å¿ä¸¢åŒ…ï¼Ÿâ†’ BEST_EFFORT QoS
â”‚  â””â”€ å¦
â”‚     â”œâ”€ æ˜¯è¯·æ±‚-å“åº”ï¼Ÿ
â”‚     â”‚  â”œâ”€ éœ€è¦å¿«é€Ÿå“åº”ï¼Ÿâ†’ æœåŠ¡
â”‚     â”‚  â””â”€ é•¿æ—¶é—´ä»»åŠ¡ï¼Ÿâ†’ åŠ¨ä½œ
â”‚     â””â”€ æ˜¯é…ç½®æ•°æ®ï¼Ÿâ†’ å‚æ•°
</code></pre></div>

<h3 id="643">6.4.3 æ€§èƒ½è€ƒé‡</h3>
<p>é€šä¿¡å¼€é”€åˆ†æï¼ˆåŸºäº 1KB æ¶ˆæ¯ï¼‰ï¼š</p>
<div class="codehilite"><pre><span></span><code>è¯é¢˜ï¼ˆå±€åŸŸç½‘ï¼‰ï¼š

- å»ºç«‹è¿æ¥ï¼š~10ms (ä»…é¦–æ¬¡)
- å•æ¬¡ä¼ è¾“ï¼š~0.1-0.5ms
- ååé‡ï¼š&gt;10000 msg/s

æœåŠ¡ï¼ˆå±€åŸŸç½‘ï¼‰ï¼š

- å»ºç«‹è¿æ¥ï¼š~10ms
- è¯·æ±‚-å“åº”ï¼š~1-5ms
- ååé‡ï¼š~200 calls/s

åŠ¨ä½œï¼ˆå±€åŸŸç½‘ï¼‰ï¼š

- ç›®æ ‡å‘é€ï¼š~5ms
- åé¦ˆæ›´æ–°ï¼š~0.5ms/æ¬¡
- ç»“æœè·å–ï¼š~5ms
</code></pre></div>

<h2 id="65-qos">6.5 QoS ç­–ç•¥è¯¦è§£</h2>
<h3 id="651-qos">6.5.1 QoS é…ç½®ç»´åº¦</h3>
<p>ROS2 æä¾› 10 ä¸ª QoS ç­–ç•¥ç»´åº¦ï¼š</p>
<ol>
<li>
<p><strong>History</strong>ï¼ˆå†å²ç­–ç•¥ï¼‰
   - KEEP_LAST(n)ï¼šä¿ç•™æœ€æ–° n ä¸ªæ ·æœ¬
   - KEEP_ALLï¼šä¿ç•™æ‰€æœ‰æ ·æœ¬ï¼ˆå— Resource Limits é™åˆ¶ï¼‰</p>
</li>
<li>
<p><strong>Reliability</strong>ï¼ˆå¯é æ€§ï¼‰
   - RELIABLEï¼šç¡®ä¿ä¼ è¾“ï¼Œé‡ä¼ ä¸¢å¤±æ•°æ®
   - BEST_EFFORTï¼šå°½åŠ›ä¼ è¾“ï¼Œä¸é‡ä¼ </p>
</li>
<li>
<p><strong>Durability</strong>ï¼ˆæŒä¹…æ€§ï¼‰
   - VOLATILEï¼šä¸ä¿å­˜å†å²æ•°æ®
   - TRANSIENT_LOCALï¼šä¿å­˜å‘å¸ƒè€…å†å²
   - TRANSIENTï¼šä¿å­˜åˆ°æŒä¹…å­˜å‚¨
   - PERSISTENTï¼šæŒä¹…åŒ–åˆ°ç£ç›˜</p>
</li>
<li>
<p><strong>Deadline</strong>ï¼ˆæˆªæ­¢æ—¶é—´ï¼‰
   - è®¾ç½®æ¶ˆæ¯æ›´æ–°å‘¨æœŸæ‰¿è¯º
   - è¿åè§¦å‘ deadline missed äº‹ä»¶</p>
</li>
<li>
<p><strong>Lifespan</strong>ï¼ˆç”Ÿå‘½å‘¨æœŸï¼‰
   - æ¶ˆæ¯æœ‰æ•ˆæœŸï¼Œè¿‡æœŸè‡ªåŠ¨ä¸¢å¼ƒ</p>
</li>
<li>
<p><strong>Liveliness</strong>ï¼ˆæ´»è·ƒæ€§ï¼‰
   - AUTOMATICï¼šDDS è‡ªåŠ¨ç»´æŠ¤
   - MANUAL_BY_TOPICï¼šåº”ç”¨å±‚ç»´æŠ¤
   - MANUAL_BY_NODEï¼šèŠ‚ç‚¹çº§ç»´æŠ¤</p>
</li>
</ol>
<h3 id="652-qos">6.5.2 é¢„å®šä¹‰ QoS é…ç½®</h3>
<p>ROS2 æä¾›å¸¸ç”¨é…ç½®æ¨¡æ¿ï¼š</p>
<div class="codehilite"><pre><span></span><code>ä¼ æ„Ÿå™¨æ•°æ®ï¼ˆSensorDataQoSï¼‰ï¼š

<span class="k">-</span> History: KEEP_LAST(5)
<span class="k">-</span> Reliability: BEST_EFFORT
<span class="k">-</span> Durability: VOLATILE

å‚æ•°ï¼ˆParameterQoSï¼‰ï¼š

<span class="k">-</span> History: KEEP_LAST(1000)
<span class="k">-</span> Reliability: RELIABLE
<span class="k">-</span> Durability: VOLATILE

æœåŠ¡ï¼ˆServicesQoSï¼‰ï¼š

<span class="k">-</span> History: KEEP_LAST(10)
<span class="k">-</span> Reliability: RELIABLE
<span class="k">-</span> Durability: VOLATILE

ç³»ç»Ÿé»˜è®¤ï¼ˆSystemDefaultQoSï¼‰ï¼š

<span class="k">-</span> History: KEEP_LAST(10)
<span class="k">-</span> Reliability: RELIABLE
<span class="k">-</span> Durability: VOLATILE
</code></pre></div>

<h3 id="653-qos">6.5.3 QoS å…¼å®¹æ€§è§„åˆ™</h3>
<p>å‘å¸ƒè€…å’Œè®¢é˜…è€… QoS å¿…é¡»å…¼å®¹ï¼š</p>
<p>| Policy | Publisher | Subscriber | Compatible |</p>
<table>
<thead>
<tr>
<th>Policy</th>
<th>Publisher</th>
<th>Subscriber</th>
<th>Compatible</th>
</tr>
</thead>
<tbody>
<tr>
<td>Reliability</td>
<td>BEST_EFFORT</td>
<td>BEST_EFFORT</td>
<td>âœ“</td>
</tr>
<tr>
<td>Reliability</td>
<td>BEST_EFFORT</td>
<td>RELIABLE</td>
<td>âœ—</td>
</tr>
<tr>
<td>Reliability</td>
<td>RELIABLE</td>
<td>BEST_EFFORT</td>
<td>âœ“</td>
</tr>
<tr>
<td>Reliability</td>
<td>RELIABLE</td>
<td>RELIABLE</td>
<td>âœ“</td>
</tr>
<tr>
<td>Durability</td>
<td>VOLATILE</td>
<td>VOLATILE</td>
<td>âœ“</td>
</tr>
<tr>
<td>Durability</td>
<td>VOLATILE</td>
<td>TRANSIENT_LOCAL</td>
<td>âœ—</td>
</tr>
<tr>
<td>Durability</td>
<td>TRANSIENT_LOCAL</td>
<td>VOLATILE</td>
<td>âœ“</td>
</tr>
</tbody>
</table>
<h2 id="66-dds">6.6 DDS å±‚é…ç½®ä¸ä¼˜åŒ–</h2>
<h3 id="661-dds">6.6.1 DDS å®ç°å¯¹æ¯”</h3>
<p>| ç‰¹æ€§ | Cyclone DDS | Fast DDS | Connext DDS |</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>Cyclone DDS</th>
<th>Fast DDS</th>
<th>Connext DDS</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¼€æº</td>
<td>æ˜¯(Eclipse)</td>
<td>æ˜¯(eProsima)</td>
<td>å¦(RTI)</td>
</tr>
<tr>
<td>é›¶æ‹·è´</td>
<td>iceoryxé›†æˆ</td>
<td>åŸç”Ÿæ”¯æŒ</td>
<td>æ”¯æŒ</td>
</tr>
<tr>
<td>å®‰å…¨æ‰©å±•</td>
<td>åŸºç¡€</td>
<td>å®Œæ•´</td>
<td>å®Œæ•´</td>
</tr>
<tr>
<td>æ€§èƒ½</td>
<td>ä½å»¶è¿Ÿä¼˜åŒ–</td>
<td>é«˜ååä¼˜åŒ–</td>
<td>ä¼ä¸šçº§</td>
</tr>
<tr>
<td>å†…å­˜å ç”¨</td>
<td>å°</td>
<td>ä¸­</td>
<td>å¤§</td>
</tr>
<tr>
<td>å®æ—¶æ€§</td>
<td>è‰¯å¥½</td>
<td>è‰¯å¥½</td>
<td>ä¼˜ç§€</td>
</tr>
</tbody>
</table>
<h3 id="662-xml">6.6.2 XML é…ç½®ä¼˜åŒ–</h3>
<p>Cyclone DDS é…ç½®ç¤ºä¾‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nt">&lt;CycloneDDS&gt;</span>
<span class="w">  </span><span class="nt">&lt;Domain&gt;</span>
<span class="w">    </span><span class="nt">&lt;General&gt;</span>
<span class="w">      </span><span class="nt">&lt;NetworkInterfaceAddress&gt;</span>192.168.1.100<span class="nt">&lt;/NetworkInterfaceAddress&gt;</span>
<span class="w">      </span><span class="nt">&lt;MaxMessageSize&gt;</span>65500B<span class="nt">&lt;/MaxMessageSize&gt;</span>
<span class="w">    </span><span class="nt">&lt;/General&gt;</span>
<span class="w">    </span><span class="nt">&lt;Discovery&gt;</span>
<span class="w">      </span><span class="nt">&lt;ParticipantIndex&gt;</span>0<span class="nt">&lt;/ParticipantIndex&gt;</span>
<span class="w">      </span><span class="nt">&lt;MaxAutoParticipantIndex&gt;</span>120<span class="nt">&lt;/MaxAutoParticipantIndex&gt;</span>
<span class="w">      </span><span class="nt">&lt;Multicast&gt;</span>
<span class="w">        </span><span class="nt">&lt;Address&gt;</span>239.255.0.1<span class="nt">&lt;/Address&gt;</span>
<span class="w">      </span><span class="nt">&lt;/Multicast&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Discovery&gt;</span>
<span class="w">    </span><span class="nt">&lt;Tracing&gt;</span>
<span class="w">      </span><span class="nt">&lt;OutputFile&gt;</span>cyclone.log<span class="nt">&lt;/OutputFile&gt;</span>
<span class="w">      </span><span class="nt">&lt;Verbosity&gt;</span>warning<span class="nt">&lt;/Verbosity&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Tracing&gt;</span>
<span class="w">  </span><span class="nt">&lt;/Domain&gt;</span>
<span class="w">  </span><span class="nt">&lt;DDSI2E&gt;</span>
<span class="w">    </span><span class="nt">&lt;Internal&gt;</span>
<span class="w">      </span><span class="nt">&lt;SocketReceiveBufferSize&gt;</span>2MiB<span class="nt">&lt;/SocketReceiveBufferSize&gt;</span>
<span class="w">      </span><span class="nt">&lt;SocketSendBufferSize&gt;</span>2MiB<span class="nt">&lt;/SocketSendBufferSize&gt;</span>
<span class="w">      </span><span class="nt">&lt;FragmentSize&gt;</span>4000B<span class="nt">&lt;/FragmentSize&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Internal&gt;</span>
<span class="w">  </span><span class="nt">&lt;/DDSI2E&gt;</span>
<span class="nt">&lt;/CycloneDDS&gt;</span>
</code></pre></div>

<h3 id="663">6.6.3 æ€§èƒ½è°ƒä¼˜å‚æ•°</h3>
<p>å…³é”®è°ƒä¼˜ç‚¹ï¼š</p>
<ol>
<li><strong>ç½‘ç»œç¼“å†²åŒº</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># Linux å†…æ ¸å‚æ•°</span>
sudo<span class="w"> </span>sysctl<span class="w"> </span>-w<span class="w"> </span>net.core.rmem_max<span class="o">=</span><span class="m">134217728</span>
sudo<span class="w"> </span>sysctl<span class="w"> </span>-w<span class="w"> </span>net.core.wmem_max<span class="o">=</span><span class="m">134217728</span>
sudo<span class="w"> </span>sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.udp_mem<span class="o">=</span><span class="s2">&quot;102400 873800 16777216&quot;</span>
</code></pre></div>

<ol start="2">
<li>
<p><strong>DDS çº¿ç¨‹é…ç½®</strong>
   - Receive threads: CPU æ ¸å¿ƒæ•°
   - Send threads: 1-2
   - Discovery threads: 1</p>
</li>
<li>
<p><strong>æ¶ˆæ¯åˆ†ç‰‡</strong>
   - Fragment size: MTU - 28 (IP/UDP headers)
   - å±€åŸŸç½‘: 8192B
   - å¹¿åŸŸç½‘: 1400B</p>
</li>
</ol>
<h2 id="67">6.7 äº§ä¸šæ¡ˆä¾‹ç ”ç©¶ï¼šé«˜é¢‘äº¤æ˜“ç³»ç»Ÿçš„ä½å»¶è¿Ÿé€šä¿¡</h2>
<h3 id="optiver">èƒŒæ™¯ï¼šOptiver è‡ªåŠ¨åŒ–äº¤æ˜“æœºå™¨äºº</h3>
<p>Optiver æ˜¯å…¨çƒé¢†å…ˆçš„åšå¸‚å•†ï¼Œå…¶äº¤æ˜“ç³»ç»Ÿå¯¹å»¶è¿Ÿæå…¶æ•æ„Ÿã€‚ä»–ä»¬åŸºäº ROS2 æ„å»ºäº†å®éªŒæ€§çš„ç¡¬ä»¶åŠ é€Ÿäº¤æ˜“æ‰§è¡Œç³»ç»Ÿï¼Œç”¨äºæœŸæƒå®šä»·å’Œé«˜é¢‘äº¤æ˜“ã€‚</p>
<h3 id="_1">æŠ€æœ¯æŒ‘æˆ˜</h3>
<ol>
<li><strong>è¶…ä½å»¶è¿Ÿè¦æ±‚</strong>ï¼šç«¯åˆ°ç«¯å»¶è¿Ÿ &lt; 10Î¼s</li>
<li><strong>ç¡®å®šæ€§æ—¶å»¶</strong>ï¼š99.99% åˆ†ä½æ•° &lt; 50Î¼s</li>
<li><strong>é«˜ååé‡</strong>ï¼šå¤„ç† 100ä¸‡+ æ¶ˆæ¯/ç§’</li>
<li><strong>é›¶æ•°æ®ä¸¢å¤±</strong>ï¼šé‡‘èäº¤æ˜“ä¸å®¹è®¸ä¸¢åŒ…</li>
</ol>
<h3 id="_2">æ¶æ„è®¾è®¡</h3>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      Kernel Bypass      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Market Data  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚FPGA Receiver â”‚
â”‚   Feed      â”‚         DPDK/RDMA        â”‚   (10G NIC)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚ Zero Copy
                                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      Shared Memory      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Strategy    â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚ ROS2 Node    â”‚
â”‚   Engine    â”‚         iceoryx          â”‚ (RT Kernel)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                                 â”‚
                                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      InfiniBand         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Order Router â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚Exchange Gate â”‚
â”‚             â”‚         RDMA             â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="_3">å…³é”®ä¼˜åŒ–æªæ–½</h3>
<ol>
<li><strong>å†…æ ¸æ—è·¯æŠ€æœ¯</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨ DPDK ç»•è¿‡å†…æ ¸ç½‘ç»œæ ˆ</span>
<span class="n">rte_eth_rx_burst</span><span class="p">(</span><span class="n">port_id</span><span class="p">,</span><span class="w"> </span><span class="n">queue_id</span><span class="p">,</span><span class="w"> </span><span class="n">rx_pkts</span><span class="p">,</span><span class="w"> </span><span class="n">MAX_BURST</span><span class="p">);</span>

<span class="c1">// ç›´æ¥æ˜ å°„ç½‘å¡é˜Ÿåˆ—åˆ°ç”¨æˆ·ç©ºé—´</span>
<span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">rx_ring</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">ring_size</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="n">PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_WRITE</span><span class="p">,</span>
<span class="w">                    </span><span class="n">MAP_SHARED</span><span class="p">,</span><span class="w"> </span><span class="n">nic_fd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
</code></pre></div>

<ol start="2">
<li><strong>CPU äº²å’Œæ€§ç»‘å®š</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// éš”ç¦» CPU æ ¸å¿ƒ</span>
<span class="c1">// /boot/cmdline: isolcpus=2-7 nohz_full=2-7 rcu_nocbs=2-7</span>

<span class="kt">cpu_set_t</span><span class="w"> </span><span class="n">cpuset</span><span class="p">;</span>
<span class="n">CPU_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="n">CPU_SET</span><span class="p">(</span><span class="n">isolated_core</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="n">pthread_setaffinity_np</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cpuset</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
</code></pre></div>

<ol start="3">
<li><strong>å†…å­˜é¢„åˆ†é…ä¸å¤§é¡µ</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// 2MB å¤§é¡µå‡å°‘ TLB miss</span>
<span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">pool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mmap</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="n">POOL_SIZE</span><span class="p">,</span>
<span class="w">                 </span><span class="n">PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_WRITE</span><span class="p">,</span>
<span class="w">                 </span><span class="n">MAP_PRIVATE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MAP_ANONYMOUS</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MAP_HUGETLB</span><span class="p">,</span>
<span class="w">                 </span><span class="mi">-1</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="c1">// é¢„çƒ­ç¼“å­˜</span>
<span class="n">memset</span><span class="p">(</span><span class="n">pool</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">POOL_SIZE</span><span class="p">);</span>
</code></pre></div>

<ol start="4">
<li><strong>è‡ªå®šä¹‰ DDS é…ç½®</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="nt">&lt;Cyclone&gt;</span>
<span class="w">  </span><span class="nt">&lt;DDSI2E&gt;</span>
<span class="w">    </span><span class="nt">&lt;General&gt;</span>
<span class="w">      </span><span class="nt">&lt;CoalesceInterval&gt;</span>0ns<span class="nt">&lt;/CoalesceInterval&gt;</span>
<span class="w">      </span><span class="nt">&lt;MaxMessageSize&gt;</span>1400B<span class="nt">&lt;/MaxMessageSize&gt;</span>
<span class="w">    </span><span class="nt">&lt;/General&gt;</span>
<span class="w">    </span><span class="nt">&lt;Internal&gt;</span>
<span class="w">      </span><span class="nt">&lt;ReceiveThreadMode&gt;</span>Exclusive<span class="nt">&lt;/ReceiveThreadMode&gt;</span>
<span class="w">      </span><span class="nt">&lt;ReceiveThreadPriority&gt;</span>99<span class="nt">&lt;/ReceiveThreadPriority&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Internal&gt;</span>
<span class="w">  </span><span class="nt">&lt;/DDSI2E&gt;</span>
<span class="nt">&lt;/Cyclone&gt;</span>
</code></pre></div>

<h3 id="_4">æ€§èƒ½æŒ‡æ ‡</h3>
<p>å®æµ‹ç»“æœï¼ˆIntel Xeon Gold 6258R + Mellanox ConnectX-6ï¼‰ï¼š</p>
<p>| æŒ‡æ ‡ | åŸå§‹ ROS2 | ä¼˜åŒ–å | æå‡ |</p>
<table>
<thead>
<tr>
<th>æŒ‡æ ‡</th>
<th>åŸå§‹ ROS2</th>
<th>ä¼˜åŒ–å</th>
<th>æå‡</th>
</tr>
</thead>
<tbody>
<tr>
<td>å¹³å‡å»¶è¿Ÿ</td>
<td>250Î¼s</td>
<td>8Î¼s</td>
<td>31x</td>
</tr>
<tr>
<td>P99 å»¶è¿Ÿ</td>
<td>1.2ms</td>
<td>45Î¼s</td>
<td>26x</td>
</tr>
<tr>
<td>P99.9 å»¶è¿Ÿ</td>
<td>5ms</td>
<td>120Î¼s</td>
<td>41x</td>
</tr>
<tr>
<td>ååé‡</td>
<td>50K msg/s</td>
<td>1.2M msg/s</td>
<td>24x</td>
</tr>
<tr>
<td>CPU ä½¿ç”¨ç‡</td>
<td>45%</td>
<td>98%</td>
<td>-</td>
</tr>
<tr>
<td>å†…å­˜å¸¦å®½</td>
<td>2.1 GB/s</td>
<td>28 GB/s</td>
<td>13x</td>
</tr>
</tbody>
</table>
<h3 id="_5">è¸©å‘ä¸è§£å†³æ–¹æ¡ˆ</h3>
<ol>
<li>
<p><strong>é—®é¢˜</strong>ï¼šDDS å‘ç°æœºåˆ¶å¯¼è‡´å¯åŠ¨å»¶è¿Ÿ
   <strong>è§£å†³</strong>ï¼šä½¿ç”¨é™æ€å‘ç°ï¼Œé¢„é…ç½®æ‰€æœ‰ç«¯ç‚¹</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šåƒåœ¾å›æ”¶å¯¼è‡´å»¶è¿Ÿå°–å³°
   <strong>è§£å†³</strong>ï¼šç¦ç”¨åŠ¨æ€å†…å­˜åˆ†é…ï¼Œä½¿ç”¨å¯¹è±¡æ± </p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šä¸­æ–­å¯¼è‡´æŠ–åŠ¨
   <strong>è§£å†³</strong>ï¼šä¸­æ–­äº²å’Œæ€§ç»‘å®šåˆ°éå…³é”®æ ¸å¿ƒ</p>
</li>
<li>
<p><strong>é—®é¢˜</strong>ï¼šæ—¶é—´æˆ³ä¸å‡†ç¡®
   <strong>è§£å†³</strong>ï¼šä½¿ç”¨ TSC æ—¶é’Ÿæºï¼ŒPTP ç¡¬ä»¶æ—¶é—´æˆ³</p>
</li>
</ol>
<h3 id="_6">ç»éªŒæ€»ç»“</h3>
<ul>
<li>é‡‘èåœºæ™¯éœ€è¦æ·±åº¦å®šåˆ¶ ROS2 æ ˆ</li>
<li>ç¡¬ä»¶åŠ é€Ÿï¼ˆFPGA/SmartNICï¼‰æ˜¯å…³é”®</li>
<li>å®æ—¶å†…æ ¸ + CPU éš”ç¦»å¿…ä¸å¯å°‘</li>
<li>ç›‘æ§å’Œè°ƒè¯•å·¥å…·é“¾éœ€è¦åŒæ­¥å»ºè®¾</li>
</ul>
<h2 id="68">6.8 é«˜çº§è¯é¢˜</h2>
<h3 id="681">6.8.1 é›¶æ‹·è´é€šä¿¡ä¸å…±äº«å†…å­˜ä¼˜åŒ–</h3>
<h4 id="eclipse-iceoryx">Eclipse iceoryx é›†æˆ</h4>
<p>iceoryx æä¾›çœŸæ­£çš„é›¶æ‹·è´å…±äº«å†…å­˜ä¼ è¾“ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// å‘å¸ƒè€…ç«¯ - Loaned Message</span>
<span class="k">auto</span><span class="w"> </span><span class="n">loaned_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">publisher</span><span class="o">-&gt;</span><span class="n">borrow_loaned_message</span><span class="p">();</span>
<span class="n">loaned_msg</span><span class="p">.</span><span class="n">get</span><span class="p">().</span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sensor_data</span><span class="p">;</span><span class="w">  </span><span class="c1">// ç›´æ¥å†™å…¥å…±äº«å†…å­˜</span>
<span class="n">publisher</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">loaned_msg</span><span class="p">));</span>

<span class="c1">// è®¢é˜…è€…ç«¯ - Zero Copy</span>
<span class="n">subscription</span><span class="o">-&gt;</span><span class="n">take_loaned_message</span><span class="p">(</span>
<span class="w">  </span><span class="p">[](</span><span class="k">const</span><span class="w"> </span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">PointCloud2</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ç›´æ¥è®¿é—®å…±äº«å†…å­˜ï¼Œæ— æ‹·è´</span>
<span class="w">    </span><span class="n">process_pointcloud</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">());</span>
<span class="w">  </span><span class="p">});</span>
</code></pre></div>

<p>æ€§èƒ½å¯¹æ¯”ï¼ˆ10MB ç‚¹äº‘æ•°æ®ï¼‰ï¼š</p>
<ul>
<li>ä¼ ç»Ÿæ–¹å¼ï¼šåºåˆ—åŒ–(2ms) + ä¼ è¾“(5ms) + ååºåˆ—åŒ–(2ms) = 9ms</li>
<li>é›¶æ‹·è´ï¼šæŒ‡é’ˆä¼ é€’ &lt; 10Î¼s</li>
</ul>
<h4 id="_7">å…³é”®è®ºæ–‡</h4>
<ol>
<li>
<p><strong>"Zero-Copy Message Passing for Robotics"</strong> (IROS 2021)
   - ä½œè€…ï¼šPÃ¶hnl et al., Bosch
   - è´¡çŒ®ï¼šå½¢å¼åŒ–é›¶æ‹·è´æ¡ä»¶ï¼Œè¯æ˜å®‰å…¨æ€§
   - å…³é”®è§è§£ï¼šç±»å‹çº¦æŸä¸ç”Ÿå‘½å‘¨æœŸç®¡ç†</p>
</li>
<li>
<p><strong>"Real-Time Capable Data Distribution Service"</strong> (RTSS 2019)
   - ä½œè€…ï¼šKampmann et al., TU Munich<br />
   - è´¡çŒ®ï¼šDDS å®æ—¶æ€§åˆ†ææ¡†æ¶
   - å…³é”®è§è§£ï¼šæœ€åæƒ…å†µæ‰§è¡Œæ—¶é—´(WCET)å»ºæ¨¡</p>
</li>
</ol>
<h3 id="682">6.8.2 ç½‘ç»œæ‹¥å¡æ§åˆ¶ä¸æµé‡æ•´å½¢</h3>
<h4 id="token-bucket">Token Bucket ç®—æ³•å®ç°</h4>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TokenBucket</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">last_refill_</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">tokens_</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">capacity_</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">refill_rate_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">try_consume</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">bytes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">refill</span><span class="p">();</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">required</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1024.0</span><span class="p">;</span><span class="w">  </span><span class="c1">// KB</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">tokens_</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">required</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">tokens_</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">required</span><span class="p">;</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">refill</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">elapsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_refill_</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">new_tokens</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elapsed</span><span class="p">.</span><span class="n">count</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">refill_rate_</span><span class="p">;</span>
<span class="w">    </span><span class="n">tokens_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">capacity_</span><span class="p">,</span><span class="w"> </span><span class="n">tokens_</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">new_tokens</span><span class="p">);</span>
<span class="w">    </span><span class="n">last_refill_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h4 id="qos">è‡ªé€‚åº” QoS è°ƒæ•´</h4>
<p>åŸºäºç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´ QoSï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AdaptiveQoS</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">adjust_qos_based_on_rtt</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">rtt_ms</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rtt_ms</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// ç½‘ç»œæ‹¥å¡ï¼Œé™ä½å‘é€é¢‘ç‡</span>
<span class="w">      </span><span class="n">qos_</span><span class="p">.</span><span class="n">reliability</span><span class="p">(</span><span class="n">RMW_QOS_POLICY_RELIABILITY_BEST_EFFORT</span><span class="p">);</span>
<span class="w">      </span><span class="n">qos_</span><span class="p">.</span><span class="n">history</span><span class="p">(</span><span class="n">RMW_QOS_POLICY_HISTORY_KEEP_LAST</span><span class="p">);</span>
<span class="w">      </span><span class="n">qos_</span><span class="p">.</span><span class="n">depth</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rtt_ms</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// ç½‘ç»œè‰¯å¥½ï¼Œæé«˜å¯é æ€§</span>
<span class="w">      </span><span class="n">qos_</span><span class="p">.</span><span class="n">reliability</span><span class="p">(</span><span class="n">RMW_QOS_POLICY_RELIABILITY_RELIABLE</span><span class="p">);</span>
<span class="w">      </span><span class="n">qos_</span><span class="p">.</span><span class="n">depth</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="683">6.8.3 åˆ†å¸ƒå¼è¿½è¸ªä¸å¯è§‚æµ‹æ€§</h3>
<h4 id="opentelemetry">OpenTelemetry é›†æˆ</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// è·¨èŠ‚ç‚¹è¿½è¸ªä¸Šä¸‹æ–‡ä¼ æ’­</span>
<span class="k">class</span><span class="w"> </span><span class="nc">TracedPublisher</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">publish_with_trace</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Message</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">span</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tracer</span><span class="o">-&gt;</span><span class="n">StartSpan</span><span class="p">(</span><span class="s">&quot;publish_message&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// æ³¨å…¥è¿½è¸ªä¸Šä¸‹æ–‡åˆ°æ¶ˆæ¯å¤´</span>
<span class="w">    </span><span class="n">TextMapCarrier</span><span class="w"> </span><span class="n">carrier</span><span class="p">;</span>
<span class="w">    </span><span class="n">propagator</span><span class="o">-&gt;</span><span class="n">Inject</span><span class="p">(</span><span class="n">carrier</span><span class="p">,</span><span class="w"> </span><span class="n">span</span><span class="o">-&gt;</span><span class="n">GetContext</span><span class="p">());</span>

<span class="w">    </span><span class="n">msg</span><span class="p">.</span><span class="n">_metadata</span><span class="p">.</span><span class="n">trace_parent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">carrier</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&quot;traceparent&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">msg</span><span class="p">.</span><span class="n">_metadata</span><span class="p">.</span><span class="n">trace_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">carrier</span><span class="p">.</span><span class="n">Get</span><span class="p">(</span><span class="s">&quot;tracestate&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="n">publisher_</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="w">    </span><span class="n">span</span><span class="o">-&gt;</span><span class="n">End</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p>ç”Ÿæˆçš„è¿½è¸ªæ•°æ®å¯è§†åŒ–ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">[Node A: Sensor]          [Node B: Filter]         [Node C: Control]</span>
<span class="w">     </span><span class="na">â”‚                           â”‚                        â”‚</span>
<span class="w">     </span><span class="na">â”œâ”€â”€publish(100ms)â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                        â”‚</span>
<span class="w">     </span><span class="na">â”‚                           â”œâ”€â”€process(50ms)â”€â”€â”€â–º     â”‚</span>
<span class="w">     </span><span class="na">â”‚                           â”‚                   â””â”€â”€â–ºcompute(30ms)</span>
<span class="w">     </span><span class="na">â”‚                           â”‚                        â”‚</span>
<span class="w">     </span><span class="na">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                        </span><span class="na">Total Latency</span><span class="o">:</span><span class="w"> </span><span class="s">180ms</span>
</code></pre></div>

<h3 id="684">6.8.4 å¼€æºé¡¹ç›®æ¨è</h3>
<ol>
<li>
<p><strong>ros2_tracing</strong>
   - åŠŸèƒ½ï¼šLTTng é›†æˆçš„æ€§èƒ½åˆ†æ
   - ç‰¹ç‚¹ï¼šçº³ç§’çº§æ—¶é—´æˆ³ï¼Œä½å¼€é”€
   - åº”ç”¨ï¼šå»¶è¿Ÿåˆ†æï¼Œæ‰§è¡Œæµè¿½è¸ª</p>
</li>
<li>
<p><strong>rmw_iceoryx</strong>
   - åŠŸèƒ½ï¼šiceoryx å…±äº«å†…å­˜ä¼ è¾“
   - ç‰¹ç‚¹ï¼šçœŸé›¶æ‹·è´ï¼Œå¾®ç§’çº§å»¶è¿Ÿ
   - åº”ç”¨ï¼šé«˜å¸¦å®½ä¼ æ„Ÿå™¨æ•°æ®</p>
</li>
<li>
<p><strong>performance_test</strong>
   - åŠŸèƒ½ï¼šROS2 é€šä¿¡æ€§èƒ½åŸºå‡†æµ‹è¯•
   - ç‰¹ç‚¹ï¼šå¤šç§é€šä¿¡æ¨¡å¼å¯¹æ¯”
   - åº”ç”¨ï¼šç³»ç»Ÿè°ƒä¼˜éªŒè¯</p>
</li>
</ol>
<h2 id="69">6.9 æœ¬ç« å°ç»“</h2>
<h3 id="_8">æ ¸å¿ƒæ¦‚å¿µå›é¡¾</h3>
<ol>
<li><strong>é€šä¿¡æ¨¡å¼å±‚æ¬¡</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code>åº”ç”¨å±‚ï¼šTopics, Services, Actions, Parameters
   â†“
ä¸­é—´ä»¶å±‚ï¼šrmw (ROS Middleware)
   â†“  
DDSå±‚ï¼šRTPS Discovery, QoS Policies
   â†“
ä¼ è¾“å±‚ï¼šUDP/TCP, Shared Memory
</code></pre></div>

<ol start="2">
<li><strong>æ€§èƒ½ä¼˜åŒ–å…¬å¼</strong></li>
</ol>
<p>æ€»å»¶è¿Ÿ = åºåˆ—åŒ–æ—¶é—´ + ä¼ è¾“æ—¶é—´ + ååºåˆ—åŒ–æ—¶é—´ + å¤„ç†æ—¶é—´</p>
<p>å…¶ä¸­ï¼š</p>
<ul>
<li>åºåˆ—åŒ–æ—¶é—´ âˆ æ¶ˆæ¯å¤§å° Ã— å¤æ‚åº¦</li>
<li>ä¼ è¾“æ—¶é—´ = æ¶ˆæ¯å¤§å° / å¸¦å®½ + å¾€è¿”æ—¶å»¶</li>
<li>é›¶æ‹·è´å¯å°†å‰ä¸‰é¡¹é™è‡³ O(1)</li>
</ul>
<ol start="3">
<li><strong>QoS åŒ¹é…è§„åˆ™</strong></li>
</ol>
<p>å…¼å®¹æ€§ = âˆ(Policy_pub âŠ‡ Policy_sub)</p>
<p>å…¶ä¸­ âŠ‡ è¡¨ç¤ºå‘å¸ƒè€…ç­–ç•¥æ»¡è¶³è®¢é˜…è€…è¦æ±‚</p>
<h3 id="_9">å…³é”®å†³ç­–ç‚¹</h3>
<ul>
<li><strong>è¯é¢˜ vs æœåŠ¡</strong>ï¼šå¼‚æ­¥æ•°æ®æµç”¨è¯é¢˜ï¼ŒåŒæ­¥è¯·æ±‚ç”¨æœåŠ¡</li>
<li><strong>QoS é€‰æ‹©</strong>ï¼šä¼ æ„Ÿå™¨ç”¨ BEST_EFFORTï¼Œæ§åˆ¶å‘½ä»¤ç”¨ RELIABLE</li>
<li><strong>DDS é€‰æ‹©</strong>ï¼šä½å»¶è¿Ÿé€‰ Cycloneï¼Œé«˜ååé€‰ Fast DDS</li>
<li><strong>ä¼˜åŒ–ç­–ç•¥</strong>ï¼šå…ˆä¼˜åŒ–ç®—æ³•ï¼Œå†ä¼˜åŒ–ä¼ è¾“ï¼Œæœ€åè€ƒè™‘ç¡¬ä»¶åŠ é€Ÿ</li>
</ul>
<h2 id="610">6.10 å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<h3 id="1qos">é™·é˜± 1ï¼šQoS ä¸åŒ¹é…å¯¼è‡´é€šä¿¡å¤±è´¥</h3>
<p><strong>ç—‡çŠ¶</strong>ï¼šå‘å¸ƒè€…å’Œè®¢é˜…è€…éƒ½æ­£å¸¸è¿è¡Œï¼Œä½†æ”¶ä¸åˆ°æ•°æ®</p>
<p><strong>è¯Šæ–­</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>ros2<span class="w"> </span>topic<span class="w"> </span>info<span class="w"> </span>/topic_name<span class="w"> </span>--verbose
<span class="c1"># æ£€æŸ¥ QoS é…ç½®æ˜¯å¦åŒ¹é…</span>
</code></pre></div>

<p><strong>è§£å†³</strong>ï¼šä½¿ç”¨ QoS override æˆ–ç»Ÿä¸€é…ç½®</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// è‡ªé€‚åº” QoS</span>
<span class="n">rmw_qos_profile_t</span><span class="w"> </span><span class="n">qos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rmw_qos_profile_sensor_data</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">need_reliable</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">qos</span><span class="p">.</span><span class="n">reliability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RMW_QOS_POLICY_RELIABILITY_RELIABLE</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="2">é™·é˜± 2ï¼šå¤§æ¶ˆæ¯å¯¼è‡´åˆ†ç‰‡å’Œä¸¢åŒ…</h3>
<p><strong>ç—‡çŠ¶</strong>ï¼šå°æ¶ˆæ¯æ­£å¸¸ï¼Œå¤§äº 64KB æ¶ˆæ¯ä¸¢å¤±</p>
<p><strong>åŸå› </strong>ï¼šUDP åˆ†ç‰‡åœ¨æ‹¥å¡æ—¶æ˜“ä¸¢å¤±</p>
<p><strong>è§£å†³</strong>ï¼š</p>
<ol>
<li>å¢å¤§ DDS ç¼“å†²åŒº</li>
<li>ä½¿ç”¨ TCP ä¼ è¾“å¤§æ¶ˆæ¯</li>
<li>æ¶ˆæ¯åˆ†å—åº”ç”¨å±‚å¤„ç†</li>
</ol>
<h3 id="3">é™·é˜± 3ï¼šåŒæ­¥æœåŠ¡è°ƒç”¨æ­»é”</h3>
<p><strong>ç—‡çŠ¶</strong>ï¼šæœåŠ¡è°ƒç”¨æŒ‚èµ·ï¼ŒèŠ‚ç‚¹æ— å“åº”</p>
<p><strong>ä»£ç ç¤ºä¾‹ï¼ˆé”™è¯¯ï¼‰</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">callback</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="o">-&gt;</span><span class="n">async_send_request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>
<span class="w">  </span><span class="n">future</span><span class="p">.</span><span class="n">wait</span><span class="p">();</span><span class="w">  </span><span class="c1">// æ­»é”ï¼å›è°ƒä¸­é˜»å¡</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>è§£å†³</strong>ï¼šä½¿ç”¨å¼‚æ­¥æ¨¡å¼æˆ–ç‹¬ç«‹æ‰§è¡Œå™¨</p>
<h3 id="4">é™·é˜± 4ï¼šå‚æ•°æ›´æ–°ç«æ€æ¡ä»¶</h3>
<p><strong>ç—‡çŠ¶</strong>ï¼šå‚æ•°è®¾ç½®åç«‹å³è¯»å–å¾—åˆ°æ—§å€¼</p>
<p><strong>åŸå› </strong>ï¼šå‚æ•°æœåŠ¡å¼‚æ­¥å¤„ç†</p>
<p><strong>è§£å†³</strong>ï¼šä½¿ç”¨å‚æ•°äº‹ä»¶ç¡®è®¤æ›´æ–°</p>
<div class="codehilite"><pre><span></span><code><span class="k">auto</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node</span><span class="o">-&gt;</span><span class="n">set_parameter</span><span class="p">(</span><span class="n">param</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">successful</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="c1">// ç­‰å¾…å‚æ•°äº‹ä»¶ç¡®è®¤</span>
<span class="w">  </span><span class="n">wait_for_parameter_event</span><span class="p">(</span><span class="n">param_name</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="5">é™·é˜± 5ï¼šåŠ¨ä½œç›®æ ‡è¦†ç›–</h3>
<p><strong>ç—‡çŠ¶</strong>ï¼šæ–°ç›®æ ‡å–æ¶ˆäº†æ­£åœ¨æ‰§è¡Œçš„ç›®æ ‡</p>
<p><strong>åŸå› </strong>ï¼šé»˜è®¤ GoalID é‡ç”¨</p>
<p><strong>è§£å†³</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨å”¯ä¸€ GoalID</span>
<span class="n">goal_msg</span><span class="p">.</span><span class="n">goal_id</span><span class="p">.</span><span class="n">uuid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generate_uuid</span><span class="p">();</span>
</code></pre></div>

<h3 id="_10">è°ƒè¯•æŠ€å·§æ¸…å•</h3>
<ol>
<li><strong>é€šä¿¡è°ƒè¯•</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># ç›‘æ§è¯é¢˜</span>
ros2<span class="w"> </span>topic<span class="w"> </span><span class="nb">echo</span><span class="w"> </span>/topic<span class="w"> </span>--qos-profile<span class="w"> </span>sensor_data

<span class="c1"># æ£€æŸ¥èŠ‚ç‚¹å›¾</span>
ros2<span class="w"> </span>node<span class="w"> </span>info<span class="w"> </span>/node_name

<span class="c1"># DDS è°ƒè¯•</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">RMW_IMPLEMENTATION</span><span class="o">=</span>rmw_cyclonedds_cpp
<span class="nb">export</span><span class="w"> </span><span class="nv">CYCLONEDDS_TRACE</span><span class="o">=</span>trace.log
</code></pre></div>

<ol start="2">
<li><strong>æ€§èƒ½åˆ†æ</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># CPU åˆ†æ</span>
perf<span class="w"> </span>record<span class="w"> </span>-g<span class="w"> </span>ros2<span class="w"> </span>run<span class="w"> </span>package<span class="w"> </span>node
perf<span class="w"> </span>report

<span class="c1"># ç½‘ç»œåˆ†æ  </span>
tcpdump<span class="w"> </span>-i<span class="w"> </span>lo<span class="w"> </span>-w<span class="w"> </span>ros2.pcap<span class="w"> </span><span class="s1">&#39;udp port 7400&#39;</span>

<span class="c1"># è¿½è¸ªåˆ†æ</span>
ros2<span class="w"> </span>trace<span class="w"> </span>start<span class="w"> </span>session_name
</code></pre></div>

<ol start="3">
<li><strong>å†…å­˜è°ƒè¯•</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># å†…å­˜æ³„æ¼</span>
valgrind<span class="w"> </span>--leak-check<span class="o">=</span>full<span class="w"> </span>ros2<span class="w"> </span>run<span class="w"> </span>package<span class="w"> </span>node

<span class="c1"># å†…å­˜åˆ†æ</span>
heaptrack<span class="w"> </span>ros2<span class="w"> </span>run<span class="w"> </span>package<span class="w"> </span>node
</code></pre></div>

<h2 id="611">6.11 ç»ƒä¹ é¢˜</h2>
<h3 id="_11">åŸºç¡€é¢˜ï¼ˆç†è§£æ¦‚å¿µï¼‰</h3>
<p><strong>ç»ƒä¹  6.1</strong>ï¼šè¯é¢˜é€šä¿¡å»¶è¿Ÿåˆ†æ</p>
<p>ç»™å®šä¸€ä¸ª ROS2 ç³»ç»Ÿï¼Œå‘å¸ƒè€…ä»¥ 100Hz å‘é€ 1MB çš„ç‚¹äº‘æ•°æ®ï¼Œç½‘ç»œå¸¦å®½ä¸º 1Gbpsï¼Œè®¡ç®—ï¼š</p>
<ol>
<li>ç†è®ºæœ€å°å»¶è¿Ÿ</li>
<li>è€ƒè™‘åºåˆ—åŒ–å¼€é”€(10%)çš„å®é™…å»¶è¿Ÿ  </li>
<li>ä½¿ç”¨é›¶æ‹·è´åçš„å»¶è¿Ÿ</li>
</ol>
<p>ğŸ’¡ <strong>æç¤º</strong>ï¼šè€ƒè™‘åºåˆ—åŒ–ã€ä¼ è¾“ã€ååºåˆ—åŒ–ä¸‰ä¸ªé˜¶æ®µ</p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<ol>
<li>
<p>ç†è®ºæœ€å°å»¶è¿Ÿï¼š
   - ä¼ è¾“æ—¶é—´ = 1MB / (1Gbps/8) = 8ms
   - ç†è®ºæœ€å° = 8ms</p>
</li>
<li>
<p>å®é™…å»¶è¿Ÿï¼š
   - åºåˆ—åŒ– = 1MB Ã— 10% / (CPUå¤„ç†é€Ÿåº¦) â‰ˆ 1ms
   - ä¼ è¾“ = 8ms
   - ååºåˆ—åŒ– = 1ms
   - æ€»è®¡ = 10ms</p>
</li>
<li>
<p>é›¶æ‹·è´å»¶è¿Ÿï¼š
   - æŒ‡é’ˆä¼ é€’ &lt; 0.01ms
   - å‡ ä¹å¯å¿½ç•¥</p>
</li>
</ol>
</details>
<p><strong>ç»ƒä¹  6.2</strong>ï¼šQoS å…¼å®¹æ€§åˆ¤æ–­</p>
<p>åˆ¤æ–­ä»¥ä¸‹å‘å¸ƒè€…å’Œè®¢é˜…è€…é…ç½®æ˜¯å¦å…¼å®¹ï¼Œå¹¶è¯´æ˜åŸå› ï¼š</p>
<p>| åœºæ™¯ | Publisher QoS | Subscriber QoS | å…¼å®¹? |</p>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>Publisher QoS</th>
<th>Subscriber QoS</th>
<th>å…¼å®¹?</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td>RELIABLE, TRANSIENT_LOCAL</td>
<td>BEST_EFFORT, VOLATILE</td>
<td>?</td>
</tr>
<tr>
<td>B</td>
<td>BEST_EFFORT, VOLATILE</td>
<td>RELIABLE, VOLATILE</td>
<td>?</td>
</tr>
<tr>
<td>C</td>
<td>RELIABLE, VOLATILE</td>
<td>RELIABLE, TRANSIENT_LOCAL</td>
<td>?</td>
</tr>
</tbody>
</table>
<p>ğŸ’¡ <strong>æç¤º</strong>ï¼šå‘å¸ƒè€…å¿…é¡»æ»¡è¶³è®¢é˜…è€…çš„æœ€ä½è¦æ±‚</p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<ul>
<li>åœºæ™¯ Aï¼šå…¼å®¹ âœ“</li>
<li>Reliability: RELIABLE âŠ‡ BEST_EFFORT</li>
<li>
<p>Durability: TRANSIENT_LOCAL âŠ‡ VOLATILE</p>
</li>
<li>
<p>åœºæ™¯ Bï¼šä¸å…¼å®¹ âœ—</p>
</li>
<li>Reliability: BEST_EFFORT âŠ‰ RELIABLE</li>
<li>
<p>è®¢é˜…è€…è¦æ±‚ RELIABLEï¼Œå‘å¸ƒè€…åªæä¾› BEST_EFFORT</p>
</li>
<li>
<p>åœºæ™¯ Cï¼šä¸å…¼å®¹ âœ—</p>
</li>
<li>Durability: VOLATILE âŠ‰ TRANSIENT_LOCAL</li>
<li>è®¢é˜…è€…è¦æ±‚å†å²æ•°æ®ï¼Œå‘å¸ƒè€…ä¸ä¿å­˜</li>
</ul>
</details>
<p><strong>ç»ƒä¹  6.3</strong>ï¼šæœåŠ¡è¶…æ—¶è®¾è®¡</p>
<p>è®¾è®¡ä¸€ä¸ªæœåŠ¡è°ƒç”¨ï¼Œè¦æ±‚ï¼š</p>
<ol>
<li>è¶…æ—¶æ—¶é—´ 5 ç§’</li>
<li>å¤±è´¥åé‡è¯• 3 æ¬¡</li>
<li>æŒ‡æ•°é€€é¿ç­–ç•¥</li>
</ol>
<p>ğŸ’¡ <strong>æç¤º</strong>ï¼šä½¿ç”¨ future å’Œ chrono</p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">ServiceT</span><span class="o">&gt;</span>
<span class="kt">bool</span><span class="w"> </span><span class="n">call_service_with_retry</span><span class="p">(</span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">rclcpp</span><span class="o">::</span><span class="n">Client</span><span class="o">&lt;</span><span class="n">ServiceT</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">client</span><span class="p">,</span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">ServiceT</span><span class="o">::</span><span class="n">Request</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">request</span><span class="p">,</span>
<span class="w">    </span><span class="k">typename</span><span class="w"> </span><span class="nc">ServiceT</span><span class="o">::</span><span class="n">Response</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">max_retries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">base_timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">max_retries</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_timeout</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">client</span><span class="o">-&gt;</span><span class="n">async_send_request</span><span class="p">(</span><span class="n">request</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">future</span><span class="p">.</span><span class="n">wait_for</span><span class="p">(</span><span class="n">timeout</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">future_status</span><span class="o">::</span><span class="n">ready</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">future</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">RCLCPP_WARN</span><span class="p">(</span><span class="n">node</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span>
<span class="w">                   </span><span class="s">&quot;Service call timeout, retry %d/%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">max_retries</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

</details>
<p><strong>ç»ƒä¹  6.4</strong>ï¼šå‚æ•°éªŒè¯å™¨å®ç°</p>
<p>å®ç°ä¸€ä¸ªå‚æ•°éªŒè¯å™¨ï¼Œæ»¡è¶³ï¼š</p>
<ol>
<li>é€Ÿåº¦å‚æ•°èŒƒå›´ [0.0, 10.0]</li>
<li>åç§°å‚æ•°éç©ºå­—ç¬¦ä¸²</li>
<li>æ¨¡å¼å‚æ•°åªèƒ½æ˜¯ "auto", "manual", "hybrid"</li>
</ol>
<p>ğŸ’¡ <strong>æç¤º</strong>ï¼šä½¿ç”¨ set_on_parameters_callback</p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="n">rcl_interfaces</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">SetParametersResult</span><span class="w"> </span>
<span class="nf">validate_parameters</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Parameter</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">params</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">rcl_interfaces</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">SetParametersResult</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="w">    </span><span class="n">result</span><span class="p">.</span><span class="n">successful</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">param</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">params</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="p">.</span><span class="n">get_name</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;velocity&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param</span><span class="p">.</span><span class="n">as_double</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">val</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">val</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">10.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="n">successful</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Velocity must be in [0.0, 10.0]&quot;</span><span class="p">;</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="p">.</span><span class="n">get_name</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="p">.</span><span class="n">as_string</span><span class="p">().</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="n">successful</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Name cannot be empty&quot;</span><span class="p">;</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">param</span><span class="p">.</span><span class="n">get_name</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;mode&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">param</span><span class="p">.</span><span class="n">as_string</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;auto&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;manual&quot;</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">mode</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="s">&quot;hybrid&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="n">successful</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">                </span><span class="n">result</span><span class="p">.</span><span class="n">reason</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Invalid mode&quot;</span><span class="p">;</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="c1">// æ³¨å†Œå›è°ƒ</span>
<span class="n">node</span><span class="o">-&gt;</span><span class="n">add_on_set_parameters_callback</span><span class="p">(</span><span class="n">validate_parameters</span><span class="p">);</span>
</code></pre></div>

</details>
<h3 id="_12">æŒ‘æˆ˜é¢˜ï¼ˆæ·±å…¥ç†è§£ï¼‰</h3>
<p><strong>ç»ƒä¹  6.5</strong>ï¼šè‡ªå®šä¹‰ QoS è‡ªé€‚åº”ç®—æ³•</p>
<p>è®¾è®¡ä¸€ä¸ª QoS è‡ªé€‚åº”ç®—æ³•ï¼Œæ ¹æ®ç½‘ç»œçŠ¶å†µåŠ¨æ€è°ƒæ•´ï¼š</p>
<ul>
<li>ç›‘æ§æ¶ˆæ¯ä¸¢å¤±ç‡</li>
<li>ä¸¢å¤±ç‡ &lt; 1%ï¼šä½¿ç”¨ BEST_EFFORT</li>
<li>ä¸¢å¤±ç‡ &gt; 5%ï¼šä½¿ç”¨ RELIABLE</li>
<li>å®ç°å¹³æ»‘åˆ‡æ¢é¿å…éœ‡è¡</li>
</ul>
<p>ğŸ’¡ <strong>æç¤º</strong>ï¼šä½¿ç”¨æ»‘åŠ¨çª—å£ç»Ÿè®¡ï¼ŒæŒ‡æ•°ç§»åŠ¨å¹³å‡</p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AdaptiveQoSController</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Stats</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">sent</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">received</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">loss_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">deque</span><span class="o">&lt;</span><span class="n">Stats</span><span class="o">&gt;</span><span class="w"> </span><span class="n">window_</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">window_size_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">alpha_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span><span class="w">  </span><span class="c1">// EMA factor</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">smoothed_loss_rate_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">QoS</span><span class="w"> </span><span class="n">current_qos_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">update_stats</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="n">message_received</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">Stats</span><span class="w"> </span><span class="n">current</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">window_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">window_</span><span class="p">.</span><span class="n">back</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">current</span><span class="p">.</span><span class="n">sent</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">message_received</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">current</span><span class="p">.</span><span class="n">received</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// è®¡ç®—ç¬æ—¶ä¸¢å¤±ç‡</span>
<span class="w">        </span><span class="n">current</span><span class="p">.</span><span class="n">loss_rate</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>
<span class="w">            </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">current</span><span class="p">.</span><span class="n">received</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">current</span><span class="p">.</span><span class="n">sent</span><span class="p">;</span>

<span class="w">        </span><span class="n">window_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">window_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">window_size_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">window_</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// æŒ‡æ•°ç§»åŠ¨å¹³å‡</span>
<span class="w">        </span><span class="n">smoothed_loss_rate_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alpha_</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">current</span><span class="p">.</span><span class="n">loss_rate</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>
<span class="w">                             </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">alpha_</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">smoothed_loss_rate_</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">QoS</span><span class="w"> </span><span class="n">get_adapted_qos</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ·»åŠ æ»åé¿å…éœ‡è¡</span>
<span class="w">        </span><span class="k">static</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">hysteresis</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.01</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">smoothed_loss_rate_</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.01</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">hysteresis</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">current_qos_</span><span class="p">.</span><span class="n">best_effort</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">smoothed_loss_rate_</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.05</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hysteresis</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">current_qos_</span><span class="p">.</span><span class="n">reliable</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="c1">// å¦åˆ™ä¿æŒå½“å‰ QoS</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">current_qos_</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

</details>
<p><strong>ç»ƒä¹  6.6</strong>ï¼šå®ç°åˆ†å¸ƒå¼é”æœåŠ¡</p>
<p>ä½¿ç”¨ ROS2 æœåŠ¡å’Œå‚æ•°å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼é”ï¼š</p>
<ul>
<li>acquire_lock(node_id, timeout)</li>
<li>release_lock(node_id)</li>
<li>æ”¯æŒè¶…æ—¶è‡ªåŠ¨é‡Šæ”¾</li>
<li>å¤„ç†èŠ‚ç‚¹å´©æºƒæƒ…å†µ</li>
</ul>
<p>ğŸ’¡ <strong>æç¤º</strong>ï¼šä½¿ç”¨å¿ƒè·³æœºåˆ¶ï¼Œå‚æ•°å­˜å‚¨é”çŠ¶æ€</p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DistributedLock</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">LockInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">owner</span><span class="p">;</span>
<span class="w">        </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span><span class="w"> </span><span class="n">acquired_time</span><span class="p">;</span>
<span class="w">        </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Duration</span><span class="w"> </span><span class="n">timeout</span><span class="p">;</span>
<span class="w">        </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span><span class="w"> </span><span class="n">last_heartbeat</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">LockInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">locks_</span><span class="p">;</span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">TimerBase</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">cleanup_timer_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">acquire_lock</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">lock_name</span><span class="p">,</span>
<span class="w">                     </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">node_id</span><span class="p">,</span>
<span class="w">                     </span><span class="kt">double</span><span class="w"> </span><span class="n">timeout_sec</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node_</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// æ¸…ç†è¿‡æœŸé”</span>
<span class="w">        </span><span class="n">cleanup_expired_locks</span><span class="p">();</span>

<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locks_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">lock_name</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">locks_</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">owner</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">node_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// é”è¢«å…¶ä»–èŠ‚ç‚¹æŒæœ‰</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// è·å–æˆ–æ›´æ–°é”</span>
<span class="w">        </span><span class="n">LockInfo</span><span class="o">&amp;</span><span class="w"> </span><span class="n">info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locks_</span><span class="p">[</span><span class="n">lock_name</span><span class="p">];</span>
<span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node_id</span><span class="p">;</span>
<span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="n">acquired_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span>
<span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="n">timeout</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Duration</span><span class="o">::</span><span class="n">from_seconds</span><span class="p">(</span><span class="n">timeout_sec</span><span class="p">);</span>
<span class="w">        </span><span class="n">info</span><span class="p">.</span><span class="n">last_heartbeat</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// æ›´æ–°å‚æ•°æœåŠ¡å™¨</span>
<span class="w">        </span><span class="n">node_</span><span class="o">-&gt;</span><span class="n">set_parameter</span><span class="p">(</span>
<span class="w">            </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Parameter</span><span class="p">(</span><span class="s">&quot;lock.&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lock_name</span><span class="p">,</span><span class="w"> </span><span class="n">node_id</span><span class="p">));</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">release_lock</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">lock_name</span><span class="p">,</span>
<span class="w">                     </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">node_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locks_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">lock_name</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">locks_</span><span class="p">.</span><span class="n">end</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">owner</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">node_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">locks_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
<span class="w">        </span><span class="n">node_</span><span class="o">-&gt;</span><span class="n">set_parameter</span><span class="p">(</span>
<span class="w">            </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Parameter</span><span class="p">(</span><span class="s">&quot;lock.&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">lock_name</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">));</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">cleanup_expired_locks</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node_</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">();</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locks_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">it</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">locks_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">elapsed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">last_heartbeat</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">elapsed</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">.</span><span class="n">timeout</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">node_</span><span class="o">-&gt;</span><span class="n">set_parameter</span><span class="p">(</span>
<span class="w">                    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Parameter</span><span class="p">(</span><span class="s">&quot;lock.&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">it</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">));</span>
<span class="w">                </span><span class="n">it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">locks_</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">it</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">++</span><span class="n">it</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

</details>
<p><strong>ç»ƒä¹  6.7</strong>ï¼šæ¶ˆæ¯ä¼˜å…ˆçº§é˜Ÿåˆ—</p>
<p>å®ç°ä¸€ä¸ªæ”¯æŒä¼˜å…ˆçº§çš„è¯é¢˜å‘å¸ƒå™¨ï¼š</p>
<ul>
<li>é«˜ä¼˜å…ˆçº§æ¶ˆæ¯æ’é˜Ÿ</li>
<li>ä½ä¼˜å…ˆçº§æ¶ˆæ¯å¯ä¸¢å¼ƒ</li>
<li>ä¿è¯é¡ºåºæ€§ï¼ˆåŒä¼˜å…ˆçº§ï¼‰</li>
</ul>
<p>ğŸ’¡ <strong>æç¤º</strong>ï¼šè‡ªå®šä¹‰æ¶ˆæ¯å¤´ï¼Œä½¿ç”¨ä¼˜å…ˆé˜Ÿåˆ—</p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">MessageT</span><span class="o">&gt;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PriorityPublisher</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">PriorityMessage</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">MessageT</span><span class="w"> </span><span class="n">msg</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">priority</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">sequence</span><span class="p">;</span>

<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="k">operator</span><span class="o">&lt;</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">PriorityMessage</span><span class="o">&amp;</span><span class="w"> </span><span class="n">other</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">priority</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">priority</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="n">priority</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">priority</span><span class="p">;</span><span class="w">  </span><span class="c1">// é«˜ä¼˜å…ˆçº§åœ¨å‰</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">sequence</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">other</span><span class="p">.</span><span class="n">sequence</span><span class="p">;</span><span class="w">  </span><span class="c1">// åŒä¼˜å…ˆçº§ä¿åº</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">priority_queue</span><span class="o">&lt;</span><span class="n">PriorityMessage</span><span class="o">&gt;</span><span class="w"> </span><span class="n">queue_</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">max_queue_size_</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">sequence_counter_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">MessageT</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">publisher_</span><span class="p">;</span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">TimerBase</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">publish_timer_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">publish_with_priority</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">MessageT</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">priority</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">queue_</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">max_queue_size_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// ä¸¢å¼ƒæœ€ä½ä¼˜å…ˆçº§æ¶ˆæ¯</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PriorityMessage</span><span class="o">&gt;</span><span class="w"> </span><span class="n">temp</span><span class="p">;</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">queue_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">temp</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">queue_</span><span class="p">.</span><span class="n">top</span><span class="p">());</span>
<span class="w">                </span><span class="n">queue_</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// ç§»é™¤æœ€ä½ä¼˜å…ˆçº§</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">min_it</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">min_element</span><span class="p">(</span>
<span class="w">                </span><span class="n">temp</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">temp</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span>
<span class="w">                </span><span class="p">[](</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">a</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">priority</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">b</span><span class="p">.</span><span class="n">priority</span><span class="p">;</span>
<span class="w">                </span><span class="p">});</span>
<span class="w">            </span><span class="n">temp</span><span class="p">.</span><span class="n">erase</span><span class="p">(</span><span class="n">min_it</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// é‡å»ºé˜Ÿåˆ—</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">pm</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">temp</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">queue_</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">pm</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">queue_</span><span class="p">.</span><span class="n">push</span><span class="p">({</span><span class="n">msg</span><span class="p">,</span><span class="w"> </span><span class="n">priority</span><span class="p">,</span><span class="w"> </span><span class="n">sequence_counter_</span><span class="o">++</span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">process_queue</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">queue_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">pm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queue_</span><span class="p">.</span><span class="n">top</span><span class="p">();</span>
<span class="w">            </span><span class="n">queue_</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
<span class="w">            </span><span class="n">publisher_</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">pm</span><span class="p">.</span><span class="n">msg</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

</details>
<p><strong>ç»ƒä¹  6.8</strong>ï¼šå®ç° Action å–æ¶ˆä¸æŠ¢å </p>
<p>è®¾è®¡ä¸€ä¸ª Action æœåŠ¡å™¨ï¼Œæ”¯æŒï¼š</p>
<ul>
<li>ç›®æ ‡å–æ¶ˆï¼ˆå®¢æˆ·ç«¯ä¸»åŠ¨ï¼‰</li>
<li>ç›®æ ‡æŠ¢å ï¼ˆæ–°ç›®æ ‡æ›¿æ¢æ—§ç›®æ ‡ï¼‰</li>
<li>ä¼˜é›…åœæ­¢ï¼ˆä¿å­˜è¿›åº¦ï¼‰</li>
</ul>
<p>ğŸ’¡ <strong>æç¤º</strong>ï¼šä½¿ç”¨çŠ¶æ€æœºç®¡ç†ç›®æ ‡ç”Ÿå‘½å‘¨æœŸ</p>
<details>
<summary>å‚è€ƒç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">ActionT</span><span class="o">&gt;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PreemptableActionServer</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">GoalState</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">IDLE</span><span class="p">,</span>
<span class="w">        </span><span class="n">EXECUTING</span><span class="p">,</span>
<span class="w">        </span><span class="n">PREEMPTING</span><span class="p">,</span>
<span class="w">        </span><span class="n">CANCELING</span><span class="p">,</span>
<span class="w">        </span><span class="n">SUCCEEDED</span><span class="p">,</span>
<span class="w">        </span><span class="n">ABORTED</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Goal</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">typename</span><span class="w"> </span><span class="nc">ActionT</span><span class="o">::</span><span class="n">Goal</span><span class="w"> </span><span class="n">goal</span><span class="p">;</span>
<span class="w">        </span><span class="n">GoalState</span><span class="w"> </span><span class="n">state</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">progress</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">checkpoint</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Goal</span><span class="o">&gt;</span><span class="w"> </span><span class="n">current_goal_</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="w"> </span><span class="n">goal_mutex_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">handle_goal</span><span class="p">(</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">ActionT</span><span class="o">::</span><span class="n">Goal</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">goal</span><span class="p">,</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">ActionT</span><span class="o">::</span><span class="n">GoalHandle</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">goal_handle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">goal_mutex_</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_goal_</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">            </span><span class="n">current_goal_</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GoalState</span><span class="o">::</span><span class="n">EXECUTING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// æŠ¢å å½“å‰ç›®æ ‡</span>
<span class="w">            </span><span class="n">current_goal_</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GoalState</span><span class="o">::</span><span class="n">PREEMPTING</span><span class="p">;</span>
<span class="w">            </span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">current_goal_</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// æ¥å—æ–°ç›®æ ‡</span>
<span class="w">        </span><span class="n">current_goal_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">Goal</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="n">current_goal_</span><span class="o">-&gt;</span><span class="n">goal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">goal</span><span class="p">;</span>
<span class="w">        </span><span class="n">current_goal_</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GoalState</span><span class="o">::</span><span class="n">EXECUTING</span><span class="p">;</span>
<span class="w">        </span><span class="n">current_goal_</span><span class="o">-&gt;</span><span class="n">progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// å¼‚æ­¥æ‰§è¡Œ</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">goal_handle</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">execute_goal</span><span class="p">(</span><span class="n">goal_handle</span><span class="p">);</span>
<span class="w">        </span><span class="p">}).</span><span class="n">detach</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">handle_cancel</span><span class="p">(</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">ActionT</span><span class="o">::</span><span class="n">GoalHandle</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">goal_handle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">goal_mutex_</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_goal_</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">            </span><span class="n">current_goal_</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GoalState</span><span class="o">::</span><span class="n">EXECUTING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">current_goal_</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GoalState</span><span class="o">::</span><span class="n">CANCELING</span><span class="p">;</span>
<span class="w">            </span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">current_goal_</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">execute_goal</span><span class="p">(</span>
<span class="w">        </span><span class="k">const</span><span class="w"> </span><span class="k">typename</span><span class="w"> </span><span class="nc">ActionT</span><span class="o">::</span><span class="n">GoalHandle</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">goal_handle</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">current_goal_</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GoalState</span><span class="o">::</span><span class="n">EXECUTING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// æ£€æŸ¥æŠ¢å </span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_goal_</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GoalState</span><span class="o">::</span><span class="n">PREEMPTING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">goal_handle</span><span class="o">-&gt;</span><span class="n">abort</span><span class="p">();</span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// æ£€æŸ¥å–æ¶ˆ</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_goal_</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">GoalState</span><span class="o">::</span><span class="n">CANCELING</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">goal_handle</span><span class="o">-&gt;</span><span class="n">canceled</span><span class="p">();</span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// æ‰§è¡Œä¸€æ­¥</span>
<span class="w">            </span><span class="n">step_execution</span><span class="p">();</span>

<span class="w">            </span><span class="c1">// å‘é€åé¦ˆ</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">feedback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">ActionT</span><span class="o">::</span><span class="n">Feedback</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">            </span><span class="n">feedback</span><span class="o">-&gt;</span><span class="n">progress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_goal_</span><span class="o">-&gt;</span><span class="n">progress</span><span class="p">;</span>
<span class="w">            </span><span class="n">goal_handle</span><span class="o">-&gt;</span><span class="n">publish_feedback</span><span class="p">(</span><span class="n">feedback</span><span class="p">);</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_goal_</span><span class="o">-&gt;</span><span class="n">progress</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">current_goal_</span><span class="o">-&gt;</span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GoalState</span><span class="o">::</span><span class="n">SUCCEEDED</span><span class="p">;</span>
<span class="w">                </span><span class="n">goal_handle</span><span class="o">-&gt;</span><span class="n">succeed</span><span class="p">();</span>
<span class="w">                </span><span class="k">return</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">save_checkpoint</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">Goal</span><span class="o">&gt;</span><span class="w"> </span><span class="n">goal</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ä¿å­˜å½“å‰è¿›åº¦åˆ°æ–‡ä»¶æˆ–æ•°æ®åº“</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">stringstream</span><span class="w"> </span><span class="n">ss</span><span class="p">;</span>
<span class="w">        </span><span class="n">ss</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;progress:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">goal</span><span class="o">-&gt;</span><span class="n">progress</span><span class="w"> </span>
<span class="w">           </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;,state:&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">goal</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
<span class="w">        </span><span class="n">goal</span><span class="o">-&gt;</span><span class="n">checkpoint</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ss</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

</details>
<h2 id="612_1">6.12 æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_13">é€šä¿¡è®¾è®¡å®¡æŸ¥</h3>
<h4 id="_14">æ¶æ„å±‚é¢</h4>
<ul>
<li>[ ] é€‰æ‹©äº†åˆé€‚çš„é€šä¿¡æ¨¡å¼ï¼ˆè¯é¢˜/æœåŠ¡/åŠ¨ä½œï¼‰</li>
<li>[ ] å®šä¹‰äº†æ¸…æ™°çš„æ¶ˆæ¯æ¥å£å’Œç‰ˆæœ¬ç­–ç•¥</li>
<li>[ ] è€ƒè™‘äº†ç³»ç»Ÿæ‰©å±•æ€§å’Œå‘åå…¼å®¹</li>
<li>[ ] è®¾è®¡äº†åˆç†çš„å‘½åç©ºé—´å’Œè¯é¢˜å±‚æ¬¡</li>
<li>[ ] è¯„ä¼°äº†é€šä¿¡é¢‘ç‡å’Œå¸¦å®½éœ€æ±‚</li>
</ul>
<h4 id="qos_1">QoS é…ç½®</h4>
<ul>
<li>[ ] ä¸ºæ¯ä¸ªè¯é¢˜é€‰æ‹©äº†åˆé€‚çš„ QoS é…ç½®</li>
<li>[ ] è®°å½•äº† QoS é€‰æ‹©ç†ç”±å’Œçº¦æŸ</li>
<li>[ ] æµ‹è¯•äº† QoS ä¸åŒ¹é…çš„å¤„ç†</li>
<li>[ ] é…ç½®äº†åˆç†çš„é˜Ÿåˆ—æ·±åº¦</li>
<li>[ ] è€ƒè™‘äº†ç½‘ç»œæ¡ä»¶å˜åŒ–çš„é€‚åº”æ€§</li>
</ul>
<h4 id="_15">æ€§èƒ½ä¼˜åŒ–</h4>
<ul>
<li>[ ] è¯†åˆ«äº†æ€§èƒ½å…³é”®è·¯å¾„</li>
<li>[ ] è¯„ä¼°äº†é›¶æ‹·è´çš„é€‚ç”¨æ€§</li>
<li>[ ] ä¼˜åŒ–äº†æ¶ˆæ¯å¤§å°å’Œç»“æ„</li>
<li>[ ] é…ç½®äº†åˆé€‚çš„ DDS å‚æ•°</li>
<li>[ ] å®æ–½äº†æµé‡æ§åˆ¶æœºåˆ¶</li>
</ul>
<h4 id="_16">é”™è¯¯å¤„ç†</h4>
<ul>
<li>[ ] å¤„ç†äº†é€šä¿¡è¶…æ—¶æƒ…å†µ</li>
<li>[ ] å®ç°äº†é‡è¿æœºåˆ¶</li>
<li>[ ] æ·»åŠ äº†æ¶ˆæ¯éªŒè¯</li>
<li>[ ] è®°å½•äº†é€šä¿¡é”™è¯¯æ—¥å¿—</li>
<li>[ ] è®¾è®¡äº†é™çº§ç­–ç•¥</li>
</ul>
<h4 id="_17">å®‰å…¨æ€§</h4>
<ul>
<li>[ ] è¯„ä¼°äº†å®‰å…¨éœ€æ±‚ç­‰çº§</li>
<li>[ ] é…ç½®äº†è®¿é—®æ§åˆ¶</li>
<li>[ ] å®æ–½äº†æ•°æ®åŠ å¯†ï¼ˆå¦‚éœ€è¦ï¼‰</li>
<li>[ ] é˜²èŒƒäº† DoS æ”»å‡»</li>
<li>[ ] å®¡è®¡äº†æ•æ„Ÿæ•°æ®ä¼ è¾“</li>
</ul>
<h4 id="_18">ç›‘æ§ä¸è°ƒè¯•</h4>
<ul>
<li>[ ] æ·»åŠ äº†æ€§èƒ½æŒ‡æ ‡æ”¶é›†</li>
<li>[ ] é…ç½®äº†æ—¥å¿—çº§åˆ«</li>
<li>[ ] å®ç°äº†å¥åº·æ£€æŸ¥</li>
<li>[ ] å‡†å¤‡äº†è°ƒè¯•å·¥å…·</li>
<li>[ ] å»ºç«‹äº†å‘Šè­¦æœºåˆ¶</li>
</ul>
<h3 id="_19">ä»£ç å®¡æŸ¥è¦ç‚¹</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// âœ“ è‰¯å¥½å®è·µç¤ºä¾‹</span>
<span class="k">class</span><span class="w"> </span><span class="nc">RobustPublisher</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">RobustPublisher</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">node</span><span class="p">)</span><span class="w"> </span>
<span class="w">        </span><span class="o">:</span><span class="w"> </span><span class="n">node_</span><span class="p">(</span><span class="n">node</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 1. æ˜ç¡®çš„ QoS é…ç½®</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">qos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">QoS</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">reliability</span><span class="p">(</span><span class="n">RMW_QOS_POLICY_RELIABILITY_RELIABLE</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">durability</span><span class="p">(</span><span class="n">RMW_QOS_POLICY_DURABILITY_TRANSIENT_LOCAL</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 2. é”™è¯¯å¤„ç†</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">publisher_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node_</span><span class="o">-&gt;</span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">MessageT</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;topic_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">qos</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="n">node_</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span>
<span class="w">                        </span><span class="s">&quot;Failed to create publisher: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
<span class="w">            </span><span class="k">throw</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 3. ç›‘æ§</span>
<span class="w">        </span><span class="n">pub_timer_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node_</span><span class="o">-&gt;</span><span class="n">create_wall_timer</span><span class="p">(</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="w">            </span><span class="p">[</span><span class="k">this</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">report_stats</span><span class="p">();</span><span class="w"> </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">publish</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">MessageT</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 4. éªŒè¯</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">validate_message</span><span class="p">(</span><span class="n">msg</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">stats_</span><span class="p">.</span><span class="n">invalid_messages</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 5. å‘å¸ƒ</span>
<span class="w">        </span><span class="k">try</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">publisher_</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="w">            </span><span class="n">stats_</span><span class="p">.</span><span class="n">published_messages</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">exception</span><span class="o">&amp;</span><span class="w"> </span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">stats_</span><span class="p">.</span><span class="n">publish_failures</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="n">RCLCPP_WARN_THROTTLE</span><span class="p">(</span><span class="n">node_</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span>
<span class="w">                </span><span class="o">*</span><span class="n">node_</span><span class="o">-&gt;</span><span class="n">get_clock</span><span class="p">(),</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;Publish failed: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">.</span><span class="n">what</span><span class="p">());</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Stats</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">published_messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">publish_failures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">invalid_messages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">stats_</span><span class="p">;</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">report_stats</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">node_</span><span class="o">-&gt;</span><span class="n">get_logger</span><span class="p">(),</span>
<span class="w">            </span><span class="s">&quot;Stats - Published: %zu, Failed: %zu, Invalid: %zu&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">stats_</span><span class="p">.</span><span class="n">published_messages</span><span class="p">,</span>
<span class="w">            </span><span class="n">stats_</span><span class="p">.</span><span class="n">publish_failures</span><span class="p">,</span>
<span class="w">            </span><span class="n">stats_</span><span class="p">.</span><span class="n">invalid_messages</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="_20">éƒ¨ç½²æ£€æŸ¥</h3>
<ul>
<li>[ ] éªŒè¯äº†ç½‘ç»œé…ç½®ï¼ˆå¤šæ’­ã€é˜²ç«å¢™ï¼‰</li>
<li>[ ] æµ‹è¯•äº†ç›®æ ‡ç¡¬ä»¶æ€§èƒ½</li>
<li>[ ] é…ç½®äº†èµ„æºé™åˆ¶</li>
<li>[ ] å‡†å¤‡äº†éƒ¨ç½²æ–‡æ¡£</li>
<li>[ ] å»ºç«‹äº†å›æ»šæ–¹æ¡ˆ</li>
</ul>
<hr />
<p>é€šè¿‡æœ¬ç« çš„å­¦ä¹ ï¼Œæ‚¨åº”è¯¥å·²ç»æŒæ¡äº† ROS2 é€šä¿¡æœºåˆ¶çš„æ ¸å¿ƒåŸç†å’Œä¼˜åŒ–æŠ€æœ¯ã€‚è¿™äº›çŸ¥è¯†å°†å¸®åŠ©æ‚¨æ„å»ºé«˜æ€§èƒ½ã€å¯é çš„æœºå™¨äººç³»ç»Ÿã€‚ä¸‹ä¸€ç« æˆ‘ä»¬å°†æ¢è®¨ Launch ç³»ç»Ÿä¸é…ç½®ç®¡ç†ã€‚</p>
            </article>
            
            <nav class="page-nav"><a href="chapter5.html" class="nav-link prev">â† ç¬¬ 5 ç« ï¼šèŠ‚ç‚¹ä¸æ‰§è¡Œå™¨æ¨¡å‹</a><a href="chapter7.html" class="nav-link next">ç¬¬ 7 ç« ï¼šLaunch ç³»ç»Ÿä¸é…ç½®ç®¡ç† â†’</a></nav>
        </main>
    </div>
</body>
</html>