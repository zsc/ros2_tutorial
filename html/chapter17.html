<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬ 17 ç« ï¼šä»¿çœŸé›†æˆï¼ˆGazebo/Ignitionï¼‰</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ROS2 å®Œå…¨æ•™ç¨‹ï¼šä»åŸç†åˆ°å®è·µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 1 ç« ï¼šROS1 æ ¸å¿ƒæ¦‚å¿µå›é¡¾</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 2 ç« ï¼šROS1 çš„å±€é™æ€§åˆ†æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 3 ç« ï¼šä» ROS1 åˆ° ROS2 çš„è¿ç§»ç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 4 ç« ï¼šROS2 æ¶æ„ä¸è®¾è®¡ç†å¿µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 5 ç« ï¼šèŠ‚ç‚¹ä¸æ‰§è¡Œå™¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 6 ç« ï¼šé€šä¿¡æœºåˆ¶æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 7 ç« ï¼šLaunch ç³»ç»Ÿä¸é…ç½®ç®¡ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 8 ç« ï¼štf2 åæ ‡å˜æ¢æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 9 ç« ï¼šæ—¶é—´åŒæ­¥ä¸å›æ”¾ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 10 ç« ï¼šä¼ æ„Ÿå™¨æ•°æ®å¤„ç†ç®¡é“</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 11 ç« ï¼šSLAM ä¸å®šä½ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 12 ç« ï¼šå¯¼èˆªæ ˆ Nav2</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 13 ç« ï¼šros2_control æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 14 ç« ï¼šMoveIt2 è¿åŠ¨è§„åˆ’</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 15 ç« ï¼šå®æ—¶ç³»ç»Ÿä¸æ€§èƒ½ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 16 ç« ï¼šå®‰å…¨æ€§ä¸è¯Šæ–­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 17 ç« ï¼šä»¿çœŸé›†æˆï¼ˆGazebo/Ignitionï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 18 ç« ï¼šå¤šæœºå™¨äººç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 19 ç« ï¼šè®¡ç®—æœºè§†è§‰ä¸æ·±åº¦å­¦ä¹ </span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 20 ç« ï¼šæœºå™¨äººå¼ºåŒ–å­¦ä¹ </span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 21 ç« ï¼šå¤§è¯­è¨€æ¨¡å‹ä¸å…·èº«æ™ºèƒ½</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 22 ç« ï¼šç¥ç»ç½‘ç»œè¿åŠ¨æ§åˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="17-gazeboignition">ç¬¬ 17 ç« ï¼šä»¿çœŸé›†æˆï¼ˆGazebo/Ignitionï¼‰</h1>
<p>ä»¿çœŸæ˜¯æœºå™¨äººå¼€å‘ä¸­ä¸å¯æˆ–ç¼ºçš„ç¯èŠ‚ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨å®‰å…¨ã€å¯æ§ã€å¯é‡å¤çš„ç¯å¢ƒä¸­æµ‹è¯•ç®—æ³•ã€éªŒè¯ç³»ç»Ÿè®¾è®¡ã€ç”Ÿæˆè®­ç»ƒæ•°æ®ã€‚æœ¬ç« æ·±å…¥æ¢è®¨ ROS2 ä¸ Gazebo/Ignition çš„é›†æˆï¼Œæ¶µç›–ä»åŸºç¡€ç¯å¢ƒæ­å»ºåˆ°é«˜çº§ç¡¬ä»¶åœ¨ç¯ä»¿çœŸçš„å®Œæ•´æŠ€æœ¯æ ˆã€‚æˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•æ„å»ºé«˜ä¿çœŸåº¦çš„ä»¿çœŸç¯å¢ƒã€å¼€å‘è‡ªå®šä¹‰æ’ä»¶ã€ä¼˜åŒ–ç‰©ç†å¼•æ“æ€§èƒ½ï¼Œä»¥åŠå¦‚ä½•åˆ©ç”¨ä»¿çœŸè¿›è¡Œå¤§è§„æ¨¡æ•°æ®ç”Ÿæˆå’Œç®—æ³•è®­ç»ƒã€‚</p>
<h2 id="171">17.1 ä»¿çœŸç¯å¢ƒæ­å»º</h2>
<h3 id="1711-gazebo-classic-vs-ignition-gazebo">17.1.1 Gazebo Classic vs Ignition Gazebo</h3>
<p>ROS2 ç”Ÿæ€ç³»ç»Ÿä¸­å­˜åœ¨ä¸¤ä¸ªä¸»è¦çš„ä»¿çœŸå¹³å°ï¼šGazebo Classicï¼ˆç‰ˆæœ¬11åŠä»¥å‰ï¼‰å’Œ Ignition Gazeboï¼ˆç°ç§°ä¸º Gazeboï¼Œä» Fortress ç‰ˆæœ¬å¼€å§‹ï¼‰ã€‚ç†è§£å®ƒä»¬çš„å·®å¼‚å¯¹äºæŠ€æœ¯é€‰å‹è‡³å…³é‡è¦ã€‚</p>
<p><strong>æ¶æ„æ¼”è¿›å¯¹æ¯”ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>Gazebo Classic æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Gazebo Server           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Physics  â”‚  Sensors   â”‚     â”‚
â”‚  â”‚  Engine   â”‚  Manager   â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚         Transport Layer          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†• (Gazebo Transport)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Gazebo Client           â”‚
â”‚      (GUI Visualization)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ignition Gazebo æ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚    Entity Component System      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”   â”‚
â”‚  â”‚Physicsâ”‚Renderâ”‚Sensorsâ”‚GUI â”‚   â”‚
â”‚  â”‚System â”‚Systemâ”‚System â”‚Sys â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”˜   â”‚
â”‚         ECM (Core)              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â†• (Ignition Transport)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Distributed Services       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>å…³é”®å·®å¼‚åˆ†æï¼š</strong></p>
<ol>
<li>
<p><strong>æ¶æ„æ¨¡å¼</strong>ï¼š
   - Gazebo Classic: å•ä½“æ¶æ„ï¼Œç´§è€¦åˆè®¾è®¡
   - Ignition Gazebo: ECSï¼ˆEntity-Component-Systemï¼‰æ¶æ„ï¼Œæ¾è€¦åˆã€é«˜åº¦æ¨¡å—åŒ–</p>
</li>
<li>
<p><strong>æ€§èƒ½ç‰¹æ€§</strong>ï¼š
   - å†…å­˜å ç”¨ï¼šIgnition å‡å°‘çº¦ 40% å†…å­˜ä½¿ç”¨
   - å¯åŠ¨æ—¶é—´ï¼šIgnition å¿« 3-5 å€
   - ä»¿çœŸç²¾åº¦ï¼šä¸¤è€…ç›¸å½“ï¼Œä½† Ignition æä¾›æ›´å¤šç‰©ç†å¼•æ“é€‰é¡¹</p>
</li>
<li>
<p><strong>å¼€å‘ä½“éªŒ</strong>ï¼š
   - API ç¨³å®šæ€§ï¼šIgnition æä¾›ç‰ˆæœ¬åŒ– APIï¼Œå‘åå…¼å®¹æ€§æ›´å¥½
   - æ’ä»¶ç³»ç»Ÿï¼šIgnition çš„æ’ä»¶æ¥å£æ›´æ¸…æ™°ï¼Œå¼€å‘æ•ˆç‡æå‡ 50%</p>
</li>
</ol>
<h3 id="1712-ros2-gazebo">17.1.2 ROS2 ä¸ Gazebo çš„æ¡¥æ¥æ¶æ„</h3>
<p>ROS2 ä¸ Gazebo çš„é›†æˆé€šè¿‡å¤šå±‚æ¡¥æ¥å®ç°ï¼Œç¡®ä¿ä»¿çœŸä¸çœŸå®ç³»ç»Ÿçš„æ¥å£ä¸€è‡´æ€§ã€‚</p>
<p><strong>æ¡¥æ¥ç»„ä»¶æ¶æ„ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          ROS2 Application          â”‚
â”‚     (Navigation, Control, etc.)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†• (ROS2 Topics/Services)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        ros_gz_bridge               â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚  Type Conversion Layer   â”‚     â”‚
â”‚   â”‚  - Timestamps alignment  â”‚     â”‚
â”‚   â”‚  - Frame ID mapping      â”‚     â”‚
â”‚   â”‚  - QoS adaptation        â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†• (Ignition Transport)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         Gazebo Simulation          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚   Sensor/Actuator Pluginsâ”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>å…³é”®æ¡¥æ¥é…ç½®ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># bridge_config.yaml</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ros_topic_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/robot/cmd_vel&quot;</span>
<span class="w">  </span><span class="nt">gz_topic_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/model/robot/cmd_vel&quot;</span>
<span class="w">  </span><span class="nt">ros_type_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;geometry_msgs/msg/Twist&quot;</span>
<span class="w">  </span><span class="nt">gz_type_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ignition.msgs.Twist&quot;</span>
<span class="w">  </span><span class="nt">direction</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ROS_TO_GZ</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ros_topic_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/robot/scan&quot;</span>
<span class="w">  </span><span class="nt">gz_topic_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/world/default/model/robot/link/laser/sensor/scan/scan&quot;</span>
<span class="w">  </span><span class="nt">ros_type_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;sensor_msgs/msg/LaserScan&quot;</span>
<span class="w">  </span><span class="nt">gz_type_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ignition.msgs.LaserScan&quot;</span>
<span class="w">  </span><span class="nt">direction</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GZ_TO_ROS</span>

<span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">ros_topic_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/camera/image_raw&quot;</span>
<span class="w">  </span><span class="nt">gz_topic_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/world/default/model/robot/link/camera/sensor/camera/image&quot;</span>
<span class="w">  </span><span class="nt">ros_type_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;sensor_msgs/msg/Image&quot;</span>
<span class="w">  </span><span class="nt">gz_type_name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;ignition.msgs.Image&quot;</span>
<span class="w">  </span><span class="nt">direction</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">GZ_TO_ROS</span>
<span class="w">  </span><span class="nt">lazy</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span><span class="w">  </span><span class="c1"># ä»…åœ¨æœ‰è®¢é˜…è€…æ—¶æ‰æ¡¥æ¥</span>
</code></pre></div>

<p><strong>æ€§èƒ½ä¼˜åŒ–ç­–ç•¥ï¼š</strong></p>
<ol>
<li><strong>æ‡’åŠ è½½æ¡¥æ¥</strong>ï¼šä»…åœ¨æœ‰å®é™…è®¢é˜…è€…æ—¶æ‰æ¿€æ´»æ¡¥æ¥ï¼Œå‡å°‘ä¸å¿…è¦çš„æ¶ˆæ¯è½¬æ¢å¼€é”€</li>
<li><strong>æ‰¹å¤„ç†æ¨¡å¼</strong>ï¼šå¯¹é«˜é¢‘æ•°æ®ï¼ˆå¦‚ç‚¹äº‘ï¼‰ä½¿ç”¨æ‰¹å¤„ç†ï¼Œå‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢</li>
<li><strong>é›¶æ‹·è´ä¼˜åŒ–</strong>ï¼šä½¿ç”¨å…±äº«å†…å­˜ä¼ è¾“å¤§æ•°æ®ï¼ˆéœ€è¦åŒæœºéƒ¨ç½²ï¼‰</li>
</ol>
<h3 id="1713">17.1.3 ä¸–ç•Œæ–‡ä»¶ä¸åœºæ™¯é…ç½®</h3>
<p>Gazebo ä¸–ç•Œæ–‡ä»¶å®šä¹‰äº†ä»¿çœŸç¯å¢ƒçš„æ‰€æœ‰é™æ€å’ŒåŠ¨æ€å…ƒç´ ã€‚é«˜æ•ˆçš„ä¸–ç•Œé…ç½®å¯¹ä»¿çœŸæ€§èƒ½è‡³å…³é‡è¦ã€‚</p>
<p><strong>ä¸–ç•Œæ–‡ä»¶ç»“æ„ä¼˜åŒ–ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cp">&lt;?xml version=&quot;1.0&quot;?&gt;</span>
<span class="nt">&lt;sdf</span><span class="w"> </span><span class="na">version=</span><span class="s">&quot;1.9&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;world</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;warehouse&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="cm">&lt;!-- ç‰©ç†å¼•æ“é…ç½® --&gt;</span>
<span class="w">    </span><span class="nt">&lt;physics</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;bullet&quot;</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;bullet&quot;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;max_step_size&gt;</span>0.001<span class="nt">&lt;/max_step_size&gt;</span>
<span class="w">      </span><span class="nt">&lt;real_time_factor&gt;</span>1.0<span class="nt">&lt;/real_time_factor&gt;</span>
<span class="w">      </span><span class="nt">&lt;real_time_update_rate&gt;</span>1000<span class="nt">&lt;/real_time_update_rate&gt;</span>

<span class="w">      </span><span class="cm">&lt;!-- Bullet ç‰¹å®šä¼˜åŒ– --&gt;</span>
<span class="w">      </span><span class="nt">&lt;bullet&gt;</span>
<span class="w">        </span><span class="nt">&lt;solver&gt;</span>
<span class="w">          </span><span class="nt">&lt;iterations&gt;</span>50<span class="nt">&lt;/iterations&gt;</span>
<span class="w">          </span><span class="nt">&lt;sor&gt;</span>1.3<span class="nt">&lt;/sor&gt;</span><span class="w">  </span><span class="cm">&lt;!-- Successive Over-Relaxation factor --&gt;</span>
<span class="w">        </span><span class="nt">&lt;/solver&gt;</span>
<span class="w">        </span><span class="nt">&lt;constraints&gt;</span>
<span class="w">          </span><span class="nt">&lt;cfm&gt;</span>0.0001<span class="nt">&lt;/cfm&gt;</span><span class="w">  </span><span class="cm">&lt;!-- Constraint Force Mixing --&gt;</span>
<span class="w">          </span><span class="nt">&lt;erp&gt;</span>0.2<span class="nt">&lt;/erp&gt;</span><span class="w">     </span><span class="cm">&lt;!-- Error Reduction Parameter --&gt;</span>
<span class="w">        </span><span class="nt">&lt;/constraints&gt;</span>
<span class="w">      </span><span class="nt">&lt;/bullet&gt;</span>
<span class="w">    </span><span class="nt">&lt;/physics&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- åœºæ™¯å…‰ç…§é…ç½® --&gt;</span>
<span class="w">    </span><span class="nt">&lt;scene&gt;</span>
<span class="w">      </span><span class="nt">&lt;ambient&gt;</span>0.4<span class="w"> </span>0.4<span class="w"> </span>0.4<span class="w"> </span>1<span class="nt">&lt;/ambient&gt;</span>
<span class="w">      </span><span class="nt">&lt;shadows&gt;</span>false<span class="nt">&lt;/shadows&gt;</span><span class="w">  </span><span class="cm">&lt;!-- å…³é—­é˜´å½±ä»¥æå‡æ€§èƒ½ --&gt;</span>
<span class="w">      </span><span class="nt">&lt;grid&gt;</span>false<span class="nt">&lt;/grid&gt;</span>
<span class="w">    </span><span class="nt">&lt;/scene&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- æ€§èƒ½ä¼˜åŒ–ï¼šä½¿ç”¨ LOD (Level of Detail) --&gt;</span>
<span class="w">    </span><span class="nt">&lt;model</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;warehouse_structure&quot;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;static&gt;</span>true<span class="nt">&lt;/static&gt;</span>
<span class="w">      </span><span class="nt">&lt;link</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;walls&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;visual</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;visual_lod0&quot;</span><span class="nt">&gt;</span>
<span class="w">          </span><span class="nt">&lt;geometry&gt;</span>
<span class="w">            </span><span class="nt">&lt;mesh&gt;</span>
<span class="w">              </span><span class="nt">&lt;uri&gt;</span>model://warehouse/meshes/walls_high.dae<span class="nt">&lt;/uri&gt;</span>
<span class="w">            </span><span class="nt">&lt;/mesh&gt;</span>
<span class="w">          </span><span class="nt">&lt;/geometry&gt;</span>
<span class="w">          </span><span class="nt">&lt;meta&gt;</span>
<span class="w">            </span><span class="nt">&lt;layer&gt;</span>0<span class="nt">&lt;/layer&gt;</span><span class="w">  </span><span class="cm">&lt;!-- é«˜ç»†èŠ‚å±‚ï¼Œè¿‘è·ç¦»æ˜¾ç¤º --&gt;</span>
<span class="w">          </span><span class="nt">&lt;/meta&gt;</span>
<span class="w">        </span><span class="nt">&lt;/visual&gt;</span>
<span class="w">        </span><span class="nt">&lt;visual</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;visual_lod1&quot;</span><span class="nt">&gt;</span>
<span class="w">          </span><span class="nt">&lt;geometry&gt;</span>
<span class="w">            </span><span class="nt">&lt;mesh&gt;</span>
<span class="w">              </span><span class="nt">&lt;uri&gt;</span>model://warehouse/meshes/walls_low.dae<span class="nt">&lt;/uri&gt;</span>
<span class="w">            </span><span class="nt">&lt;/mesh&gt;</span>
<span class="w">          </span><span class="nt">&lt;/geometry&gt;</span>
<span class="w">          </span><span class="nt">&lt;meta&gt;</span>
<span class="w">            </span><span class="nt">&lt;layer&gt;</span>1<span class="nt">&lt;/layer&gt;</span><span class="w">  </span><span class="cm">&lt;!-- ä½ç»†èŠ‚å±‚ï¼Œè¿œè·ç¦»æ˜¾ç¤º --&gt;</span>
<span class="w">          </span><span class="nt">&lt;/meta&gt;</span>
<span class="w">        </span><span class="nt">&lt;/visual&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- ç¢°æ’æ¨¡å‹ç®€åŒ– --&gt;</span>
<span class="w">        </span><span class="nt">&lt;collision</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;collision&quot;</span><span class="nt">&gt;</span>
<span class="w">          </span><span class="nt">&lt;geometry&gt;</span>
<span class="w">            </span><span class="nt">&lt;box&gt;</span>
<span class="w">              </span><span class="nt">&lt;size&gt;</span>20<span class="w"> </span>15<span class="w"> </span>3<span class="nt">&lt;/size&gt;</span><span class="w">  </span><span class="cm">&lt;!-- ä½¿ç”¨ç®€å•å‡ ä½•ä½“æ›¿ä»£å¤æ‚ç½‘æ ¼ --&gt;</span>
<span class="w">            </span><span class="nt">&lt;/box&gt;</span>
<span class="w">          </span><span class="nt">&lt;/geometry&gt;</span>
<span class="w">        </span><span class="nt">&lt;/collision&gt;</span>
<span class="w">      </span><span class="nt">&lt;/link&gt;</span>
<span class="w">    </span><span class="nt">&lt;/model&gt;</span>

<span class="w">    </span><span class="cm">&lt;!-- åŠ¨æ€å¯¹è±¡æ± ä¼˜åŒ– --&gt;</span>
<span class="w">    </span><span class="nt">&lt;plugin</span><span class="w"> </span><span class="na">filename=</span><span class="s">&quot;libignition-gazebo-physics-system.so&quot;</span><span class="w"> </span>
<span class="w">            </span><span class="na">name=</span><span class="s">&quot;ignition::gazebo::systems::Physics&quot;</span><span class="nt">&gt;</span>
<span class="w">      </span><span class="nt">&lt;engine&gt;</span>
<span class="w">        </span><span class="nt">&lt;filename&gt;</span>libignition-physics-bullet-plugin.so<span class="nt">&lt;/filename&gt;</span>
<span class="w">      </span><span class="nt">&lt;/engine&gt;</span>
<span class="w">    </span><span class="nt">&lt;/plugin&gt;</span>
<span class="w">  </span><span class="nt">&lt;/world&gt;</span>
<span class="nt">&lt;/sdf&gt;</span>
</code></pre></div>

<p><strong>åœºæ™¯ä¼˜åŒ–æŠ€å·§ï¼š</strong></p>
<ol>
<li>
<p><strong>å‡ ä½•ä½“ç®€åŒ–</strong>ï¼š
   - è§†è§‰æ¨¡å‹ï¼šä½¿ç”¨é«˜ç²¾åº¦ç½‘æ ¼
   - ç¢°æ’æ¨¡å‹ï¼šä½¿ç”¨ç®€å•å‡¸åŒ…æˆ–åŸºæœ¬å‡ ä½•ä½“
   - æ€§èƒ½æå‡ï¼šç¢°æ’æ£€æµ‹é€Ÿåº¦æå‡ 10-100 å€</p>
</li>
<li>
<p><strong>é™æ€å¯¹è±¡æ ‡è®°</strong>ï¼š
   - å°†ä¸ç§»åŠ¨çš„å¯¹è±¡æ ‡è®°ä¸º <code>&lt;static&gt;true&lt;/static&gt;</code>
   - ç‰©ç†å¼•æ“å¯è·³è¿‡è¿™äº›å¯¹è±¡çš„åŠ¨åŠ›å­¦è®¡ç®—
   - å…¸å‹åœºæ™¯æ€§èƒ½æå‡ 20-30%</p>
</li>
<li>
<p><strong>åˆ†å±‚æ¸²æŸ“ç­–ç•¥</strong>ï¼š
   - è¿‘æ™¯ï¼šé«˜å¤šè¾¹å½¢æ¨¡å‹ï¼Œè¯¦ç»†çº¹ç†
   - ä¸­æ™¯ï¼šä¸­ç­‰ç»†èŠ‚ï¼Œæ ‡å‡†çº¹ç†
   - è¿œæ™¯ï¼šä½å¤šè¾¹å½¢ï¼Œç®€åŒ–çº¹ç†
   - GPU è´Ÿè½½é™ä½ 40-60%</p>
</li>
</ol>
<h2 id="172">17.2 ä¼ æ„Ÿå™¨ä¸æ‰§è¡Œå™¨æ’ä»¶</h2>
<h3 id="1721">17.2.1 æ’ä»¶æ¶æ„ä¸ç”Ÿå‘½å‘¨æœŸ</h3>
<p>Gazebo æ’ä»¶ç³»ç»Ÿæ˜¯æ‰©å±•ä»¿çœŸåŠŸèƒ½çš„æ ¸å¿ƒæœºåˆ¶ã€‚ç†è§£æ’ä»¶ç”Ÿå‘½å‘¨æœŸå¯¹äºå¼€å‘é«˜æ€§èƒ½ã€ç¨³å®šçš„ä»¿çœŸç»„ä»¶è‡³å…³é‡è¦ã€‚</p>
<p><strong>æ’ä»¶ç±»å‹å±‚æ¬¡ç»“æ„ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// æ’ä»¶ç»§æ‰¿ä½“ç³»</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SystemPlugin</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// é…ç½®é˜¶æ®µ - ä»…è°ƒç”¨ä¸€æ¬¡</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">Configure</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Entity</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_entity</span><span class="p">,</span>
<span class="w">                          </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">sdf</span><span class="o">::</span><span class="n">Element</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_sdf</span><span class="p">,</span>
<span class="w">                          </span><span class="n">EntityComponentManager</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_ecm</span><span class="p">,</span>
<span class="w">                          </span><span class="n">EventManager</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_eventMgr</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ä»¥ä¸‹æ¥å£æŒ‰éœ€å®ç°</span>
<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">PreUpdate</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">UpdateInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_info</span><span class="p">,</span>
<span class="w">                          </span><span class="n">EntityComponentManager</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_ecm</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">  </span><span class="c1">// ç‰©ç†æ›´æ–°å‰</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">Update</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">UpdateInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_info</span><span class="p">,</span>
<span class="w">                       </span><span class="n">EntityComponentManager</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_ecm</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">     </span><span class="c1">// ç‰©ç†æ›´æ–°ä¸­</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">PostUpdate</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">UpdateInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_info</span><span class="p">,</span>
<span class="w">                           </span><span class="k">const</span><span class="w"> </span><span class="n">EntityComponentManager</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_ecm</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">  </span><span class="c1">// ç‰©ç†æ›´æ–°å</span>

<span class="w">    </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="nf">Reset</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">UpdateInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_info</span><span class="p">,</span>
<span class="w">                      </span><span class="n">EntityComponentManager</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_ecm</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">      </span><span class="c1">// é‡ç½®ä»¿çœŸ</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>ç”Ÿå‘½å‘¨æœŸæ—¶åºå›¾ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>æ’ä»¶åŠ è½½<span class="w"> </span>â†’<span class="w"> </span><span class="nv">Configure</span><span class="ss">()</span><span class="w"> </span>â†’<span class="w"> </span><span class="k">Loop</span><span class="w"> </span>{
<span class="w">    </span><span class="nv">PreUpdate</span><span class="ss">()</span><span class="w">  </span>[ç”¨æˆ·è¾“å…¥ã€ä¼ æ„Ÿå™¨é…ç½®]
<span class="w">        </span>â†“
<span class="w">    </span><span class="nv">Update</span><span class="ss">()</span><span class="w">     </span>[ç‰©ç†ä»¿çœŸæ­¥è¿›]
<span class="w">        </span>â†“
<span class="w">    </span><span class="nv">PostUpdate</span><span class="ss">()</span><span class="w"> </span>[ä¼ æ„Ÿå™¨æ•°æ®å‘å¸ƒã€æ¸²æŸ“]
}<span class="w"> </span>â†’<span class="w"> </span>æ’ä»¶å¸è½½
</code></pre></div>

<p><strong>é«˜æ€§èƒ½æ’ä»¶å¼€å‘æ¨¡å¼ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">OptimizedLidarPlugin</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">System</span><span class="p">,</span>
<span class="w">                             </span><span class="k">public</span><span class="w"> </span><span class="n">ISystemConfigure</span><span class="p">,</span>
<span class="w">                             </span><span class="k">public</span><span class="w"> </span><span class="n">ISystemPostUpdate</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// æ€§èƒ½ä¼˜åŒ–ï¼šé¢„åˆ†é…å†…å­˜</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rangeData</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">ignition</span><span class="o">::</span><span class="n">math</span><span class="o">::</span><span class="n">Vector3d</span><span class="o">&gt;</span><span class="w"> </span><span class="n">rayEndpoints</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// çº¿ç¨‹æ± ç”¨äºå¹¶è¡Œå…‰çº¿æŠ•å°„</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">ThreadPool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">raycastPool</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ç¼“å­˜é¢‘ç¹è®¿é—®çš„ç»„ä»¶</span>
<span class="w">    </span><span class="n">Entity</span><span class="w"> </span><span class="n">sensorEntity</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">sensors</span><span class="o">::</span><span class="n">Lidar</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lidarSensor</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Configure</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Entity</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_entity</span><span class="p">,</span>
<span class="w">                  </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="k">const</span><span class="w"> </span><span class="n">sdf</span><span class="o">::</span><span class="n">Element</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_sdf</span><span class="p">,</span>
<span class="w">                  </span><span class="n">EntityComponentManager</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_ecm</span><span class="p">,</span>
<span class="w">                  </span><span class="n">EventManager</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_eventMgr</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// é¢„åˆ†é…å†…å­˜é¿å…è¿è¡Œæ—¶åˆ†é…</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">numRays</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_sdf</span><span class="o">-&gt;</span><span class="n">Get</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;num_rays&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">360</span><span class="p">);</span>
<span class="w">        </span><span class="n">rangeData</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">numRays</span><span class="p">);</span>
<span class="w">        </span><span class="n">rayEndpoints</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">numRays</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// åˆå§‹åŒ–çº¿ç¨‹æ± </span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">numThreads</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="kr">thread</span><span class="o">::</span><span class="n">hardware_concurrency</span><span class="p">();</span>
<span class="w">        </span><span class="n">raycastPool</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">ThreadPool</span><span class="o">&gt;</span><span class="p">(</span><span class="n">numThreads</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ç¼“å­˜å®ä½“å¼•ç”¨</span>
<span class="w">        </span><span class="n">sensorEntity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_entity</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">PostUpdate</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">UpdateInfo</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_info</span><span class="p">,</span>
<span class="w">                   </span><span class="k">const</span><span class="w"> </span><span class="n">EntityComponentManager</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_ecm</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ€§èƒ½ä¼˜åŒ–ï¼šè·³è¿‡ä¸å¿…è¦çš„æ›´æ–°</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">_info</span><span class="p">.</span><span class="n">dt</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">duration</span><span class="o">::</span><span class="n">zero</span><span class="p">())</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// æ‰¹é‡å…‰çº¿æŠ•å°„withå¹¶è¡Œå¤„ç†</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">futures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">future</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">numRays</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">batchSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">futures</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span>
<span class="w">                </span><span class="n">raycastPool</span><span class="o">-&gt;</span><span class="n">enqueue</span><span class="p">([</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="n">performBatchRaycast</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">batchSize</span><span class="p">);</span>
<span class="w">                </span><span class="p">})</span>
<span class="w">            </span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// æ”¶é›†ç»“æœ</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">future</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">futures</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">future</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// å‘å¸ƒæ•°æ®ï¼ˆä½¿ç”¨é›¶æ‹·è´ifå¯èƒ½ï¼‰</span>
<span class="w">        </span><span class="n">publishLaserScan</span><span class="p">(</span><span class="n">rangeData</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1722">17.2.2 å¸¸ç”¨ä¼ æ„Ÿå™¨æ’ä»¶æ·±åº¦è§£æ</h3>
<ol>
<li><strong>ç›¸æœºä¼ æ„Ÿå™¨ä¼˜åŒ–ï¼š</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CameraPlugin</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">SensorPlugin</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// GPU æ¸²æŸ“ä¼˜åŒ–</span>
<span class="w">    </span><span class="n">rendering</span><span class="o">::</span><span class="n">CameraPtr</span><span class="w"> </span><span class="n">camera</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="p">[]</span><span class="o">&gt;</span><span class="w"> </span><span class="n">imageBuffer</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å›¾åƒå¤„ç†ç®¡é“</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ImagePipeline</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">enableDistortion</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">enableNoise</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="n">enableMotionBlur</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// ç•¸å˜å‚æ•°</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">k1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">k2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">p1</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">,</span><span class="w"> </span><span class="n">p2</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// å™ªå£°æ¨¡å‹</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">gaussianNoiseMean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">gaussianNoiseStdDev</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.01</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">pipeline</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">OnNewFrame</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">_image</span><span class="p">,</span>
<span class="w">                   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_width</span><span class="p">,</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">_height</span><span class="p">,</span>
<span class="w">                   </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="o">&amp;</span><span class="n">_format</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ€§èƒ½å…³é”®è·¯å¾„ï¼šé¿å…å†…å­˜æ‹·è´</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">imageBuffer</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">bufferSize</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">_width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_height</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">imageBuffer</span><span class="p">.</span><span class="n">reset</span><span class="p">(</span><span class="k">new</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="p">[</span><span class="n">_width</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_height</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// å¹¶è¡Œå›¾åƒå¤„ç†</span>
<span class="w">        </span><span class="cp">#pragma omp parallel for</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">_height</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">_width</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">int</span><span class="w"> </span><span class="n">idx</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">_width</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>

<span class="w">                </span><span class="c1">// åº”ç”¨ç•¸å˜æ¨¡å‹</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pipeline</span><span class="p">.</span><span class="n">enableDistortion</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">applyBarrelDistortion</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">y</span><span class="p">,</span><span class="w"> </span><span class="n">_width</span><span class="p">,</span><span class="w"> </span><span class="n">_height</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="c1">// æ·»åŠ ä¼ æ„Ÿå™¨å™ªå£°</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pipeline</span><span class="p">.</span><span class="n">enableNoise</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">addGaussianNoise</span><span class="p">(</span><span class="n">imageBuffer</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span><span class="w"> </span>
<span class="w">                                   </span><span class="n">imageBuffer</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span>
<span class="w">                                   </span><span class="n">imageBuffer</span><span class="p">[</span><span class="n">idx</span><span class="o">+</span><span class="mi">2</span><span class="p">]);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// å‘å¸ƒåˆ° ROS2</span>
<span class="w">        </span><span class="n">publishImage</span><span class="p">(</span><span class="n">imageBuffer</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="n">_width</span><span class="p">,</span><span class="w"> </span><span class="n">_height</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<ol start="2">
<li><strong>IMU ä¼ æ„Ÿå™¨çœŸå®æ€§å»ºæ¨¡ï¼š</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RealisticIMUPlugin</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ModelPlugin</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// Allan æ–¹å·®å‚æ•°</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">IMUNoiseModel</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// é™€èºä»ªå™ªå£°</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">gyroNoiseDensity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0003394</span><span class="p">;</span><span class="w">      </span><span class="c1">// rad/s/âˆšHz</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">gyroRandomWalk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.000038785</span><span class="p">;</span><span class="w">      </span><span class="c1">// rad/sÂ²/âˆšHz</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">gyroBiasStability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00001</span><span class="p">;</span><span class="w">       </span><span class="c1">// rad/s</span>

<span class="w">        </span><span class="c1">// åŠ é€Ÿåº¦è®¡å™ªå£°</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">accelNoiseDensity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.004</span><span class="p">;</span><span class="w">         </span><span class="c1">// m/sÂ²/âˆšHz</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">accelRandomWalk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.00006</span><span class="p">;</span><span class="w">         </span><span class="c1">// m/sÂ³/âˆšHz</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">accelBiasStability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0001</span><span class="p">;</span><span class="w">       </span><span class="c1">// m/sÂ²</span>

<span class="w">        </span><span class="c1">// æ¸©åº¦ç›¸å…³æ¼‚ç§»</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">tempCoeffGyro</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0001</span><span class="p">;</span><span class="w">            </span><span class="c1">// rad/s/Â°C</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">tempCoeffAccel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.001</span><span class="p">;</span><span class="w">            </span><span class="c1">// m/sÂ²/Â°C</span>

<span class="w">        </span><span class="c1">// å½“å‰åç½®çŠ¶æ€</span>
<span class="w">        </span><span class="n">ignition</span><span class="o">::</span><span class="n">math</span><span class="o">::</span><span class="n">Vector3d</span><span class="w"> </span><span class="n">gyroBias</span><span class="p">;</span>
<span class="w">        </span><span class="n">ignition</span><span class="o">::</span><span class="n">math</span><span class="o">::</span><span class="n">Vector3d</span><span class="w"> </span><span class="n">accelBias</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">noiseModel</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å¡å°”æ›¼æ»¤æ³¢å™¨çŠ¶æ€</span>
<span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="n">biasState</span><span class="p">;</span>
<span class="w">    </span><span class="n">Eigen</span><span class="o">::</span><span class="n">MatrixXd</span><span class="w"> </span><span class="n">biasCovariance</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">OnUpdate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">dt</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">lastUpdate</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// è·å–çœŸå€¼</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">angVel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">link</span><span class="o">-&gt;</span><span class="n">WorldAngularVel</span><span class="p">();</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">linAccel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">link</span><span class="o">-&gt;</span><span class="n">WorldLinearAccel</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// åç½®éšæœºæ¸¸èµ°æ›´æ–°</span>
<span class="w">        </span><span class="n">updateBiasRandomWalk</span><span class="p">(</span><span class="n">dt</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// åº”ç”¨å™ªå£°æ¨¡å‹</span>
<span class="w">        </span><span class="n">ignition</span><span class="o">::</span><span class="n">math</span><span class="o">::</span><span class="n">Vector3d</span><span class="w"> </span><span class="n">noisyAngVel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">angVel</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">noiseModel</span><span class="p">.</span><span class="n">gyroBias</span><span class="p">;</span>
<span class="w">        </span><span class="n">ignition</span><span class="o">::</span><span class="n">math</span><span class="o">::</span><span class="n">Vector3d</span><span class="w"> </span><span class="n">noisyLinAccel</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">linAccel</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">noiseModel</span><span class="p">.</span><span class="n">accelBias</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// æ·»åŠ ç™½å™ªå£°</span>
<span class="w">        </span><span class="n">noisyAngVel</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">generateWhiteNoise</span><span class="p">(</span><span class="n">noiseModel</span><span class="p">.</span><span class="n">gyroNoiseDensity</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="p">);</span>
<span class="w">        </span><span class="n">noisyLinAccel</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">generateWhiteNoise</span><span class="p">(</span><span class="n">noiseModel</span><span class="p">.</span><span class="n">accelNoiseDensity</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ¸©åº¦è¡¥å¿ï¼ˆæ¨¡æ‹Ÿï¼‰</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">temp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getSimulatedTemperature</span><span class="p">();</span>
<span class="w">        </span><span class="n">noisyAngVel</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">noiseModel</span><span class="p">.</span><span class="n">tempCoeffGyro</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">temp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">25.0</span><span class="p">);</span>
<span class="w">        </span><span class="n">noisyLinAccel</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">noiseModel</span><span class="p">.</span><span class="n">tempCoeffAccel</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">temp</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mf">25.0</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å‘å¸ƒ IMU æ¶ˆæ¯</span>
<span class="w">        </span><span class="n">publishIMU</span><span class="p">(</span><span class="n">noisyAngVel</span><span class="p">,</span><span class="w"> </span><span class="n">noisyLinAccel</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1723">17.2.3 è‡ªå®šä¹‰æ’ä»¶å¼€å‘æœ€ä½³å®è·µ</h3>
<p>å¼€å‘è‡ªå®šä¹‰æ’ä»¶æ—¶ï¼Œéœ€è¦è€ƒè™‘æ€§èƒ½ã€å¯ç»´æŠ¤æ€§å’Œå¯é‡ç”¨æ€§ã€‚ä»¥ä¸‹å±•ç¤ºä¸€ä¸ªå®Œæ•´çš„è‡ªå®šä¹‰æœºæ¢°è‡‚æ§åˆ¶æ’ä»¶ç¤ºä¾‹ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// é«˜æ€§èƒ½æœºæ¢°è‡‚æ§åˆ¶æ’ä»¶</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ArmControlPlugin</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">ModelPlugin</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// æ€§èƒ½ç›‘æ§</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">PerformanceMetrics</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">lastUpdate</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">avgUpdateTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">maxUpdateTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">updateCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">recordUpdate</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">duration</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">avgUpdateTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">avgUpdateTime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">updateCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">duration</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">updateCount</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">            </span><span class="n">maxUpdateTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">(</span><span class="n">maxUpdateTime</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">);</span>
<span class="w">            </span><span class="n">updateCount</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">metrics</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ§åˆ¶å™¨çŠ¶æ€</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ControllerState</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">targetPositions</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">currentPositions</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">velocities</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">efforts</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// PID æ§åˆ¶å™¨å‚æ•°</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">PIDController</span><span class="o">&gt;</span><span class="w"> </span><span class="n">jointControllers</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// è½¨è¿¹æ’å€¼å™¨</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">TrajectoryInterpolator</span><span class="o">&gt;</span><span class="w"> </span><span class="n">trajectoryInterp</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">controller</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">Load</span><span class="p">(</span><span class="n">physics</span><span class="o">::</span><span class="n">ModelPtr</span><span class="w"> </span><span class="n">_model</span><span class="p">,</span><span class="w"> </span><span class="n">sdf</span><span class="o">::</span><span class="n">ElementPtr</span><span class="w"> </span><span class="n">_sdf</span><span class="p">)</span><span class="w"> </span><span class="k">override</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ€§èƒ½ä¼˜åŒ–ï¼šç¼“å­˜å…³èŠ‚æŒ‡é’ˆ</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">joints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_model</span><span class="o">-&gt;</span><span class="n">GetJoints</span><span class="p">();</span>
<span class="w">        </span><span class="n">controller</span><span class="p">.</span><span class="n">targetPositions</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">joints</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<span class="w">        </span><span class="n">controller</span><span class="p">.</span><span class="n">currentPositions</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">joints</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>

<span class="w">        </span><span class="c1">// åˆå§‹åŒ– PID æ§åˆ¶å™¨</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">joints</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">kp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_sdf</span><span class="o">-&gt;</span><span class="n">Get</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;joint_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_kp&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">100.0</span><span class="p">);</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">ki</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_sdf</span><span class="o">-&gt;</span><span class="n">Get</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;joint_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_ki&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">0.1</span><span class="p">);</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">kd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_sdf</span><span class="o">-&gt;</span><span class="n">Get</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;joint_&quot;</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">to_string</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s">&quot;_kd&quot;</span><span class="p">,</span><span class="w"> </span><span class="mf">10.0</span><span class="p">);</span>

<span class="w">            </span><span class="n">controller</span><span class="p">.</span><span class="n">jointControllers</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">kp</span><span class="p">,</span><span class="w"> </span><span class="n">ki</span><span class="p">,</span><span class="w"> </span><span class="n">kd</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// è®¢é˜…å‘½ä»¤è¯é¢˜</span>
<span class="w">        </span><span class="n">ros</span><span class="o">::</span><span class="n">NodeHandle</span><span class="w"> </span><span class="n">nh</span><span class="p">;</span>
<span class="w">        </span><span class="n">cmdSub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nh</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="s">&quot;/arm/command&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ArmControlPlugin</span><span class="o">::</span><span class="n">OnCommand</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å‘å¸ƒçŠ¶æ€è¯é¢˜</span>
<span class="w">        </span><span class="n">statePub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nh</span><span class="p">.</span><span class="n">advertise</span><span class="o">&lt;</span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">JointState</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;/arm/state&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ³¨å†Œæ›´æ–°å›è°ƒ</span>
<span class="w">        </span><span class="n">updateConnection</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">event</span><span class="o">::</span><span class="n">Events</span><span class="o">::</span><span class="n">ConnectWorldUpdateBegin</span><span class="p">(</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ArmControlPlugin</span><span class="o">::</span><span class="n">OnUpdate</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">OnUpdate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// æ›´æ–°å½“å‰çŠ¶æ€</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">joints</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">controller</span><span class="p">.</span><span class="n">currentPositions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">Position</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">            </span><span class="n">controller</span><span class="p">.</span><span class="n">velocities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">joints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">GetVelocity</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// è½¨è¿¹æ’å€¼</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">controller</span><span class="p">.</span><span class="n">trajectoryInterp</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">controller</span><span class="p">.</span><span class="n">trajectoryInterp</span><span class="o">-&gt;</span><span class="n">isActive</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">controller</span><span class="p">.</span><span class="n">targetPositions</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">controller</span><span class="p">.</span><span class="n">trajectoryInterp</span><span class="o">-&gt;</span><span class="n">interpolate</span><span class="p">(</span>
<span class="w">                </span><span class="n">world</span><span class="o">-&gt;</span><span class="n">SimTime</span><span class="p">().</span><span class="n">Double</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// PID æ§åˆ¶</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">joints</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">controller</span><span class="p">.</span><span class="n">targetPositions</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">controller</span><span class="p">.</span><span class="n">currentPositions</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">effort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">controller</span><span class="p">.</span><span class="n">jointControllers</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">compute</span><span class="p">(</span><span class="n">error</span><span class="p">,</span><span class="w"> </span><span class="n">dt</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// åº”ç”¨åŠ›çŸ©é™åˆ¶</span>
<span class="w">            </span><span class="n">effort</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">clamp</span><span class="p">(</span><span class="n">effort</span><span class="p">,</span><span class="w"> </span><span class="o">-</span><span class="n">maxEffort</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">maxEffort</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">            </span><span class="n">joints</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">SetForce</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">effort</span><span class="p">);</span>
<span class="w">            </span><span class="n">controller</span><span class="p">.</span><span class="n">efforts</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">effort</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// å‘å¸ƒçŠ¶æ€</span>
<span class="w">        </span><span class="n">publishJointState</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// è®°å½•æ€§èƒ½æŒ‡æ ‡</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>
<span class="w">        </span><span class="n">metrics</span><span class="p">.</span><span class="n">recordUpdate</span><span class="p">(</span><span class="n">duration</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ€§èƒ½è­¦å‘Š</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">duration</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.001</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 1ms é˜ˆå€¼</span>
<span class="w">            </span><span class="n">ROS_WARN_THROTTLE</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Control update took %.3f ms&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="173">17.3 ç‰©ç†å¼•æ“é…ç½®</h2>
<h3 id="1731">17.3.1 ç‰©ç†å¼•æ“é€‰æ‹©ä¸å‚æ•°è°ƒä¼˜</h3>
<p>Gazebo æ”¯æŒå¤šç§ç‰©ç†å¼•æ“ï¼Œæ¯ç§å¼•æ“æœ‰å…¶ç‹¬ç‰¹çš„æ€§èƒ½ç‰¹å¾å’Œé€‚ç”¨åœºæ™¯ã€‚</p>
<p><strong>ç‰©ç†å¼•æ“å¯¹æ¯”çŸ©é˜µï¼š</strong></p>
<p>| å¼•æ“ | ç²¾åº¦ | é€Ÿåº¦ | ç¨³å®šæ€§ | é€‚ç”¨åœºæ™¯ |</p>
<table>
<thead>
<tr>
<th>å¼•æ“</th>
<th>ç²¾åº¦</th>
<th>é€Ÿåº¦</th>
<th>ç¨³å®šæ€§</th>
<th>é€‚ç”¨åœºæ™¯</th>
</tr>
</thead>
<tbody>
<tr>
<td>ODE</td>
<td>ä¸­</td>
<td>å¿«</td>
<td>é«˜</td>
<td>é€šç”¨æœºå™¨äººä»¿çœŸ</td>
</tr>
<tr>
<td>Bullet</td>
<td>é«˜</td>
<td>ä¸­</td>
<td>é«˜</td>
<td>å¤æ‚ç¢°æ’ã€è½¯ä½“</td>
</tr>
<tr>
<td>DART</td>
<td>å¾ˆé«˜</td>
<td>æ…¢</td>
<td>å¾ˆé«˜</td>
<td>ç²¾ç¡®åŠ¨åŠ›å­¦ä»¿çœŸ</td>
</tr>
<tr>
<td>Simbody</td>
<td>å¾ˆé«˜</td>
<td>ä¸­</td>
<td>é«˜</td>
<td>ç”Ÿç‰©åŠ›å­¦ä»¿çœŸ</td>
</tr>
</tbody>
</table>
<p><strong>é«˜çº§ç‰©ç†å¼•æ“é…ç½®ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="cm">&lt;!-- Bullet å¼•æ“ç²¾ç»†è°ƒä¼˜ --&gt;</span>
<span class="nt">&lt;physics</span><span class="w"> </span><span class="na">type=</span><span class="s">&quot;bullet&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;max_step_size&gt;</span>0.0005<span class="nt">&lt;/max_step_size&gt;</span><span class="w">  </span><span class="cm">&lt;!-- 500Î¼s æ­¥é•¿foré«˜ç²¾åº¦ --&gt;</span>
<span class="w">    </span><span class="nt">&lt;real_time_factor&gt;</span>1.0<span class="nt">&lt;/real_time_factor&gt;</span>
<span class="w">    </span><span class="nt">&lt;real_time_update_rate&gt;</span>2000<span class="nt">&lt;/real_time_update_rate&gt;</span><span class="w">  </span><span class="cm">&lt;!-- 2kHz æ›´æ–°ç‡ --&gt;</span>

<span class="w">    </span><span class="nt">&lt;bullet&gt;</span>
<span class="w">        </span><span class="nt">&lt;solver&gt;</span>
<span class="w">            </span><span class="nt">&lt;type&gt;</span>sequential_impulse<span class="nt">&lt;/type&gt;</span>
<span class="w">            </span><span class="nt">&lt;iterations&gt;</span>100<span class="nt">&lt;/iterations&gt;</span><span class="w">  </span><span class="cm">&lt;!-- å¢åŠ è¿­ä»£foræ›´å¥½æ”¶æ•› --&gt;</span>
<span class="w">            </span><span class="nt">&lt;sor&gt;</span>1.3<span class="nt">&lt;/sor&gt;</span><span class="w">  </span><span class="cm">&lt;!-- è¶…æ¾å¼›å› å­ --&gt;</span>
<span class="w">        </span><span class="nt">&lt;/solver&gt;</span>

<span class="w">        </span><span class="nt">&lt;constraints&gt;</span>
<span class="w">            </span><span class="nt">&lt;cfm&gt;</span>0.00001<span class="nt">&lt;/cfm&gt;</span><span class="w">  </span><span class="cm">&lt;!-- çº¦æŸåŠ›æ··åˆ,é™ä½foræ›´ç¡¬çº¦æŸ --&gt;</span>
<span class="w">            </span><span class="nt">&lt;erp&gt;</span>0.8<span class="nt">&lt;/erp&gt;</span><span class="w">  </span><span class="cm">&lt;!-- è¯¯å·®å‡å°‘å‚æ•°,æé«˜foræ›´å¿«æ”¶æ•› --&gt;</span>
<span class="w">            </span><span class="nt">&lt;contact_surface_layer&gt;</span>0.0001<span class="nt">&lt;/contact_surface_layer&gt;</span>
<span class="w">        </span><span class="nt">&lt;/constraints&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- ç¢°æ’æ£€æµ‹ä¼˜åŒ– --&gt;</span>
<span class="w">        </span><span class="nt">&lt;collision_detector&gt;</span>btDbvtBroadphase<span class="nt">&lt;/collision_detector&gt;</span>
<span class="w">        </span><span class="nt">&lt;use_dynamic_moi_rescaling&gt;</span>true<span class="nt">&lt;/use_dynamic_moi_rescaling&gt;</span>
<span class="w">        </span><span class="nt">&lt;split_impulse&gt;</span>true<span class="nt">&lt;/split_impulse&gt;</span>
<span class="w">        </span><span class="nt">&lt;split_impulse_penetration_threshold&gt;</span>-0.02<span class="nt">&lt;/split_impulse_penetration_threshold&gt;</span>
<span class="w">    </span><span class="nt">&lt;/bullet&gt;</span>
<span class="nt">&lt;/physics&gt;</span>
</code></pre></div>

<h3 id="1732">17.3.2 ç¢°æ’æ£€æµ‹ä¸æ¥è§¦æ¨¡å‹</h3>
<p>ç²¾ç¡®çš„ç¢°æ’æ£€æµ‹å’Œæ¥è§¦å»ºæ¨¡å¯¹äºæŠ“å–ã€è£…é…ç­‰ä»»åŠ¡è‡³å…³é‡è¦ã€‚</p>
<p><strong>æ¥è§¦å‚æ•°æ·±åº¦é…ç½®ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="nt">&lt;collision</span><span class="w"> </span><span class="na">name=</span><span class="s">&quot;gripper_collision&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;surface&gt;</span>
<span class="w">        </span><span class="nt">&lt;friction&gt;</span>
<span class="w">            </span><span class="nt">&lt;ode&gt;</span>
<span class="w">                </span><span class="nt">&lt;mu&gt;</span>1.0<span class="nt">&lt;/mu&gt;</span><span class="w">  </span><span class="cm">&lt;!-- é™æ‘©æ“¦ç³»æ•° --&gt;</span>
<span class="w">                </span><span class="nt">&lt;mu2&gt;</span>0.8<span class="nt">&lt;/mu2&gt;</span><span class="w">  </span><span class="cm">&lt;!-- åŠ¨æ‘©æ“¦ç³»æ•° --&gt;</span>
<span class="w">                </span><span class="nt">&lt;fdir1&gt;</span>0<span class="w"> </span>0<span class="w"> </span>1<span class="nt">&lt;/fdir1&gt;</span><span class="w">  </span><span class="cm">&lt;!-- æ‘©æ“¦æ–¹å‘ --&gt;</span>
<span class="w">            </span><span class="nt">&lt;/ode&gt;</span>
<span class="w">            </span><span class="nt">&lt;bullet&gt;</span>
<span class="w">                </span><span class="nt">&lt;friction&gt;</span>1.0<span class="nt">&lt;/friction&gt;</span>
<span class="w">                </span><span class="nt">&lt;friction2&gt;</span>0.8<span class="nt">&lt;/friction2&gt;</span>
<span class="w">                </span><span class="nt">&lt;rolling_friction&gt;</span>0.01<span class="nt">&lt;/rolling_friction&gt;</span><span class="w">  </span><span class="cm">&lt;!-- æ»šåŠ¨æ‘©æ“¦ --&gt;</span>
<span class="w">                </span><span class="nt">&lt;spinning_friction&gt;</span>0.001<span class="nt">&lt;/spinning_friction&gt;</span><span class="w">  </span><span class="cm">&lt;!-- æ—‹è½¬æ‘©æ“¦ --&gt;</span>
<span class="w">            </span><span class="nt">&lt;/bullet&gt;</span>
<span class="w">        </span><span class="nt">&lt;/friction&gt;</span>

<span class="w">        </span><span class="nt">&lt;bounce&gt;</span>
<span class="w">            </span><span class="nt">&lt;restitution_coefficient&gt;</span>0.1<span class="nt">&lt;/restitution_coefficient&gt;</span><span class="w">  </span><span class="cm">&lt;!-- å¼¹æ€§ç³»æ•° --&gt;</span>
<span class="w">            </span><span class="nt">&lt;threshold&gt;</span>0.01<span class="nt">&lt;/threshold&gt;</span><span class="w">  </span><span class="cm">&lt;!-- å¼¹æ€§æ¿€æ´»é€Ÿåº¦é˜ˆå€¼ --&gt;</span>
<span class="w">        </span><span class="nt">&lt;/bounce&gt;</span>

<span class="w">        </span><span class="nt">&lt;contact&gt;</span>
<span class="w">            </span><span class="nt">&lt;ode&gt;</span>
<span class="w">                </span><span class="nt">&lt;soft_cfm&gt;</span>0.001<span class="nt">&lt;/soft_cfm&gt;</span><span class="w">  </span><span class="cm">&lt;!-- è½¯æ¥è§¦ --&gt;</span>
<span class="w">                </span><span class="nt">&lt;soft_erp&gt;</span>0.2<span class="nt">&lt;/soft_erp&gt;</span>
<span class="w">                </span><span class="nt">&lt;kp&gt;</span>1000000<span class="nt">&lt;/kp&gt;</span><span class="w">  </span><span class="cm">&lt;!-- æ¥è§¦åˆšåº¦ --&gt;</span>
<span class="w">                </span><span class="nt">&lt;kd&gt;</span>100<span class="nt">&lt;/kd&gt;</span><span class="w">  </span><span class="cm">&lt;!-- æ¥è§¦é˜»å°¼ --&gt;</span>
<span class="w">                </span><span class="nt">&lt;max_vel&gt;</span>100<span class="nt">&lt;/max_vel&gt;</span><span class="w">  </span><span class="cm">&lt;!-- æœ€å¤§ç©¿é€ä¿®æ­£é€Ÿåº¦ --&gt;</span>
<span class="w">                </span><span class="nt">&lt;min_depth&gt;</span>0.001<span class="nt">&lt;/min_depth&gt;</span><span class="w">  </span><span class="cm">&lt;!-- æœ€å°æ¥è§¦æ·±åº¦ --&gt;</span>
<span class="w">            </span><span class="nt">&lt;/ode&gt;</span>
<span class="w">        </span><span class="nt">&lt;/contact&gt;</span>
<span class="w">    </span><span class="nt">&lt;/surface&gt;</span>
<span class="nt">&lt;/collision&gt;</span>
</code></pre></div>

<p><strong>ç¢°æ’ä¼˜åŒ–ç­–ç•¥ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1">// åˆ†å±‚ç¢°æ’æ£€æµ‹ä¼˜åŒ–</span>
<span class="k">class</span><span class="w"> </span><span class="nc">HierarchicalCollisionManager</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">BVHNode</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">AABB</span><span class="w"> </span><span class="n">boundingBox</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">CollisionShape</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">shapes</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">BVHNode</span><span class="o">&gt;</span><span class="w"> </span><span class="n">left</span><span class="p">,</span><span class="w"> </span><span class="n">right</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">BVHNode</span><span class="o">&gt;</span><span class="w"> </span><span class="n">bvhRoot</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">buildBVH</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">CollisionShape</span><span class="o">*&gt;&amp;</span><span class="w"> </span><span class="n">shapes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">bvhRoot</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">constructBVH</span><span class="p">(</span><span class="n">shapes</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">shapes</span><span class="p">.</span><span class="n">size</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">CollisionPair</span><span class="o">&gt;</span><span class="w"> </span><span class="n">detectCollisions</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">CollisionPair</span><span class="o">&gt;</span><span class="w"> </span><span class="n">collisions</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// å®½ç›¸ä½ï¼šBVH éå†</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">CollisionPair</span><span class="o">&gt;</span><span class="w"> </span><span class="n">broadPhasePairs</span><span class="p">;</span>
<span class="w">        </span><span class="n">traverseBVH</span><span class="p">(</span><span class="n">bvhRoot</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span><span class="w"> </span><span class="n">broadPhasePairs</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// çª„ç›¸ä½ï¼šç²¾ç¡®ç¢°æ’æ£€æµ‹</span>
<span class="w">        </span><span class="cp">#pragma omp parallel for</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">pair</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">broadPhasePairs</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">GJK</span><span class="o">::</span><span class="n">intersect</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">EPA</span><span class="o">::</span><span class="n">ContactInfo</span><span class="w"> </span><span class="n">contact</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">EPA</span><span class="o">::</span><span class="n">getContact</span><span class="p">(</span><span class="n">pair</span><span class="p">.</span><span class="n">first</span><span class="p">,</span><span class="w"> </span><span class="n">pair</span><span class="p">.</span><span class="n">second</span><span class="p">);</span>
<span class="w">                </span><span class="cp">#pragma omp critical</span>
<span class="w">                </span><span class="n">collisions</span><span class="p">.</span><span class="n">push_back</span><span class="p">({</span><span class="n">pair</span><span class="p">,</span><span class="w"> </span><span class="n">contact</span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">collisions</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1733">17.3.3 å®æ—¶å› å­ä¸æ­¥é•¿æ§åˆ¶</h3>
<p>ä»¿çœŸé€Ÿåº¦ä¸ç²¾åº¦çš„å¹³è¡¡æ˜¯ç‰©ç†ä»¿çœŸçš„æ ¸å¿ƒæŒ‘æˆ˜ã€‚åˆç†é…ç½®å®æ—¶å› å­å’Œæ­¥é•¿å¯¹ç³»ç»Ÿæ€§èƒ½è‡³å…³é‡è¦ã€‚</p>
<p><strong>åŠ¨æ€æ­¥é•¿æ§åˆ¶ç®—æ³•ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AdaptiveStepController</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">minStepSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0001</span><span class="p">;</span><span class="w">  </span><span class="c1">// 100Î¼s</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">maxStepSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.01</span><span class="p">;</span><span class="w">    </span><span class="c1">// 10ms</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">targetRealTimeFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">currentStepSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.001</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// è¯¯å·®ä¼°è®¡å™¨</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">ErrorEstimator</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">positionError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">velocityError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">energyDrift</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="nf">computeStepSizeMultiplier</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">double</span><span class="w"> </span><span class="n">maxError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">max</span><span class="p">({</span><span class="n">positionError</span><span class="p">,</span><span class="w"> </span><span class="n">velocityError</span><span class="p">,</span><span class="w"> </span><span class="n">energyDrift</span><span class="p">});</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">maxError</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0001</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mf">1.5</span><span class="p">;</span><span class="w">  </span><span class="c1">// å¯ä»¥å¢å¤§æ­¥é•¿</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">maxError</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.01</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="mf">0.5</span><span class="p">;</span><span class="w">    </span><span class="c1">// éœ€è¦å‡å°æ­¥é•¿</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mf">1.0</span><span class="p">;</span><span class="w">  </span><span class="c1">// ä¿æŒå½“å‰æ­¥é•¿</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">errorEstimator</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">computeNextStepSize</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">realTimeFactor</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">computationTime</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åŸºäºå®æ—¶å› å­è°ƒæ•´</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">rtfError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">targetRealTimeFactor</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">realTimeFactor</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">rtfAdjustment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">rtfError</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// åŸºäºè¯¯å·®ä¼°è®¡è°ƒæ•´</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">errorAdjustment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">errorEstimator</span><span class="p">.</span><span class="n">computeStepSizeMultiplier</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// ç»¼åˆè°ƒæ•´</span>
<span class="w">        </span><span class="n">currentStepSize</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">rtfAdjustment</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">errorAdjustment</span><span class="p">;</span>
<span class="w">        </span><span class="n">currentStepSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">clamp</span><span class="p">(</span><span class="n">currentStepSize</span><span class="p">,</span><span class="w"> </span><span class="n">minStepSize</span><span class="p">,</span><span class="w"> </span><span class="n">maxStepSize</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">currentStepSize</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>å®æ—¶æ€§èƒ½ç›‘æ§ç³»ç»Ÿï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SimulationProfiler</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">TimingStats</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">physicsTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">sensorTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">renderTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">pluginTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">totalTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">reset</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">physicsTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sensorTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">renderTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pluginTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">totalTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">deque</span><span class="o">&lt;</span><span class="n">TimingStats</span><span class="o">&gt;</span><span class="w"> </span><span class="n">historyBuffer</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">bufferSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1000</span><span class="p">;</span><span class="w">  </span><span class="c1">// ä¿å­˜æœ€è¿‘1000å¸§</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">recordFrame</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">TimingStats</span><span class="o">&amp;</span><span class="w"> </span><span class="n">stats</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">historyBuffer</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">stats</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">historyBuffer</span><span class="p">.</span><span class="n">size</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">bufferSize</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">historyBuffer</span><span class="p">.</span><span class="n">pop_front</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">generateReport</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">TimingStats</span><span class="w"> </span><span class="n">avg</span><span class="p">;</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">frame</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">historyBuffer</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">avg</span><span class="p">.</span><span class="n">physicsTime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">frame</span><span class="p">.</span><span class="n">physicsTime</span><span class="p">;</span>
<span class="w">            </span><span class="n">avg</span><span class="p">.</span><span class="n">sensorTime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">frame</span><span class="p">.</span><span class="n">sensorTime</span><span class="p">;</span>
<span class="w">            </span><span class="n">avg</span><span class="p">.</span><span class="n">renderTime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">frame</span><span class="p">.</span><span class="n">renderTime</span><span class="p">;</span>
<span class="w">            </span><span class="n">avg</span><span class="p">.</span><span class="n">pluginTime</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">frame</span><span class="p">.</span><span class="n">pluginTime</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">historyBuffer</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>
<span class="w">        </span><span class="n">avg</span><span class="p">.</span><span class="n">physicsTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">        </span><span class="n">avg</span><span class="p">.</span><span class="n">sensorTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">        </span><span class="n">avg</span><span class="p">.</span><span class="n">renderTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">        </span><span class="n">avg</span><span class="p">.</span><span class="n">pluginTime</span><span class="w"> </span><span class="o">/=</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>

<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">stringstream</span><span class="w"> </span><span class="n">report</span><span class="p">;</span>
<span class="w">        </span><span class="n">report</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;=== Simulation Performance Report ===</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">               </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Physics: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">avg</span><span class="p">.</span><span class="n">physicsTime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; ms</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">               </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Sensors: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">avg</span><span class="p">.</span><span class="n">sensorTime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; ms</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">               </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Rendering: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">avg</span><span class="p">.</span><span class="n">renderTime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; ms</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">               </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Plugins: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">avg</span><span class="p">.</span><span class="n">pluginTime</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; ms</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">               </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Real-time factor: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">computeRTF</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">report</span><span class="p">.</span><span class="n">str</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="174">17.4 ç¡¬ä»¶åœ¨ç¯ä»¿çœŸ</h2>
<h3 id="1741-hil">17.4.1 HIL æ¶æ„è®¾è®¡</h3>
<p>ç¡¬ä»¶åœ¨ç¯ï¼ˆHardware-in-the-Loopï¼‰ä»¿çœŸå°†çœŸå®ç¡¬ä»¶ç»„ä»¶é›†æˆåˆ°ä»¿çœŸç¯å¢ƒä¸­ï¼Œæ˜¯éªŒè¯æ§åˆ¶ç®—æ³•å’Œç³»ç»Ÿé›†æˆçš„å…³é”®æŠ€æœ¯ã€‚</p>
<p><strong>HIL ç³»ç»Ÿæ¶æ„ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Gazebo Simulation              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚Virtual Robotâ”‚ Virtual Environmentâ”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†• (ROS2 Topics)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         HIL Bridge Node                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ â€¢ Time Synchronization           â”‚    â”‚
â”‚  â”‚ â€¢ Data Format Conversion         â”‚    â”‚
â”‚  â”‚ â€¢ Safety Monitors                â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†• (Real-time Interface)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      Real Hardware Components            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚Controllerâ”‚   Sensors   â”‚Actuatorsâ”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>HIL æ¡¥æ¥èŠ‚ç‚¹å®ç°ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HILBridge</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// å®æ—¶è°ƒåº¦å™¨</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">RTScheduler</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">99</span><span class="p">;</span><span class="w">  </span><span class="c1">// RT priority</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">cpuCore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span><span class="w">    </span><span class="c1">// Dedicated CPU core</span>

<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="nf">setup</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// è®¾ç½®å®æ—¶è°ƒåº¦ç­–ç•¥</span>
<span class="w">            </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_param</span><span class="w"> </span><span class="n">param</span><span class="p">;</span>
<span class="w">            </span><span class="n">param</span><span class="p">.</span><span class="n">sched_priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">priority</span><span class="p">;</span>
<span class="w">            </span><span class="n">sched_setscheduler</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">SCHED_FIFO</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>

<span class="w">            </span><span class="c1">// CPU äº²å’Œæ€§è®¾ç½®</span>
<span class="w">            </span><span class="kt">cpu_set_t</span><span class="w"> </span><span class="n">cpuset</span><span class="p">;</span>
<span class="w">            </span><span class="n">CPU_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="w">            </span><span class="n">CPU_SET</span><span class="p">(</span><span class="n">cpuCore</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="w">            </span><span class="n">sched_setaffinity</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cpuset</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">rtScheduler</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// ç¡¬ä»¶æ¥å£</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">HardwareInterface</span><span class="o">&gt;</span><span class="w"> </span><span class="n">hwInterface</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// æ—¶é—´åŒæ­¥</span>
<span class="w">    </span><span class="k">class</span><span class="w"> </span><span class="nc">TimeSynchronizer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">private</span><span class="o">:</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">simTime</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">hwTime</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">clockSkew</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.0</span><span class="p">;</span>

<span class="w">    </span><span class="k">public</span><span class="o">:</span>
<span class="w">        </span><span class="kt">void</span><span class="w"> </span><span class="n">synchronize</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// PTP/IEEE 1588 æ—¶é—´åŒæ­¥</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">ptpTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getPTPTime</span><span class="p">();</span>
<span class="w">            </span><span class="k">auto</span><span class="w"> </span><span class="n">localTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">            </span><span class="n">clockSkew</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">ptpTime</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">localTime</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">getTimeDelta</span><span class="p">()</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">clockSkew</span><span class="p">;</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="n">timeSynchronizer</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">HILBridge</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="s">&quot;hil_bridge&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// è®¾ç½®å®æ—¶ä¼˜å…ˆçº§</span>
<span class="w">        </span><span class="n">rtScheduler</span><span class="p">.</span><span class="n">setup</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// åˆå§‹åŒ–ç¡¬ä»¶æ¥å£</span>
<span class="w">        </span><span class="n">hwInterface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">EtherCATInterface</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="n">hwInterface</span><span class="o">-&gt;</span><span class="n">initialize</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// åˆ›å»ºå®šæ—¶å™¨forå‘¨æœŸæ€§æ›´æ–°</span>
<span class="w">        </span><span class="n">timer_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_wall_timer</span><span class="p">(</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="p">(</span><span class="mi">250</span><span class="p">),</span><span class="w">  </span><span class="c1">// 4kHz</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">HILBridge</span><span class="o">::</span><span class="n">controlLoop</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">controlLoop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// ä»ç¡¬ä»¶è¯»å–ä¼ æ„Ÿå™¨æ•°æ®</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">sensorData</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hwInterface</span><span class="o">-&gt;</span><span class="n">readSensors</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// å‘å¸ƒåˆ°ä»¿çœŸ</span>
<span class="w">        </span><span class="n">publishToSimulation</span><span class="p">(</span><span class="n">sensorData</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ä»ä»¿çœŸæ¥æ”¶æ§åˆ¶å‘½ä»¤</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">commands</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">receiveFromSimulation</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// å®‰å…¨æ£€æŸ¥</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">safetyCheck</span><span class="p">(</span><span class="n">commands</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">RCLCPP_ERROR</span><span class="p">(</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Safety violation detected!&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="n">emergencyStop</span><span class="p">();</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// å†™å…¥ç¡¬ä»¶</span>
<span class="w">        </span><span class="n">hwInterface</span><span class="o">-&gt;</span><span class="n">writeActuators</span><span class="p">(</span><span class="n">commands</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ€§èƒ½ç›‘æ§</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">duration</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.00025</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 250Î¼s deadline</span>
<span class="w">            </span><span class="n">RCLCPP_WARN</span><span class="p">(</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Control loop missed deadline: %.3f ms&quot;</span><span class="p">,</span><span class="w"> </span>
<span class="w">                       </span><span class="n">duration</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1000</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1742">17.4.2 å®æ—¶æ€§ä¿è¯</h3>
<p>HIL ä»¿çœŸçš„å®æ—¶æ€§è¦æ±‚æé«˜ï¼Œéœ€è¦ä¸“é—¨çš„ä¼˜åŒ–ç­–ç•¥ã€‚</p>
<p><strong>å®æ—¶å†…æ ¸é…ç½®ï¼ˆPREEMPT_RTï¼‰ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å†…æ ¸é…ç½®é€‰é¡¹</span>
<span class="nv">CONFIG_PREEMPT_RT</span><span class="o">=</span>y
<span class="nv">CONFIG_HIGH_RES_TIMERS</span><span class="o">=</span>y
<span class="nv">CONFIG_NO_HZ_FULL</span><span class="o">=</span>y
<span class="nv">CONFIG_RCU_NOCB_CPU</span><span class="o">=</span>y
<span class="nv">CONFIG_RCU_NOCB_CPU_ALL</span><span class="o">=</span>y

<span class="c1"># ç³»ç»Ÿè°ƒä¼˜å‚æ•°</span>
<span class="nb">echo</span><span class="w"> </span>-1<span class="w"> </span>&gt;<span class="w"> </span>/proc/sys/kernel/sched_rt_runtime_us
<span class="nb">echo</span><span class="w"> </span><span class="m">0</span><span class="w"> </span>&gt;<span class="w"> </span>/proc/sys/kernel/watchdog
<span class="nb">echo</span><span class="w"> </span>performance<span class="w"> </span>&gt;<span class="w"> </span>/sys/devices/system/cpu/cpu*/cpufreq/scaling_governor
</code></pre></div>

<p><strong>é›¶æ‹·è´å…±äº«å†…å­˜é€šä¿¡ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SharedMemoryTransport</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">SHMHeader</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sequence</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dataReady</span><span class="p">;</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">dataSize</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">timestamp</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kt">void</span><span class="o">*</span><span class="w"> </span><span class="n">shmPtr</span><span class="p">;</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">shmSize</span><span class="p">;</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">shmFd</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">initialize</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åˆ›å»ºå…±äº«å†…å­˜</span>
<span class="w">        </span><span class="n">shmFd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">shm_open</span><span class="p">(</span><span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">O_CREAT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">O_RDWR</span><span class="p">,</span><span class="w"> </span><span class="mo">0666</span><span class="p">);</span>
<span class="w">        </span><span class="n">ftruncate</span><span class="p">(</span><span class="n">shmFd</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ˜ å°„åˆ°è¿›ç¨‹åœ°å€ç©ºé—´</span>
<span class="w">        </span><span class="n">shmPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">mmap</span><span class="p">(</span><span class="k">nullptr</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">,</span><span class="w"> </span><span class="n">PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_WRITE</span><span class="p">,</span><span class="w"> </span>
<span class="w">                     </span><span class="n">MAP_SHARED</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MAP_LOCKED</span><span class="p">,</span><span class="w"> </span><span class="n">shmFd</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// é”å®šå†…å­˜é˜²æ­¢æ¢é¡µ</span>
<span class="w">        </span><span class="n">mlock</span><span class="p">(</span><span class="n">shmPtr</span><span class="p">,</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">shmPtr</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">MAP_FAILED</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">writeData</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">T</span><span class="o">&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="o">*</span><span class="w"> </span><span class="n">header</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="n">SHMHeader</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">shmPtr</span><span class="p">);</span>
<span class="w">        </span><span class="k">auto</span><span class="o">*</span><span class="w"> </span><span class="n">dataPtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">reinterpret_cast</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">*&gt;</span><span class="p">(</span><span class="n">shmPtr</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">SHMHeader</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ç­‰å¾…è¯»å–æ–¹å®Œæˆ</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">header</span><span class="o">-&gt;</span><span class="n">dataReady</span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_acquire</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">yield</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// å†™å…¥æ•°æ®</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">memcpy</span><span class="p">(</span><span class="n">dataPtr</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">));</span>
<span class="w">        </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">dataSize</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">T</span><span class="p">);</span>
<span class="w">        </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">        </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">sequence</span><span class="p">.</span><span class="n">fetch_add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">);</span>
<span class="w">        </span><span class="n">header</span><span class="o">-&gt;</span><span class="n">dataReady</span><span class="p">.</span><span class="n">store</span><span class="p">(</span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">memory_order_release</span><span class="p">);</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="175-nvidia-isaac-sim">17.5 äº§ä¸šæ¡ˆä¾‹ç ”ç©¶ï¼šNVIDIA Isaac Sim åˆæˆæ•°æ®ç”Ÿæˆ</h2>
<p>NVIDIA Isaac Sim å±•ç¤ºäº†ç°ä»£ä»¿çœŸå¹³å°å¦‚ä½•å¤§è§„æ¨¡ç”Ÿæˆé«˜è´¨é‡åˆæˆæ•°æ®ç”¨äºæœºå™¨å­¦ä¹ è®­ç»ƒã€‚</p>
<h3 id="_1">æ¡ˆä¾‹èƒŒæ™¯</h3>
<p>Amazon Robotics éœ€è¦è®­ç»ƒè§†è§‰æ¨¡å‹è¯†åˆ«æ•°ç™¾ä¸‡ç§å•†å“ï¼Œä½†æ”¶é›†çœŸå®æ•°æ®æˆæœ¬é«˜æ˜‚ä¸”è€—æ—¶ã€‚ä»–ä»¬é‡‡ç”¨ Isaac Sim ç”Ÿæˆåˆæˆæ•°æ®ï¼Œå®ç°äº†ï¼š</p>
<ul>
<li>æ•°æ®ç”Ÿæˆé€Ÿåº¦æå‡ 1000 å€</li>
<li>æ ‡æ³¨æˆæœ¬é™ä½ 99%</li>
<li>æ¨¡å‹å‡†ç¡®ç‡è¾¾åˆ° 95%ï¼ˆä¸çœŸå®æ•°æ®è®­ç»ƒç›¸å½“ï¼‰</li>
</ul>
<h3 id="_2">æŠ€æœ¯æ¶æ„</h3>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">         </span><span class="nv">Isaac</span><span class="w"> </span><span class="nv">Sim</span><span class="w"> </span><span class="nv">Core</span><span class="w">               </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">     </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span><span class="nv">PhysX</span><span class="w"> </span><span class="mi">5</span>.<span class="mi">0</span><span class="w"> </span><span class="nv">Physics</span><span class="w"> </span><span class="nv">Engine</span><span class="w">   </span>â”‚<span class="w">     </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">     </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">     </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="w">  </span><span class="nv">RTX</span><span class="w"> </span><span class="nv">Ray</span><span class="w"> </span><span class="nv">Tracing</span><span class="w"> </span><span class="nv">Renderer</span><span class="w">   </span>â”‚<span class="w">     </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">     </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
<span class="w">              </span>â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">      </span><span class="nv">Synthetic</span><span class="w"> </span><span class="nv">Data</span><span class="w"> </span><span class="nv">Generation</span><span class="w">       </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="nv">Domain</span><span class="w">    </span>â”‚<span class="nv">Sensor</span><span class="w">    </span>â”‚<span class="nv">Ground</span><span class="w">   </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="k">Random</span>.<span class="w">   </span>â”‚<span class="nv">Simulation</span>â”‚<span class="nv">Truth</span><span class="w">    </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">    </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
<span class="w">              </span>â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚<span class="w">         </span><span class="nv">Training</span><span class="w"> </span><span class="nv">Pipeline</span><span class="w">            </span>â”‚
â”‚<span class="w">  </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="nv">Data</span><span class="w">      </span>â”‚<span class="nv">Model</span><span class="w">     </span>â”‚<span class="nv">Deploy</span><span class="w">   </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â”‚<span class="nv">Validation</span>â”‚<span class="nv">Training</span><span class="w">  </span>â”‚<span class="nv">to</span><span class="w"> </span><span class="nv">Robot</span><span class="w"> </span>â”‚<span class="w">    </span>â”‚
â”‚<span class="w">  </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w">    </span>â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="_3">å…³é”®æŠ€æœ¯å®ç°</h3>
<ol>
<li><strong>åŸŸéšæœºåŒ–ï¼ˆDomain Randomizationï¼‰ï¼š</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DomainRandomizer</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim</span> <span class="o">=</span> <span class="n">sim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;lighting&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;intensity&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span>
                <span class="s1">&#39;color_temp&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">2700</span><span class="p">,</span> <span class="mi">6500</span><span class="p">),</span>  <span class="c1"># Kelvin</span>
                <span class="s1">&#39;num_lights&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="s1">&#39;materials&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;metallic&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                <span class="s1">&#39;roughness&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
                <span class="s1">&#39;specular&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="s1">&#39;camera&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;fov&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="mi">90</span><span class="p">),</span>
                <span class="s1">&#39;exposure&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;noise_level&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
            <span class="p">},</span>
            <span class="s1">&#39;physics&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;friction&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">),</span>
                <span class="s1">&#39;restitution&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                <span class="s1">&#39;mass_scale&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">randomize_scene</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># å…‰ç…§éšæœºåŒ–</span>
        <span class="k">for</span> <span class="n">light</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">get_lights</span><span class="p">():</span>
            <span class="n">intensity</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lighting&#39;</span><span class="p">][</span><span class="s1">&#39;intensity&#39;</span><span class="p">])</span>
            <span class="n">color_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;lighting&#39;</span><span class="p">][</span><span class="s1">&#39;color_temp&#39;</span><span class="p">])</span>
            <span class="n">light</span><span class="o">.</span><span class="n">set_intensity</span><span class="p">(</span><span class="n">intensity</span><span class="p">)</span>
            <span class="n">light</span><span class="o">.</span><span class="n">set_color_temperature</span><span class="p">(</span><span class="n">color_temp</span><span class="p">)</span>

        <span class="c1"># æè´¨éšæœºåŒ–</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">get_objects</span><span class="p">():</span>
            <span class="n">metallic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;materials&#39;</span><span class="p">][</span><span class="s1">&#39;metallic&#39;</span><span class="p">])</span>
            <span class="n">roughness</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;materials&#39;</span><span class="p">][</span><span class="s1">&#39;roughness&#39;</span><span class="p">])</span>
            <span class="n">obj</span><span class="o">.</span><span class="n">set_material_properties</span><span class="p">(</span><span class="n">metallic</span><span class="o">=</span><span class="n">metallic</span><span class="p">,</span> <span class="n">roughness</span><span class="o">=</span><span class="n">roughness</span><span class="p">)</span>

        <span class="c1"># ç›¸æœºå‚æ•°éšæœºåŒ–</span>
        <span class="n">camera</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim</span><span class="o">.</span><span class="n">get_camera</span><span class="p">()</span>
        <span class="n">fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;camera&#39;</span><span class="p">][</span><span class="s1">&#39;fov&#39;</span><span class="p">])</span>
        <span class="n">exposure</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;camera&#39;</span><span class="p">][</span><span class="s1">&#39;exposure&#39;</span><span class="p">])</span>
        <span class="n">camera</span><span class="o">.</span><span class="n">set_fov</span><span class="p">(</span><span class="n">fov</span><span class="p">)</span>
        <span class="n">camera</span><span class="o">.</span><span class="n">set_exposure</span><span class="p">(</span><span class="n">exposure</span><span class="p">)</span>
</code></pre></div>

<ol start="2">
<li><strong>é«˜æ€§èƒ½æ•°æ®ç”Ÿæˆç®¡é“ï¼š</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SyntheticDataGenerator</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_gpus</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_gpus</span> <span class="o">=</span> <span class="n">num_gpus</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sim_instances</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># å¤š GPU å¹¶è¡Œä»¿çœŸ</span>
        <span class="k">for</span> <span class="n">gpu_id</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_gpus</span><span class="p">):</span>
            <span class="n">sim</span> <span class="o">=</span> <span class="n">IsaacSim</span><span class="p">(</span><span class="n">gpu_id</span><span class="o">=</span><span class="n">gpu_id</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sim_instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_samples</span><span class="o">=</span><span class="mi">1000000</span><span class="p">):</span>
        <span class="n">samples_per_gpu</span> <span class="o">=</span> <span class="n">num_samples</span> <span class="o">//</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_gpus</span>

        <span class="k">with</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">num_gpus</span><span class="p">)</span> <span class="k">as</span> <span class="n">executor</span><span class="p">:</span>
            <span class="n">futures</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sim</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sim_instances</span><span class="p">:</span>
                <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_generate_on_gpu</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">samples_per_gpu</span><span class="p">)</span>
                <span class="n">futures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">future</span><span class="p">)</span>

            <span class="c1"># æ”¶é›†ç»“æœ</span>
            <span class="n">all_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">future</span> <span class="ow">in</span> <span class="n">concurrent</span><span class="o">.</span><span class="n">futures</span><span class="o">.</span><span class="n">as_completed</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                <span class="n">all_data</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">all_data</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_on_gpu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">,</span> <span class="n">num_samples</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_samples</span><span class="p">):</span>
            <span class="c1"># åœºæ™¯éšæœºåŒ–</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">randomizer</span><span class="o">.</span><span class="n">randomize_scene</span><span class="p">()</span>

            <span class="c1"># ç‰©ä½“ä½å§¿éšæœºåŒ–</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_randomize_object_poses</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>

            <span class="c1"># æ¸²æŸ“</span>
            <span class="n">rgb</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">segmentation</span> <span class="o">=</span> <span class="n">sim</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

            <span class="c1"># ç”Ÿæˆæ ‡æ³¨</span>
            <span class="n">annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_annotations</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>

            <span class="n">data</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;rgb&#39;</span><span class="p">:</span> <span class="n">rgb</span><span class="p">,</span>
                <span class="s1">&#39;depth&#39;</span><span class="p">:</span> <span class="n">depth</span><span class="p">,</span>
                <span class="s1">&#39;segmentation&#39;</span><span class="p">:</span> <span class="n">segmentation</span><span class="p">,</span>
                <span class="s1">&#39;annotations&#39;</span><span class="p">:</span> <span class="n">annotations</span><span class="p">,</span>
                <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_metadata</span><span class="p">(</span><span class="n">sim</span><span class="p">)</span>
            <span class="p">})</span>

            <span class="c1"># å®šæœŸä¿å­˜</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_save_batch</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1000</span><span class="p">:],</span> <span class="sa">f</span><span class="s1">&#39;batch_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">data</span>
</code></pre></div>

<h3 id="_4">æ€§èƒ½æŒ‡æ ‡ä¸ä¼˜åŒ–</h3>
<p>| æŒ‡æ ‡ | ä¼ ç»Ÿæ–¹æ³• | Isaac Sim | æå‡å€æ•° |</p>
<table>
<thead>
<tr>
<th>æŒ‡æ ‡</th>
<th>ä¼ ç»Ÿæ–¹æ³•</th>
<th>Isaac Sim</th>
<th>æå‡å€æ•°</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ•°æ®ç”Ÿæˆé€Ÿåº¦</td>
<td>100 å¼ /å°æ—¶</td>
<td>100,000 å¼ /å°æ—¶</td>
<td>1000x</td>
</tr>
<tr>
<td>æ ‡æ³¨æˆæœ¬</td>
<td>$0.5/å¼ </td>
<td>$0.005/å¼ </td>
<td>100x</td>
</tr>
<tr>
<td>åœºæ™¯å¤šæ ·æ€§</td>
<td>æœ‰é™</td>
<td>æ— é™</td>
<td>âˆ</td>
</tr>
<tr>
<td>æ ‡æ³¨å‡†ç¡®ç‡</td>
<td>95%</td>
<td>100%</td>
<td>1.05x</td>
</tr>
</tbody>
</table>
<h3 id="_5">è¸©å‘ä¸è§£å†³æ–¹æ¡ˆ</h3>
<ol>
<li>
<p><strong>GPU å†…å­˜æº¢å‡º</strong>ï¼š
   - é—®é¢˜ï¼šé«˜åˆ†è¾¨ç‡æ¸²æŸ“å¯¼è‡´ GPU OOM
   - è§£å†³ï¼šå®ç°åŠ¨æ€æ‰¹å¤„ç†å’Œå†…å­˜æ± ç®¡ç†</p>
</li>
<li>
<p><strong>Sim-to-Real Gap</strong>ï¼š
   - é—®é¢˜ï¼šä»¿çœŸè®­ç»ƒæ¨¡å‹åœ¨çœŸå®ç¯å¢ƒè¡¨ç°å·®
   - è§£å†³ï¼šå¼•å…¥ç‰©ç†å™ªå£°æ¨¡å‹å’Œä¼ æ„Ÿå™¨è¯¯å·®æ¨¡æ‹Ÿ</p>
</li>
<li>
<p><strong>æ•°æ®åˆ†å¸ƒåå·®</strong>ï¼š
   - é—®é¢˜ï¼šéšæœºç”Ÿæˆæ•°æ®åˆ†å¸ƒä¸çœŸå®æ•°æ®ä¸åŒ¹é…
   - è§£å†³ï¼šä½¿ç”¨çœŸå®æ•°æ®ç»Ÿè®¡æŒ‡å¯¼éšæœºåŒ–å‚æ•°</p>
</li>
</ol>
<h2 id="176">17.6 é«˜çº§è¯é¢˜</h2>
<h3 id="1761">17.6.1 åˆ†å¸ƒå¼ä»¿çœŸä¸äº‘ç«¯è®­ç»ƒ</h3>
<p>å¤§è§„æ¨¡æœºå™¨äººä»¿çœŸéœ€è¦åˆ†å¸ƒå¼æ¶æ„æ”¯æŒã€‚</p>
<p><strong>åˆ†å¸ƒå¼ä»¿çœŸæ¶æ„ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DistributedSimulation</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">master_node</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;master&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">worker_nodes</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;workers&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;redis_host&#39;</span><span class="p">])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">distribute_simulation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">world_config</span><span class="p">,</span> <span class="n">num_robots</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
        <span class="c1"># ç©ºé—´åˆ†åŒº</span>
        <span class="n">partitions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spatial_partitioning</span><span class="p">(</span><span class="n">world_config</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_nodes</span><span class="p">))</span>

        <span class="c1"># åˆ†é…æœºå™¨äººåˆ°åˆ†åŒº</span>
        <span class="n">robot_assignments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_assign_robots</span><span class="p">(</span><span class="n">num_robots</span><span class="p">,</span> <span class="n">partitions</span><span class="p">)</span>

        <span class="c1"># å¯åŠ¨åˆ†å¸ƒå¼ä»¿çœŸ</span>
        <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">worker</span><span class="p">,</span> <span class="n">partition</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">worker_nodes</span><span class="p">,</span> <span class="n">partitions</span><span class="p">):</span>
            <span class="n">task</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s1">&#39;partition&#39;</span><span class="p">:</span> <span class="n">partition</span><span class="p">,</span>
                <span class="s1">&#39;robots&#39;</span><span class="p">:</span> <span class="n">robot_assignments</span><span class="p">[</span><span class="n">partition</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]],</span>
                <span class="s1">&#39;sync_rate&#39;</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span>  <span class="c1"># Hz</span>
            <span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">redis_client</span><span class="o">.</span><span class="n">rpush</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;tasks:</span><span class="si">{</span><span class="n">worker</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">task</span><span class="p">))</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="c1"># åŒæ­¥å¾ªç¯</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="c1"># æ”¶é›†çŠ¶æ€</span>
            <span class="n">states</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_states</span><span class="p">()</span>

            <span class="c1"># è§£å†³è¾¹ç•Œäº¤äº’</span>
            <span class="n">boundary_forces</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_boundaries</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>

            <span class="c1"># åˆ†å‘æ›´æ–°</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_distribute_updates</span><span class="p">(</span><span class="n">boundary_forces</span><span class="p">)</span>

            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.001</span><span class="p">)</span>  <span class="c1"># 1ms åŒæ­¥å‘¨æœŸ</span>
</code></pre></div>

<h3 id="1762">17.6.2 å‰æ²¿ç ”ç©¶æ–¹å‘</h3>
<ol>
<li><strong>å¯å¾®åˆ†ä»¿çœŸï¼ˆDifferentiable Simulationï¼‰ï¼š</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">taichi</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">ti</span>

<span class="nd">@ti</span><span class="o">.</span><span class="n">kernel</span>
<span class="k">def</span><span class="w"> </span><span class="nf">differentiable_physics_step</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">ti</span><span class="o">.</span><span class="n">template</span><span class="p">(),</span> <span class="n">v</span><span class="p">:</span> <span class="n">ti</span><span class="o">.</span><span class="n">template</span><span class="p">(),</span> 
                                <span class="n">f</span><span class="p">:</span> <span class="n">ti</span><span class="o">.</span><span class="n">template</span><span class="p">(),</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x</span><span class="p">:</span>
        <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">dt</span>

        <span class="c1"># ç¢°æ’æ£€æµ‹ä¸å“åº”ï¼ˆå¯å¾®åˆ†ï¼‰</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="mf">0.8</span>  <span class="c1"># å¼¹æ€§ç¢°æ’</span>
</code></pre></div>

<ol start="2">
<li><strong>ç¥ç»ç‰©ç†å¼•æ“ï¼š</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NeuralPhysicsEngine</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state_dim</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="o">=</span><span class="mi">256</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">state_dim</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">GRU</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">,</span> <span class="n">num_layers</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">hidden_dim</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">hidden_dim</span><span class="p">,</span> <span class="n">state_dim</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">,</span> <span class="n">dt</span><span class="p">):</span>
        <span class="c1"># ç¼–ç å½“å‰çŠ¶æ€å’ŒåŠ¨ä½œ</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span><span class="n">state</span><span class="p">,</span> <span class="n">action</span><span class="p">],</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># é¢„æµ‹ä¸‹ä¸€çŠ¶æ€</span>
        <span class="n">h</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dynamics</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
        <span class="n">next_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span><span class="n">h</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">state</span> <span class="o">+</span> <span class="n">next_state</span> <span class="o">*</span> <span class="n">dt</span>
</code></pre></div>

<h3 id="1763-paper-reading-guide">17.6.3 Paper Reading Guide</h3>
<ol>
<li>
<p><strong>"Sim-to-Real: Learning Agile Locomotion For Quadruped Robots"</strong> (RSS 2018)
   - å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ä»¿çœŸè®­ç»ƒå››è¶³æœºå™¨äººè¿åŠ¨æ§åˆ¶
   - å…³é”®æŠ€æœ¯ï¼šåŸŸéšæœºåŒ–ã€è¯¾ç¨‹å­¦ä¹ </p>
</li>
<li>
<p><strong>"Learning Dexterous In-Hand Manipulation"</strong> (IJRR 2019)
   - OpenAI çš„æœºæ¢°æ‰‹æ“ä½œå­¦ä¹ 
   - å…³é”®æŠ€æœ¯ï¼šå¤§è§„æ¨¡å¹¶è¡Œä»¿çœŸã€è‡ªåŠ¨åŸŸéšæœºåŒ–</p>
</li>
<li>
<p><strong>"DiffTaichi: Differentiable Programming for Physical Simulation"</strong> (ICLR 2020)
   - å¯å¾®åˆ†ç‰©ç†ä»¿çœŸæ¡†æ¶
   - å…³é”®æŠ€æœ¯ï¼šè‡ªåŠ¨å¾®åˆ†ã€æ¢¯åº¦ä¼˜åŒ–</p>
</li>
</ol>
<h3 id="1764">17.6.4 å¼€æºé¡¹ç›®æ¨è</h3>
<ol>
<li><strong>Isaac Gym</strong> - NVIDIA çš„é«˜æ€§èƒ½ç‰©ç†ä»¿çœŸ</li>
<li><strong>PyBullet</strong> - å¼€æºç‰©ç†å¼•æ“ Python æ¥å£</li>
<li><strong>MuJoCo</strong> - é«˜ç²¾åº¦æ¥è§¦åŠ¨åŠ›å­¦ä»¿çœŸ</li>
<li><strong>Drake</strong> - ä¸°ç”°ç ”ç©¶é™¢çš„å¤šä½“åŠ¨åŠ›å­¦åº“</li>
</ol>
<h2 id="177">17.7 æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº† ROS2 ä¸ Gazebo/Ignition ä»¿çœŸå¹³å°çš„é›†æˆï¼Œæ¶µç›–äº†ä»åŸºç¡€ç¯å¢ƒæ­å»ºåˆ°é«˜çº§ç¡¬ä»¶åœ¨ç¯ä»¿çœŸçš„å®Œæ•´æŠ€æœ¯æ ˆã€‚å…³é”®è¦ç‚¹åŒ…æ‹¬ï¼š</p>
<ol>
<li><strong>æ¶æ„é€‰æ‹©</strong>ï¼šIgnition Gazebo çš„ ECS æ¶æ„æä¾›äº†æ›´å¥½çš„æ¨¡å—åŒ–å’Œæ€§èƒ½</li>
<li><strong>æ’ä»¶å¼€å‘</strong>ï¼šé«˜æ€§èƒ½æ’ä»¶éœ€è¦è€ƒè™‘å†…å­˜é¢„åˆ†é…ã€å¹¶è¡Œå¤„ç†å’Œç¼“å­˜ä¼˜åŒ–</li>
<li><strong>ç‰©ç†å¼•æ“</strong>ï¼šä¸åŒå¼•æ“é€‚ç”¨ä¸åŒåœºæ™¯ï¼Œå‚æ•°è°ƒä¼˜å¯¹ä»¿çœŸè´¨é‡è‡³å…³é‡è¦</li>
<li><strong>HIL ä»¿çœŸ</strong>ï¼šå®æ—¶æ€§ä¿è¯éœ€è¦ä¸“é—¨çš„ç³»ç»Ÿé…ç½®å’Œä¼˜åŒ–ç­–ç•¥</li>
<li><strong>åˆæˆæ•°æ®</strong>ï¼šåŸŸéšæœºåŒ–å’Œåˆ†å¸ƒå¼æ¸²æŸ“æ˜¯å¤§è§„æ¨¡æ•°æ®ç”Ÿæˆçš„å…³é”®</li>
</ol>
<p>å…³é”®å…¬å¼ï¼š</p>
<ol>
<li>
<p>å®æ—¶å› å­è®¡ç®—ï¼š
   $$RTF = \frac{t_{sim}}{t_{real}}$$</p>
</li>
<li>
<p>æ­¥é•¿è‡ªé€‚åº”ç®—æ³•ï¼š
$$h_{new} = h_{old} \cdot \min\left(\alpha_{max}, \max\left(\alpha_{min}, \sqrt{\frac{\epsilon_{tol}}{\epsilon_{est}}}\right)\right)$$</p>
</li>
<li>
<p>ç¢°æ’å“åº”å†²é‡ï¼š
$$j = \frac{-(1+e)v_{rel} \cdot n}{m_1^{-1} + m_2^{-1} + (I_1^{-1}r_1 \times n + I_2^{-1}r_2 \times n) \cdot n}$$</p>
</li>
</ol>
<h2 id="178">17.8 ç»ƒä¹ é¢˜</h2>
<h3 id="_6">åŸºç¡€é¢˜</h3>
<p><strong>ç»ƒä¹  17.1ï¼šGazebo ä¸–ç•Œæ–‡ä»¶é…ç½®</strong></p>
<p>åˆ›å»ºä¸€ä¸ªä»“åº“ç¯å¢ƒçš„ä¸–ç•Œæ–‡ä»¶ï¼ŒåŒ…å«ï¼š</p>
<ul>
<li>20x15 ç±³çš„åœ°é¢</li>
<li>å››é¢å¢™å£</li>
<li>10 ä¸ªéšæœºæ”¾ç½®çš„ç®±å­</li>
<li>é€‚å½“çš„å…‰ç…§è®¾ç½®</li>
</ul>
<p><em>æç¤ºï¼šä½¿ç”¨ <code>&lt;include&gt;</code> æ ‡ç­¾å¼•å…¥æ¨¡å‹ï¼Œä½¿ç”¨ <code>&lt;pose&gt;</code> è®¾ç½®ä½ç½®</em></p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä¸–ç•Œæ–‡ä»¶åº”åŒ…å«ä»¥ä¸‹å…³é”®å…ƒç´ ï¼š</p>
<ol>
<li>ç‰©ç†å¼•æ“é…ç½®ï¼Œè®¾ç½®åˆé€‚çš„æ­¥é•¿ï¼ˆå¦‚ 0.001sï¼‰</li>
<li>é™æ€åœ°é¢å’Œå¢™å£æ¨¡å‹ï¼Œæ ‡è®°ä¸º <code>&lt;static&gt;true&lt;/static&gt;</code></li>
<li>ä½¿ç”¨å¾ªç¯æˆ–è„šæœ¬ç”Ÿæˆéšæœºç®±å­ä½ç½®</li>
<li>è®¾ç½®ç¯å¢ƒå…‰å’Œæ–¹å‘å…‰æº</li>
<li>é…ç½®åˆé€‚çš„é‡åŠ›å€¼ï¼ˆ-9.81 m/sÂ²ï¼‰</li>
</ol>
<p>å…³é”®è€ƒè™‘ï¼š</p>
<ul>
<li>é™æ€å¯¹è±¡ä¼˜åŒ–ç‰©ç†è®¡ç®—</li>
<li>å…‰ç…§å½±å“è§†è§‰ä¼ æ„Ÿå™¨æ€§èƒ½</li>
<li>ç®±å­ç¢°æ’æ¨¡å‹å¯ç®€åŒ–ä¸ºé•¿æ–¹ä½“</li>
</ul>
</details>
<p><strong>ç»ƒä¹  17.2ï¼šä¼ æ„Ÿå™¨æ’ä»¶å¼€å‘</strong></p>
<p>å¼€å‘ä¸€ä¸ªè‡ªå®šä¹‰è¶…å£°æ³¢ä¼ æ„Ÿå™¨æ’ä»¶ï¼Œè¦æ±‚ï¼š</p>
<ul>
<li>æ¨¡æ‹ŸçœŸå®è¶…å£°æ³¢çš„æ‰‡å½¢æ£€æµ‹åŒºåŸŸ</li>
<li>æ·»åŠ è·ç¦»ç›¸å…³çš„å™ªå£°æ¨¡å‹</li>
<li>å‘å¸ƒ <code>sensor_msgs/Range</code> æ¶ˆæ¯</li>
</ul>
<p><em>æç¤ºï¼šä½¿ç”¨å…‰çº¿æŠ•å°„å®ç°è·ç¦»æ£€æµ‹ï¼Œè€ƒè™‘è¶…å£°æ³¢çš„ç‰©ç†ç‰¹æ€§</em></p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æ’ä»¶å®ç°è¦ç‚¹ï¼š</p>
<ol>
<li>åœ¨ PreUpdate ä¸­é…ç½®ä¼ æ„Ÿå™¨å‚æ•°</li>
<li>åœ¨ PostUpdate ä¸­æ‰§è¡Œå¤šæ¡å…‰çº¿æŠ•å°„æ¨¡æ‹Ÿæ‰‡å½¢åŒºåŸŸ</li>
<li>è®¡ç®—æ‰€æœ‰å…‰çº¿çš„æœ€çŸ­è·ç¦»ä½œä¸ºæ£€æµ‹ç»“æœ</li>
<li>æ·»åŠ é«˜æ–¯å™ªå£°ï¼Œæ ‡å‡†å·®ä¸è·ç¦»æˆæ­£æ¯”</li>
<li>è€ƒè™‘æœ€å°/æœ€å¤§æ£€æµ‹èŒƒå›´é™åˆ¶</li>
</ol>
<p>å™ªå£°æ¨¡å‹ï¼š</p>
<ul>
<li>è¿‘è·ç¦»ï¼šÏƒ = 0.01 * distance</li>
<li>è¿œè·ç¦»ï¼šÏƒ = 0.02 * distance + 0.05</li>
<li>æ·»åŠ å¶å‘çš„å¼‚å¸¸å€¼æ¨¡æ‹Ÿå¤šè·¯å¾„æ•ˆåº”</li>
</ul>
</details>
<p><strong>ç»ƒä¹  17.3ï¼šç‰©ç†å¼•æ“å‚æ•°è°ƒä¼˜</strong></p>
<p>ç»™å®šä¸€ä¸ªæœºæ¢°è‡‚æŠ“å–ä»»åŠ¡ï¼Œç‰©ä½“ç»å¸¸ç©¿é€æˆ–å¼¹é£ã€‚è¯·åˆ—å‡ºéœ€è¦è°ƒæ•´çš„ç‰©ç†å‚æ•°åŠå…¶å½±å“ã€‚</p>
<p><em>æç¤ºï¼šè€ƒè™‘æ¥è§¦åŠ›ã€æ±‚è§£å™¨è¿­ä»£æ¬¡æ•°ã€æ—¶é—´æ­¥é•¿</em></p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>å…³é”®å‚æ•°è°ƒæ•´ï¼š</p>
<ol>
<li>å‡å° max_step_size åˆ° 0.0001-0.0005</li>
<li>å¢åŠ  solver iterations åˆ° 50-200</li>
<li>è°ƒæ•´ CFM åˆ° 0.00001-0.0001ï¼ˆæ›´ç¡¬çš„æ¥è§¦ï¼‰</li>
<li>æé«˜ ERP åˆ° 0.8-0.95ï¼ˆæ›´å¿«çš„è¯¯å·®ä¿®æ­£ï¼‰</li>
<li>è®¾ç½®åˆé€‚çš„ contact_max_correcting_vel</li>
<li>è°ƒæ•´æ‘©æ“¦ç³»æ•°å’Œæ¥è§¦å±‚åšåº¦</li>
</ol>
<p>æƒè¡¡è€ƒè™‘ï¼š</p>
<ul>
<li>ç²¾åº¦ vs è®¡ç®—æˆæœ¬</li>
<li>ç¨³å®šæ€§ vs å“åº”é€Ÿåº¦</li>
<li>çœŸå®æ€§ vs ä»¿çœŸæ•ˆç‡</li>
</ul>
</details>
<h3 id="_7">æŒ‘æˆ˜é¢˜</h3>
<p><strong>ç»ƒä¹  17.4ï¼šåˆ†å¸ƒå¼ä»¿çœŸç³»ç»Ÿè®¾è®¡</strong></p>
<p>è®¾è®¡ä¸€ä¸ªåˆ†å¸ƒå¼ä»¿çœŸç³»ç»Ÿï¼Œæ”¯æŒ 100 ä¸ªæœºå™¨äººåœ¨ 1000x1000 ç±³ç¯å¢ƒä¸­è¿è¡Œã€‚è¦æ±‚ï¼š</p>
<ul>
<li>æœºå™¨äººé—´å¯ä»¥é€šä¿¡å’Œåä½œ</li>
<li>æ”¯æŒåŠ¨æ€è´Ÿè½½å‡è¡¡</li>
<li>å®¹é”™æœºåˆ¶</li>
</ul>
<p><em>æç¤ºï¼šè€ƒè™‘ç©ºé—´åˆ’åˆ†ã€è¾¹ç•ŒåŒæ­¥ã€çŠ¶æ€ä¸€è‡´æ€§</em></p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ç³»ç»Ÿæ¶æ„è®¾è®¡ï¼š</p>
<ol>
<li>
<p><strong>ç©ºé—´åˆ’åˆ†ç­–ç•¥</strong>ï¼š
   - ä½¿ç”¨å››å‰æ ‘åŠ¨æ€åˆ’åˆ†ç©ºé—´
   - æ¯ä¸ªèŠ‚ç‚¹è´Ÿè´£ä¸€ä¸ªåŒºåŸŸ
   - æœºå™¨äººå¯†åº¦è§¦å‘é‡æ–°åˆ’åˆ†</p>
</li>
<li>
<p><strong>åŒæ­¥æœºåˆ¶</strong>ï¼š
   - é‡‡ç”¨ BSPï¼ˆBulk Synchronous Parallelï¼‰æ¨¡å‹
   - è¾¹ç•ŒåŒºåŸŸåŒå‘åŒæ­¥
   - ä½¿ç”¨å‘é‡æ—¶é’Ÿä¿è¯å› æœä¸€è‡´æ€§</p>
</li>
<li>
<p><strong>è´Ÿè½½å‡è¡¡</strong>ï¼š
   - ç›‘æ§å„èŠ‚ç‚¹ CPU/å†…å­˜ä½¿ç”¨ç‡
   - åŸºäºæœºå™¨äººæ•°é‡å’Œè®¡ç®—å¤æ‚åº¦è¿ç§»
   - ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œå‡å°‘è¿ç§»å¼€é”€</p>
</li>
<li>
<p><strong>å®¹é”™è®¾è®¡</strong>ï¼š
   - ä¸»ä»å¤åˆ¶å…³é”®çŠ¶æ€
   - æ£€æŸ¥ç‚¹æœºåˆ¶å®šæœŸä¿å­˜
   - èŠ‚ç‚¹æ•…éšœæ—¶é‚»å±…æ¥ç®¡å…¶åŒºåŸŸ</p>
</li>
</ol>
</details>
<p><strong>ç»ƒä¹  17.5ï¼šSim-to-Real è¿ç§»ä¼˜åŒ–</strong></p>
<p>ä»¿çœŸè®­ç»ƒçš„è§†è§‰æŠ“å–æ¨¡å‹åœ¨çœŸå®ç¯å¢ƒå‡†ç¡®ç‡ä» 95% é™åˆ° 60%ã€‚è®¾è®¡ç³»ç»Ÿæ€§çš„ä¼˜åŒ–æ–¹æ¡ˆã€‚</p>
<p><em>æç¤ºï¼šåˆ†æ domain gap æ¥æºï¼Œè®¾è®¡é’ˆå¯¹æ€§è§£å†³æ–¹æ¡ˆ</em></p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä¼˜åŒ–æ–¹æ¡ˆï¼š</p>
<ol>
<li>
<p><strong>è§†è§‰åŸŸå·®å¼‚</strong>ï¼š
   - æ”¶é›†çœŸå®åœºæ™¯å›¾åƒè®¡ç®—åˆ†å¸ƒå·®å¼‚
   - è°ƒæ•´ä»¿çœŸæ¸²æŸ“å‚æ•°åŒ¹é…çœŸå®ç›¸æœº
   - ä½¿ç”¨ CycleGAN è¿›è¡Œé£æ ¼è¿ç§»</p>
</li>
<li>
<p><strong>ç‰©ç†å‚æ•°æ ¡å‡†</strong>ï¼š
   - ç³»ç»Ÿè¾¨è¯†è·å–çœŸå®æ‘©æ“¦/æƒ¯æ€§å‚æ•°
   - ä½¿ç”¨è´å¶æ–¯ä¼˜åŒ–æœç´¢æœ€ä½³å‚æ•°
   - æ·»åŠ å‚æ•°ä¸ç¡®å®šæ€§è®­ç»ƒ</p>
</li>
<li>
<p><strong>ä¼ æ„Ÿå™¨å™ªå£°å»ºæ¨¡</strong>ï¼š
   - åˆ†æçœŸå®ä¼ æ„Ÿå™¨å™ªå£°ç‰¹æ€§
   - å®ç° Allan æ–¹å·®å™ªå£°æ¨¡å‹
   - æ·»åŠ ç³»ç»Ÿæ€§åå·®å’Œæ¼‚ç§»</p>
</li>
<li>
<p><strong>è®­ç»ƒç­–ç•¥</strong>ï¼š
   - æ¸è¿›å¼åŸŸéšæœºåŒ–
   - æ··åˆçœŸå®å’Œä»¿çœŸæ•°æ®è®­ç»ƒ
   - å¯¹æŠ—è®­ç»ƒæé«˜é²æ£’æ€§</p>
</li>
</ol>
</details>
<p><strong>ç»ƒä¹  17.6ï¼šæ€§èƒ½ç“¶é¢ˆåˆ†æ</strong></p>
<p>æŸä»¿çœŸç³»ç»Ÿå®æ—¶å› å­åªæœ‰ 0.3ï¼Œä½¿ç”¨æ€§èƒ½åˆ†æå·¥å…·å‘ç°ï¼š</p>
<ul>
<li>ç‰©ç†è®¡ç®—ï¼š40%</li>
<li>ä¼ æ„Ÿå™¨æ¨¡æ‹Ÿï¼š35%</li>
<li>æ¸²æŸ“ï¼š15%</li>
<li>å…¶ä»–ï¼š10%</li>
</ul>
<p>è®¾è®¡ä¼˜åŒ–æ–¹æ¡ˆå°†å®æ—¶å› å­æå‡åˆ° 0.8 ä»¥ä¸Šã€‚</p>
<p><em>æç¤ºï¼šè¯†åˆ«å¯å¹¶è¡ŒåŒ–éƒ¨åˆ†ï¼Œè€ƒè™‘ç²¾åº¦-æ€§èƒ½æƒè¡¡</em></p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä¼˜åŒ–ç­–ç•¥ï¼š</p>
<ol>
<li>
<p><strong>ç‰©ç†è®¡ç®—ä¼˜åŒ–ï¼ˆç›®æ ‡å‡å°‘ 50%ï¼‰</strong>ï¼š
   - ä½¿ç”¨å¤šçº¿ç¨‹ç‰©ç†å¼•æ“ï¼ˆBullet MTï¼‰
   - å®ç° LOD for ç¢°æ’æ£€æµ‹
   - ç©ºé—´å“ˆå¸ŒåŠ é€Ÿé‚»è¿‘æŸ¥è¯¢
   - å¢å¤§æ­¥é•¿ï¼Œä½¿ç”¨å­æ­¥è¡¥å¿</p>
</li>
<li>
<p><strong>ä¼ æ„Ÿå™¨ä¼˜åŒ–ï¼ˆç›®æ ‡å‡å°‘ 60%ï¼‰</strong>ï¼š
   - GPU åŠ é€Ÿå…‰çº¿æŠ•å°„
   - é™ä½éå…³é”®ä¼ æ„Ÿå™¨æ›´æ–°é¢‘ç‡
   - å®ç°ä¼ æ„Ÿå™¨æ•°æ®ç¼“å­˜
   - æ‰¹é‡å¤„ç†ä¼ æ„Ÿå™¨æ›´æ–°</p>
</li>
<li>
<p><strong>æ¸²æŸ“ä¼˜åŒ–ï¼ˆç›®æ ‡å‡å°‘ 50%ï¼‰</strong>ï¼š
   - ä»…åœ¨éœ€è¦æ—¶æ¸²æŸ“
   - é™ä½éå…³é”®è§†è§’åˆ†è¾¨ç‡
   - ä½¿ç”¨ç®€åŒ–çš„ç€è‰²å™¨
   - ç¦ç”¨ä¸å¿…è¦çš„åå¤„ç†</p>
</li>
<li>
<p><strong>ç³»ç»Ÿçº§ä¼˜åŒ–</strong>ï¼š
   - CPU äº²å’Œæ€§ç»‘å®š
   - ç¦ç”¨ä¸å¿…è¦çš„æ—¥å¿—
   - ä½¿ç”¨æ€§èƒ½æ¨¡å¼ç”µæºç®¡ç†</p>
</li>
</ol>
</details>
<p><strong>ç»ƒä¹  17.7ï¼šHIL ç³»ç»Ÿå®æ—¶æ€§ä¿è¯</strong></p>
<p>è®¾è®¡ä¸€ä¸ª HIL æµ‹è¯•ç³»ç»Ÿï¼Œè¦æ±‚æ§åˆ¶å¾ªç¯å»¶è¿Ÿ &lt; 1msï¼ŒæŠ–åŠ¨ &lt; 100Î¼sã€‚ç¡¬ä»¶åŒ…æ‹¬ï¼š</p>
<ul>
<li>EtherCAT ä¼ºæœé©±åŠ¨å™¨</li>
<li>åŠ›çŸ©ä¼ æ„Ÿå™¨</li>
<li>é«˜é€Ÿç›¸æœºï¼ˆ1000 FPSï¼‰</li>
</ul>
<p><em>æç¤ºï¼šè€ƒè™‘å®æ—¶æ“ä½œç³»ç»Ÿã€ä¸­æ–­å¤„ç†ã€å†…å­˜ç®¡ç†</em></p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>å®æ—¶æ€§ä¿è¯æ–¹æ¡ˆï¼š</p>
<ol>
<li>
<p><strong>ç³»ç»Ÿé…ç½®</strong>ï¼š
   - ä½¿ç”¨ PREEMPT_RT å†…æ ¸
   - éš”ç¦» CPU æ ¸å¿ƒä¸“ç”¨äºæ§åˆ¶
   - ç¦ç”¨ CPU é¢‘ç‡è°ƒèŠ‚
   - å…³é—­ä¸å¿…è¦çš„ç³»ç»ŸæœåŠ¡</p>
</li>
<li>
<p><strong>è½¯ä»¶æ¶æ„</strong>ï¼š
   - ä½¿ç”¨ POSIX å®æ—¶è°ƒåº¦ç­–ç•¥
   - é¢„åˆ†é…æ‰€æœ‰å†…å­˜ï¼Œç¦ç”¨swap
   - é›¶æ‹·è´æ•°æ®ä¼ è¾“
   - æ— é”æ•°æ®ç»“æ„é€šä¿¡</p>
</li>
<li>
<p><strong>ç¡¬ä»¶åŒæ­¥</strong>ï¼š
   - IEEE 1588 PTP æ—¶é—´åŒæ­¥
   - EtherCAT åˆ†å¸ƒå¼æ—¶é’Ÿ
   - ç¡¬ä»¶è§¦å‘ç›¸æœºé‡‡é›†
   - DMA ç›´æ¥å†…å­˜è®¿é—®</p>
</li>
<li>
<p><strong>ç›‘æ§ä¸é™çº§</strong>ï¼š
   - å®æ—¶ç›‘æ§å¾ªç¯æ—¶é—´
   - æ£€æµ‹ deadline miss
   - ä¼˜é›…é™çº§æœºåˆ¶
   - ç´§æ€¥åœæ­¢ä¿æŠ¤</p>
</li>
</ol>
</details>
<h2 id="179">17.9 å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<h3 id="1">1. ä»¿çœŸæ—¶é—´ä¸å¢™é’Ÿæ—¶é—´æ··æ·†</h3>
<p><strong>é—®é¢˜</strong>ï¼šä½¿ç”¨ <code>std::chrono::steady_clock</code> è€Œä¸æ˜¯ä»¿çœŸæ—¶é—´å¯¼è‡´å›æ”¾æ—¶è¡Œä¸ºå¼‚å¸¸</p>
<p><strong>è§£å†³</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// é”™è¯¯</span>
<span class="k">auto</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>

<span class="c1">// æ­£ç¡®</span>
<span class="k">auto</span><span class="w"> </span><span class="n">simTime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">world</span><span class="o">-&gt;</span><span class="n">SimTime</span><span class="p">();</span>
</code></pre></div>

<h3 id="2">2. å¿½ç•¥ä¼ æ„Ÿå™¨æ›´æ–°ç‡ä¸ç‰©ç†æ­¥é•¿å…³ç³»</h3>
<p><strong>é—®é¢˜</strong>ï¼šä¼ æ„Ÿå™¨æ›´æ–°ç‡ä¸æ˜¯ç‰©ç†æ­¥é•¿æ•´æ•°å€ï¼Œå¯¼è‡´æ•°æ®ä¸è§„å¾‹</p>
<p><strong>è§£å†³</strong>ï¼š</p>
<ul>
<li>ç¡®ä¿ sensor_update_rate = n * physics_update_rate</li>
<li>ä½¿ç”¨ä¼ æ„Ÿå™¨ç‰¹å®šçš„æ›´æ–°å›è°ƒè€Œéç‰©ç†å›è°ƒ</li>
</ul>
<h3 id="3">3. ç¢°æ’å‡ ä½•ä½“è¿‡äºå¤æ‚</h3>
<p><strong>é—®é¢˜</strong>ï¼šä½¿ç”¨é«˜ç²¾åº¦ç½‘æ ¼ä½œä¸ºç¢°æ’æ¨¡å‹ï¼Œæ€§èƒ½æå·®</p>
<p><strong>è§£å†³</strong>ï¼š</p>
<ul>
<li>è§†è§‰æ¨¡å‹ï¼šé«˜ç²¾åº¦ç½‘æ ¼</li>
<li>ç¢°æ’æ¨¡å‹ï¼šå‡¸åŒ…æˆ–åŸºæœ¬å‡ ä½•ä½“</li>
<li>ä½¿ç”¨ Convex Decomposition å·¥å…·</li>
</ul>
<h3 id="4">4. å†…å­˜æ³„æ¼åœ¨æ’ä»¶ä¸­</h3>
<p><strong>é—®é¢˜</strong>ï¼šæ’ä»¶åŠ¨æ€åˆ†é…å†…å­˜æœªé‡Šæ”¾ï¼Œé•¿æ—¶é—´è¿è¡Œå†…å­˜è€—å°½</p>
<p><strong>è§£å†³</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆç®¡ç†èµ„æº</li>
<li>å®ç°æ­£ç¡®çš„ææ„å‡½æ•°</li>
<li>å®šæœŸæ£€æŸ¥å†…å­˜ä½¿ç”¨</li>
</ul>
<h3 id="5">5. å®æ—¶å› å­ç†è§£é”™è¯¯</h3>
<p><strong>é—®é¢˜</strong>ï¼šæœŸæœ› RTF &gt; 1 è¡¨ç¤ºæ›´å¥½çš„æ€§èƒ½</p>
<p><strong>è§£å†³</strong>ï¼š</p>
<ul>
<li>RTF = 1ï¼šå®æ—¶</li>
<li>RTF &lt; 1ï¼šæ…¢äºå®æ—¶ï¼ˆé€šå¸¸æ˜¯é—®é¢˜ï¼‰</li>
<li>RTF &gt; 1ï¼šå¿«äºå®æ—¶ï¼ˆä¸é€‚åˆ HILï¼‰</li>
</ul>
<h3 id="6">6. å¹¶å‘è®¿é—®å…±äº«æ•°æ®</h3>
<p><strong>é—®é¢˜</strong>ï¼šå¤šä¸ªæ’ä»¶åŒæ—¶è®¿é—® ECM å¯¼è‡´å´©æºƒ</p>
<p><strong>è§£å†³</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨æ­£ç¡®çš„æ›´æ–°é˜¶æ®µ</li>
<li>PreUpdateï¼šä¿®æ”¹å‘½ä»¤</li>
<li>Updateï¼šåªè¯»</li>
<li>PostUpdateï¼šè¯»å–ç»“æœ</li>
</ul>
<h3 id="7-qos">7. å¿½ç•¥ QoS è®¾ç½®</h3>
<p><strong>é—®é¢˜</strong>ï¼šROS2 æ¡¥æ¥ä¸¢å¤±æ¶ˆæ¯æˆ–å»¶è¿Ÿå¤§</p>
<p><strong>è§£å†³</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nt">qos</span><span class="p">:</span>
<span class="w">  </span><span class="nt">reliability</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">reliable</span><span class="w">  </span><span class="c1"># å¯¹äºæ§åˆ¶å‘½ä»¤</span>
<span class="w">  </span><span class="nt">durability</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">transient_local</span><span class="w">  </span><span class="c1"># å¯¹äºé…ç½®</span>
<span class="w">  </span><span class="nt">history</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">keep_last</span>
<span class="w">  </span><span class="nt">depth</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span><span class="w">  </span><span class="c1"># å¯¹äºé«˜é¢‘æ•°æ®</span>
</code></pre></div>

<h2 id="1710">17.10 æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_8">ä»¿çœŸç¯å¢ƒè®¾è®¡</h3>
<ul>
<li>[ ] é™æ€å¯¹è±¡æ­£ç¡®æ ‡è®°ä¸º static</li>
<li>[ ] ç¢°æ’æ¨¡å‹é€‚å½“ç®€åŒ–</li>
<li>[ ] ä½¿ç”¨ LOD ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½</li>
<li>[ ] åˆç†è®¾ç½®ç‰©ç†å¼•æ“æ­¥é•¿</li>
<li>[ ] ä¼ æ„Ÿå™¨æ›´æ–°ç‡ä¸ä»»åŠ¡éœ€æ±‚åŒ¹é…</li>
</ul>
<h3 id="_9">æ’ä»¶å¼€å‘</h3>
<ul>
<li>[ ] å†…å­˜é¢„åˆ†é…é¿å…è¿è¡Œæ—¶åˆ†é…</li>
<li>[ ] ä½¿ç”¨å¯¹è±¡æ± ç®¡ç†é¢‘ç¹åˆ›å»º/é”€æ¯å¯¹è±¡</li>
<li>[ ] å®ç°æ€§èƒ½ç›‘æ§å’Œæ—¥å¿—</li>
<li>[ ] æ­£ç¡®å¤„ç†æ’ä»¶ç”Ÿå‘½å‘¨æœŸ</li>
<li>[ ] é¿å…é˜»å¡æ“ä½œåœ¨æ›´æ–°å¾ªç¯ä¸­</li>
</ul>
<h3 id="_10">ç‰©ç†ä»¿çœŸ</h3>
<ul>
<li>[ ] é€‰æ‹©é€‚åˆä»»åŠ¡çš„ç‰©ç†å¼•æ“</li>
<li>[ ] è°ƒä¼˜æ±‚è§£å™¨å‚æ•°</li>
<li>[ ] è®¾ç½®åˆç†çš„æ¥è§¦å‚æ•°</li>
<li>[ ] éªŒè¯è´¨é‡å’Œæƒ¯æ€§å‚æ•°</li>
<li>[ ] æµ‹è¯•æç«¯æƒ…å†µç¨³å®šæ€§</li>
</ul>
<h3 id="hil">HIL é›†æˆ</h3>
<ul>
<li>[ ] é…ç½®å®æ—¶æ“ä½œç³»ç»Ÿ</li>
<li>[ ] å®ç°ç¡®å®šæ€§è°ƒåº¦</li>
<li>[ ] ç¡¬ä»¶æ—¶é—´åŒæ­¥</li>
<li>[ ] å®‰å…¨ç›‘æ§å’Œç´§æ€¥åœæ­¢</li>
<li>[ ] æ€§èƒ½æŒ‡æ ‡æŒç»­ç›‘æ§</li>
</ul>
<h3 id="_11">æ•°æ®ç”Ÿæˆ</h3>
<ul>
<li>[ ] åŸŸéšæœºåŒ–å‚æ•°è¦†ç›–çœŸå®åˆ†å¸ƒ</li>
<li>[ ] æ ‡æ³¨è´¨é‡è‡ªåŠ¨éªŒè¯</li>
<li>[ ] æ•°æ®æ ¼å¼æ ‡å‡†åŒ–</li>
<li>[ ] å®ç°å¢é‡å¼ç”Ÿæˆé¿å…é‡å¤</li>
<li>[ ] æ•°æ®é›†ç‰ˆæœ¬ç®¡ç†</li>
</ul>
<h3 id="_12">æ€§èƒ½ä¼˜åŒ–</h3>
<ul>
<li>[ ] è¯†åˆ«æ€§èƒ½ç“¶é¢ˆ</li>
<li>[ ] å¹¶è¡ŒåŒ–å¯å¹¶è¡Œéƒ¨åˆ†</li>
<li>[ ] ä½¿ç”¨ GPU åŠ é€Ÿwhené€‚ç”¨</li>
<li>[ ] å®ç°åˆ†çº§ç»†èŠ‚ï¼ˆLODï¼‰</li>
<li>[ ] ç›‘æ§èµ„æºä½¿ç”¨è¶‹åŠ¿</li>
</ul>
<h3 id="_13">è°ƒè¯•ä¸æµ‹è¯•</h3>
<ul>
<li>[ ] å•å…ƒæµ‹è¯•æ ¸å¿ƒç»„ä»¶</li>
<li>[ ] é›†æˆæµ‹è¯•å®Œæ•´ç³»ç»Ÿ</li>
<li>[ ] å‹åŠ›æµ‹è¯•æé™æ€§èƒ½</li>
<li>[ ] å›å½’æµ‹è¯•é˜²æ­¢æ€§èƒ½é€€åŒ–</li>
<li>[ ] å¯è§†åŒ–è°ƒè¯•å·¥å…·é›†æˆ</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter16.html" class="nav-link prev">â† ç¬¬ 16 ç« ï¼šå®‰å…¨æ€§ä¸è¯Šæ–­ç³»ç»Ÿ</a><a href="chapter18.html" class="nav-link next">ç¬¬ 18 ç« ï¼šå¤šæœºå™¨äººç³»ç»Ÿ â†’</a></nav>
        </main>
    </div>
</body>
</html>