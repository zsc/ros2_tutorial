<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬ 19 ç« ï¼šè®¡ç®—æœºè§†è§‰ä¸æ·±åº¦å­¦ä¹ </title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ROS2 å®Œå…¨æ•™ç¨‹ï¼šä»åŸç†åˆ°å®è·µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 1 ç« ï¼šROS1 æ ¸å¿ƒæ¦‚å¿µå›é¡¾</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 2 ç« ï¼šROS1 çš„å±€é™æ€§åˆ†æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 3 ç« ï¼šä» ROS1 åˆ° ROS2 çš„è¿ç§»ç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 4 ç« ï¼šROS2 æ¶æ„ä¸è®¾è®¡ç†å¿µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 5 ç« ï¼šèŠ‚ç‚¹ä¸æ‰§è¡Œå™¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 6 ç« ï¼šé€šä¿¡æœºåˆ¶æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 7 ç« ï¼šLaunch ç³»ç»Ÿä¸é…ç½®ç®¡ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 8 ç« ï¼štf2 åæ ‡å˜æ¢æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 9 ç« ï¼šæ—¶é—´åŒæ­¥ä¸å›æ”¾ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 10 ç« ï¼šä¼ æ„Ÿå™¨æ•°æ®å¤„ç†ç®¡é“</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 11 ç« ï¼šSLAM ä¸å®šä½ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 12 ç« ï¼šå¯¼èˆªæ ˆ Nav2</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 13 ç« ï¼šros2_control æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 14 ç« ï¼šMoveIt2 è¿åŠ¨è§„åˆ’</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 15 ç« ï¼šå®æ—¶ç³»ç»Ÿä¸æ€§èƒ½ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 16 ç« ï¼šå®‰å…¨æ€§ä¸è¯Šæ–­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 17 ç« ï¼šä»¿çœŸé›†æˆï¼ˆGazebo/Ignitionï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 18 ç« ï¼šå¤šæœºå™¨äººç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 19 ç« ï¼šè®¡ç®—æœºè§†è§‰ä¸æ·±åº¦å­¦ä¹ </span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 20 ç« ï¼šæœºå™¨äººå¼ºåŒ–å­¦ä¹ </span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 21 ç« ï¼šå¤§è¯­è¨€æ¨¡å‹ä¸å…·èº«æ™ºèƒ½</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 22 ç« ï¼šç¥ç»ç½‘ç»œè¿åŠ¨æ§åˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="19">ç¬¬ 19 ç« ï¼šè®¡ç®—æœºè§†è§‰ä¸æ·±åº¦å­¦ä¹ </h1>
<h2 id="_1">ç« èŠ‚å¤§çº²</h2>
<ol>
<li><strong>å¼€ç¯‡ä¸å­¦ä¹ ç›®æ ‡</strong></li>
<li><strong>19.1 YOLOv8/v9 ç›®æ ‡æ£€æµ‹é›†æˆ</strong>
   - YOLO æ¶æ„æ¼”è¿›ä¸é€‰å‹
   - ROS2 èŠ‚ç‚¹å°è£…è®¾è®¡
   - å®æ—¶æ¨ç†ä¼˜åŒ–
   - å¤šç›®æ ‡è·Ÿè¸ªé›†æˆ</li>
<li><strong>19.2 è¯­ä¹‰åˆ†å‰²ä¸å®ä¾‹åˆ†å‰²</strong>
   - Segment Anything Model (SAM) é›†æˆ
   - DeepLabV3+ å®æ—¶è¯­ä¹‰åˆ†å‰²
   - Mask R-CNN å®ä¾‹åˆ†å‰²
   - åˆ†å‰²ç»“æœçš„ 3D æŠ•å½±</li>
<li><strong>19.3 3D ç‚¹äº‘æ·±åº¦å­¦ä¹ </strong>
   - PointNet++ æ¶æ„ä¸å®ç°
   - VoxelNet ä½“ç´ åŒ–å¤„ç†
   - PointPillars å¿«é€Ÿæ£€æµ‹
   - ç‚¹äº‘-å›¾åƒèåˆç½‘ç»œ</li>
<li><strong>19.4 TensorRT åŠ é€Ÿä¸è¾¹ç¼˜éƒ¨ç½²</strong>
   - æ¨¡å‹é‡åŒ–ä¸ä¼˜åŒ–
   - INT8 æ ¡å‡†æµç¨‹
   - åŠ¨æ€æ‰¹å¤„ç†ç­–ç•¥
   - Jetson å¹³å°éƒ¨ç½²</li>
<li><strong>äº§ä¸šæ¡ˆä¾‹ç ”ç©¶ï¼šTesla FSD è§†è§‰æ„ŸçŸ¥ç³»ç»Ÿ</strong></li>
<li><strong>é«˜çº§è¯é¢˜ï¼šBEV æ„ŸçŸ¥ä¸ Transformer æ¶æ„</strong></li>
<li><strong>æœ¬ç« å°ç»“</strong></li>
<li><strong>ç»ƒä¹ é¢˜</strong></li>
<li><strong>å¸¸è§é™·é˜±ä¸é”™è¯¯</strong></li>
<li><strong>æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</strong></li>
</ol>
<hr />
<h2 id="_2">å¼€ç¯‡</h2>
<p>åœ¨ç°ä»£æœºå™¨äººç³»ç»Ÿä¸­ï¼Œè§†è§‰æ„ŸçŸ¥æ˜¯å®ç°è‡ªä¸»å¯¼èˆªã€ç‰©ä½“æ“ä½œå’Œåœºæ™¯ç†è§£çš„å…³é”®èƒ½åŠ›ã€‚æœ¬ç« å°†æ·±å…¥æ¢è®¨å¦‚ä½•åœ¨ ROS2 ä¸­é›†æˆæœ€å…ˆè¿›çš„è®¡ç®—æœºè§†è§‰å’Œæ·±åº¦å­¦ä¹ æ¨¡å‹ï¼Œä»ä¼ ç»Ÿçš„ 2D ç›®æ ‡æ£€æµ‹åˆ°å¤æ‚çš„ 3D åœºæ™¯ç†è§£ï¼Œå†åˆ°è¾¹ç¼˜è®¡ç®—ä¼˜åŒ–ã€‚æˆ‘ä»¬å°†ç‰¹åˆ«å…³æ³¨å·¥ç¨‹å®è·µä¸­çš„æ€§èƒ½ä¼˜åŒ–ã€å®æ—¶æ€§ä¿è¯å’Œç³»ç»Ÿé›†æˆæŒ‘æˆ˜ã€‚</p>
<h2 id="_3">å­¦ä¹ ç›®æ ‡</h2>
<p>å®Œæˆæœ¬ç« å­¦ä¹ åï¼Œæ‚¨å°†èƒ½å¤Ÿï¼š</p>
<ul>
<li>åœ¨ ROS2 ä¸­é›†æˆå’Œä¼˜åŒ– YOLO ç³»åˆ—æ£€æµ‹å™¨ï¼Œå®ç°å®æ—¶ç›®æ ‡æ£€æµ‹</li>
<li>éƒ¨ç½²è¯­ä¹‰åˆ†å‰²å’Œå®ä¾‹åˆ†å‰²æ¨¡å‹ï¼Œå¹¶å°†ç»“æœæŠ•å½±åˆ° 3D ç©ºé—´</li>
<li>ä½¿ç”¨æ·±åº¦å­¦ä¹ å¤„ç†ç‚¹äº‘æ•°æ®ï¼Œå®ç° 3D ç›®æ ‡æ£€æµ‹å’Œåœºæ™¯ç†è§£</li>
<li>æŒæ¡ TensorRT ä¼˜åŒ–æµç¨‹ï¼Œåœ¨è¾¹ç¼˜è®¾å¤‡ä¸Šéƒ¨ç½²é«˜æ€§èƒ½æ¨ç†</li>
<li>ç†è§£ Tesla FSD ç­‰å…ˆè¿›ç³»ç»Ÿçš„æ¶æ„è®¾è®¡å’Œå·¥ç¨‹æƒè¡¡</li>
<li>å®ç° BEVï¼ˆé¸Ÿç°å›¾ï¼‰æ„ŸçŸ¥å’Œ Transformer åŸºç¡€çš„è§†è§‰æ¨¡å‹</li>
</ul>
<h2 id="191-yolov8v9">19.1 YOLOv8/v9 ç›®æ ‡æ£€æµ‹é›†æˆ</h2>
<h3 id="1911-yolo">19.1.1 YOLO æ¶æ„æ¼”è¿›ä¸é€‰å‹</h3>
<p>YOLOï¼ˆYou Only Look Onceï¼‰ç³»åˆ—æ˜¯æœºå™¨äººè§†è§‰ç³»ç»Ÿä¸­æœ€å¸¸ç”¨çš„ç›®æ ‡æ£€æµ‹æ¡†æ¶ã€‚ä» YOLOv1 åˆ°æœ€æ–°çš„ YOLOv9ï¼Œæ¯ä»£éƒ½å¸¦æ¥äº†æ˜¾è‘—çš„æ€§èƒ½æå‡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">YOLOv8</span><span class="w"> </span><span class="err">æ¶æ„ç‰¹ç‚¹ï¼š</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">          </span><span class="n">Backbone</span><span class="w"> </span><span class="p">(</span><span class="n">CSPDarknet</span><span class="p">)</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="n">Conv</span><span class="w"> </span><span class="err">â”‚â†’</span><span class="w"> </span><span class="err">â”‚</span><span class="w"> </span><span class="n">C2f</span><span class="w"> </span><span class="err">â”‚â†’</span><span class="w"> </span><span class="err">â”‚</span><span class="n">SPPF</span><span class="w"> </span><span class="err">â”‚</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”˜</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”˜</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”˜</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                </span><span class="err">â†“</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">           </span><span class="n">Neck</span><span class="w"> </span><span class="p">(</span><span class="n">PAN</span><span class="o">-</span><span class="n">FPN</span><span class="p">)</span><span class="w">            </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Multi</span><span class="o">-</span><span class="n">scale</span><span class="w"> </span><span class="n">Feature</span><span class="w">    </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">     </span><span class="n">Aggregation</span><span class="w">          </span><span class="err">â”‚</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                </span><span class="err">â†“</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">          </span><span class="n">Head</span><span class="w"> </span><span class="p">(</span><span class="n">Decoupled</span><span class="p">)</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Cls</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">Reg</span><span class="w">  </span><span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w"> </span><span class="n">DFL</span><span class="w">  </span><span class="err">â”‚</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”˜</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<p>å…³é”®æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”ï¼š</p>
<ul>
<li><strong>YOLOv8n</strong>: 3.2M å‚æ•°ï¼Œ640Ã—640 è¾“å…¥ï¼Œ~100 FPS (RTX 3090)</li>
<li><strong>YOLOv8s</strong>: 11.2M å‚æ•°ï¼Œ640Ã—640 è¾“å…¥ï¼Œ~80 FPS</li>
<li><strong>YOLOv8m</strong>: 25.9M å‚æ•°ï¼Œ640Ã—640 è¾“å…¥ï¼Œ~50 FPS</li>
<li><strong>YOLOv9c</strong>: 25.3M å‚æ•°ï¼Œ640Ã—640 è¾“å…¥ï¼Œ~60 FPSï¼ˆå¼•å…¥ PGI å’Œ GELANï¼‰</li>
</ul>
<h3 id="1912-ros2">19.1.2 ROS2 èŠ‚ç‚¹å°è£…è®¾è®¡</h3>
<p>è®¾è®¡é«˜æ•ˆçš„ YOLO ROS2 èŠ‚ç‚¹éœ€è¦è€ƒè™‘ä»¥ä¸‹æ¶æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># yolo_detector_node.py</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">rclpy</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">rclpy.node</span><span class="w"> </span><span class="kn">import</span> <span class="n">Node</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sensor_msgs.msg</span><span class="w"> </span><span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">CompressedImage</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">vision_msgs.msg</span><span class="w"> </span><span class="kn">import</span> <span class="n">Detection2DArray</span><span class="p">,</span> <span class="n">Detection2D</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">cv_bridge</span><span class="w"> </span><span class="kn">import</span> <span class="n">CvBridge</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ultralytics</span><span class="w"> </span><span class="kn">import</span> <span class="n">YOLO</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="k">class</span><span class="w"> </span><span class="nc">YOLODetectorNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;yolo_detector&#39;</span><span class="p">)</span>

        <span class="c1"># å‚æ•°å£°æ˜</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s1">&#39;model_path&#39;</span><span class="p">,</span> <span class="s1">&#39;yolov8n.pt&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s1">&#39;confidence_threshold&#39;</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s1">&#39;nms_threshold&#39;</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s1">&#39;device&#39;</span><span class="p">,</span> <span class="s1">&#39;cuda:0&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s1">&#39;input_size&#39;</span><span class="p">,</span> <span class="p">[</span><span class="mi">640</span><span class="p">,</span> <span class="mi">640</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">declare_parameter</span><span class="p">(</span><span class="s1">&#39;enable_tracking&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># åˆå§‹åŒ–æ¨¡å‹</span>
        <span class="n">model_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="s1">&#39;model_path&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="n">device</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="s1">&#39;device&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">YOLO</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>

        <span class="c1"># é¢„çƒ­æ¨¡å‹ï¼ˆé‡è¦çš„å»¶è¿Ÿä¼˜åŒ–ï¼‰</span>
        <span class="n">dummy_input</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">640</span><span class="p">))</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">dummy_input</span><span class="p">)</span>

        <span class="c1"># å‘å¸ƒå™¨å’Œè®¢é˜…å™¨</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detection_pub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span>
            <span class="n">Detection2DArray</span><span class="p">,</span> <span class="s1">&#39;detections&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">viz_pub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span>
            <span class="n">Image</span><span class="p">,</span> <span class="s1">&#39;detection_viz&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">image_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
            <span class="n">Image</span><span class="p">,</span> <span class="s1">&#39;image_raw&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_callback</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">bridge</span> <span class="o">=</span> <span class="n">CvBridge</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">image_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c1"># æ€§èƒ½è®¡æ—¶</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_clock</span><span class="p">()</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>

        <span class="c1"># å›¾åƒé¢„å¤„ç†</span>
        <span class="n">cv_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">imgmsg_to_cv2</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s1">&#39;bgr8&#39;</span><span class="p">)</span>

        <span class="c1"># YOLO æ¨ç†</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">cv_image</span><span class="p">,</span> 
                            <span class="n">conf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="s1">&#39;confidence_threshold&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">,</span>
                            <span class="n">iou</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_parameter</span><span class="p">(</span><span class="s1">&#39;nms_threshold&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

        <span class="c1"># è½¬æ¢ä¸º ROS2 æ¶ˆæ¯</span>
        <span class="n">detection_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_detection_array</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">msg</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detection_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">detection_array</span><span class="p">)</span>

        <span class="c1"># å‘å¸ƒå¯è§†åŒ–ï¼ˆå¯é€‰ï¼‰</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">viz_pub</span><span class="o">.</span><span class="n">get_subscription_count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">viz_image</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
            <span class="n">viz_msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">cv2_to_imgmsg</span><span class="p">(</span><span class="n">viz_image</span><span class="p">,</span> <span class="s1">&#39;bgr8&#39;</span><span class="p">)</span>
            <span class="n">viz_msg</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">header</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">viz_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">viz_msg</span><span class="p">)</span>

        <span class="c1"># æ€§èƒ½æ—¥å¿—</span>
        <span class="n">inference_time</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_clock</span><span class="p">()</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span><span class="o">.</span><span class="n">nanoseconds</span> <span class="o">/</span> <span class="mf">1e6</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Inference time: </span><span class="si">{</span><span class="n">inference_time</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">ms&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="1913">19.1.3 å®æ—¶æ¨ç†ä¼˜åŒ–</h3>
<p>ä¸ºå®ç°å®æ—¶æ€§èƒ½ï¼Œéœ€è¦å¤šå±‚æ¬¡ä¼˜åŒ–ï¼š</p>
<ol>
<li><strong>æ‰¹å¤„ç†ç­–ç•¥</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BatchedYOLONode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;batched_yolo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_buffer</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_buffer</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># æ‰¹å¤„ç†å®šæ—¶å™¨</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="mf">0.033</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_batch</span><span class="p">)</span>  <span class="c1"># 30 FPS</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">image_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_buffer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_batch</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_buffer</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># æ‰¹é‡æ¨ç†</span>
        <span class="n">batch_images</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">imgmsg_to_cv2</span><span class="p">(</span><span class="n">img</span><span class="p">)</span> <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_buffer</span><span class="p">]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">batch_images</span><span class="p">)</span>

        <span class="c1"># å‘å¸ƒç»“æœ</span>
        <span class="k">for</span> <span class="n">result</span><span class="p">,</span> <span class="n">header</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">header_buffer</span><span class="p">):</span>
            <span class="n">detection_array</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_detection_array</span><span class="p">(</span><span class="n">result</span><span class="p">,</span> <span class="n">header</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">detection_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">detection_array</span><span class="p">)</span>

        <span class="c1"># æ¸…ç©ºç¼“å†²åŒº</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_buffer</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_buffer</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div>

<ol start="2">
<li><strong>å¼‚æ­¥æ¨ç†ç®¡é“</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">threading</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">queue</span><span class="w"> </span><span class="kn">import</span> <span class="n">Queue</span>

<span class="k">class</span><span class="w"> </span><span class="nc">AsyncYOLONode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;async_yolo&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">input_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_queue</span> <span class="o">=</span> <span class="n">Queue</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># æ¨ç†çº¿ç¨‹</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inference_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span><span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">inference_worker</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inference_thread</span><span class="o">.</span><span class="n">daemon</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inference_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># å‘å¸ƒçº¿ç¨‹</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publish_timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">publish_results</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">inference_worker</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">rclpy</span><span class="o">.</span><span class="n">ok</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_queue</span><span class="o">.</span><span class="n">empty</span><span class="p">():</span>
                <span class="n">image</span><span class="p">,</span> <span class="n">header</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">input_queue</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>
                <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">output_queue</span><span class="o">.</span><span class="n">put</span><span class="p">((</span><span class="n">result</span><span class="p">,</span> <span class="n">header</span><span class="p">))</span>
</code></pre></div>

<h3 id="1914">19.1.4 å¤šç›®æ ‡è·Ÿè¸ªé›†æˆ</h3>
<p>é›†æˆ DeepSORT æˆ– ByteTrack å®ç°ç¨³å®šè·Ÿè¸ªï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">deep_sort_realtime.deepsort_tracker</span><span class="w"> </span><span class="kn">import</span> <span class="n">DeepSort</span>

<span class="k">class</span><span class="w"> </span><span class="nc">YOLOTrackerNode</span><span class="p">(</span><span class="n">YOLODetectorNode</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tracker</span> <span class="o">=</span> <span class="n">DeepSort</span><span class="p">(</span><span class="n">max_age</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">n_init</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_detections</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detections</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="c1"># å‡†å¤‡ DeepSORT è¾“å…¥</span>
        <span class="n">bbs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">det</span> <span class="ow">in</span> <span class="n">detections</span><span class="p">:</span>
            <span class="n">bbox</span> <span class="o">=</span> <span class="p">[</span><span class="n">det</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">det</span><span class="o">.</span><span class="n">y</span><span class="p">,</span> <span class="n">det</span><span class="o">.</span><span class="n">width</span><span class="p">,</span> <span class="n">det</span><span class="o">.</span><span class="n">height</span><span class="p">]</span>
            <span class="n">confidence</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">confidence</span>
            <span class="n">class_id</span> <span class="o">=</span> <span class="n">det</span><span class="o">.</span><span class="n">class_id</span>
            <span class="n">bbs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">bbox</span><span class="p">,</span> <span class="n">confidence</span><span class="p">,</span> <span class="n">class_id</span><span class="p">))</span>

        <span class="c1"># æ›´æ–°è·Ÿè¸ªå™¨</span>
        <span class="n">tracks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tracker</span><span class="o">.</span><span class="n">update_tracks</span><span class="p">(</span><span class="n">bbs</span><span class="p">,</span> <span class="n">frame</span><span class="o">=</span><span class="n">image</span><span class="p">)</span>

        <span class="c1"># å‘å¸ƒè·Ÿè¸ªç»“æœ</span>
        <span class="n">tracked_detections</span> <span class="o">=</span> <span class="n">Detection2DArray</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">track</span> <span class="ow">in</span> <span class="n">tracks</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">track</span><span class="o">.</span><span class="n">is_confirmed</span><span class="p">():</span>
                <span class="k">continue</span>

            <span class="n">detection</span> <span class="o">=</span> <span class="n">Detection2D</span><span class="p">()</span>
            <span class="n">detection</span><span class="o">.</span><span class="n">id</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">track</span><span class="o">.</span><span class="n">track_id</span><span class="p">)</span>
            <span class="n">detection</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="n">track</span><span class="o">.</span><span class="n">to_ltrb</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">track</span><span class="o">.</span><span class="n">to_ltrb</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">detection</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">center</span><span class="o">.</span><span class="n">position</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="n">track</span><span class="o">.</span><span class="n">to_ltrb</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">track</span><span class="o">.</span><span class="n">to_ltrb</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span> <span class="o">/</span> <span class="mi">2</span>
            <span class="n">detection</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">size_x</span> <span class="o">=</span> <span class="n">track</span><span class="o">.</span><span class="n">to_ltrb</span><span class="p">()[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">track</span><span class="o">.</span><span class="n">to_ltrb</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">detection</span><span class="o">.</span><span class="n">bbox</span><span class="o">.</span><span class="n">size_y</span> <span class="o">=</span> <span class="n">track</span><span class="o">.</span><span class="n">to_ltrb</span><span class="p">()[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">track</span><span class="o">.</span><span class="n">to_ltrb</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">tracked_detections</span><span class="o">.</span><span class="n">detections</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">detection</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">tracked_detections</span>
</code></pre></div>

<h2 id="192">19.2 è¯­ä¹‰åˆ†å‰²ä¸å®ä¾‹åˆ†å‰²</h2>
<h3 id="1921-segment-anything-model-sam">19.2.1 Segment Anything Model (SAM) é›†æˆ</h3>
<p>SAM æä¾›äº†å¼ºå¤§çš„é›¶æ ·æœ¬åˆ†å‰²èƒ½åŠ›ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">segment_anything</span><span class="w"> </span><span class="kn">import</span> <span class="n">sam_model_registry</span><span class="p">,</span> <span class="n">SamAutomaticMaskGenerator</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SAMSegmentationNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;sam_segmentation&#39;</span><span class="p">)</span>

        <span class="c1"># åŠ è½½ SAM æ¨¡å‹</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sam</span> <span class="o">=</span> <span class="n">sam_model_registry</span><span class="p">[</span><span class="s2">&quot;vit_h&quot;</span><span class="p">](</span><span class="n">checkpoint</span><span class="o">=</span><span class="s2">&quot;sam_vit_h.pth&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sam</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s1">&#39;cuda&#39;</span><span class="p">)</span>

        <span class="c1"># è‡ªåŠ¨æ©ç ç”Ÿæˆå™¨</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_generator</span> <span class="o">=</span> <span class="n">SamAutomaticMaskGenerator</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sam</span><span class="p">,</span>
            <span class="n">points_per_side</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
            <span class="n">pred_iou_thresh</span><span class="o">=</span><span class="mf">0.86</span><span class="p">,</span>
            <span class="n">stability_score_thresh</span><span class="o">=</span><span class="mf">0.92</span><span class="p">,</span>
            <span class="n">min_mask_region_area</span><span class="o">=</span><span class="mi">100</span>
        <span class="p">)</span>

        <span class="c1"># ROS2 æ¥å£</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mask_pub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span>
            <span class="n">Image</span><span class="p">,</span> <span class="s1">&#39;segmentation_masks&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">segment_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="c1"># ç”Ÿæˆæ©ç </span>
        <span class="n">masks</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask_generator</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="c1"># æ’åºï¼ˆæŒ‰é¢ç§¯ï¼‰</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">masks</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;area&#39;</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># åˆ›å»ºå¯è§†åŒ–</span>
        <span class="n">mask_image</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">mask</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">masks</span><span class="p">):</span>
            <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_color</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
            <span class="n">mask_image</span><span class="p">[</span><span class="n">mask</span><span class="p">[</span><span class="s1">&#39;segmentation&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">color</span>

        <span class="k">return</span> <span class="n">mask_image</span><span class="p">,</span> <span class="n">masks</span>
</code></pre></div>

<h3 id="1922-deeplabv3">19.2.2 DeepLabV3+ å®æ—¶è¯­ä¹‰åˆ†å‰²</h3>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">torchvision.models.segmentation</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">segmentation</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DeepLabNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;deeplab_segmentation&#39;</span><span class="p">)</span>

        <span class="c1"># åŠ è½½é¢„è®­ç»ƒæ¨¡å‹</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">segmentation</span><span class="o">.</span><span class="n">deeplabv3_resnet101</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>

        <span class="c1"># ç±»åˆ«æ˜ å°„ï¼ˆCityscapesï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;road&#39;</span><span class="p">,</span> <span class="s1">&#39;sidewalk&#39;</span><span class="p">,</span> <span class="s1">&#39;building&#39;</span><span class="p">,</span> <span class="s1">&#39;wall&#39;</span><span class="p">,</span> 
                           <span class="s1">&#39;fence&#39;</span><span class="p">,</span> <span class="s1">&#39;pole&#39;</span><span class="p">,</span> <span class="s1">&#39;traffic_light&#39;</span><span class="p">,</span> <span class="s1">&#39;traffic_sign&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;vegetation&#39;</span><span class="p">,</span> <span class="s1">&#39;terrain&#39;</span><span class="p">,</span> <span class="s1">&#39;sky&#39;</span><span class="p">,</span> <span class="s1">&#39;person&#39;</span><span class="p">,</span> 
                           <span class="s1">&#39;rider&#39;</span><span class="p">,</span> <span class="s1">&#39;car&#39;</span><span class="p">,</span> <span class="s1">&#39;truck&#39;</span><span class="p">,</span> <span class="s1">&#39;bus&#39;</span><span class="p">,</span> <span class="s1">&#39;train&#39;</span><span class="p">,</span> 
                           <span class="s1">&#39;motorcycle&#39;</span><span class="p">,</span> <span class="s1">&#39;bicycle&#39;</span><span class="p">]</span>

    <span class="nd">@torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">()</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">segment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="c1"># é¢„å¤„ç†</span>
        <span class="n">input_tensor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="c1"># æ¨ç†</span>
        <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">input_tensor</span><span class="p">)[</span><span class="s1">&#39;out&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">output_predictions</span> <span class="o">=</span> <span class="n">output</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1"># åå¤„ç†</span>
        <span class="n">segmentation_map</span> <span class="o">=</span> <span class="n">output_predictions</span><span class="o">.</span><span class="n">byte</span><span class="p">()</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">segmentation_map</span>
</code></pre></div>

<h3 id="1923-mask-r-cnn">19.2.3 Mask R-CNN å®ä¾‹åˆ†å‰²</h3>
<p>å®ä¾‹åˆ†å‰²æä¾›åƒç´ çº§çš„ç›®æ ‡åˆ†å‰²ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">detectron2</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">detectron2.engine</span><span class="w"> </span><span class="kn">import</span> <span class="n">DefaultPredictor</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">detectron2.config</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_cfg</span>

<span class="k">class</span><span class="w"> </span><span class="nc">MaskRCNNNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;mask_rcnn&#39;</span><span class="p">)</span>

        <span class="c1"># é…ç½® Detectron2</span>
        <span class="n">cfg</span> <span class="o">=</span> <span class="n">get_cfg</span><span class="p">()</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">merge_from_file</span><span class="p">(</span><span class="s2">&quot;COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x.yaml&quot;</span><span class="p">)</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">ROI_HEADS</span><span class="o">.</span><span class="n">SCORE_THRESH_TEST</span> <span class="o">=</span> <span class="mf">0.5</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">WEIGHTS</span> <span class="o">=</span> <span class="s2">&quot;detectron2://COCO-InstanceSegmentation/mask_rcnn_R_50_FPN_3x/137849600/model_final_f10217.pkl&quot;</span>
        <span class="n">cfg</span><span class="o">.</span><span class="n">MODEL</span><span class="o">.</span><span class="n">DEVICE</span> <span class="o">=</span> <span class="s2">&quot;cuda&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="n">DefaultPredictor</span><span class="p">(</span><span class="n">cfg</span><span class="p">)</span>

        <span class="c1"># å‘å¸ƒå™¨</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instance_pub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span>
            <span class="n">InstanceSegmentation</span><span class="p">,</span> <span class="s1">&#39;instance_masks&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="n">outputs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="c1"># æå–å®ä¾‹</span>
        <span class="n">instances</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;instances&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="s2">&quot;cpu&quot;</span><span class="p">)</span>
        <span class="n">boxes</span> <span class="o">=</span> <span class="n">instances</span><span class="o">.</span><span class="n">pred_boxes</span><span class="o">.</span><span class="n">tensor</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">scores</span> <span class="o">=</span> <span class="n">instances</span><span class="o">.</span><span class="n">scores</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">classes</span> <span class="o">=</span> <span class="n">instances</span><span class="o">.</span><span class="n">pred_classes</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
        <span class="n">masks</span> <span class="o">=</span> <span class="n">instances</span><span class="o">.</span><span class="n">pred_masks</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>

        <span class="c1"># åˆ›å»º ROS æ¶ˆæ¯</span>
        <span class="n">instance_msg</span> <span class="o">=</span> <span class="n">InstanceSegmentation</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">instances</span><span class="p">)):</span>
            <span class="n">instance</span> <span class="o">=</span> <span class="n">Instance</span><span class="p">()</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">class_id</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">classes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">scores</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_bbox</span><span class="p">(</span><span class="n">boxes</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">instance</span><span class="o">.</span><span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_mask</span><span class="p">(</span><span class="n">masks</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
            <span class="n">instance_msg</span><span class="o">.</span><span class="n">instances</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">instance</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">instance_msg</span>
</code></pre></div>

<h3 id="1924-3d">19.2.4 åˆ†å‰²ç»“æœçš„ 3D æŠ•å½±</h3>
<p>å°† 2D åˆ†å‰²ç»“æœæŠ•å½±åˆ° 3D ç©ºé—´ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">open3d</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">o3d</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">sensor_msgs.msg</span><span class="w"> </span><span class="kn">import</span> <span class="n">PointCloud2</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">sensor_msgs.point_cloud2</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pc2</span>

<span class="k">class</span><span class="w"> </span><span class="nc">Segmentation3DProjector</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;segmentation_3d_projector&#39;</span><span class="p">)</span>

        <span class="c1"># ç›¸æœºå†…å‚</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">K</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">fx</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cx</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">fy</span><span class="p">,</span> <span class="n">cy</span><span class="p">],</span>
                          <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span>

        <span class="c1"># åŒæ­¥è®¢é˜…</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seg_sub</span> <span class="o">=</span> <span class="n">message_filters</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="s1">&#39;segmentation&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">depth_sub</span> <span class="o">=</span> <span class="n">message_filters</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="s1">&#39;depth&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sync</span> <span class="o">=</span> <span class="n">message_filters</span><span class="o">.</span><span class="n">ApproximateTimeSynchronizer</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">seg_sub</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">depth_sub</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync</span><span class="o">.</span><span class="n">registerCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sync_callback</span><span class="p">)</span>

        <span class="c1"># ç‚¹äº‘å‘å¸ƒå™¨</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pc_pub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span><span class="n">PointCloud2</span><span class="p">,</span> <span class="s1">&#39;segmented_pointcloud&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">sync_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seg_msg</span><span class="p">,</span> <span class="n">depth_msg</span><span class="p">):</span>
        <span class="c1"># è½¬æ¢æ¶ˆæ¯</span>
        <span class="n">seg_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">imgmsg_to_cv2</span><span class="p">(</span><span class="n">seg_msg</span><span class="p">)</span>
        <span class="n">depth_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">imgmsg_to_cv2</span><span class="p">(</span><span class="n">depth_msg</span><span class="p">)</span>

        <span class="c1"># ç”Ÿæˆ 3D ç‚¹äº‘</span>
        <span class="n">points</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">depth_map</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">z</span> <span class="o">=</span> <span class="n">depth_map</span><span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">u</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1000.0</span>  <span class="c1"># mm to m</span>
                <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="c1"># åæŠ•å½±åˆ° 3D</span>
                <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">z</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
                <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="n">z</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">K</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>

                <span class="n">points</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">])</span>
                <span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">seg_map</span><span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">u</span><span class="p">])</span>
                <span class="n">colors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">label_to_color</span><span class="p">(</span><span class="n">seg_map</span><span class="p">[</span><span class="n">v</span><span class="p">,</span> <span class="n">u</span><span class="p">]))</span>

        <span class="c1"># åˆ›å»ºç‚¹äº‘æ¶ˆæ¯</span>
        <span class="n">header</span> <span class="o">=</span> <span class="n">seg_msg</span><span class="o">.</span><span class="n">header</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">pc2</span><span class="o">.</span><span class="n">PointField</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pc2</span><span class="o">.</span><span class="n">PointField</span><span class="o">.</span><span class="n">FLOAT32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">pc2</span><span class="o">.</span><span class="n">PointField</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">pc2</span><span class="o">.</span><span class="n">PointField</span><span class="o">.</span><span class="n">FLOAT32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">pc2</span><span class="o">.</span><span class="n">PointField</span><span class="p">(</span><span class="s1">&#39;z&#39;</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">pc2</span><span class="o">.</span><span class="n">PointField</span><span class="o">.</span><span class="n">FLOAT32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">pc2</span><span class="o">.</span><span class="n">PointField</span><span class="p">(</span><span class="s1">&#39;rgb&#39;</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="n">pc2</span><span class="o">.</span><span class="n">PointField</span><span class="o">.</span><span class="n">UINT32</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">pc2</span><span class="o">.</span><span class="n">PointField</span><span class="p">(</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">pc2</span><span class="o">.</span><span class="n">PointField</span><span class="o">.</span><span class="n">UINT32</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="n">cloud_msg</span> <span class="o">=</span> <span class="n">pc2</span><span class="o">.</span><span class="n">create_cloud</span><span class="p">(</span><span class="n">header</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> 
                                     <span class="bp">self</span><span class="o">.</span><span class="n">pack_points</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">colors</span><span class="p">,</span> <span class="n">labels</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pc_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">cloud_msg</span><span class="p">)</span>
</code></pre></div>

<h2 id="193-3d">19.3 3D ç‚¹äº‘æ·±åº¦å­¦ä¹ </h2>
<h3 id="1931-pointnet">19.3.1 PointNet++ æ¶æ„ä¸å®ç°</h3>
<p>PointNet++ æ˜¯å¤„ç†ç‚¹äº‘çš„ç»å…¸æ¶æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">torch</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">torch.nn</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nn</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">pointnet2_ops</span><span class="w"> </span><span class="kn">import</span> <span class="n">pointnet2_utils</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PointNet2MSG</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Multi-Scale Grouping PointNet++&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">40</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Set Abstraction layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sa1</span> <span class="o">=</span> <span class="n">PointNetSetAbstractionMSG</span><span class="p">(</span>
            <span class="n">npoint</span><span class="o">=</span><span class="mi">512</span><span class="p">,</span> 
            <span class="n">radii</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
            <span class="n">nsamples</span><span class="o">=</span><span class="p">[</span><span class="mi">16</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span>
            <span class="n">in_channel</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">mlp_list</span><span class="o">=</span><span class="p">[[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">128</span><span class="p">]]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sa2</span> <span class="o">=</span> <span class="n">PointNetSetAbstractionMSG</span><span class="p">(</span>
            <span class="n">npoint</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
            <span class="n">radii</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">],</span>
            <span class="n">nsamples</span><span class="o">=</span><span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span>
            <span class="n">in_channel</span><span class="o">=</span><span class="mi">320</span><span class="p">,</span>
            <span class="n">mlp_list</span><span class="o">=</span><span class="p">[[</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">],</span> <span class="p">[</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">]]</span>
        <span class="p">)</span>

        <span class="c1"># Feature Propagation layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fp2</span> <span class="o">=</span> <span class="n">PointNetFeaturePropagation</span><span class="p">(</span><span class="n">in_channel</span><span class="o">=</span><span class="mi">640</span><span class="p">,</span> <span class="n">mlp</span><span class="o">=</span><span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">256</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fp1</span> <span class="o">=</span> <span class="n">PointNetFeaturePropagation</span><span class="p">(</span><span class="n">in_channel</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">mlp</span><span class="o">=</span><span class="p">[</span><span class="mi">256</span><span class="p">,</span> <span class="mi">128</span><span class="p">])</span>

        <span class="c1"># Classifier</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm1d</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv1d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xyz</span><span class="p">):</span>
        <span class="c1"># Set abstraction</span>
        <span class="n">l1_xyz</span><span class="p">,</span> <span class="n">l1_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sa1</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">l2_xyz</span><span class="p">,</span> <span class="n">l2_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sa2</span><span class="p">(</span><span class="n">l1_xyz</span><span class="p">,</span> <span class="n">l1_points</span><span class="p">)</span>

        <span class="c1"># Feature propagation</span>
        <span class="n">l1_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp2</span><span class="p">(</span><span class="n">l1_xyz</span><span class="p">,</span> <span class="n">l2_xyz</span><span class="p">,</span> <span class="n">l1_points</span><span class="p">,</span> <span class="n">l2_points</span><span class="p">)</span>
        <span class="n">l0_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fp1</span><span class="p">(</span><span class="n">xyz</span><span class="p">,</span> <span class="n">l1_xyz</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">l1_points</span><span class="p">)</span>

        <span class="c1"># Classification</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classifier</span><span class="p">(</span><span class="n">l0_points</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">x</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PointNet2Node</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;pointnet2_node&#39;</span><span class="p">)</span>

        <span class="c1"># åŠ è½½æ¨¡å‹</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">PointNet2MSG</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;pointnet2_model.pth&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>

        <span class="c1"># ROS2 æ¥å£</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pc_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
            <span class="n">PointCloud2</span><span class="p">,</span> <span class="s1">&#39;points_raw&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointcloud_callback</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detection_pub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span>
            <span class="n">Detection3DArray</span><span class="p">,</span> <span class="s1">&#39;detections_3d&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">pointcloud_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="c1"># è½¬æ¢ç‚¹äº‘</span>
        <span class="n">points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointcloud2_to_tensor</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="c1"># æ¨ç†</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">predictions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

        <span class="c1"># å‘å¸ƒç»“æœ</span>
        <span class="n">detections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_3d_detections</span><span class="p">(</span><span class="n">predictions</span><span class="p">,</span> <span class="n">points</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detection_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">detections</span><span class="p">)</span>
</code></pre></div>

<h3 id="1932-voxelnet">19.3.2 VoxelNet ä½“ç´ åŒ–å¤„ç†</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">VoxelNet</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">voxel_size</span><span class="o">=</span><span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span> 
                 <span class="n">point_cloud_range</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">40</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mf">70.4</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">1</span><span class="p">]):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">voxel_size</span> <span class="o">=</span> <span class="n">voxel_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">point_cloud_range</span> <span class="o">=</span> <span class="n">point_cloud_range</span>

        <span class="c1"># Voxel Feature Encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vfe</span> <span class="o">=</span> <span class="n">VoxelFeatureExtractor</span><span class="p">(</span>
            <span class="n">num_filters</span><span class="o">=</span><span class="p">[</span><span class="mi">32</span><span class="p">,</span> <span class="mi">128</span><span class="p">],</span>
            <span class="n">with_distance</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">voxel_size</span><span class="o">=</span><span class="n">voxel_size</span>
        <span class="p">)</span>

        <span class="c1"># Middle Convolutional layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">middle_conv</span> <span class="o">=</span> <span class="n">MiddleConv</span><span class="p">(</span>
            <span class="n">in_channels</span><span class="o">=</span><span class="mi">128</span><span class="p">,</span>
            <span class="n">out_channels</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
            <span class="n">layer_nums</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
            <span class="n">layer_strides</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
            <span class="n">filter_sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># Region Proposal Network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rpn</span> <span class="o">=</span> <span class="n">RPN</span><span class="p">(</span>
            <span class="n">in_channels</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span>
            <span class="n">num_anchors_per_location</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
            <span class="n">box_code_size</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span>
            <span class="n">num_class</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">voxels</span><span class="p">,</span> <span class="n">num_points</span><span class="p">,</span> <span class="n">coors</span><span class="p">):</span>
        <span class="c1"># VFE</span>
        <span class="n">voxel_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vfe</span><span class="p">(</span><span class="n">voxels</span><span class="p">,</span> <span class="n">num_points</span><span class="p">,</span> <span class="n">coors</span><span class="p">)</span>

        <span class="c1"># Sparse to dense</span>
        <span class="n">spatial_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sparse_to_dense</span><span class="p">(</span><span class="n">voxel_features</span><span class="p">,</span> <span class="n">coors</span><span class="p">)</span>

        <span class="c1"># Middle layers</span>
        <span class="n">spatial_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">middle_conv</span><span class="p">(</span><span class="n">spatial_features</span><span class="p">)</span>

        <span class="c1"># RPN</span>
        <span class="n">box_preds</span><span class="p">,</span> <span class="n">cls_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rpn</span><span class="p">(</span><span class="n">spatial_features</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">box_preds</span><span class="p">,</span> <span class="n">cls_preds</span>
</code></pre></div>

<h3 id="1933-pointpillars">19.3.3 PointPillars å¿«é€Ÿæ£€æµ‹</h3>
<p>PointPillars æä¾›äº†ä¼˜ç§€çš„é€Ÿåº¦-ç²¾åº¦æƒè¡¡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PointPillars</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Pillar Feature Network</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pfn</span> <span class="o">=</span> <span class="n">PillarFeatureNet</span><span class="p">(</span>
            <span class="n">num_filters</span><span class="o">=</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span>
            <span class="n">use_norm</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">with_distance</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">voxel_size</span><span class="o">=</span><span class="p">(</span><span class="mf">0.16</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
            <span class="n">pc_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mf">39.68</span><span class="p">,</span> <span class="o">-</span><span class="mi">3</span><span class="p">,</span> <span class="mf">69.12</span><span class="p">,</span> <span class="mf">39.68</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># Backbone: 2D CNN</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">64</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">128</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">256</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># Detection Head</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">SSDHead</span><span class="p">(</span>
            <span class="n">in_channels</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
            <span class="n">num_classes</span><span class="o">=</span><span class="n">num_classes</span><span class="p">,</span>
            <span class="n">num_anchors_per_location</span><span class="o">=</span><span class="mi">2</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pillars</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="c1"># Pillar encoding</span>
        <span class="n">pillar_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pfn</span><span class="p">(</span><span class="n">pillars</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>

        <span class="c1"># Scatter to BEV</span>
        <span class="n">bev_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">scatter_to_bev</span><span class="p">(</span><span class="n">pillar_features</span><span class="p">,</span> <span class="n">indices</span><span class="p">)</span>

        <span class="c1"># Backbone</span>
        <span class="n">spatial_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">(</span><span class="n">bev_features</span><span class="p">)</span>

        <span class="c1"># Detection</span>
        <span class="n">cls_preds</span><span class="p">,</span> <span class="n">box_preds</span><span class="p">,</span> <span class="n">dir_cls_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="n">spatial_features</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">cls_preds</span><span class="p">,</span> <span class="n">box_preds</span><span class="p">,</span> <span class="n">dir_cls_preds</span>
</code></pre></div>

<h3 id="1934-">19.3.4 ç‚¹äº‘-å›¾åƒèåˆç½‘ç»œ</h3>
<p>å¤šæ¨¡æ€èåˆæå‡æ£€æµ‹ç²¾åº¦ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PointCloudImageFusion</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># ç‚¹äº‘åˆ†æ”¯</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">point_branch</span> <span class="o">=</span> <span class="n">PointPillars</span><span class="p">(</span><span class="n">num_classes</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>

        <span class="c1"># å›¾åƒåˆ†æ”¯</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_branch</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">resnet50</span><span class="p">(</span><span class="n">pretrained</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_branch</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Identity</span><span class="p">()</span>

        <span class="c1"># èåˆæ¨¡å—</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fusion</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">2048</span> <span class="o">+</span> <span class="mi">256</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="mf">0.3</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">256</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="c1"># æ£€æµ‹å¤´</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">detection_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">3</span><span class="p">)</span>  <span class="c1"># 7 params per box, 3 classes</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">points</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">calib</span><span class="p">):</span>
        <span class="c1"># ç‚¹äº‘ç‰¹å¾</span>
        <span class="n">point_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">point_branch</span><span class="p">(</span><span class="n">points</span><span class="p">)</span>

        <span class="c1"># å›¾åƒç‰¹å¾</span>
        <span class="n">image_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_branch</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

        <span class="c1"># æŠ•å½±å¯¹é½</span>
        <span class="n">aligned_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_and_align</span><span class="p">(</span>
            <span class="n">point_features</span><span class="p">,</span> <span class="n">image_features</span><span class="p">,</span> <span class="n">calib</span><span class="p">)</span>

        <span class="c1"># èåˆ</span>
        <span class="n">fused_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fusion</span><span class="p">(</span><span class="n">aligned_features</span><span class="p">)</span>

        <span class="c1"># æ£€æµ‹</span>
        <span class="n">detections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detection_head</span><span class="p">(</span><span class="n">fused_features</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">detections</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FusionNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;fusion_detection&#39;</span><span class="p">)</span>

        <span class="c1"># åŒæ­¥è®¢é˜…</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pc_sub</span> <span class="o">=</span> <span class="n">message_filters</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">PointCloud2</span><span class="p">,</span> <span class="s1">&#39;velodyne_points&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">img_sub</span> <span class="o">=</span> <span class="n">message_filters</span><span class="o">.</span><span class="n">Subscriber</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">Image</span><span class="p">,</span> <span class="s1">&#39;camera/image_raw&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">sync</span> <span class="o">=</span> <span class="n">message_filters</span><span class="o">.</span><span class="n">ApproximateTimeSynchronizer</span><span class="p">(</span>
            <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pc_sub</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">img_sub</span><span class="p">],</span> <span class="mi">10</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sync</span><span class="o">.</span><span class="n">registerCallback</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fusion_callback</span><span class="p">)</span>

        <span class="c1"># åŠ è½½èåˆæ¨¡å‹</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">PointCloudImageFusion</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">load_state_dict</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="s1">&#39;fusion_model.pth&#39;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">cuda</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">eval</span><span class="p">()</span>
</code></pre></div>

<h2 id="194-tensorrt">19.4 TensorRT åŠ é€Ÿä¸è¾¹ç¼˜éƒ¨ç½²</h2>
<h3 id="1941">19.4.1 æ¨¡å‹é‡åŒ–ä¸ä¼˜åŒ–</h3>
<p>TensorRT æä¾›å¤šç§ä¼˜åŒ–æŠ€æœ¯ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span><span class="w"> </span><span class="nn">tensorrt</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">trt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pycuda.driver</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">cuda</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">pycuda.autoinit</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TensorRTOptimizer</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onnx_model_path</span><span class="p">,</span> <span class="n">precision</span><span class="o">=</span><span class="s1">&#39;fp16&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">logger</span> <span class="o">=</span> <span class="n">trt</span><span class="o">.</span><span class="n">Logger</span><span class="p">(</span><span class="n">trt</span><span class="o">.</span><span class="n">Logger</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">builder</span> <span class="o">=</span> <span class="n">trt</span><span class="o">.</span><span class="n">Builder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">create_builder_config</span><span class="p">()</span>

        <span class="c1"># è®¾ç½®ç²¾åº¦</span>
        <span class="k">if</span> <span class="n">precision</span> <span class="o">==</span> <span class="s1">&#39;fp16&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set_flag</span><span class="p">(</span><span class="n">trt</span><span class="o">.</span><span class="n">BuilderFlag</span><span class="o">.</span><span class="n">FP16</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">precision</span> <span class="o">==</span> <span class="s1">&#39;int8&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set_flag</span><span class="p">(</span><span class="n">trt</span><span class="o">.</span><span class="n">BuilderFlag</span><span class="o">.</span><span class="n">INT8</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">int8_calibrator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_calibrator</span><span class="p">()</span>

        <span class="c1"># è®¾ç½®å†…å­˜é™åˆ¶</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">max_workspace_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span>  <span class="c1"># 1GB</span>

        <span class="c1"># åŠ¨æ€æ‰¹å¤„ç†</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">set_flag</span><span class="p">(</span><span class="n">trt</span><span class="o">.</span><span class="n">BuilderFlag</span><span class="o">.</span><span class="n">STRICT_TYPES</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">onnx_path</span><span class="p">):</span>
        <span class="c1"># è§£æ ONNX</span>
        <span class="n">network</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">create_network</span><span class="p">(</span>
            <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">trt</span><span class="o">.</span><span class="n">NetworkDefinitionCreationFlag</span><span class="o">.</span><span class="n">EXPLICIT_BATCH</span><span class="p">))</span>
        <span class="n">parser</span> <span class="o">=</span> <span class="n">trt</span><span class="o">.</span><span class="n">OnnxParser</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">onnx_path</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()):</span>
                <span class="k">for</span> <span class="n">error</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">num_errors</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">get_error</span><span class="p">(</span><span class="n">error</span><span class="p">))</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># ä¼˜åŒ–é…ç½®</span>
        <span class="n">profile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">create_optimization_profile</span><span class="p">()</span>

        <span class="c1"># åŠ¨æ€è¾“å…¥å°ºå¯¸</span>
        <span class="n">input_tensor</span> <span class="o">=</span> <span class="n">network</span><span class="o">.</span><span class="n">get_input</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">profile</span><span class="o">.</span><span class="n">set_shape</span><span class="p">(</span><span class="n">input_tensor</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                         <span class="nb">min</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">224</span><span class="p">),</span>
                         <span class="n">opt</span><span class="o">=</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">640</span><span class="p">),</span>
                         <span class="nb">max</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">1280</span><span class="p">,</span> <span class="mi">1280</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">add_optimization_profile</span><span class="p">(</span><span class="n">profile</span><span class="p">)</span>

        <span class="c1"># æ„å»ºå¼•æ“</span>
        <span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">build_engine</span><span class="p">(</span><span class="n">network</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">engine</span>
</code></pre></div>

<h3 id="1942-int8">19.4.2 INT8 æ ¡å‡†æµç¨‹</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">INT8Calibrator</span><span class="p">(</span><span class="n">trt</span><span class="o">.</span><span class="n">IInt8EntropyCalibrator2</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">calibration_data</span><span class="p">,</span> <span class="n">cache_file</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibration_data</span> <span class="o">=</span> <span class="n">calibration_data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span> <span class="o">=</span> <span class="n">cache_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_index</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># åˆ†é… GPU å†…å­˜</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device_input</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">*</span> <span class="mi">3</span> <span class="o">*</span> <span class="mi">640</span> <span class="o">*</span> <span class="mi">640</span> <span class="o">*</span> <span class="mi">4</span><span class="p">)</span>  <span class="c1"># float32</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_batch_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_index</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">calibration_data</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># å‡†å¤‡æ‰¹æ¬¡æ•°æ®</span>
        <span class="n">batch</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">calibration_data</span><span class="p">[</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_index</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">current_index</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_index</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span>

        <span class="c1"># å¤åˆ¶åˆ° GPU</span>
        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">device_input</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">device_input</span><span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">read_calibration_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">write_calibration_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cache</span><span class="p">):</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cache_file</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>
</code></pre></div>

<h3 id="1943">19.4.3 åŠ¨æ€æ‰¹å¤„ç†ç­–ç•¥</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DynamicBatchProcessor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">engine_path</span><span class="p">,</span> <span class="n">max_batch_size</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_batch_size</span> <span class="o">=</span> <span class="n">max_batch_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_engine</span><span class="p">(</span><span class="n">engine_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">create_execution_context</span><span class="p">()</span>

        <span class="c1"># åˆ›å»ºç¼“å†²åŒº</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">buffers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allocate_buffers</span><span class="p">()</span>

        <span class="c1"># æ‰¹å¤„ç†é˜Ÿåˆ—</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">result_futures</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">allocate_buffers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">buffers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">binding</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="p">:</span>
            <span class="n">shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">get_binding_shape</span><span class="p">(</span><span class="n">binding</span><span class="p">)</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">trt</span><span class="o">.</span><span class="n">volume</span><span class="p">(</span><span class="n">shape</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_batch_size</span>
            <span class="n">dtype</span> <span class="o">=</span> <span class="n">trt</span><span class="o">.</span><span class="n">nptype</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">get_binding_dtype</span><span class="p">(</span><span class="n">binding</span><span class="p">))</span>

            <span class="c1"># åˆ†é… GPU å†…å­˜</span>
            <span class="n">device_mem</span> <span class="o">=</span> <span class="n">cuda</span><span class="o">.</span><span class="n">mem_alloc</span><span class="p">(</span><span class="n">size</span> <span class="o">*</span> <span class="n">dtype</span><span class="o">.</span><span class="n">itemsize</span><span class="p">)</span>
            <span class="n">buffers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">device_mem</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">buffers</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">infer_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_data</span><span class="p">):</span>
        <span class="n">batch_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">batch_data</span><span class="p">)</span>

        <span class="c1"># è®¾ç½®åŠ¨æ€æ‰¹å¤§å°</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">set_binding_shape</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="p">(</span><span class="n">batch_size</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">640</span><span class="p">))</span>

        <span class="c1"># å¤åˆ¶è¾“å…¥æ•°æ®</span>
        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_htod</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffers</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">batch_data</span><span class="p">)</span>

        <span class="c1"># æ‰§è¡Œæ¨ç†</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">execute_v2</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">buffers</span><span class="p">)</span>

        <span class="c1"># å¤åˆ¶è¾“å‡ºæ•°æ®</span>
        <span class="n">output_shape</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">context</span><span class="o">.</span><span class="n">get_binding_shape</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">output_shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="n">cuda</span><span class="o">.</span><span class="n">memcpy_dtoh</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">buffers</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">output</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_async</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">):</span>
        <span class="n">future</span> <span class="o">=</span> <span class="n">Future</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">image</span><span class="p">,</span> <span class="n">future</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_batch_size</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_process_batch</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">future</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_process_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># æå–æ‰¹æ¬¡</span>
        <span class="n">batch_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="p">]</span>
        <span class="n">futures</span> <span class="o">=</span> <span class="p">[</span><span class="n">item</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="p">]</span>

        <span class="c1"># æ¨ç†</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infer_batch</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">batch_data</span><span class="p">))</span>

        <span class="c1"># åˆ†å‘ç»“æœ</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">future</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">futures</span><span class="p">):</span>
            <span class="n">future</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

        <span class="c1"># æ¸…ç©ºé˜Ÿåˆ—</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
</code></pre></div>

<h3 id="1944-jetson">19.4.4 Jetson å¹³å°éƒ¨ç½²</h3>
<p>é’ˆå¯¹ NVIDIA Jetson çš„ä¼˜åŒ–ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">JetsonDeployment</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">):</span>
        <span class="c1"># Jetson ç”µæºæ¨¡å¼</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_power_mode</span><span class="p">(</span><span class="s1">&#39;MAXN&#39;</span><span class="p">)</span>  <span class="c1"># æœ€å¤§æ€§èƒ½</span>

        <span class="c1"># è®¾ç½® GPU/DLA</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="s1">&#39;DLA0&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_dla</span><span class="p">()</span> <span class="k">else</span> <span class="s1">&#39;GPU&#39;</span>

        <span class="c1"># TensorRT å¼•æ“</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">engine</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_jetson_engine</span><span class="p">(</span><span class="n">model_path</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_power_mode</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è®¾ç½® Jetson ç”µæºæ¨¡å¼&quot;&quot;&quot;</span>
        <span class="n">modes</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;MAXN&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>      <span class="c1"># æœ€å¤§æ€§èƒ½</span>
            <span class="s1">&#39;10W&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>       <span class="c1"># 10W åŠŸè€—</span>
            <span class="s1">&#39;15W&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>       <span class="c1"># 15W åŠŸè€—</span>
            <span class="s1">&#39;30W&#39;</span><span class="p">:</span> <span class="mi">3</span>        <span class="c1"># 30W åŠŸè€—</span>
        <span class="p">}</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;sudo nvpmodel -m </span><span class="si">{</span><span class="n">modes</span><span class="p">[</span><span class="n">mode</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">system</span><span class="p">(</span><span class="s1">&#39;sudo jetson_clocks&#39;</span><span class="p">)</span>  <span class="c1"># é”å®šæœ€é«˜é¢‘ç‡</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">has_dla</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ£€æŸ¥æ˜¯å¦æœ‰ DLA (Deep Learning Accelerator)&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;/dev/nvhost-nvdla0&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_jetson_engine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_path</span><span class="p">):</span>
        <span class="n">builder</span> <span class="o">=</span> <span class="n">trt</span><span class="o">.</span><span class="n">Builder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">config</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">create_builder_config</span><span class="p">()</span>

        <span class="c1"># Jetson ç‰¹å®šä¼˜åŒ–</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">==</span> <span class="s1">&#39;DLA&#39;</span><span class="p">:</span>
            <span class="n">config</span><span class="o">.</span><span class="n">default_device_type</span> <span class="o">=</span> <span class="n">trt</span><span class="o">.</span><span class="n">DeviceType</span><span class="o">.</span><span class="n">DLA</span>
            <span class="n">config</span><span class="o">.</span><span class="n">DLA_core</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1"># ä½¿ç”¨ FP16ï¼ˆJetson ä¸Šæ›´é«˜æ•ˆï¼‰</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set_flag</span><span class="p">(</span><span class="n">trt</span><span class="o">.</span><span class="n">BuilderFlag</span><span class="o">.</span><span class="n">FP16</span><span class="p">)</span>

        <span class="c1"># å†…å­˜ä¼˜åŒ–ï¼ˆJetson å†…å­˜æœ‰é™ï¼‰</span>
        <span class="n">config</span><span class="o">.</span><span class="n">max_workspace_size</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span>  <span class="c1"># 256MB</span>

        <span class="c1"># ä½¿ç”¨ç»Ÿä¸€å†…å­˜</span>
        <span class="n">config</span><span class="o">.</span><span class="n">set_flag</span><span class="p">(</span><span class="n">trt</span><span class="o">.</span><span class="n">BuilderFlag</span><span class="o">.</span><span class="n">GPU_FALLBACK</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_engine</span><span class="p">(</span><span class="n">model_path</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">benchmark</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">input_shape</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">640</span><span class="p">),</span> <span class="n">iterations</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ€§èƒ½åŸºå‡†æµ‹è¯•&quot;&quot;&quot;</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">time</span>

        <span class="c1"># é¢„çƒ­</span>
        <span class="n">dummy_input</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="o">*</span><span class="n">input_shape</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infer</span><span class="p">(</span><span class="n">dummy_input</span><span class="p">)</span>

        <span class="c1"># æµ‹è¯•</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">iterations</span><span class="p">):</span>
            <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">infer</span><span class="p">(</span><span class="n">dummy_input</span><span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        <span class="c1"># ç»Ÿè®¡</span>
        <span class="n">avg_time</span> <span class="o">=</span> <span class="p">(</span><span class="n">end</span> <span class="o">-</span> <span class="n">start</span><span class="p">)</span> <span class="o">/</span> <span class="n">iterations</span> <span class="o">*</span> <span class="mi">1000</span>  <span class="c1"># ms</span>
        <span class="n">fps</span> <span class="o">=</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">avg_time</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Average inference time: </span><span class="si">{</span><span class="n">avg_time</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">ms&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;FPS: </span><span class="si">{</span><span class="n">fps</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># åŠŸè€—ç›‘æ§</span>
        <span class="n">power</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_power_consumption</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Power consumption: </span><span class="si">{</span><span class="n">power</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">W&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;avg_latency_ms&#39;</span><span class="p">:</span> <span class="n">avg_time</span><span class="p">,</span>
            <span class="s1">&#39;fps&#39;</span><span class="p">:</span> <span class="n">fps</span><span class="p">,</span>
            <span class="s1">&#39;power_w&#39;</span><span class="p">:</span> <span class="n">power</span>
        <span class="p">}</span>
</code></pre></div>

<h2 id="tesla-fsd">äº§ä¸šæ¡ˆä¾‹ç ”ç©¶ï¼šTesla FSD è§†è§‰æ„ŸçŸ¥ç³»ç»Ÿ</h2>
<h3 id="_4">èƒŒæ™¯ä¸æŒ‘æˆ˜</h3>
<p>Tesla çš„å…¨è‡ªåŠ¨é©¾é©¶ï¼ˆFSDï¼‰ç³»ç»Ÿä»£è¡¨äº†çº¯è§†è§‰è‡ªåŠ¨é©¾é©¶çš„æé™æŒ‘æˆ˜ã€‚ä¸å¤§å¤šæ•°è‡ªåŠ¨é©¾é©¶å…¬å¸ä¸åŒï¼ŒTesla å®Œå…¨ç§»é™¤äº†æ¿€å…‰é›·è¾¾å’Œæ¯«ç±³æ³¢é›·è¾¾ï¼Œä»…ä¾é  8 ä¸ªæ‘„åƒå¤´å®ç° 360Â° æ„ŸçŸ¥ã€‚</p>
<h3 id="_5">æŠ€æœ¯æ¶æ„</h3>
<p>Tesla FSD çš„è§†è§‰ç³»ç»Ÿé‡‡ç”¨äº†é©å‘½æ€§çš„æ¶æ„è®¾è®¡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">FSD</span><span class="w"> </span><span class="err">è§†è§‰æ¶æ„ï¼š</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">         </span><span class="n">Multi</span><span class="o">-</span><span class="n">Camera</span><span class="w"> </span><span class="n">Input</span><span class="w"> </span><span class="p">(</span><span class="mh">8</span><span class="w"> </span><span class="n">cameras</span><span class="p">)</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Front</span><span class="err">Ã—</span><span class="mh">3</span><span class="w">  </span><span class="n">Side</span><span class="err">Ã—</span><span class="mh">2</span><span class="w">  </span><span class="n">Rear</span><span class="err">Ã—</span><span class="mh">1</span><span class="w">  </span><span class="n">Pillar</span><span class="err">Ã—</span><span class="mh">2</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                    </span><span class="err">â†“</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">          </span><span class="n">RegNet</span><span class="w"> </span><span class="n">Backbone</span><span class="w"> </span><span class="p">(</span><span class="n">shared</span><span class="p">)</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">         </span><span class="n">Efficient</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="n">extraction</span><span class="w">         </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                    </span><span class="err">â†“</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">         </span><span class="n">BiFPN</span><span class="w"> </span><span class="n">Feature</span><span class="w"> </span><span class="n">Pyramid</span><span class="w">               </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="n">Multi</span><span class="o">-</span><span class="n">scale</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="n">aggregation</span><span class="w">        </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                    </span><span class="err">â†“</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">      </span><span class="n">Transformer</span><span class="o">-</span><span class="n">based</span><span class="w"> </span><span class="n">BEV</span><span class="w"> </span><span class="n">Encoder</span><span class="w">          </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">    </span><span class="n">Project</span><span class="w"> </span><span class="n">features</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">bird</span><span class="p">&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">eye</span><span class="w"> </span><span class="n">view</span><span class="w">      </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                    </span><span class="err">â†“</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">         </span><span class="n">Temporal</span><span class="w"> </span><span class="n">Fusion</span><span class="w"> </span><span class="p">(</span><span class="mh">4</span><span class="n">D</span><span class="p">)</span><span class="w">                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">      </span><span class="n">Aggregate</span><span class="w"> </span><span class="n">across</span><span class="w"> </span><span class="kt">time</span><span class="w"> </span><span class="n">frames</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
<span class="w">                    </span><span class="err">â†“</span>
<span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">  </span><span class="n">Detection</span><span class="w">   </span><span class="err">â”‚</span><span class="w">  </span><span class="n">Tracking</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="n">Planning</span><span class="w">     </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">   </span><span class="n">Head</span><span class="w">       </span><span class="err">â”‚</span><span class="w">    </span><span class="n">Head</span><span class="w">    </span><span class="err">â”‚</span><span class="w">     </span><span class="n">Head</span><span class="w">       </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="_6">å…³é”®æŠ€æœ¯å†³ç­–</h3>
<ol>
<li>
<p><strong>HydraNet å¤šä»»åŠ¡å­¦ä¹ </strong>ï¼š
   - å•ä¸€éª¨å¹²ç½‘ç»œåŒæ—¶å¤„ç† 48 ä¸ªä»»åŠ¡
   - åŒ…æ‹¬ç›®æ ‡æ£€æµ‹ã€è½¦é“çº¿æ£€æµ‹ã€å¯è¡Œé©¶åŒºåŸŸã€äº¤é€šä¿¡å·ç¯ç­‰
   - æ˜¾è‘—å‡å°‘è®¡ç®—å¼€é”€</p>
</li>
<li>
<p><strong>Vector Space è¡¨ç¤º</strong>ï¼š
   - ä¸ä½¿ç”¨ä¼ ç»Ÿçš„æ …æ ¼åœ°å›¾
   - ç›´æ¥è¾“å‡ºçŸ¢é‡åŒ–çš„è½¦é“çº¿ã€é“è·¯è¾¹ç•Œ
   - æé«˜äº†è¡¨ç¤ºæ•ˆç‡å’Œç²¾åº¦</p>
</li>
<li>
<p><strong>è‡ªç›‘ç£å­¦ä¹ </strong>ï¼š
   - åˆ©ç”¨è½¦é˜Ÿæ•°æ®è‡ªåŠ¨æ ‡æ³¨
   - æ—¶é—´ä¸€è‡´æ€§çº¦æŸ
   - å‡å°‘äººå·¥æ ‡æ³¨æˆæœ¬</p>
</li>
</ol>
<h3 id="_7">æ€§èƒ½æŒ‡æ ‡</h3>
<ul>
<li><strong>å»¶è¿Ÿ</strong>ï¼š36ms ç«¯åˆ°ç«¯ï¼ˆä»å›¾åƒè¾“å…¥åˆ°è§„åˆ’è¾“å‡ºï¼‰</li>
<li><strong>å¸§ç‡</strong>ï¼š36 FPSï¼ˆæ‰€æœ‰æ‘„åƒå¤´ï¼‰</li>
<li><strong>æ£€æµ‹èŒƒå›´</strong>ï¼š250mï¼ˆå‰å‘ä¸»æ‘„åƒå¤´ï¼‰</li>
<li><strong>è®¡ç®—å¹³å°</strong>ï¼šFSD Computer (2Ã—144 TOPS)</li>
</ul>
<h3 id="_8">å·¥ç¨‹ä¼˜åŒ–ç»éªŒ</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TeslaFSDOptimizations</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Tesla FSD é£æ ¼çš„ä¼˜åŒ–æŠ€æœ¯&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># 1. ç¼“å­˜ä¼˜åŒ–</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_cache</span> <span class="o">=</span> <span class="n">TemporalCache</span><span class="p">(</span><span class="n">max_frames</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

        <span class="c1"># 2. ç¨€ç–å·ç§¯</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sparse_conv</span> <span class="o">=</span> <span class="n">SparseConvolution</span><span class="p">()</span>

        <span class="c1"># 3. æ··åˆç²¾åº¦</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mixed_precision</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">cached_backbone_forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç¼“å­˜éª¨å¹²ç½‘ç»œç‰¹å¾ï¼Œé¿å…é‡å¤è®¡ç®—&quot;&quot;&quot;</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">img</span><span class="p">,</span> <span class="n">ts</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">timestamps</span><span class="p">):</span>
            <span class="c1"># æ£€æŸ¥ç¼“å­˜</span>
            <span class="k">if</span> <span class="n">ts</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_cache</span><span class="p">:</span>
                <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">feature_cache</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># è®¡ç®—æ–°ç‰¹å¾</span>
                <span class="k">with</span> <span class="n">autocast</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mixed_precision</span><span class="p">):</span>
                    <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backbone</span><span class="p">(</span><span class="n">img</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">feature_cache</span><span class="p">[</span><span class="n">ts</span><span class="p">]</span> <span class="o">=</span> <span class="n">feat</span>
            <span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">features</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">vector_space_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">bev_features</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;çŸ¢é‡ç©ºé—´è¾“å‡ºï¼Œé¿å…å¯†é›†æ …æ ¼&quot;&quot;&quot;</span>
        <span class="c1"># è½¦é“çº¿ï¼šç”¨å¤šé¡¹å¼å‚æ•°è¡¨ç¤º</span>
        <span class="n">lane_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lane_head</span><span class="p">(</span><span class="n">bev_features</span><span class="p">)</span>  <span class="c1"># [N, 4] (a,b,c,d for axÂ³+bxÂ²+cx+d)</span>

        <span class="c1"># ç›®æ ‡ï¼šç”¨è¾¹ç•Œæ¡†è§’ç‚¹è¡¨ç¤º</span>
        <span class="n">object_corners</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_head</span><span class="p">(</span><span class="n">bev_features</span><span class="p">)</span>  <span class="c1"># [N, 8] (4 corners Ã— 2)</span>

        <span class="c1"># å¯è¡Œé©¶åŒºåŸŸï¼šç”¨å¤šè¾¹å½¢é¡¶ç‚¹è¡¨ç¤º</span>
        <span class="n">drivable_polygon</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drivable_head</span><span class="p">(</span><span class="n">bev_features</span><span class="p">)</span>  <span class="c1"># [M, 2]</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;lanes&#39;</span><span class="p">:</span> <span class="n">lane_params</span><span class="p">,</span>
            <span class="s1">&#39;objects&#39;</span><span class="p">:</span> <span class="n">object_corners</span><span class="p">,</span>
            <span class="s1">&#39;drivable&#39;</span><span class="p">:</span> <span class="n">drivable_polygon</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">temporal_nms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">detections</span><span class="p">,</span> <span class="n">history</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ—¶åº NMSï¼Œåˆ©ç”¨å†å²ä¿¡æ¯æé«˜ç¨³å®šæ€§&quot;&quot;&quot;</span>
        <span class="c1"># å°†å½“å‰æ£€æµ‹ä¸å†å²å…³è”</span>
        <span class="n">matched</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">associate</span><span class="p">(</span><span class="n">detections</span><span class="p">,</span> <span class="n">history</span><span class="p">)</span>

        <span class="c1"># å¹³æ»‘è¾¹ç•Œæ¡†</span>
        <span class="k">for</span> <span class="n">det</span><span class="p">,</span> <span class="n">hist</span> <span class="ow">in</span> <span class="n">matched</span><span class="p">:</span>
            <span class="n">det</span><span class="o">.</span><span class="n">bbox</span> <span class="o">=</span> <span class="mf">0.7</span> <span class="o">*</span> <span class="n">det</span><span class="o">.</span><span class="n">bbox</span> <span class="o">+</span> <span class="mf">0.3</span> <span class="o">*</span> <span class="n">hist</span><span class="o">.</span><span class="n">bbox</span>
            <span class="n">det</span><span class="o">.</span><span class="n">confidence</span> <span class="o">=</span> <span class="mf">0.8</span> <span class="o">*</span> <span class="n">det</span><span class="o">.</span><span class="n">confidence</span> <span class="o">+</span> <span class="mf">0.2</span> <span class="o">*</span> <span class="n">hist</span><span class="o">.</span><span class="n">confidence</span>

        <span class="k">return</span> <span class="n">detections</span>
</code></pre></div>

<h3 id="_9">è¸©å‘ä¸è§£å†³æ–¹æ¡ˆ</h3>
<ol>
<li>
<p><strong>æ‘„åƒå¤´æ ‡å®šæ¼‚ç§»</strong>ï¼š
   - é—®é¢˜ï¼šé•¿æœŸä½¿ç”¨å¯¼è‡´å¤–å‚å˜åŒ–
   - è§£å†³ï¼šåœ¨çº¿è‡ªæ ‡å®šç®—æ³•ï¼Œåˆ©ç”¨è½¦é“çº¿å’Œé™æ€ç›®æ ‡</p>
</li>
<li>
<p><strong>æ¶åŠ£å¤©æ°”é€€åŒ–</strong>ï¼š
   - é—®é¢˜ï¼šé›¨é›ªå¯¼è‡´æ€§èƒ½ä¸‹é™
   - è§£å†³ï¼šå¤§è§„æ¨¡æ¶åŠ£å¤©æ°”æ•°æ®å¢å¼ºï¼Œä¸“é—¨çš„å»é›¨ç½‘ç»œ</p>
</li>
<li>
<p><strong>è®¡ç®—èµ„æºé™åˆ¶</strong>ï¼š
   - é—®é¢˜ï¼šè½¦è½½èŠ¯ç‰‡ç®—åŠ›æœ‰é™
   - è§£å†³ï¼šæ¨¡å‹å‰ªæã€é‡åŒ–ã€çŸ¥è¯†è’¸é¦</p>
</li>
</ol>
<h3 id="_10">ç»éªŒæ•™è®­</h3>
<ol>
<li><strong>æ•°æ®è´¨é‡ &gt; æ¨¡å‹å¤æ‚åº¦</strong>ï¼šTesla çš„æˆåŠŸå¾ˆå¤§ç¨‹åº¦ä¸Šå½’åŠŸäºæµ·é‡é«˜è´¨é‡æ•°æ®</li>
<li><strong>ç«¯åˆ°ç«¯ä¼˜åŒ–</strong>ï¼šæ•´ä½“ä¼˜åŒ–æ¯”æ¨¡å—ä¼˜åŒ–æ›´æœ‰æ•ˆ</li>
<li><strong>ç¡¬ä»¶ååŒè®¾è®¡</strong>ï¼šFSD èŠ¯ç‰‡ä¸“é—¨ä¸ºç¥ç»ç½‘ç»œä¼˜åŒ–</li>
<li><strong>æŒç»­å­¦ä¹ </strong>ï¼šShadow mode å…è®¸åœ¨ä¸å½±å“é©¾é©¶çš„æƒ…å†µä¸‹æµ‹è¯•æ–°æ¨¡å‹</li>
</ol>
<h2 id="bev-transformer">é«˜çº§è¯é¢˜ï¼šBEV æ„ŸçŸ¥ä¸ Transformer æ¶æ„</h2>
<h3 id="bev-birds-eye-view">BEV (Bird's Eye View) æ„ŸçŸ¥</h3>
<p>BEV æ„ŸçŸ¥å·²æˆä¸ºè‡ªåŠ¨é©¾é©¶çš„ä¸»æµèŒƒå¼ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">BEVFormer</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;BEVFormer: åŸºäº Transformer çš„ BEV æ„ŸçŸ¥&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_cameras</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">bev_h</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">bev_w</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># å›¾åƒç¼–ç å™¨</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_encoder</span> <span class="o">=</span> <span class="n">ResNet50</span><span class="p">()</span>

        <span class="c1"># BEV æŸ¥è¯¢</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bev_queries</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">bev_h</span> <span class="o">*</span> <span class="n">bev_w</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>

        <span class="c1"># Spatial Cross-Attention</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_cross_attn</span> <span class="o">=</span> <span class="n">SpatialCrossAttention</span><span class="p">(</span>
            <span class="n">embed_dim</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
            <span class="n">num_heads</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
            <span class="n">num_levels</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
            <span class="n">num_cameras</span><span class="o">=</span><span class="n">num_cameras</span>
        <span class="p">)</span>

        <span class="c1"># Temporal Self-Attention</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temporal_self_attn</span> <span class="o">=</span> <span class="n">TemporalSelfAttention</span><span class="p">(</span>
            <span class="n">embed_dim</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>
            <span class="n">num_heads</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
            <span class="n">num_frames</span><span class="o">=</span><span class="mi">4</span>
        <span class="p">)</span>

        <span class="c1"># BEV ç¼–ç å™¨</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bev_encoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoder</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">TransformerEncoderLayer</span><span class="p">(</span><span class="n">d_model</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">nhead</span><span class="o">=</span><span class="mi">8</span><span class="p">),</span>
            <span class="n">num_layers</span><span class="o">=</span><span class="mi">6</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">intrinsics</span><span class="p">,</span> <span class="n">extrinsics</span><span class="p">,</span> <span class="n">prev_bev</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">B</span><span class="p">,</span> <span class="n">N</span><span class="p">,</span> <span class="n">C</span><span class="p">,</span> <span class="n">H</span><span class="p">,</span> <span class="n">W</span> <span class="o">=</span> <span class="n">images</span><span class="o">.</span><span class="n">shape</span>  <span class="c1"># B:batch, N:cameras</span>

        <span class="c1"># 1. æå–å›¾åƒç‰¹å¾</span>
        <span class="n">image_features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">N</span><span class="p">):</span>
            <span class="n">feat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_encoder</span><span class="p">(</span><span class="n">images</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span>
            <span class="n">image_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feat</span><span class="p">)</span>
        <span class="n">image_features</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">stack</span><span class="p">(</span><span class="n">image_features</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># 2. åˆå§‹åŒ– BEV æŸ¥è¯¢</span>
        <span class="n">bev_queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bev_queries</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># 3. Spatial Cross-Attention</span>
        <span class="c1"># å°† BEV æŸ¥è¯¢æŠ•å½±åˆ°å›¾åƒç‰¹å¾ç©ºé—´</span>
        <span class="n">bev_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_cross_attn</span><span class="p">(</span>
            <span class="n">bev_queries</span><span class="p">,</span> 
            <span class="n">image_features</span><span class="p">,</span>
            <span class="n">intrinsics</span><span class="p">,</span>
            <span class="n">extrinsics</span>
        <span class="p">)</span>

        <span class="c1"># 4. Temporal Self-Attention</span>
        <span class="k">if</span> <span class="n">prev_bev</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">bev_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temporal_self_attn</span><span class="p">(</span>
                <span class="n">bev_features</span><span class="p">,</span> <span class="n">prev_bev</span><span class="p">)</span>

        <span class="c1"># 5. BEV ç¼–ç </span>
        <span class="n">bev_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bev_encoder</span><span class="p">(</span><span class="n">bev_features</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">bev_features</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bev_h</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">bev_w</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div>

<h3 id="detr3d3d-transformer">DETR3Dï¼š3D ç›®æ ‡æ£€æµ‹ Transformer</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DETR3D</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;DETR3D: ç«¯åˆ°ç«¯ 3D ç›®æ ‡æ£€æµ‹&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_queries</span><span class="o">=</span><span class="mi">900</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># å¯¹è±¡æŸ¥è¯¢</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">object_queries</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span>
            <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">num_queries</span><span class="p">,</span> <span class="mi">256</span><span class="p">))</span>

        <span class="c1"># 3D å‚è€ƒç‚¹</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_points</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="c1"># Transformer decoder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">TransformerDecoder</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">TransformerDecoderLayer</span><span class="p">(</span>
                <span class="n">d_model</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> 
                <span class="n">nhead</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                <span class="n">dim_feedforward</span><span class="o">=</span><span class="mi">2048</span>
            <span class="p">),</span>
            <span class="n">num_layers</span><span class="o">=</span><span class="mi">6</span>
        <span class="p">)</span>

        <span class="c1"># é¢„æµ‹å¤´</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">class_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bbox_head</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">256</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>  <span class="c1"># (x,y,z,w,l,h,rot,vx,vy,vz)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">multi_view_features</span><span class="p">,</span> <span class="n">intrinsics</span><span class="p">,</span> <span class="n">extrinsics</span><span class="p">):</span>
        <span class="n">B</span> <span class="o">=</span> <span class="n">multi_view_features</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># 1. åˆå§‹åŒ–æŸ¥è¯¢å’Œå‚è€ƒç‚¹</span>
        <span class="n">queries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">object_queries</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">reference_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_points</span><span class="p">(</span><span class="n">queries</span><span class="p">)</span><span class="o">.</span><span class="n">sigmoid</span><span class="p">()</span>
        <span class="n">reference_points</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference_points</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span>  <span class="c1"># [-1, 1]</span>
        <span class="n">reference_points</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">reference_points</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">6</span> <span class="o">-</span> <span class="mi">3</span>    <span class="c1"># [-3, 3]m</span>

        <span class="c1"># 2. æŠ•å½±å‚è€ƒç‚¹åˆ°å„ä¸ªè§†å›¾</span>
        <span class="n">projected_points</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">project_3d_to_2d</span><span class="p">(</span>
            <span class="n">reference_points</span><span class="p">,</span> <span class="n">intrinsics</span><span class="p">,</span> <span class="n">extrinsics</span><span class="p">)</span>

        <span class="c1"># 3. é‡‡æ ·å›¾åƒç‰¹å¾</span>
        <span class="n">sampled_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_features</span><span class="p">(</span>
            <span class="n">multi_view_features</span><span class="p">,</span> <span class="n">projected_points</span><span class="p">)</span>

        <span class="c1"># 4. Transformer è§£ç </span>
        <span class="n">decoded_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decoder</span><span class="p">(</span>
            <span class="n">queries</span><span class="p">,</span> <span class="n">sampled_features</span><span class="p">)</span>

        <span class="c1"># 5. é¢„æµ‹</span>
        <span class="n">class_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">class_head</span><span class="p">(</span><span class="n">decoded_features</span><span class="p">)</span>
        <span class="n">bbox_preds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bbox_head</span><span class="p">(</span><span class="n">decoded_features</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">class_logits</span><span class="p">,</span> <span class="n">bbox_preds</span>
</code></pre></div>

<h3 id="_11">æ€§èƒ½ä¼˜åŒ–æŠ€å·§</h3>
<ol>
<li><strong>Flash Attention</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">flash_attn</span><span class="w"> </span><span class="kn">import</span> <span class="n">flash_attn_func</span>

<span class="k">class</span><span class="w"> </span><span class="nc">FlashBEVAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ä½¿ç”¨ Flash Attention åŠ é€Ÿ BEV è®¡ç®—&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
        <span class="c1"># Flash Attention: O(N) å†…å­˜å¤æ‚åº¦</span>
        <span class="k">return</span> <span class="n">flash_attn_func</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">dropout_p</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">causal</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div>

<ol start="2">
<li><strong>Deformable Attention</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DeformableBEVAttention</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å¯å˜å½¢æ³¨æ„åŠ›ï¼Œå‡å°‘è®¡ç®—é‡&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dim</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span> <span class="n">n_heads</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">n_points</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_points</span> <span class="o">=</span> <span class="n">n_points</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sampling_offsets</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">n_heads</span> <span class="o">*</span> <span class="n">n_points</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">attention_weights</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="n">dim</span><span class="p">,</span> <span class="n">n_heads</span> <span class="o">*</span> <span class="n">n_points</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">,</span> <span class="n">reference_points</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="c1"># é¢„æµ‹é‡‡æ ·åç§»</span>
        <span class="n">sampling_offsets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sampling_offsets</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>
        <span class="n">sampling_offsets</span> <span class="o">=</span> <span class="n">sampling_offsets</span><span class="o">.</span><span class="n">view</span><span class="p">(</span>
            <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_heads</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">n_points</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># è®¡ç®—é‡‡æ ·ä½ç½®</span>
        <span class="n">sampling_locations</span> <span class="o">=</span> <span class="n">reference_points</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">sampling_offsets</span>

        <span class="c1"># é‡‡æ ·å’ŒåŠ æƒ</span>
        <span class="n">sampled_value</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">grid_sample</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">sampling_locations</span><span class="p">)</span>
        <span class="n">attention_weights</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">attention_weights</span><span class="p">(</span><span class="n">query</span><span class="p">)</span><span class="o">.</span><span class="n">softmax</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">output</span> <span class="o">=</span> <span class="p">(</span><span class="n">sampled_value</span> <span class="o">*</span> <span class="n">attention_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">output</span>
</code></pre></div>

<h3 id="_12">å‰æ²¿ç ”ç©¶æ–¹å‘</h3>
<ol>
<li>
<p><strong>å ç”¨ç½‘ç»œï¼ˆOccupancy Networksï¼‰</strong>ï¼š
   - ä»£è¡¨å·¥ä½œï¼šTesla Occupancy Network, OccNet
   - ä¼˜åŠ¿ï¼šç»Ÿä¸€è¡¨ç¤ºé™æ€å’ŒåŠ¨æ€éšœç¢ç‰©
   - æŒ‘æˆ˜ï¼šè®¡ç®—é‡å¤§ï¼Œéœ€è¦ 3D ç›‘ç£</p>
</li>
<li>
<p><strong>ç¥ç»è¾å°„åœºï¼ˆNeRFï¼‰for è‡ªåŠ¨é©¾é©¶</strong>ï¼š
   - ä»£è¡¨å·¥ä½œï¼šBlock-NeRF, Neural Scene Graphs
   - åº”ç”¨ï¼šåœºæ™¯é‡å»ºã€æ–°è§†è§’åˆæˆã€ä»¿çœŸ
   - é™åˆ¶ï¼šå®æ—¶æ€§ä¸è¶³</p>
</li>
<li>
<p><strong>World Models</strong>ï¼š
   - ä»£è¡¨å·¥ä½œï¼šMILE, DreamerV3
   - ç›®æ ‡ï¼šå­¦ä¹ ç¯å¢ƒåŠ¨åŠ›å­¦æ¨¡å‹
   - åº”ç”¨ï¼šé¢„æµ‹ã€è§„åˆ’ã€ä»¿çœŸ</p>
</li>
</ol>
<h3 id="_13">å…³é”®è®ºæ–‡æ¨è</h3>
<ol>
<li><strong>BEVFormer</strong> (ECCV 2022): "BEVFormer: Learning Bird's-Eye-View Representation from Multi-Camera Images via Spatiotemporal Transformers"</li>
<li><strong>DETR3D</strong> (CoRL 2021): "DETR3D: 3D Object Detection from Multi-view Images via 3D-to-2D Queries"</li>
<li><strong>BEVDet</strong> (2021): "BEVDet: High-performance Multi-camera 3D Object Detection in Bird-Eye-View"</li>
</ol>
<h3 id="_14">å¼€æºé¡¹ç›®æ¨è</h3>
<ol>
<li><strong>MMDetection3D</strong>: ç»¼åˆçš„ 3D æ£€æµ‹æ¡†æ¶</li>
<li><strong>BEVFormer</strong>: å®˜æ–¹ BEVFormer å®ç°</li>
<li><strong>OpenPCDet</strong>: ç‚¹äº‘æ£€æµ‹å·¥å…·ç®±</li>
<li><strong>NVIDIA DriveWorks</strong>: å•†ä¸šçº§è‡ªåŠ¨é©¾é©¶ SDK</li>
</ol>
<h2 id="_15">æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº† ROS2 ä¸­è®¡ç®—æœºè§†è§‰ä¸æ·±åº¦å­¦ä¹ çš„é›†æˆæ–¹æ³•ã€‚æˆ‘ä»¬å­¦ä¹ äº†ï¼š</p>
<ol>
<li>
<p><strong>2D è§†è§‰å¤„ç†</strong>ï¼š
   - YOLO ç³»åˆ—æ£€æµ‹å™¨çš„æ¶æ„æ¼”è¿›ï¼šä» YOLOv1 çš„å•é˜¶æ®µæ£€æµ‹åˆ° YOLOv9 çš„ PGI å’Œ GELAN
   - å®æ—¶æ¨ç†ä¼˜åŒ–ç­–ç•¥ï¼šæ‰¹å¤„ç†ã€å¼‚æ­¥ç®¡é“ã€åŠ¨æ€æ‰¹å¤§å°
   - å¤šç›®æ ‡è·Ÿè¸ªé›†æˆï¼šDeepSORT å’Œ ByteTrack çš„å·¥ç¨‹å®ç°</p>
</li>
<li>
<p><strong>è¯­ä¹‰ç†è§£</strong>ï¼š
   - SAM çš„é›¶æ ·æœ¬åˆ†å‰²èƒ½åŠ›ï¼š$P(mask|image, prompt) = \sigma(f_{\theta}(image, prompt))$
   - å®ä¾‹åˆ†å‰²çš„åƒç´ çº§ç²¾åº¦ï¼šMask R-CNN çš„ RoIAlign æœºåˆ¶
   - 2D åˆ° 3D çš„æŠ•å½±å˜æ¢ï¼š$[X, Y, Z]^T = K^{-1} \cdot d \cdot [u, v, 1]^T$</p>
</li>
<li>
<p><strong>3D æ„ŸçŸ¥</strong>ï¼š
   - PointNet++ çš„å±‚æ¬¡åŒ–ç‰¹å¾å­¦ä¹ ï¼šSet Abstraction å’Œ Feature Propagation
   - ä½“ç´ åŒ–æ–¹æ³•çš„é€Ÿåº¦ä¼˜åŠ¿ï¼šVoxelNet çš„ç¨€ç–å·ç§¯ï¼ŒPointPillars çš„ 2D æŠ•å½±
   - å¤šæ¨¡æ€èåˆçš„ç²¾åº¦æå‡ï¼šç‚¹äº‘-å›¾åƒç‰¹å¾å¯¹é½</p>
</li>
<li>
<p><strong>è¾¹ç¼˜éƒ¨ç½²</strong>ï¼š
   - TensorRT ä¼˜åŒ–æµç¨‹ï¼šFP16/INT8 é‡åŒ–ï¼ŒåŠ¨æ€æ‰¹å¤„ç†ï¼Œå†…å­˜ä¼˜åŒ–
   - Jetson å¹³å°ç‰¹æ€§ï¼šDLA åŠ é€Ÿå™¨ï¼Œç»Ÿä¸€å†…å­˜æ¶æ„
   - æ€§èƒ½åŸºå‡†ï¼šå»¶è¿Ÿ vs ååé‡ vs åŠŸè€—çš„æƒè¡¡</p>
</li>
<li>
<p><strong>å‰æ²¿æŠ€æœ¯</strong>ï¼š
   - BEV ç»Ÿä¸€è¡¨ç¤ºï¼šå¤šè§†å›¾ç‰¹å¾èšåˆåˆ°é¸Ÿç°å›¾ç©ºé—´
   - Transformer æ¶æ„ï¼šDETR3D çš„æŸ¥è¯¢æœºåˆ¶ï¼ŒBEVFormer çš„æ—¶ç©ºæ³¨æ„åŠ›
   - å·¥ä¸šå®è·µï¼šTesla FSD çš„ç«¯åˆ°ç«¯ä¼˜åŒ–ç­–ç•¥</p>
</li>
</ol>
<p>å…³é”®å…¬å¼æ€»ç»“ï¼š</p>
<ul>
<li>
<p><strong>ç›¸æœºæŠ•å½±æ¨¡å‹</strong>ï¼š$\begin{bmatrix} u \\ v \\ 1 \end{bmatrix} = \frac{1}{Z} K \begin{bmatrix} X \\ Y \\ Z \end{bmatrix}$</p>
</li>
<li>
<p><strong>IoU è®¡ç®—</strong>ï¼š$IoU = \frac{|A \cap B|}{|A \cup B|}$</p>
</li>
<li>
<p><strong>NMS é˜ˆå€¼</strong>ï¼š$score_i = score_i \cdot (1 - IoU(box_i, box_{max}))^{p}$ï¼Œå…¶ä¸­ $p$ ä¸ºè½¯åŒ–å‚æ•°</p>
</li>
<li>
<p><strong>Transformer æ³¨æ„åŠ›</strong>ï¼š$Attention(Q,K,V) = softmax(\frac{QK^T}{\sqrt{d_k}})V$</p>
</li>
</ul>
<h2 id="_16">ç»ƒä¹ é¢˜</h2>
<h3 id="_17">åŸºç¡€é¢˜</h3>
<ol>
<li><strong>YOLO æ¶æ„ç†è§£</strong>
   - è§£é‡Š YOLOv8 çš„ Decoupled Head è®¾è®¡ç›¸æ¯” Coupled Head çš„ä¼˜åŠ¿
   - <em>æç¤º</em>ï¼šè€ƒè™‘åˆ†ç±»å’Œå®šä½ä»»åŠ¡çš„ç‰¹å¾éœ€æ±‚å·®å¼‚</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>Decoupled Head å°†åˆ†ç±»å’Œå›å½’ä»»åŠ¡åˆ†ç¦»ï¼Œä½¿ç”¨ç‹¬ç«‹çš„åˆ†æ”¯å¤„ç†ã€‚ä¼˜åŠ¿åŒ…æ‹¬ï¼š</p>
<ul>
<li>åˆ†ç±»åˆ†æ”¯å…³æ³¨è¯­ä¹‰ç‰¹å¾ï¼Œå›å½’åˆ†æ”¯å…³æ³¨ç©ºé—´ç‰¹å¾</li>
<li>å‡å°‘ä»»åŠ¡é—´çš„ç›¸äº’å¹²æ‰°</li>
<li>å¯ä»¥ä¸ºä¸åŒä»»åŠ¡ä½¿ç”¨ä¸åŒçš„æŸå¤±å‡½æ•°æƒé‡</li>
<li>æå‡äº†å°ç›®æ ‡æ£€æµ‹æ€§èƒ½çº¦ 2-3 AP</li>
</ul>
</details>
<ol start="2">
<li><strong>è¯­ä¹‰åˆ†å‰²ä¼˜åŒ–</strong>
   - è®¾è®¡ä¸€ä¸ªè½»é‡çº§è¯­ä¹‰åˆ†å‰²ç½‘ç»œï¼Œè¦æ±‚åœ¨ Jetson Nano ä¸Šè¾¾åˆ° 15 FPS
   - <em>æç¤º</em>ï¼šè€ƒè™‘ MobileNet éª¨å¹²å’ŒåŒçº¿æ€§ä¸Šé‡‡æ ·</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>å…³é”®è®¾è®¡è¦ç‚¹ï¼š</p>
<ul>
<li>ä½¿ç”¨ MobileNetV3-Small ä½œä¸ºéª¨å¹²ï¼ˆ~2.5M å‚æ•°ï¼‰</li>
<li>é‡‡ç”¨ ASPP æ¨¡å—ä½†å‡å°‘æ‰©å¼ ç‡ï¼ˆ[1,3,5]ï¼‰</li>
<li>ä½¿ç”¨åŒçº¿æ€§æ’å€¼æ›¿ä»£è½¬ç½®å·ç§¯</li>
<li>è¾“å…¥åˆ†è¾¨ç‡é™è‡³ 320Ã—240</li>
<li>é‡åŒ–åˆ° INT8
é¢„æœŸæ€§èƒ½ï¼šJetson Nano ä¸Š 15-18 FPS</li>
</ul>
</details>
<ol start="3">
<li><strong>ç‚¹äº‘å¤„ç†åŸºç¡€</strong>
   - å®ç°ä¸€ä¸ªç®€å•çš„ä½“ç´ åŒ–å‡½æ•°ï¼Œå°†ç‚¹äº‘è½¬æ¢ä¸º 3D ç½‘æ ¼
   - <em>æç¤º</em>ï¼šä½¿ç”¨ numpy çš„ digitize å‡½æ•°</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">voxelize</span><span class="p">(</span><span class="n">points</span><span class="p">,</span> <span class="n">voxel_size</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">max_points</span><span class="o">=</span><span class="mi">32</span><span class="p">):</span>
    <span class="n">voxel_coords</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">floor</span><span class="p">(</span><span class="n">points</span> <span class="o">/</span> <span class="n">voxel_size</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
    <span class="n">voxel_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">coord</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">voxel_coords</span><span class="p">):</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">coord</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">voxel_dict</span><span class="p">:</span>
            <span class="n">voxel_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">voxel_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">max_points</span><span class="p">:</span>
            <span class="n">voxel_dict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">points</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">voxel_dict</span>
</code></pre></div>

</details>
<ol start="4">
<li><strong>TensorRT åŸºç¡€</strong>
   - åˆ—å‡ºå°† PyTorch æ¨¡å‹è½¬æ¢ä¸º TensorRT çš„å®Œæ•´æµç¨‹
   - <em>æç¤º</em>ï¼šåŒ…æ‹¬ ONNX å¯¼å‡ºå’Œä¼˜åŒ–æ­¥éª¤</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>è½¬æ¢æµç¨‹ï¼š</p>
<ol>
<li>PyTorch â†’ ONNXï¼štorch.onnx.export()</li>
<li>ç®€åŒ– ONNXï¼šonnx-simplifier</li>
<li>ONNX â†’ TensorRTï¼štrtexec æˆ– Python API</li>
<li>INT8 æ ¡å‡†ï¼ˆå¯é€‰ï¼‰ï¼šæä¾›æ ¡å‡†æ•°æ®é›†</li>
<li>åºåˆ—åŒ–å¼•æ“ï¼šä¿å­˜ .engine æ–‡ä»¶</li>
<li>éƒ¨ç½²æ¨ç†ï¼šåŠ è½½å¼•æ“å¹¶æ‰§è¡Œ</li>
</ol>
</details>
<h3 id="_18">æŒ‘æˆ˜é¢˜</h3>
<ol start="5">
<li><strong>å¤šä¼ æ„Ÿå™¨æ—¶é—´åŒæ­¥</strong>
   - è®¾è®¡ä¸€ä¸ªç®—æ³•ï¼ŒåŒæ­¥æ¥è‡ª 4 ä¸ªä¸åŒå¸§ç‡ç›¸æœºçš„å›¾åƒæµï¼ˆ10Hz, 15Hz, 20Hz, 30Hzï¼‰
   - è¦æ±‚æœ€å¤§å»¶è¿Ÿä¸è¶…è¿‡ 50ms
   - <em>æç¤º</em>ï¼šä½¿ç”¨ä¼˜å…ˆé˜Ÿåˆ—å’Œæ—¶é—´æˆ³æ’å€¼</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ç®—æ³•è®¾è®¡ï¼š</p>
<ol>
<li>ä¸ºæ¯ä¸ªç›¸æœºç»´æŠ¤ä¸€ä¸ªç¼“å†²é˜Ÿåˆ—</li>
<li>ä½¿ç”¨æ—¶é—´æˆ³ä½œä¸ºåŒæ­¥åŸºå‡†</li>
<li>å®šä¹‰åŒæ­¥çª—å£ï¼ˆå¦‚ 33msï¼‰</li>
<li>å½“æ‰€æœ‰ç›¸æœºåœ¨çª—å£å†…éƒ½æœ‰æ•°æ®æ—¶è§¦å‘</li>
<li>å¯¹ç¼ºå¤±å¸§è¿›è¡Œæ’å€¼æˆ–ä½¿ç”¨æœ€è¿‘é‚»</li>
<li>å®ç°è‡ªé€‚åº”çª—å£è°ƒæ•´é˜²æ­¢é¥¥é¥¿</li>
</ol>
<p>å…³é”®ä»£ç ç»“æ„ï¼š</p>
<ul>
<li>PriorityQueue æŒ‰æ—¶é—´æˆ³æ’åº</li>
<li>æ»‘åŠ¨çª—å£æ£€æŸ¥å®Œæ•´æ€§</li>
<li>æ’å€¼å™¨å¤„ç†ç¼ºå¤±æ•°æ®</li>
</ul>
</details>
<ol start="6">
<li><strong>BEV ç‰¹å¾èšåˆ</strong>
   - æ¨å¯¼ä»å¤šä¸ªç›¸æœºè§†å›¾æŠ•å½±åˆ° BEV ç©ºé—´çš„æ•°å­¦å…¬å¼
   - è€ƒè™‘ç›¸æœºå†…å¤–å‚å’Œåœ°é¢å‡è®¾
   - <em>æç¤º</em>ï¼šä½¿ç”¨é€†é€è§†å˜æ¢ï¼ˆIPMï¼‰</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æŠ•å½±å…¬å¼æ¨å¯¼ï¼š</p>
<p>ç»™å®šç›¸æœºåæ ‡ç³»ä¸­çš„ç‚¹ $P_c = [X_c, Y_c, Z_c]^T$ï¼Œä¸–ç•Œåæ ‡ç³»ä¸­çš„ç‚¹ $P_w = [X_w, Y_w, Z_w]^T$</p>
<ol>
<li>ç›¸æœºåˆ°ä¸–ç•Œï¼š$P_w = R^{-1}(P_c - t)$</li>
<li>åœ°é¢çº¦æŸï¼š$Z_w = 0$</li>
<li>BEV ç½‘æ ¼åŒ–ï¼š$[i, j] = [(X_w - X_{min})/\Delta x, (Y_w - Y_{min})/\Delta y]$</li>
<li>ç‰¹å¾èšåˆï¼š$F_{BEV}[i,j] = \sum_{k} w_k \cdot F_{cam_k}[u_k, v_k]$</li>
</ol>
<p>å…¶ä¸­æƒé‡ $w_k$ åŸºäºè§†è§’å’Œè·ç¦»è®¡ç®—</p>
</details>
<ol start="7">
<li><strong>å®æ—¶æ€§èƒ½ä¼˜åŒ–</strong>
   - ç»™å®šä¸€ä¸ªè¿è¡Œåœ¨ 25 FPS çš„æ£€æµ‹ç³»ç»Ÿï¼Œå¦‚ä½•ä¼˜åŒ–åˆ° 40 FPSï¼Ÿ
   - åˆ—å‡ºè‡³å°‘ 5 ç§ä¸åŒå±‚æ¬¡çš„ä¼˜åŒ–æ–¹æ³•
   - <em>æç¤º</em>ï¼šä»ç®—æ³•ã€å®ç°ã€ç¡¬ä»¶å¤šä¸ªè§’åº¦è€ƒè™‘</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä¼˜åŒ–ç­–ç•¥ï¼š</p>
<p>ç®—æ³•å±‚ï¼š</p>
<ol>
<li>æ¨¡å‹å‰ªæï¼šç§»é™¤ 30% ä¸é‡è¦é€šé“</li>
<li>çŸ¥è¯†è’¸é¦ï¼šç”¨å¤§æ¨¡å‹æŒ‡å¯¼å°æ¨¡å‹</li>
<li>é™ä½è¾“å…¥åˆ†è¾¨ç‡ï¼š640â†’512</li>
</ol>
<p>å®ç°å±‚ï¼š</p>
<ol start="4">
<li>CUDA Graphï¼šå‡å°‘ kernel launch å¼€é”€</li>
<li>å¤šæµå¹¶å‘ï¼šé¢„å¤„ç†/æ¨ç†/åå¤„ç†æµæ°´çº¿</li>
<li>å†…å­˜æ± ï¼šé¢„åˆ†é…é¿å…åŠ¨æ€åˆ†é…</li>
</ol>
<p>ç¡¬ä»¶å±‚ï¼š</p>
<ol start="7">
<li>TensorCore åˆ©ç”¨ï¼šç¡®ä¿ç»´åº¦å¯¹é½</li>
<li>GPU é¢‘ç‡é”å®šï¼šé¿å…åŠ¨æ€è°ƒé¢‘</li>
<li>PCIe ä¼ è¾“ä¼˜åŒ–ï¼šä½¿ç”¨ pinned memory</li>
</ol>
<p>é¢„æœŸæå‡ï¼š25 FPS â†’ 42 FPS</p>
</details>
<ol start="8">
<li><strong>å¼€æ”¾æ€§æ€è€ƒï¼šè§†è§‰ Foundation Model</strong>
   - è®¨è®ºå¦‚ä½•å°† SAMã€CLIPã€DINOv2 ç­‰è§†è§‰å¤§æ¨¡å‹é›†æˆåˆ°æœºå™¨äººç³»ç»Ÿ
   - åˆ†æè®¡ç®—èµ„æºã€å»¶è¿Ÿã€ç²¾åº¦çš„æƒè¡¡
   - <em>æç¤º</em>ï¼šè€ƒè™‘è¾¹ç¼˜-äº‘ååŒæ¶æ„</li>
</ol>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>é›†æˆæ¶æ„è®¾è®¡ï¼š</p>
<ol>
<li>
<p>åˆ†å±‚éƒ¨ç½²ï¼š
   - è¾¹ç¼˜ï¼šè½»é‡çº§æ¨¡å‹å®æ—¶è¿è¡Œ
   - äº‘ç«¯ï¼šFoundation Model æä¾›é«˜è´¨é‡ç»“æœ</p>
</li>
<li>
<p>è‡ªé€‚åº”åˆ‡æ¢ï¼š
   - ç®€å•åœºæ™¯ï¼šè¾¹ç¼˜æ¨¡å‹
   - å¤æ‚åœºæ™¯ï¼šè¯·æ±‚äº‘ç«¯
   - ç¼“å­˜æœºåˆ¶ï¼šå¤ç”¨äº‘ç«¯ç»“æœ</p>
</li>
<li>
<p>æ¨¡å‹å‹ç¼©ï¼š
   - SAMï¼šMobileSAMï¼ˆ~40MBï¼‰
   - CLIPï¼šOpenCLIP ViT-B/32
   - é‡åŒ–åˆ° INT8</p>
</li>
<li>
<p>åº”ç”¨åœºæ™¯ï¼š
   - å¼€æ”¾è¯æ±‡æ£€æµ‹
   - é›¶æ ·æœ¬åˆ†å‰²
   - è§†è§‰é—®ç­”</p>
</li>
</ol>
<p>æƒè¡¡åˆ†æï¼š</p>
<ul>
<li>å»¶è¿Ÿï¼šè¾¹ç¼˜ &lt;50msï¼Œäº‘ç«¯ 200-500ms</li>
<li>ç²¾åº¦ï¼šäº‘ç«¯é«˜ 10-15% mAP</li>
<li>æˆæœ¬ï¼šäº‘ç«¯ API è°ƒç”¨è´¹ç”¨</li>
</ul>
</details>
<h2 id="_19">å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<h3 id="1">1. å†…å­˜æ³„æ¼</h3>
<ul>
<li><strong>é—®é¢˜</strong>ï¼šGPU å†…å­˜æŒç»­å¢é•¿å¯¼è‡´ OOM</li>
<li><strong>åŸå› </strong>ï¼šæœªé‡Šæ”¾ä¸­é—´å¼ é‡ï¼Œå¾ªç¯å¼•ç”¨</li>
<li><strong>è§£å†³</strong>ï¼šä½¿ç”¨ <code>torch.no_grad()</code>ï¼ŒåŠæ—¶ <code>del</code> å¤§å¼ é‡ï¼Œç›‘æ§ <code>nvidia-smi</code></li>
</ul>
<h3 id="2">2. åæ ‡ç³»æ··æ·†</h3>
<ul>
<li><strong>é—®é¢˜</strong>ï¼š3D æ£€æµ‹æ¡†ä½ç½®é”™è¯¯</li>
<li><strong>åŸå› </strong>ï¼šç›¸æœº/æ¿€å…‰é›·è¾¾/ä¸–ç•Œåæ ‡ç³»æ··ç”¨</li>
<li><strong>è§£å†³</strong>ï¼šæ˜ç¡®å®šä¹‰åæ ‡ç³»ï¼Œç»Ÿä¸€è½¬æ¢åˆ° ROS æ ‡å‡†ï¼ˆå³æ‰‹ç³»ï¼ŒX å‰ Y å·¦ Z ä¸Šï¼‰</li>
</ul>
<h3 id="3">3. æ—¶é—´æˆ³ä¸åŒæ­¥</h3>
<ul>
<li><strong>é—®é¢˜</strong>ï¼šå¤šä¼ æ„Ÿå™¨èåˆç»“æœæŠ–åŠ¨</li>
<li><strong>åŸå› </strong>ï¼šä½¿ç”¨ç³»ç»Ÿæ—¶é—´è€Œéç¡¬ä»¶æ—¶é—´æˆ³</li>
<li><strong>è§£å†³</strong>ï¼šä½¿ç”¨ PTP åŒæ­¥ï¼Œmessage_filters åŒæ­¥è®¢é˜…</li>
</ul>
<h3 id="4">4. æ‰¹å¤„ç†æ•ˆç‡ä½</h3>
<ul>
<li><strong>é—®é¢˜</strong>ï¼šæ‰¹å¤„ç†åè€Œæ›´æ…¢</li>
<li><strong>åŸå› </strong>ï¼šåŠ¨æ€å½¢çŠ¶å¯¼è‡´é‡æ–°ç¼–è¯‘ï¼Œå°æ‰¹é‡å¼€é”€å¤§</li>
<li><strong>è§£å†³</strong>ï¼šå›ºå®šè¾“å…¥å°ºå¯¸ï¼Œåˆç†è®¾ç½®æ‰¹å¤§å°ï¼ˆé€šå¸¸ 4-8ï¼‰</li>
</ul>
<h3 id="5-tensorrt">5. TensorRT ç‰ˆæœ¬ä¸å…¼å®¹</h3>
<ul>
<li><strong>é—®é¢˜</strong>ï¼šå¼•æ“åŠ è½½å¤±è´¥</li>
<li><strong>åŸå› </strong>ï¼šæ„å»ºå’Œè¿è¡Œç¯å¢ƒ TensorRT ç‰ˆæœ¬ä¸ä¸€è‡´</li>
<li><strong>è§£å†³</strong>ï¼šå®¹å™¨åŒ–éƒ¨ç½²ï¼Œè®°å½•ç‰ˆæœ¬ä¿¡æ¯åœ¨å¼•æ“å…ƒæ•°æ®ä¸­</li>
</ul>
<h3 id="6">6. è¿‡æ‹Ÿåˆé¢„è®­ç»ƒæ•°æ®é›†</h3>
<ul>
<li><strong>é—®é¢˜</strong>ï¼šCOCO æ¨¡å‹åœ¨æœºå™¨äººåœºæ™¯è¡¨ç°å·®</li>
<li><strong>åŸå› </strong>ï¼šé¢†åŸŸå·®å¼‚å¤§ï¼ˆå®¤å†… vs å®¤å¤–ï¼‰</li>
<li><strong>è§£å†³</strong>ï¼šæ”¶é›†é¢†åŸŸæ•°æ®å¾®è°ƒï¼Œä½¿ç”¨åŸŸé€‚åº”æŠ€æœ¯</li>
</ul>
<h3 id="7">7. å®æ—¶æ€§å‡è±¡</h3>
<ul>
<li><strong>é—®é¢˜</strong>ï¼šå•å¸§å¿«ä½†æµå¤„ç†æ…¢</li>
<li><strong>åŸå› </strong>ï¼šæœªè€ƒè™‘æ•°æ®ä¼ è¾“ã€é¢„å¤„ç†æ—¶é—´</li>
<li><strong>è§£å†³</strong>ï¼šç«¯åˆ°ç«¯è®¡æ—¶ï¼ŒåŒ…æ‹¬æ‰€æœ‰ç¯èŠ‚</li>
</ul>
<h3 id="8">8. ç‚¹äº‘ç¨€ç–å¯¼è‡´æ¼æ£€</h3>
<ul>
<li><strong>é—®é¢˜</strong>ï¼šè¿œå¤„ç›®æ ‡æ£€æµ‹ç‡ä½</li>
<li><strong>åŸå› </strong>ï¼šç‚¹äº‘ç¨€ç–ï¼Œç‰¹å¾ä¸è¶³</li>
<li><strong>è§£å†³</strong>ï¼šå¤šå¸§ç´¯ç§¯ï¼Œä½¿ç”¨å›¾åƒè¡¥å……ä¿¡æ¯</li>
</ul>
<h2 id="_20">æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_21">è®¾è®¡é˜¶æ®µ</h3>
<ul>
<li>[ ] <strong>éœ€æ±‚åˆ†æ</strong>ï¼šæ˜ç¡®ç²¾åº¦ã€é€Ÿåº¦ã€èµ„æºçº¦æŸ</li>
<li>[ ] <strong>ä¼ æ„Ÿå™¨é€‰æ‹©</strong>ï¼šç›¸æœºåˆ†è¾¨ç‡ã€å¸§ç‡ã€è§†åœºè§’åŒ¹é…ä»»åŠ¡éœ€æ±‚</li>
<li>[ ] <strong>æ¨¡å‹é€‰å‹</strong>ï¼šåŸºäºåŸºå‡†æµ‹è¯•é€‰æ‹©ï¼Œä¸ç›²ç›®è¿½æ–°</li>
<li>[ ] <strong>æ•°æ®è§„åˆ’</strong>ï¼šä¼°ç®—æ•°æ®é‡ï¼Œè®¾è®¡æ ‡æ³¨æµç¨‹</li>
<li>[ ] <strong>è¯„ä¼°æŒ‡æ ‡</strong>ï¼šå®šä¹‰ä¸ä»»åŠ¡ç›¸å…³çš„æŒ‡æ ‡ï¼ˆä¸åªæ˜¯ mAPï¼‰</li>
</ul>
<h3 id="_22">å¼€å‘é˜¶æ®µ</h3>
<ul>
<li>[ ] <strong>æ¨¡å—åŒ–è®¾è®¡</strong>ï¼šæ£€æµ‹ã€è·Ÿè¸ªã€åˆ†å‰²æ¨¡å—è§£è€¦</li>
<li>[ ] <strong>é…ç½®ç®¡ç†</strong>ï¼šä½¿ç”¨ YAML/JSON ç®¡ç†è¶…å‚æ•°</li>
<li>[ ] <strong>ç‰ˆæœ¬æ§åˆ¶</strong>ï¼šæ¨¡å‹ã€æ•°æ®ã€ä»£ç ç‰ˆæœ¬å¯¹åº”</li>
<li>[ ] <strong>å•å…ƒæµ‹è¯•</strong>ï¼šå…³é”®ç»„ä»¶çš„å•å…ƒæµ‹è¯•è¦†ç›–</li>
<li>[ ] <strong>æ€§èƒ½ç›‘æ§</strong>ï¼šé›†æˆ profilerï¼Œç›‘æ§å…³é”®è·¯å¾„</li>
</ul>
<h3 id="_23">ä¼˜åŒ–é˜¶æ®µ</h3>
<ul>
<li>[ ] <strong>æ¸è¿›ä¼˜åŒ–</strong>ï¼šå…ˆå®ç°åŠŸèƒ½ï¼Œå†ä¼˜åŒ–æ€§èƒ½</li>
<li>[ ] <strong>é‡åŒ–è¯„ä¼°</strong>ï¼šINT8 é‡åŒ–å‰åç²¾åº¦å¯¹æ¯”</li>
<li>[ ] <strong>æ‰¹å¤„ç†ç­–ç•¥</strong>ï¼šæ ¹æ®ç¡¬ä»¶ç¡®å®šæœ€ä¼˜æ‰¹å¤§å°</li>
<li>[ ] <strong>å†…å­˜ç®¡ç†</strong>ï¼šä½¿ç”¨å†…å­˜æ± ï¼Œé¿å…ç¢ç‰‡åŒ–</li>
<li>[ ] <strong>å¹¶è¡ŒåŒ–</strong>ï¼šæ•°æ®å¹¶è¡Œã€æ¨¡å‹å¹¶è¡Œã€æµæ°´çº¿å¹¶è¡Œ</li>
</ul>
<h3 id="_24">éƒ¨ç½²é˜¶æ®µ</h3>
<ul>
<li>[ ] <strong>é²æ£’æ€§æµ‹è¯•</strong>ï¼šè¾¹ç•Œæƒ…å†µã€å¼‚å¸¸è¾“å…¥</li>
<li>[ ] <strong>é™çº§ç­–ç•¥</strong>ï¼šæ¨¡å‹åŠ è½½å¤±è´¥çš„ fallback</li>
<li>[ ] <strong>ç›‘æ§å‘Šè­¦</strong>ï¼šå»¶è¿Ÿã€ååé‡ã€é”™è¯¯ç‡ç›‘æ§</li>
<li>[ ] <strong>A/B æµ‹è¯•</strong>ï¼šæ–°æ¨¡å‹ç°åº¦å‘å¸ƒ</li>
<li>[ ] <strong>æ–‡æ¡£å®Œå–„</strong>ï¼šAPI æ–‡æ¡£ã€éƒ¨ç½²æŒ‡å—ã€æ•…éšœæ’æŸ¥</li>
</ul>
<h3 id="_25">ç»´æŠ¤é˜¶æ®µ</h3>
<ul>
<li>[ ] <strong>æŒç»­å­¦ä¹ </strong>ï¼šæ”¶é›† corner caseï¼Œå®šæœŸé‡è®­ç»ƒ</li>
<li>[ ] <strong>æ€§èƒ½å›å½’</strong>ï¼šè‡ªåŠ¨åŒ–æµ‹è¯•é˜²æ­¢æ€§èƒ½é€€åŒ–</li>
<li>[ ] <strong>å®‰å…¨æ›´æ–°</strong>ï¼šåŠæ—¶æ›´æ–°ä¾èµ–åº“å®‰å…¨è¡¥ä¸</li>
<li>[ ] <strong>ç”¨æˆ·åé¦ˆ</strong>ï¼šå»ºç«‹åé¦ˆæ¸ é“ï¼Œå¿«é€Ÿå“åº”</li>
<li>[ ] <strong>çŸ¥è¯†æ²‰æ·€</strong>ï¼šè®°å½•è¸©å‘ç»éªŒï¼Œæ›´æ–°æœ€ä½³å®è·µ</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter18.html" class="nav-link prev">â† ç¬¬ 18 ç« ï¼šå¤šæœºå™¨äººç³»ç»Ÿ</a><a href="chapter20.html" class="nav-link next">ç¬¬ 20 ç« ï¼šæœºå™¨äººå¼ºåŒ–å­¦ä¹  â†’</a></nav>
        </main>
    </div>
</body>
</html>