<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬ 8 ç« ï¼štf2 åæ ‡å˜æ¢æ¡†æ¶</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ROS2 å®Œå…¨æ•™ç¨‹ï¼šä»åŸç†åˆ°å®è·µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 1 ç« ï¼šROS1 æ ¸å¿ƒæ¦‚å¿µå›é¡¾</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 2 ç« ï¼šROS1 çš„å±€é™æ€§åˆ†æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 3 ç« ï¼šä» ROS1 åˆ° ROS2 çš„è¿ç§»ç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 4 ç« ï¼šROS2 æ¶æ„ä¸è®¾è®¡ç†å¿µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 5 ç« ï¼šèŠ‚ç‚¹ä¸æ‰§è¡Œå™¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 6 ç« ï¼šé€šä¿¡æœºåˆ¶æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 7 ç« ï¼šLaunch ç³»ç»Ÿä¸é…ç½®ç®¡ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 8 ç« ï¼štf2 åæ ‡å˜æ¢æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 9 ç« ï¼šæ—¶é—´åŒæ­¥ä¸å›æ”¾ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 10 ç« ï¼šä¼ æ„Ÿå™¨æ•°æ®å¤„ç†ç®¡é“</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 11 ç« ï¼šSLAM ä¸å®šä½ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 12 ç« ï¼šå¯¼èˆªæ ˆ Nav2</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 13 ç« ï¼šros2_control æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 14 ç« ï¼šMoveIt2 è¿åŠ¨è§„åˆ’</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 15 ç« ï¼šå®æ—¶ç³»ç»Ÿä¸æ€§èƒ½ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 16 ç« ï¼šå®‰å…¨æ€§ä¸è¯Šæ–­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 17 ç« ï¼šä»¿çœŸé›†æˆï¼ˆGazebo/Ignitionï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 18 ç« ï¼šå¤šæœºå™¨äººç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 19 ç« ï¼šè®¡ç®—æœºè§†è§‰ä¸æ·±åº¦å­¦ä¹ </span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 20 ç« ï¼šæœºå™¨äººå¼ºåŒ–å­¦ä¹ </span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 21 ç« ï¼šå¤§è¯­è¨€æ¨¡å‹ä¸å…·èº«æ™ºèƒ½</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 22 ç« ï¼šç¥ç»ç½‘ç»œè¿åŠ¨æ§åˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="8-tf2">ç¬¬ 8 ç« ï¼štf2 åæ ‡å˜æ¢æ¡†æ¶</h1>
<p>tf2ï¼ˆTransform Framework 2ï¼‰æ˜¯ ROS2 ä¸­å¤„ç†åæ ‡å˜æ¢çš„æ ¸å¿ƒæ¡†æ¶ï¼Œå®ƒç®¡ç†ç€æœºå™¨äººç³»ç»Ÿä¸­æ‰€æœ‰åæ ‡ç³»ä¹‹é—´çš„å…³ç³»ã€‚å¯¹äºä»»ä½•æ¶‰åŠç©ºé—´ä½ç½®å’Œå§¿æ€çš„æœºå™¨äººåº”ç”¨ï¼Œtf2 éƒ½æ˜¯ä¸å¯æˆ–ç¼ºçš„åŸºç¡€è®¾æ–½ã€‚æœ¬ç« å°†æ·±å…¥æ¢è®¨ tf2 çš„è®¾è®¡åŸç†ã€å®ç°æœºåˆ¶ï¼Œä»¥åŠåœ¨å¤æ‚æœºå™¨äººç³»ç»Ÿä¸­çš„é«˜çº§åº”ç”¨æŠ€å·§ã€‚</p>
<h2 id="81">8.1 åæ ‡ç³»æ ‘ç»“æ„è®¾è®¡</h2>
<h3 id="811-tf2">8.1.1 tf2 æ ‘çš„åŸºæœ¬æ¦‚å¿µ</h3>
<p>tf2 å°†æœºå™¨äººç³»ç»Ÿä¸­çš„æ‰€æœ‰åæ ‡ç³»ç»„ç»‡æˆä¸€æ£µæ ‘çŠ¶ç»“æ„ï¼Œæ¯ä¸ªåæ ‡ç³»ä½œä¸ºæ ‘çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåæ ‡ç³»ä¹‹é—´çš„å˜æ¢å…³ç³»ä½œä¸ºè¾¹ã€‚è¿™ç§è®¾è®¡ä¿è¯äº†ä»»æ„ä¸¤ä¸ªåæ ‡ç³»ä¹‹é—´éƒ½å­˜åœ¨å”¯ä¸€çš„å˜æ¢è·¯å¾„ã€‚</p>
<div class="codehilite"><pre><span></span><code><span class="w">                    </span><span class="n">map</span>
<span class="w">                     </span><span class="o">|</span>
<span class="w">                  </span><span class="n">odom</span>
<span class="w">                     </span><span class="o">|</span>
<span class="w">                </span><span class="n">base_link</span>
<span class="w">                </span><span class="o">/</span><span class="w">    </span><span class="o">|</span><span class="w">    </span><span class="err">\</span>
<span class="w">        </span><span class="n">laser_link</span><span class="w">  </span><span class="n">imu</span><span class="w">  </span><span class="n">camera_link</span>
<span class="w">                          </span><span class="o">/</span><span class="w">        </span><span class="err">\</span>
<span class="w">                   </span><span class="n">optical_frame</span><span class="w">  </span><span class="n">depth_frame</span>
</code></pre></div>

<p>æ ‘ç»“æ„çš„æ ¸å¿ƒç‰¹æ€§ï¼š</p>
<ul>
<li><strong>æ— ç¯æ€§</strong>ï¼šä¸å…è®¸å½¢æˆç¯è·¯ï¼Œä¿è¯å˜æ¢è·¯å¾„å”¯ä¸€</li>
<li><strong>è¿é€šæ€§</strong>ï¼šæ‰€æœ‰åæ ‡ç³»å¿…é¡»è¿æ¥åˆ°åŒä¸€æ£µæ ‘ä¸Š</li>
<li><strong>æœ‰å‘æ€§</strong>ï¼šæ¯ä¸ªå˜æ¢éƒ½æœ‰æ˜ç¡®çš„çˆ¶å­å…³ç³»</li>
</ul>
<h3 id="812">8.1.2 åæ ‡ç³»å‘½åè§„èŒƒ</h3>
<p>ROS2 ç¤¾åŒºå½¢æˆäº†ä¸€å¥—æ ‡å‡†çš„åæ ‡ç³»å‘½åè§„èŒƒï¼ˆREP 105ï¼‰ï¼š</p>
<p>| åæ ‡ç³»åç§° | å«ä¹‰ | ç‰¹ç‚¹ |</p>
<table>
<thead>
<tr>
<th>åæ ‡ç³»åç§°</th>
<th>å«ä¹‰</th>
<th>ç‰¹ç‚¹</th>
</tr>
</thead>
<tbody>
<tr>
<td>map</td>
<td>å…¨å±€å›ºå®šåæ ‡ç³»</td>
<td>ä¸éšæ—¶é—´æ¼‚ç§»ï¼Œç”¨äºå…¨å±€å®šä½</td>
</tr>
<tr>
<td>odom</td>
<td>é‡Œç¨‹è®¡åæ ‡ç³»</td>
<td>è¿ç»­ä½†å¯èƒ½æ¼‚ç§»ï¼Œç”¨äºå±€éƒ¨è¿åŠ¨ä¼°è®¡</td>
</tr>
<tr>
<td>base_link</td>
<td>æœºå™¨äººæœ¬ä½“åæ ‡ç³»</td>
<td>åˆšæ€§é™„ç€åœ¨æœºå™¨äººåº•ç›˜ä¸Š</td>
</tr>
<tr>
<td>base_footprint</td>
<td>æœºå™¨äººæŠ•å½±åæ ‡ç³»</td>
<td>base_link åœ¨åœ°é¢çš„ 2D æŠ•å½±</td>
</tr>
<tr>
<td>sensor_frame</td>
<td>ä¼ æ„Ÿå™¨åæ ‡ç³»</td>
<td>å„ç±»ä¼ æ„Ÿå™¨çš„æµ‹é‡å‚è€ƒç³»</td>
</tr>
</tbody>
</table>
<h3 id="813">8.1.3 å˜æ¢çš„æ•°å­¦è¡¨ç¤º</h3>
<p>åæ ‡å˜æ¢åœ¨ tf2 ä¸­ä½¿ç”¨é½æ¬¡å˜æ¢çŸ©é˜µè¡¨ç¤ºï¼š</p>
<p>$$
T = \begin{bmatrix}
R &amp; t \\
0 &amp; 1
\end{bmatrix} = \begin{bmatrix}
r_{11} &amp; r_{12} &amp; r_{13} &amp; t_x \\
r_{21} &amp; r_{22} &amp; r_{23} &amp; t_y \\
r_{31} &amp; r_{32} &amp; r_{33} &amp; t_z \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}
$$</p>
<p>å…¶ä¸­ $R \in SO(3)$ æ˜¯æ—‹è½¬çŸ©é˜µï¼Œ$t \in \mathbb{R}^3$ æ˜¯å¹³ç§»å‘é‡ã€‚</p>
<p>å››å…ƒæ•°è¡¨ç¤ºæ³•æ›´å¸¸ç”¨äºé¿å…ä¸‡å‘é”é—®é¢˜ï¼š</p>
<p>$$
q = w + xi + yj + zk, \quad |q| = 1
$$</p>
<h3 id="814-tf2">8.1.4 tf2 æ ‘çš„æ„å»ºç­–ç•¥</h3>
<p>è®¾è®¡ tf æ ‘æ—¶éœ€è¦è€ƒè™‘ä»¥ä¸‹åŸåˆ™ï¼š</p>
<ol>
<li><strong>å±‚æ¬¡æ¸…æ™°</strong>ï¼šä»å…¨å±€åˆ°å±€éƒ¨ï¼Œä»å›ºå®šåˆ°ç§»åŠ¨</li>
<li><strong>è¯­ä¹‰æ˜ç¡®</strong>ï¼šåæ ‡ç³»å‘½ååæ˜ å…¶ç‰©ç†æ„ä¹‰</li>
<li><strong>æœ€å°æ·±åº¦</strong>ï¼šå‡å°‘å˜æ¢é“¾é•¿åº¦ï¼Œé™ä½ç´¯ç§¯è¯¯å·®</li>
<li><strong>æ›´æ–°é¢‘ç‡åŒ¹é…</strong>ï¼šç›¸ä¼¼æ›´æ–°é¢‘ç‡çš„å˜æ¢æ”¾åœ¨åŒä¸€å±‚çº§</li>
</ol>
<p>å…¸å‹çš„ç§»åŠ¨æœºå™¨äºº tf æ ‘è®¾è®¡ï¼š</p>
<div class="codehilite"><pre><span></span><code>Level 0: map                    (å›ºå®šï¼Œå…¨å±€å‚è€ƒ)
Level 1: odom                   (10-100 Hz æ›´æ–°)
Level 2: base_link              (ä¸ odom åŒæ­¥)
Level 3: sensor frames          (å„ä¼ æ„Ÿå™¨é¢‘ç‡)
Level 4: actuator frames        (é«˜é¢‘æ§åˆ¶ç›¸å…³)
</code></pre></div>

<h2 id="82">8.2 é™æ€ä¸åŠ¨æ€å˜æ¢</h2>
<h3 id="821">8.2.1 é™æ€å˜æ¢å‘å¸ƒå™¨</h3>
<p>é™æ€å˜æ¢æè¿°å›ºå®šä¸å˜çš„åæ ‡ç³»å…³ç³»ï¼Œé€šå¸¸ç”¨äºä¼ æ„Ÿå™¨å®‰è£…ä½ç½®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">tf2_ros</span><span class="w"> </span><span class="kn">import</span> <span class="n">StaticTransformBroadcaster</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">geometry_msgs.msg</span><span class="w"> </span><span class="kn">import</span> <span class="n">TransformStamped</span>

<span class="k">class</span><span class="w"> </span><span class="nc">StaticTFPublisher</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;static_tf_publisher&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">broadcaster</span> <span class="o">=</span> <span class="n">StaticTransformBroadcaster</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># å‘å¸ƒæ¿€å…‰é›·è¾¾ç›¸å¯¹äºæœºå™¨äººåº•ç›˜çš„å›ºå®šå˜æ¢</span>
        <span class="n">static_tf</span> <span class="o">=</span> <span class="n">TransformStamped</span><span class="p">()</span>
        <span class="n">static_tf</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="s1">&#39;base_link&#39;</span>
        <span class="n">static_tf</span><span class="o">.</span><span class="n">child_frame_id</span> <span class="o">=</span> <span class="s1">&#39;laser_link&#39;</span>

        <span class="c1"># è®¾ç½®å¹³ç§»ï¼šæ¿€å…‰é›·è¾¾åœ¨åº•ç›˜å‰æ–¹ 0.3mï¼Œä¸Šæ–¹ 0.2m</span>
        <span class="n">static_tf</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="mf">0.3</span>
        <span class="n">static_tf</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="mf">0.2</span>

        <span class="c1"># è®¾ç½®æ—‹è½¬ï¼šæ— æ—‹è½¬</span>
        <span class="n">static_tf</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">broadcaster</span><span class="o">.</span><span class="n">sendTransform</span><span class="p">(</span><span class="n">static_tf</span><span class="p">)</span>
</code></pre></div>

<p>é™æ€å˜æ¢çš„ä¼˜åŒ–ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>/tf_static</code> è¯é¢˜ï¼Œåªå‘å¸ƒä¸€æ¬¡</li>
<li>è®¢é˜…è€…è‡ªåŠ¨ç¼“å­˜ï¼Œæ— éœ€é‡å¤ä¼ è¾“</li>
<li>æ”¯æŒæ‰¹é‡å‘å¸ƒå¤šä¸ªé™æ€å˜æ¢</li>
</ul>
<h3 id="822">8.2.2 åŠ¨æ€å˜æ¢å‘å¸ƒå™¨</h3>
<p>åŠ¨æ€å˜æ¢ç”¨äºéšæ—¶é—´å˜åŒ–çš„åæ ‡ç³»å…³ç³»ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">tf2_ros</span><span class="w"> </span><span class="kn">import</span> <span class="n">TransformBroadcaster</span>

<span class="k">class</span><span class="w"> </span><span class="nc">DynamicTFPublisher</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;dynamic_tf_publisher&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">broadcaster</span> <span class="o">=</span> <span class="n">TransformBroadcaster</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">timer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">broadcast_timer_callback</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">broadcast_timer_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">TransformStamped</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_clock</span><span class="p">()</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">to_msg</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="s1">&#39;odom&#39;</span>
        <span class="n">t</span><span class="o">.</span><span class="n">child_frame_id</span> <span class="o">=</span> <span class="s1">&#39;base_link&#39;</span>

        <span class="c1"># ä»é‡Œç¨‹è®¡æˆ–å®šä½ç³»ç»Ÿè·å–å½“å‰ä½å§¿</span>
        <span class="n">t</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_x_position</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_y_position</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="n">transform</span><span class="o">.</span><span class="n">rotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_quaternion</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">broadcaster</span><span class="o">.</span><span class="n">sendTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</code></pre></div>

<h3 id="823">8.2.3 å˜æ¢ç¼“å†²åŒºä¸ç›‘å¬å™¨</h3>
<p>tf2 ä½¿ç”¨ç¼“å†²åŒºå­˜å‚¨å†å²å˜æ¢ï¼Œæ”¯æŒæ—¶é—´æŸ¥è¯¢ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">tf2_ros</span><span class="w"> </span><span class="kn">import</span> <span class="n">Buffer</span><span class="p">,</span> <span class="n">TransformListener</span>

<span class="k">class</span><span class="w"> </span><span class="nc">TFSubscriber</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;tf_subscriber&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span> <span class="o">=</span> <span class="n">Buffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_listener</span> <span class="o">=</span> <span class="n">TransformListener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">lookup_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_frame</span><span class="p">,</span> <span class="n">source_frame</span><span class="p">,</span> <span class="n">time_point</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># æŸ¥è¯¢ç‰¹å®šæ—¶åˆ»çš„å˜æ¢</span>
            <span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span><span class="o">.</span><span class="n">lookup_transform</span><span class="p">(</span>
                <span class="n">target_frame</span><span class="p">,</span> 
                <span class="n">source_frame</span><span class="p">,</span>
                <span class="n">time_point</span><span class="p">,</span>
                <span class="n">timeout</span><span class="o">=</span><span class="n">Duration</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">transform</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">LookupException</span><span class="p">,</span> <span class="n">ConnectivityException</span><span class="p">,</span> 
                <span class="n">ExtrapolationException</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;TF lookup failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>

<h3 id="824">8.2.4 å˜æ¢é“¾çš„ç»„åˆ</h3>
<p>tf2 è‡ªåŠ¨å¤„ç†å˜æ¢é“¾çš„ç»„åˆï¼Œé€šè¿‡çŸ©é˜µä¹˜æ³•è®¡ç®—é—´æ¥å˜æ¢ï¼š</p>
<p>$$
T_{AC} = T_{AB} \cdot T_{BC}
$$</p>
<p>å¯¹äºé•¿å˜æ¢é“¾ï¼Œç´¯ç§¯è¯¯å·®åˆ†æï¼š</p>
<p>$$
\delta T_{total} \approx \sum_{i=1}^{n} J_i \cdot \delta T_i
$$</p>
<p>å…¶ä¸­ $J_i$ æ˜¯ç¬¬ i ä¸ªå˜æ¢çš„é›…å¯æ¯”çŸ©é˜µã€‚</p>
<h2 id="83">8.3 æ—¶é—´åŒæ­¥ä¸å¤–æ¨</h2>
<h3 id="831">8.3.1 æ—¶é—´æˆ³ç®¡ç†</h3>
<p>tf2 ä¸­æ¯ä¸ªå˜æ¢éƒ½å¸¦æœ‰æ—¶é—´æˆ³ï¼Œç¡®ä¿æ—¶é—´ä¸€è‡´æ€§ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TimeSyncedTF</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;time_synced_tf&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span> <span class="o">=</span> <span class="n">Buffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_listener</span> <span class="o">=</span> <span class="n">TransformListener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_synchronized_transforms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frames</span><span class="p">,</span> <span class="n">sync_time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è·å–åŒä¸€æ—¶åˆ»çš„å¤šä¸ªå˜æ¢&quot;&quot;&quot;</span>
        <span class="n">transforms</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">source</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">frames</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span><span class="o">.</span><span class="n">lookup_transform</span><span class="p">(</span>
                    <span class="n">target</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">sync_time</span><span class="p">)</span>
                <span class="n">transforms</span><span class="p">[(</span><span class="n">source</span><span class="p">,</span> <span class="n">target</span><span class="p">)]</span> <span class="o">=</span> <span class="n">tf</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>  <span class="c1"># ä»»ä¸€å˜æ¢å¤±è´¥åˆ™æ•´ä½“å¤±è´¥</span>
        <span class="k">return</span> <span class="n">transforms</span>
</code></pre></div>

<h3 id="832">8.3.2 å˜æ¢å¤–æ¨ç®—æ³•</h3>
<p>å½“è¯·æ±‚çš„æ—¶é—´ç‚¹æ²¡æœ‰ç²¾ç¡®çš„å˜æ¢æ•°æ®æ—¶ï¼Œtf2 ä½¿ç”¨å¤–æ¨ç®—æ³•ï¼š</p>
<p>çº¿æ€§å¤–æ¨ï¼ˆçŸ­æ—¶é—´ï¼‰ï¼š
$$
T(t) = T(t_0) + \frac{dT}{dt}|_{t_0} \cdot (t - t_0)
$$</p>
<p>é€Ÿåº¦ä¼°è®¡ï¼š
$$
v = \frac{p(t_1) - p(t_0)}{t_1 - t_0}
$$</p>
<p>è§’é€Ÿåº¦ä¼°è®¡ï¼ˆä½¿ç”¨å››å…ƒæ•°ï¼‰ï¼š
$$
\omega = \frac{2}{t_1 - t_0} \log(q(t_0)^{-1} \cdot q(t_1))
$$</p>
<h3 id="833">8.3.3 ç¼“å†²åŒºé…ç½®</h3>
<p>ä¼˜åŒ–ç¼“å†²åŒºä»¥å¹³è¡¡å†…å­˜å’ŒæŸ¥è¯¢æ€§èƒ½ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">rclpy.duration</span><span class="w"> </span><span class="kn">import</span> <span class="n">Duration</span>

<span class="k">class</span><span class="w"> </span><span class="nc">OptimizedTFBuffer</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;optimized_tf_buffer&#39;</span><span class="p">)</span>
        <span class="c1"># è‡ªå®šä¹‰ç¼“å†²åŒºå¤§å°å’Œæ—¶é—´çª—å£</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span> <span class="o">=</span> <span class="n">Buffer</span><span class="p">(</span>
            <span class="n">cache_time</span><span class="o">=</span><span class="n">Duration</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mf">10.0</span><span class="p">))</span>  <span class="c1"># ä¿ç•™10ç§’å†å²</span>

        <span class="c1"># è®¾ç½®å˜æ¢å®¹å·®</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span><span class="o">.</span><span class="n">set_transform_tolerance</span><span class="p">(</span><span class="n">Duration</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mf">0.1</span><span class="p">))</span>
</code></pre></div>

<h3 id="834">8.3.4 é«˜é¢‘å˜æ¢ä¼˜åŒ–</h3>
<p>å¯¹äºé«˜é¢‘æ›´æ–°çš„å˜æ¢ï¼Œä½¿ç”¨ä¸“é—¨çš„ä¼˜åŒ–ç­–ç•¥ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HighFrequencyTF</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;high_freq_tf&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">broadcaster</span> <span class="o">=</span> <span class="n">TransformBroadcaster</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># ä½¿ç”¨å›ºå®šå¤§å°çš„å¾ªç¯ç¼“å†²åŒº</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform_queue</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

        <span class="c1"># æ‰¹é‡å‘å¸ƒå‡å°‘å¼€é”€</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span> <span class="o">=</span> <span class="mi">10</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">batch_buffer</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">publish_transform_batch</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transforms</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ‰¹é‡å‘å¸ƒå˜æ¢ä»¥å‡å°‘é€šä¿¡å¼€é”€&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_buffer</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">batch_size</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">broadcaster</span><span class="o">.</span><span class="n">sendTransform</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">batch_buffer</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_buffer</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">batch_buffer</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">transforms</span><span class="p">)</span>
</code></pre></div>

<h2 id="84">8.4 å¤šæœºå™¨äººåæ ‡ç³»ç®¡ç†</h2>
<h3 id="841">8.4.1 å‘½åç©ºé—´éš”ç¦»</h3>
<p>å¤šæœºå™¨äººç³»ç»Ÿä¸­ä½¿ç”¨å‘½åç©ºé—´é¿å…åæ ‡ç³»å†²çªï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MultiRobotTF</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot_id</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;robot_</span><span class="si">{</span><span class="n">robot_id</span><span class="si">}</span><span class="s1">_tf&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">robot_ns</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;/robot_</span><span class="si">{</span><span class="n">robot_id</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="c1"># å‘å¸ƒå¸¦å‘½åç©ºé—´çš„å˜æ¢</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">broadcaster</span> <span class="o">=</span> <span class="n">TransformBroadcaster</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">publish_robot_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">TransformStamped</span><span class="p">()</span>
        <span class="n">t</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">frame_id</span> <span class="o">=</span> <span class="s1">&#39;map&#39;</span>  <span class="c1"># å…±äº«çš„å…¨å±€åæ ‡ç³»</span>
        <span class="n">t</span><span class="o">.</span><span class="n">child_frame_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_ns</span><span class="si">}</span><span class="s1">/base_link&#39;</span>
        <span class="c1"># ... è®¾ç½®å˜æ¢</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">broadcaster</span><span class="o">.</span><span class="n">sendTransform</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
</code></pre></div>

<h3 id="842">8.4.2 åæ ‡ç³»å¯¹é½</h3>
<p>å¤šæœºå™¨äººç³»ç»Ÿä¸­çš„åæ ‡ç³»å¯¹é½ç­–ç•¥ï¼š</p>
<ol>
<li><strong>å…±äº«å…¨å±€åæ ‡ç³»</strong>ï¼šæ‰€æœ‰æœºå™¨äººä½¿ç”¨åŒä¸€ä¸ª map åæ ‡ç³»</li>
<li><strong>ç›¸å¯¹å®šä½</strong>ï¼šæœºå™¨äººä¹‹é—´é€šè¿‡è§†è§‰æˆ–é€šä¿¡è¿›è¡Œç›¸å¯¹å®šä½</li>
<li><strong>åŠ¨æ€å¯¹é½</strong>ï¼šè¿è¡Œæ—¶é€šè¿‡ç‰¹å¾åŒ¹é…å¯¹é½åæ ‡ç³»</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CoordinateAlignment</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">align_robot_frames</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot1_ns</span><span class="p">,</span> <span class="n">robot2_ns</span><span class="p">,</span> <span class="n">landmarks</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åŸºäºå…±åŒåœ°æ ‡å¯¹é½ä¸¤ä¸ªæœºå™¨äººçš„åæ ‡ç³»&quot;&quot;&quot;</span>
        <span class="c1"># è·å–ä¸¤ä¸ªæœºå™¨äººè§‚æµ‹åˆ°çš„åœ°æ ‡ä½ç½®</span>
        <span class="n">landmarks_r1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_landmarks_in_frame</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">robot1_ns</span><span class="si">}</span><span class="s1">/base_link&#39;</span><span class="p">,</span> <span class="n">landmarks</span><span class="p">)</span>
        <span class="n">landmarks_r2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_landmarks_in_frame</span><span class="p">(</span>
            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">robot2_ns</span><span class="si">}</span><span class="s1">/base_link&#39;</span><span class="p">,</span> <span class="n">landmarks</span><span class="p">)</span>

        <span class="c1"># ä½¿ç”¨ ICP æˆ–å…¶ä»–é…å‡†ç®—æ³•è®¡ç®—å¯¹é½å˜æ¢</span>
        <span class="n">alignment_tf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_alignment</span><span class="p">(</span><span class="n">landmarks_r1</span><span class="p">,</span> <span class="n">landmarks_r2</span><span class="p">)</span>

        <span class="c1"># å‘å¸ƒå¯¹é½å˜æ¢</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">publish_alignment_transform</span><span class="p">(</span><span class="n">robot1_ns</span><span class="p">,</span> <span class="n">robot2_ns</span><span class="p">,</span> <span class="n">alignment_tf</span><span class="p">)</span>
</code></pre></div>

<h3 id="843-tf">8.4.3 åˆ†å¸ƒå¼ tf ç³»ç»Ÿ</h3>
<p>å¤§è§„æ¨¡å¤šæœºå™¨äººç³»ç»Ÿçš„åˆ†å¸ƒå¼ tf æ¶æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Robot 1 TF     â”‚     â”‚  Robot 2 TF     â”‚
â”‚  - local tree   â”‚     â”‚  - local tree   â”‚
â”‚  - /robot1/*    â”‚     â”‚  - /robot2/*    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  Global TF     â”‚
         â”‚  Coordinator   â”‚
         â”‚  - /map        â”‚
         â”‚  - alignment   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="844">8.4.4 æ—¶é’ŸåŒæ­¥åè®®</h3>
<p>å¤šæœºå™¨äººç³»ç»Ÿä¸­çš„æ—¶é—´åŒæ­¥ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ClockSynchronizer</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;clock_synchronizer&#39;</span><span class="p">)</span>
        <span class="c1"># NTP/PTP æ—¶é—´åŒæ­¥</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time_offset</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clock_skew</span> <span class="o">=</span> <span class="mf">1.0</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">correct_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">remote_time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ ¡æ­£è¿œç¨‹æœºå™¨äººçš„æ—¶é—´æˆ³&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">remote_time</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">time_offset</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">clock_skew</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">estimate_clock_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">time_pairs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åŸºäºå¾€è¿”æ—¶é—´ä¼°è®¡æ—¶é’Ÿå‚æ•°&quot;&quot;&quot;</span>
        <span class="c1"># ä½¿ç”¨æœ€å°äºŒä¹˜æ³•ä¼°è®¡offsetå’Œskew</span>
        <span class="k">pass</span>
</code></pre></div>

<h2 id="85-kuka">8.5 äº§ä¸šæ¡ˆä¾‹ç ”ç©¶ï¼šKUKA åŒè‡‚æœºå™¨äººåæ ‡åŒæ­¥</h2>
<h3 id="851">8.5.1 ç³»ç»Ÿæ¶æ„æ¦‚è¿°</h3>
<p>KUKA iiwa åŒè‡‚åä½œç³»ç»Ÿæ˜¯å·¥ä¸š 4.0 çš„å…¸å‹åº”ç”¨ï¼Œä¸¤ä¸ª 7 è‡ªç”±åº¦æœºæ¢°è‡‚éœ€è¦ç²¾ç¡®çš„åæ ‡åŒæ­¥æ¥å®Œæˆè£…é…ä»»åŠ¡ã€‚è¯¥ç³»ç»Ÿçš„ tf2 æ¶æ„è®¾è®¡å……åˆ†è€ƒè™‘äº†é«˜ç²¾åº¦ã€ä½å»¶è¿Ÿå’Œå®¹é”™æ€§è¦æ±‚ã€‚</p>
<p>ç³»ç»Ÿè§„æ ¼ï¼š</p>
<ul>
<li>ä¸¤ä¸ª KUKA LBR iiwa 14 R820 æœºæ¢°è‡‚</li>
<li>ä½ç½®é‡å¤ç²¾åº¦ï¼šÂ±0.1mm</li>
<li>åŠ›æ§ç²¾åº¦ï¼šÂ±2N</li>
<li>æ§åˆ¶é¢‘ç‡ï¼š1000Hz</li>
<li>é€šä¿¡å»¶è¿Ÿï¼š&lt;1msï¼ˆEtherCATï¼‰</li>
</ul>
<h3 id="852">8.5.2 åæ ‡ç³»å±‚æ¬¡è®¾è®¡</h3>
<div class="codehilite"><pre><span></span><code><span class="w">                        </span><span class="n">world</span>
<span class="w">                    </span><span class="o">/</span><span class="w">           </span>\
<span class="w">            </span><span class="n">robot1_base</span><span class="w">      </span><span class="n">robot2_base</span>
<span class="w">                </span><span class="o">|</span><span class="w">                 </span><span class="o">|</span>
<span class="w">          </span><span class="n">robot1_link_0</span><span class="w">      </span><span class="n">robot2_link_0</span>
<span class="w">                </span><span class="o">|</span><span class="w">                 </span><span class="o">|</span>
<span class="w">              </span><span class="o">...</span><span class="w">               </span><span class="o">...</span>
<span class="w">                </span><span class="o">|</span><span class="w">                 </span><span class="o">|</span>
<span class="w">          </span><span class="n">robot1_link_7</span><span class="w">      </span><span class="n">robot2_link_7</span>
<span class="w">                </span><span class="o">|</span><span class="w">                 </span><span class="o">|</span>
<span class="w">          </span><span class="n">robot1_tool</span><span class="w">        </span><span class="n">robot2_tool</span>
<span class="w">                </span>\<span class="w">               </span><span class="o">/</span>
<span class="w">                  </span><span class="n">workpiece_frame</span>
</code></pre></div>

<p>å…³é”®è®¾è®¡å†³ç­–ï¼š</p>
<ol>
<li><strong>åŒåŸºåº§æ ‡å®š</strong>ï¼šä½¿ç”¨æ¿€å…‰è·Ÿè¸ªä»ªç²¾ç¡®æ ‡å®šä¸¤ä¸ªæœºå™¨äººåŸºåº§çš„ç›¸å¯¹ä½ç½®</li>
<li><strong>å·¥å…·ä¸­å¿ƒç‚¹(TCP)æ ¡å‡†</strong>ï¼šä½¿ç”¨å››ç‚¹æ³•ç¡®ä¿TCPç²¾åº¦</li>
<li><strong>åŠ¨æ€å·¥ä»¶åæ ‡ç³»</strong>ï¼šå·¥ä»¶å¯åœ¨ä¸¤è‡‚é—´ä¼ é€’ï¼Œåæ ‡ç³»åŠ¨æ€åˆ‡æ¢</li>
</ol>
<h3 id="853">8.5.3 é«˜ç²¾åº¦åŒæ­¥å®ç°</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DualArmCoordinator</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;dual_arm_coordinator&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span> <span class="o">=</span> <span class="n">Buffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_listener</span> <span class="o">=</span> <span class="n">TransformListener</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="c1"># EtherCAT æ—¶é—´åŒæ­¥</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ethercat_clock</span> <span class="o">=</span> <span class="n">EtherCATClock</span><span class="p">()</span>

        <span class="c1"># åæ ‡ç³»æ ‡å®šå‚æ•°</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">calibration</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;robot1_to_world&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
            <span class="p">]),</span>
            <span class="s1">&#39;robot2_to_world&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]</span>
            <span class="p">])</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">synchronized_motion</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target_pose1</span><span class="p">,</span> <span class="n">target_pose2</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åŒæ­¥åŒè‡‚è¿åŠ¨åˆ°ç›®æ ‡ä½ç½®&quot;&quot;&quot;</span>
        <span class="c1"># è·å–å½“å‰æ—¶é—´æˆ³ï¼ˆç¡¬ä»¶åŒæ­¥ï¼‰</span>
        <span class="n">sync_time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ethercat_clock</span><span class="o">.</span><span class="n">get_sync_time</span><span class="p">()</span>

        <span class="c1"># è®¡ç®—ä¸¤è‡‚çš„è¿åŠ¨è½¨è¿¹</span>
        <span class="n">traj1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_trajectory</span><span class="p">(</span><span class="s1">&#39;robot1_tool&#39;</span><span class="p">,</span> <span class="n">target_pose1</span><span class="p">,</span> <span class="n">sync_time</span><span class="p">)</span>
        <span class="n">traj2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">plan_trajectory</span><span class="p">(</span><span class="s1">&#39;robot2_tool&#39;</span><span class="p">,</span> <span class="n">target_pose2</span><span class="p">,</span> <span class="n">sync_time</span><span class="p">)</span>

        <span class="c1"># æ—¶é—´å¯¹é½</span>
        <span class="n">max_duration</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">traj1</span><span class="o">.</span><span class="n">duration</span><span class="p">,</span> <span class="n">traj2</span><span class="o">.</span><span class="n">duration</span><span class="p">)</span>
        <span class="n">traj1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retime_trajectory</span><span class="p">(</span><span class="n">traj1</span><span class="p">,</span> <span class="n">max_duration</span><span class="p">)</span>
        <span class="n">traj2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">retime_trajectory</span><span class="p">(</span><span class="n">traj2</span><span class="p">,</span> <span class="n">max_duration</span><span class="p">)</span>

        <span class="c1"># åŒæ­¥æ‰§è¡Œ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execute_synchronized</span><span class="p">(</span><span class="n">traj1</span><span class="p">,</span> <span class="n">traj2</span><span class="p">)</span>
</code></pre></div>

<h3 id="854">8.5.4 åŠ›æ§åè°ƒ</h3>
<p>åŒè‡‚åä½œä¸­çš„åŠ›/ä½æ··åˆæ§åˆ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ForceCoordination</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;force_coordination&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">force_threshold</span> <span class="o">=</span> <span class="mf">10.0</span>  <span class="c1"># N</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compliant_assembly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æŸ”é¡ºè£…é…æ§åˆ¶&quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembly_complete</span><span class="p">():</span>
            <span class="c1"># è·å–åŒè‡‚æœ«ç«¯çš„ç›¸å¯¹ä½å§¿</span>
            <span class="n">tf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span><span class="o">.</span><span class="n">lookup_transform</span><span class="p">(</span>
                <span class="s1">&#39;robot1_tool&#39;</span><span class="p">,</span> <span class="s1">&#39;robot2_tool&#39;</span><span class="p">,</span> 
                <span class="n">rclpy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">())</span>

            <span class="c1"># è®¡ç®—è™šæ‹Ÿå¼¹ç°§é˜»å°¼åŠ›</span>
            <span class="n">F_spring</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_spring_force</span><span class="p">(</span><span class="n">tf</span><span class="p">)</span>

            <span class="c1"># åˆ†é…åŠ›åˆ°ä¸¤ä¸ªæœºæ¢°è‡‚</span>
            <span class="n">F1</span> <span class="o">=</span> <span class="n">F_spring</span> <span class="o">*</span> <span class="mf">0.5</span>
            <span class="n">F2</span> <span class="o">=</span> <span class="o">-</span><span class="n">F_spring</span> <span class="o">*</span> <span class="mf">0.5</span>

            <span class="c1"># é˜»æŠ—æ§åˆ¶</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_impedance_control</span><span class="p">(</span><span class="s1">&#39;robot1&#39;</span><span class="p">,</span> <span class="n">F1</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">apply_impedance_control</span><span class="p">(</span><span class="s1">&#39;robot2&#39;</span><span class="p">,</span> <span class="n">F2</span><span class="p">)</span>
</code></pre></div>

<h3 id="855">8.5.5 å®¹é”™ä¸å¼‚å¸¸å¤„ç†</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">FaultTolerantTF</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;fault_tolerant_tf&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tf_health_monitor</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">backup_transforms</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">monitor_tf_health</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç›‘æ§ tf æ ‘å¥åº·çŠ¶æ€&quot;&quot;&quot;</span>
        <span class="n">critical_frames</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="s1">&#39;robot1_base&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="s1">&#39;robot2_base&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;robot1_tool&#39;</span><span class="p">,</span> <span class="s1">&#39;workpiece&#39;</span><span class="p">),</span>
            <span class="p">(</span><span class="s1">&#39;robot2_tool&#39;</span><span class="p">,</span> <span class="s1">&#39;workpiece&#39;</span><span class="p">)</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">parent</span><span class="p">,</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">critical_frames</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">tf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span><span class="o">.</span><span class="n">lookup_transform</span><span class="p">(</span>
                    <span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> 
                    <span class="n">rclpy</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">Time</span><span class="p">(),</span>
                    <span class="n">timeout</span><span class="o">=</span><span class="n">Duration</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mf">0.01</span><span class="p">))</span>

                <span class="c1"># æ£€æŸ¥æ—¶é—´æˆ³æ–°é²œåº¦</span>
                <span class="n">age</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_clock</span><span class="p">()</span><span class="o">.</span><span class="n">now</span><span class="p">()</span> <span class="o">-</span> 
                       <span class="n">Time</span><span class="o">.</span><span class="n">from_msg</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stamp</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">age</span> <span class="o">&gt;</span> <span class="n">Duration</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">handle_stale_transform</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_missing_transform</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_missing_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å¤„ç†ä¸¢å¤±çš„å˜æ¢&quot;&quot;&quot;</span>
        <span class="c1"># ä½¿ç”¨æœ€åå·²çŸ¥çš„è‰¯å¥½å˜æ¢</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">backup_transforms</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">publish_backup_transform</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># è§¦å‘å®‰å…¨åœæœº</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">emergency_stop</span><span class="p">()</span>
</code></pre></div>

<h3 id="856">8.5.6 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h3>
<ol>
<li><strong>é¢„è®¡ç®—å˜æ¢é“¾</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># é¢„è®¡ç®—å¸¸ç”¨çš„å˜æ¢é“¾</span>
<span class="bp">self</span><span class="o">.</span><span class="n">precomputed_chains</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;tool_to_tool&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;robot1_tool&#39;</span><span class="p">,</span> <span class="s1">&#39;robot1_base&#39;</span><span class="p">,</span> 
                     <span class="s1">&#39;world&#39;</span><span class="p">,</span> <span class="s1">&#39;robot2_base&#39;</span><span class="p">,</span> <span class="s1">&#39;robot2_tool&#39;</span><span class="p">],</span>
    <span class="s1">&#39;workpiece_in_world&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;workpiece&#39;</span><span class="p">,</span> <span class="s1">&#39;robot1_tool&#39;</span><span class="p">,</span> 
                           <span class="s1">&#39;robot1_base&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">]</span>
<span class="p">}</span>
</code></pre></div>

<ol start="2">
<li>
<p><strong>ç¼“å­˜ä¼˜åŒ–</strong>ï¼š
- ä½¿ç”¨ LRU ç¼“å­˜å­˜å‚¨é¢‘ç¹æŸ¥è¯¢çš„å˜æ¢
- è®¾ç½®åˆç†çš„ç¼“å­˜è¿‡æœŸæ—¶é—´ï¼ˆé€šå¸¸ 10-100msï¼‰</p>
</li>
<li>
<p><strong>å¹¶è¡ŒæŸ¥è¯¢</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">async</span> <span class="k">def</span><span class="w"> </span><span class="nf">parallel_tf_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queries</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å¹¶è¡ŒæŸ¥è¯¢å¤šä¸ªå˜æ¢&quot;&quot;&quot;</span>
    <span class="n">tasks</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">parent</span><span class="p">,</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">queries</span><span class="p">:</span>
        <span class="n">task</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">create_task</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">async_lookup</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">))</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

    <span class="n">results</span> <span class="o">=</span> <span class="k">await</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">gather</span><span class="p">(</span><span class="o">*</span><span class="n">tasks</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">queries</span><span class="p">,</span> <span class="n">results</span><span class="p">))</span>
</code></pre></div>

<h2 id="86-tf">8.6 é«˜çº§è¯é¢˜ï¼šå¤§è§„æ¨¡ tf æ ‘ä¼˜åŒ–ä¸ç¼“å­˜ç­–ç•¥</h2>
<h3 id="861-tf">8.6.1 tf æ ‘çš„æ€§èƒ½ç“¶é¢ˆåˆ†æ</h3>
<p>åœ¨å¤§è§„æ¨¡æœºå™¨äººç³»ç»Ÿä¸­ï¼ˆå¦‚ä»“åº“æœºå™¨äººç¾¤ã€å¤šä¼ æ„Ÿå™¨èåˆç³»ç»Ÿï¼‰ï¼Œtf æ ‘å¯èƒ½åŒ…å«æ•°ç™¾ä¸ªåæ ‡ç³»ï¼Œæ€§èƒ½é—®é¢˜ä¸»è¦ä½“ç°åœ¨ï¼š</p>
<ol>
<li><strong>æŸ¥è¯¢å»¶è¿Ÿ</strong>ï¼šO(n) çš„æ ‘éå†å¤æ‚åº¦</li>
<li><strong>å†…å­˜å ç”¨</strong>ï¼šå†å²å˜æ¢ç¼“å­˜æ¶ˆè€—å¤§é‡å†…å­˜</li>
<li><strong>ç½‘ç»œå¸¦å®½</strong>ï¼šé«˜é¢‘å˜æ¢æ›´æ–°å ç”¨å¸¦å®½</li>
<li><strong>è®¡ç®—å¼€é”€</strong>ï¼šé•¿å˜æ¢é“¾çš„çŸ©é˜µä¹˜æ³•</li>
</ol>
<p>æ€§èƒ½åˆ†æå·¥å…·ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TFPerformanceAnalyzer</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;tf_performance_analyzer&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_times</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">transform_rates</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">profile_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ€§èƒ½å‰–æå•æ¬¡æŸ¥è¯¢&quot;&quot;&quot;</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">tf</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span><span class="o">.</span><span class="n">lookup_transform</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">Time</span><span class="p">())</span>
        <span class="n">duration</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span> <span class="o">-</span> <span class="n">start</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">query_times</span><span class="p">[(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">duration</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">duration</span> <span class="o">&gt;</span> <span class="mf">0.001</span><span class="p">:</span>  <span class="c1"># 1ms é˜ˆå€¼</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;Slow TF lookup: </span><span class="si">{</span><span class="n">parent</span><span class="si">}</span><span class="s1">-&gt;</span><span class="si">{</span><span class="n">child</span><span class="si">}</span><span class="s1"> took </span><span class="si">{</span><span class="n">duration</span><span class="o">*</span><span class="mi">1000</span><span class="si">:</span><span class="s1">.2f</span><span class="si">}</span><span class="s1">ms&#39;</span><span class="p">)</span>
</code></pre></div>

<h3 id="862">8.6.2 åˆ†å±‚ç¼“å­˜æ¶æ„</h3>
<p>ä¸‰çº§ç¼“å­˜è®¾è®¡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HierarchicalTFCache</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># L1: çƒ­ç‚¹å˜æ¢ç¼“å­˜ï¼ˆæœ€è¿‘ 10msï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span> <span class="o">=</span> <span class="n">LRUCache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l1_ttl</span> <span class="o">=</span> <span class="mf">0.01</span>

        <span class="c1"># L2: å¸¸ç”¨å˜æ¢ç¼“å­˜ï¼ˆæœ€è¿‘ 100msï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l2_cache</span> <span class="o">=</span> <span class="n">LRUCache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">256</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l2_ttl</span> <span class="o">=</span> <span class="mf">0.1</span>

        <span class="c1"># L3: å®Œæ•´å†å²ç¼“å­˜ï¼ˆæœ€è¿‘ 10sï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">l3_cache</span> <span class="o">=</span> <span class="n">TimeOrderedCache</span><span class="p">(</span><span class="n">time_window</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">lookup_with_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆ†å±‚ç¼“å­˜æŸ¥è¯¢&quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">time</span><span class="o">.</span><span class="n">nanoseconds</span> <span class="o">//</span> <span class="mi">1000000</span><span class="p">)</span>  <span class="c1"># 1msç²¾åº¦</span>

        <span class="c1"># L1 æŸ¥è¯¢</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="c1"># L2 æŸ¥è¯¢</span>
        <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_cache</span><span class="p">:</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">l2_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">l1_cache</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">result</span>  <span class="c1"># æå‡åˆ°L1</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># L3 æŸ¥è¯¢æˆ–è®¡ç®—</span>
        <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_transform</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">update_caches</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<h3 id="863">8.6.3 å›¾ä¼˜åŒ–ç®—æ³•</h3>
<p>å°† tf æ ‘ä¼˜åŒ–é—®é¢˜è½¬åŒ–ä¸ºå›¾ä¼˜åŒ–ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">TFGraphOptimizer</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">edge_weights</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># æŸ¥è¯¢é¢‘ç‡</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_tree_structure</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åŸºäºæŸ¥è¯¢æ¨¡å¼ä¼˜åŒ–æ ‘ç»“æ„&quot;&quot;&quot;</span>
        <span class="c1"># æ”¶é›†æŸ¥è¯¢ç»Ÿè®¡</span>
        <span class="n">query_patterns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_query_statistics</span><span class="p">()</span>

        <span class="c1"># è¯†åˆ«çƒ­ç‚¹è·¯å¾„</span>
        <span class="n">hot_paths</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">identify_hot_paths</span><span class="p">(</span><span class="n">query_patterns</span><span class="p">)</span>

        <span class="c1"># æ·»åŠ å¿«æ·è¾¹ï¼ˆshortcut edgesï¼‰</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">hot_paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># ç›´æ¥è¿æ¥é¦–å°¾èŠ‚ç‚¹</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_shortcut</span><span class="p">(</span><span class="n">path</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># é‡æ–°å¹³è¡¡æ ‘</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rebalance_tree</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_shortcut</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ·»åŠ å¿«æ·å˜æ¢é¿å…é•¿é“¾è®¡ç®—&quot;&quot;&quot;</span>
        <span class="c1"># é¢„è®¡ç®—å¹¶ç¼“å­˜ç›´æ¥å˜æ¢</span>
        <span class="n">direct_transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_chain_transform</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shortcut_cache</span><span class="p">[(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">)]</span> <span class="o">=</span> <span class="n">direct_transform</span>
</code></pre></div>

<h3 id="864-tf">8.6.4 åˆ†å¸ƒå¼ tf æœåŠ¡</h3>
<p>å¯¹äºè¶…å¤§è§„æ¨¡ç³»ç»Ÿï¼Œä½¿ç”¨åˆ†å¸ƒå¼ tf æœåŠ¡ï¼š</p>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  TF Shard 1  â”‚     â”‚  TF Shard 2  â”‚     â”‚  TF Shard 3  â”‚
â”‚  /robot1/*   â”‚     â”‚  /robot2/*   â”‚     â”‚  /robot3/*   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                    â”‚                    â”‚
       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
                   â”‚  TF Router      â”‚
                   â”‚  - Consistent   â”‚
                   â”‚    Hashing      â”‚
                   â”‚  - Load Balance â”‚
                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p>å®ç°ç¤ºä¾‹ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DistributedTFService</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shard_id</span><span class="p">,</span> <span class="n">total_shards</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shard_id</span> <span class="o">=</span> <span class="n">shard_id</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">total_shards</span> <span class="o">=</span> <span class="n">total_shards</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">local_buffer</span> <span class="o">=</span> <span class="n">Buffer</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remote_clients</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">lookup_transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">time</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆ†å¸ƒå¼å˜æ¢æŸ¥è¯¢&quot;&quot;&quot;</span>
        <span class="c1"># ç¡®å®šè´Ÿè´£çš„åˆ†ç‰‡</span>
        <span class="n">responsible_shard</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hash_to_shard</span><span class="p">(</span><span class="n">parent</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">responsible_shard</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">shard_id</span><span class="p">:</span>
            <span class="c1"># æœ¬åœ°æŸ¥è¯¢</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_buffer</span><span class="o">.</span><span class="n">lookup_transform</span><span class="p">(</span>
                <span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># è¿œç¨‹æŸ¥è¯¢</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_lookup</span><span class="p">(</span>
                <span class="n">responsible_shard</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">hash_to_shard</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">frame_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä¸€è‡´æ€§å“ˆå¸Œç¡®å®šåˆ†ç‰‡&quot;&quot;&quot;</span>
        <span class="n">hash_val</span> <span class="o">=</span> <span class="n">hashlib</span><span class="o">.</span><span class="n">md5</span><span class="p">(</span><span class="n">frame_id</span><span class="o">.</span><span class="n">encode</span><span class="p">())</span><span class="o">.</span><span class="n">hexdigest</span><span class="p">()</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">hash_val</span><span class="p">,</span> <span class="mi">16</span><span class="p">)</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_shards</span>
</code></pre></div>

<h3 id="865">8.6.5 å†…å­˜ä¼˜åŒ–æŠ€æœ¯</h3>
<ol>
<li><strong>å‹ç¼©å­˜å‚¨</strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CompressedTransform</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ä½¿ç”¨å®šç‚¹æ•°å‹ç¼©å˜æ¢å­˜å‚¨&quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transform</span><span class="p">):</span>
        <span class="c1"># ä½ç½®ï¼šæ¯«ç±³ç²¾åº¦ï¼Œint32</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">y</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">z</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">translation</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="c1"># å››å…ƒæ•°ï¼š16ä½å®šç‚¹æ•°</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qw</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">w</span> <span class="o">*</span> <span class="mi">32767</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">x</span> <span class="o">*</span> <span class="mi">32767</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qy</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">y</span> <span class="o">*</span> <span class="mi">32767</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qz</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">transform</span><span class="o">.</span><span class="n">rotation</span><span class="o">.</span><span class="n">z</span> <span class="o">*</span> <span class="mi">32767</span><span class="p">)</span>
</code></pre></div>

<ol start="2">
<li><strong>å¢é‡ç¼–ç </strong>ï¼š</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">encode_incremental</span><span class="p">(</span><span class="n">transforms</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å¢é‡ç¼–ç è¿ç»­å˜æ¢&quot;&quot;&quot;</span>
    <span class="n">encoded</span> <span class="o">=</span> <span class="p">[</span><span class="n">transforms</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">transforms</span><span class="p">)):</span>
        <span class="n">delta</span> <span class="o">=</span> <span class="n">compute_delta</span><span class="p">(</span><span class="n">transforms</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">transforms</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
        <span class="n">encoded</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">delta</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">encoded</span>
</code></pre></div>

<h3 id="866">8.6.6 å®æ—¶æ€§ä¿è¯</h3>
<p>ç¡®ä¿ tf æŸ¥è¯¢çš„å®æ—¶æ€§ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RealtimeTFBuffer</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rt_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">realtime_loop</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rt_thread</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

        <span class="c1"># é¢„åˆ†é…å†…å­˜é¿å…åŠ¨æ€åˆ†é…</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">preallocated_transforms</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">TransformStamped</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1000</span><span class="p">)]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">realtime_lookup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å®æ—¶æŸ¥è¯¢ï¼Œä¿è¯ç¡®å®šæ€§å»¶è¿Ÿ&quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">rt_lock</span><span class="p">:</span>
            <span class="c1"># ä½¿ç”¨é¢„åˆ†é…çš„å¯¹è±¡</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preallocated_transforms</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">next_slot</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">next_slot</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">next_slot</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">1000</span>

            <span class="c1"># O(1) æŸ¥è¯¢</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">direct_cache</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">transform</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">direct_cache</span><span class="p">[(</span><span class="n">parent</span><span class="p">,</span> <span class="n">child</span><span class="p">)]</span>
                <span class="k">return</span> <span class="n">result</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># é™çº§åˆ°éå®æ—¶è·¯å¾„</span>
                <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>

<h2 id="87">8.7 æœ¬ç« å°ç»“</h2>
<p>tf2 åæ ‡å˜æ¢æ¡†æ¶æ˜¯ ROS2 ä¸­ç©ºé—´å…³ç³»ç®¡ç†çš„æ ¸å¿ƒåŸºç¡€è®¾æ–½ã€‚æœ¬ç« æ·±å…¥æ¢è®¨äº†ï¼š</p>
<p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>ï¼š</p>
<ul>
<li>tf æ ‘çš„æ— ç¯ã€è¿é€šã€æœ‰å‘ç‰¹æ€§ä¿è¯äº†å˜æ¢è·¯å¾„çš„å”¯ä¸€æ€§</li>
<li>é™æ€å˜æ¢ç”¨äºå›ºå®šçš„ä¼ æ„Ÿå™¨å®‰è£…ï¼ŒåŠ¨æ€å˜æ¢å¤„ç†è¿åŠ¨éƒ¨ä»¶</li>
<li>æ—¶é—´åŒæ­¥å’Œå¤–æ¨ç®—æ³•ç¡®ä¿äº†ä¸åŒæ—¶åˆ»æ•°æ®çš„ä¸€è‡´æ€§</li>
<li>å¤šæœºå™¨äººç³»ç»Ÿé€šè¿‡å‘½åç©ºé—´éš”ç¦»å’Œåˆ†å¸ƒå¼æ¶æ„å®ç°æ‰©å±•</li>
</ul>
<p><strong>å…³é”®å…¬å¼</strong>ï¼š</p>
<ul>
<li>é½æ¬¡å˜æ¢çŸ©é˜µï¼š$T = \begin{bmatrix} R &amp; t \\ 0 &amp; 1 \end{bmatrix}$</li>
<li>å˜æ¢é“¾ç»„åˆï¼š$T_{AC} = T_{AB} \cdot T_{BC}$</li>
<li>çº¿æ€§å¤–æ¨ï¼š$T(t) = T(t_0) + \frac{dT}{dt}|_{t_0} \cdot (t - t_0)$</li>
<li>ç´¯ç§¯è¯¯å·®ï¼š$\delta T_{total} \approx \sum_{i=1}^{n} J_i \cdot \delta T_i$</li>
</ul>
<p><strong>æ€§èƒ½ä¼˜åŒ–è¦ç‚¹</strong>ï¼š</p>
<ul>
<li>åˆ†å±‚ç¼“å­˜æ¶æ„ï¼ˆL1/L2/L3ï¼‰å‡å°‘æŸ¥è¯¢å»¶è¿Ÿ</li>
<li>é¢„è®¡ç®—çƒ­ç‚¹è·¯å¾„å’Œå¿«æ·è¾¹ä¼˜åŒ–é•¿å˜æ¢é“¾</li>
<li>å‹ç¼©å­˜å‚¨å’Œå¢é‡ç¼–ç é™ä½å†…å­˜å ç”¨</li>
<li>åˆ†å¸ƒå¼ tf æœåŠ¡æ”¯æŒè¶…å¤§è§„æ¨¡ç³»ç»Ÿ</li>
</ul>
<h2 id="88">8.8 ç»ƒä¹ é¢˜</h2>
<h3 id="_1">åŸºç¡€é¢˜</h3>
<p><strong>ç»ƒä¹  8.1</strong>ï¼šè®¾è®¡ä¸€ä¸ªå››è¶³æœºå™¨äººçš„ tf æ ‘ç»“æ„ï¼ŒåŒ…å«èº¯å¹²ã€å››æ¡è…¿ï¼ˆæ¯æ¡è…¿ 3 ä¸ªå…³èŠ‚ï¼‰ã€IMU å’Œæ¿€å…‰é›·è¾¾ã€‚</p>
<details>
<summary>ğŸ’¡ æç¤º</summary>
<p>è€ƒè™‘ï¼š</p>
<ul>
<li>èº¯å¹²ä½œä¸º base_link</li>
<li>æ¯æ¡è…¿çš„è¿åŠ¨é“¾</li>
<li>ä¼ æ„Ÿå™¨çš„å®‰è£…ä½ç½®</li>
<li>è¶³ç«¯æ¥è§¦ç‚¹åæ ‡ç³»</li>
</ul>
</details>
<details>
<summary>ğŸ“ ç­”æ¡ˆ</summary>
<p>tf æ ‘ç»“æ„ï¼š</p>
<ul>
<li>base_linkï¼ˆèº¯å¹²ï¼‰</li>
<li>imu_linkï¼ˆå›ºå®šåœ¨èº¯å¹²ä¸­å¿ƒï¼‰</li>
<li>laser_linkï¼ˆå›ºå®šåœ¨èº¯å¹²å‰éƒ¨ï¼‰</li>
<li>front_left_hip â†’ front_left_thigh â†’ front_left_calf â†’ front_left_foot</li>
<li>front_right_hip â†’ front_right_thigh â†’ front_right_calf â†’ front_right_foot</li>
<li>rear_left_hip â†’ rear_left_thigh â†’ rear_left_calf â†’ rear_left_foot</li>
<li>rear_right_hip â†’ rear_right_thigh â†’ rear_right_calf â†’ rear_right_foot</li>
</ul>
<p>æ¯æ¡è…¿å½¢æˆä¸€ä¸ªè¿åŠ¨é“¾ï¼Œé«‹å…³èŠ‚ç›´æ¥è¿æ¥åˆ° base_linkã€‚</p>
</details>
<p><strong>ç»ƒä¹  8.2</strong>ï¼šç»™å®šä¸¤ä¸ªåæ ‡ç³»ä¹‹é—´çš„å˜æ¢çŸ©é˜µï¼Œè®¡ç®—é€†å˜æ¢ã€‚å¦‚æœ $T_{AB} = \begin{bmatrix} 0 &amp; -1 &amp; 0 &amp; 2 \\ 1 &amp; 0 &amp; 0 &amp; 3 \\ 0 &amp; 0 &amp; 1 &amp; 1 \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix}$ï¼Œæ±‚ $T_{BA}$ã€‚</p>
<details>
<summary>ğŸ’¡ æç¤º</summary>
<p>é½æ¬¡å˜æ¢çŸ©é˜µçš„é€†ï¼š$T^{-1} = \begin{bmatrix} R^T &amp; -R^T t \\ 0 &amp; 1 \end{bmatrix}$</p>
</details>
<details>
<summary>ğŸ“ ç­”æ¡ˆ</summary>
<p>$T_{BA} = T_{AB}^{-1} = \begin{bmatrix} 0 &amp; 1 &amp; 0 &amp; -3 \\ -1 &amp; 0 &amp; 0 &amp; 2 \\ 0 &amp; 0 &amp; 1 &amp; -1 \\ 0 &amp; 0 &amp; 0 &amp; 1 \end{bmatrix}$</p>
<p>éªŒè¯ï¼š$R^T = \begin{bmatrix} 0 &amp; 1 &amp; 0 \\ -1 &amp; 0 &amp; 0 \\ 0 &amp; 0 &amp; 1 \end{bmatrix}$ï¼Œ$-R^T t = \begin{bmatrix} -3 \\ 2 \\ -1 \end{bmatrix}$</p>
</details>
<p><strong>ç»ƒä¹  8.3</strong>ï¼šå®ç°ä¸€ä¸ª tf2 ç›‘æ§èŠ‚ç‚¹ï¼Œå½“ä»»æ„ä¸¤ä¸ªå…³é”®åæ ‡ç³»ä¹‹é—´çš„å˜æ¢è¶…è¿‡ 100ms æœªæ›´æ–°æ—¶å‘å‡ºè­¦å‘Šã€‚</p>
<details>
<summary>ğŸ’¡ æç¤º</summary>
<ul>
<li>ä½¿ç”¨ tf_buffer.lookup_transform() è·å–å˜æ¢</li>
<li>æ£€æŸ¥ header.stamp æ—¶é—´æˆ³</li>
<li>åˆ›å»ºå®šæ—¶å™¨å‘¨æœŸæ€§æ£€æŸ¥</li>
</ul>
</details>
<details>
<summary>ğŸ“ ç­”æ¡ˆ</summary>
<p>ç›‘æ§èŠ‚ç‚¹éœ€è¦ï¼š</p>
<ol>
<li>å®šä¹‰å…³é”®åæ ‡ç³»å¯¹åˆ—è¡¨</li>
<li>åˆ›å»º 100Hz çš„å®šæ—¶å™¨</li>
<li>åœ¨å›è°ƒä¸­éå†åæ ‡ç³»å¯¹ï¼Œæ£€æŸ¥æ¯ä¸ªå˜æ¢çš„æ—¶é—´æˆ³</li>
<li>è®¡ç®—å½“å‰æ—¶é—´ä¸å˜æ¢æ—¶é—´æˆ³çš„å·®å€¼</li>
<li>è¶…è¿‡é˜ˆå€¼æ—¶é€šè¿‡ get_logger().warn() å‘å‡ºè­¦å‘Š</li>
<li>å¯é€‰ï¼šå‘å¸ƒè¯Šæ–­æ¶ˆæ¯åˆ° /diagnostics è¯é¢˜</li>
</ol>
</details>
<h3 id="_2">æŒ‘æˆ˜é¢˜</h3>
<p><strong>ç»ƒä¹  8.4</strong>ï¼šè®¾è®¡å¹¶å®ç°ä¸€ä¸ª tf2 å˜æ¢é¢„æµ‹å™¨ï¼ŒåŸºäºå†å²æ•°æ®é¢„æµ‹æœªæ¥ 100ms çš„å˜æ¢ã€‚è€ƒè™‘åŒ€é€Ÿå’ŒåŒ€åŠ é€Ÿä¸¤ç§è¿åŠ¨æ¨¡å‹ã€‚</p>
<details>
<summary>ğŸ’¡ æç¤º</summary>
<ul>
<li>ä½¿ç”¨å¡å°”æ›¼æ»¤æ³¢æˆ–ç²’å­æ»¤æ³¢</li>
<li>åˆ†åˆ«å¤„ç†ä½ç½®å’Œå§¿æ€</li>
<li>å››å…ƒæ•°æ’å€¼ä½¿ç”¨ SLERP</li>
<li>è¯„ä¼°é¢„æµ‹è¯¯å·®</li>
</ul>
</details>
<details>
<summary>ğŸ“ ç­”æ¡ˆ</summary>
<p>å®ç°ç­–ç•¥ï¼š</p>
<ol>
<li>å†å²æ•°æ®æ”¶é›†ï¼šä¿å­˜æœ€è¿‘ 1 ç§’çš„å˜æ¢å†å²</li>
<li>è¿åŠ¨æ¨¡å‹ä¼°è®¡ï¼š
   - ä½ç½®ï¼šçº¿æ€§å›å½’ä¼°è®¡é€Ÿåº¦å’ŒåŠ é€Ÿåº¦
   - å§¿æ€ï¼šè®¡ç®—è§’é€Ÿåº¦å’Œè§’åŠ é€Ÿåº¦</li>
<li>é¢„æµ‹ç®—æ³•ï¼š
   - åŒ€é€Ÿæ¨¡å‹ï¼š$p(t+\Delta t) = p(t) + v \cdot \Delta t$
   - åŒ€åŠ é€Ÿæ¨¡å‹ï¼š$p(t+\Delta t) = p(t) + v \cdot \Delta t + \frac{1}{2}a \cdot \Delta t^2$</li>
<li>å››å…ƒæ•°é¢„æµ‹ï¼šä½¿ç”¨è§’é€Ÿåº¦ç§¯åˆ†å¹¶å½’ä¸€åŒ–</li>
<li>è¯¯å·®è¯„ä¼°ï¼šä¸å®é™…å˜æ¢æ¯”è¾ƒï¼ŒåŠ¨æ€é€‰æ‹©æœ€ä½³æ¨¡å‹</li>
</ol>
</details>
<p><strong>ç»ƒä¹  8.5</strong>ï¼šä¸ºä¸€ä¸ª 50 å°æœºå™¨äººçš„ä»“åº“ç³»ç»Ÿè®¾è®¡åˆ†å¸ƒå¼ tf æ¶æ„ã€‚è¦æ±‚æ”¯æŒåŠ¨æ€åŠ å…¥/é€€å‡ºï¼Œæ•…éšœå®¹é”™ï¼Œä»¥åŠå…¨å±€åæ ‡ç³»ä¸€è‡´æ€§ã€‚</p>
<details>
<summary>ğŸ’¡ æç¤º</summary>
<ul>
<li>è€ƒè™‘åˆ†ç‰‡ç­–ç•¥</li>
<li>ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œ</li>
<li>å®ç°å¿ƒè·³æœºåˆ¶</li>
<li>è®¾è®¡æ•…éšœè½¬ç§»æ–¹æ¡ˆ</li>
</ul>
</details>
<details>
<summary>ğŸ“ ç­”æ¡ˆ</summary>
<p>æ¶æ„è®¾è®¡ï¼š</p>
<ol>
<li>
<p><strong>åˆ†ç‰‡ç­–ç•¥</strong>ï¼š
   - 5 ä¸ª tf æœåŠ¡èŠ‚ç‚¹ï¼Œæ¯ä¸ªè´Ÿè´£ 10 å°æœºå™¨äºº
   - ä½¿ç”¨ä¸€è‡´æ€§å“ˆå¸Œåˆ†é…æœºå™¨äººåˆ°èŠ‚ç‚¹</p>
</li>
<li>
<p><strong>é«˜å¯ç”¨è®¾è®¡</strong>ï¼š
   - æ¯ä¸ªåˆ†ç‰‡æœ‰ä¸»å¤‡ä¸¤ä¸ªèŠ‚ç‚¹
   - ä½¿ç”¨ Raft åè®®é€‰ä¸¾ä¸»èŠ‚ç‚¹
   - å¤‡èŠ‚ç‚¹å®æ—¶åŒæ­¥æ•°æ®</p>
</li>
<li>
<p><strong>å…¨å±€ä¸€è‡´æ€§</strong>ï¼š
   - ä¸“é—¨çš„å…¨å±€åæ ‡ç³»æœåŠ¡ç»´æŠ¤ map åæ ‡ç³»
   - å„æœºå™¨äººé€šè¿‡ AprilTag æˆ– UWB å®šä½
   - å®šæœŸæ ¡å‡†è¡¥å¿ç´¯ç§¯è¯¯å·®</p>
</li>
<li>
<p><strong>åŠ¨æ€ç®¡ç†</strong>ï¼š
   - æœåŠ¡å‘ç°ä½¿ç”¨ DDS discovery
   - æ–°æœºå™¨äººåŠ å…¥æ—¶è‡ªåŠ¨åˆ†é…åˆ°è´Ÿè½½æœ€è½»çš„åˆ†ç‰‡
   - æ•…éšœæœºå™¨äººçš„ tf æ•°æ®ä¿ç•™ 30 ç§’åæ¸…ç†</p>
</li>
</ol>
</details>
<p><strong>ç»ƒä¹  8.6</strong>ï¼šåˆ†æå¹¶ä¼˜åŒ–ä¸€ä¸ªåŒ…å« 200 ä¸ªåæ ‡ç³»ã€æŸ¥è¯¢ QPS è¾¾åˆ° 10000 çš„ tf2 ç³»ç»Ÿã€‚ç»™å‡ºå…·ä½“çš„ä¼˜åŒ–æ–¹æ¡ˆå’Œé¢„æœŸæ€§èƒ½æå‡ã€‚</p>
<details>
<summary>ğŸ’¡ æç¤º</summary>
<ul>
<li>åˆ†ææŸ¥è¯¢æ¨¡å¼</li>
<li>è¯†åˆ«çƒ­ç‚¹è·¯å¾„</li>
<li>è®¾è®¡å¤šçº§ç¼“å­˜</li>
<li>è€ƒè™‘å¹¶è¡ŒåŒ–</li>
</ul>
</details>
<details>
<summary>ğŸ“ ç­”æ¡ˆ</summary>
<p>ä¼˜åŒ–æ–¹æ¡ˆï¼š</p>
<ol>
<li>
<p><strong>æŸ¥è¯¢åˆ†æ</strong>ï¼ˆå·¥å…·ï¼štf2_monitorï¼‰
   - è®°å½•ä¸€å¤©çš„æŸ¥è¯¢æ—¥å¿—
   - è¯†åˆ« Top 20 çƒ­ç‚¹æŸ¥è¯¢ï¼ˆå  80% æµé‡ï¼‰
   - åˆ†ææŸ¥è¯¢æ—¶é—´åˆ†å¸ƒ</p>
</li>
<li>
<p><strong>ç¼“å­˜ä¼˜åŒ–</strong>ï¼š
   - L1 ç¼“å­˜ï¼š32 ä¸ªçƒ­ç‚¹å˜æ¢ï¼ŒTTL=1msï¼Œå‘½ä¸­ç‡ 60%
   - L2 ç¼“å­˜ï¼š256 ä¸ªå¸¸ç”¨å˜æ¢ï¼ŒTTL=10msï¼Œå‘½ä¸­ç‡ 30%
   - é¢„æœŸå»¶è¿Ÿé™ä½ï¼šä» 5ms é™è‡³ 0.5ms</p>
</li>
<li>
<p><strong>ç»“æ„ä¼˜åŒ–</strong>ï¼š
   - ä¸ºçƒ­ç‚¹è·¯å¾„æ·»åŠ  50 ä¸ªå¿«æ·è¾¹
   - å°†å¹³å‡æŸ¥è¯¢æ·±åº¦ä» 8 é™è‡³ 3
   - è®¡ç®—å¼€é”€å‡å°‘ 60%</p>
</li>
<li>
<p><strong>å¹¶è¡ŒåŒ–</strong>ï¼š
   - 4 ä¸ªå·¥ä½œçº¿ç¨‹å¤„ç†æŸ¥è¯¢
   - æ— é”æ•°æ®ç»“æ„ï¼ˆRCUï¼‰
   - ååé‡æå‡ 3.5 å€</p>
</li>
<li>
<p><strong>å†…å­˜ä¼˜åŒ–</strong>ï¼š
   - å‹ç¼©å­˜å‚¨å‡å°‘ 50% å†…å­˜
   - åªä¿ç•™ 1 ç§’å†å²æ•°æ®
   - æ€»å†…å­˜ä» 2GB é™è‡³ 500MB</p>
</li>
</ol>
<p>é¢„æœŸç»¼åˆæ€§èƒ½æå‡ï¼šå»¶è¿Ÿ P99 ä» 10ms é™è‡³ 2msï¼Œååé‡ä» 10K QPS æå‡è‡³ 35K QPSã€‚</p>
</details>
<p><strong>ç»ƒä¹  8.7</strong>ï¼šè®¾è®¡ä¸€ä¸ªè‡ªé€‚åº” tf ç¼“å†²åŒºï¼Œæ ¹æ®æŸ¥è¯¢æ¨¡å¼åŠ¨æ€è°ƒæ•´ç¼“å­˜å¤§å°å’Œè¿‡æœŸæ—¶é—´ã€‚</p>
<details>
<summary>ğŸ’¡ æç¤º</summary>
<ul>
<li>ç›‘æ§ç¼“å­˜å‘½ä¸­ç‡</li>
<li>ä½¿ç”¨å¼ºåŒ–å­¦ä¹ æˆ–å¯å‘å¼ç®—æ³•</li>
<li>è€ƒè™‘å†…å­˜çº¦æŸ</li>
<li>å®ç°å¹³æ»‘è¿‡æ¸¡</li>
</ul>
</details>
<details>
<summary>ğŸ“ ç­”æ¡ˆ</summary>
<p>è‡ªé€‚åº”ç®—æ³•è®¾è®¡ï¼š</p>
<ol>
<li>
<p><strong>ç›‘æ§æŒ‡æ ‡</strong>ï¼š
   - ç¼“å­˜å‘½ä¸­ç‡ï¼ˆç›®æ ‡ &gt; 80%ï¼‰
   - å¹³å‡æŸ¥è¯¢å»¶è¿Ÿ
   - å†…å­˜ä½¿ç”¨ç‡
   - æŸ¥è¯¢é¢‘ç‡åˆ†å¸ƒ</p>
</li>
<li>
<p><strong>è‡ªé€‚åº”ç­–ç•¥</strong>ï¼š</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">if</span> <span class="n">hit_rate</span> <span class="o">&lt;</span> <span class="mf">0.7</span> <span class="ow">and</span> <span class="n">memory_usage</span> <span class="o">&lt;</span> <span class="mf">0.8</span><span class="p">:</span>
    <span class="n">cache_size</span> <span class="o">*=</span> <span class="mf">1.5</span>
    <span class="n">ttl</span> <span class="o">*=</span> <span class="mf">1.2</span>
<span class="k">elif</span> <span class="n">hit_rate</span> <span class="o">&gt;</span> <span class="mf">0.9</span> <span class="ow">and</span> <span class="n">memory_usage</span> <span class="o">&gt;</span> <span class="mf">0.6</span><span class="p">:</span>
    <span class="n">cache_size</span> <span class="o">*=</span> <span class="mf">0.8</span>
    <span class="n">ttl</span> <span class="o">*=</span> <span class="mf">0.9</span>
</code></pre></div>

<ol start="3">
<li>
<p><strong>å¹³æ»‘è¿‡æ¸¡</strong>ï¼š
   - é€æ­¥è°ƒæ•´ï¼Œæ¯æ¬¡å˜åŒ–ä¸è¶…è¿‡ 20%
   - ä½¿ç”¨æ»‘åŠ¨çª—å£å¹³å‡é¿å…éœ‡è¡
   - ä¿ç•™æœ€å°ç¼“å­˜å¤§å°ï¼ˆå¦‚ 16 ä¸ªæ¡ç›®ï¼‰</p>
</li>
<li>
<p><strong>æ™ºèƒ½æ·˜æ±°</strong>ï¼š
   - LFU + LRU æ··åˆç­–ç•¥
   - æ ¹æ®æŸ¥è¯¢æ¨¡å¼åŠ¨æ€è°ƒæ•´æƒé‡
   - ä¿æŠ¤é«˜ä»·å€¼å˜æ¢ï¼ˆé•¿é“¾è®¡ç®—ç»“æœï¼‰</p>
</li>
</ol>
</details>
<h2 id="89">8.9 å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<h3 id="1tf">é™·é˜± 1ï¼štf æ ‘ä¸­çš„ç¯è·¯</h3>
<p><strong>é—®é¢˜</strong>ï¼šé”™è¯¯åœ°å‘å¸ƒäº†å½¢æˆç¯è·¯çš„å˜æ¢ï¼Œå¯¼è‡´ tf2 æ— æ³•æ­£ç¡®è®¡ç®—å˜æ¢è·¯å¾„ã€‚</p>
<p><strong>ç—‡çŠ¶</strong>ï¼š<code>ConnectivityException: Could not find a connection between 'A' and 'B'</code></p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>rosrun tf2_tools view_frames.py</code> å¯è§†åŒ– tf æ ‘</li>
<li>ç¡®ä¿æ¯ä¸ªåæ ‡ç³»åªæœ‰ä¸€ä¸ªçˆ¶èŠ‚ç‚¹</li>
<li>æ£€æŸ¥æ˜¯å¦æœ‰é‡å¤å‘å¸ƒåŒä¸€å˜æ¢</li>
</ul>
<h3 id="2">é™·é˜± 2ï¼šæ—¶é—´æˆ³ä¸ä¸€è‡´</h3>
<p><strong>é—®é¢˜</strong>ï¼šä½¿ç”¨ç³»ç»Ÿæ—¶é—´è€Œé ROS æ—¶é—´ï¼Œæˆ–ä¸åŒèŠ‚ç‚¹çš„æ—¶é’Ÿä¸åŒæ­¥ã€‚</p>
<p><strong>ç—‡çŠ¶</strong>ï¼š<code>ExtrapolationException: Lookup would require extrapolation into the future</code></p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<ul>
<li>å§‹ç»ˆä½¿ç”¨ <code>self.get_clock().now()</code></li>
<li>é…ç½® NTP/PTP æ—¶é—´åŒæ­¥</li>
<li>è®¾ç½®åˆç†çš„å˜æ¢å®¹å·®</li>
</ul>
<h3 id="3">é™·é˜± 3ï¼šå˜æ¢å‘å¸ƒé¢‘ç‡ä¸è¶³</h3>
<p><strong>é—®é¢˜</strong>ï¼šåŠ¨æ€å˜æ¢å‘å¸ƒé¢‘ç‡å¤ªä½ï¼Œå¯¼è‡´å¤–æ¨è¯¯å·®å¤§ã€‚</p>
<p><strong>ç—‡çŠ¶</strong>ï¼šæœºå™¨äººè¿åŠ¨æ—¶ä½ç½®è·³å˜ï¼Œè·¯å¾„è§„åˆ’å¤±è´¥</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<ul>
<li>åŠ¨æ€å˜æ¢è‡³å°‘ 10Hzï¼Œæ¨è 30-100Hz</li>
<li>é«˜é€Ÿè¿åŠ¨æ—¶ç›¸åº”æé«˜é¢‘ç‡</li>
<li>ä½¿ç”¨æ‰¹é‡å‘å¸ƒå‡å°‘å¼€é”€</li>
</ul>
<h3 id="4">é™·é˜± 4ï¼šåæ ‡ç³»å‘½åä¸è§„èŒƒ</h3>
<p><strong>é—®é¢˜</strong>ï¼šä½¿ç”¨éæ ‡å‡†å‘½åï¼Œå¯¼è‡´ä¸å…¶ä»–åŒ…ä¸å…¼å®¹ã€‚</p>
<p><strong>ç—‡çŠ¶</strong>ï¼šå¯¼èˆªæ ˆã€MoveIt ç­‰æ— æ³•æ­£å¸¸å·¥ä½œ</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<ul>
<li>éµå¾ª REP 105 å‘½åè§„èŒƒ</li>
<li>ä½¿ç”¨ä¸‹åˆ’çº¿è€Œéè¿å­—ç¬¦</li>
<li>é¿å…ä½¿ç”¨ç‰¹æ®Šå­—ç¬¦</li>
</ul>
<h3 id="5">é™·é˜± 5ï¼šç¼“å†²åŒºæº¢å‡º</h3>
<p><strong>é—®é¢˜</strong>ï¼štf ç¼“å†²åŒºä¿å­˜æ—¶é—´è¿‡é•¿ï¼Œæ¶ˆè€—å¤§é‡å†…å­˜ã€‚</p>
<p><strong>ç—‡çŠ¶</strong>ï¼šèŠ‚ç‚¹å†…å­˜æŒç»­å¢é•¿ï¼Œæœ€ç»ˆ OOM</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># é™åˆ¶ç¼“å†²åŒºæ—¶é—´çª—å£</span>
<span class="bp">self</span><span class="o">.</span><span class="n">tf_buffer</span> <span class="o">=</span> <span class="n">Buffer</span><span class="p">(</span><span class="n">cache_time</span><span class="o">=</span><span class="n">Duration</span><span class="p">(</span><span class="n">seconds</span><span class="o">=</span><span class="mf">10.0</span><span class="p">))</span>
</code></pre></div>

<h3 id="6">é™·é˜± 6ï¼šæŸ¥è¯¢æœªæ¥æ—¶é—´</h3>
<p><strong>é—®é¢˜</strong>ï¼šæŸ¥è¯¢è¿˜æœªå‘å¸ƒçš„å˜æ¢ã€‚</p>
<p><strong>ç—‡çŠ¶</strong>ï¼š<code>ExtrapolationException</code></p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨ <code>Time()</code> æŸ¥è¯¢æœ€æ–°å¯ç”¨å˜æ¢</li>
<li>æˆ–ç­‰å¾…å˜æ¢å¯ç”¨ï¼š<code>tf_buffer.wait_for_transform()</code></li>
</ul>
<h2 id="810">8.10 æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_3">è®¾è®¡é˜¶æ®µ</h3>
<ul>
<li>[ ] tf æ ‘è®¾è®¡éµå¾ªä»å…¨å±€åˆ°å±€éƒ¨çš„å±‚æ¬¡ç»“æ„</li>
<li>[ ] åæ ‡ç³»å‘½åç¬¦åˆ REP 105 è§„èŒƒ</li>
<li>[ ] è¯†åˆ«å¹¶åˆ†ç¦»é™æ€/åŠ¨æ€å˜æ¢</li>
<li>[ ] è€ƒè™‘å¤šæœºå™¨äººåœºæ™¯çš„å‘½åç©ºé—´</li>
<li>[ ] è¯„ä¼°å˜æ¢æ›´æ–°é¢‘ç‡éœ€æ±‚</li>
</ul>
<h3 id="_4">å®ç°é˜¶æ®µ</h3>
<ul>
<li>[ ] ä½¿ç”¨ StaticTransformBroadcaster å‘å¸ƒå›ºå®šå˜æ¢</li>
<li>[ ] åŠ¨æ€å˜æ¢å‘å¸ƒé¢‘ç‡ â‰¥ 10Hz</li>
<li>[ ] æ‰€æœ‰æ—¶é—´æˆ³ä½¿ç”¨ ROS æ—¶é’Ÿ</li>
<li>[ ] å®ç°å¼‚å¸¸å¤„ç†ï¼ˆLookupException ç­‰ï¼‰</li>
<li>[ ] è®¾ç½®åˆç†çš„æŸ¥è¯¢è¶…æ—¶</li>
</ul>
<h3 id="_5">ä¼˜åŒ–é˜¶æ®µ</h3>
<ul>
<li>[ ] é…ç½®é€‚å½“çš„ç¼“å†²åŒºå¤§å°</li>
<li>[ ] å®ç°å…³é”®è·¯å¾„çš„ç¼“å­˜</li>
<li>[ ] ç›‘æ§ tf æ ‘å¥åº·çŠ¶æ€</li>
<li>[ ] é¢„è®¡ç®—å¸¸ç”¨å˜æ¢é“¾</li>
<li>[ ] æ‰¹é‡å‘å¸ƒå‡å°‘é€šä¿¡å¼€é”€</li>
</ul>
<h3 id="_6">æµ‹è¯•é˜¶æ®µ</h3>
<ul>
<li>[ ] éªŒè¯ tf æ ‘å®Œæ•´æ€§ï¼ˆæ— ç¯è·¯ã€å…¨è¿é€šï¼‰</li>
<li>[ ] æµ‹è¯•é«˜è´Ÿè½½ä¸‹çš„æ€§èƒ½</li>
<li>[ ] éªŒè¯æ—¶é—´åŒæ­¥ç²¾åº¦</li>
<li>[ ] æµ‹è¯•èŠ‚ç‚¹æ•…éšœæ¢å¤</li>
<li>[ ] æ£€æŸ¥å†…å­˜æ³„æ¼</li>
</ul>
<h3 id="_7">éƒ¨ç½²é˜¶æ®µ</h3>
<ul>
<li>[ ] é…ç½®ç³»ç»Ÿæ—¶é—´åŒæ­¥ï¼ˆNTP/PTPï¼‰</li>
<li>[ ] è®¾ç½® tf è¯Šæ–­ç›‘æ§</li>
<li>[ ] å‡†å¤‡å¯è§†åŒ–å·¥å…·ï¼ˆrviz2 é…ç½®ï¼‰</li>
<li>[ ] è®°å½•å…³é”®å˜æ¢çš„æ›´æ–°é¢‘ç‡</li>
<li>[ ] å»ºç«‹æ€§èƒ½åŸºå‡†å’Œå‘Šè­¦é˜ˆå€¼</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter7.html" class="nav-link prev">â† ç¬¬ 7 ç« ï¼šLaunch ç³»ç»Ÿä¸é…ç½®ç®¡ç†</a><a href="chapter9.html" class="nav-link next">ç¬¬ 9 ç« ï¼šæ—¶é—´åŒæ­¥ä¸å›æ”¾ç³»ç»Ÿ â†’</a></nav>
        </main>
    </div>
</body>
</html>