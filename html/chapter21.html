<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬ 21 ç« ï¼šå¤§è¯­è¨€æ¨¡å‹ä¸å…·èº«æ™ºèƒ½</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ROS2 å®Œå…¨æ•™ç¨‹ï¼šä»åŸç†åˆ°å®è·µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 1 ç« ï¼šROS1 æ ¸å¿ƒæ¦‚å¿µå›é¡¾</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 2 ç« ï¼šROS1 çš„å±€é™æ€§åˆ†æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 3 ç« ï¼šä» ROS1 åˆ° ROS2 çš„è¿ç§»ç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 4 ç« ï¼šROS2 æ¶æ„ä¸è®¾è®¡ç†å¿µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 5 ç« ï¼šèŠ‚ç‚¹ä¸æ‰§è¡Œå™¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 6 ç« ï¼šé€šä¿¡æœºåˆ¶æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 7 ç« ï¼šLaunch ç³»ç»Ÿä¸é…ç½®ç®¡ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 8 ç« ï¼štf2 åæ ‡å˜æ¢æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 9 ç« ï¼šæ—¶é—´åŒæ­¥ä¸å›æ”¾ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 10 ç« ï¼šä¼ æ„Ÿå™¨æ•°æ®å¤„ç†ç®¡é“</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 11 ç« ï¼šSLAM ä¸å®šä½ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 12 ç« ï¼šå¯¼èˆªæ ˆ Nav2</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 13 ç« ï¼šros2_control æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 14 ç« ï¼šMoveIt2 è¿åŠ¨è§„åˆ’</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 15 ç« ï¼šå®æ—¶ç³»ç»Ÿä¸æ€§èƒ½ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 16 ç« ï¼šå®‰å…¨æ€§ä¸è¯Šæ–­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 17 ç« ï¼šä»¿çœŸé›†æˆï¼ˆGazebo/Ignitionï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 18 ç« ï¼šå¤šæœºå™¨äººç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 19 ç« ï¼šè®¡ç®—æœºè§†è§‰ä¸æ·±åº¦å­¦ä¹ </span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 20 ç« ï¼šæœºå™¨äººå¼ºåŒ–å­¦ä¹ </span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 21 ç« ï¼šå¤§è¯­è¨€æ¨¡å‹ä¸å…·èº«æ™ºèƒ½</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 22 ç« ï¼šç¥ç»ç½‘ç»œè¿åŠ¨æ§åˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="21">ç¬¬ 21 ç« ï¼šå¤§è¯­è¨€æ¨¡å‹ä¸å…·èº«æ™ºèƒ½</h1>
<p>å¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„å´›èµ·ä¸ºæœºå™¨äººé¢†åŸŸå¸¦æ¥äº†å‰æ‰€æœªæœ‰çš„å˜é©ã€‚é€šè¿‡å°† GPT-4ã€PaLMã€LLaMA ç­‰æ¨¡å‹ä¸ ROS2 ç³»ç»Ÿæ·±åº¦é›†æˆï¼Œæœºå™¨äººè·å¾—äº†ç†è§£è‡ªç„¶è¯­è¨€æŒ‡ä»¤ã€è¿›è¡Œå¸¸è¯†æ¨ç†ã€ç”Ÿæˆæ‰§è¡Œç­–ç•¥çš„èƒ½åŠ›ã€‚æœ¬ç« å°†æ·±å…¥æ¢è®¨å¦‚ä½•åœ¨ ROS2 ä¸­æ„å»º LLM é©±åŠ¨çš„æ™ºèƒ½æœºå™¨äººç³»ç»Ÿï¼Œå®ç°ä»è¯­è¨€ç†è§£åˆ°ç‰©ç†æ‰§è¡Œçš„å®Œæ•´é—­ç¯ã€‚</p>
<h2 id="211-llm">21.1 LLM ä»»åŠ¡è§„åˆ’èŠ‚ç‚¹</h2>
<h3 id="2111">21.1.1 æ¶æ„è®¾è®¡</h3>
<p>LLM ä»»åŠ¡è§„åˆ’å™¨ä½œä¸ºæœºå™¨äººç³»ç»Ÿçš„"å¤§è„‘"ï¼Œè´Ÿè´£å°†é«˜å±‚æ¬¡çš„è‡ªç„¶è¯­è¨€æŒ‡ä»¤è½¬æ¢ä¸ºå¯æ‰§è¡Œçš„æœºå™¨äººåŠ¨ä½œåºåˆ—ã€‚åœ¨ ROS2 ä¸­ï¼Œæˆ‘ä»¬é€šè¿‡ä¸“é—¨çš„è§„åˆ’èŠ‚ç‚¹æ¥å°è£… LLM åŠŸèƒ½ï¼š</p>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                ç”¨æˆ·è¯­éŸ³/æ–‡æœ¬è¾“å…¥                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚            LLM Task Planner Node                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Prompt Engineering Module          â”‚  â”‚
â”‚  â”‚  - ç¯å¢ƒçŠ¶æ€ç¼–ç                            â”‚  â”‚
â”‚  â”‚  - ä»»åŠ¡å†å²ç®¡ç†                           â”‚  â”‚
â”‚  â”‚  - çº¦æŸæ¡ä»¶æ³¨å…¥                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                      â”‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           LLM Inference Engine             â”‚  â”‚
â”‚  â”‚  - API è°ƒç”¨ç®¡ç†                            â”‚  â”‚
â”‚  â”‚  - æµå¼å“åº”å¤„ç†                           â”‚  â”‚
â”‚  â”‚  - ç¼“å­˜ä¸ä¼˜åŒ–                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                      â”‚                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚         Plan Validation Module             â”‚  â”‚
â”‚  â”‚  - è¯­æ³•æ£€æŸ¥                               â”‚  â”‚
â”‚  â”‚  - å¯è¡Œæ€§éªŒè¯                             â”‚  â”‚
â”‚  â”‚  - å®‰å…¨æ€§å®¡æ ¸                             â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Action Execution Layer              â”‚
â”‚   (Nav2 / MoveIt2 / ros2_control)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="2112-prompt">21.1.2 Prompt å·¥ç¨‹ç­–ç•¥</h3>
<p>æœ‰æ•ˆçš„ Prompt è®¾è®¡æ˜¯ LLM ä»»åŠ¡è§„åˆ’çš„æ ¸å¿ƒã€‚æˆ‘ä»¬é‡‡ç”¨ç»“æ„åŒ–çš„ Prompt æ¨¡æ¿ï¼ŒåŒ…å«ä»¥ä¸‹å…³é”®è¦ç´ ï¼š</p>
<ol>
<li><strong>ç³»ç»Ÿè§’è‰²å®šä¹‰</strong>ï¼šæ˜ç¡® LLM ä½œä¸ºæœºå™¨äººæ§åˆ¶å™¨çš„èŒè´£</li>
<li><strong>ç¯å¢ƒä¸Šä¸‹æ–‡</strong>ï¼šå½“å‰ä¼ æ„Ÿå™¨çŠ¶æ€ã€å¯ç”¨æ‰§è¡Œå™¨ã€ç¯å¢ƒåœ°å›¾</li>
<li><strong>åŠ¨ä½œåŸè¯­åº“</strong>ï¼šæœºå™¨äººå¯æ‰§è¡Œçš„åŸºæœ¬åŠ¨ä½œé›†åˆ</li>
<li><strong>çº¦æŸæ¡ä»¶</strong>ï¼šå®‰å…¨é™åˆ¶ã€ç‰©ç†çº¦æŸã€ä»»åŠ¡ä¼˜å…ˆçº§</li>
<li><strong>è¾“å‡ºæ ¼å¼è§„èŒƒ</strong>ï¼šç¡®ä¿ç”Ÿæˆçš„è®¡åˆ’å¯è¢«è§£ææ‰§è¡Œ</li>
</ol>
<p>å…¸å‹çš„ Prompt ç»“æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">System</span><span class="o">:</span><span class="w"> </span><span class="n">You</span><span class="w"> </span><span class="n">are</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">robot</span><span class="w"> </span><span class="n">controller</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">mobile</span><span class="w"> </span><span class="n">manipulator</span><span class="o">.</span><span class="w"> </span><span class="n">Your</span><span class="w"> </span><span class="n">available</span><span class="w"> </span><span class="n">actions</span><span class="w"> </span><span class="n">are</span><span class="o">:</span>

<span class="o">-</span><span class="w"> </span><span class="n">navigate_to</span><span class="o">(</span><span class="n">location</span><span class="o">):</span><span class="w"> </span><span class="n">Move</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">specified</span><span class="w"> </span><span class="n">location</span>
<span class="o">-</span><span class="w"> </span><span class="n">pick</span><span class="o">(</span><span class="n">object</span><span class="o">):</span><span class="w"> </span><span class="n">Grasp</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">specified</span><span class="w"> </span><span class="n">object</span><span class="w">  </span>
<span class="o">-</span><span class="w"> </span><span class="n">place</span><span class="o">(</span><span class="n">object</span><span class="o">,</span><span class="w"> </span><span class="n">location</span><span class="o">):</span><span class="w"> </span><span class="n">Place</span><span class="w"> </span><span class="n">object</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">location</span>
<span class="o">-</span><span class="w"> </span><span class="n">scan</span><span class="o">():</span><span class="w"> </span><span class="n">Perform</span><span class="w"> </span><span class="mi">360</span><span class="o">-</span><span class="n">degree</span><span class="w"> </span><span class="n">environment</span><span class="w"> </span><span class="n">scan</span>

<span class="n">Current</span><span class="w"> </span><span class="n">state</span><span class="o">:</span>

<span class="o">-</span><span class="w"> </span><span class="n">Robot</span><span class="w"> </span><span class="n">position</span><span class="o">:</span><span class="w"> </span><span class="o">(</span><span class="n">x</span><span class="o">=</span><span class="mf">2.5</span><span class="o">,</span><span class="w"> </span><span class="n">y</span><span class="o">=</span><span class="mf">1.0</span><span class="o">,</span><span class="w"> </span><span class="n">theta</span><span class="o">=</span><span class="mf">0.0</span><span class="o">)</span>
<span class="o">-</span><span class="w"> </span><span class="n">Gripper</span><span class="o">:</span><span class="w"> </span><span class="n">empty</span>
<span class="o">-</span><span class="w"> </span><span class="n">Detected</span><span class="w"> </span><span class="n">objects</span><span class="o">:</span><span class="w"> </span><span class="o">[</span><span class="n">red_cube</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">table_1</span><span class="o">,</span><span class="w"> </span><span class="n">blue_sphere</span><span class="w"> </span><span class="n">at</span><span class="w"> </span><span class="n">floor</span><span class="o">]</span>
<span class="o">-</span><span class="w"> </span><span class="n">Battery</span><span class="o">:</span><span class="w"> </span><span class="mi">85</span><span class="o">%</span>

<span class="n">Task</span><span class="o">:</span><span class="w"> </span><span class="o">{</span><span class="n">user_instruction</span><span class="o">}</span>

<span class="n">Generate</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="n">step</span><span class="o">-</span><span class="n">by</span><span class="o">-</span><span class="n">step</span><span class="w"> </span><span class="n">plan</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">JSON</span><span class="w"> </span><span class="n">format</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="n">safety</span><span class="w"> </span><span class="n">checks</span><span class="o">.</span>
</code></pre></div>

<h3 id="2113">21.1.3 ä¸Šä¸‹æ–‡ç®¡ç†ä¸è®°å¿†ç³»ç»Ÿ</h3>
<p>ä¸ºäº†å¤„ç†å¤æ‚çš„å¤šè½®å¯¹è¯å’Œé•¿æœŸä»»åŠ¡ï¼Œæˆ‘ä»¬å®ç°äº†åˆ†å±‚è®°å¿†ç³»ç»Ÿï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LLMContextManager</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_short_term</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">max_long_term</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">short_term_memory</span> <span class="o">=</span> <span class="n">deque</span><span class="p">(</span><span class="n">maxlen</span><span class="o">=</span><span class="n">max_short_term</span><span class="p">)</span>  <span class="c1"># æœ€è¿‘äº¤äº’</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">long_term_memory</span> <span class="o">=</span> <span class="p">[]</span>  <span class="c1"># é‡è¦äº‹ä»¶ä¸å­¦ä¹ ç»éªŒ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">episodic_memory</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># ä»»åŠ¡æ‰§è¡Œå†å²</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">semantic_memory</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># æ¦‚å¿µä¸çŸ¥è¯†å›¾è°±</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_interaction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">plan</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">result</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è®°å½•å®Œæ•´çš„äº¤äº’å¾ªç¯&quot;&quot;&quot;</span>
        <span class="n">interaction</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;timestamp&#39;</span><span class="p">:</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span>
            <span class="s1">&#39;instruction&#39;</span><span class="p">:</span> <span class="n">instruction</span><span class="p">,</span>
            <span class="s1">&#39;plan&#39;</span><span class="p">:</span> <span class="n">plan</span><span class="p">,</span>
            <span class="s1">&#39;execution_result&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
            <span class="s1">&#39;context_embedding&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_embedding</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">short_term_memory</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interaction</span><span class="p">)</span>

        <span class="c1"># è¯„ä¼°æ˜¯å¦è½¬å…¥é•¿æœŸè®°å¿†</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_important</span><span class="p">(</span><span class="n">interaction</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">long_term_memory</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">interaction</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">retrieve_relevant_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">query</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">k</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åŸºäºç›¸ä¼¼åº¦æ£€ç´¢ç›¸å…³å†å²&quot;&quot;&quot;</span>
        <span class="n">query_embedding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_compute_embedding</span><span class="p">(</span><span class="n">query</span><span class="p">)</span>

        <span class="c1"># ç»“åˆçŸ­æœŸå’Œé•¿æœŸè®°å¿†è¿›è¡Œæ£€ç´¢</span>
        <span class="n">all_memories</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">short_term_memory</span><span class="p">)</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">long_term_memory</span>
        <span class="n">similarities</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">cosine_similarity</span><span class="p">(</span><span class="n">query_embedding</span><span class="p">,</span> <span class="n">m</span><span class="p">[</span><span class="s1">&#39;context_embedding&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">all_memories</span>
        <span class="p">]</span>

        <span class="n">top_k_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="n">similarities</span><span class="p">)[</span><span class="o">-</span><span class="n">k</span><span class="p">:]</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">all_memories</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">top_k_indices</span><span class="p">]</span>
</code></pre></div>

<h3 id="2114-ros2">21.1.4 ä¸ ROS2 è¡Œä¸ºæ ‘é›†æˆ</h3>
<p>å°† LLM ç”Ÿæˆçš„é«˜å±‚è®¡åˆ’è½¬æ¢ä¸ºå¯æ‰§è¡Œçš„è¡Œä¸ºæ ‘æ˜¯å…³é”®æ­¥éª¤ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">&lt;!-- LLM ç”Ÿæˆçš„ä»»åŠ¡è½¬æ¢ä¸ºè¡Œä¸ºæ ‘ --&gt;</span>
<span class="nt">&lt;root</span><span class="w"> </span><span class="na">main_tree_to_execute=</span><span class="s">&quot;MainTree&quot;</span><span class="nt">&gt;</span>
<span class="w">  </span><span class="nt">&lt;BehaviorTree</span><span class="w"> </span><span class="na">ID=</span><span class="s">&quot;MainTree&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;Sequence&gt;</span>
<span class="w">      </span><span class="cm">&lt;!-- LLM è§„åˆ’éªŒè¯ --&gt;</span>
<span class="w">      </span><span class="nt">&lt;Action</span><span class="w"> </span><span class="na">ID=</span><span class="s">&quot;ValidateLLMPlan&quot;</span><span class="w"> </span><span class="na">plan=</span><span class="s">&quot;{llm_plan}&quot;</span><span class="nt">/&gt;</span>

<span class="w">      </span><span class="cm">&lt;!-- åŠ¨æ€ç”Ÿæˆçš„å­ä»»åŠ¡ --&gt;</span>
<span class="w">      </span><span class="nt">&lt;Fallback&gt;</span>
<span class="w">        </span><span class="nt">&lt;Sequence&gt;</span>
<span class="w">          </span><span class="nt">&lt;Action</span><span class="w"> </span><span class="na">ID=</span><span class="s">&quot;NavigateToTable&quot;</span><span class="w"> </span><span class="na">goal=</span><span class="s">&quot;{table_position}&quot;</span><span class="nt">/&gt;</span>
<span class="w">          </span><span class="nt">&lt;Action</span><span class="w"> </span><span class="na">ID=</span><span class="s">&quot;IdentifyObject&quot;</span><span class="w"> </span><span class="na">target=</span><span class="s">&quot;{object_name}&quot;</span><span class="nt">/&gt;</span>
<span class="w">          </span><span class="nt">&lt;Action</span><span class="w"> </span><span class="na">ID=</span><span class="s">&quot;GraspObject&quot;</span><span class="w"> </span><span class="na">approach=</span><span class="s">&quot;{grasp_strategy}&quot;</span><span class="nt">/&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Sequence&gt;</span>

<span class="w">        </span><span class="cm">&lt;!-- å¤±è´¥æ¢å¤ï¼šè¯·æ±‚ LLM é‡æ–°è§„åˆ’ --&gt;</span>
<span class="w">        </span><span class="nt">&lt;Action</span><span class="w"> </span><span class="na">ID=</span><span class="s">&quot;RequestLLMReplan&quot;</span><span class="w"> </span>
<span class="w">                </span><span class="na">context=</span><span class="s">&quot;{failure_reason}&quot;</span>
<span class="w">                </span><span class="na">max_attempts=</span><span class="s">&quot;3&quot;</span><span class="nt">/&gt;</span>
<span class="w">      </span><span class="nt">&lt;/Fallback&gt;</span>

<span class="w">      </span><span class="cm">&lt;!-- æ‰§è¡Œç¡®è®¤ --&gt;</span>
<span class="w">      </span><span class="nt">&lt;Action</span><span class="w"> </span><span class="na">ID=</span><span class="s">&quot;ReportToLLM&quot;</span><span class="w"> </span><span class="na">status=</span><span class="s">&quot;{execution_status}&quot;</span><span class="nt">/&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Sequence&gt;</span>
<span class="w">  </span><span class="nt">&lt;/BehaviorTree&gt;</span>
<span class="nt">&lt;/root&gt;</span>
</code></pre></div>

<h2 id="212-vlm">21.2 è§†è§‰-è¯­è¨€æ¨¡å‹ï¼ˆVLMï¼‰é›†æˆ</h2>
<h3 id="2121">21.2.1 å¤šæ¨¡æ€æ„ŸçŸ¥æ¶æ„</h3>
<p>è§†è§‰-è¯­è¨€æ¨¡å‹ä½¿æœºå™¨äººèƒ½å¤Ÿç†è§£è§†è§‰åœºæ™¯å¹¶ç”¨è‡ªç„¶è¯­è¨€æè¿°ï¼Œå®ç°"çœ‹å›¾è¯´è¯"å’Œ"å¬è¯çœ‹å›¾"çš„èƒ½åŠ›ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">VLMPerceptionNode</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;vlm_perception_node&#39;</span><span class="p">)</span>

        <span class="c1"># è®¢é˜…å¤šæ¨¡æ€è¾“å…¥</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">image_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
            <span class="n">Image</span><span class="p">,</span> <span class="s1">&#39;/camera/image_raw&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_callback</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pointcloud_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
            <span class="n">PointCloud2</span><span class="p">,</span> <span class="s1">&#39;/velodyne/points&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointcloud_callback</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1"># VLM æœåŠ¡</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vlm_service</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_service</span><span class="p">(</span>
            <span class="n">VLMQuery</span><span class="p">,</span> <span class="s1">&#39;vlm_query&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_vlm_query</span><span class="p">)</span>

        <span class="c1"># åœºæ™¯æè¿°å‘å¸ƒ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scene_desc_pub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span>
            <span class="n">String</span><span class="p">,</span> <span class="s1">&#39;/scene_description&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

        <span class="c1"># åˆå§‹åŒ– VLM æ¨¡å‹ï¼ˆå¦‚ CLIP, BLIP-2, LLaVAï¼‰</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vlm_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_vlm_model</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">image_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">:</span> <span class="n">Image</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å¤„ç†å›¾åƒè¾“å…¥å¹¶ç”Ÿæˆåœºæ™¯æè¿°&quot;&quot;&quot;</span>
        <span class="c1"># å›¾åƒé¢„å¤„ç†</span>
        <span class="n">cv_image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">imgmsg_to_cv2</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s2">&quot;rgb8&quot;</span><span class="p">)</span>

        <span class="c1"># VLM æ¨ç†</span>
        <span class="n">scene_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlm_model</span><span class="o">.</span><span class="n">encode_image</span><span class="p">(</span><span class="n">cv_image</span><span class="p">)</span>
        <span class="n">description</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlm_model</span><span class="o">.</span><span class="n">generate_description</span><span class="p">(</span><span class="n">scene_features</span><span class="p">)</span>

        <span class="c1"># å‘å¸ƒåœºæ™¯æè¿°</span>
        <span class="n">desc_msg</span> <span class="o">=</span> <span class="n">String</span><span class="p">()</span>
        <span class="n">desc_msg</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">description</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scene_desc_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">desc_msg</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_vlm_query</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å¤„ç†è§†è§‰é—®ç­”è¯·æ±‚&quot;&quot;&quot;</span>
        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bridge</span><span class="o">.</span><span class="n">imgmsg_to_cv2</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">image</span><span class="p">,</span> <span class="s2">&quot;rgb8&quot;</span><span class="p">)</span>
        <span class="n">question</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">question</span>

        <span class="c1"># å¤šæ¨¡æ€æ¨ç†</span>
        <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlm_model</span><span class="o">.</span><span class="n">answer_question</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">question</span><span class="p">)</span>

        <span class="n">response</span><span class="o">.</span><span class="n">answer</span> <span class="o">=</span> <span class="n">answer</span>
        <span class="n">response</span><span class="o">.</span><span class="n">confidence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlm_model</span><span class="o">.</span><span class="n">get_confidence</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">response</span>
</code></pre></div>

<h3 id="2122">21.2.2 åœºæ™¯ç†è§£ä¸ç‰©ä½“å…³ç³»æ¨ç†</h3>
<p>VLM ä¸ä»…è¯†åˆ«ç‰©ä½“ï¼Œè¿˜ç†è§£å®ƒä»¬ä¹‹é—´çš„ç©ºé—´å…³ç³»å’Œè¯­ä¹‰è”ç³»ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SceneGraphGenerator</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vlm_model</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vlm</span> <span class="o">=</span> <span class="n">vlm_model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scene_graph</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">DiGraph</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">build_scene_graph</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">depth_map</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ„å»ºåœºæ™¯å›¾è°±&quot;&quot;&quot;</span>
        <span class="c1"># 1. ç‰©ä½“æ£€æµ‹ä¸åˆ†å‰²</span>
        <span class="n">objects</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_objects</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

        <span class="c1"># 2. ç©ºé—´å…³ç³»æå–</span>
        <span class="k">for</span> <span class="n">obj1</span><span class="p">,</span> <span class="n">obj2</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="n">objects</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
            <span class="n">relation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlm</span><span class="o">.</span><span class="n">infer_relation</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">obj1</span><span class="p">,</span> <span class="n">obj2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">relation</span><span class="o">.</span><span class="n">confidence</span> <span class="o">&gt;</span> <span class="mf">0.7</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">scene_graph</span><span class="o">.</span><span class="n">add_edge</span><span class="p">(</span>
                    <span class="n">obj1</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">obj2</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
                    <span class="n">relation</span><span class="o">=</span><span class="n">relation</span><span class="o">.</span><span class="n">type</span><span class="p">,</span>
                    <span class="n">confidence</span><span class="o">=</span><span class="n">relation</span><span class="o">.</span><span class="n">confidence</span>
                <span class="p">)</span>

        <span class="c1"># 3. å±æ€§æ ‡æ³¨</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">objects</span><span class="p">:</span>
            <span class="n">attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlm</span><span class="o">.</span><span class="n">extract_attributes</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">obj</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scene_graph</span><span class="o">.</span><span class="n">nodes</span><span class="p">[</span><span class="n">obj</span><span class="o">.</span><span class="n">id</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">attributes</span><span class="p">)</span>

        <span class="c1"># 4. åœºæ™¯æ ‡é¢˜ç”Ÿæˆ</span>
        <span class="n">scene_caption</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlm</span><span class="o">.</span><span class="n">generate_caption</span><span class="p">(</span>
            <span class="n">image</span><span class="p">,</span> 
            <span class="n">context</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scene_graph</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">scene_graph</span><span class="p">,</span> <span class="n">scene_caption</span>
</code></pre></div>

<h3 id="2123-grounding">21.2.3 è§†è§‰ Grounding ä¸æŒ‡ç§°ç†è§£</h3>
<p>å°†è‡ªç„¶è¯­è¨€æè¿°å®šä½åˆ°å›¾åƒä¸­çš„å…·ä½“åŒºåŸŸï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">VisualGrounding</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">grounding_model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="s1">&#39;grounding_dino&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sam_model</span> <span class="o">=</span> <span class="n">load_model</span><span class="p">(</span><span class="s1">&#39;segment_anything&#39;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ground_referring_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">expression</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        å®šä½æŒ‡ç§°è¡¨è¾¾å¼å¯¹åº”çš„å›¾åƒåŒºåŸŸ</span>
<span class="sd">        å¦‚ï¼š&quot;çº¢è‰²æ¯å­å³è¾¹çš„è“è‰²ç¬”&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># 1. æå–å…³é”®å®ä½“</span>
        <span class="n">entities</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_entities</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

        <span class="c1"># 2. ç›®æ ‡æ£€æµ‹</span>
        <span class="n">detections</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grounding_model</span><span class="o">.</span><span class="n">detect</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">entities</span><span class="p">)</span>

        <span class="c1"># 3. å…³ç³»æ¨ç†</span>
        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_spatial_relations</span><span class="p">(</span><span class="n">detections</span><span class="p">,</span> <span class="n">expression</span><span class="p">)</span>

        <span class="c1"># 4. ç²¾ç¡®åˆ†å‰²</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sam_model</span><span class="o">.</span><span class="n">segment</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">target</span><span class="o">.</span><span class="n">bbox</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s1">&#39;bbox&#39;</span><span class="p">:</span> <span class="n">target</span><span class="o">.</span><span class="n">bbox</span><span class="p">,</span>
            <span class="s1">&#39;mask&#39;</span><span class="p">:</span> <span class="n">mask</span><span class="p">,</span>
            <span class="s1">&#39;confidence&#39;</span><span class="p">:</span> <span class="n">target</span><span class="o">.</span><span class="n">confidence</span><span class="p">,</span>
            <span class="s1">&#39;attributes&#39;</span><span class="p">:</span> <span class="n">target</span><span class="o">.</span><span class="n">attributes</span>
        <span class="p">}</span>

<span class="c1">## 21.3 è‡ªç„¶è¯­è¨€å¯¼èˆªï¼ˆVLNï¼‰</span>

<span class="c1">### 21.3.1 è¯­è¨€æŒ‡ä»¤åˆ°è·¯å¾„è§„åˆ’</span>

<span class="n">è‡ªç„¶è¯­è¨€å¯¼èˆª</span><span class="err">ï¼ˆ</span><span class="n">Vision</span><span class="o">-</span><span class="ow">and</span><span class="o">-</span><span class="n">Language</span> <span class="n">Navigation</span><span class="err">ï¼‰</span><span class="n">ä½¿æœºå™¨äººèƒ½å¤Ÿç†è§£å’Œæ‰§è¡Œå¤æ‚çš„å¯¼èˆªæŒ‡ä»¤</span><span class="err">ï¼Œ</span><span class="n">å¦‚</span><span class="s2">&quot;èµ°åˆ°å¨æˆ¿ï¼Œç»•è¿‡é¤æ¡Œï¼Œåœ¨å†°ç®±å‰åœä¸‹&quot;</span><span class="err">ï¼š</span>

<span class="err">```</span><span class="n">python</span>
<span class="k">class</span><span class="w"> </span><span class="nc">VLNNavigator</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;vln_navigator&#39;</span><span class="p">)</span>

        <span class="c1"># è¯­è¨€ç¼–ç å™¨</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">language_encoder</span> <span class="o">=</span> <span class="n">BertModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;bert-base-chinese&#39;</span><span class="p">)</span>

        <span class="c1"># è§†è§‰ç¼–ç å™¨</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vision_encoder</span> <span class="o">=</span> <span class="n">ResNetEncoder</span><span class="p">()</span>

        <span class="c1"># è·¨æ¨¡æ€èåˆç½‘ç»œ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross_modal_attention</span> <span class="o">=</span> <span class="n">CrossModalTransformer</span><span class="p">(</span>
            <span class="n">d_model</span><span class="o">=</span><span class="mi">768</span><span class="p">,</span>
            <span class="n">n_heads</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
            <span class="n">n_layers</span><span class="o">=</span><span class="mi">6</span>
        <span class="p">)</span>

        <span class="c1"># åŠ¨ä½œé¢„æµ‹å¤´</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_predictor</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Sequential</span><span class="p">(</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">768</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">ReLU</span><span class="p">(),</span>
            <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>  <span class="c1"># å‰è¿›/åé€€/å·¦è½¬/å³è½¬/åœæ­¢/æ‰«æ</span>
        <span class="p">)</span>

        <span class="c1"># ROS2 æ¥å£</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nav_goal_pub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span>
            <span class="n">NavigateToPose</span><span class="p">,</span> <span class="s1">&#39;/navigate_to_pose&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">instruction_sub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_subscription</span><span class="p">(</span>
            <span class="n">String</span><span class="p">,</span> <span class="s1">&#39;/navigation_instruction&#39;</span><span class="p">,</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">process_instruction</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_instruction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å¤„ç†å¯¼èˆªæŒ‡ä»¤&quot;&quot;&quot;</span>
        <span class="n">instruction</span> <span class="o">=</span> <span class="n">msg</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># 1. æŒ‡ä»¤è§£æä¸åˆ†è§£</span>
        <span class="n">sub_goals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decompose_instruction</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>

        <span class="c1"># 2. æ‰§è¡Œå¯¼èˆªåºåˆ—</span>
        <span class="k">for</span> <span class="n">sub_goal</span> <span class="ow">in</span> <span class="n">sub_goals</span><span class="p">:</span>
            <span class="c1"># è·å–å½“å‰è§‚æµ‹</span>
            <span class="n">current_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_current_observation</span><span class="p">()</span>

            <span class="c1"># é¢„æµ‹ä¸‹ä¸€æ­¥åŠ¨ä½œ</span>
            <span class="n">action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predict_action</span><span class="p">(</span><span class="n">sub_goal</span><span class="p">,</span> <span class="n">current_view</span><span class="p">)</span>

            <span class="c1"># æ‰§è¡ŒåŠ¨ä½œ</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">execute_navigation_action</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

            <span class="c1"># æ£€æŸ¥æ˜¯å¦åˆ°è¾¾å­ç›®æ ‡</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_subgoal_reached</span><span class="p">(</span><span class="n">sub_goal</span><span class="p">,</span> <span class="n">current_view</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">get_logger</span><span class="p">()</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Reached subgoal: </span><span class="si">{</span><span class="n">sub_goal</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">decompose_instruction</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å°†å¤æ‚æŒ‡ä»¤åˆ†è§£ä¸ºå­ç›®æ ‡&quot;&quot;&quot;</span>
        <span class="c1"># ä½¿ç”¨ LLM æˆ–è§„åˆ™åˆ†è§£</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        å°†ä»¥ä¸‹å¯¼èˆªæŒ‡ä»¤åˆ†è§£ä¸ºç®€å•çš„å­æ­¥éª¤ï¼š</span>
<span class="s2">        æŒ‡ä»¤ï¼š</span><span class="si">{</span><span class="n">instruction</span><span class="si">}</span>

<span class="s2">        è¾“å‡ºæ ¼å¼ï¼š</span>

<span class="s2">        1. ç¬¬ä¸€æ­¥åŠ¨ä½œ</span>
<span class="s2">        2. ç¬¬äºŒæ­¥åŠ¨ä½œ</span>
<span class="s2">        ...</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="n">sub_goals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm_decompose</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">sub_goals</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">predict_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">,</span> <span class="n">observation</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åŸºäºæŒ‡ä»¤å’Œè§‚æµ‹é¢„æµ‹åŠ¨ä½œ&quot;&quot;&quot;</span>
        <span class="c1"># ç¼–ç è¯­è¨€æŒ‡ä»¤</span>
        <span class="n">inst_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tokenizer</span><span class="p">(</span><span class="n">instruction</span><span class="p">,</span> <span class="n">return_tensors</span><span class="o">=</span><span class="s1">&#39;pt&#39;</span><span class="p">)</span>
        <span class="n">inst_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">language_encoder</span><span class="p">(</span><span class="o">**</span><span class="n">inst_tokens</span><span class="p">)</span><span class="o">.</span><span class="n">last_hidden_state</span>

        <span class="c1"># ç¼–ç è§†è§‰è§‚æµ‹</span>
        <span class="n">vis_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vision_encoder</span><span class="p">(</span><span class="n">observation</span><span class="p">)</span>

        <span class="c1"># è·¨æ¨¡æ€æ³¨æ„åŠ›</span>
        <span class="n">fused_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_modal_attention</span><span class="p">(</span>
            <span class="n">inst_features</span><span class="p">,</span> <span class="n">vis_features</span>
        <span class="p">)</span>

        <span class="c1"># é¢„æµ‹åŠ¨ä½œ</span>
        <span class="n">action_logits</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_predictor</span><span class="p">(</span><span class="n">fused_features</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
        <span class="n">action</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">action_logits</span><span class="p">,</span> <span class="n">dim</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">action</span>
</code></pre></div>

<h3 id="2132">21.3.2 ç©ºé—´è¯­è¨€ç†è§£</h3>
<p>ç†è§£ç©ºé—´å…³ç³»è¯æ±‡å¹¶æ˜ å°„åˆ°æœºå™¨äººåæ ‡ç³»ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SpatialLanguageGrounder</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spatial_relations</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;å‰é¢&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;åé¢&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span>
            <span class="s1">&#39;å·¦è¾¹&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span>
            <span class="s1">&#39;å³è¾¹&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">),</span>
            <span class="s1">&#39;æ—è¾¹&#39;</span><span class="p">:</span> <span class="s1">&#39;proximity&#39;</span><span class="p">,</span>
            <span class="s1">&#39;ä¹‹é—´&#39;</span><span class="p">:</span> <span class="s1">&#39;between&#39;</span><span class="p">,</span>
            <span class="s1">&#39;é™„è¿‘&#39;</span><span class="p">:</span> <span class="s1">&#39;near&#39;</span><span class="p">,</span>
            <span class="s1">&#39;è¿œç¦»&#39;</span><span class="p">:</span> <span class="s1">&#39;far_from&#39;</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">ground_spatial_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">scene_objects</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        å°†ç©ºé—´è¡¨è¾¾æ¥åœ°åˆ°å…·ä½“ä½ç½®</span>
<span class="sd">        ä¾‹å¦‚ï¼š&quot;æ¡Œå­å’Œæ¤…å­ä¹‹é—´çš„ä½ç½®&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># è§£æç©ºé—´å…³ç³»</span>
        <span class="n">relation</span><span class="p">,</span> <span class="n">anchors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_spatial_relation</span><span class="p">(</span><span class="n">expression</span><span class="p">)</span>

        <span class="c1"># æ‰¾åˆ°é”šç‚¹ç‰©ä½“</span>
        <span class="n">anchor_objects</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">anchor</span> <span class="ow">in</span> <span class="n">anchors</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_object_by_description</span><span class="p">(</span><span class="n">anchor</span><span class="p">,</span> <span class="n">scene_objects</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">obj</span><span class="p">:</span>
                <span class="n">anchor_objects</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>

        <span class="c1"># è®¡ç®—ç›®æ ‡ä½ç½®</span>
        <span class="k">if</span> <span class="n">relation</span> <span class="o">==</span> <span class="s1">&#39;between&#39;</span><span class="p">:</span>
            <span class="n">target_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_between_position</span><span class="p">(</span><span class="n">anchor_objects</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">relation</span> <span class="o">==</span> <span class="s1">&#39;near&#39;</span><span class="p">:</span>
            <span class="n">target_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_near_position</span><span class="p">(</span><span class="n">anchor_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ç›¸å¯¹æ–¹å‘</span>
            <span class="n">direction</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">spatial_relations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">relation</span><span class="p">)</span>
            <span class="n">target_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_relative_position</span><span class="p">(</span>
                <span class="n">anchor_objects</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">direction</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">target_pos</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">compute_between_position</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">objects</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è®¡ç®—ä¸¤ä¸ªç‰©ä½“ä¹‹é—´çš„ä½ç½®&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">pos1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">])</span>
        <span class="n">pos2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">objects</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">objects</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">y</span><span class="p">])</span>

        <span class="c1"># ä¸­ç‚¹ä½ç½®</span>
        <span class="n">midpoint</span> <span class="o">=</span> <span class="p">(</span><span class="n">pos1</span> <span class="o">+</span> <span class="n">pos2</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

        <span class="c1"># è€ƒè™‘ç¢°æ’ï¼Œç¨ä½œåç§»</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_collision_free_offset</span><span class="p">(</span><span class="n">midpoint</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">midpoint</span> <span class="o">+</span> <span class="n">offset</span>
</code></pre></div>

<h3 id="2133">21.3.3 æ­§ä¹‰æ¶ˆè§£ä¸ä¸»åŠ¨è¯¢é—®</h3>
<p>å¤„ç†æŒ‡ä»¤ä¸­çš„æ­§ä¹‰å¹¶é€šè¿‡å¯¹è¯æ¾„æ¸…ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AmbiguityResolver</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dialogue_manager</span> <span class="o">=</span> <span class="n">DialogueManager</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">context_tracker</span> <span class="o">=</span> <span class="n">ContextTracker</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_ambiguous_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">,</span> <span class="n">scene</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è§£å†³æŒ‡ç§°æ­§ä¹‰&quot;&quot;&quot;</span>
        <span class="c1"># æå–æŒ‡ç§°è¯</span>
        <span class="n">references</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_references</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>

        <span class="n">ambiguous_refs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">references</span><span class="p">:</span>
            <span class="n">candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_candidates</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">scene</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># æœªæ‰¾åˆ°åŒ¹é…</span>
                <span class="n">question</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;æˆ‘æ²¡æœ‰çœ‹åˆ°</span><span class="si">{</span><span class="n">ref</span><span class="si">}</span><span class="s2">ï¼Œæ‚¨èƒ½è¯¦ç»†æè¿°ä¸€ä¸‹å—ï¼Ÿ&quot;</span>
                <span class="n">clarification</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask_for_clarification</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
                <span class="c1"># é‡æ–°æœç´¢</span>
                <span class="n">candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_candidates</span><span class="p">(</span><span class="n">clarification</span><span class="p">,</span> <span class="n">scene</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="c1"># å¤šä¸ªå€™é€‰</span>
                <span class="n">question</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_disambiguation_question</span><span class="p">(</span>
                    <span class="n">ref</span><span class="p">,</span> <span class="n">candidates</span>
                <span class="p">)</span>
                <span class="n">answer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ask_for_clarification</span><span class="p">(</span><span class="n">question</span><span class="p">)</span>
                <span class="n">candidates</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_by_answer</span><span class="p">(</span><span class="n">candidates</span><span class="p">,</span> <span class="n">answer</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">context_tracker</span><span class="o">.</span><span class="n">add_resolution</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="n">candidates</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">context_tracker</span><span class="o">.</span><span class="n">get_resolved_instruction</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_disambiguation_question</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">reference</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç”Ÿæˆæ¶ˆæ­§é—®é¢˜&quot;&quot;&quot;</span>
        <span class="c1"># æ‰¾å‡ºåŒºåˆ†ç‰¹å¾</span>
        <span class="n">distinguishing_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_distinguishing_features</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;color&#39;</span> <span class="ow">in</span> <span class="n">distinguishing_features</span><span class="p">:</span>
            <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">color</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">]</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;æ‚¨æŒ‡çš„æ˜¯å“ªä¸ªé¢œè‰²çš„</span><span class="si">{</span><span class="n">reference</span><span class="si">}</span><span class="s2">ï¼Ÿå¯é€‰ï¼š</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">colors</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">elif</span> <span class="s1">&#39;location&#39;</span> <span class="ow">in</span> <span class="n">distinguishing_features</span><span class="p">:</span>
            <span class="n">locations</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">describe_location</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">]</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;æ‚¨æŒ‡çš„æ˜¯å“ªä¸ª</span><span class="si">{</span><span class="n">reference</span><span class="si">}</span><span class="s2">ï¼Ÿ</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ä½¿ç”¨ç´¢å¼•</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;æˆ‘çœ‹åˆ°</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">candidates</span><span class="p">)</span><span class="si">}</span><span class="s2">ä¸ª</span><span class="si">{</span><span class="n">reference</span><span class="si">}</span><span class="s2">ï¼Œæ‚¨æŒ‡çš„æ˜¯ç¬¬å‡ ä¸ªï¼Ÿ&quot;</span>
</code></pre></div>

<h2 id="214-code-as-policies">21.4 Code as Policies å®ç°</h2>
<h3 id="2141">21.4.1 ä»£ç ç”Ÿæˆæ¡†æ¶</h3>
<p>Code as Policies æ–¹æ³•è®© LLM ç›´æ¥ç”Ÿæˆå¯æ‰§è¡Œçš„æœºå™¨äººæ§åˆ¶ä»£ç ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CodeAsPolicies</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">llm</span> <span class="o">=</span> <span class="n">GPT4Interface</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">code_validator</span> <span class="o">=</span> <span class="n">CodeValidator</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sandbox_executor</span> <span class="o">=</span> <span class="n">SandboxExecutor</span><span class="p">()</span>

        <span class="c1"># å®šä¹‰æœºå™¨äºº API</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">robot_api</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        # å¯ç”¨çš„æœºå™¨äººæ§åˆ¶å‡½æ•°</span>
<span class="s2">        def move_to(x: float, y: float, theta: float = 0.0):</span>
<span class="s2">            &#39;&#39;&#39;ç§»åŠ¨åˆ°æŒ‡å®šä½ç½®&#39;&#39;&#39;</span>

<span class="s2">        def pick_object(obj_name: str, grasp_type: str = &#39;top&#39;):</span>
<span class="s2">            &#39;&#39;&#39;æŠ“å–æŒ‡å®šç‰©ä½“&#39;&#39;&#39;</span>

<span class="s2">        def place_object(location: str):</span>
<span class="s2">            &#39;&#39;&#39;æ”¾ç½®ç‰©ä½“åˆ°æŒ‡å®šä½ç½®&#39;&#39;&#39;</span>

<span class="s2">        def get_object_position(obj_name: str) -&gt; Tuple[float, float, float]:</span>
<span class="s2">            &#39;&#39;&#39;è·å–ç‰©ä½“ä½ç½®&#39;&#39;&#39;</span>

<span class="s2">        def detect_objects() -&gt; List[str]:</span>
<span class="s2">            &#39;&#39;&#39;æ£€æµ‹å½“å‰å¯è§ç‰©ä½“&#39;&#39;&#39;</span>
<span class="s2">        &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task_description</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scene_context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç”Ÿæˆä»»åŠ¡æ‰§è¡Œç­–ç•¥ä»£ç &quot;&quot;&quot;</span>
        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        ä»»åŠ¡ï¼š</span><span class="si">{</span><span class="n">task_description</span><span class="si">}</span>

<span class="s2">        åœºæ™¯ä¿¡æ¯ï¼š</span>
<span class="s2">        </span><span class="si">{</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">scene_context</span><span class="p">,</span><span class="w"> </span><span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span><span class="si">}</span>

<span class="s2">        ä½¿ç”¨ä»¥ä¸‹ API ç”Ÿæˆ Python ä»£ç å®Œæˆä»»åŠ¡ï¼š</span>
<span class="s2">        </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">robot_api</span><span class="si">}</span>

<span class="s2">        è¦æ±‚ï¼š</span>

<span class="s2">        1. æ·»åŠ å¿…è¦çš„é”™è¯¯å¤„ç†</span>
<span class="s2">        2. åœ¨å…³é”®æ­¥éª¤æ·»åŠ æ—¥å¿—</span>
<span class="s2">        3. è€ƒè™‘æ‰§è¡Œå¤±è´¥çš„æ¢å¤ç­–ç•¥</span>

<span class="s2">        ç”Ÿæˆçš„ä»£ç ï¼š</span>

<span class="s2">```python</span>
<span class="s2">&quot;&quot;&quot;</span>

<span class="c1"># LLM ç”Ÿæˆä»£ç </span>
<span class="n">generated_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

<span class="c1"># ä»£ç éªŒè¯</span>
<span class="n">validation_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">code_validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">generated_code</span><span class="p">)</span>

<span class="k">if</span> <span class="ow">not</span> <span class="n">validation_result</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
    <span class="c1"># åŸºäºé”™è¯¯ä¿¡æ¯é‡æ–°ç”Ÿæˆ</span>
    <span class="n">retry_prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">    ä¸Šæ¬¡ç”Ÿæˆçš„ä»£ç æœ‰ä»¥ä¸‹é—®é¢˜ï¼š</span>
<span class="s2">    </span><span class="si">{</span><span class="n">validation_result</span><span class="o">.</span><span class="n">errors</span><span class="si">}</span>

<span class="s2">    è¯·ä¿®æ­£å¹¶é‡æ–°ç”Ÿæˆï¼š</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="n">generated_code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="n">retry_prompt</span><span class="p">)</span>

<span class="k">return</span> <span class="n">generated_code</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">execute_policy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">timeout</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">30.0</span><span class="p">):</span>
<span class="sd">&quot;&quot;&quot;åœ¨æ²™ç›’ç¯å¢ƒä¸­æ‰§è¡Œç”Ÿæˆçš„ä»£ç &quot;&quot;&quot;</span>
<span class="c1"># æ³¨å…¥è¿è¡Œæ—¶ç¯å¢ƒ</span>
<span class="n">runtime_env</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;move_to&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_move_to</span><span class="p">,</span>
    <span class="s1">&#39;pick_object&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_pick</span><span class="p">,</span>
    <span class="s1">&#39;place_object&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">robot_place</span><span class="p">,</span>
    <span class="s1">&#39;get_object_position&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_object_pos</span><span class="p">,</span>
    <span class="s1">&#39;detect_objects&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">detect_objects</span><span class="p">,</span>
    <span class="s1">&#39;np&#39;</span><span class="p">:</span> <span class="n">np</span><span class="p">,</span>
    <span class="s1">&#39;math&#39;</span><span class="p">:</span> <span class="n">math</span>
<span class="p">}</span>

<span class="c1"># æ²™ç›’æ‰§è¡Œ</span>
<span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sandbox_executor</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
    <span class="n">code</span><span class="p">,</span>
    <span class="nb">globals</span><span class="o">=</span><span class="n">runtime_env</span><span class="p">,</span>
    <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span>
<span class="p">)</span>

<span class="k">return</span> <span class="n">result</span>
</code></pre></div>

<h3 id="2142">21.4.2 å®‰å…¨æ‰§è¡Œä¸éªŒè¯</h3>
<p>ç¡®ä¿ç”Ÿæˆçš„ä»£ç å®‰å…¨å¯é ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SafetyValidator</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forbidden_modules</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;os&#39;</span><span class="p">,</span> <span class="s1">&#39;subprocess&#39;</span><span class="p">,</span> <span class="s1">&#39;eval&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">,</span> <span class="s1">&#39;__import__&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">workspace_limits</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;x&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span>
            <span class="s1">&#39;y&#39;</span><span class="p">:</span> <span class="p">(</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span>
            <span class="s1">&#39;z&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">velocity_limits</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;linear&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># m/s</span>
            <span class="s1">&#39;angular&#39;</span><span class="p">:</span> <span class="mf">1.0</span>  <span class="c1"># rad/s</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">code</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ValidationResult</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;é™æ€ä»£ç åˆ†æ&quot;&quot;&quot;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">ValidationResult</span><span class="p">()</span>

        <span class="c1"># AST åˆ†æ</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tree</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">SyntaxError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;è¯­æ³•é”™è¯¯: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="c1"># æ£€æŸ¥å±é™©æ“ä½œ</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">ast</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">tree</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Import</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">alias</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">alias</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forbidden_modules</span><span class="p">:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ç¦æ­¢å¯¼å…¥æ¨¡å—: </span><span class="si">{</span><span class="n">alias</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Call</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">ast</span><span class="o">.</span><span class="n">Name</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">id</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;eval&#39;</span><span class="p">,</span> <span class="s1">&#39;exec&#39;</span><span class="p">]:</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ç¦æ­¢ä½¿ç”¨å‡½æ•°: </span><span class="si">{</span><span class="n">node</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="n">id</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># æ¨¡æ‹Ÿæ‰§è¡ŒéªŒè¯</span>
        <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">is_valid</span><span class="p">:</span>
            <span class="n">sim_result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">simulate_execution</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">sim_result</span><span class="o">.</span><span class="n">is_safe</span><span class="p">:</span>
                <span class="n">result</span><span class="o">.</span><span class="n">add_error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;æ¨¡æ‹Ÿæ‰§è¡Œå¤±è´¥: </span><span class="si">{</span><span class="n">sim_result</span><span class="o">.</span><span class="n">reason</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_runtime_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">params</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è¿è¡Œæ—¶åŠ¨ä½œéªŒè¯&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">action_type</span> <span class="o">==</span> <span class="s1">&#39;move_to&#39;</span><span class="p">:</span>
            <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">),</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)</span>

            <span class="c1"># æ£€æŸ¥å·¥ä½œç©ºé—´é™åˆ¶</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace_limits</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace_limits</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">workspace_limits</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">y</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">workspace_limits</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]):</span>
                <span class="k">return</span> <span class="kc">False</span>

            <span class="c1"># æ£€æŸ¥é€Ÿåº¦é™åˆ¶</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;velocity&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">velocity_limits</span><span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">]:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">elif</span> <span class="n">action_type</span> <span class="o">==</span> <span class="s1">&#39;pick_object&#39;</span><span class="p">:</span>
            <span class="c1"># æ£€æŸ¥æŠ“å–åŠ›åº¦</span>
            <span class="k">if</span> <span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;force&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mf">50.0</span><span class="p">:</span>  <span class="c1"># N</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="k">return</span> <span class="kc">True</span>
</code></pre></div>

<h3 id="2143">21.4.3 å®æ—¶ä»£ç ç”Ÿæˆä¸ä¿®æ­£</h3>
<p>æ”¯æŒåŸºäºæ‰§è¡Œåé¦ˆçš„åŠ¨æ€ä»£ç è°ƒæ•´ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AdaptiveCodeGenerator</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">execution_history</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">learned_patterns</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_with_feedback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">max_attempts</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å¸¦åé¦ˆå¾ªç¯çš„ä»£ç ç”Ÿæˆ&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">attempt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_attempts</span><span class="p">):</span>
            <span class="c1"># ç”Ÿæˆåˆå§‹ä»£ç </span>
            <span class="k">if</span> <span class="n">attempt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_initial_code</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># åŸºäºå¤±è´¥åŸå› é‡æ–°ç”Ÿæˆ</span>
                <span class="n">code</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regenerate_code</span><span class="p">(</span>
                    <span class="n">task</span><span class="p">,</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">execution_history</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="c1"># æ‰§è¡Œä»£ç </span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">execute_with_monitoring</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">execution_history</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
                <span class="s1">&#39;result&#39;</span><span class="p">:</span> <span class="n">result</span><span class="p">,</span>
                <span class="s1">&#39;task&#39;</span><span class="p">:</span> <span class="n">task</span>
            <span class="p">})</span>

            <span class="k">if</span> <span class="n">result</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
                <span class="c1"># æˆåŠŸï¼Œå­¦ä¹ æ¨¡å¼</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">learn_from_success</span><span class="p">(</span><span class="n">task</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">code</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># å¤±è´¥ï¼Œåˆ†æåŸå› </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">analyze_failure</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to complete task after </span><span class="si">{</span><span class="n">max_attempts</span><span class="si">}</span><span class="s2"> attempts&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">regenerate_code</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">last_execution</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åŸºäºæ‰§è¡Œåé¦ˆé‡æ–°ç”Ÿæˆä»£ç &quot;&quot;&quot;</span>
        <span class="n">error_analysis</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">analyze_error</span><span class="p">(</span><span class="n">last_execution</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="p">)</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        ä»»åŠ¡ï¼š</span><span class="si">{</span><span class="n">task</span><span class="si">}</span>

<span class="s2">        ä¸Šæ¬¡æ‰§è¡Œå¤±è´¥ï¼š</span>
<span class="s2">        ä»£ç ï¼š</span><span class="si">{</span><span class="n">last_execution</span><span class="p">[</span><span class="s1">&#39;code&#39;</span><span class="p">]</span><span class="si">}</span>
<span class="s2">        é”™è¯¯ï¼š</span><span class="si">{</span><span class="n">last_execution</span><span class="p">[</span><span class="s1">&#39;result&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">error</span><span class="si">}</span>

<span class="s2">        é”™è¯¯åˆ†æï¼š</span><span class="si">{</span><span class="n">error_analysis</span><span class="si">}</span>

<span class="s2">        è¯·ç”Ÿæˆä¿®æ­£åçš„ä»£ç ï¼Œé¿å…ç›¸åŒé”™è¯¯ï¼š</span>
<span class="s2">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">llm</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">prompt</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">learn_from_success</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">task</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ä»æˆåŠŸæ‰§è¡Œä¸­å­¦ä¹ æ¨¡å¼&quot;&quot;&quot;</span>
        <span class="c1"># æå–ä»£ç æ¨¡å¼</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">extract_pattern</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

        <span class="c1"># å…³è”ä»»åŠ¡ç±»å‹</span>
        <span class="n">task_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">classify_task</span><span class="p">(</span><span class="n">task</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">task_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">learned_patterns</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">learned_patterns</span><span class="p">[</span><span class="n">task_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">learned_patterns</span><span class="p">[</span><span class="n">task_type</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
            <span class="s1">&#39;pattern&#39;</span><span class="p">:</span> <span class="n">pattern</span><span class="p">,</span>
            <span class="s1">&#39;code&#39;</span><span class="p">:</span> <span class="n">code</span><span class="p">,</span>
            <span class="s1">&#39;success_rate&#39;</span><span class="p">:</span> <span class="mf">1.0</span>
        <span class="p">})</span>
</code></pre></div>

<h2 id="215-google-palm-e">21.5 äº§ä¸šæ¡ˆä¾‹ç ”ç©¶ï¼šGoogle PaLM-E å…·èº«æœºå™¨äºº</h2>
<h3 id="2151">21.5.1 ç³»ç»Ÿæ¶æ„</h3>
<p>Google çš„ PaLM-Eï¼ˆPathways Language Model Embodiedï¼‰æ˜¯ä¸€ä¸ª 5620 äº¿å‚æ•°çš„å¤šæ¨¡æ€æ¨¡å‹ï¼Œä¸“é—¨ä¸ºæœºå™¨äººæ§åˆ¶è®¾è®¡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span>
<span class="err">â”‚</span><span class="w">                  </span><span class="n">PaLM</span><span class="o">-</span><span class="n">E</span><span class="w"> </span><span class="n">Architecture</span><span class="w">           </span><span class="err">â”‚</span>
<span class="err">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span>
<span class="err">â”‚</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">         </span><span class="n">Vision</span><span class="w"> </span><span class="n">Encoder</span><span class="w"> </span><span class="p">(</span><span class="n">ViT</span><span class="o">-</span><span class="mi">22</span><span class="n">B</span><span class="p">)</span><span class="w">         </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="mi">4</span><span class="n">K</span><span class="w"> </span><span class="n">resolution</span><span class="w"> </span><span class="n">support</span><span class="w">                </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Multi</span><span class="o">-</span><span class="n">view</span><span class="w"> </span><span class="n">fusion</span><span class="w">                    </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Temporal</span><span class="w"> </span><span class="n">encoding</span><span class="w">                    </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">      </span><span class="n">Language</span><span class="w"> </span><span class="n">Model</span><span class="w"> </span><span class="p">(</span><span class="n">PaLM</span><span class="o">-</span><span class="mi">540</span><span class="n">B</span><span class="p">)</span><span class="w">          </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Instruction</span><span class="w"> </span><span class="n">following</span><span class="w">                </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Chain</span><span class="o">-</span><span class="n">of</span><span class="o">-</span><span class="n">thought</span><span class="w"> </span><span class="n">reasoning</span><span class="w">           </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Multi</span><span class="o">-</span><span class="n">task</span><span class="w"> </span><span class="n">learning</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                    </span><span class="err">â”‚</span><span class="w">                           </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">       </span><span class="n">Robot</span><span class="w"> </span><span class="n">Control</span><span class="w"> </span><span class="n">Decoder</span><span class="w">              </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Action</span><span class="w"> </span><span class="n">tokenization</span><span class="w">                  </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Continuous</span><span class="w"> </span><span class="n">control</span><span class="w">                   </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â”‚</span><span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Safety</span><span class="w"> </span><span class="n">constraints</span><span class="w">                   </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">  </span><span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span><span class="w"> </span><span class="err">â”‚</span>
<span class="err">â”‚</span><span class="w">                                                </span><span class="err">â”‚</span>
<span class="err">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span>
</code></pre></div>

<h3 id="2152">21.5.2 å…³é”®åˆ›æ–°ç‚¹</h3>
<ol>
<li><strong>å¤šæ¨¡æ€ Token åŒ–</strong>ï¼šç»Ÿä¸€å›¾åƒã€æ–‡æœ¬ã€ä¼ æ„Ÿå™¨æ•°æ®çš„è¡¨ç¤º</li>
<li><strong>ä»»åŠ¡é€šç”¨æ€§</strong>ï¼šå•ä¸€æ¨¡å‹å¤„ç†å¯¼èˆªã€æ“ä½œã€é—®ç­”ç­‰å¤šç§ä»»åŠ¡</li>
<li><strong>é›¶æ ·æœ¬æ³›åŒ–</strong>ï¼šåœ¨æ–°ç¯å¢ƒä¸­æ— éœ€å¾®è°ƒå³å¯å·¥ä½œ</li>
<li><strong>é•¿ç¨‹è§„åˆ’</strong>ï¼šæ”¯æŒå¤æ‚å¤šæ­¥éª¤ä»»åŠ¡çš„è§„åˆ’ä¸æ‰§è¡Œ</li>
</ol>
<h3 id="2153">21.5.3 å®é™…éƒ¨ç½²ç»éªŒ</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PaLMERobotController</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">PaLMEModel</span><span class="o">.</span><span class="n">from_pretrained</span><span class="p">(</span><span class="s1">&#39;palm-e-562b&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">robot_interface</span> <span class="o">=</span> <span class="n">RobotInterface</span><span class="p">()</span>

        <span class="c1"># æ€§èƒ½ä¼˜åŒ–é…ç½®</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;inference_batch_size&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="s1">&#39;max_sequence_length&#39;</span><span class="p">:</span> <span class="mi">2048</span><span class="p">,</span>
            <span class="s1">&#39;vision_resolution&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="mi">1024</span><span class="p">),</span>
            <span class="s1">&#39;control_frequency&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>  <span class="c1"># Hz</span>
            <span class="s1">&#39;planning_horizon&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>   <span class="c1"># steps</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_multimodal_input</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">sensor_data</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å¤„ç†å¤šæ¨¡æ€è¾“å…¥&quot;&quot;&quot;</span>
        <span class="c1"># å›¾åƒç¼–ç </span>
        <span class="n">vision_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">encode_images</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

        <span class="c1"># ä¼ æ„Ÿå™¨æ•°æ®ç¼–ç </span>
        <span class="n">sensor_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encode_sensors</span><span class="p">(</span><span class="n">sensor_data</span><span class="p">)</span>

        <span class="c1"># æŒ‡ä»¤ç¼–ç </span>
        <span class="n">text_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">tokenize</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>

        <span class="c1"># å¤šæ¨¡æ€èåˆ</span>
        <span class="n">input_sequence</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">([</span>
            <span class="n">text_tokens</span><span class="p">,</span>
            <span class="n">vision_tokens</span><span class="p">,</span>
            <span class="n">sensor_tokens</span>
        <span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">input_sequence</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_robot_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">,</span> <span class="n">scene</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç”Ÿæˆæœºå™¨äººæ‰§è¡Œè®¡åˆ’&quot;&quot;&quot;</span>
        <span class="c1"># å¤šæ¨¡æ€è¾“å…¥å¤„ç†</span>
        <span class="n">input_seq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_multimodal_input</span><span class="p">(</span>
            <span class="n">instruction</span><span class="p">,</span>
            <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;images&#39;</span><span class="p">],</span>
            <span class="n">scene</span><span class="p">[</span><span class="s1">&#39;sensors&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="c1"># æ¨¡å‹æ¨ç†</span>
        <span class="k">with</span> <span class="n">torch</span><span class="o">.</span><span class="n">no_grad</span><span class="p">():</span>
            <span class="n">output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
                <span class="n">input_seq</span><span class="p">,</span>
                <span class="n">max_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;max_sequence_length&#39;</span><span class="p">],</span>
                <span class="n">temperature</span><span class="o">=</span><span class="mf">0.7</span><span class="p">,</span>
                <span class="n">top_p</span><span class="o">=</span><span class="mf">0.9</span>
            <span class="p">)</span>

        <span class="c1"># è§£ç åŠ¨ä½œåºåˆ—</span>
        <span class="n">action_sequence</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">decode_actions</span><span class="p">(</span><span class="n">output</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">action_sequence</span>
</code></pre></div>

<h3 id="2154">21.5.4 æ€§èƒ½æŒ‡æ ‡</h3>
<ul>
<li><strong>ä»»åŠ¡æˆåŠŸç‡</strong>ï¼šç§»åŠ¨æ“ä½œä»»åŠ¡ 87%ï¼Œå¤æ‚è£…é…ä»»åŠ¡ 73%</li>
<li><strong>æ¨ç†å»¶è¿Ÿ</strong>ï¼šå¹³å‡ 120ms/å†³ç­–ï¼ˆä½¿ç”¨ TPU v4ï¼‰</li>
<li><strong>æ³›åŒ–èƒ½åŠ›</strong>ï¼šåœ¨æœªè§è¿‡çš„å¨æˆ¿ç¯å¢ƒä¸­æˆåŠŸç‡ &gt;80%</li>
<li><strong>é”™è¯¯æ¢å¤</strong>ï¼šè‡ªä¸»é”™è¯¯æ£€æµ‹å’Œæ¢å¤ç‡ 65%</li>
</ul>
<h2 id="216-rt-2">21.6 é«˜çº§è¯é¢˜ï¼šRT-2 ä¸å¤šæ¨¡æ€å¤§æ¨¡å‹</h2>
<h3 id="2161-rt-2">21.6.1 RT-2 æ¶æ„åˆ›æ–°</h3>
<p>Robotics Transformer 2 (RT-2) å°†è§†è§‰-è¯­è¨€æ¨¡å‹ç›´æ¥ç”¨äºæœºå™¨äººæ§åˆ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RT2Model</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    RT-2: Vision-Language-Action Model</span>
<span class="sd">    å°† VLM çš„è¾“å‡ºç©ºé—´æ‰©å±•åˆ°åŒ…å«æœºå™¨äººåŠ¨ä½œ</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># åŸºç¡€ VLM (PaLI-X æˆ– PaLM-E)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">vlm_backbone</span> <span class="o">=</span> <span class="n">load_pretrained_vlm</span><span class="p">(</span><span class="s1">&#39;pali-x-55b&#39;</span><span class="p">)</span>

        <span class="c1"># åŠ¨ä½œ tokenizer</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">action_tokenizer</span> <span class="o">=</span> <span class="n">ActionTokenizer</span><span class="p">(</span>
            <span class="n">num_bins</span><span class="o">=</span><span class="mi">256</span><span class="p">,</span>  <span class="c1"># ç¦»æ•£åŒ–ç²¾åº¦</span>
            <span class="n">action_dim</span><span class="o">=</span><span class="mi">7</span>   <span class="c1"># æœºå™¨äººè‡ªç”±åº¦</span>
        <span class="p">)</span>

        <span class="c1"># æ‰©å±•è¯è¡¨ä»¥åŒ…å«åŠ¨ä½œ token</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extended_vocab</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlm_backbone</span><span class="o">.</span><span class="n">vocab</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_tokenizer</span><span class="o">.</span><span class="n">vocab</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span> <span class="n">instruction</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        è¾“å…¥ï¼šå›¾åƒåºåˆ— + è¯­è¨€æŒ‡ä»¤</span>
<span class="sd">        è¾“å‡ºï¼šæœºå™¨äººåŠ¨ä½œåºåˆ—</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># è§†è§‰ç¼–ç </span>
        <span class="n">visual_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlm_backbone</span><span class="o">.</span><span class="n">encode_images</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>

        <span class="c1"># è¯­è¨€ç¼–ç </span>
        <span class="n">text_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlm_backbone</span><span class="o">.</span><span class="n">encode_text</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>

        <span class="c1"># è·¨æ¨¡æ€æ³¨æ„åŠ›</span>
        <span class="n">fused_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlm_backbone</span><span class="o">.</span><span class="n">cross_attention</span><span class="p">(</span>
            <span class="n">visual_features</span><span class="p">,</span> <span class="n">text_features</span>
        <span class="p">)</span>

        <span class="c1"># ç”ŸæˆåŠ¨ä½œ token</span>
        <span class="n">action_tokens</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vlm_backbone</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span>
            <span class="n">fused_features</span><span class="p">,</span>
            <span class="n">max_new_tokens</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>  <span class="c1"># æœ€å¤š10ä¸ªåŠ¨ä½œ</span>
            <span class="n">vocab</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">extended_vocab</span>
        <span class="p">)</span>

        <span class="c1"># è§£ç ä¸ºè¿ç»­åŠ¨ä½œ</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">action_tokenizer</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">action_tokens</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">actions</span>
</code></pre></div>

<h3 id="2162">21.6.2 è®­ç»ƒç­–ç•¥</h3>
<p>RT-2 é‡‡ç”¨å¤šé˜¶æ®µè®­ç»ƒç­–ç•¥ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RT2Training</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stages</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s1">&#39;vision_language_pretraining&#39;</span><span class="p">,</span>
            <span class="s1">&#39;robot_data_finetuning&#39;</span><span class="p">,</span> 
            <span class="s1">&#39;co_finetuning&#39;</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stage1_vl_pretraining</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç¬¬ä¸€é˜¶æ®µï¼šè§†è§‰-è¯­è¨€é¢„è®­ç»ƒ&quot;&quot;&quot;</span>
        <span class="c1"># ä½¿ç”¨å¤§è§„æ¨¡äº’è”ç½‘æ•°æ®</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
            <span class="n">images</span><span class="p">,</span> <span class="n">captions</span> <span class="o">=</span> <span class="n">batch</span>

            <span class="c1"># æ ‡å‡† VLM è®­ç»ƒç›®æ ‡</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">compute_captioning_loss</span><span class="p">(</span><span class="n">images</span><span class="p">,</span> <span class="n">captions</span><span class="p">)</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

            <span class="c1"># æ¢¯åº¦ç´¯ç§¯</span>
            <span class="k">if</span> <span class="n">step</span> <span class="o">%</span> <span class="n">accumulation_steps</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">step</span><span class="p">()</span>
                <span class="n">optimizer</span><span class="o">.</span><span class="n">zero_grad</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stage2_robot_finetuning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">robot_dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç¬¬äºŒé˜¶æ®µï¼šæœºå™¨äººæ•°æ®å¾®è°ƒ&quot;&quot;&quot;</span>
        <span class="c1"># å†»ç»“éƒ¨åˆ†å±‚</span>
        <span class="n">model</span><span class="o">.</span><span class="n">freeze_backbone_layers</span><span class="p">(</span><span class="n">keep_top_n</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">episode</span> <span class="ow">in</span> <span class="n">robot_dataset</span><span class="p">:</span>
            <span class="n">observations</span> <span class="o">=</span> <span class="n">episode</span><span class="p">[</span><span class="s1">&#39;observations&#39;</span><span class="p">]</span>
            <span class="n">instructions</span> <span class="o">=</span> <span class="n">episode</span><span class="p">[</span><span class="s1">&#39;instructions&#39;</span><span class="p">]</span>
            <span class="n">actions</span> <span class="o">=</span> <span class="n">episode</span><span class="p">[</span><span class="s1">&#39;actions&#39;</span><span class="p">]</span>

            <span class="c1"># åŠ¨ä½œé¢„æµ‹æŸå¤±</span>
            <span class="n">pred_actions</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">observations</span><span class="p">,</span> <span class="n">instructions</span><span class="p">)</span>
            <span class="n">action_loss</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">mse_loss</span><span class="p">(</span><span class="n">pred_actions</span><span class="p">,</span> <span class="n">actions</span><span class="p">)</span>

            <span class="c1"># è¾…åŠ©ä»»åŠ¡ï¼šåœºæ™¯ç†è§£</span>
            <span class="n">scene_desc</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">describe_scene</span><span class="p">(</span><span class="n">observations</span><span class="p">)</span>
            <span class="n">desc_loss</span> <span class="o">=</span> <span class="n">compute_description_loss</span><span class="p">(</span><span class="n">scene_desc</span><span class="p">,</span> <span class="n">episode</span><span class="p">[</span><span class="s1">&#39;scene_labels&#39;</span><span class="p">])</span>

            <span class="n">total_loss</span> <span class="o">=</span> <span class="n">action_loss</span> <span class="o">+</span> <span class="mf">0.1</span> <span class="o">*</span> <span class="n">desc_loss</span>
            <span class="n">total_loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">stage3_co_finetuning</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">mixed_dataset</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç¬¬ä¸‰é˜¶æ®µï¼šæ··åˆå¾®è°ƒ&quot;&quot;&quot;</span>
        <span class="c1"># åŒæ—¶ä½¿ç”¨äº’è”ç½‘æ•°æ®å’Œæœºå™¨äººæ•°æ®</span>
        <span class="k">for</span> <span class="n">batch</span> <span class="ow">in</span> <span class="n">mixed_dataset</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;internet&#39;</span><span class="p">:</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_vl_loss</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># robot data</span>
                <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">compute_robot_loss</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">batch</span><span class="p">)</span>

            <span class="c1"># åŠ¨æ€æƒé‡å¹³è¡¡</span>
            <span class="n">loss</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">balance_losses</span><span class="p">(</span><span class="n">loss</span><span class="p">,</span> <span class="n">batch</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">])</span>
            <span class="n">loss</span><span class="o">.</span><span class="n">backward</span><span class="p">()</span>
</code></pre></div>

<h3 id="2163">21.6.3 éƒ¨ç½²ä¼˜åŒ–æŠ€æœ¯</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RT2Deployment</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">quantization_config</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;weight_bits&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="s1">&#39;activation_bits&#39;</span><span class="p">:</span> <span class="mi">8</span><span class="p">,</span>
            <span class="s1">&#39;kv_cache_bits&#39;</span><span class="p">:</span> <span class="mi">4</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">optimize_for_edge</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è¾¹ç¼˜è®¾å¤‡ä¼˜åŒ–&quot;&quot;&quot;</span>
        <span class="c1"># 1. æ¨¡å‹é‡åŒ–</span>
        <span class="n">quantized_model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">quantization</span><span class="o">.</span><span class="n">quantize_dynamic</span><span class="p">(</span>
            <span class="n">model</span><span class="p">,</span>
            <span class="p">{</span><span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">,</span> <span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">},</span>
            <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">qint8</span>
        <span class="p">)</span>

        <span class="c1"># 2. çŸ¥è¯†è’¸é¦åˆ°å°æ¨¡å‹</span>
        <span class="n">student_model</span> <span class="o">=</span> <span class="n">RT2StudentModel</span><span class="p">(</span><span class="n">hidden_size</span><span class="o">=</span><span class="mi">768</span><span class="p">)</span>  <span class="c1"># åŸæ¨¡å‹çš„ 1/10</span>
        <span class="n">student_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">distill_knowledge</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">student_model</span><span class="p">)</span>

        <span class="c1"># 3. æ¨¡å‹å‰ªæ</span>
        <span class="n">pruned_model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">structured_pruning</span><span class="p">(</span>
            <span class="n">student_model</span><span class="p">,</span>
            <span class="n">pruning_ratio</span><span class="o">=</span><span class="mf">0.3</span>
        <span class="p">)</span>

        <span class="c1"># 4. ç¼–è¯‘ä¼˜åŒ–</span>
        <span class="n">compiled_model</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="n">pruned_model</span><span class="p">,</span>
            <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;reduce-overhead&#39;</span><span class="p">,</span>
            <span class="n">backend</span><span class="o">=</span><span class="s1">&#39;inductor&#39;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">compiled_model</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">streaming_inference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">instruction</span><span class="p">,</span> <span class="n">image_stream</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æµå¼æ¨ç†ä¼˜åŒ–&quot;&quot;&quot;</span>
        <span class="n">action_buffer</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">image_stream</span><span class="p">:</span>
            <span class="c1"># å¢é‡å¤„ç†</span>
            <span class="n">features</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">encode_image_incremental</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>

            <span class="c1"># é¢„æµ‹ä¸‹ä¸€ä¸ªåŠ¨ä½œ</span>
            <span class="n">action</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">predict_next_action</span><span class="p">(</span>
                <span class="n">instruction</span><span class="p">,</span>
                <span class="n">features</span><span class="p">,</span>
                <span class="n">history</span><span class="o">=</span><span class="n">action_buffer</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]</span>  <span class="c1"># ä½¿ç”¨æœ€è¿‘10ä¸ªåŠ¨ä½œä½œä¸ºä¸Šä¸‹æ–‡</span>
            <span class="p">)</span>

            <span class="n">action_buffer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

            <span class="c1"># å¹¶è¡Œæ‰§è¡Œå’Œæ¨ç†</span>
            <span class="k">yield</span> <span class="n">action</span>
</code></pre></div>

<h3 id="2164">21.6.4 æœ€æ–°ç ”ç©¶æ–¹å‘</h3>
<ol>
<li><strong>æ€ç»´é“¾æ¨ç†ï¼ˆChain-of-Thoughtï¼‰</strong>ï¼šè®©æœºå™¨äººè§£é‡Šå…¶å†³ç­–è¿‡ç¨‹</li>
<li><strong>å°‘æ ·æœ¬å­¦ä¹ </strong>ï¼šé€šè¿‡å°‘é‡æ¼”ç¤ºå¿«é€Ÿé€‚åº”æ–°ä»»åŠ¡</li>
<li><strong>å¤šæœºå™¨äººåä½œ</strong>ï¼šLLM åè°ƒå¤šä¸ªæœºå™¨äººæ‰§è¡Œå¤æ‚ä»»åŠ¡</li>
<li><strong>æŒç»­å­¦ä¹ </strong>ï¼šä»äººç±»åé¦ˆä¸­ä¸æ–­æ”¹è¿›</li>
</ol>
<p>å…³é”®è®ºæ–‡æ¨èï¼š</p>
<ul>
<li>"RT-2: Vision-Language-Action Models for Robotics" (Google DeepMind, 2023)</li>
<li>"PaLM-E: An Embodied Multimodal Language Model" (Google, 2023)</li>
<li>"Code as Policies: Language Model Programs for Embodied Control" (Google, 2022)</li>
</ul>
<h2 id="217-gotchas">21.7 å¸¸è§é™·é˜±ä¸é”™è¯¯ï¼ˆGotchasï¼‰</h2>
<h3 id="2171-llm">21.7.1 LLM å¹»è§‰é—®é¢˜</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">HallucinationMitigation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;LLM å¹»è§‰ç¼“è§£ç­–ç•¥&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fact_checker</span> <span class="o">=</span> <span class="n">FactChecker</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">confidence_threshold</span> <span class="o">=</span> <span class="mf">0.8</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">validate_llm_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">llm_response</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;éªŒè¯ LLM è¾“å‡ºçš„çœŸå®æ€§&quot;&quot;&quot;</span>
        <span class="c1"># 1. æ£€æŸ¥ç‰©ç†å¯è¡Œæ€§</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_physical_feasibility</span><span class="p">(</span><span class="n">llm_response</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;è¿åç‰©ç†çº¦æŸ&quot;</span>

        <span class="c1"># 2. æ£€æŸ¥ç¯å¢ƒä¸€è‡´æ€§</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_environmental_consistency</span><span class="p">(</span><span class="n">llm_response</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;ä¸ç¯å¢ƒçŠ¶æ€ä¸ä¸€è‡´&quot;</span>

        <span class="c1"># 3. æ£€æŸ¥åŠ¨ä½œåºåˆ—åˆç†æ€§</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_action_sequence_validity</span><span class="p">(</span><span class="n">llm_response</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="s2">&quot;åŠ¨ä½œåºåˆ—ä¸åˆç†&quot;</span>

        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;éªŒè¯é€šè¿‡&quot;</span>
</code></pre></div>

<h3 id="2172">21.7.2 å»¶è¿Ÿä¸å®æ—¶æ€§æƒè¡¡</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LatencyOptimization</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å»¶è¿Ÿä¼˜åŒ–ç­–ç•¥&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="o">=</span> <span class="n">LRUCache</span><span class="p">(</span><span class="n">maxsize</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span> <span class="o">=</span> <span class="n">ActionPredictor</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reduce_inference_latency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instruction</span><span class="p">):</span>
        <span class="c1"># 1. æŸ¥è¯¢ç¼“å­˜</span>
        <span class="k">if</span> <span class="n">instruction</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">instruction</span><span class="p">]</span>

        <span class="c1"># 2. é¢„æµ‹æ€§æ‰§è¡Œ</span>
        <span class="n">predicted_action</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">predictor</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>

        <span class="c1"># 3. å¼‚æ­¥ LLM è°ƒç”¨</span>
        <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">async_llm_call</span><span class="p">(</span><span class="n">instruction</span><span class="p">)</span>

        <span class="c1"># 4. ä½¿ç”¨é¢„æµ‹ç»“æœï¼ŒåŒæ—¶ç­‰å¾… LLM</span>
        <span class="k">return</span> <span class="n">predicted_action</span><span class="p">,</span> <span class="n">future</span>
</code></pre></div>

<h3 id="2173">21.7.3 å®‰å…¨æ€§è€ƒè™‘</h3>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SafetyMonitor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å®‰å…¨ç›‘æ§ç³»ç»Ÿ&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">safety_rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">load_safety_rules</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">emergency_stop</span> <span class="o">=</span> <span class="n">EmergencyStop</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">monitor_execution</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">action_stream</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">action</span> <span class="ow">in</span> <span class="n">action_stream</span><span class="p">:</span>
            <span class="c1"># 1. é¢„æ£€æŸ¥</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pre_check_action</span><span class="p">(</span><span class="n">action</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">emergency_stop</span><span class="o">.</span><span class="n">trigger</span><span class="p">()</span>
                <span class="k">raise</span> <span class="n">SafetyViolation</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsafe action: </span><span class="si">{</span><span class="n">action</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># 2. æ‰§è¡Œç›‘æ§</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">monitor_action_execution</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

            <span class="c1"># 3. åéªŒè¯</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">post_validate_state</span><span class="p">():</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rollback_action</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
</code></pre></div>

<h2 id="218">21.8 æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_1">ç³»ç»Ÿè®¾è®¡å®¡æŸ¥è¦ç‚¹</h3>
<ul>
<li>[ ] <strong>æ¨¡å‹é€‰æ‹©</strong></li>
<li>é€‰æ‹©é€‚åˆä»»åŠ¡å¤æ‚åº¦çš„ LLM è§„æ¨¡</li>
<li>è€ƒè™‘éƒ¨ç½²ç¯å¢ƒçš„è®¡ç®—èµ„æºé™åˆ¶</li>
<li>
<p>è¯„ä¼°æ¨¡å‹çš„å¤šè¯­è¨€æ”¯æŒèƒ½åŠ›</p>
</li>
<li>
<p>[ ] <strong>å®‰å…¨æœºåˆ¶</strong></p>
</li>
<li>å®ç°å¤šå±‚å®‰å…¨éªŒè¯</li>
<li>è®¾ç½®ç‰©ç†å’Œé€»è¾‘çº¦æŸ</li>
<li>
<p>é…ç½®ç´§æ€¥åœæ­¢æœºåˆ¶</p>
</li>
<li>
<p>[ ] <strong>æ€§èƒ½ä¼˜åŒ–</strong></p>
</li>
<li>ä½¿ç”¨æ¨¡å‹é‡åŒ–å’Œå‰ªæ</li>
<li>å®ç°æ™ºèƒ½ç¼“å­˜ç­–ç•¥</li>
<li>
<p>é‡‡ç”¨æµå¼å¤„ç†æ¶æ„</p>
</li>
<li>
<p>[ ] <strong>é²æ£’æ€§è®¾è®¡</strong></p>
</li>
<li>å¤„ç† LLM è¾“å‡ºä¸ç¡®å®šæ€§</li>
<li>å®ç°å¤±è´¥æ¢å¤æœºåˆ¶</li>
<li>
<p>è®¾è®¡é™çº§è¿è¡Œæ¨¡å¼</p>
</li>
<li>
<p>[ ] <strong>äººæœºäº¤äº’</strong></p>
</li>
<li>æä¾›è‡ªç„¶è¯­è¨€åé¦ˆ</li>
<li>æ”¯æŒå¤šè½®å¯¹è¯æ¾„æ¸…</li>
<li>
<p>è®°å½•å†³ç­–è¿‡ç¨‹ç”¨äºè§£é‡Š</p>
</li>
<li>
<p>[ ] <strong>æ•°æ®ç®¡ç†</strong></p>
</li>
<li>æ”¶é›†æ‰§è¡Œæ•°æ®ç”¨äºæ”¹è¿›</li>
<li>å®ç°éšç§ä¿æŠ¤æœºåˆ¶</li>
<li>
<p>å»ºç«‹æ•°æ®ç‰ˆæœ¬æ§åˆ¶</p>
</li>
<li>
<p>[ ] <strong>æµ‹è¯•éªŒè¯</strong></p>
</li>
<li>ä»¿çœŸç¯å¢ƒå……åˆ†æµ‹è¯•</li>
<li>è¾¹ç•Œæ¡ä»¶æµ‹è¯•</li>
<li>
<p>é•¿æœŸè¿è¡Œç¨³å®šæ€§æµ‹è¯•</p>
</li>
<li>
<p>[ ] <strong>ç›‘æ§è¿ç»´</strong></p>
</li>
<li>å®æ—¶æ€§èƒ½ç›‘æ§</li>
<li>å¼‚å¸¸æ£€æµ‹å’ŒæŠ¥è­¦</li>
<li>æ—¥å¿—è®°å½•å’Œåˆ†æ</li>
</ul>
<h2 id="219">21.9 æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº†å¤§è¯­è¨€æ¨¡å‹ä¸ ROS2 æœºå™¨äººç³»ç»Ÿçš„æ·±åº¦é›†æˆã€‚æˆ‘ä»¬å­¦ä¹ äº†ï¼š</p>
<ol>
<li>
<p><strong>LLM ä»»åŠ¡è§„åˆ’</strong>ï¼šå¦‚ä½•æ„å»ºåŸºäº LLM çš„é«˜å±‚ä»»åŠ¡è§„åˆ’å™¨ï¼ŒåŒ…æ‹¬ Prompt å·¥ç¨‹ã€ä¸Šä¸‹æ–‡ç®¡ç†å’Œè¡Œä¸ºæ ‘é›†æˆ</p>
</li>
<li>
<p><strong>å¤šæ¨¡æ€æ„ŸçŸ¥</strong>ï¼šVLM æ¨¡å‹åœ¨åœºæ™¯ç†è§£ã€è§†è§‰é—®ç­”å’Œ Grounding ä»»åŠ¡ä¸­çš„åº”ç”¨</p>
</li>
<li>
<p><strong>è‡ªç„¶è¯­è¨€å¯¼èˆª</strong>ï¼šå®ç°ä»è¯­è¨€æŒ‡ä»¤åˆ°æœºå™¨äººå¯¼èˆªçš„å®Œæ•´ç®¡é“ï¼ŒåŒ…æ‹¬ç©ºé—´è¯­è¨€ç†è§£å’Œæ­§ä¹‰æ¶ˆè§£</p>
</li>
<li>
<p><strong>Code as Policies</strong>ï¼šè®© LLM ç›´æ¥ç”Ÿæˆå¯æ‰§è¡Œä»£ç ï¼Œå®ç°çµæ´»çš„ä»»åŠ¡æ‰§è¡Œç­–ç•¥</p>
</li>
<li>
<p><strong>äº§ä¸šå®è·µ</strong>ï¼šé€šè¿‡ Google PaLM-E æ¡ˆä¾‹äº†è§£å¤§è§„æ¨¡éƒ¨ç½²ç»éªŒ</p>
</li>
<li>
<p><strong>å‰æ²¿æŠ€æœ¯</strong>ï¼šRT-2 ç­‰æœ€æ–°æ¨¡å‹æ¶æ„å’Œè®­ç»ƒç­–ç•¥</p>
</li>
</ol>
<p>å…³é”®è¦ç‚¹ï¼š</p>
<ul>
<li>LLM ä¸ºæœºå™¨äººå¸¦æ¥äº†å‰æ‰€æœªæœ‰çš„è¯­è¨€ç†è§£å’Œæ¨ç†èƒ½åŠ›</li>
<li>å¤šæ¨¡æ€èåˆæ˜¯å®ç°çœŸæ­£æ™ºèƒ½æœºå™¨äººçš„å…³é”®</li>
<li>å®‰å…¨æ€§å’Œå¯é æ€§ä»æ˜¯éƒ¨ç½²çš„ä¸»è¦æŒ‘æˆ˜</li>
<li>è¾¹ç¼˜è®¡ç®—ä¼˜åŒ–å¯¹å®æ—¶åº”ç”¨è‡³å…³é‡è¦</li>
</ul>
<h2 id="2110">21.10 ç»ƒä¹ é¢˜</h2>
<h3 id="_2">åŸºç¡€é¢˜</h3>
<p><strong>ç»ƒä¹  21.1</strong>ï¼šè®¾è®¡ä¸€ä¸ªç®€å•çš„ LLM ä»»åŠ¡è§„åˆ’å™¨ï¼Œèƒ½å¤Ÿå°†"æ¸…ç†æ¡Œå­"è¿™æ ·çš„é«˜å±‚æŒ‡ä»¤åˆ†è§£ä¸ºå…·ä½“çš„æœºå™¨äººåŠ¨ä½œåºåˆ—ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘ä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ol>
<li>æ‰«ææ¡Œé¢è¯†åˆ«ç‰©ä½“</li>
<li>åˆ†ç±»ç‰©ä½“ï¼ˆåƒåœ¾/éåƒåœ¾ï¼‰</li>
<li>è§„åˆ’æŠ“å–é¡ºåº</li>
<li>æ‰§è¡Œæ¸…ç†åŠ¨ä½œ</li>
</ol>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä»»åŠ¡åˆ†è§£æµç¨‹ï¼š</p>
<ol>
<li>è°ƒç”¨è§†è§‰ç³»ç»Ÿæ‰«ææ¡Œé¢</li>
<li>ä½¿ç”¨ VLM è¯†åˆ«æ¯ä¸ªç‰©ä½“ç±»åˆ«</li>
<li>æŸ¥è¯¢ LLM åˆ¤æ–­ç‰©ä½“å½’å±</li>
<li>ç”ŸæˆæŠ“å–å’Œæ”¾ç½®åºåˆ—</li>
<li>ä¼˜åŒ–è·¯å¾„å‡å°‘ç§»åŠ¨è·ç¦»</li>
<li>é€ä¸ªæ‰§è¡Œå¹¶éªŒè¯ç»“æœ</li>
</ol>
</details>
<p><strong>ç»ƒä¹  21.2</strong>ï¼šå®ç°ä¸€ä¸ªåŸºç¡€çš„è§†è§‰ Grounding ç³»ç»Ÿï¼Œèƒ½å¤Ÿå®šä½"çº¢è‰²æ¯å­å·¦è¾¹çš„ä¹¦"è¿™æ ·çš„æŒ‡ç§°è¡¨è¾¾ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>åˆ†è§£ä»»åŠ¡ï¼š</p>
<ol>
<li>æ£€æµ‹æ‰€æœ‰ç‰©ä½“</li>
<li>è¯†åˆ«çº¢è‰²æ¯å­</li>
<li>ç¡®å®š"å·¦è¾¹"çš„ç©ºé—´å…³ç³»</li>
<li>æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ä¹¦</li>
</ol>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>å®ç°æ­¥éª¤ï¼š</p>
<ol>
<li>ä½¿ç”¨ç›®æ ‡æ£€æµ‹è·å–æ‰€æœ‰è¾¹ç•Œæ¡†</li>
<li>é€šè¿‡é¢œè‰²åˆ†å‰²æ‰¾åˆ°çº¢è‰²æ¯å­</li>
<li>è®¡ç®—æ¯å­å·¦ä¾§åŒºåŸŸ</li>
<li>åœ¨è¯¥åŒºåŸŸå†…æœç´¢ä¹¦æœ¬</li>
<li>è¿”å›æœ€è¿‘çš„ä¹¦çš„ä½ç½®</li>
</ol>
</details>
<p><strong>ç»ƒä¹  21.3</strong>ï¼šè®¾è®¡ä¸€ä¸ª Code as Policies çš„å®‰å…¨éªŒè¯å™¨ï¼Œé˜²æ­¢ç”Ÿæˆçš„ä»£ç æ‰§è¡Œå±é™©æ“ä½œã€‚</p>
<details>
<summary>æç¤º</summary>
<p>éœ€è¦æ£€æŸ¥ï¼š</p>
<ul>
<li>å·¥ä½œç©ºé—´è¾¹ç•Œ</li>
<li>é€Ÿåº¦é™åˆ¶</li>
<li>ç¢°æ’é£é™©</li>
<li>ç³»ç»Ÿè°ƒç”¨</li>
</ul>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>éªŒè¯å™¨åŒ…å«ï¼š</p>
<ol>
<li>AST åˆ†æç¦æ­¢å±é™©å‡½æ•°</li>
<li>å‚æ•°èŒƒå›´æ£€æŸ¥</li>
<li>æ¨¡æ‹Ÿæ‰§è¡ŒéªŒè¯è½¨è¿¹</li>
<li>è¿è¡Œæ—¶ç›‘æ§å’Œä¸­æ–­</li>
<li>æ²™ç›’ç¯å¢ƒéš”ç¦»</li>
</ol>
</details>
<h3 id="_3">æŒ‘æˆ˜é¢˜</h3>
<p><strong>ç»ƒä¹  21.4</strong>ï¼šè®¾è®¡ä¸€ä¸ªå¤šè½®å¯¹è¯ç³»ç»Ÿï¼Œèƒ½å¤Ÿé€šè¿‡è¯¢é—®ç”¨æˆ·æ¥æ¶ˆé™¤æŒ‡ä»¤ä¸­çš„æ­§ä¹‰ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘ï¼š</p>
<ul>
<li>æ­§ä¹‰ç±»å‹åˆ†ç±»</li>
<li>é—®é¢˜ç”Ÿæˆç­–ç•¥</li>
<li>ç­”æ¡ˆæ•´åˆæœºåˆ¶</li>
<li>ä¸Šä¸‹æ–‡è¿½è¸ª</li>
</ul>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ç³»ç»Ÿè®¾è®¡ï¼š</p>
<ol>
<li>ä½¿ç”¨ NER æå–å®ä½“</li>
<li>åœºæ™¯åŒ¹é…æ‰¾å‡ºæ­§ä¹‰</li>
<li>ç”ŸæˆåŒºåˆ†æ€§é—®é¢˜</li>
<li>è§£æç”¨æˆ·å›ç­”æ›´æ–°ç†è§£</li>
<li>ç»´æŠ¤å¯¹è¯çŠ¶æ€æœº</li>
<li>ç¡®è®¤ç†è§£åæ‰§è¡Œ</li>
</ol>
</details>
<p><strong>ç»ƒä¹  21.5</strong>ï¼šå®ç°ä¸€ä¸ª LLM é©±åŠ¨çš„é”™è¯¯æ¢å¤ç³»ç»Ÿï¼Œå½“ä»»åŠ¡æ‰§è¡Œå¤±è´¥æ—¶èƒ½è‡ªåŠ¨åˆ†æåŸå› å¹¶å°è¯•æ–°ç­–ç•¥ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>å…³é”®ç»„ä»¶ï¼š</p>
<ul>
<li>å¤±è´¥æ£€æµ‹</li>
<li>åŸå› åˆ†æ</li>
<li>ç­–ç•¥ç”Ÿæˆ</li>
<li>éªŒè¯æ‰§è¡Œ</li>
</ul>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æ¢å¤æµç¨‹ï¼š</p>
<ol>
<li>ç›‘æ§æ‰§è¡ŒçŠ¶æ€æ£€æµ‹å¼‚å¸¸</li>
<li>æ”¶é›†å¤±è´¥ä¸Šä¸‹æ–‡ä¿¡æ¯</li>
<li>è°ƒç”¨ LLM åˆ†æå¤±è´¥åŸå› </li>
<li>ç”Ÿæˆå¤‡é€‰æ‰§è¡Œç­–ç•¥</li>
<li>è¯„ä¼°ç­–ç•¥å¯è¡Œæ€§</li>
<li>é€‰æ‹©æœ€ä¼˜ç­–ç•¥é‡è¯•</li>
<li>è®°å½•ç»éªŒç”¨äºå­¦ä¹ </li>
</ol>
</details>
<p><strong>ç»ƒä¹  21.6</strong>ï¼šè®¾è®¡ä¸€ä¸ªåˆ†å¸ƒå¼ LLM æœºå™¨äººç³»ç»Ÿï¼Œå¤šä¸ªæœºå™¨äººå¯ä»¥åä½œå®Œæˆå¤æ‚ä»»åŠ¡ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>éœ€è¦è§£å†³ï¼š</p>
<ul>
<li>ä»»åŠ¡åˆ†é…</li>
<li>é€šä¿¡åè®®</li>
<li>åŒæ­¥æœºåˆ¶</li>
<li>å†²çªè§£å†³</li>
</ul>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>æ¶æ„è®¾è®¡ï¼š</p>
<ol>
<li>ä¸­å¤® LLM åˆ†è§£æ€»ä»»åŠ¡</li>
<li>è¯„ä¼°æœºå™¨äººèƒ½åŠ›åŒ¹é…</li>
<li>åˆ†é…å­ä»»åŠ¡ç»™å„æœºå™¨äºº</li>
<li>å»ºç«‹ P2P é€šä¿¡é€šé“</li>
<li>å®æ—¶åŒæ­¥æ‰§è¡ŒçŠ¶æ€</li>
<li>åŠ¨æ€é‡åˆ†é…å¤„ç†å¤±è´¥</li>
<li>åˆå¹¶ç»“æœå®Œæˆæ€»ä»»åŠ¡</li>
</ol>
</details>
<p><strong>ç»ƒä¹  21.7</strong>ï¼šå®ç°ä¸€ä¸ªè‡ªé€‚åº” Prompt ä¼˜åŒ–ç³»ç»Ÿï¼Œæ ¹æ®æ‰§è¡Œæ•ˆæœè‡ªåŠ¨æ”¹è¿› Prompt æ¨¡æ¿ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>ä¼˜åŒ–ç»´åº¦ï¼š</p>
<ul>
<li>æŒ‡ä»¤æ¸…æ™°åº¦</li>
<li>ä¸Šä¸‹æ–‡å®Œæ•´æ€§</li>
<li>è¾“å‡ºæ ¼å¼è§„èŒƒ</li>
<li>çº¦æŸæ¡ä»¶è¡¨è¾¾</li>
</ul>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä¼˜åŒ–ç­–ç•¥ï¼š</p>
<ol>
<li>è®°å½• Prompt-ç»“æœå¯¹</li>
<li>è¯„ä¼°æ‰§è¡ŒæˆåŠŸç‡</li>
<li>è¯†åˆ«å¤±è´¥æ¨¡å¼</li>
<li>ä½¿ç”¨å…ƒ Prompt ç”Ÿæˆæ”¹è¿›</li>
<li>A/B æµ‹è¯•æ–°æ¨¡æ¿</li>
<li>è´å¶æ–¯ä¼˜åŒ–è¶…å‚æ•°</li>
<li>æŒç»­è¿­ä»£æ”¹è¿›</li>
</ol>
</details>
<p><strong>ç»ƒä¹  21.8</strong>ï¼šè®¾è®¡ä¸€ä¸ªè¾¹ç¼˜-äº‘ååŒçš„ LLM æœºå™¨äººæ¶æ„ï¼Œå¹³è¡¡å®æ—¶æ€§å’Œè®¡ç®—èƒ½åŠ›ã€‚</p>
<details>
<summary>æç¤º</summary>
<p>è€ƒè™‘ï¼š</p>
<ul>
<li>ä»»åŠ¡åˆ’åˆ†ç­–ç•¥</li>
<li>ç½‘ç»œå»¶è¿Ÿå¤„ç†</li>
<li>ç¼“å­˜æœºåˆ¶</li>
<li>é™çº§æ–¹æ¡ˆ</li>
</ul>
</details>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ååŒæ¶æ„ï¼š</p>
<ol>
<li>è¾¹ç¼˜éƒ¨ç½²è½»é‡æ¨¡å‹</li>
<li>äº‘ç«¯è¿è¡Œå¤§æ¨¡å‹</li>
<li>ç®€å•ä»»åŠ¡æœ¬åœ°å¤„ç†</li>
<li>å¤æ‚æ¨ç†äº‘ç«¯æ‰§è¡Œ</li>
<li>é¢„æµ‹æ€§ç¼“å­˜å¸¸ç”¨ç»“æœ</li>
<li>ç½‘ç»œä¸­æ–­æ—¶é™çº§è¿è¡Œ</li>
<li>å¼‚æ­¥æ›´æ–°åŒæ­¥çŠ¶æ€</li>
</ol>
</details>
            </article>
            
            <nav class="page-nav"><a href="chapter20.html" class="nav-link prev">â† ç¬¬ 20 ç« ï¼šæœºå™¨äººå¼ºåŒ–å­¦ä¹ </a><a href="chapter22.html" class="nav-link next">ç¬¬ 22 ç« ï¼šç¥ç»ç½‘ç»œè¿åŠ¨æ§åˆ¶ â†’</a></nav>
        </main>
    </div>
</body>
</html>