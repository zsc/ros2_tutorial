<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>第 13 章：ros2_control 框架</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>目录</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="搜索..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">ROS2 完全教程：从原理到实践</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 1 章：ROS1 核心概念回顾</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 2 章：ROS1 的局限性分析</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 3 章：从 ROS1 到 ROS2 的迁移策略</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 4 章：ROS2 架构与设计理念</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 5 章：节点与执行器模型</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 6 章：通信机制深度解析</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 7 章：Launch 系统与配置管理</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 8 章：tf2 坐标变换框架</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 9 章：时间同步与回放系统</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 10 章：传感器数据处理管道</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 11 章：SLAM 与定位系统</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 12 章：导航栈 Nav2</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 13 章：ros2_control 框架</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 14 章：MoveIt2 运动规划</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 15 章：实时系统与性能优化</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 16 章：安全性与诊断系统</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 17 章：仿真集成（Gazebo/Ignition）</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 18 章：多机器人系统</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 19 章：计算机视觉与深度学习</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 20 章：机器人强化学习</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 21 章：大语言模型与具身智能</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">第 22 章：神经网络运动控制</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">📄</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="13-ros2_control">第 13 章：ros2_control 框架</h1>
<h2 id="_1">章节大纲</h2>
<h3 id="131">13.1 引言与框架概述</h3>
<ul>
<li>ros2_control 的设计理念</li>
<li>与 ROS1 control 的对比</li>
<li>硬件抽象的重要性</li>
</ul>
<h3 id="132">13.2 硬件抽象层设计</h3>
<ul>
<li>Hardware Interface 架构</li>
<li>Resource Manager 机制</li>
<li>硬件组件生命周期</li>
<li>自定义硬件接口开发</li>
</ul>
<h3 id="133-controller-chaining">13.3 控制器链（Controller Chaining）</h3>
<ul>
<li>控制器管理器架构</li>
<li>级联控制器设计</li>
<li>控制器间数据流</li>
<li>动态加载与切换</li>
</ul>
<h3 id="134">13.4 实时控制循环</h3>
<ul>
<li>实时性保证机制</li>
<li>控制周期与更新率</li>
<li>线程模型与调度</li>
<li>延迟分析与优化</li>
</ul>
<h3 id="135">13.5 机械臂控制实例</h3>
<ul>
<li>7自由度机械臂建模</li>
<li>关节控制器实现</li>
<li>轨迹跟踪控制</li>
<li>力矩控制与重力补偿</li>
</ul>
<h3 id="136-universal-robots">13.6 产业案例研究：Universal Robots 力控与柔顺控制</h3>
<ul>
<li>UR 机器人架构分析</li>
<li>力/力矩传感器集成</li>
<li>柔顺控制算法实现</li>
<li>安全性与碰撞检测</li>
</ul>
<h3 id="137">13.7 高级话题</h3>
<ul>
<li>EtherCAT 总线集成</li>
<li>硬实时控制策略</li>
<li>多机器人同步控制</li>
<li>论文导读与开源项目</li>
</ul>
<h3 id="138">13.8 本章小结</h3>
<h3 id="139">13.9 练习题</h3>
<h3 id="1310">13.10 常见陷阱与错误</h3>
<h3 id="1311">13.11 最佳实践检查清单</h3>
<hr />
<h2 id="131_1">13.1 引言与框架概述</h2>
<p>ros2_control 是 ROS2 中用于机器人控制的核心框架，它提供了一个标准化、模块化的方式来管理机器人硬件接口和控制算法。本章将深入探讨 ros2_control 的架构设计、实时控制机制、以及在工业机器人中的实际应用。通过学习本章，您将掌握如何设计高性能的机器人控制系统，实现从简单的位置控制到复杂的力控和柔顺控制。</p>
<h3 id="ros2_control">ros2_control 的核心价值</h3>
<p>ros2_control 解决了机器人控制系统开发中的几个关键挑战：</p>
<ol>
<li><strong>硬件抽象</strong>：通过统一的接口隔离硬件细节，使控制算法可以在不同硬件平台间复用</li>
<li><strong>实时性保证</strong>：提供确定性的控制循环，满足工业级实时控制要求</li>
<li><strong>模块化设计</strong>：控制器可以独立开发、测试和部署，支持热插拔</li>
<li><strong>标准化接口</strong>：与 MoveIt2、Nav2 等高级框架无缝集成</li>
</ol>
<h3 id="ros1-ros2">架构演进：从 ROS1 到 ROS2</h3>
<p>ROS1 的 ros_control 在工业界得到广泛应用，但存在一些限制：</p>
<ul>
<li>单线程执行模型导致的性能瓶颈</li>
<li>缺乏生命周期管理</li>
<li>实时性依赖外部补丁</li>
</ul>
<p>ROS2 control 的改进：</p>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：

<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>
<span class="nv">ROS1</span><span class="w"> </span><span class="nv">Control</span><span class="w">                    </span><span class="nv">ROS2</span><span class="w"> </span><span class="nv">Control</span>
<span class="w">     </span>│<span class="w">                               </span>│
<span class="w">     </span>├─<span class="w"> </span><span class="nv">Controller</span><span class="w"> </span><span class="nv">Manager</span><span class="w">           </span>├─<span class="w"> </span><span class="nv">Controller</span><span class="w"> </span><span class="nv">Manager</span>
<span class="w">     </span>│<span class="w">   </span>└─<span class="w"> </span><span class="nv">Single</span><span class="w"> </span><span class="nv">Thread</span><span class="w">            </span>│<span class="w">   </span>├─<span class="w"> </span><span class="nv">Multi</span><span class="o">-</span><span class="nv">threaded</span>
<span class="w">     </span>│<span class="w">                               </span>│<span class="w">   </span>└─<span class="w"> </span><span class="nv">Lifecycle</span><span class="w"> </span><span class="nv">Management</span>
<span class="w">     </span>├─<span class="w"> </span><span class="nv">Hardware</span><span class="w"> </span><span class="nv">Interface</span><span class="w">           </span>├─<span class="w"> </span><span class="nv">Hardware</span><span class="w"> </span><span class="nv">Components</span>
<span class="w">     </span>│<span class="w">   </span>└─<span class="w"> </span><span class="nv">Static</span><span class="w"> </span><span class="nv">Loading</span><span class="w">           </span>│<span class="w">   </span>├─<span class="w"> </span><span class="nv">Dynamic</span><span class="w"> </span><span class="nv">Loading</span>
<span class="w">     </span>│<span class="w">                               </span>│<span class="w">   </span>└─<span class="w"> </span><span class="nv">State</span><span class="w"> </span><span class="nv">Interfaces</span>
<span class="w">     </span>└─<span class="w"> </span><span class="nv">Transmission</span><span class="w">                </span>└─<span class="w"> </span><span class="nv">Chainable</span><span class="w"> </span><span class="nv">Controllers</span>
<span class="w">         </span>└─<span class="w"> </span><span class="nv">Fixed</span><span class="w"> </span><span class="nv">Pipeline</span><span class="w">               </span>└─<span class="w"> </span><span class="nv">Flexible</span><span class="w"> </span><span class="nv">Routing</span>
</code></pre></div>

<h2 id="135_1">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_2">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_3">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_4">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_5">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$</li>
</ul>
<h3 id="_6">系统组件概览</h3>
<p>ros2_control 框架由以下核心组件构成：</p>
<ol>
<li><strong>Hardware Components</strong>：封装实际硬件或仿真接口</li>
<li><strong>Resource Manager</strong>：管理硬件资源的分配和访问</li>
<li><strong>Controller Manager</strong>：负责控制器的生命周期和执行调度</li>
<li><strong>Controllers</strong>：实现具体的控制算法</li>
<li><strong>Transmission System</strong>：处理关节空间与执行器空间的映射</li>
</ol>
<h2 id="132_1">13.2 硬件抽象层设计</h2>
<p>硬件抽象层是 ros2_control 的基础，它定义了控制系统与物理硬件之间的标准接口。这种抽象使得同一套控制算法可以无缝地在仿真环境和真实硬件之间切换。</p>
<h3 id="hardware-interface">Hardware Interface 架构</h3>
<p>Hardware Interface 采用组件化设计，每个硬件组件都继承自 <code>hardware_interface::SystemInterface</code>、<code>hardware_interface::ActuatorInterface</code> 或 <code>hardware_interface::SensorInterface</code>：</p>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>
<span class="nf">SystemInterface</span><span class="w"> </span><span class="p">(</span>多关节系统，如机械臂<span class="p">)</span>
<span class="w">    </span>├─<span class="w"> </span><span class="nv">State</span><span class="w"> </span><span class="nv">Interfaces</span>
<span class="w">    </span>│<span class="w">   </span>├─<span class="w"> </span><span class="nv">position</span>
<span class="w">    </span>│<span class="w">   </span>├─<span class="w"> </span><span class="nv">velocity</span>
<span class="w">    </span>│<span class="w">   </span>└─<span class="w"> </span><span class="nv">effort</span>
<span class="w">    </span>└─<span class="w"> </span><span class="nv">Command</span><span class="w"> </span><span class="nv">Interfaces</span>
<span class="w">        </span>├─<span class="w"> </span><span class="nv">position_command</span>
<span class="w">        </span>├─<span class="w"> </span><span class="nv">velocity_command</span>
<span class="w">        </span>└─<span class="w"> </span><span class="nv">effort_command</span>

<span class="nf">ActuatorInterface</span><span class="w"> </span><span class="p">(</span>单个执行器<span class="p">)</span>
<span class="w">    </span>├─<span class="w"> </span><span class="nv">State</span><span class="o">:</span><span class="w"> </span><span class="nv">position</span><span class="p">,</span><span class="w"> </span><span class="nv">velocity</span><span class="p">,</span><span class="w"> </span><span class="nv">effort</span>
<span class="w">    </span>└─<span class="w"> </span><span class="nv">Command</span><span class="o">:</span><span class="w"> </span><span class="nv">position</span><span class="o">/</span><span class="nv">velocity</span><span class="o">/</span><span class="nv">effort</span>

<span class="nf">SensorInterface</span><span class="w"> </span><span class="p">(</span>传感器<span class="p">)</span>
<span class="w">    </span>└─<span class="w"> </span><span class="nv">State</span><span class="o">:</span><span class="w"> </span><span class="k">for</span><span class="nv">ce</span><span class="p">,</span><span class="w"> </span><span class="k">to</span><span class="nv">rque</span><span class="p">,</span><span class="w"> </span><span class="nv">IMU</span><span class="w"> </span><span class="nv">data</span><span class="p">,</span><span class="w"> </span><span class="nv">etc</span><span class="o">.</span>
</code></pre></div>

<h2 id="135_2">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_1">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_7">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_8">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_9">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_10">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$</li>
</ul>
<h3 id="_11">状态与命令接口</h3>
<p>ros2_control 使用状态接口（State Interface）和命令接口（Command Interface）来抽象硬件交互：</p>
<p><strong>状态接口</strong>：从硬件读取当前状态</p>
<ul>
<li>关节位置、速度、力矩</li>
<li>传感器读数（力传感器、IMU等）</li>
<li>硬件状态标志（温度、错误码等）</li>
</ul>
<p><strong>命令接口</strong>：向硬件发送控制命令</p>
<ul>
<li>位置命令（用于位置控制）</li>
<li>速度命令（用于速度控制）</li>
<li>力矩/力命令（用于力控制）</li>
</ul>
<h3 id="resource-manager">Resource Manager 机制</h3>
<p>Resource Manager 是硬件资源的中央管理器，负责：</p>
<ol>
<li><strong>资源注册与发现</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="n">DH</span><span class="w"> </span><span class="err">参数表（</span><span class="n">Denavit</span><span class="o">-</span><span class="n">Hartenberg</span><span class="err">）：</span>

<span class="o">|</span><span class="w"> </span><span class="n">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="err">α</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">d</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="err">θ</span><span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="n">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">a</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="err">α</span><span class="p">(</span><span class="n">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">d</span><span class="p">(</span><span class="n">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="err">θ</span><span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="n">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="err">π</span><span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="err">θ₁</span><span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="err">π</span><span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="err">θ₂</span><span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="err">π</span><span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="err">θ₃</span><span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="err">π</span><span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="err">θ₄</span><span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span><span class="err">π</span><span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="err">θ₅</span><span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="err">π</span><span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="err">θ₆</span><span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="n">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span><span class="err">θ₇</span><span class="w"> </span><span class="o">|</span>

<span class="err">正运动学变换矩阵：</span>
<span class="o">$$</span><span class="n">T</span>\<span class="n">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="n">prod</span>\<span class="n">_</span><span class="p">{</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="n">T</span>\<span class="n">_</span><span class="p">{</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="n">i</span><span class="p">}(</span>\<span class="n">theta</span>\<span class="n">_i</span><span class="p">)</span><span class="o">$$</span>
<span class="err">其中每个关节变换矩阵：</span>
<span class="o">$$</span><span class="n">T</span>\<span class="n">_</span><span class="p">{</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="n">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="n">begin</span><span class="p">{</span><span class="n">bmatrix</span><span class="p">}</span>
\<span class="nb">cos</span>\<span class="n">theta</span>\<span class="n">_i</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">-</span>\<span class="nb">sin</span>\<span class="n">theta</span>\<span class="n">_i</span>\<span class="nb">cos</span>\<span class="n">alpha</span>\<span class="n">_i</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span>\<span class="nb">sin</span>\<span class="n">theta</span>\<span class="n">_i</span>\<span class="nb">sin</span>\<span class="n">alpha</span>\<span class="n">_i</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">a</span>\<span class="n">_i</span>\<span class="nb">cos</span>\<span class="n">theta</span>\<span class="n">_i</span><span class="w"> </span>\\\\
\<span class="nb">sin</span>\<span class="n">theta</span>\<span class="n">_i</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span>\<span class="nb">cos</span>\<span class="n">theta</span>\<span class="n">_i</span>\<span class="nb">cos</span>\<span class="n">alpha</span>\<span class="n">_i</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="o">-</span>\<span class="nb">cos</span>\<span class="n">theta</span>\<span class="n">_i</span>\<span class="nb">sin</span>\<span class="n">alpha</span>\<span class="n">_i</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">a</span>\<span class="n">_i</span>\<span class="nb">sin</span>\<span class="n">theta</span>\<span class="n">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span>\<span class="nb">sin</span>\<span class="n">alpha</span>\<span class="n">_i</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span>\<span class="nb">cos</span>\<span class="n">alpha</span>\<span class="n">_i</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="n">d</span>\<span class="n">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="mi">1</span>
\<span class="n">end</span><span class="p">{</span><span class="n">bmatrix</span><span class="p">}</span><span class="o">$$</span>
<span class="c1">### 关节控制器实现</span>

<span class="err">关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</span>

<span class="o">**</span><span class="err">重力补偿计算</span><span class="o">**</span><span class="err">：</span>

<span class="err">重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：</span>
<span class="o">$$</span>\<span class="n">tau</span>\<span class="n">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">G</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="n">sum</span>\<span class="n">_</span><span class="p">{</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="n">n</span><span class="p">}</span><span class="w"> </span><span class="n">m</span>\<span class="n">_i</span><span class="w"> </span><span class="n">g</span><span class="o">^</span><span class="n">T</span><span class="w"> </span><span class="n">J</span>\<span class="n">_</span><span class="p">{</span><span class="n">v</span>\<span class="n">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="n">c</span>\<span class="n">_i</span><span class="p">}(</span><span class="n">q</span><span class="p">)</span><span class="o">$$</span>
<span class="err">其中：</span>

<span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="n">m</span>\<span class="n">_i</span><span class="o">$</span><span class="w"> </span><span class="err">是连杆</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="err">的质量</span>
<span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="n">g</span><span class="o">$</span><span class="w"> </span><span class="err">是重力向量</span>
<span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="n">J</span>\<span class="n">_</span><span class="p">{</span><span class="n">v</span>\<span class="n">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="n">c</span>\<span class="n">_i</span><span class="p">}</span><span class="o">$</span><span class="w"> </span><span class="err">是连杆</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="err">质心的线速度雅可比矩阵</span>

<span class="c1">### 轨迹跟踪控制</span>

<span class="err">轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</span>

<span class="mf">1.</span><span class="w"> </span><span class="o">**</span><span class="err">三次样条插值</span><span class="o">**</span><span class="err">：保证位置和速度连续性</span>
<span class="mf">2.</span><span class="w"> </span><span class="o">**</span><span class="err">前馈控制</span><span class="o">**</span><span class="err">：提高跟踪精度</span>
<span class="mf">3.</span><span class="w"> </span><span class="o">**</span><span class="err">误差容限管理</span><span class="o">**</span><span class="err">：判断轨迹执行成功与否</span>

<span class="err">轨迹规划的约束条件：</span>

<span class="o">-</span><span class="w"> </span><span class="err">关节位置限制：</span><span class="o">$</span><span class="n">q</span>\<span class="n">_</span><span class="p">{</span><span class="nb">min</span><span class="p">}</span><span class="w"> </span>\<span class="n">leq</span><span class="w"> </span><span class="n">q</span><span class="w"> </span>\<span class="n">leq</span><span class="w"> </span><span class="n">q</span>\<span class="n">_</span><span class="p">{</span><span class="nb">max</span><span class="p">}</span><span class="o">$</span>
<span class="o">-</span><span class="w"> </span><span class="err">关节速度限制：</span><span class="o">$|</span>\<span class="n">dot</span><span class="p">{</span><span class="n">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="n">leq</span><span class="w"> </span>\<span class="n">dot</span><span class="p">{</span><span class="n">q</span><span class="p">}</span>\<span class="n">_</span><span class="p">{</span><span class="nb">max</span><span class="p">}</span><span class="o">$</span>
<span class="o">-</span><span class="w"> </span><span class="err">关节加速度限制：</span><span class="o">$|</span>\<span class="n">ddot</span><span class="p">{</span><span class="n">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="n">leq</span><span class="w"> </span>\<span class="n">ddot</span><span class="p">{</span><span class="n">q</span><span class="p">}</span>\<span class="n">_</span><span class="p">{</span><span class="nb">max</span><span class="p">}</span><span class="o">$</span>
<span class="o">-</span><span class="w"> </span><span class="err">关节加加速度限制：</span><span class="o">$|</span>\<span class="n">dddot</span><span class="p">{</span><span class="n">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="n">leq</span><span class="w"> </span>\<span class="n">dddot</span><span class="p">{</span><span class="n">q</span><span class="p">}</span>\<span class="n">_</span><span class="p">{</span><span class="nb">max</span><span class="p">}</span><span class="o">$</span>

<span class="c1">### 力矩控制与动力学补偿</span>

<span class="err">力矩控制提供最直接的控制方式，但需要精确的动力学模型：</span>

<span class="err">动力学方程（拉格朗日形式）：</span>
<span class="o">$$</span><span class="n">M</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>\<span class="n">ddot</span><span class="p">{</span><span class="n">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">C</span><span class="p">(</span><span class="n">q</span><span class="p">,</span>\<span class="n">dot</span><span class="p">{</span><span class="n">q</span><span class="p">})</span>\<span class="n">dot</span><span class="p">{</span><span class="n">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">G</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="n">tau</span><span class="o">$$</span>
<span class="err">其中：</span>

<span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="n">M</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">$</span><span class="w"> </span><span class="err">是惯性矩阵（对称正定）</span>
<span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="n">C</span><span class="p">(</span><span class="n">q</span><span class="p">,</span>\<span class="n">dot</span><span class="p">{</span><span class="n">q</span><span class="p">})</span><span class="o">$</span><span class="w"> </span><span class="err">是科氏力和离心力矩阵</span>
<span class="o">-</span><span class="w"> </span><span class="o">$</span><span class="n">G</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">$</span><span class="w"> </span><span class="err">是重力向量</span>
<span class="o">-</span><span class="w"> </span><span class="o">$</span>\<span class="n">tau</span><span class="o">$</span><span class="w"> </span><span class="err">是关节力矩</span>

<span class="err">计算力矩控制律：</span>
<span class="o">$$</span>\<span class="n">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">(</span><span class="n">q</span><span class="p">)(</span>\<span class="n">ddot</span><span class="p">{</span><span class="n">q</span><span class="p">}</span>\<span class="n">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K</span>\<span class="n">_p</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K</span>\<span class="n">_d</span><span class="w"> </span>\<span class="n">dot</span><span class="p">{</span><span class="n">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">C</span><span class="p">(</span><span class="n">q</span><span class="p">,</span>\<span class="n">dot</span><span class="p">{</span><span class="n">q</span><span class="p">})</span>\<span class="n">dot</span><span class="p">{</span><span class="n">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">G</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="o">$$</span>
<span class="err">其中</span><span class="w"> </span><span class="o">$</span><span class="n">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">q</span>\<span class="n">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">q</span><span class="o">$</span><span class="w"> </span><span class="err">是位置误差。</span>

<span class="c1">### 关节空间阻抗控制</span>

<span class="err">阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</span>

<span class="err">阻抗模型：</span>
<span class="o">$$</span><span class="n">M</span>\<span class="n">_d</span><span class="p">(</span>\<span class="n">ddot</span><span class="p">{</span><span class="n">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="n">ddot</span><span class="p">{</span><span class="n">x</span><span class="p">}</span>\<span class="n">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">D</span>\<span class="n">_d</span><span class="p">(</span>\<span class="n">dot</span><span class="p">{</span><span class="n">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="n">dot</span><span class="p">{</span><span class="n">x</span><span class="p">}</span>\<span class="n">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K</span>\<span class="n">_d</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x</span>\<span class="n">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">F</span>\<span class="n">_</span><span class="p">{</span><span class="n">ext</span><span class="p">}</span><span class="o">$$</span>
<span class="err">设计准则：</span>

<span class="o">-</span><span class="w"> </span><span class="err">低刚度</span><span class="w"> </span><span class="o">$</span><span class="n">K</span>\<span class="n">_d</span><span class="o">$</span><span class="err">：柔顺接触，适合精密装配</span>
<span class="o">-</span><span class="w"> </span><span class="err">高刚度</span><span class="w"> </span><span class="o">$</span><span class="n">K</span>\<span class="n">_d</span><span class="o">$</span><span class="err">：精确位置控制</span>
<span class="o">-</span><span class="w"> </span><span class="err">适中阻尼</span><span class="w"> </span><span class="o">$</span><span class="n">D</span>\<span class="n">_d</span><span class="o">$</span><span class="err">：避免振荡，临界阻尼</span><span class="w"> </span><span class="o">$</span><span class="n">D</span>\<span class="n">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nb">sqrt</span><span class="p">{</span><span class="n">M</span>\<span class="n">_d</span><span class="w"> </span><span class="n">K</span>\<span class="n">_d</span><span class="p">}</span><span class="o">$</span>
<span class="w">   </span><span class="err">资源注册流程：</span>
<span class="w">   </span><span class="n">Hardware</span><span class="w"> </span><span class="n">Component</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">export_interfaces</span><span class="p">()</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">Resource</span><span class="w"> </span><span class="n">Manager</span>
<span class="w">                                                    </span><span class="err">│</span>
<span class="w">                                                    </span><span class="err">├─</span><span class="w"> </span><span class="n">State</span><span class="w"> </span><span class="n">Interface</span><span class="w"> </span><span class="n">Registry</span>
<span class="w">                                                    </span><span class="err">└─</span><span class="w"> </span><span class="n">Command</span><span class="w"> </span><span class="n">Interface</span><span class="w"> </span><span class="n">Registry</span>
<span class="w">   </span><span class="err">```</span>

<span class="c1">## 13.5 机械臂控制实例</span>

<span class="err">机械臂控制是</span><span class="w"> </span><span class="n">ros2_control</span><span class="w"> </span><span class="err">最典型的应用场景。本节将通过一个</span><span class="w"> </span><span class="mi">7</span><span class="w"> </span><span class="err">自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</span>

<span class="c1">### 7自由度机械臂建模</span>

<span class="mi">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="err">机械臂相比</span><span class="w"> </span><span class="mi">6</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="err">具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</span>
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>资源分配与锁定<span class="o">**</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span>防止多个控制器同时访问同一命令接口
<span class="w">   </span><span class="o">-</span><span class="w"> </span>允许多个控制器共享状态接口（只读）
<span class="w">   </span><span class="o">-</span><span class="w"> </span>实现资源互斥和优先级管理

<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>生命周期管理<span class="o">**</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="nv">Configure</span>：加载硬件配置，建立通信
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="nv">Activate</span>：启动硬件，开始数据交换
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="nv">Deactivate</span>：停止硬件，保持连接
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="nv">Cleanup</span>：释放资源，断开连接

<span class="o">###</span><span class="w"> </span>硬件组件生命周期

硬件组件遵循标准的生命周期状态机：
</code></pre></div>

<h2 id="135_3">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_2">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_12">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_13">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_14">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_15">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$
    [Unconfigured] 
          │
      configure()
          ↓
     [Inactive]
       ↙    ↘
  activate() deactivate()
     ↓        ↑
    [Active]──┘</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

每个状态转换都有对应的回调函数：

<span class="o">-</span><span class="w"> </span><span class="nv">`on_configure()`</span><span class="o">:</span><span class="w"> </span>读取参数，初始化硬件连接
<span class="o">-</span><span class="w"> </span><span class="nv">`on_activate()`</span><span class="o">:</span><span class="w"> </span>启动硬件，开始控制循环
<span class="o">-</span><span class="w"> </span><span class="nv">`on_deactivate()`</span><span class="o">:</span><span class="w"> </span>停止控制，保持安全状态
<span class="o">-</span><span class="w"> </span><span class="nv">`on_cleanup()`</span><span class="o">:</span><span class="w"> </span>清理资源，关闭连接

<span class="o">###</span><span class="w"> </span>自定义硬件接口开发

开发自定义硬件接口需要实现以下关键方法：
</code></pre></div>

<h2 id="135_4">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_3">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_16">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_17">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_18">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_19">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$cpp
class MyRobotSystem : public hardware_interface::SystemInterface {
public:
  // 导出状态和命令接口
  std::vector<hardware_interface::StateInterface> export_state_interfaces() override {
    std::vector<hardware_interface::StateInterface> state_interfaces;
    for (size_t i = 0; i &lt; joint_count_; ++i) {
      state_interfaces.emplace_back(
        joint_names_[i], "position", &amp;joint_positions_[i]);
      state_interfaces.emplace_back(
        joint_names_[i], "velocity", &amp;joint_velocities_[i]);
    }
    return state_interfaces;
  }</li>
</ul>
<p>// 硬件读取
  return_type read(const rclcpp::Time &amp; time, const rclcpp::Duration &amp; period) override {
    // 从硬件读取当前状态
    // 更新 joint_positions_, joint_velocities_ 等
    return return_type::OK;
  }</p>
<p>// 硬件写入
  return_type write(const rclcpp::Time &amp; time, const rclcpp::Duration &amp; period) override {
    // 将命令发送到硬件
    // 读取 joint_position_commands_ 并发送
    return return_type::OK;
  }
};</p>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>硬件接口配置

硬件接口通过<span class="w"> </span><span class="nv">URDF</span><span class="o">/</span><span class="nv">XACRO</span><span class="w"> </span>文件配置：
</code></pre></div>

<h2 id="135_5">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_4">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_20">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_21">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_22">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_23">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$xml
<ros2_control name="MyRobotSystem" type="system">
  <hardware>
    <plugin>my_robot_hardware/MyRobotSystem</plugin>
    <param name="robot_ip">192.168.1.100</param>
    <param name="control_frequency">1000</param>
  </hardware>
  <joint name="joint1">
    <command_interface name="position"/>
    <command_interface name="velocity"/>
    <state_interface name="position">
      <param name="initial_value">0.0</param>
    </state_interface>
    <state_interface name="velocity"/>
    <state_interface name="effort"/>
  </joint>
</ros2_control></li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

<span class="o">##</span><span class="w"> </span><span class="mf">13.3</span><span class="w"> </span>控制器链（<span class="nv">Controller</span><span class="w"> </span><span class="nv">Chaining</span>）

控制器链是<span class="w"> </span><span class="nv">ros2_control</span><span class="w"> </span>的创新特性，允许控制器之间形成级联关系，实现复杂的控制策略。这种设计使得控制系统可以像搭积木一样组合不同的控制模块。

<span class="o">###</span><span class="w"> </span>控制器管理器架构

<span class="nv">Controller</span><span class="w"> </span><span class="nv">Manager</span><span class="w"> </span>是控制器的运行时环境，负责：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>控制器加载与配置<span class="o">**</span>
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>资源分配与冲突检测<span class="o">**</span>
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>执行顺序调度<span class="o">**</span>
<span class="mi">4</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>实时循环管理<span class="o">**</span>

控制器管理器的执行流程：
</code></pre></div>

<h2 id="135_6">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_5">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_24">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_25">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_26">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_27">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$
Control Loop (1kHz)
    │
    ├─ read() → 从硬件读取状态
    │
    ├─ update() → 按依赖顺序更新控制器
    │   ├─ Sensor Controllers (第一层)
    │   ├─ State Controllers (第二层)
    │   └─ Command Controllers (第三层)
    │
    └─ write() → 向硬件写入命令</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>可链接控制器设计

可链接控制器（<span class="nv">Chainable</span><span class="w"> </span><span class="nv">Controller</span>）既可以作为其他控制器的输入源，也可以接收其他控制器的输出：
</code></pre></div>

<h2 id="135_7">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_6">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_28">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_29">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_30">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_31">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$
传统控制器:
Hardware → Controller → Hardware</li>
</ul>
<p>可链接控制器:
Hardware → Controller A → Controller B → Controller C → Hardware
              (滤波)        (PID)         (限幅)</p>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

实现可链接控制器的关键接口：
</code></pre></div>

<h2 id="135_8">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_7">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_32">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_33">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_34">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_35">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$cpp
class ChainableController : public controller_interface::ControllerInterface {
public:
  // 导出引用接口供下游控制器使用
  std::vector<hardware_interface::StateInterface> export_state_interfaces() {
    std::vector<hardware_interface::StateInterface> state_interfaces;
    state_interfaces.emplace_back(
      get_node()-&gt;get_name(), "output", &amp;output_value_);
    return state_interfaces;
  }</li>
</ul>
<p>// 声明需要的引用接口
  std::vector<hardware_interface::CommandInterface> export_reference_interfaces() {
    std::vector<hardware_interface::CommandInterface> reference_interfaces;
    reference_interfaces.emplace_back(
      get_node()-&gt;get_name(), "reference", &amp;reference_value_);
    return reference_interfaces;
  }
};</p>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>控制器间数据流

控制器链中的数据流遵循严格的方向性：
</code></pre></div>

<h2 id="135_9">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_8">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_36">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_37">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_38">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_39">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$
数据流示例：力控制链
┌─────────────┐     ┌──────────────┐     ┌────────────┐     ┌──────────┐
│Force Sensor │ --&gt; │Gravity Comp. │ --&gt; │Force PID   │ --&gt; │Joint Cmd │
│Controller   │     │Controller    │     │Controller  │     │Interface │
└─────────────┘     └──────────────┘     └────────────┘     └──────────┘
     读取力              补偿重力           计算力矩          发送命令</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>动态加载与切换

控制器支持运行时动态加载和切换，这对于多模态控制至关重要：
</code></pre></div>

<h2 id="135_10">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_9">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_40">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_41">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_42">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_43">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$yaml</li>
</ul>
<h1 id="_44">控制器配置示例</h1>
<p>controller_manager:
  ros__parameters:
    update_rate: 1000  # Hz</p>
<div class="codehilite"><pre><span></span><code><span class="err">#</span><span class="w"> </span><span class="nx">位置控制器</span>
<span class="nx">position_controller</span><span class="p">:</span>
<span class="w">  </span><span class="k">type</span><span class="p">:</span><span class="w"> </span><span class="nx">position_controllers</span><span class="o">/</span><span class="nx">JointGroupPositionController</span>
<span class="w">  </span><span class="nx">joints</span><span class="p">:</span>

<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="nx">joint1</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="nx">joint2</span>

<span class="err">#</span><span class="w"> </span><span class="nx">轨迹控制器</span><span class="w">  </span>
<span class="nx">trajectory_controller</span><span class="p">:</span>
<span class="w">  </span><span class="k">type</span><span class="p">:</span><span class="w"> </span><span class="nx">joint_trajectory_controller</span><span class="o">/</span><span class="nx">JointTrajectoryController</span>
<span class="w">  </span><span class="nx">joints</span><span class="p">:</span>

<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="nx">joint1</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="nx">joint2</span>
<span class="w">  </span><span class="nx">state_interfaces</span><span class="p">:</span>

<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="nx">position</span>
<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="nx">velocity</span>
<span class="w">  </span><span class="nx">command_interfaces</span><span class="p">:</span>

<span class="w">    </span><span class="o">-</span><span class="w"> </span><span class="nx">position</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

控制器切换流程：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>停止当前控制器<span class="o">**</span>
</code></pre></div>

<h2 id="135_11">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_10">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_45">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_46">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_47">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_48">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$bash
   ros2 control switch_controllers --stop position_controller</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>启动新控制器<span class="o">**</span>
</code></pre></div>

<h2 id="135_12">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_11">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_49">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_50">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_51">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_52">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$bash
   ros2 control switch_controllers --start trajectory_controller</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>原子切换<span class="o">**</span>（同时停止和启动）
</code></pre></div>

<h2 id="135_13">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_12">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_53">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_54">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_55">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_56">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$bash
   ros2 control switch_controllers \
     --stop position_controller \
     --start trajectory_controller \
     --strict  # 确保切换成功</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>控制器优先级与冲突解决

当多个控制器请求同一资源时，需要优先级机制：
</code></pre></div>

<h2 id="135_14">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_13">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_57">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_58">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_59">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_60">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$
优先级规则：</li>
</ul>
<ol>
<li>
<p>安全控制器 (最高优先级)
   └─ 紧急停止、碰撞避免</p>
</li>
<li>
<p>轨迹控制器
   └─ 路径跟踪、运动规划执行</p>
</li>
<li>
<p>位置控制器
   └─ 点到点运动</p>
</li>
<li>
<p>速度控制器 (最低优先级)
   └─ 手动控制、遥操作</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>控制器链实例：阻抗控制

阻抗控制是控制器链的典型应用：
</code></pre></div>

<h2 id="135_15">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_14">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_61">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_62">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_63">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_64">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$
阻抗控制链：
┌────────────┐    ┌──────────────┐    ┌─────────────┐    ┌──────────┐
│Position    │    │Impedance     │    │Torque       │    │Hardware  │
│Reference   │ -&gt; │Controller    │ -&gt; │Controller   │ -&gt; │Interface │
└────────────┘    └──────────────┘    └─────────────┘    └──────────┘
                        │
                        ├─ K_p (刚度矩阵)
                        ├─ K_d (阻尼矩阵)<br />
                        └─ M (惯性矩阵)</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

阻抗控制器实现：
</code></pre></div>

<h2 id="135_16">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_15">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_65">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_66">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_67">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_68">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>
<p>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$cpp
class ImpedanceController : public ChainableController {
  controller_interface::return_type update(
    const rclcpp::Time &amp; time, const rclcpp::Duration &amp; period) {</p>
<p>// 计算位置误差
Eigen::VectorXd pos_error = desired_position_ - current_position_;
Eigen::VectorXd vel_error = desired_velocity_ - current_velocity_;</p>
<p>// 阻抗控制律: F = K_p * Δx + K_d * Δẋ + M * ẍ_d
Eigen::VectorXd force_cmd = 
  stiffness_matrix_ * pos_error +
  damping_matrix_ * vel_error +
  inertia_matrix_ * desired_acceleration_;</p>
<p>// 输出到下游力矩控制器
output_force_ = force_cmd;</p>
<p>return controller_interface::return_type::OK;
  }
};</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

<span class="o">##</span><span class="w"> </span><span class="mf">13.4</span><span class="w"> </span>实时控制循环

实时控制是机器人系统的核心要求，<span class="nv">ros2_control</span><span class="w"> </span>通过精心设计的控制循环和调度策略，实现了微秒级的控制周期和确定性的响应时间。

<span class="o">###</span><span class="w"> </span>实时性保证机制

<span class="nv">ros2_control</span><span class="w"> </span>的实时性建立在多个层次的保证机制之上：
</code></pre></div>

<h2 id="135_17">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_16">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_69">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_70">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_71">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_72">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$
实时性层次结构：
┌─────────────────────────────┐
│     应用层 (控制算法)        │ ← 无动态内存分配
├─────────────────────────────┤
│     ros2_control 框架       │ ← 锁定内存页
├─────────────────────────────┤
│     DDS 中间件 (实时配置)    │ ← 零拷贝传输
├─────────────────────────────┤
│     实时内核 (RT_PREEMPT)   │ ← 抢占式调度
└─────────────────────────────┘</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

关键的实时保证技术：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>内存预分配<span class="o">**</span>：避免运行时内存分配
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>锁定内存页<span class="o">**</span>：防止页面交换
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span><span class="nv">CPU</span><span class="w"> </span>亲和性<span class="o">**</span>：绑定到专用<span class="w"> </span><span class="nv">CPU</span><span class="w"> </span>核心
<span class="mi">4</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>实时调度策略<span class="o">**</span>：<span class="nv">SCHED_FIFO</span><span class="w"> </span>或<span class="w"> </span><span class="nv">SCHED_RR</span>

<span class="o">###</span><span class="w"> </span>控制周期与更新率

控制周期的选择直接影响系统性能：
</code></pre></div>

<h2 id="135_18">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_17">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_73">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_74">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_75">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_76">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>
<p>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$
典型控制频率：</p>
</li>
<li>
<p>位置控制: 100-500 Hz</p>
</li>
<li>速度控制: 500-1000 Hz  </li>
<li>力/力矩控制: 1000-4000 Hz</li>
<li>电流控制: 10-40 kHz (通常在驱动器内部)</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

控制周期的数学关系：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_s</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">frac</span><span class="p">{</span><span class="mi">1</span><span class="p">}{</span><span class="nv">f</span>\<span class="nv">_c</span><span class="p">}$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">T</span>\<span class="nv">_s</span><span class="p">$</span><span class="w"> </span>是采样周期，<span class="p">$</span><span class="nv">f</span>\<span class="nv">_c</span><span class="p">$</span><span class="w"> </span>是控制频率。

奈奎斯特采样定理要求：
<span class="p">$$</span><span class="nv">f</span>\<span class="nv">_c</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span>\<span class="nv">cdot</span><span class="w"> </span><span class="nv">f</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">f</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span><span class="w"> </span>是系统最高频率成分。

<span class="o">###</span><span class="w"> </span>线程模型与调度

<span class="nv">ros2_control</span><span class="w"> </span>采用多线程架构，不同组件运行在不同优先级的线程中：
</code></pre></div>

<h2 id="135_19">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_18">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_77">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_78">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_79">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_80">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>
<p>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$cpp
// 控制循环线程配置
class ControlLoop {
  void configure_realtime() {
    // 设置线程优先级
    struct sched_param param;
    param.sched_priority = 95;  // 高优先级
    pthread_setschedparam(pthread_self(), SCHED_FIFO, &amp;param);</p>
<p>// 锁定内存
mlockall(MCL_CURRENT | MCL_FUTURE);</p>
<p>// CPU 亲和性
cpu_set_t cpuset;
CPU_ZERO(&amp;cpuset);
CPU_SET(3, &amp;cpuset);  // 绑定到 CPU 3
pthread_setaffinity_np(pthread_self(), sizeof(cpuset), &amp;cpuset);
  }</p>
</li>
</ul>
<p>void run() {
    rclcpp::Time last_time = node_-&gt;now();
    rclcpp::Duration period(0, 1000000);  // 1ms</p>
<div class="codehilite"><pre><span></span><code><span class="nt">while</span><span class="w"> </span><span class="o">(</span><span class="nt">rclcpp</span><span class="p">::</span><span class="nd">ok</span><span class="o">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="err">auto</span><span class="w"> </span><span class="err">current_time</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">node_-&gt;now()</span><span class="p">;</span>
<span class="w">  </span><span class="err">auto</span><span class="w"> </span><span class="err">elapsed</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">current_time</span><span class="w"> </span><span class="err">-</span><span class="w"> </span><span class="err">last_time</span><span class="p">;</span>

<span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">硬件读取</span>
<span class="w">  </span><span class="err">hardware_-&gt;read(current_time,</span><span class="w"> </span><span class="err">elapsed)</span><span class="p">;</span>

<span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">控制器更新</span>
<span class="w">  </span><span class="err">controller_manager_-&gt;update(current_time,</span><span class="w"> </span><span class="err">elapsed)</span><span class="p">;</span>

<span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">硬件写入</span>
<span class="w">  </span><span class="err">hardware_-&gt;write(current_time,</span><span class="w"> </span><span class="err">elapsed)</span><span class="p">;</span>

<span class="w">  </span><span class="err">//</span><span class="w"> </span><span class="err">精确睡眠到下一个周期</span>
<span class="w">  </span><span class="n">std</span><span class="p">:</span><span class="o">:</span><span class="n">this_thread</span><span class="o">::</span><span class="nf">sleep_until</span><span class="p">(</span><span class="n">last_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">period</span><span class="p">);</span>
<span class="w">  </span><span class="err">last_time</span><span class="w"> </span><span class="err">=</span><span class="w"> </span><span class="err">current_time</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>}
};</p>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>延迟分析与优化

控制循环的总延迟由多个部分组成：
</code></pre></div>

<h2 id="135_20">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_19">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_81">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_82">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_83">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_84">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$
总延迟 = 传感器延迟 + 通信延迟 + 计算延迟 + 执行器延迟</li>
</ul>
<p>典型延迟分解 (1kHz 控制循环):
├─ 传感器读取: 50-100 μs
├─ 控制计算:  100-200 μs<br />
├─ 通信传输:  50-100 μs
└─ 执行器响应: 200-500 μs
总计: 400-900 μs (&lt; 1ms 周期)</p>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

延迟优化策略：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>传感器优化<span class="o">**</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span>使用硬件触发采样
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="nv">DMA</span><span class="w"> </span>直接内存访问
<span class="w">   </span><span class="o">-</span><span class="w"> </span>并行读取多个传感器

<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>计算优化<span class="o">**</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="nv">SIMD</span><span class="w"> </span>向量化计算
<span class="w">   </span><span class="o">-</span><span class="w"> </span>查表法替代复杂计算
<span class="w">   </span><span class="o">-</span><span class="w"> </span>增量式算法

<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>通信优化<span class="o">**</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span>共享内存通信
<span class="w">   </span><span class="o">-</span><span class="w"> </span>零拷贝消息传递
<span class="w">   </span><span class="o">-</span><span class="w"> </span>批量数据传输

<span class="o">###</span><span class="w"> </span>抖动（<span class="nv">Jitter</span>）控制

控制周期的抖动会严重影响控制性能：
</code></pre></div>

<h2 id="135_21">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_20">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_85">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_86">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_87">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_88">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$
抖动来源：</li>
</ul>
<ol>
<li>操作系统调度延迟</li>
<li>中断处理</li>
<li>缓存未命中</li>
<li>总线竞争</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

抖动测量与监控：
</code></pre></div>

<h2 id="135_22">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_21">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_89">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_90">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_91">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_92">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>
<p>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$cpp
class JitterMonitor {
  void measure_jitter() {
    static rclcpp::Time last_time;
    auto current_time = node_-&gt;now();</p>
<p>if (last_time.nanoseconds() &gt; 0) {
  auto period = (current_time - last_time).nanoseconds();
  auto jitter = std::abs(period - expected_period_ns_);</p>
<p>// 统计抖动
  max_jitter_ = std::max(max_jitter_, jitter);
  jitter_histogram_[jitter / 1000]++;  // 微秒级统计</p>
<p>// 抖动告警
  if (jitter &gt; jitter_threshold_) {
    RCLCPP_WARN(node_-&gt;get_logger(), 
      "High jitter detected: %ld ns", jitter);
  }
}
last_time = current_time;
  }
};</p>
</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>实时性能基准测试

评估实时性能的关键指标：
</code></pre></div>

<h2 id="135_23">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_22">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_93">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_94">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_95">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_96">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>
<p>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$
性能指标：</p>
</li>
<li>
<p>平均延迟 (Average Latency)</p>
</li>
<li>最坏情况延迟 (WCET - Worst Case Execution Time)</li>
<li>抖动标准差 (Jitter Standard Deviation)</li>
<li>丢失周期率 (Missed Deadline Rate)</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>

基准测试工具：
</code></pre></div>

<h2 id="135_24">13.5 机械臂控制实例</h2>
<p>机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。</p>
<h3 id="7_23">7自由度机械臂建模</h3>
<p>7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。</p>
<div class="codehilite"><pre><span></span><code><span class="mf">7</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">机械臂运动学链</span><span class="err">：</span>
<span class="n">Base</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">S1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">E1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W0</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W1</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="n">W2</span><span class="w"> </span><span class="err">→</span><span class="w"> </span><span class="kr">End</span><span class="o">-</span><span class="n">effector</span>
<span class="w">       </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span><span class="w">    </span><span class="err">↑</span>
<span class="w">      </span><span class="n">肩部</span><span class="w">  </span><span class="n">肩部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">肘部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span><span class="w">  </span><span class="n">腕部</span>
<span class="w">      </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">偏航</span><span class="w">  </span><span class="n">俯仰</span><span class="w">  </span><span class="n">滚转</span>
</code></pre></div>

<p>DH 参数表（Denavit-Hartenberg）：</p>
<p>| Joint | a(mm) | α(rad) | d(mm) | θ |</p>
<table>
<thead>
<tr>
<th>Joint</th>
<th>a(mm)</th>
<th>α(rad)</th>
<th>d(mm)</th>
<th>θ</th>
</tr>
</thead>
<tbody>
<tr>
<td>S0</td>
<td>0</td>
<td>-π/2</td>
<td>317</td>
<td>θ₁</td>
</tr>
<tr>
<td>S1</td>
<td>81</td>
<td>π/2</td>
<td>192.5</td>
<td>θ₂</td>
</tr>
<tr>
<td>E0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₃</td>
</tr>
<tr>
<td>E1</td>
<td>0</td>
<td>π/2</td>
<td>168.5</td>
<td>θ₄</td>
</tr>
<tr>
<td>W0</td>
<td>0</td>
<td>-π/2</td>
<td>400</td>
<td>θ₅</td>
</tr>
<tr>
<td>W1</td>
<td>0</td>
<td>π/2</td>
<td>136.3</td>
<td>θ₆</td>
</tr>
<tr>
<td>W2</td>
<td>0</td>
<td>0</td>
<td>133.75</td>
<td>θ₇</td>
</tr>
</tbody>
</table>
<p>正运动学变换矩阵：
$$T_{0}^{7} = \prod_{i=1}^{7} T_{i-1}^{i}(\theta_i)$$
其中每个关节变换矩阵：
$$T_{i-1}^{i} = \begin{bmatrix}
\cos\theta_i &amp; -\sin\theta_i\cos\alpha_i &amp; \sin\theta_i\sin\alpha_i &amp; a_i\cos\theta_i \\
\sin\theta_i &amp; \cos\theta_i\cos\alpha_i &amp; -\cos\theta_i\sin\alpha_i &amp; a_i\sin\theta_i \\
0 &amp; \sin\alpha_i &amp; \cos\alpha_i &amp; d_i \\
0 &amp; 0 &amp; 0 &amp; 1
\end{bmatrix}$$</p>
<h3 id="_97">关节控制器实现</h3>
<p>关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。</p>
<p><strong>重力补偿计算</strong>：</p>
<p>重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
$$\tau_g = G(q) = \sum_{i=1}^{n} m_i g^T J_{v_i}^{c_i}(q)$$
其中：</p>
<ul>
<li>$m_i$ 是连杆 i 的质量</li>
<li>$g$ 是重力向量</li>
<li>$J_{v_i}^{c_i}$ 是连杆 i 质心的线速度雅可比矩阵</li>
</ul>
<h3 id="_98">轨迹跟踪控制</h3>
<p>轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：</p>
<ol>
<li><strong>三次样条插值</strong>：保证位置和速度连续性</li>
<li><strong>前馈控制</strong>：提高跟踪精度</li>
<li><strong>误差容限管理</strong>：判断轨迹执行成功与否</li>
</ol>
<p>轨迹规划的约束条件：</p>
<ul>
<li>关节位置限制：$q_{min} \leq q \leq q_{max}$</li>
<li>关节速度限制：$|\dot{q}| \leq \dot{q}_{max}$</li>
<li>关节加速度限制：$|\ddot{q}| \leq \ddot{q}_{max}$</li>
<li>关节加加速度限制：$|\dddot{q}| \leq \dddot{q}_{max}$</li>
</ul>
<h3 id="_99">力矩控制与动力学补偿</h3>
<p>力矩控制提供最直接的控制方式，但需要精确的动力学模型：</p>
<p>动力学方程（拉格朗日形式）：
$$M(q)\ddot{q} + C(q,\dot{q})\dot{q} + G(q) = \tau$$
其中：</p>
<ul>
<li>$M(q)$ 是惯性矩阵（对称正定）</li>
<li>$C(q,\dot{q})$ 是科氏力和离心力矩阵</li>
<li>$G(q)$ 是重力向量</li>
<li>$\tau$ 是关节力矩</li>
</ul>
<p>计算力矩控制律：
$$\tau = M(q)(\ddot{q}_d + K_p e + K_d \dot{e}) + C(q,\dot{q})\dot{q} + G(q)$$
其中 $e = q_d - q$ 是位置误差。</p>
<h3 id="_100">关节空间阻抗控制</h3>
<p>阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：</p>
<p>阻抗模型：
$$M_d(\ddot{x} - \ddot{x}_d) + D_d(\dot{x} - \dot{x}_d) + K_d(x - x_d) = F_{ext}$$
设计准则：</p>
<ul>
<li>低刚度 $K_d$：柔顺接触，适合精密装配</li>
<li>高刚度 $K_d$：精确位置控制</li>
<li>适中阻尼 $D_d$：避免振荡，临界阻尼 $D_d = 2\sqrt{M_d K_d}$bash</li>
</ul>
<h1 id="cyclictest">cyclictest 测试实时延迟</h1>
<p>sudo cyclictest -p 95 -t1 -n -i 1000 -l 100000</p>
<h1 id="ros2_control_1">ros2_control 性能分析</h1>
<p>ros2 run controller_manager ros2_control_benchmark \
  --iterations 10000 \
  --control-frequency 1000</p>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span> 13.5 机械臂控制实例

机械臂控制是 ros2_control 最典型的应用场景。本节将通过一个 7 自由度机械臂的完整实现，展示从底层硬件接口到高级控制算法的全栈开发流程。

<span class="gu">##</span># 7自由度机械臂建模

7-DOF 机械臂相比 6-DOF 具有冗余自由度，能够在保持末端位姿不变的情况下调整关节配置，这对于避障和优化关节运动至关重要。
</code></pre></div>

<p>7-DOF 机械臂运动学链：
Base → S0 → S1 → E0 → E1 → W0 → W1 → W2 → End-effector
       ↑    ↑    ↑    ↑    ↑    ↑    ↑
      肩部  肩部  肘部  肘部  腕部  腕部  腕部
      偏航  俯仰  偏航  俯仰  偏航  俯仰  滚转</p>
<div class="codehilite"><pre><span></span><code><span class="nv">DH</span><span class="w"> </span>参数表（<span class="nv">Denavit</span><span class="o">-</span><span class="nv">Hartenberg</span>）：

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>

<span class="o">|</span><span class="w"> </span><span class="nv">Joint</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>α<span class="p">(</span><span class="nv">rad</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="nf">d</span><span class="p">(</span><span class="nv">mm</span><span class="p">)</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ<span class="w"> </span><span class="o">|</span>
<span class="o">|-------|-------|--------|-------|---|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">317</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₁<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">S1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">81</span><span class="w">    </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">192.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₂<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₃<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">E1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">168.5</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₄<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W0</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="o">-</span>π<span class="o">/</span><span class="mi">2</span><span class="w">   </span><span class="o">|</span><span class="w"> </span><span class="mi">400</span><span class="w">   </span><span class="o">|</span><span class="w"> </span>θ₅<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W1</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span>π<span class="o">/</span><span class="mi">2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mf">136.3</span><span class="w"> </span><span class="o">|</span><span class="w"> </span>θ₆<span class="w"> </span><span class="o">|</span>
<span class="o">|</span><span class="w"> </span><span class="nv">W2</span><span class="w">    </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">     </span><span class="o">|</span><span class="w"> </span><span class="mi">0</span><span class="w">      </span><span class="o">|</span><span class="w"> </span><span class="mf">133.75</span><span class="o">|</span><span class="w"> </span>θ₇<span class="w"> </span><span class="o">|</span>

正运动学变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="mi">0</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">prod</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="mi">7</span><span class="p">}</span><span class="w"> </span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}(</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="p">)$$</span>
其中每个关节变换矩阵：
<span class="p">$$</span><span class="nv">T</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">-</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">i</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">begin</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}</span>
\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="o">-</span>\<span class="nv">cos</span>\<span class="nv">theta</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">a</span>\<span class="nv">_i</span>\<span class="nv">sin</span>\<span class="nv">theta</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">sin</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span>\<span class="nv">cos</span>\<span class="nv">alpha</span>\<span class="nv">_i</span><span class="w"> </span>&amp;<span class="w"> </span><span class="nv">d</span>\<span class="nv">_i</span><span class="w"> </span>\\\\
<span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">0</span><span class="w"> </span>&amp;<span class="w"> </span><span class="mi">1</span>
\<span class="nv">end</span><span class="p">{</span><span class="nv">bmatrix</span><span class="p">}$$</span>
<span class="o">###</span><span class="w"> </span>关节控制器实现

关节控制器是机械臂控制的基础，包括位置控制、速度控制和力矩控制三种基本模式。

<span class="o">**</span>重力补偿计算<span class="o">**</span>：

重力补偿是机械臂控制的关键，特别是在低速运动和静态保持时：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_g</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">i</span><span class="o">=</span><span class="mi">1</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_i</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}(</span><span class="nv">q</span><span class="p">)$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">m</span>\<span class="nv">_i</span><span class="p">$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>的质量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">g</span><span class="p">$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span>\<span class="nv">_i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">c</span>\<span class="nv">_i</span><span class="p">}$</span><span class="w"> </span>是连杆<span class="w"> </span><span class="nv">i</span><span class="w"> </span>质心的线速度雅可比矩阵

<span class="o">###</span><span class="w"> </span>轨迹跟踪控制

轨迹控制器负责让机械臂沿着预定轨迹运动，需要处理位置、速度和加速度的协调控制。关键技术包括：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>三次样条插值<span class="o">**</span>：保证位置和速度连续性
<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>前馈控制<span class="o">**</span>：提高跟踪精度
<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>误差容限管理<span class="o">**</span>：判断轨迹执行成功与否

轨迹规划的约束条件：

<span class="o">-</span><span class="w"> </span>关节位置限制：<span class="p">$</span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">min</span><span class="p">}</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节速度限制：<span class="p">$</span><span class="o">|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>
<span class="o">-</span><span class="w"> </span>关节加加速度限制：<span class="p">$</span><span class="o">|</span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|</span><span class="w"> </span>\<span class="nv">leq</span><span class="w"> </span>\<span class="nv">dddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">max</span><span class="p">}$</span>

<span class="o">###</span><span class="w"> </span>力矩控制与动力学补偿

力矩控制提供最直接的控制方式，但需要精确的动力学模型：

动力学方程（拉格朗日形式）：
<span class="p">$$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span><span class="p">$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是惯性矩阵（对称正定）
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})$</span><span class="w"> </span>是科氏力和离心力矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$</span><span class="w"> </span>是重力向量
<span class="o">-</span><span class="w"> </span><span class="p">$</span>\<span class="nv">tau</span><span class="p">$</span><span class="w"> </span>是关节力矩

计算力矩控制律：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nf">M</span><span class="p">(</span><span class="nv">q</span><span class="p">)(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">C</span><span class="p">(</span><span class="nv">q</span><span class="p">,</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nf">G</span><span class="p">(</span><span class="nv">q</span><span class="p">)$$</span>
其中<span class="w"> </span><span class="p">$</span><span class="nv">e</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">q</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">q</span><span class="p">$</span><span class="w"> </span>是位置误差。

<span class="o">###</span><span class="w"> </span>关节空间阻抗控制

阻抗控制允许机械臂表现出期望的动态特性，适用于与环境交互的任务：

阻抗模型：
<span class="p">$$</span><span class="nv">M</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">D</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span><span class="nv">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
设计准则：

<span class="o">-</span><span class="w"> </span>低刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：柔顺接触，适合精密装配
<span class="o">-</span><span class="w"> </span>高刚度<span class="w"> </span><span class="p">$</span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">$</span>：精确位置控制
<span class="o">-</span><span class="w"> </span>适中阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="p">$</span>：避免振荡，临界阻尼<span class="w"> </span><span class="p">$</span><span class="nv">D</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span>\<span class="nv">sqrt</span><span class="p">{</span><span class="nv">M</span>\<span class="nv">_d</span><span class="w"> </span><span class="nv">K</span>\<span class="nv">_d</span><span class="p">}$</span>
<span class="o">##</span><span class="w"> </span><span class="mf">13.6</span><span class="w"> </span>产业案例研究：<span class="nv">Universal</span><span class="w"> </span><span class="nv">Robots</span><span class="w"> </span>力控与柔顺控制

<span class="nv">Universal</span><span class="w"> </span><span class="nf">Robots</span><span class="w"> </span><span class="p">(</span><span class="nv">UR</span><span class="p">)</span><span class="w"> </span>是协作机器人领域的领导者，其<span class="w"> </span><span class="nv">e</span><span class="o">-</span><span class="nv">Series</span><span class="w"> </span>机器人（<span class="nv">UR3e</span><span class="p">,</span><span class="w"> </span><span class="nv">UR5e</span><span class="p">,</span><span class="w"> </span><span class="nv">UR10e</span><span class="p">,</span><span class="w"> </span><span class="nv">UR16e</span>）在力控和柔顺控制方面的实现为工业界树立了标杆。本节深入分析<span class="w"> </span><span class="nv">UR</span><span class="w"> </span>机器人如何通过<span class="w"> </span><span class="nv">ros2_control</span><span class="w"> </span>实现安全、高效的人机协作。

<span class="o">###</span><span class="w"> </span><span class="nv">UR</span><span class="w"> </span>机器人架构分析

<span class="nv">UR</span><span class="w"> </span>机器人采用模块化设计，每个关节都是独立的智能单元：
</code></pre></div>

<p>UR 控制架构：
┌─────────────────────────────────────┐
│         主控制器 (Linux RT)           │
│  ┌─────────────┬──────────────────┐ │
│  │ Safety MCU  │  Control Thread   │ │
│  │  (双通道)    │   (125μs cycle)   │ │
│  └─────────────┴──────────────────┘ │
└─────────┬───────────────────────────┘
          │ EtherCAT (4kHz)
    ┌─────┴─────┬─────┬─────┬─────┬─────┐
    │Joint1│Joint2│Joint3│Joint4│Joint5│Joint6│
    └──────┴──────┴──────┴──────┴──────┴──────┘
      每个关节模块包含：</p>
<div class="codehilite"><pre><span></span><code>  - 伺服驱动器
  - 绝对编码器 (19-bit)
  - 力矩传感器
  - 温度传感器
  - 安全监控器
</code></pre></div>

<div class="codehilite"><pre><span></span><code>关键技术特性：

1. **双编码器系统**：
   <span class="k">-</span> 主编码器：19 位分辨率，用于精确控制
   <span class="k">-</span> 安全编码器：独立通道，用于安全监控

2. **分布式力矩感知**：
   <span class="k">-</span> 每个关节内置力矩传感器
   <span class="k">-</span> 采样率 4kHz，分辨率 0.01 Nm
   <span class="k">-</span> 用于碰撞检测和力控制

3. **功能安全设计**：
   <span class="k">-</span> 符合 ISO 13849-1 Cat. 3 PL d
   <span class="k">-</span> 双通道安全架构
   <span class="k">-</span> 安全速度和位置监控

<span class="gu">##</span># 力/力矩传感器集成

UR 机器人的力感知能力基于关节力矩传感器和动力学模型的融合：

**力矩估计算法**：
</code></pre></div>

<p>外力矩估计：
τ_ext = τ_measured - τ_model</p>
<p>其中：
τ_measured: 关节力矩传感器测量值
τ_model: 动力学模型计算值（包括重力、惯性、摩擦）</p>
<div class="codehilite"><pre><span></span><code>动力学模型辨识过程：

<span class="mi">1</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>质量参数辨识<span class="o">**</span>：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">sum</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">j</span><span class="o">=</span><span class="nv">i</span><span class="p">}</span><span class="o">^</span><span class="p">{</span><span class="nv">n</span><span class="p">}</span><span class="w"> </span><span class="p">(</span><span class="nv">I</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">j</span><span class="p">}</span><span class="w"> </span>\<span class="nv">ddot</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">m</span>\<span class="nv">_j</span><span class="w"> </span><span class="nv">g</span><span class="o">^</span><span class="nv">T</span><span class="w"> </span><span class="nv">J</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">v</span><span class="p">,</span><span class="nv">j</span><span class="p">})$$</span>
通过激励轨迹和最小二乘法辨识质量和质心位置

<span class="mi">2</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>摩擦模型辨识<span class="o">**</span>：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">friction</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_c</span><span class="w"> </span>\<span class="nv">cdot</span><span class="w"> </span><span class="nf">sign</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_v</span><span class="w"> </span>\<span class="nv">cdot</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_s</span><span class="w"> </span>\<span class="nv">cdot</span><span class="w"> </span><span class="nv">e</span><span class="o">^</span><span class="p">{</span><span class="o">-|</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span><span class="o">|/</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">q</span><span class="p">}</span>\<span class="nv">_s</span><span class="p">}$$</span>
包含库仑摩擦、粘性摩擦和<span class="w"> </span><span class="nv">Stribeck</span><span class="w"> </span>效应

<span class="mi">3</span><span class="o">.</span><span class="w"> </span><span class="o">**</span>温度补偿<span class="o">**</span>：
<span class="p">$$</span>\<span class="nv">tau</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">comp</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>\<span class="nv">tau</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">measured</span><span class="p">}</span><span class="w"> </span>\<span class="nf">cdot</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="w"> </span><span class="o">+</span><span class="w"> </span>\<span class="nv">alpha</span><span class="w"> </span>\<span class="nv">cdot</span><span class="w"> </span>\<span class="nv">Delta</span><span class="w"> </span><span class="nv">T</span><span class="p">)$$</span>
补偿温度对传感器和机械结构的影响

<span class="o">**</span>末端力估计<span class="o">**</span>：

从关节力矩到末端力的映射：
<span class="p">$$</span><span class="nv">F</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ee</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="nv">J</span><span class="o">^</span><span class="nv">T</span><span class="p">)</span><span class="o">^+</span><span class="w"> </span>\<span class="nv">tau</span>\<span class="nv">_</span><span class="p">{</span><span class="nv">ext</span><span class="p">}$$</span>
其中<span class="w"> </span><span class="p">$(</span><span class="nv">J</span><span class="o">^</span><span class="nv">T</span><span class="p">)</span><span class="o">^+</span><span class="p">$</span><span class="w"> </span>是雅可比转置的伪逆。

为提高估计精度，<span class="nv">UR</span><span class="w"> </span>采用卡尔曼滤波器：
</code></pre></div>

<p>状态方程：
x_k = A x_{k-1} + B u_k + w_k
y_k = C x_k + v_k</p>
<p>其中：
x: [F_ext, F_ext_dot]  (外力及其导数)
u: τ_measured - τ_model (力矩残差)
w, v: 过程噪声和测量噪声</p>
<div class="codehilite"><pre><span></span><code><span class="o">###</span><span class="w"> </span>柔顺控制算法实现

<span class="nv">UR</span><span class="w"> </span>的柔顺控制采用混合力<span class="o">/</span>位置控制架构：

<span class="o">**</span>选择矩阵方法<span class="o">**</span>：
<span class="p">$$</span>\<span class="nv">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">J</span><span class="o">^</span><span class="nf">T</span><span class="p">(</span><span class="nv">S</span>\<span class="nv">_f</span><span class="w"> </span><span class="nv">F</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">S</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_p</span><span class="p">(</span><span class="nv">x</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="nv">S</span>\<span class="nv">_p</span><span class="w"> </span><span class="nv">K</span>\<span class="nf">_d</span><span class="p">(</span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}</span>\<span class="nv">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>\<span class="k">do</span><span class="nv">t</span><span class="p">{</span><span class="nv">x</span><span class="p">}))$$</span>
其中：

<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">S</span>\<span class="nv">_f</span><span class="p">$</span>：力控制选择矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">S</span>\<span class="nv">_p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nv">I</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nv">S</span>\<span class="nv">_f</span><span class="p">$</span>：位置控制选择矩阵
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">F</span>\<span class="nv">_d</span><span class="p">$</span>：期望接触力
<span class="o">-</span><span class="w"> </span><span class="p">$</span><span class="nv">x</span>\<span class="nv">_d</span><span class="p">,</span><span class="w"> </span><span class="nv">x</span><span class="p">$</span>：期望和实际笛卡尔位置

<span class="o">**</span>自适应阻抗控制<span class="o">**</span>：

<span class="nv">UR</span><span class="w"> </span>实现了变刚度控制，根据任务需求动态调整阻抗参数：
</code></pre></div>

<p>阻抗参数调度：
         ┌─ 高刚度 (2000 N/m)：自由空间运动
K(t) = ──┼─ 中刚度 (500 N/m)：接近阶段
         └─ 低刚度 (100 N/m)：接触阶段</p>
<p>切换策略：
if |F_ext| &lt; F_threshold_1:
    K = K_high  # 自由空间
elif |F_ext| &lt; F_threshold_2:
    K = K_medium  # 过渡区
else:
    K = K_low  # 接触区</p>
<div class="codehilite"><pre><span></span><code><span class="gu">##</span># 安全性与碰撞检测

UR 的安全系统是多层次的，确保在各种故障模式下都能保证人员安全：

**碰撞检测算法**：

1. **基于模型的检测**：
</code></pre></div>

<p>碰撞指标：
r = |τ_ext| - τ_threshold</p>
<p>动态阈值：
τ_threshold = τ_base + k_vel * |q_dot| + k_acc * |q_ddot|</p>
<div class="codehilite"><pre><span></span><code><span class="mf">2.</span><span class="w"> </span><span class="o">**</span><span class="n">基于能量的检测</span><span class="o">**</span><span class="err">：</span>
</code></pre></div>

<p>碰撞能量：
E_collision = ∫ F_ext · v dt</p>
<p>触发条件：
if E_collision &gt; E_threshold:
    trigger_protective_stop()</p>
<div class="codehilite"><pre><span></span><code><span class="mf">3.</span><span class="w"> </span><span class="o">**</span><span class="n">频域分析</span><span class="o">**</span><span class="err">：</span>
<span class="w">   </span><span class="n">检测力矩信号的高频成分</span><span class="err">，</span><span class="n">识别碰撞特征</span>

<span class="o">**</span><span class="n">安全响应策略</span><span class="o">**</span><span class="err">：</span>
</code></pre></div>

<p>安全响应级别：
Level 0: 正常运行
Level 1: 降速运行 (速度限制到 250 mm/s)
Level 2: 保护停止 (零力矩，重力补偿)
Level 3: 紧急停止 (断电制动)</p>
<p>触发条件：</p>
<ul>
<li>Level 1: |F_ext| &gt; 100N 或接近速度/位置限制</li>
<li>Level 2: |F_ext| &gt; 150N 或碰撞检测触发</li>
<li>Level 3: 安全系统故障或急停按钮</li>
</ul>
<div class="codehilite"><pre><span></span><code>**ISO/TS 15066 合规性**：

UR 机器人符合协作机器人标准，实现四种协作模式：

1. **安全监控停止**：人员进入时停止
2. **手动引导**：直接手动操作
3. **速度和距离监控**：根据距离调整速度
4. **功率和力限制**：限制接触力和压强

生物力学限值（ISO/TS 15066）：
| 身体部位 | 准静态力 (N) | 瞬态力 (N) |

| 身体部位 | 准静态力 (N) | 瞬态力 (N) |
|---------|-------------|-----------|
| 头部    | 130         | 175       |
| 胸部    | 140         | 210       |
| 手臂    | 150         | 190       |
| 手部    | 140         | 180       |

<span class="gu">##</span># 实际应用案例

**案例1：精密装配**

汽车零部件装配，公差 ±0.05mm：
</code></pre></div>

<p>控制策略：</p>
<ol>
<li>快速接近：位置控制，v=250mm/s</li>
<li>搜索接触：速度控制，v=10mm/s，监测 Fz</li>
<li>对准插入：混合力/位控制
   - X,Y: 位置控制，刚度 500 N/m
   - Z: 力控制，Fz = 10N
   - Rx,Ry: 柔顺，刚度 5 Nm/rad</li>
<li>完全插入：力控制，Fz = 30N</li>
</ol>
<div class="codehilite"><pre><span></span><code>成功率：99.5%，周期时间：3.2秒

**案例2：打磨抛光**

曲面打磨，恒定接触力 20N：
</code></pre></div>

<p>控制参数：</p>
<ul>
<li>法向力控制：Fn = 20 ± 2N</li>
<li>切向速度：v = 100 mm/s</li>
<li>阻抗参数：</li>
<li>Kn = 100 N/m (法向低刚度)</li>
<li>Kt = 1000 N/m (切向高刚度)</li>
</ul>
<div class="codehilite"><pre><span></span><code>表面粗糙度：Ra &lt; 0.8μm，力控制精度：±1.5N

<span class="gu">##</span> 13.7 高级话题

ros2_control 的前沿研究和工业实践不断推动着机器人控制技术的发展。本节探讨 EtherCAT 总线集成、硬实时控制、多机器人同步等高级主题。

<span class="gu">##</span># EtherCAT 总线集成

EtherCAT (Ethernet for Control Automation Technology) 是工业机器人中最广泛使用的实时以太网协议，提供微秒级的控制周期和纳秒级的同步精度。

**EtherCAT 架构**：
</code></pre></div>

<p>EtherCAT 拓扑：
Master (IPC) ──┬── Slave 1 (Joint 1) 
               ├── Slave 2 (Joint 2)
               ├── Slave 3 (Joint 3)
               ├── Slave 4 (I/O Module)
               └── Slave 5 (Force Sensor)</p>
<p>通信特性：</p>
<ul>
<li>周期时间：125 μs - 1 ms</li>
<li>抖动：&lt; 1 μs</li>
<li>同步精度：&lt; 100 ns (with DC)</li>
<li>最大节点数：65535</li>
<li>传输效率：&gt; 90%</li>
</ul>
<div class="codehilite"><pre><span></span><code><span class="o">**</span><span class="nx">SOEM</span><span class="w"> </span><span class="nx">集成</span><span class="err">（</span><span class="nx">Simple</span><span class="w"> </span><span class="nx">Open</span><span class="w"> </span><span class="nx">EtherCAT</span><span class="w"> </span><span class="nx">Master</span><span class="err">）</span><span class="o">**</span><span class="err">：</span>

<span class="err">```</span><span class="nx">cpp</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">EtherCATHardware</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="nx">public</span><span class="w"> </span><span class="nx">hardware_interface</span><span class="o">::</span><span class="nx">SystemInterface</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="p">:</span>
<span class="w">  </span><span class="c1">// EtherCAT 上下文</span>
<span class="w">  </span><span class="nx">ecx_contextt</span><span class="o">*</span><span class="w"> </span><span class="nx">ec_context_</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// 从站配置</span>
<span class="w">  </span><span class="nx">struct</span><span class="w"> </span><span class="nx">SlaveConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">uint16_t</span><span class="w"> </span><span class="kd">alias</span><span class="p">;</span>
<span class="w">    </span><span class="nx">uint16_t</span><span class="w"> </span><span class="nx">position</span><span class="p">;</span>
<span class="w">    </span><span class="nx">uint32_t</span><span class="w"> </span><span class="nx">vendor_id</span><span class="p">;</span>
<span class="w">    </span><span class="nx">uint32_t</span><span class="w"> </span><span class="nx">product_code</span><span class="p">;</span>
<span class="w">    </span><span class="nx">ec_slave</span><span class="o">*</span><span class="w"> </span><span class="nx">slave</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="nx">std</span><span class="o">::</span><span class="nx">vector</span><span class="p">&lt;</span><span class="nx">SlaveConfig</span><span class="p">&gt;</span><span class="w"> </span><span class="nx">slaves_</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// PDO 映射</span>
<span class="w">  </span><span class="nx">struct</span><span class="w"> </span><span class="nx">PDOMapping</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="nx">inputs</span><span class="p">;</span>
<span class="w">    </span><span class="nx">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="nx">outputs</span><span class="p">;</span>
<span class="w">    </span><span class="nx">size_t</span><span class="w"> </span><span class="nx">input_size</span><span class="p">;</span>
<span class="w">    </span><span class="nx">size_t</span><span class="w"> </span><span class="nx">output_size</span><span class="p">;</span>
<span class="w">  </span><span class="p">};</span>
<span class="w">  </span><span class="nx">std</span><span class="o">::</span><span class="nx">vector</span><span class="p">&lt;</span><span class="nx">PDOMapping</span><span class="p">&gt;</span><span class="w"> </span><span class="nx">pdo_mappings_</span><span class="p">;</span>

<span class="nx">public</span><span class="p">:</span>
<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="nx">configure_ethercat</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 初始化 SOEM</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">ec_init</span><span class="p">(</span><span class="nx">interface_name_</span><span class="p">.</span><span class="nx">c_str</span><span class="p">())</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 配置从站</span>
<span class="w">    </span><span class="nx">int</span><span class="w"> </span><span class="nx">slave_count</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ec_config_init</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 配置分布式时钟</span>
<span class="w">    </span><span class="nx">ec_configdc</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// PDO 映射</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nx">int</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="nx">slave_count</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">configure_slave_pdo</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 切换到安全操作状态</span>
<span class="w">    </span><span class="nx">ec_slave</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">state</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">EC_STATE_SAFE_OP</span><span class="p">;</span>
<span class="w">    </span><span class="nx">ec_writestate</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 启动周期性数据交换</span>
<span class="w">    </span><span class="nx">ec_slave</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">state</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">EC_STATE_OPERATIONAL</span><span class="p">;</span>
<span class="w">    </span><span class="nx">ec_writestate</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">return_type</span><span class="w"> </span><span class="nx">read</span><span class="p">(</span><span class="nx">const</span><span class="w"> </span><span class="nx">rclcpp</span><span class="o">::</span><span class="nx">Time</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">time</span><span class="p">,</span><span class="w"> </span><span class="nx">const</span><span class="w"> </span><span class="nx">rclcpp</span><span class="o">::</span><span class="nx">Duration</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">period</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 发送过程数据</span>
<span class="w">    </span><span class="nx">ec_send_processdata</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 接收过程数据</span>
<span class="w">    </span><span class="nx">int</span><span class="w"> </span><span class="nx">wkc</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="nx">ec_receive_processdata</span><span class="p">(</span><span class="nx">EC_TIMEOUTRET</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="nx">wkc</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="nx">ec_slave</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">expectedWKC</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="c1">// 解析输入数据</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nx">size_t</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">slaves_</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">parse_slave_inputs</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">return_type</span><span class="o">::</span><span class="nx">OK</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="nx">return_type</span><span class="w"> </span><span class="nx">write</span><span class="p">(</span><span class="nx">const</span><span class="w"> </span><span class="nx">rclcpp</span><span class="o">::</span><span class="nx">Time</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">time</span><span class="p">,</span><span class="w"> </span><span class="nx">const</span><span class="w"> </span><span class="nx">rclcpp</span><span class="o">::</span><span class="nx">Duration</span><span class="w"> </span><span class="o">&amp;</span><span class="w"> </span><span class="nx">period</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 准备输出数据</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="nx">size_t</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="nx">i</span><span class="w"> </span><span class="p">&lt;</span><span class="w"> </span><span class="nx">slaves_</span><span class="p">.</span><span class="nx">size</span><span class="p">();</span><span class="w"> </span><span class="nx">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="nx">prepare_slave_outputs</span><span class="p">(</span><span class="nx">i</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="nx">return_type</span><span class="o">::</span><span class="nx">OK</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>分布式时钟同步</strong>：</p>
<p>EtherCAT 的分布式时钟（DC）实现纳秒级同步：</p>
<div class="codehilite"><pre><span></span><code>DC 同步过程：

1. 主站广播 SYNC0 信号
2. 从站锁定本地时钟到 SYNC0
3. 补偿传播延迟
4. 实现全局时间同步

时间戳计算：
T_global = T_local + Offset + Drift * t
</code></pre></div>

<h3 id="_101">硬实时控制策略</h3>
<p>硬实时控制要求系统在确定的时间内完成任务，任何延迟都可能导致系统失败。</p>
<p><strong>RT_PREEMPT 内核配置</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 内核配置选项</span>
<span class="nv">CONFIG_PREEMPT_RT</span><span class="o">=</span>y
<span class="nv">CONFIG_HIGH_RES_TIMERS</span><span class="o">=</span>y
<span class="nv">CONFIG_NO_HZ_FULL</span><span class="o">=</span>y
<span class="nv">CONFIG_HZ_1000</span><span class="o">=</span>y

<span class="c1"># CPU 隔离</span>
<span class="nv">isolcpus</span><span class="o">=</span><span class="m">2</span>,3<span class="w"> </span><span class="nv">nohz_full</span><span class="o">=</span><span class="m">2</span>,3<span class="w"> </span><span class="nv">rcu_nocbs</span><span class="o">=</span><span class="m">2</span>,3

<span class="c1"># IRQ 亲和性</span>
<span class="nb">echo</span><span class="w"> </span><span class="m">2</span><span class="w"> </span>&gt;<span class="w"> </span>/proc/irq/24/smp_affinity<span class="w">  </span><span class="c1"># 网卡中断绑定到 CPU2</span>
</code></pre></div>

<p><strong>实时调度策略</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">RealtimeController</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">configure_realtime</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 设置调度策略</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_param</span><span class="w"> </span><span class="n">param</span><span class="p">;</span>
<span class="w">    </span><span class="n">param</span><span class="p">.</span><span class="n">sched_priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">49</span><span class="p">;</span><span class="w">  </span><span class="c1">// RT 优先级</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pthread_setschedparam</span><span class="p">(</span><span class="n">pthread_self</span><span class="p">(),</span><span class="w"> </span><span class="n">SCHED_FIFO</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">param</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Failed to set realtime priority&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 内存锁定</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mlockall</span><span class="p">(</span><span class="n">MCL_CURRENT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MCL_FUTURE</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;Failed to lock memory&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 预分配堆栈</span>
<span class="w">    </span><span class="n">stack_prefault</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// CPU 亲和性</span>
<span class="w">    </span><span class="kt">cpu_set_t</span><span class="w"> </span><span class="n">cpuset</span><span class="p">;</span>
<span class="w">    </span><span class="n">CPU_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="w">    </span><span class="n">CPU_SET</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span><span class="w">  </span><span class="c1">// 绑定到隔离的 CPU3</span>
<span class="w">    </span><span class="n">pthread_setaffinity_np</span><span class="p">(</span><span class="n">pthread_self</span><span class="p">(),</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">cpuset</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">stack_prefault</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">dummy</span><span class="p">[</span><span class="n">MAX_STACK_SIZE</span><span class="p">];</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">MAX_STACK_SIZE</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>WCET 分析（最坏执行时间）</strong>：</p>
<div class="codehilite"><pre><span></span><code>控制循环 WCET 分解：
┌─────────────────────────────────┐
│ 硬件读取        │  50 μs │ 5%  │
│ 传感器融合      │ 100 μs │ 10% │
│ 轨迹插值        │  80 μs │ 8%  │
│ 逆运动学        │ 150 μs │ 15% │
│ 控制器计算      │ 200 μs │ 20% │
│ 动力学补偿      │ 180 μs │ 18% │
│ 安全检查        │  40 μs │ 4%  │
│ 硬件写入        │  50 μs │ 5%  │
│ 通信开销        │ 150 μs │ 15% │
├─────────────────────────────────┤
│ 总 WCET         │1000 μs │100% │
└─────────────────────────────────┘
</code></pre></div>

<h3 id="_102">多机器人同步控制</h3>
<p>多机器人协作需要精确的时间同步和协调控制：</p>
<p><strong>时间同步协议</strong>：</p>
<ol>
<li><strong>PTP (IEEE 1588) 精确时间协议</strong>：</li>
</ol>
<div class="codehilite"><pre><span></span><code>同步精度：&lt; 1 μs

PTP 消息序列：
Master → Slave: Sync (t1)
Master → Slave: Follow_Up (t1)
Slave → Master: Delay_Req (t2)
Master → Slave: Delay_Resp (t3, t4)

时钟偏移计算：
Offset = ((t2-t1) - (t4-t3)) / 2
</code></pre></div>

<ol start="2">
<li><strong>DDS 时间同步</strong>：</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MultiRobotSync</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">setup_dds_qos</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 配置时间同步 QoS</span>
<span class="w">    </span><span class="n">dds</span><span class="o">::</span><span class="n">core</span><span class="o">::</span><span class="n">policy</span><span class="o">::</span><span class="n">DestinationOrder</span><span class="w"> </span><span class="n">order</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">      </span><span class="n">dds</span><span class="o">::</span><span class="n">core</span><span class="o">::</span><span class="n">policy</span><span class="o">::</span><span class="n">DestinationOrder</span><span class="o">::</span><span class="n">BySourceTimestamp</span><span class="p">();</span>

<span class="w">    </span><span class="n">dds</span><span class="o">::</span><span class="n">core</span><span class="o">::</span><span class="n">policy</span><span class="o">::</span><span class="n">History</span><span class="w"> </span><span class="n">history</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">      </span><span class="n">dds</span><span class="o">::</span><span class="n">core</span><span class="o">::</span><span class="n">policy</span><span class="o">::</span><span class="n">History</span><span class="o">::</span><span class="n">KeepLast</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

<span class="w">    </span><span class="n">dds</span><span class="o">::</span><span class="n">core</span><span class="o">::</span><span class="n">policy</span><span class="o">::</span><span class="n">Reliability</span><span class="w"> </span><span class="n">reliability</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">      </span><span class="n">dds</span><span class="o">::</span><span class="n">core</span><span class="o">::</span><span class="n">policy</span><span class="o">::</span><span class="n">Reliability</span><span class="o">::</span><span class="n">Reliable</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>协调控制架构</strong>：</p>
<div class="codehilite"><pre><span></span><code>多机器人控制架构：
┌─────────────────────────────────────┐
│      协调控制器 (Coordinator)        │
│   ┌──────────┬──────────────────┐   │
│   │任务分配器│ 同步管理器        │   │
│   └──────────┴──────────────────┘   │
└───────┬──────────┬──────────┬───────┘
        │          │          │
   ┌────▼───┐ ┌───▼────┐ ┌───▼────┐
   │Robot 1 │ │Robot 2 │ │Robot 3 │
   └────────┘ └────────┘ └────────┘
</code></pre></div>

<p><strong>同步运动控制</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SynchronizedMotionController</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="c1">// 同步屏障</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">barrier</span><span class="w"> </span><span class="n">sync_barrier_</span><span class="p">;</span>

<span class="w">  </span><span class="c1">// 共享轨迹时钟</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">global_time_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="n">synchronized_update</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// Phase 1: 本地计算</span>
<span class="w">    </span><span class="n">compute_local_trajectory</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 同步点 1：等待所有机器人完成计算</span>
<span class="w">    </span><span class="n">sync_barrier_</span><span class="p">.</span><span class="n">arrive_and_wait</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Phase 2: 交换状态信息</span>
<span class="w">    </span><span class="n">broadcast_state</span><span class="p">();</span>
<span class="w">    </span><span class="n">receive_neighbor_states</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 同步点 2：等待状态交换完成</span>
<span class="w">    </span><span class="n">sync_barrier_</span><span class="p">.</span><span class="n">arrive_and_wait</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// Phase 3: 协调控制</span>
<span class="w">    </span><span class="n">compute_coordinated_control</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 同步点 3：同时执行</span>
<span class="w">    </span><span class="n">sync_barrier_</span><span class="p">.</span><span class="n">arrive_and_wait</span><span class="p">();</span>
<span class="w">    </span><span class="n">execute_control</span><span class="p">();</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="_103">论文导读与开源项目</h3>
<p><strong>关键论文</strong>：</p>
<ol>
<li>
<p><strong>"Real-Time Control of Industrial Robots Using EtherCAT"</strong> (2019)
   - 作者：Delgado et al.
   - 贡献：EtherCAT 在工业机器人中的最佳实践
   - 关键点：分布式时钟同步、确定性通信</p>
</li>
<li>
<p><strong>"Adaptive Impedance Control for Human-Robot Collaboration"</strong> (2021)
   - 作者：Wang et al.
   - 贡献：基于学习的自适应阻抗参数调整
   - 关键点：在线参数优化、安全约束</p>
</li>
<li>
<p><strong>"Multi-Robot Coordination with ros2_control"</strong> (2022)
   - 作者：Kim et al.
   - 贡献：分布式 ros2_control 架构
   - 关键点：时间同步、容错机制</p>
</li>
</ol>
<p><strong>开源项目推荐</strong>：</p>
<ol>
<li>
<p><strong>ros2_control</strong>
   - GitHub: ros-controls/ros2_control
   - 特点：官方控制框架</p>
</li>
<li>
<p><strong>EtherCAT for ROS2</strong>
   - GitHub: ICube-Robotics/ethercat_driver_ros2
   - 特点：完整的 EtherCAT 集成</p>
</li>
<li>
<p><strong>RT_ROS2</strong>
   - GitHub: ros-realtime/rt-kernel-docker-builder
   - 特点：实时内核构建工具</p>
</li>
<li>
<p><strong>Universal_Robots_ROS2_Driver</strong>
   - GitHub: UniversalRobots/Universal_Robots_ROS2_Driver
   - 特点：UR 机器人官方驱动</p>
</li>
</ol>
<h3 id="_104">性能极限优化技巧</h3>
<p><strong>1. 零拷贝通信</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 使用共享内存避免数据拷贝</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ZeroCopyPublisher</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">void</span><span class="w"> </span><span class="nf">publish_zero_copy</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">auto</span><span class="w"> </span><span class="n">loan</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">publisher_</span><span class="o">-&gt;</span><span class="n">borrow_loaned_message</span><span class="p">();</span>
<span class="w">    </span><span class="c1">// 直接写入借用的消息</span>
<span class="w">    </span><span class="n">fill_message</span><span class="p">(</span><span class="o">*</span><span class="n">loan</span><span class="p">);</span>
<span class="w">    </span><span class="n">publisher_</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">loan</span><span class="p">));</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>2. SIMD 优化</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 使用 AVX2 加速矩阵运算</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">matrix_multiply_avx2</span><span class="p">(</span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">C</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">A</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">float</span><span class="o">*</span><span class="w"> </span><span class="n">B</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">8</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">__m256</span><span class="w"> </span><span class="n">row</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_load_ps</span><span class="p">(</span><span class="o">&amp;</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="n">__m256</span><span class="w"> </span><span class="n">col</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_load_ps</span><span class="p">(</span><span class="o">&amp;</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="n">__m256</span><span class="w"> </span><span class="n">prod</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">_mm256_mul_ps</span><span class="p">(</span><span class="n">row</span><span class="p">,</span><span class="w"> </span><span class="n">col</span><span class="p">);</span>
<span class="w">    </span><span class="n">_mm256_store_ps</span><span class="p">(</span><span class="o">&amp;</span><span class="n">C</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="w"> </span><span class="n">prod</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>3. 缓存优化</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 数据布局优化，提高缓存命中率</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">alignas</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="n">JointData</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 缓存行对齐</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">position</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">velocity</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">effort</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">command</span><span class="p">;</span>
<span class="w">  </span><span class="kt">char</span><span class="w"> </span><span class="n">padding</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span><span class="w">  </span><span class="c1">// 避免伪共享</span>
<span class="p">};</span>
<span class="err">```##</span><span class="w"> </span><span class="mf">13.8</span><span class="w"> </span><span class="n">本章小结</span>

<span class="n">本章深入探讨了</span><span class="w"> </span><span class="n">ros2_control</span><span class="w"> </span><span class="n">框架的核心概念和实现细节</span><span class="err">。</span><span class="n">ros2_control</span><span class="w"> </span><span class="n">作为</span><span class="w"> </span><span class="n">ROS2</span><span class="w"> </span><span class="n">中机器人控制的基石</span><span class="err">，</span><span class="n">提供了从硬件抽象到高级控制算法的完整解决方案</span><span class="err">。</span>

<span class="cp">### 关键概念回顾</span>

<span class="mf">1.</span><span class="w"> </span><span class="o">**</span><span class="n">硬件抽象层</span><span class="o">**</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Hardware</span><span class="w"> </span><span class="n">Interface</span><span class="w"> </span><span class="n">提供统一的硬件访问接口</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">Resource</span><span class="w"> </span><span class="n">Manager</span><span class="w"> </span><span class="n">管理硬件资源的分配和访问权限</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">生命周期管理确保硬件状态的可控转换</span>

<span class="mf">2.</span><span class="w"> </span><span class="o">**</span><span class="n">控制器架构</span><span class="o">**</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">控制器链支持模块化的控制策略组合</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">实时执行保证确定性的控制性能</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">动态加载和切换适应不同的控制需求</span>

<span class="mf">3.</span><span class="w"> </span><span class="o">**</span><span class="n">实时控制</span><span class="o">**</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">实时内核和调度策略保证微秒级控制周期</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">内存预分配和锁定避免运行时延迟</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">WCET</span><span class="w"> </span><span class="n">分析确保时间约束满足</span>

<span class="mf">4.</span><span class="w"> </span><span class="o">**</span><span class="n">高级控制算法</span><span class="o">**</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">计算力矩控制实现精确的动力学补偿</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">阻抗控制提供柔顺的环境交互能力</span>
<span class="w">   </span><span class="o">-</span><span class="w"> </span><span class="n">力控制实现精确的接触力调节</span>

<span class="cp">### 核心公式总结</span>

<span class="o">**</span><span class="n">动力学方程</span><span class="o">**</span><span class="err">：</span>
<span class="n">$$M</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="err">\</span><span class="n">ddot</span><span class="p">{</span><span class="n">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">C</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="err">\</span><span class="n">dot</span><span class="p">{</span><span class="n">q</span><span class="p">})</span><span class="err">\</span><span class="n">dot</span><span class="p">{</span><span class="n">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">G</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="n">tau$$</span>
<span class="o">**</span><span class="n">计算力矩控制律</span><span class="o">**</span><span class="err">：</span>
<span class="n">$$</span><span class="err">\</span><span class="n">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">(</span><span class="n">q</span><span class="p">)(</span><span class="err">\</span><span class="n">ddot</span><span class="p">{</span><span class="n">q</span><span class="p">}</span><span class="err">\</span><span class="n">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K</span><span class="err">\</span><span class="n">_p</span><span class="w"> </span><span class="n">e</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K</span><span class="err">\</span><span class="n">_d</span><span class="w"> </span><span class="err">\</span><span class="n">dot</span><span class="p">{</span><span class="n">e</span><span class="p">})</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">C</span><span class="p">(</span><span class="n">q</span><span class="p">,</span><span class="err">\</span><span class="n">dot</span><span class="p">{</span><span class="n">q</span><span class="p">})</span><span class="err">\</span><span class="n">dot</span><span class="p">{</span><span class="n">q</span><span class="p">}</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">G</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="n">$$</span>
<span class="o">**</span><span class="n">阻抗控制模型</span><span class="o">**</span><span class="err">：</span>
<span class="n">$$M</span><span class="err">\</span><span class="n">_d</span><span class="p">(</span><span class="err">\</span><span class="n">ddot</span><span class="p">{</span><span class="n">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">\</span><span class="n">ddot</span><span class="p">{</span><span class="n">x</span><span class="p">}</span><span class="err">\</span><span class="n">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">D</span><span class="err">\</span><span class="n">_d</span><span class="p">(</span><span class="err">\</span><span class="n">dot</span><span class="p">{</span><span class="n">x</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">\</span><span class="n">dot</span><span class="p">{</span><span class="n">x</span><span class="p">}</span><span class="err">\</span><span class="n">_d</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">K</span><span class="err">\</span><span class="n">_d</span><span class="p">(</span><span class="n">x</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x</span><span class="err">\</span><span class="n">_d</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">F</span><span class="err">\</span><span class="n">_</span><span class="p">{</span><span class="n">ext</span><span class="p">}</span><span class="n">$$</span>
<span class="o">**</span><span class="n">外力估计</span><span class="o">**</span><span class="err">：</span>
<span class="n">$$</span><span class="err">\</span><span class="n">tau</span><span class="err">\</span><span class="n">_</span><span class="p">{</span><span class="n">ext</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="err">\</span><span class="n">tau</span><span class="err">\</span><span class="n">_</span><span class="p">{</span><span class="n">measured</span><span class="p">}</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">\</span><span class="n">tau</span><span class="err">\</span><span class="n">_</span><span class="p">{</span><span class="n">model</span><span class="p">}</span><span class="n">$$</span>
<span class="n">$$F</span><span class="err">\</span><span class="n">_</span><span class="p">{</span><span class="n">ee</span><span class="p">}</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">J</span><span class="o">^</span><span class="n">T</span><span class="p">)</span><span class="o">^+</span><span class="w"> </span><span class="err">\</span><span class="n">tau</span><span class="err">\</span><span class="n">_</span><span class="p">{</span><span class="n">ext</span><span class="p">}</span><span class="n">$$</span>
<span class="o">**</span><span class="n">混合力</span><span class="o">/</span><span class="n">位置控制</span><span class="o">**</span><span class="err">：</span>
<span class="n">$$</span><span class="err">\</span><span class="n">tau</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">J</span><span class="o">^</span><span class="n">T</span><span class="p">(</span><span class="n">S</span><span class="err">\</span><span class="n">_f</span><span class="w"> </span><span class="n">F</span><span class="err">\</span><span class="n">_d</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">S</span><span class="err">\</span><span class="n">_p</span><span class="w"> </span><span class="n">K</span><span class="err">\</span><span class="n">_p</span><span class="p">(</span><span class="n">x</span><span class="err">\</span><span class="n">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">x</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">S</span><span class="err">\</span><span class="n">_p</span><span class="w"> </span><span class="n">K</span><span class="err">\</span><span class="n">_d</span><span class="p">(</span><span class="err">\</span><span class="n">dot</span><span class="p">{</span><span class="n">x</span><span class="p">}</span><span class="err">\</span><span class="n">_d</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="err">\</span><span class="n">dot</span><span class="p">{</span><span class="n">x</span><span class="p">}))</span><span class="n">$$</span>

<span class="cp">### 设计模式与最佳实践</span>

<span class="mf">1.</span><span class="w"> </span><span class="o">**</span><span class="n">分层设计</span><span class="o">**</span><span class="err">：</span><span class="n">硬件层</span><span class="err">、</span><span class="n">控制层</span><span class="err">、</span><span class="n">应用层清晰分离</span>
<span class="mf">2.</span><span class="w"> </span><span class="o">**</span><span class="n">组件化架构</span><span class="o">**</span><span class="err">：</span><span class="n">控制器作为独立组件</span><span class="err">，</span><span class="n">支持热插拔</span>
<span class="mf">3.</span><span class="w"> </span><span class="o">**</span><span class="n">实时优先</span><span class="o">**</span><span class="err">：</span><span class="n">关键路径上避免动态内存分配和系统调用</span>
<span class="mf">4.</span><span class="w"> </span><span class="o">**</span><span class="n">安全第一</span><span class="o">**</span><span class="err">：</span><span class="n">多层次的安全机制</span><span class="err">，</span><span class="n">包括硬件</span><span class="err">、</span><span class="n">软件和算法层面</span>
<span class="mf">5.</span><span class="w"> </span><span class="o">**</span><span class="n">标准化接口</span><span class="o">**</span><span class="err">：</span><span class="n">遵循</span><span class="w"> </span><span class="n">ros2_control</span><span class="w"> </span><span class="n">标准</span><span class="err">，</span><span class="n">确保组件互操作性</span>

<span class="cp">## 13.9 练习题</span>

<span class="cp">### 基础题</span>

<span class="o">**</span><span class="n">练习</span><span class="w"> </span><span class="mf">13.1</span><span class="o">**</span><span class="err">：</span><span class="n">硬件接口设计</span>
<span class="n">设计一个</span><span class="w"> </span><span class="mi">2</span><span class="o">-</span><span class="n">DOF</span><span class="w"> </span><span class="n">平面机械臂的硬件接口</span><span class="err">，</span><span class="n">要求支持位置和速度两种控制模式</span><span class="err">。</span><span class="n">列出需要导出的状态接口和命令接口</span><span class="err">。</span>

<span class="o">*</span><span class="n">提示</span><span class="o">*</span><span class="err">：</span><span class="n">考虑每个关节需要的传感器数据和控制命令类型</span><span class="err">。</span>

<span class="o">&lt;</span><span class="n">details</span><span class="w"> </span><span class="n">markdown</span><span class="o">=</span><span class="s">&quot;1&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">summary</span><span class="o">&gt;</span><span class="n">答案</span><span class="o">&lt;/</span><span class="n">summary</span><span class="o">&gt;</span>

<span class="n">硬件接口设计</span><span class="err">：</span>

<span class="n">状态接口</span><span class="err">（</span><span class="n">State</span><span class="w"> </span><span class="n">Interfaces</span><span class="err">）：</span>

<span class="o">-</span><span class="w"> </span><span class="n">joint1</span><span class="o">/</span><span class="n">position</span><span class="err">：</span><span class="n">关节1位置反馈</span>
<span class="o">-</span><span class="w"> </span><span class="n">joint1</span><span class="o">/</span><span class="n">velocity</span><span class="err">：</span><span class="n">关节1速度反馈</span><span class="w">  </span>
<span class="o">-</span><span class="w"> </span><span class="n">joint1</span><span class="o">/</span><span class="n">effort</span><span class="err">：</span><span class="n">关节1力矩反馈</span>
<span class="o">-</span><span class="w"> </span><span class="n">joint2</span><span class="o">/</span><span class="n">position</span><span class="err">：</span><span class="n">关节2位置反馈</span>
<span class="o">-</span><span class="w"> </span><span class="n">joint2</span><span class="o">/</span><span class="n">velocity</span><span class="err">：</span><span class="n">关节2速度反馈</span>
<span class="o">-</span><span class="w"> </span><span class="n">joint2</span><span class="o">/</span><span class="n">effort</span><span class="err">：</span><span class="n">关节2力矩反馈</span>

<span class="n">命令接口</span><span class="err">（</span><span class="n">Command</span><span class="w"> </span><span class="n">Interfaces</span><span class="err">）：</span>

<span class="o">-</span><span class="w"> </span><span class="n">joint1</span><span class="o">/</span><span class="n">position</span><span class="err">：</span><span class="n">关节1位置命令</span>
<span class="o">-</span><span class="w"> </span><span class="n">joint1</span><span class="o">/</span><span class="n">velocity</span><span class="err">：</span><span class="n">关节1速度命令</span>
<span class="o">-</span><span class="w"> </span><span class="n">joint2</span><span class="o">/</span><span class="n">position</span><span class="err">：</span><span class="n">关节2位置命令</span>
<span class="o">-</span><span class="w"> </span><span class="n">joint2</span><span class="o">/</span><span class="n">velocity</span><span class="err">：</span><span class="n">关节2速度命令</span>

<span class="n">配置文件示例</span><span class="err">：</span>
<span class="err">```</span><span class="n">xml</span>
<span class="o">&lt;</span><span class="n">ros2_control</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;Planar2DOF&quot;</span><span class="w"> </span><span class="n">type</span><span class="o">=</span><span class="s">&quot;system&quot;</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">joint</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;joint1&quot;</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">command_interface</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;position&quot;</span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">command_interface</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;velocity&quot;</span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">state_interface</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;position&quot;</span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">state_interface</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;velocity&quot;</span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">state_interface</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;effort&quot;</span><span class="o">/&gt;</span>
<span class="w">  </span><span class="o">&lt;/</span><span class="n">joint</span><span class="o">&gt;</span>
<span class="w">  </span><span class="o">&lt;</span><span class="n">joint</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;joint2&quot;</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">command_interface</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;position&quot;</span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">command_interface</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;velocity&quot;</span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">state_interface</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;position&quot;</span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">state_interface</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;velocity&quot;</span><span class="o">/&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">state_interface</span><span class="w"> </span><span class="n">name</span><span class="o">=</span><span class="s">&quot;effort&quot;</span><span class="o">/&gt;</span>
<span class="w">  </span><span class="o">&lt;/</span><span class="n">joint</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">ros2_control</span><span class="o">&gt;</span>
</code></pre></div>

</details>
<p><strong>练习 13.2</strong>：控制周期计算
一个 6-DOF 机械臂的控制器需要执行以下操作：</p>
<ul>
<li>硬件读取：80 μs</li>
<li>运动学计算：200 μs</li>
<li>控制算法：150 μs</li>
<li>硬件写入：70 μs</li>
</ul>
<p>问：(a) 最小可行的控制周期是多少？(b) 为保证 20% 的安全裕度，应该设置多大的控制周期？</p>
<p><em>提示</em>：考虑 WCET 和系统抖动。</p>
<details>
<summary>答案</summary>
<p>(a) 最小可行控制周期：
总执行时间 = 80 + 200 + 150 + 70 = 500 μs</p>
<p>理论最小周期 = 500 μs</p>
<p>(b) 带安全裕度的控制周期：
安全裕度 20% 意味着实际执行时间应占周期的 80%
控制周期 = 500 / 0.8 = 625 μs</p>
<p>实践中通常选择标准频率：</p>
<ul>
<li>可选择 1000 Hz (1000 μs 周期)，提供 50% 裕度</li>
<li>或选择 2000 Hz (500 μs 周期)，需要优化代码</li>
</ul>
<p>建议：选择 1000 Hz，提供充足的裕度应对抖动和意外延迟。</p>
</details>
<p><strong>练习 13.3</strong>：重力补偿
一个 3-DOF 机械臂，连杆质量分别为 m₁=2kg, m₂=1.5kg, m₃=1kg，连杆长度 l₁=0.3m, l₂=0.25m, l₃=0.2m。当机械臂处于 q=[0°, 90°, 0°] 时，计算第二个关节的重力矩。假设重力 g=9.81 m/s²。</p>
<p><em>提示</em>：使用递归牛顿-欧拉方法或拉格朗日方法。</p>
<details>
<summary>答案</summary>
<p>第二关节重力矩计算：</p>
<p>关节2需要支撑连杆2和连杆3的重量：</p>
<p>τ₂ = m₂ * g * (l₂/2) * cos(q₂) + m₃ * g * (l₂ * cos(q₂) + l₃/2 * cos(q₂+q₃))</p>
<p>代入数值：</p>
<ul>
<li>q₂ = 90° = π/2, cos(90°) = 0</li>
<li>q₃ = 0°, q₂+q₃ = 90°, cos(90°) = 0</li>
</ul>
<p>τ₂ = 1.5 * 9.81 * (0.25/2) * 0 + 1.0 * 9.81 * (0.25 * 0 + 0.2/2 * 0)
τ₂ = 0 Nm</p>
<p>当第二关节处于90°时，重力方向与关节轴平行，不产生力矩。</p>
<p>如果 q₂ = 45°：
τ₂ = 1.5 * 9.81 * 0.125 * 0.707 + 1.0 * 9.81 * (0.25 * 0.707 + 0.1 * 0.707)
τ₂ = 1.30 + 2.43 = 3.73 Nm</p>
</details>
<h3 id="_105">挑战题</h3>
<p><strong>练习 13.4</strong>：控制器链设计
设计一个控制器链，实现"柔顺插入"任务：机器人需要将一个轴插入孔中，孔的位置有 ±2mm 的不确定性。要求：</p>
<ol>
<li>列出控制器链中需要的控制器</li>
<li>说明每个控制器的功能</li>
<li>画出数据流图</li>
</ol>
<p><em>提示</em>：考虑搜索、对准、插入三个阶段。</p>
<details>
<summary>答案</summary>
<p>控制器链设计：</p>
<ol>
<li>
<p><strong>力传感器控制器</strong>（最底层）
   - 读取 F/T 传感器数据
   - 滤波和坐标变换
   - 输出：笛卡尔力/力矩</p>
</li>
<li>
<p><strong>接触检测控制器</strong>
   - 输入：力传感器数据
   - 检测接触状态和接触点
   - 输出：接触标志和接触力</p>
</li>
<li>
<p><strong>螺旋搜索控制器</strong>
   - 生成螺旋搜索轨迹
   - 输入：目标位置、搜索半径
   - 输出：位置/速度参考</p>
</li>
<li>
<p><strong>阻抗控制器</strong>
   - 输入：力误差、位置误差
   - 实现可变刚度控制
   - 输出：速度修正量</p>
</li>
<li>
<p><strong>混合力/位控制器</strong>
   - X,Y方向：位置控制（搜索）
   - Z方向：力控制（插入）
   - 输出：笛卡尔速度命令</p>
</li>
<li>
<p><strong>笛卡尔速度控制器</strong>
   - 输入：笛卡尔速度命令
   - 执行逆运动学
   - 输出：关节速度命令</p>
</li>
</ol>
<p>数据流：</p>
<div class="codehilite"><pre><span></span><code>F/T Sensor → Force Controller → Contact Detector ┐
                                                  ↓
Target Pose → Spiral Search → Impedance → Hybrid F/P → Cartesian → Joint Cmd
                                   ↑                      Velocity
                                   └──────────────────────┘
</code></pre></div>

<p>控制策略：</p>
<ul>
<li>阶段1（搜索）：低Z力(2N)，XY螺旋运动</li>
<li>阶段2（对准）：检测到孔口，切换到柔顺模式</li>
<li>阶段3（插入）：Z力控(10N)，XY柔顺</li>
</ul>
</details>
<p><strong>练习 13.5</strong>：实时性能分析
某控制系统在 1kHz 控制频率下运行 1 小时，统计数据如下：</p>
<ul>
<li>平均执行时间：750 μs</li>
<li>最大执行时间：980 μs</li>
<li>标准差：50 μs</li>
<li>超过 900 μs 的次数：15</li>
</ul>
<p>评估系统的实时性能，并提出优化建议。</p>
<p><em>提示</em>：计算抖动、成功率等指标。</p>
<details>
<summary>答案</summary>
<p>实时性能评估：</p>
<ol>
<li>
<p><strong>基础指标</strong>：
   - 控制周期：1000 μs
   - CPU 利用率：75% (750/1000)
   - 最坏情况利用率：98% (980/1000)
   - 安全裕度：仅 2%</p>
</li>
<li>
<p><strong>抖动分析</strong>：
   - 标准差：50 μs (5% 的周期)
   - 抖动范围：约 ±150 μs (3σ)
   - 相对抖动：15%</p>
</li>
<li>
<p><strong>可靠性</strong>：
   - 总执行次数：3,600,000 (1 hour × 1000 Hz)
   - 超时风险事件：15次
   - 成功率：99.9996%</p>
</li>
<li>
<p><strong>问题识别</strong>：
   - 安全裕度太小（仅 20 μs）
   - 偶发的长延迟（可能是系统中断或 GC）
   - 抖动偏大，影响控制品质</p>
</li>
<li>
<p><strong>优化建议</strong>：
   - <strong>短期</strong>：</p>
<ul>
<li>降低控制频率到 800 Hz，增加裕度</li>
<li>优化关键路径代码，目标减少 50 μs</li>
<li><strong>中期</strong>：</li>
<li>使用 CPU 隔离，避免系统干扰</li>
<li>实现分级控制，非关键任务降频</li>
<li><strong>长期</strong>：</li>
<li>迁移到实时内核（RT_PREEMPT）</li>
<li>硬件加速关键算法（FPGA/GPU）</li>
</ul>
</li>
</ol>
</details>
<p><strong>练习 13.6</strong>：多机器人同步
两个机器人需要协同搬运一个 2 米长的刚性杆。机器人 A 的控制频率是 1000 Hz，机器人 B 是 800 Hz。设计一个同步方案，确保两端的位置误差不超过 1mm。</p>
<p><em>提示</em>：考虑最小公倍数和插值。</p>
<details>
<summary>答案</summary>
<p>同步方案设计：</p>
<ol>
<li>
<p><strong>频率分析</strong>：
   - Robot A: 1000 Hz (周期 1.0 ms)
   - Robot B: 800 Hz (周期 1.25 ms)
   - 最小公倍数：LCM(1000, 800) = 4000 Hz
   - 同步周期：5 ms (200 Hz)</p>
</li>
<li>
<p><strong>同步架构</strong>：</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code>每 5ms 同步点：
Robot A: 5 个控制周期
Robot B: 4 个控制周期

Timeline:
0ms    1ms    2ms    3ms    4ms    5ms
A: ●------●------●------●------●------● (sync)
B: ●--------●--------●--------●--------● (sync)
</code></pre></div>

<ol start="3">
<li>
<p><strong>轨迹同步策略</strong>：
   - 使用全局时间戳
   - 每 5ms 交换状态信息
   - 预测-校正算法</p>
</li>
<li>
<p><strong>误差补偿</strong>：</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># Robot A (1000 Hz)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">control_loop_A</span><span class="p">():</span>
    <span class="n">t_global</span> <span class="o">=</span> <span class="n">get_global_time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">t_global</span> <span class="o">%</span> <span class="mi">5</span><span class="n">ms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sync_with_B</span><span class="p">()</span>

    <span class="c1"># 局部轨迹插值</span>
    <span class="n">pos_ref</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">t_global</span><span class="p">)</span>

    <span class="c1"># 预测 B 的位置</span>
    <span class="n">pos_B_pred</span> <span class="o">=</span> <span class="n">predict_B_position</span><span class="p">(</span><span class="n">t_global</span><span class="p">)</span>

    <span class="c1"># 协调控制</span>
    <span class="n">correction</span> <span class="o">=</span> <span class="n">compute_coordination_correction</span><span class="p">(</span><span class="n">pos_B_pred</span><span class="p">)</span>
    <span class="n">pos_cmd</span> <span class="o">=</span> <span class="n">pos_ref</span> <span class="o">+</span> <span class="n">correction</span>

<span class="c1"># Robot B (800 Hz)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">control_loop_B</span><span class="p">():</span>
    <span class="n">t_global</span> <span class="o">=</span> <span class="n">get_global_time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">t_global</span> <span class="o">%</span> <span class="mi">5</span><span class="n">ms</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">sync_with_A</span><span class="p">()</span>

    <span class="c1"># 三次样条插值提高精度</span>
    <span class="n">pos_ref</span> <span class="o">=</span> <span class="n">trajectory</span><span class="o">.</span><span class="n">spline_sample</span><span class="p">(</span><span class="n">t_global</span><span class="p">)</span>

    <span class="c1"># 类似的协调控制</span>
</code></pre></div>

<ol start="5">
<li>
<p><strong>误差分析</strong>：
   - 最大异步时间：2.5 ms
   - 最大速度 100 mm/s 时
   - 最大位置偏差：0.25 mm &lt; 1 mm ✓</p>
</li>
<li>
<p><strong>容错机制</strong>：
   - 通信延迟补偿
   - 丢包时使用预测值
   - 紧急停止同步</p>
</li>
</ol>
</details>
<p><strong>练习 13.7</strong>：EtherCAT 网络设计
设计一个 EtherCAT 网络，包含：8 个关节驱动器、2 个力传感器、1 个 IMU、16 个数字 I/O。要求实现 1ms 的控制周期，计算所需的网络带宽和延迟。</p>
<p><em>提示</em>：考虑 PDO 大小和 EtherCAT 帧结构。</p>
<details>
<summary>答案</summary>
<p>EtherCAT 网络设计：</p>
<ol>
<li>
<p><strong>设备清单和 PDO 大小</strong>：
   - 8× 关节驱动器：每个 20 bytes (Tx) + 16 bytes (Rx) = 288 bytes
   - 2× 力传感器：每个 24 bytes (Tx only) = 48 bytes
   - 1× IMU：32 bytes (Tx only) = 32 bytes
   - 16× 数字 I/O：2 bytes (Tx) + 2 bytes (Rx) = 4 bytes
   - 总计：372 bytes</p>
</li>
<li>
<p><strong>EtherCAT 帧结构</strong>：
   - Ethernet header：14 bytes
   - EtherCAT header：2 bytes
   - Datagram header：10 bytes × 4 = 40 bytes (假设4个数据报)
   - Working Counter：2 bytes × 4 = 8 bytes
   - CRC：4 bytes
   - 总开销：68 bytes</p>
</li>
<li>
<p><strong>带宽计算</strong>：
   - 有效数据：372 bytes
   - 总帧大小：372 + 68 = 440 bytes
   - 每周期带宽：440 bytes × 1000 Hz = 440 KB/s
   - 比特率：3.52 Mbps
   - 100 Mbps 网络利用率：3.52%</p>
</li>
<li>
<p><strong>延迟分析</strong>：
   - 传输延迟：440 bytes × 8 / 100 Mbps = 35.2 μs
   - 处理延迟（每从站）：~1 μs × 11 = 11 μs
   - 总线延迟：~46 μs
   - 往返时间：~92 μs</p>
</li>
<li>
<p><strong>拓扑优化</strong>：</p>
</li>
</ol>
<div class="codehilite"><pre><span></span><code>Master ─┬─ Joint1 ─ Joint2 ─ Joint3 ─ Joint4
        └─ Joint5 ─ Joint6 ─ Joint7 ─ Joint8
           └─ Force1 ─ Force2 ─ IMU ─ I/O

优化后（星型）：
        ┌─ Branch1: Joint1-4
Master ─┼─ Branch2: Joint5-8
        └─ Branch3: Sensors + I/O
</code></pre></div>

<ol start="6">
<li><strong>实时性保证</strong>：
   - 周期时间：1000 μs
   - 网络往返：92 μs (9.2%)
   - 剩余时间：908 μs 用于控制计算
   - 结论：满足 1ms 周期要求，有充足裕度</li>
</ol>
</details>
<h2 id="1310_1">13.10 常见陷阱与错误</h2>
<h3 id="1">1. 硬件接口陷阱</h3>
<p><strong>问题</strong>：硬件接口状态不一致</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 错误：忘记更新所有状态</span>
<span class="n">return_type</span><span class="w"> </span><span class="nf">read</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">joint_positions_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_encoder</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="c1">// 忘记更新 joint_velocities_!</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">return_type</span><span class="o">::</span><span class="n">OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>解决</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="n">return_type</span><span class="w"> </span><span class="nf">read</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Time</span><span class="w"> </span><span class="n">last_time</span><span class="p">;</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">current_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">clock_</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">();</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">joint_count_</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">new_position</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_encoder</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">last_time</span><span class="p">.</span><span class="n">nanoseconds</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="n">joint_velocities_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>
<span class="w">        </span><span class="p">(</span><span class="n">new_position</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">joint_positions_</span><span class="p">[</span><span class="n">i</span><span class="p">])</span><span class="w"> </span><span class="o">/</span><span class="w"> </span>
<span class="w">        </span><span class="p">(</span><span class="n">current_time</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">last_time</span><span class="p">).</span><span class="n">seconds</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">joint_positions_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_position</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="n">last_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_time</span><span class="p">;</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">return_type</span><span class="o">::</span><span class="n">OK</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="2">2. 实时性违规</h3>
<p><strong>问题</strong>：控制循环中的动态内存分配</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 错误：运行时分配内存</span>
<span class="n">update</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">temp_data</span><span class="p">(</span><span class="n">joint_count_</span><span class="p">);</span><span class="w">  </span><span class="c1">// 分配！</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>解决</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">Controller</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">temp_data_</span><span class="p">;</span><span class="w">  </span><span class="c1">// 预分配</span>

<span class="w">  </span><span class="n">on_configure</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">temp_data_</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">joint_count_</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="n">update</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 使用预分配的内存</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">fill</span><span class="p">(</span><span class="n">temp_data_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">temp_data_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="mf">0.0</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="3">3. 控制器冲突</h3>
<p><strong>问题</strong>：多个控制器访问同一命令接口</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># 错误配置：两个控制器控制同一关节</span>
<span class="nt">position_controller</span><span class="p">:</span>
<span class="w">  </span><span class="nt">joints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">joint1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">joint2</span><span class="p p-Indicator">]</span>

<span class="nt">velocity_controller</span><span class="p">:</span>
<span class="w">  </span><span class="nt">joints</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">joint1</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">joint3</span><span class="p p-Indicator">]</span><span class="w">  </span><span class="c1"># joint1 冲突！</span>
</code></pre></div>

<p><strong>解决</strong>：使用控制器管理器的互斥检查，或实现控制器切换逻辑。</p>
<h3 id="4">4. 时间戳问题</h3>
<p><strong>问题</strong>：使用系统时间而非 ROS 时间</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 错误：使用系统时间</span>
<span class="k">auto</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">system_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
</code></pre></div>

<p><strong>解决</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 正确：使用 ROS 时间</span>
<span class="k">auto</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">node_</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">();</span>
<span class="c1">// 支持仿真时间和真实时间切换</span>
</code></pre></div>

<h3 id="5">5. 单位不一致</h3>
<p><strong>问题</strong>：角度和弧度混用</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 错误：混用单位</span>
<span class="kt">double</span><span class="w"> </span><span class="n">joint_limit_deg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">180</span><span class="p">;</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">joint_position_rad</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">joint_limit_deg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 错误比较！</span>
<span class="w">  </span><span class="c1">// ...</span>
<span class="p">}</span>
</code></pre></div>

<p><strong>解决</strong>：统一使用 SI 单位（弧度、米、秒）。</p>
<h3 id="6">6. 数值稳定性</h3>
<p><strong>问题</strong>：矩阵求逆的数值问题</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 错误：直接求逆</span>
<span class="n">Eigen</span><span class="o">::</span><span class="n">MatrixXd</span><span class="w"> </span><span class="n">M_inv</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">M</span><span class="p">.</span><span class="n">inverse</span><span class="p">();</span><span class="w">  </span><span class="c1">// 可能奇异！</span>
</code></pre></div>

<p><strong>解决</strong>：</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// 使用分解方法</span>
<span class="n">Eigen</span><span class="o">::</span><span class="n">LDLT</span><span class="o">&lt;</span><span class="n">Eigen</span><span class="o">::</span><span class="n">MatrixXd</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ldlt</span><span class="p">(</span><span class="n">M</span><span class="p">);</span>
<span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ldlt</span><span class="p">.</span><span class="n">info</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Eigen</span><span class="o">::</span><span class="n">Success</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="n">Eigen</span><span class="o">::</span><span class="n">VectorXd</span><span class="w"> </span><span class="n">solution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ldlt</span><span class="p">.</span><span class="n">solve</span><span class="p">(</span><span class="n">b</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="_106">调试技巧</h3>
<ol>
<li><strong>实时性能监控</strong>：</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># 监控控制循环性能</span>
ros2<span class="w"> </span>run<span class="w"> </span>controller_manager<span class="w"> </span>controller_manager_diagnostics

<span class="c1"># 查看实时统计</span>
watch<span class="w"> </span>-n<span class="w"> </span><span class="m">0</span>.1<span class="w"> </span><span class="s1">&#39;cat /proc/$(pidof controller_manager)/sched&#39;</span>
</code></pre></div>

<ol start="2">
<li><strong>控制器状态检查</strong>：</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># 列出所有控制器</span>
ros2<span class="w"> </span>control<span class="w"> </span>list_controllers

<span class="c1"># 查看控制器状态</span>
ros2<span class="w"> </span>control<span class="w"> </span>list_controller_types
</code></pre></div>

<ol start="3">
<li><strong>硬件接口调试</strong>：</li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># 列出硬件接口</span>
ros2<span class="w"> </span>control<span class="w"> </span>list_hardware_interfaces

<span class="c1"># 查看硬件组件状态</span>
ros2<span class="w"> </span>control<span class="w"> </span>list_hardware_components
</code></pre></div>

<h2 id="1311_1">13.11 最佳实践检查清单</h2>
<h3 id="_107">设计阶段</h3>
<ul>
<li>[ ] <strong>需求分析</strong></li>
<li>确定控制频率要求</li>
<li>识别实时性约束</li>
<li>
<p>定义安全需求</p>
</li>
<li>
<p>[ ] <strong>架构设计</strong></p>
</li>
<li>选择合适的硬件接口类型</li>
<li>设计控制器链结构</li>
<li>
<p>规划资源分配策略</p>
</li>
<li>
<p>[ ] <strong>接口定义</strong></p>
</li>
<li>统一使用 SI 单位</li>
<li>明确坐标系定义</li>
<li>文档化所有接口</li>
</ul>
<h3 id="_108">实现阶段</h3>
<ul>
<li>[ ] <strong>代码质量</strong></li>
<li>避免动态内存分配</li>
<li>使用 const correctness</li>
<li>
<p>实现异常处理</p>
</li>
<li>
<p>[ ] <strong>实时保证</strong></p>
</li>
<li>内存预分配和锁定</li>
<li>CPU 亲和性设置</li>
<li>
<p>避免阻塞调用</p>
</li>
<li>
<p>[ ] <strong>数值稳定</strong></p>
</li>
<li>使用稳定的数值算法</li>
<li>检查除零和溢出</li>
<li>验证矩阵条件数</li>
</ul>
<h3 id="_109">测试阶段</h3>
<ul>
<li>[ ] <strong>单元测试</strong></li>
<li>测试所有控制模式</li>
<li>验证极限情况</li>
<li>
<p>检查错误处理</p>
</li>
<li>
<p>[ ] <strong>集成测试</strong></p>
</li>
<li>控制器切换测试</li>
<li>通信延迟测试</li>
<li>
<p>故障注入测试</p>
</li>
<li>
<p>[ ] <strong>性能测试</strong></p>
</li>
<li>WCET 分析</li>
<li>抖动测量</li>
<li>长时间稳定性测试</li>
</ul>
<h3 id="_110">部署阶段</h3>
<ul>
<li>[ ] <strong>系统配置</strong></li>
<li>实时内核配置</li>
<li>网络优化</li>
<li>
<p>日志级别设置</p>
</li>
<li>
<p>[ ] <strong>安全检查</strong></p>
</li>
<li>紧急停止测试</li>
<li>碰撞检测验证</li>
<li>
<p>限位保护确认</p>
</li>
<li>
<p>[ ] <strong>文档完善</strong></p>
</li>
<li>参数说明文档</li>
<li>故障排除指南</li>
<li>维护手册</li>
</ul>
<h3 id="_111">维护阶段</h3>
<ul>
<li>[ ] <strong>监控指标</strong></li>
<li>控制性能监控</li>
<li>硬件健康检查</li>
<li>
<p>日志分析</p>
</li>
<li>
<p>[ ] <strong>优化改进</strong></p>
</li>
<li>性能瓶颈分析</li>
<li>参数调优</li>
<li>
<p>算法升级</p>
</li>
<li>
<p>[ ] <strong>知识管理</strong></p>
</li>
<li>问题记录</li>
<li>经验总结</li>
<li>培训材料更新</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter12.html" class="nav-link prev">← 第 12 章：导航栈 Nav2</a><a href="chapter14.html" class="nav-link next">第 14 章：MoveIt2 运动规划 →</a></nav>
        </main>
    </div>
</body>
</html>