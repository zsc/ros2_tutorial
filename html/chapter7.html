<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬ 7 ç« ï¼šLaunch ç³»ç»Ÿä¸é…ç½®ç®¡ç†</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ROS2 å®Œå…¨æ•™ç¨‹ï¼šä»åŸç†åˆ°å®è·µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 1 ç« ï¼šROS1 æ ¸å¿ƒæ¦‚å¿µå›é¡¾</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 2 ç« ï¼šROS1 çš„å±€é™æ€§åˆ†æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 3 ç« ï¼šä» ROS1 åˆ° ROS2 çš„è¿ç§»ç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 4 ç« ï¼šROS2 æ¶æ„ä¸è®¾è®¡ç†å¿µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 5 ç« ï¼šèŠ‚ç‚¹ä¸æ‰§è¡Œå™¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 6 ç« ï¼šé€šä¿¡æœºåˆ¶æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 7 ç« ï¼šLaunch ç³»ç»Ÿä¸é…ç½®ç®¡ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 8 ç« ï¼štf2 åæ ‡å˜æ¢æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 9 ç« ï¼šæ—¶é—´åŒæ­¥ä¸å›æ”¾ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 10 ç« ï¼šä¼ æ„Ÿå™¨æ•°æ®å¤„ç†ç®¡é“</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 11 ç« ï¼šSLAM ä¸å®šä½ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 12 ç« ï¼šå¯¼èˆªæ ˆ Nav2</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 13 ç« ï¼šros2_control æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 14 ç« ï¼šMoveIt2 è¿åŠ¨è§„åˆ’</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 15 ç« ï¼šå®æ—¶ç³»ç»Ÿä¸æ€§èƒ½ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 16 ç« ï¼šå®‰å…¨æ€§ä¸è¯Šæ–­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 17 ç« ï¼šä»¿çœŸé›†æˆï¼ˆGazebo/Ignitionï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 18 ç« ï¼šå¤šæœºå™¨äººç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 19 ç« ï¼šè®¡ç®—æœºè§†è§‰ä¸æ·±åº¦å­¦ä¹ </span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 20 ç« ï¼šæœºå™¨äººå¼ºåŒ–å­¦ä¹ </span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 21 ç« ï¼šå¤§è¯­è¨€æ¨¡å‹ä¸å…·èº«æ™ºèƒ½</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 22 ç« ï¼šç¥ç»ç½‘ç»œè¿åŠ¨æ§åˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="7-launch">ç¬¬ 7 ç« ï¼šLaunch ç³»ç»Ÿä¸é…ç½®ç®¡ç†</h1>
<h2 id="_1">å¼€ç¯‡æ®µè½</h2>
<p>ROS2 çš„ Launch ç³»ç»Ÿæ˜¯æ•´ä¸ªæœºå™¨äººç³»ç»Ÿçš„æŒ‡æŒ¥ä¸­å¿ƒï¼Œè´Ÿè´£åè°ƒå¯åŠ¨ã€é…ç½®å’Œç®¡ç†æ•°åç”šè‡³ä¸Šç™¾ä¸ªèŠ‚ç‚¹ã€‚ä¸ ROS1 çš„ XML-only launch æ–‡ä»¶ç›¸æ¯”ï¼ŒROS2 æä¾›äº†åŸºäº Python çš„åŠ¨æ€å¯åŠ¨ç³»ç»Ÿï¼Œæ”¯æŒæ¡ä»¶é€»è¾‘ã€äº‹ä»¶å¤„ç†å’Œå¤æ‚çš„å‚æ•°ç®¡ç†ã€‚æœ¬ç« å°†æ·±å…¥æ¢è®¨ Launch ç³»ç»Ÿçš„æ¶æ„è®¾è®¡ã€é«˜çº§ç‰¹æ€§ä»¥åŠåœ¨å¤§è§„æ¨¡æœºå™¨äººç³»ç»Ÿä¸­çš„æœ€ä½³å®è·µã€‚</p>
<h2 id="_2">å­¦ä¹ ç›®æ ‡</h2>
<ul>
<li>æŒæ¡ ROS2 Launch ç³»ç»Ÿçš„æ ¸å¿ƒæ¶æ„å’Œè®¾è®¡ç†å¿µ</li>
<li>ç†Ÿç»ƒä½¿ç”¨ Pythonã€XMLã€YAML ä¸‰ç§æ ¼å¼ç¼–å†™ Launch æ–‡ä»¶</li>
<li>ç†è§£æ¡ä»¶å¯åŠ¨ã€äº‹ä»¶å¤„ç†å’Œå‚æ•°æ›¿æ¢æœºåˆ¶</li>
<li>å­¦ä¼šè®¾è®¡å¯å¤ç”¨ã€å¯æ‰©å±•çš„ Launch æ¨¡å—</li>
<li>æŒæ¡åˆ†å¸ƒå¼å¤šæœºå™¨äººç³»ç»Ÿçš„éƒ¨ç½²ç­–ç•¥</li>
</ul>
<h2 id="71-launch">7.1 Launch æ–‡ä»¶æ¶æ„</h2>
<h3 id="711-ros1-ros2">7.1.1 æ¶æ„æ¼”è¿›ï¼šä» ROS1 åˆ° ROS2</h3>
<p>ROS1 çš„ launch ç³»ç»ŸåŸºäºé™æ€ XML æ–‡ä»¶ï¼Œè™½ç„¶ç®€å•ç›´è§‚ï¼Œä½†åœ¨å¤„ç†å¤æ‚é€»è¾‘æ—¶æ˜¾å¾—åŠ›ä¸ä»å¿ƒã€‚ä¸»è¦å±€é™åŒ…æ‹¬ï¼š</p>
<ol>
<li><strong>é™æ€é…ç½®</strong>ï¼šç¼ºä¹æ¡ä»¶é€»è¾‘å’Œå¾ªç¯ç»“æ„</li>
<li><strong>å‚æ•°ç®¡ç†ç®€é™‹</strong>ï¼šå‚æ•°æœåŠ¡å™¨é›†ä¸­å¼æ¶æ„ï¼Œéš¾ä»¥å®ç°æ¨¡å—åŒ–</li>
<li><strong>æ‰©å±•æ€§å·®</strong>ï¼šè‡ªå®šä¹‰åŠŸèƒ½éœ€è¦ä¿®æ”¹ roslaunch æºç </li>
<li><strong>è°ƒè¯•å›°éš¾</strong>ï¼šXML è§£æé”™è¯¯ä¿¡æ¯ä¸å¤Ÿå‹å¥½</li>
</ol>
<p>ROS2 å¼•å…¥äº†å…¨æ–°çš„ Launch æ¶æ„ï¼Œæ ¸å¿ƒæ”¹è¿›åŒ…æ‹¬ï¼š</p>
<div class="codehilite"><pre><span></span><code>ROS1 Launch                    ROS2 Launch
     â”‚                              â”‚
     â”œâ”€â”€ XML Only                   â”œâ”€â”€ Python (Primary)
     â”œâ”€â”€ Static Config              â”œâ”€â”€ XML/YAML (Frontend)
     â”œâ”€â”€ Parameter Server           â”œâ”€â”€ Distributed Parameters
     â””â”€â”€ Limited Logic              â””â”€â”€ Event-Based System
</code></pre></div>

<p>å…³é”®è®¾è®¡ç†å¿µï¼š</p>
<ul>
<li><strong>ç¨‹åºåŒ–é…ç½®</strong>ï¼šPython API æä¾›å®Œæ•´çš„ç¼–ç¨‹èƒ½åŠ›</li>
<li><strong>äº‹ä»¶é©±åŠ¨</strong>ï¼šåŸºäºäº‹ä»¶çš„å¼‚æ­¥æ¶æ„</li>
<li><strong>æ¨¡å—åŒ–è®¾è®¡</strong>ï¼šæ”¯æŒ Launch æ–‡ä»¶ç»„åˆå’Œå¤ç”¨</li>
<li><strong>å£°æ˜å¼å‰ç«¯</strong>ï¼šXML/YAML ä½œä¸ºç®€åŒ–æ¥å£</li>
</ul>
<h3 id="712-python-launch">7.1.2 Python Launch ç³»ç»Ÿè®¾è®¡</h3>
<p>Python Launch ç³»ç»Ÿé‡‡ç”¨äº†æè¿°-æ‰§è¡Œåˆ†ç¦»çš„æ¶æ„ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="nv">LaunchDescription</span>
<span class="w">     </span>â”‚
<span class="w">     </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Actions</span><span class="w"> </span><span class="ss">(</span>èŠ‚ç‚¹ã€åŒ…å«æ–‡ä»¶ã€è®¾ç½®å‚æ•°ç­‰<span class="ss">)</span>
<span class="w">     </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Substitutions</span><span class="w"> </span><span class="ss">(</span>å‚æ•°æ›¿æ¢ã€ç¯å¢ƒå˜é‡ç­‰<span class="ss">)</span>
<span class="w">     </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Conditions</span><span class="w"> </span><span class="ss">(</span>æ¡ä»¶è¡¨è¾¾å¼<span class="ss">)</span>
<span class="w">     </span>â””â”€â”€<span class="w"> </span><span class="nv">Event</span><span class="w"> </span><span class="nv">Handlers</span><span class="w"> </span><span class="ss">(</span>äº‹ä»¶å¤„ç†å™¨<span class="ss">)</span>
<span class="w">           </span>â”‚
<span class="w">           </span><span class="nv">v</span>
<span class="w">    </span><span class="nv">LaunchService</span><span class="w"> </span><span class="ss">(</span>æ‰§è¡Œå¼•æ“<span class="ss">)</span>
<span class="w">           </span>â”‚
<span class="w">           </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Event</span><span class="w"> </span><span class="k">Loop</span>
<span class="w">           </span>â”œâ”€â”€<span class="w"> </span><span class="nv">Action</span><span class="w"> </span><span class="nv">Executor</span>
<span class="w">           </span>â””â”€â”€<span class="w"> </span><span class="nv">Context</span><span class="w"> </span><span class="nv">Manager</span>
</code></pre></div>

<p>æ ¸å¿ƒç»„ä»¶è§£æï¼š</p>
<p><strong>LaunchDescription</strong>ï¼šå£°æ˜å¼çš„å¯åŠ¨æè¿°ï¼ŒåŒ…å«æ‰€æœ‰è¦æ‰§è¡Œçš„åŠ¨ä½œåºåˆ—ã€‚</p>
<p><strong>Actions</strong>ï¼šå¯æ‰§è¡Œçš„åŸå­æ“ä½œï¼Œä¸»è¦ç±»å‹åŒ…æ‹¬ï¼š</p>
<ul>
<li><code>Node</code>ï¼šå¯åŠ¨ ROS2 èŠ‚ç‚¹</li>
<li><code>ExecuteProcess</code>ï¼šæ‰§è¡Œç³»ç»Ÿè¿›ç¨‹</li>
<li><code>IncludeLaunchDescription</code>ï¼šåŒ…å«å…¶ä»– launch æ–‡ä»¶</li>
<li><code>SetParameter</code>ï¼šè®¾ç½®å‚æ•°</li>
<li><code>GroupAction</code>ï¼šç»„åˆå¤šä¸ªåŠ¨ä½œ</li>
</ul>
<p><strong>Substitutions</strong>ï¼šå»¶è¿Ÿæ±‚å€¼çš„è¡¨è¾¾å¼ç³»ç»Ÿï¼š</p>
<ul>
<li><code>LaunchConfiguration</code>ï¼šå¯åŠ¨é…ç½®å˜é‡</li>
<li><code>PathJoinSubstitution</code>ï¼šè·¯å¾„æ‹¼æ¥</li>
<li><code>FindPackageShare</code>ï¼šæŸ¥æ‰¾åŒ…çš„ share ç›®å½•</li>
<li><code>Command</code>ï¼šæ‰§è¡Œ shell å‘½ä»¤å¹¶è·å–è¾“å‡º</li>
</ul>
<p><strong>LaunchService</strong>ï¼šæ‰§è¡Œå¼•æ“ï¼Œè´Ÿè´£ï¼š</p>
<ol>
<li>è§£æ LaunchDescription</li>
<li>ç®¡ç†äº‹ä»¶å¾ªç¯</li>
<li>æ‰§è¡Œ Actions</li>
<li>å¤„ç†ç”Ÿå‘½å‘¨æœŸäº‹ä»¶</li>
</ol>
<h3 id="713-xml-yaml">7.1.3 XML å’Œ YAML æ ¼å¼æ”¯æŒ</h3>
<p>è™½ç„¶ Python æ˜¯ä¸»è¦æ¥å£ï¼ŒROS2 ä¹Ÿæä¾›äº† XML å’Œ YAML å‰ç«¯ï¼Œä¾¿äºç®€å•åœºæ™¯çš„å¿«é€Ÿé…ç½®ã€‚</p>
<p><strong>æ ¼å¼å¯¹æ¯”</strong>ï¼š</p>
<p>| ç‰¹æ€§ | Python | XML | YAML |</p>
<table>
<thead>
<tr>
<th>ç‰¹æ€§</th>
<th>Python</th>
<th>XML</th>
<th>YAML</th>
</tr>
</thead>
<tbody>
<tr>
<td>æ¡ä»¶é€»è¾‘</td>
<td>å®Œæ•´æ”¯æŒ</td>
<td>åŸºç¡€æ”¯æŒ</td>
<td>åŸºç¡€æ”¯æŒ</td>
</tr>
<tr>
<td>å¾ªç¯ç»“æ„</td>
<td>æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
</tr>
<tr>
<td>è‡ªå®šä¹‰å‡½æ•°</td>
<td>æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
<td>ä¸æ”¯æŒ</td>
</tr>
<tr>
<td>å¯è¯»æ€§</td>
<td>ä¸­ç­‰</td>
<td>é«˜</td>
<td>æœ€é«˜</td>
</tr>
<tr>
<td>å­¦ä¹ æ›²çº¿</td>
<td>é™¡å³­</td>
<td>å¹³ç¼“</td>
<td>å¹³ç¼“</td>
</tr>
<tr>
<td>é€‚ç”¨åœºæ™¯</td>
<td>å¤æ‚ç³»ç»Ÿ</td>
<td>ä¸­ç­‰å¤æ‚åº¦</td>
<td>ç®€å•é…ç½®</td>
</tr>
</tbody>
</table>
<p><strong>è½¬æ¢æœºåˆ¶</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>XML/YAML â†’ Frontend Parser â†’ Python AST â†’ LaunchDescription
                                  â”‚
                                  v
                           LaunchService
</code></pre></div>

<p>XML/YAML å®é™…ä¸Šæ˜¯é€šè¿‡è§£æå™¨è½¬æ¢ä¸ºç­‰ä»·çš„ Python ä»£ç ï¼Œå› æ­¤åŠŸèƒ½æ˜¯ Python API çš„å­é›†ã€‚</p>
<h3 id="714-launch">7.1.4 Launch æè¿°æ¶æ„</h3>
<p>Launch æè¿°é‡‡ç”¨äº†åˆ†å±‚æ¶æ„è®¾è®¡ï¼š</p>
<div class="codehilite"><pre><span></span><code>Application Layer (åº”ç”¨å±‚)
    â”‚
    â”œâ”€â”€ Launch Files (ç”¨æˆ·ç¼–å†™çš„å¯åŠ¨æ–‡ä»¶)
    â””â”€â”€ Launch Configurations (é…ç½®å‚æ•°)
         â”‚
Description Layer (æè¿°å±‚)
    â”‚
    â”œâ”€â”€ Actions (åŠ¨ä½œå®šä¹‰)
    â”œâ”€â”€ Substitutions (æ›¿æ¢è¡¨è¾¾å¼)
    â””â”€â”€ Conditions (æ¡ä»¶é€»è¾‘)
         â”‚
Execution Layer (æ‰§è¡Œå±‚)
    â”‚
    â”œâ”€â”€ LaunchService (æ‰§è¡ŒæœåŠ¡)
    â”œâ”€â”€ Event System (äº‹ä»¶ç³»ç»Ÿ)
    â””â”€â”€ Context (æ‰§è¡Œä¸Šä¸‹æ–‡)
         â”‚
System Layer (ç³»ç»Ÿå±‚)
    â”‚
    â”œâ”€â”€ Process Management (è¿›ç¨‹ç®¡ç†)
    â”œâ”€â”€ Signal Handling (ä¿¡å·å¤„ç†)
    â””â”€â”€ I/O Redirection (è¾“å…¥è¾“å‡ºé‡å®šå‘)
</code></pre></div>

<p><strong>æ‰§è¡Œæµç¨‹</strong>ï¼š</p>
<ol>
<li>
<p><strong>è§£æé˜¶æ®µ</strong>ï¼š
   - åŠ è½½ launch æ–‡ä»¶
   - æ„å»º LaunchDescription
   - æ³¨å†Œäº‹ä»¶å¤„ç†å™¨</p>
</li>
<li>
<p><strong>å‡†å¤‡é˜¶æ®µ</strong>ï¼š
   - åˆå§‹åŒ– LaunchContext
   - è§£æå‘½ä»¤è¡Œå‚æ•°
   - è®¾ç½®ç¯å¢ƒå˜é‡</p>
</li>
<li>
<p><strong>æ‰§è¡Œé˜¶æ®µ</strong>ï¼š
   - éå† Actions åˆ—è¡¨
   - æ‰§è¡Œæ¯ä¸ª Action
   - å¤„ç†äº§ç”Ÿçš„äº‹ä»¶</p>
</li>
<li>
<p><strong>æ¸…ç†é˜¶æ®µ</strong>ï¼š
   - ç­‰å¾…è¿›ç¨‹ç»“æŸ
   - æ¸…ç†èµ„æº
   - è¿”å›é€€å‡ºç </p>
</li>
</ol>
<p><strong>ä¸Šä¸‹æ–‡ç®¡ç†</strong>ï¼š</p>
<p>LaunchContext ç»´æŠ¤äº†æ‰§è¡Œæ—¶çš„å…¨å±€çŠ¶æ€ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">LaunchContext</span><span class="p">:</span>
    <span class="n">launch_configurations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>  <span class="c1"># é…ç½®å‚æ•°</span>
    <span class="n">environment_variables</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]</span>  <span class="c1"># ç¯å¢ƒå˜é‡</span>
    <span class="n">global_parameters</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Parameter</span><span class="p">]</span>     <span class="c1"># å…¨å±€å‚æ•°</span>
    <span class="n">asyncio_loop</span><span class="p">:</span> <span class="n">AbstractEventLoop</span>       <span class="c1"># äº‹ä»¶å¾ªç¯</span>
</code></pre></div>

<p>è¿™ç§è®¾è®¡å…è®¸åœ¨è¿è¡Œæ—¶åŠ¨æ€ä¿®æ”¹é…ç½®ï¼Œå®ç°çµæ´»çš„ç³»ç»Ÿè¡Œä¸ºã€‚</p>
<h2 id="72">7.2 å¤æ‚ç³»ç»Ÿç»„åˆä¸å‚æ•°ä¼ é€’</h2>
<h3 id="721">7.2.1 å‚æ•°æ–‡ä»¶ä¸è¦†ç›–æœºåˆ¶</h3>
<p>ROS2 çš„å‚æ•°ç³»ç»Ÿæ”¯æŒå¤šå±‚æ¬¡çš„é…ç½®è¦†ç›–ï¼Œä¼˜å…ˆçº§ä»ä½åˆ°é«˜ä¸ºï¼š</p>
<div class="codehilite"><pre><span></span><code>é»˜è®¤å€¼ â†’ YAMLæ–‡ä»¶ â†’ Launchå‚æ•° â†’ å‘½ä»¤è¡Œè¦†ç›–
</code></pre></div>

<p><strong>å‚æ•°æ–‡ä»¶æ ¼å¼</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># config/robot_params.yaml</span>
<span class="nt">/robot_controller</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ros__parameters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">wheel_radius</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.05</span>
<span class="w">    </span><span class="nt">wheel_base</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.3</span>
<span class="w">    </span><span class="nt">max_velocity</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2.0</span>
<span class="w">    </span><span class="nt">control_frequency</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100.0</span>

<span class="nt">/sensor_processor</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ros__parameters</span><span class="p">:</span>
<span class="w">    </span><span class="nt">lidar</span><span class="p">:</span>
<span class="w">      </span><span class="nt">range_min</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.15</span>
<span class="w">      </span><span class="nt">range_max</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">12.0</span>
<span class="w">      </span><span class="nt">angle_increment</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.00436</span><span class="w">  </span><span class="c1"># 0.25 degree</span>
<span class="w">    </span><span class="nt">camera</span><span class="p">:</span>
<span class="w">      </span><span class="nt">fps</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
<span class="w">      </span><span class="nt">resolution</span><span class="p">:</span><span class="w"> </span><span class="p p-Indicator">[</span><span class="nv">640</span><span class="p p-Indicator">,</span><span class="w"> </span><span class="nv">480</span><span class="p p-Indicator">]</span>
</code></pre></div>

<p><strong>å‚æ•°è¦†ç›–æœºåˆ¶</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># ä¼˜å…ˆçº§ç¤ºä¾‹</span>
<span class="n">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="s1">&#39;robot_control&#39;</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;controller&#39;</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
        <span class="c1"># 1. ä»æ–‡ä»¶åŠ è½½åŸºç¡€é…ç½®</span>
        <span class="p">{</span><span class="s1">&#39;config_file&#39;</span><span class="p">:</span> <span class="s1">&#39;base_config.yaml&#39;</span><span class="p">},</span>

        <span class="c1"># 2. åŠ è½½ç‰¹å®šç¯å¢ƒé…ç½®ï¼ˆè¦†ç›–åŸºç¡€é…ç½®ï¼‰</span>
        <span class="p">{</span><span class="s1">&#39;config_file&#39;</span><span class="p">:</span> <span class="s1">&#39;env_specific.yaml&#39;</span><span class="p">},</span>

        <span class="c1"># 3. Launch æ–‡ä»¶ä¸­çš„ç›´æ¥å‚æ•°ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰</span>
        <span class="p">{</span><span class="s1">&#39;max_velocity&#39;</span><span class="p">:</span> <span class="mf">1.5</span><span class="p">},</span>

        <span class="c1"># 4. å…è®¸å‘½ä»¤è¡Œè¦†ç›–</span>
        <span class="p">{</span><span class="s1">&#39;use_sim_time&#39;</span><span class="p">:</span> <span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;use_sim_time&#39;</span><span class="p">)}</span>
    <span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>å‚æ•°å‘½åç©ºé—´éš”ç¦»</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å¤šæœºå™¨äººå‚æ•°éš”ç¦»</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_robots</span><span class="p">):</span>
    <span class="n">robot_ns</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;robot_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span>
    <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="n">Node</span><span class="p">(</span>
            <span class="n">namespace</span><span class="o">=</span><span class="n">robot_ns</span><span class="p">,</span>
            <span class="n">package</span><span class="o">=</span><span class="s1">&#39;nav2_controller&#39;</span><span class="p">,</span>
            <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;controller_server&#39;</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
                <span class="p">{</span><span class="s1">&#39;robot_id&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">},</span>
                <span class="p">{</span><span class="s1">&#39;base_frame&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">robot_ns</span><span class="si">}</span><span class="s1">/base_link&#39;</span><span class="p">},</span>
                <span class="c1"># æ¯ä¸ªæœºå™¨äººç‹¬ç«‹çš„å‚æ•°æ–‡ä»¶</span>
                <span class="sa">f</span><span class="s1">&#39;config/</span><span class="si">{</span><span class="n">robot_ns</span><span class="si">}</span><span class="s1">_params.yaml&#39;</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="p">)</span>
</code></pre></div>

<p><strong>åŠ¨æ€å‚æ•°æ›´æ–°</strong>ï¼š</p>
<p>Launch ç³»ç»Ÿæ”¯æŒåœ¨è¿è¡Œæ—¶æ›´æ–°å‚æ•°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å‚æ•°æ›´æ–°äº‹ä»¶å¤„ç†</span>
<span class="n">RegisterEventHandler</span><span class="p">(</span>
    <span class="n">OnProcessStart</span><span class="p">(</span>
        <span class="n">target_action</span><span class="o">=</span><span class="n">controller_node</span><span class="p">,</span>
        <span class="n">on_start</span><span class="o">=</span><span class="p">[</span>
            <span class="c1"># èŠ‚ç‚¹å¯åŠ¨ååŠ¨æ€è®¾ç½®å‚æ•°</span>
            <span class="n">ExecuteProcess</span><span class="p">(</span>
                <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ros2&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">,</span> 
                     <span class="s1">&#39;/controller&#39;</span><span class="p">,</span> <span class="s1">&#39;gain&#39;</span><span class="p">,</span> <span class="s1">&#39;1.5&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="722">7.2.2 å‘½åç©ºé—´ä¸é‡æ˜ å°„</h3>
<p>å‘½åç©ºé—´å’Œé‡æ˜ å°„æ˜¯å®ç°æ¨¡å—åŒ–å’Œå¤ç”¨çš„å…³é”®æœºåˆ¶ã€‚</p>
<p><strong>å‘½åç©ºé—´å±‚æ¬¡ç»“æ„</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="o">/</span><span class="w">                          </span><span class="err">#</span><span class="w"> </span><span class="err">å…¨å±€å‘½åç©ºé—´</span>
<span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="o">/</span><span class="n">robot1</span><span class="w">                </span><span class="err">#</span><span class="w"> </span><span class="err">æœºå™¨äºº</span><span class="mi">1</span><span class="err">å‘½åç©ºé—´</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="o">/</span><span class="n">sensors</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â”œâ”€â”€</span><span class="w"> </span><span class="o">/</span><span class="n">lidar</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="o">/</span><span class="nb">camera</span>
<span class="err">â”‚</span><span class="w">   </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="o">/</span><span class="n">actuators</span>
<span class="err">â”‚</span><span class="w">       </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="o">/</span><span class="n">wheels</span>
<span class="err">â””â”€â”€</span><span class="w"> </span><span class="o">/</span><span class="n">robot2</span><span class="w">                </span><span class="err">#</span><span class="w"> </span><span class="err">æœºå™¨äºº</span><span class="mi">2</span><span class="err">å‘½åç©ºé—´</span>
<span class="w">    </span><span class="err">â””â”€â”€</span><span class="w"> </span><span class="o">...</span>
</code></pre></div>

<p><strong>è¯é¢˜é‡æ˜ å°„</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="n">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="s1">&#39;sensor_fusion&#39;</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;fusion_node&#39;</span><span class="p">,</span>
    <span class="n">remappings</span><span class="o">=</span><span class="p">[</span>
        <span class="c1"># è¾“å…¥é‡æ˜ å°„</span>
        <span class="p">(</span><span class="s1">&#39;scan&#39;</span><span class="p">,</span> <span class="s1">&#39;/robot1/lidar/scan&#39;</span><span class="p">),</span>
        <span class="p">(</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="s1">&#39;/robot1/camera/image_raw&#39;</span><span class="p">),</span>

        <span class="c1"># è¾“å‡ºé‡æ˜ å°„</span>
        <span class="p">(</span><span class="s1">&#39;fused_data&#39;</span><span class="p">,</span> <span class="s1">&#39;/perception/obstacles&#39;</span><span class="p">),</span>

        <span class="c1"># æœåŠ¡é‡æ˜ å°„</span>
        <span class="p">(</span><span class="s1">&#39;calibrate&#39;</span><span class="p">,</span> <span class="s1">&#39;/calibration/trigger&#39;</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>ç›¸å¯¹ä¸ç»å¯¹å‘½å</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># ç›¸å¯¹å‘½åï¼ˆç›¸å¯¹äºèŠ‚ç‚¹çš„å‘½åç©ºé—´ï¼‰</span>
<span class="n">remappings</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;cmd_vel&#39;</span><span class="p">,</span> <span class="s1">&#39;mobile_base/cmd_vel&#39;</span><span class="p">),</span>  <span class="c1"># ç›¸å¯¹è·¯å¾„</span>
<span class="p">]</span>

<span class="c1"># ç»å¯¹å‘½åï¼ˆä»æ ¹å‘½åç©ºé—´å¼€å§‹ï¼‰</span>
<span class="n">remappings</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;cmd_vel&#39;</span><span class="p">,</span> <span class="s1">&#39;/robot1/mobile_base/cmd_vel&#39;</span><span class="p">),</span>  <span class="c1"># ç»å¯¹è·¯å¾„</span>
<span class="p">]</span>

<span class="c1"># ç§æœ‰å‘½åï¼ˆèŠ‚ç‚¹ç§æœ‰å‘½åç©ºé—´ï¼‰</span>
<span class="n">remappings</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;~diagnostics&#39;</span><span class="p">,</span> <span class="s1">&#39;system/health&#39;</span><span class="p">),</span>  <span class="c1"># ~ è¡¨ç¤ºç§æœ‰</span>
<span class="p">]</span>
</code></pre></div>

<h3 id="723-launch">7.2.3 ç»„åˆ Launch æ–‡ä»¶</h3>
<p>æ¨¡å—åŒ–è®¾è®¡æ˜¯ç®¡ç†å¤§å‹ç³»ç»Ÿçš„å…³é”®ã€‚ROS2 æ”¯æŒå¤šç§ Launch æ–‡ä»¶ç»„åˆæ¨¡å¼ã€‚</p>
<p><strong>åŸºç¡€åŒ…å«æ¨¡å¼</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">launch</span><span class="w"> </span><span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch.actions</span><span class="w"> </span><span class="kn">import</span> <span class="n">IncludeLaunchDescription</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch.launch_description_sources</span><span class="w"> </span><span class="kn">import</span> <span class="n">PythonLaunchDescriptionSource</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch.substitutions</span><span class="w"> </span><span class="kn">import</span> <span class="n">PathJoinSubstitution</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch_ros.substitutions</span><span class="w"> </span><span class="kn">import</span> <span class="n">FindPackageShare</span>

<span class="k">def</span><span class="w"> </span><span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="c1"># åŒ…å«å…¶ä»–åŒ…çš„ launch æ–‡ä»¶</span>
    <span class="n">nav2_launch</span> <span class="o">=</span> <span class="n">IncludeLaunchDescription</span><span class="p">(</span>
        <span class="n">PythonLaunchDescriptionSource</span><span class="p">([</span>
            <span class="n">PathJoinSubstitution</span><span class="p">([</span>
                <span class="n">FindPackageShare</span><span class="p">(</span><span class="s1">&#39;nav2_bringup&#39;</span><span class="p">),</span>
                <span class="s1">&#39;launch&#39;</span><span class="p">,</span>
                <span class="s1">&#39;navigation_launch.py&#39;</span>
            <span class="p">])</span>
        <span class="p">]),</span>
        <span class="c1"># ä¼ é€’å‚æ•°åˆ°è¢«åŒ…å«çš„ launch æ–‡ä»¶</span>
        <span class="n">launch_arguments</span><span class="o">=</span><span class="p">{</span>
            <span class="s1">&#39;use_sim_time&#39;</span><span class="p">:</span> <span class="s1">&#39;true&#39;</span><span class="p">,</span>
            <span class="s1">&#39;map&#39;</span><span class="p">:</span> <span class="s1">&#39;/path/to/map.yaml&#39;</span><span class="p">,</span>
            <span class="s1">&#39;params_file&#39;</span><span class="p">:</span> <span class="n">FindPackageShare</span><span class="p">(</span><span class="s1">&#39;my_robot&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;config/nav2_params.yaml&#39;</span><span class="p">)</span>
        <span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">LaunchDescription</span><span class="p">([</span><span class="n">nav2_launch</span><span class="p">])</span>
</code></pre></div>

<p><strong>æ¡ä»¶åŒ…å«</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ ¹æ®æ¡ä»¶åŒ…å«ä¸åŒçš„ launch æ–‡ä»¶</span>
<span class="n">simulation_launch</span> <span class="o">=</span> <span class="n">IncludeLaunchDescription</span><span class="p">(</span>
    <span class="n">PythonLaunchDescriptionSource</span><span class="p">([</span><span class="o">...</span><span class="p">]),</span>
    <span class="n">condition</span><span class="o">=</span><span class="n">IfCondition</span><span class="p">(</span><span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;use_sim&#39;</span><span class="p">))</span>
<span class="p">)</span>

<span class="n">hardware_launch</span> <span class="o">=</span> <span class="n">IncludeLaunchDescription</span><span class="p">(</span>
    <span class="n">PythonLaunchDescriptionSource</span><span class="p">([</span><span class="o">...</span><span class="p">]),</span>
    <span class="n">condition</span><span class="o">=</span><span class="n">UnlessCondition</span><span class="p">(</span><span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;use_sim&#39;</span><span class="p">))</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>ç»„åˆæ¨¡å¼æœ€ä½³å®è·µ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># åˆ†å±‚ç»„åˆæ¶æ„</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="n">ld</span> <span class="o">=</span> <span class="n">LaunchDescription</span><span class="p">()</span>

    <span class="c1"># 1. ç¡¬ä»¶æŠ½è±¡å±‚</span>
    <span class="n">ld</span><span class="o">.</span><span class="n">add_action</span><span class="p">(</span>
        <span class="n">IncludeLaunchDescription</span><span class="p">(</span>
            <span class="s1">&#39;hardware_interface_launch.py&#39;</span><span class="p">,</span>
            <span class="n">launch_arguments</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;robot_type&#39;</span><span class="p">:</span> <span class="s1">&#39;differential_drive&#39;</span><span class="p">}</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># 2. ä¼ æ„Ÿå™¨å±‚</span>
    <span class="n">ld</span><span class="o">.</span><span class="n">add_action</span><span class="p">(</span>
        <span class="n">GroupAction</span><span class="p">([</span>
            <span class="n">IncludeLaunchDescription</span><span class="p">(</span><span class="s1">&#39;lidar_launch.py&#39;</span><span class="p">),</span>
            <span class="n">IncludeLaunchDescription</span><span class="p">(</span><span class="s1">&#39;camera_launch.py&#39;</span><span class="p">),</span>
            <span class="n">IncludeLaunchDescription</span><span class="p">(</span><span class="s1">&#39;imu_launch.py&#39;</span><span class="p">),</span>
        <span class="p">],</span> 
        <span class="n">scoped</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># ä½œç”¨åŸŸéš”ç¦»</span>
        <span class="n">forwarding</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># è½¬å‘å¯åŠ¨å‚æ•°</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># 3. æ„ŸçŸ¥å±‚</span>
    <span class="n">ld</span><span class="o">.</span><span class="n">add_action</span><span class="p">(</span>
        <span class="n">IncludeLaunchDescription</span><span class="p">(</span>
            <span class="s1">&#39;perception_launch.py&#39;</span><span class="p">,</span>
            <span class="n">condition</span><span class="o">=</span><span class="n">LaunchConfigurationEquals</span><span class="p">(</span><span class="s1">&#39;enable_perception&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">)</span>

    <span class="c1"># 4. å¯¼èˆªå±‚</span>
    <span class="n">ld</span><span class="o">.</span><span class="n">add_action</span><span class="p">(</span>
        <span class="n">IncludeLaunchDescription</span><span class="p">(</span><span class="s1">&#39;navigation_launch.py&#39;</span><span class="p">)</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">ld</span>
</code></pre></div>

<h3 id="724">7.2.4 å‚æ•°æ›¿æ¢ä¸ç¯å¢ƒå˜é‡</h3>
<p>ROS2 çš„æ›¿æ¢æœºåˆ¶å…è®¸åœ¨è¿è¡Œæ—¶åŠ¨æ€è§£æå‚æ•°å€¼ã€‚</p>
<p><strong>å¸¸ç”¨æ›¿æ¢ç±»å‹</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">launch.substitutions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">Command</span><span class="p">,</span> <span class="n">LaunchConfiguration</span><span class="p">,</span> 
    <span class="n">EnvironmentVariable</span><span class="p">,</span> <span class="n">FindExecutable</span><span class="p">,</span>
    <span class="n">PathJoinSubstitution</span><span class="p">,</span> <span class="n">TextSubstitution</span>
<span class="p">)</span>

<span class="c1"># 1. å‘½ä»¤æ›¿æ¢ - æ‰§è¡Œå‘½ä»¤è·å–è¾“å‡º</span>
<span class="n">robot_description</span> <span class="o">=</span> <span class="n">Command</span><span class="p">([</span>
    <span class="n">FindExecutable</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;xacro&#39;</span><span class="p">),</span> <span class="s1">&#39; &#39;</span><span class="p">,</span>
    <span class="n">PathJoinSubstitution</span><span class="p">([</span>
        <span class="n">FindPackageShare</span><span class="p">(</span><span class="s1">&#39;my_robot&#39;</span><span class="p">),</span>
        <span class="s1">&#39;urdf&#39;</span><span class="p">,</span>
        <span class="s1">&#39;robot.urdf.xacro&#39;</span>
    <span class="p">])</span>
<span class="p">])</span>

<span class="c1"># 2. ç¯å¢ƒå˜é‡æ›¿æ¢</span>
<span class="n">ros_domain_id</span> <span class="o">=</span> <span class="n">EnvironmentVariable</span><span class="p">(</span><span class="s1">&#39;ROS_DOMAIN_ID&#39;</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="p">)</span>

<span class="c1"># 3. å¯åŠ¨é…ç½®æ›¿æ¢</span>
<span class="n">use_sim_time</span> <span class="o">=</span> <span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;use_sim_time&#39;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s1">&#39;false&#39;</span><span class="p">)</span>

<span class="c1"># 4. æ¡ä»¶æ›¿æ¢</span>
<span class="n">robot_name</span> <span class="o">=</span> <span class="n">PythonExpression</span><span class="p">([</span>
    <span class="s1">&#39;&quot;simulation_robot&quot; if &quot;&#39;</span><span class="p">,</span>
    <span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;use_sim&#39;</span><span class="p">),</span>
    <span class="s1">&#39;&quot; == &quot;true&quot; else &quot;real_robot&quot;&#39;</span>
<span class="p">])</span>
</code></pre></div>

<p><strong>å¤æ‚æ›¿æ¢è¡¨è¾¾å¼</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># ç»„åˆå¤šä¸ªæ›¿æ¢æ„å»ºå¤æ‚è¡¨è¾¾å¼</span>
<span class="n">frame_prefix</span> <span class="o">=</span> <span class="n">PythonExpression</span><span class="p">([</span>
    <span class="s1">&#39;&quot;&quot; if &quot;&#39;</span><span class="p">,</span>
    <span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;namespace&#39;</span><span class="p">),</span>
    <span class="s1">&#39;&quot; == &quot;&quot; else &quot;&#39;</span><span class="p">,</span>
    <span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;namespace&#39;</span><span class="p">),</span>
    <span class="s1">&#39;/&quot;&#39;</span>
<span class="p">])</span>

<span class="c1"># åœ¨èŠ‚ç‚¹å‚æ•°ä¸­ä½¿ç”¨</span>
<span class="n">Node</span><span class="p">(</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span>
        <span class="s1">&#39;frame_prefix&#39;</span><span class="p">:</span> <span class="n">frame_prefix</span><span class="p">,</span>
        <span class="s1">&#39;base_frame&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">frame_prefix</span><span class="p">,</span> <span class="s1">&#39;base_link&#39;</span><span class="p">],</span>
        <span class="s1">&#39;odom_frame&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">frame_prefix</span><span class="p">,</span> <span class="s1">&#39;odom&#39;</span><span class="p">]</span>
    <span class="p">}]</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>ç¯å¢ƒå˜é‡ç®¡ç†</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># è®¾ç½®ç¯å¢ƒå˜é‡</span>
<span class="n">SetEnvironmentVariable</span><span class="p">(</span><span class="s1">&#39;RCUTILS_CONSOLE_OUTPUT_FORMAT&#39;</span><span class="p">,</span> 
                      <span class="s1">&#39;[</span><span class="si">{severity}</span><span class="s1">] [</span><span class="si">{time}</span><span class="s1">] [</span><span class="si">{name}</span><span class="s1">]: </span><span class="si">{message}</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="c1"># æ¡ä»¶è®¾ç½®ç¯å¢ƒå˜é‡</span>
<span class="n">PushEnvironmentVariable</span><span class="p">(</span>
    <span class="s1">&#39;LD_LIBRARY_PATH&#39;</span><span class="p">,</span>
    <span class="s1">&#39;/opt/custom/lib&#39;</span><span class="p">,</span>
    <span class="n">condition</span><span class="o">=</span><span class="n">IfCondition</span><span class="p">(</span><span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;use_custom_libs&#39;</span><span class="p">))</span>
<span class="p">)</span>

<span class="c1"># ä»æ–‡ä»¶åŠ è½½ç¯å¢ƒå˜é‡</span>
<span class="n">SetEnvironmentVariable</span><span class="p">(</span>
    <span class="s1">&#39;GAZEBO_MODEL_PATH&#39;</span><span class="p">,</span>
    <span class="n">Command</span><span class="p">([</span><span class="s1">&#39;cat&#39;</span><span class="p">,</span> <span class="n">FindPackageShare</span><span class="p">(</span><span class="s1">&#39;my_robot&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;config/gazebo_paths.txt&#39;</span><span class="p">)])</span>
<span class="p">)</span>
</code></pre></div>

<h2 id="73">7.3 æ¡ä»¶å¯åŠ¨ä¸äº‹ä»¶å¤„ç†</h2>
<h3 id="731">7.3.1 æ¡ä»¶è¡¨è¾¾å¼ç³»ç»Ÿ</h3>
<p>ROS2 Launch æä¾›äº†å¼ºå¤§çš„æ¡ä»¶ç³»ç»Ÿï¼Œæ”¯æŒå¤æ‚çš„å¯åŠ¨é€»è¾‘ã€‚</p>
<p><strong>åŸºç¡€æ¡ä»¶ç±»å‹</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">launch.conditions</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">IfCondition</span><span class="p">,</span> <span class="n">UnlessCondition</span><span class="p">,</span>
    <span class="n">LaunchConfigurationEquals</span><span class="p">,</span>
    <span class="n">LaunchConfigurationNotEquals</span><span class="p">,</span>
    <span class="n">EnvironmentEquals</span>
<span class="p">)</span>

<span class="c1"># åŸºç¡€å¸ƒå°”æ¡ä»¶</span>
<span class="n">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="s1">&#39;rviz2&#39;</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;rviz2&#39;</span><span class="p">,</span>
    <span class="n">condition</span><span class="o">=</span><span class="n">IfCondition</span><span class="p">(</span><span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;gui&#39;</span><span class="p">))</span>
<span class="p">)</span>

<span class="c1"># åå‘æ¡ä»¶</span>
<span class="n">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="s1">&#39;robot_state_publisher&#39;</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;robot_state_publisher&#39;</span><span class="p">,</span>
    <span class="n">condition</span><span class="o">=</span><span class="n">UnlessCondition</span><span class="p">(</span><span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;use_joint_state_publisher_gui&#39;</span><span class="p">))</span>
<span class="p">)</span>

<span class="c1"># å€¼æ¯”è¾ƒæ¡ä»¶</span>
<span class="n">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="s1">&#39;gazebo_ros&#39;</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;spawn_entity.py&#39;</span><span class="p">,</span>
    <span class="n">condition</span><span class="o">=</span><span class="n">LaunchConfigurationEquals</span><span class="p">(</span><span class="s1">&#39;simulator&#39;</span><span class="p">,</span> <span class="s1">&#39;gazebo&#39;</span><span class="p">)</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>å¤åˆæ¡ä»¶è¡¨è¾¾å¼</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">launch.conditions</span><span class="w"> </span><span class="kn">import</span> <span class="n">IfCondition</span><span class="p">,</span> <span class="n">UnlessCondition</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch.substitutions</span><span class="w"> </span><span class="kn">import</span> <span class="n">PythonExpression</span><span class="p">,</span> <span class="n">AndSubstitution</span><span class="p">,</span> <span class="n">OrSubstitution</span>

<span class="c1"># ä½¿ç”¨ Python è¡¨è¾¾å¼æ„å»ºå¤æ‚æ¡ä»¶</span>
<span class="n">complex_condition</span> <span class="o">=</span> <span class="n">IfCondition</span><span class="p">(</span>
    <span class="n">PythonExpression</span><span class="p">([</span>
        <span class="s1">&#39;&quot;&#39;</span><span class="p">,</span> <span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;robot_type&#39;</span><span class="p">),</span> <span class="s1">&#39;&quot; == &quot;mobile&quot; and &quot;&#39;</span><span class="p">,</span>
        <span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;environment&#39;</span><span class="p">),</span> <span class="s1">&#39;&quot; == &quot;outdoor&quot;&#39;</span>
    <span class="p">])</span>
<span class="p">)</span>

<span class="c1"># é€»è¾‘ç»„åˆ</span>
<span class="n">condition</span> <span class="o">=</span> <span class="n">IfCondition</span><span class="p">(</span>
    <span class="n">AndSubstitution</span><span class="p">(</span>
        <span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;use_slam&#39;</span><span class="p">),</span>
        <span class="n">NotSubstitution</span><span class="p">(</span><span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;use_localization&#39;</span><span class="p">))</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># å¤šæ¡ä»¶åˆ†æ”¯</span>
<span class="k">def</span><span class="w"> </span><span class="nf">choose_planner</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">[</span>
        <span class="n">Node</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="s1">&#39;nav2_planner&#39;</span><span class="p">,</span>
            <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;planner_server&#39;</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;planner_plugin&#39;</span><span class="p">:</span> <span class="s1">&#39;NavfnPlanner&#39;</span><span class="p">}],</span>
            <span class="n">condition</span><span class="o">=</span><span class="n">LaunchConfigurationEquals</span><span class="p">(</span><span class="s1">&#39;planner&#39;</span><span class="p">,</span> <span class="s1">&#39;navfn&#39;</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">Node</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="s1">&#39;nav2_planner&#39;</span><span class="p">,</span>
            <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;planner_server&#39;</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;planner_plugin&#39;</span><span class="p">:</span> <span class="s1">&#39;SmacPlanner2D&#39;</span><span class="p">}],</span>
            <span class="n">condition</span><span class="o">=</span><span class="n">LaunchConfigurationEquals</span><span class="p">(</span><span class="s1">&#39;planner&#39;</span><span class="p">,</span> <span class="s1">&#39;smac&#39;</span><span class="p">)</span>
        <span class="p">),</span>
        <span class="n">Node</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="s1">&#39;nav2_planner&#39;</span><span class="p">,</span>
            <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;planner_server&#39;</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span><span class="s1">&#39;planner_plugin&#39;</span><span class="p">:</span> <span class="s1">&#39;ThetaStarPlanner&#39;</span><span class="p">}],</span>
            <span class="n">condition</span><span class="o">=</span><span class="n">LaunchConfigurationEquals</span><span class="p">(</span><span class="s1">&#39;planner&#39;</span><span class="p">,</span> <span class="s1">&#39;theta_star&#39;</span><span class="p">)</span>
        <span class="p">)</span>
    <span class="p">]</span>
</code></pre></div>

<p><strong>æ¡ä»¶åŒ…å«ç»„</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ¡ä»¶ç»„ - æ‰€æœ‰åŠ¨ä½œå…±äº«ç›¸åŒæ¡ä»¶</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch.actions</span><span class="w"> </span><span class="kn">import</span> <span class="n">GroupAction</span>

<span class="n">simulation_group</span> <span class="o">=</span> <span class="n">GroupAction</span><span class="p">(</span>
    <span class="n">condition</span><span class="o">=</span><span class="n">IfCondition</span><span class="p">(</span><span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;use_sim&#39;</span><span class="p">)),</span>
    <span class="n">actions</span><span class="o">=</span><span class="p">[</span>
        <span class="c1"># Gazebo ä»¿çœŸå™¨</span>
        <span class="n">IncludeLaunchDescription</span><span class="p">(</span><span class="o">...</span><span class="p">),</span>
        <span class="c1"># ç”Ÿæˆæœºå™¨äººæ¨¡å‹</span>
        <span class="n">Node</span><span class="p">(</span><span class="n">package</span><span class="o">=</span><span class="s1">&#39;gazebo_ros&#39;</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;spawn_entity.py&#39;</span><span class="p">),</span>
        <span class="c1"># ä»¿çœŸæ—¶é’Ÿ</span>
        <span class="n">Node</span><span class="p">(</span><span class="n">package</span><span class="o">=</span><span class="s1">&#39;gazebo_ros&#39;</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;sim_time_publisher&#39;</span><span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="732">7.3.2 äº‹ä»¶å¤„ç†å™¨æ¶æ„</h3>
<p>äº‹ä»¶ç³»ç»Ÿæ˜¯ Launch åŠ¨æ€è¡Œä¸ºçš„æ ¸å¿ƒã€‚</p>
<p><strong>äº‹ä»¶ç±»å‹å±‚æ¬¡</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>Event (åŸºç±»)
â”œâ”€â”€ ProcessEvent
â”‚   â”œâ”€â”€ ProcessStarted
â”‚   â”œâ”€â”€ ProcessExited
â”‚   â””â”€â”€ ProcessStdout/Stderr
â”œâ”€â”€ ExecutionEvent  
â”‚   â”œâ”€â”€ ExecutionComplete
â”‚   â””â”€â”€ Shutdown
â””â”€â”€ LifecycleEvent
    â”œâ”€â”€ StateTransition
    â””â”€â”€ ChangeState
</code></pre></div>

<p><strong>å¸¸ç”¨äº‹ä»¶å¤„ç†å™¨</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">launch.event_handlers</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">OnProcessStart</span><span class="p">,</span> <span class="n">OnProcessExit</span><span class="p">,</span>
    <span class="n">OnProcessIO</span><span class="p">,</span> <span class="n">OnExecutionComplete</span><span class="p">,</span>
    <span class="n">OnShutdown</span>
<span class="p">)</span>

<span class="c1"># è¿›ç¨‹å¯åŠ¨äº‹ä»¶</span>
<span class="n">RegisterEventHandler</span><span class="p">(</span>
    <span class="n">OnProcessStart</span><span class="p">(</span>
        <span class="n">target_action</span><span class="o">=</span><span class="n">robot_state_publisher</span><span class="p">,</span>
        <span class="n">on_start</span><span class="o">=</span><span class="p">[</span>
            <span class="n">LogInfo</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Robot state publisher started&#39;</span><span class="p">),</span>
            <span class="c1"># å¯åŠ¨ä¾èµ–èŠ‚ç‚¹</span>
            <span class="n">Node</span><span class="p">(</span><span class="n">package</span><span class="o">=</span><span class="s1">&#39;tf2_ros&#39;</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;static_transform_publisher&#39;</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="c1"># è¿›ç¨‹é€€å‡ºäº‹ä»¶</span>
<span class="n">RegisterEventHandler</span><span class="p">(</span>
    <span class="n">OnProcessExit</span><span class="p">(</span>
        <span class="n">target_action</span><span class="o">=</span><span class="n">navigation_node</span><span class="p">,</span>
        <span class="n">on_exit</span><span class="o">=</span><span class="p">[</span>
            <span class="n">LogInfo</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Navigation node exited&#39;</span><span class="p">),</span>
            <span class="c1"># æ ¹æ®é€€å‡ºç é‡‡å–ä¸åŒè¡ŒåŠ¨</span>
            <span class="n">EmitEvent</span><span class="p">(</span>
                <span class="n">event</span><span class="o">=</span><span class="n">Shutdown</span><span class="p">(</span><span class="n">reason</span><span class="o">=</span><span class="s1">&#39;Navigation failed&#39;</span><span class="p">)</span>
            <span class="p">)</span> <span class="k">if</span> <span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;critical_nav&#39;</span><span class="p">)</span> <span class="k">else</span> <span class="n">LogInfo</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Continuing...&#39;</span><span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>è‡ªå®šä¹‰äº‹ä»¶å¤„ç†</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">CustomEventHandler</span><span class="p">(</span><span class="n">EventHandler</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">target_action</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target_action</span> <span class="o">=</span> <span class="n">target_action</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="c1"># è‡ªå®šä¹‰äº‹ä»¶å¤„ç†é€»è¾‘</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">ProcessExited</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># é”™è¯¯å¤„ç†</span>
                <span class="k">return</span> <span class="p">[</span>
                    <span class="n">LogError</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Process failed with code </span><span class="si">{</span><span class="n">event</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span>
                    <span class="c1"># å°è¯•é‡å¯</span>
                    <span class="n">TimerAction</span><span class="p">(</span>
                        <span class="n">period</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
                        <span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_target_action</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">]</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div>

<p><strong>äº‹ä»¶é“¾å¼å¤„ç†</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># åˆ›å»ºäº‹ä»¶å¤„ç†é“¾</span>
<span class="k">def</span><span class="w"> </span><span class="nf">create_restart_handler</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">max_restarts</span><span class="o">=</span><span class="mi">3</span><span class="p">):</span>
    <span class="n">restart_count</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">on_exit</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
        <span class="n">restart_count</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">restart_count</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">max_restarts</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">LogInfo</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Restarting node (attempt </span><span class="si">{</span><span class="n">restart_count</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">)&#39;</span><span class="p">),</span>
                <span class="n">TimerAction</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="n">node</span><span class="p">])</span>
            <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="n">LogError</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Max restart attempts reached&#39;</span><span class="p">),</span>
                <span class="n">EmitEvent</span><span class="p">(</span><span class="n">event</span><span class="o">=</span><span class="n">Shutdown</span><span class="p">())</span>
            <span class="p">]</span>

    <span class="k">return</span> <span class="n">OnProcessExit</span><span class="p">(</span>
        <span class="n">target_action</span><span class="o">=</span><span class="n">node</span><span class="p">,</span>
        <span class="n">on_exit</span><span class="o">=</span><span class="n">on_exit</span>
    <span class="p">)</span>
</code></pre></div>

<h3 id="733">7.3.3 ç”Ÿå‘½å‘¨æœŸèŠ‚ç‚¹ç®¡ç†</h3>
<p>ç”Ÿå‘½å‘¨æœŸèŠ‚ç‚¹æä¾›äº†æ ‡å‡†åŒ–çš„çŠ¶æ€ç®¡ç†æ¥å£ã€‚</p>
<p><strong>ç”Ÿå‘½å‘¨æœŸçŠ¶æ€æœº</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>Unconfigured â†’ Configuring â†’ Inactive
     â†‘              â†“            â†“
     â†â”€â”€â”€â”€â”€â”€â”€ CleaningUp    Activating
                    â†‘            â†“
                    â†â”€â”€â”€â”€â”€â”€ Active
                    â†‘            â†“
                    â†â”€â”€â”€ Deactivating
                    â†‘            â†“
                    â†â”€â”€â”€â”€ ShuttingDown
                             â†“
                          Finalized
</code></pre></div>

<p><strong>ç”Ÿå‘½å‘¨æœŸèŠ‚ç‚¹å¯åŠ¨</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">launch_ros.actions</span><span class="w"> </span><span class="kn">import</span> <span class="n">LifecycleNode</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch.actions</span><span class="w"> </span><span class="kn">import</span> <span class="n">EmitEvent</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch_ros.events.lifecycle</span><span class="w"> </span><span class="kn">import</span> <span class="n">ChangeState</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">lifecycle_msgs.msg</span><span class="w"> </span><span class="kn">import</span> <span class="n">Transition</span>

<span class="n">lifecycle_node</span> <span class="o">=</span> <span class="n">LifecycleNode</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="s1">&#39;nav2_controller&#39;</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;controller_server&#39;</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;controller_server&#39;</span><span class="p">,</span>
    <span class="n">namespace</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">[</span><span class="n">controller_params_file</span><span class="p">],</span>
    <span class="n">remappings</span><span class="o">=</span><span class="p">[(</span><span class="s1">&#39;/tf&#39;</span><span class="p">,</span> <span class="s1">&#39;tf&#39;</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;/tf_static&#39;</span><span class="p">,</span> <span class="s1">&#39;tf_static&#39;</span><span class="p">)]</span>
<span class="p">)</span>

<span class="c1"># è‡ªåŠ¨é…ç½®å’Œæ¿€æ´»</span>
<span class="n">configure_event</span> <span class="o">=</span> <span class="n">EmitEvent</span><span class="p">(</span>
    <span class="n">event</span><span class="o">=</span><span class="n">ChangeState</span><span class="p">(</span>
        <span class="n">lifecycle_node_matcher</span><span class="o">=</span><span class="n">matches_action</span><span class="p">(</span><span class="n">lifecycle_node</span><span class="p">),</span>
        <span class="n">transition_id</span><span class="o">=</span><span class="n">Transition</span><span class="o">.</span><span class="n">TRANSITION_CONFIGURE</span>
    <span class="p">)</span>
<span class="p">)</span>

<span class="n">activate_event</span> <span class="o">=</span> <span class="n">EmitEvent</span><span class="p">(</span>
    <span class="n">event</span><span class="o">=</span><span class="n">ChangeState</span><span class="p">(</span>
        <span class="n">lifecycle_node_matcher</span><span class="o">=</span><span class="n">matches_action</span><span class="p">(</span><span class="n">lifecycle_node</span><span class="p">),</span>
        <span class="n">transition_id</span><span class="o">=</span><span class="n">Transition</span><span class="o">.</span><span class="n">TRANSITION_ACTIVATE</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>ç”Ÿå‘½å‘¨æœŸç®¡ç†å™¨</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æ‰¹é‡ç®¡ç†ç”Ÿå‘½å‘¨æœŸèŠ‚ç‚¹</span>
<span class="n">Node</span><span class="p">(</span>
    <span class="n">package</span><span class="o">=</span><span class="s1">&#39;nav2_lifecycle_manager&#39;</span><span class="p">,</span>
    <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;lifecycle_manager&#39;</span><span class="p">,</span>
    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;lifecycle_manager_navigation&#39;</span><span class="p">,</span>
    <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span>
        <span class="s1">&#39;autostart&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
        <span class="s1">&#39;node_names&#39;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s1">&#39;controller_server&#39;</span><span class="p">,</span>
            <span class="s1">&#39;planner_server&#39;</span><span class="p">,</span>
            <span class="s1">&#39;recoveries_server&#39;</span><span class="p">,</span>
            <span class="s1">&#39;bt_navigator&#39;</span>
        <span class="p">],</span>
        <span class="s1">&#39;bond_timeout&#39;</span><span class="p">:</span> <span class="mf">4.0</span><span class="p">,</span>
        <span class="s1">&#39;attempt_respawn_reconnection&#39;</span><span class="p">:</span> <span class="kc">True</span>
    <span class="p">}]</span>
<span class="p">)</span>
</code></pre></div>

<h3 id="734">7.3.4 åŠ¨æ€ç³»ç»Ÿé‡é…ç½®</h3>
<p>Launch ç³»ç»Ÿæ”¯æŒè¿è¡Œæ—¶çš„åŠ¨æ€é…ç½®æ›´æ–°ã€‚</p>
<p><strong>åŠ¨æ€åŠ è½½èŠ‚ç‚¹</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span><span class="w"> </span><span class="nn">launch.actions</span><span class="w"> </span><span class="kn">import</span> <span class="n">OpaqueFunction</span>

<span class="k">def</span><span class="w"> </span><span class="nf">launch_setup</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="c1"># è¿è¡Œæ—¶å†³å®šå¯åŠ¨å“ªäº›èŠ‚ç‚¹</span>
    <span class="n">robot_count</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;robot_count&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">perform</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>

    <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">robot_count</span><span class="p">):</span>
        <span class="n">nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">Node</span><span class="p">(</span>
                <span class="n">package</span><span class="o">=</span><span class="s1">&#39;robot_controller&#39;</span><span class="p">,</span>
                <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;controller&#39;</span><span class="p">,</span>
                <span class="n">namespace</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;robot_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span>
                    <span class="s1">&#39;robot_id&#39;</span><span class="p">:</span> <span class="n">i</span><span class="p">,</span>
                    <span class="s1">&#39;total_robots&#39;</span><span class="p">:</span> <span class="n">robot_count</span>
                <span class="p">}]</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">nodes</span>

<span class="c1"># åœ¨ LaunchDescription ä¸­ä½¿ç”¨</span>
<span class="n">LaunchDescription</span><span class="p">([</span>
    <span class="n">DeclareLaunchArgument</span><span class="p">(</span><span class="s1">&#39;robot_count&#39;</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="s1">&#39;3&#39;</span><span class="p">),</span>
    <span class="n">OpaqueFunction</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">launch_setup</span><span class="p">)</span>
<span class="p">])</span>
</code></pre></div>

<p><strong>è¿è¡Œæ—¶å‚æ•°æ›´æ–°</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å‚æ•°æ›´æ–°æœåŠ¡</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ParameterUpdateHandler</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_client</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">update_parameters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="c1"># åˆ›å»ºå‚æ•°å®¢æˆ·ç«¯</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">param_client</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="s1">&#39;demo_nodes_cpp&#39;</span><span class="p">,</span>
            <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;parameter_blackboard&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s1">_param_client&#39;</span>
        <span class="p">)</span>

        <span class="c1"># æ„å»ºå‚æ•°æ›´æ–°è¯·æ±‚</span>
        <span class="n">update_actions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">update_actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">ExecuteProcess</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ros2&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">update_actions</span>

<span class="c1"># æ¡ä»¶å‚æ•°æ›´æ–°</span>
<span class="n">RegisterEventHandler</span><span class="p">(</span>
    <span class="n">OnProcessStart</span><span class="p">(</span>
        <span class="n">target_action</span><span class="o">=</span><span class="n">sensor_node</span><span class="p">,</span>
        <span class="n">on_start</span><span class="o">=</span><span class="p">[</span>
            <span class="c1"># æ ¹æ®ç¯å¢ƒåŠ¨æ€è°ƒæ•´ä¼ æ„Ÿå™¨å‚æ•°</span>
            <span class="n">OpaqueFunction</span><span class="p">(</span>
                <span class="n">function</span><span class="o">=</span><span class="k">lambda</span> <span class="n">context</span><span class="p">:</span> <span class="p">[</span>
                    <span class="n">ExecuteProcess</span><span class="p">(</span>
                        <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ros2&#39;</span><span class="p">,</span> <span class="s1">&#39;param&#39;</span><span class="p">,</span> <span class="s1">&#39;set&#39;</span><span class="p">,</span> <span class="s1">&#39;/sensor&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;range_max&#39;</span><span class="p">,</span> <span class="s1">&#39;5.0&#39;</span> <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">launch_configurations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;indoor&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;true&#39;</span> <span class="k">else</span> <span class="s1">&#39;50.0&#39;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">]</span>
    <span class="p">)</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>çƒ­é‡è½½é…ç½®</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># ç›‘å¬é…ç½®æ–‡ä»¶å˜åŒ–å¹¶é‡è½½</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">inotify.adapters</span>

<span class="k">class</span><span class="w"> </span><span class="nc">ConfigWatcher</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_file</span><span class="p">,</span> <span class="n">node_action</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config_file</span> <span class="o">=</span> <span class="n">config_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_action</span> <span class="o">=</span> <span class="n">node_action</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_watcher</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">RegisterEventHandler</span><span class="p">(</span>
            <span class="n">OnProcessStart</span><span class="p">(</span>
                <span class="n">target_action</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">node_action</span><span class="p">,</span>
                <span class="n">on_start</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">ExecuteProcess</span><span class="p">(</span>
                        <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;python3&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;&#39;&#39;</span>
<span class="s1">import inotify.adapters</span>
<span class="s1">import subprocess</span>

<span class="s1">i = inotify.adapters.Inotify()</span>
<span class="s1">i.add_watch(&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config_file</span><span class="si">}</span><span class="s1">&quot;)</span>

<span class="s1">for event in i.event_gen():</span>
<span class="s1">    if event and &quot;IN_MODIFY&quot; in event[1]:</span>
<span class="s1">        subprocess.run([&quot;ros2&quot;, &quot;param&quot;, &quot;load&quot;, </span>
<span class="s1">                       &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">node_action</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s1">&quot;, &quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config_file</span><span class="si">}</span><span class="s1">&quot;])</span>
<span class="s1">                       &#39;&#39;&#39;</span><span class="p">],</span>
                        <span class="n">shell</span><span class="o">=</span><span class="kc">False</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>
</code></pre></div>

<h2 id="74">7.4 åˆ†å¸ƒå¼ç³»ç»Ÿéƒ¨ç½²</h2>
<p>ROS2 çš„åˆ†å¸ƒå¼éƒ¨ç½²èƒ½åŠ›æ˜¯å…¶ç›¸å¯¹äº ROS1 çš„é‡å¤§æ”¹è¿›ä¹‹ä¸€ã€‚åŸºäº DDS çš„é€šä¿¡æœºåˆ¶ä½¿å¾—å¤šæœºéƒ¨ç½²å˜å¾—æ›´åŠ çµæ´»å’Œå¯é ï¼Œæ— éœ€ä¸­å¿ƒåŒ–çš„ Master èŠ‚ç‚¹ã€‚æœ¬èŠ‚å°†æ·±å…¥æ¢è®¨å¦‚ä½•è®¾è®¡å’Œå®æ–½å¤§è§„æ¨¡åˆ†å¸ƒå¼æœºå™¨äººç³»ç»Ÿã€‚</p>
<h3 id="741">7.4.1 å¤šæœºéƒ¨ç½²æ¶æ„</h3>
<p>åˆ†å¸ƒå¼ ROS2 ç³»ç»Ÿçš„æ¶æ„è®¾è®¡éœ€è¦è€ƒè™‘ç½‘ç»œæ‹“æ‰‘ã€æ•…éšœå®¹é”™å’Œæ€§èƒ½ä¼˜åŒ–ç­‰å¤šä¸ªç»´åº¦ã€‚</p>
<p><strong>å…¸å‹éƒ¨ç½²æ‹“æ‰‘</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ§åˆ¶ä¸­å¿ƒ (Control Center)          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ Mission  â”‚  â”‚Monitoringâ”‚  â”‚ Operator â”‚         â”‚
â”‚  â”‚ Planner  â”‚  â”‚  System  â”‚  â”‚ Interfaceâ”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                    DDS Domain 0
                         â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                    â”‚                    â”‚
â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”
â”‚Robot 1 â”‚          â”‚Robot 2 â”‚          â”‚Robot N â”‚
â”‚Domain 1â”‚          â”‚Domain 2â”‚          â”‚Domain Nâ”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚-Sensorsâ”‚          â”‚-Sensorsâ”‚          â”‚-Sensorsâ”‚
â”‚-Controlâ”‚          â”‚-Controlâ”‚          â”‚-Controlâ”‚
â”‚-Nav    â”‚          â”‚-Nav    â”‚          â”‚-Nav    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>DDS Domain ID è§„åˆ’</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># domain_config.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DomainConfiguration</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;DDS Domain ID åˆ†é…ç­–ç•¥&quot;&quot;&quot;</span>

    <span class="c1"># åŠŸèƒ½åŸŸåˆ’åˆ†</span>
    <span class="n">DOMAINS</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;control&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>        <span class="c1"># æ§åˆ¶ä¸­å¿ƒåŸŸ</span>
        <span class="s1">&#39;perception&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>    <span class="c1"># æ„ŸçŸ¥å¤„ç†åŸŸ</span>
        <span class="s1">&#39;planning&#39;</span><span class="p">:</span> <span class="mi">20</span><span class="p">,</span>      <span class="c1"># è§„åˆ’è®¡ç®—åŸŸ</span>
        <span class="s1">&#39;fleet&#39;</span><span class="p">:</span> <span class="mi">30</span><span class="p">,</span>        <span class="c1"># è½¦é˜Ÿç®¡ç†åŸŸ</span>
    <span class="p">}</span>

    <span class="c1"># æœºå™¨äººåŸŸåˆ†é…ï¼ˆåŸºç¡€åŸŸ + æœºå™¨äººIDï¼‰</span>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_robot_domain</span><span class="p">(</span><span class="n">robot_id</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="n">BASE_ROBOT_DOMAIN</span> <span class="o">=</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="n">BASE_ROBOT_DOMAIN</span> <span class="o">+</span> <span class="n">robot_id</span>

    <span class="c1"># è·¨åŸŸæ¡¥æ¥é…ç½®</span>
    <span class="n">BRIDGE_CONFIG</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;control_to_robot&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;from_domain&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;to_domain_pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;10*&#39;</span><span class="p">,</span>  <span class="c1"># æ‰€æœ‰æœºå™¨äººåŸŸ</span>
            <span class="s1">&#39;topics&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;/mission_goal&#39;</span><span class="p">,</span> <span class="s1">&#39;/emergency_stop&#39;</span><span class="p">],</span>
            <span class="s1">&#39;services&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;/reconfigure&#39;</span><span class="p">,</span> <span class="s1">&#39;/shutdown&#39;</span><span class="p">]</span>
        <span class="p">},</span>
        <span class="s1">&#39;robot_to_control&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;from_domain_pattern&#39;</span><span class="p">:</span> <span class="s1">&#39;10*&#39;</span><span class="p">,</span>
            <span class="s1">&#39;to_domain&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s1">&#39;topics&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;/status&#39;</span><span class="p">,</span> <span class="s1">&#39;/diagnostics&#39;</span><span class="p">,</span> <span class="s1">&#39;/telemetry&#39;</span><span class="p">],</span>
            <span class="s1">&#39;qos&#39;</span><span class="p">:</span> <span class="s1">&#39;sensor_data&#39;</span>  <span class="c1"># ä½¿ç”¨ä¼ æ„Ÿå™¨QoSé…ç½®</span>
        <span class="p">}</span>
    <span class="p">}</span>
</code></pre></div>

<p><strong>Launch æ–‡ä»¶å¤šæœºé…ç½®</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># multi_robot_launch.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="c1"># å£°æ˜æœºå™¨äººæ•°é‡å’Œé…ç½®</span>
    <span class="n">num_robots_arg</span> <span class="o">=</span> <span class="n">DeclareLaunchArgument</span><span class="p">(</span>
        <span class="s1">&#39;num_robots&#39;</span><span class="p">,</span> <span class="n">default_value</span><span class="o">=</span><span class="s1">&#39;3&#39;</span><span class="p">,</span>
        <span class="n">description</span><span class="o">=</span><span class="s1">&#39;Number of robots in the fleet&#39;</span>
    <span class="p">)</span>

    <span class="c1"># ç½‘ç»œé…ç½®å‚æ•°</span>
    <span class="n">network_config</span> <span class="o">=</span> <span class="n">DeclareLaunchArgument</span><span class="p">(</span>
        <span class="s1">&#39;network_config&#39;</span><span class="p">,</span> 
        <span class="n">default_value</span><span class="o">=</span><span class="n">PathJoinSubstitution</span><span class="p">([</span>
            <span class="n">FindPackageShare</span><span class="p">(</span><span class="s1">&#39;fleet_manager&#39;</span><span class="p">),</span>
            <span class="s1">&#39;config&#39;</span><span class="p">,</span> <span class="s1">&#39;network.yaml&#39;</span>
        <span class="p">])</span>
    <span class="p">)</span>

    <span class="c1"># åŠ¨æ€ç”Ÿæˆæœºå™¨äººå¯åŠ¨é…ç½®</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">launch_robots</span><span class="p">(</span><span class="n">context</span><span class="p">):</span>
        <span class="n">num_robots</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;num_robots&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">perform</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>
        <span class="n">robot_launches</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_robots</span><span class="p">):</span>
            <span class="c1"># æ¯ä¸ªæœºå™¨äººç‹¬ç«‹çš„åŸŸå’Œé…ç½®</span>
            <span class="n">robot_launches</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">GroupAction</span><span class="p">(</span>
                    <span class="n">actions</span><span class="o">=</span><span class="p">[</span>
                        <span class="c1"># è®¾ç½®åŸŸID</span>
                        <span class="n">SetEnvironmentVariable</span><span class="p">(</span>
                            <span class="s1">&#39;ROS_DOMAIN_ID&#39;</span><span class="p">,</span> 
                            <span class="nb">str</span><span class="p">(</span><span class="mi">100</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
                        <span class="p">),</span>

                        <span class="c1"># å¯åŠ¨æœºå™¨äººèŠ‚ç‚¹ç»„</span>
                        <span class="n">IncludeLaunchDescription</span><span class="p">(</span>
                            <span class="n">PythonLaunchDescriptionSource</span><span class="p">([</span>
                                <span class="n">FindPackageShare</span><span class="p">(</span><span class="s1">&#39;robot_bringup&#39;</span><span class="p">),</span>
                                <span class="s1">&#39;/launch/robot.launch.py&#39;</span>
                            <span class="p">]),</span>
                            <span class="n">launch_arguments</span><span class="o">=</span><span class="p">{</span>
                                <span class="s1">&#39;robot_id&#39;</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
                                <span class="s1">&#39;robot_name&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;robot_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;namespace&#39;</span><span class="p">:</span> <span class="sa">f</span><span class="s1">&#39;/robot_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;use_sim_time&#39;</span><span class="p">:</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span>
                                <span class="s1">&#39;config_file&#39;</span><span class="p">:</span> <span class="n">PathJoinSubstitution</span><span class="p">([</span>
                                    <span class="n">FindPackageShare</span><span class="p">(</span><span class="s1">&#39;fleet_config&#39;</span><span class="p">),</span>
                                    <span class="s1">&#39;robots&#39;</span><span class="p">,</span> <span class="sa">f</span><span class="s1">&#39;robot_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">.yaml&#39;</span>
                                <span class="p">])</span>
                            <span class="p">}</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                        <span class="p">),</span>

                        <span class="c1"># DDSåŸŸæ¡¥æ¥å™¨</span>
                        <span class="n">Node</span><span class="p">(</span>
                            <span class="n">package</span><span class="o">=</span><span class="s1">&#39;domain_bridge&#39;</span><span class="p">,</span>
                            <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;domain_bridge&#39;</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;bridge_robot_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                            <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span>
                                <span class="s1">&#39;from_domain&#39;</span><span class="p">:</span> <span class="mi">100</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span>
                                <span class="s1">&#39;to_domain&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="s1">&#39;config_file&#39;</span><span class="p">:</span> <span class="n">LaunchConfiguration</span><span class="p">(</span><span class="s1">&#39;network_config&#39;</span><span class="p">)</span>
                            <span class="p">}]</span>
                        <span class="p">)</span>
                    <span class="p">],</span>
                    <span class="n">scoped</span><span class="o">=</span><span class="kc">True</span>  <span class="c1"># ç¯å¢ƒå˜é‡ä½œç”¨åŸŸéš”ç¦»</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">robot_launches</span>

    <span class="k">return</span> <span class="n">LaunchDescription</span><span class="p">([</span>
        <span class="n">num_robots_arg</span><span class="p">,</span>
        <span class="n">network_config</span><span class="p">,</span>
        <span class="n">OpaqueFunction</span><span class="p">(</span><span class="n">function</span><span class="o">=</span><span class="n">launch_robots</span><span class="p">)</span>
    <span class="p">])</span>
</code></pre></div>

<p><strong>æ•…éšœå®¹é”™è®¾è®¡</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># åˆ†å¸ƒå¼ç³»ç»Ÿç›‘æ§å’Œæ•…éšœæ¢å¤</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DistributedSystemMonitor</span><span class="p">:</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_timeout</span> <span class="o">=</span> <span class="mf">5.0</span>  <span class="c1"># ç§’</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">robot_status</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_monitor_node</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">Node</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="s1">&#39;fleet_monitor&#39;</span><span class="p">,</span>
            <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;health_monitor&#39;</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span>
                <span class="s1">&#39;heartbeat_timeout&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">heartbeat_timeout</span><span class="p">,</span>
                <span class="s1">&#39;recovery_strategy&#39;</span><span class="p">:</span> <span class="s1">&#39;restart&#39;</span><span class="p">,</span>  <span class="c1"># restart/isolate/alert</span>
                <span class="s1">&#39;max_recovery_attempts&#39;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
                <span class="s1">&#39;alert_topics&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;/system/alerts&#39;</span><span class="p">,</span> <span class="s1">&#39;/operator/notifications&#39;</span><span class="p">]</span>
            <span class="p">}],</span>
            <span class="c1"># æ•…éšœæ—¶çš„æ¢å¤åŠ¨ä½œ</span>
            <span class="n">on_exit</span><span class="o">=</span><span class="p">[</span>
                <span class="n">LogError</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Health monitor crashed, restarting...&#39;</span><span class="p">),</span>
                <span class="n">TimerAction</span><span class="p">(</span>
                    <span class="n">period</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                    <span class="n">actions</span><span class="o">=</span><span class="p">[</span>
                        <span class="c1"># é€’å½’é‡å¯ç›‘æ§èŠ‚ç‚¹</span>
                        <span class="n">Node</span><span class="p">(</span>
                            <span class="n">package</span><span class="o">=</span><span class="s1">&#39;fleet_monitor&#39;</span><span class="p">,</span>
                            <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;health_monitor&#39;</span><span class="p">,</span>
                            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;health_monitor_recovery&#39;</span>
                        <span class="p">)</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
</code></pre></div>

<h3 id="742">7.4.2 ç½‘ç»œé…ç½®ä¸å‘ç°</h3>
<p>DDS çš„è‡ªåŠ¨å‘ç°æœºåˆ¶ç®€åŒ–äº†ç½‘ç»œé…ç½®ï¼Œä½†åœ¨å¤§è§„æ¨¡éƒ¨ç½²æ—¶éœ€è¦ç²¾å¿ƒä¼˜åŒ–ã€‚</p>
<p><strong>DDS å‘ç°é…ç½®</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">&lt;!-- dds_profiles.xml --&gt;</span>
<span class="nt">&lt;dds&gt;</span>
<span class="w">    </span><span class="nt">&lt;profiles&gt;</span>
<span class="w">        </span><span class="cm">&lt;!-- å¤§è§„æ¨¡éƒ¨ç½²ä¼˜åŒ–é…ç½® --&gt;</span>
<span class="w">        </span><span class="nt">&lt;participant</span><span class="w"> </span><span class="na">profile_name=</span><span class="s">&quot;large_scale_participant&quot;</span><span class="nt">&gt;</span>
<span class="w">            </span><span class="nt">&lt;rtps&gt;</span>
<span class="w">                </span><span class="nt">&lt;builtin&gt;</span>
<span class="w">                    </span><span class="cm">&lt;!-- å‘ç°åè®®é…ç½® --&gt;</span>
<span class="w">                    </span><span class="nt">&lt;discovery_config&gt;</span>
<span class="w">                        </span><span class="cm">&lt;!-- åˆå§‹æ’­å‘å»¶è¿Ÿ --&gt;</span>
<span class="w">                        </span><span class="nt">&lt;initialAnnouncements&gt;</span>
<span class="w">                            </span><span class="nt">&lt;count&gt;</span>5<span class="nt">&lt;/count&gt;</span>
<span class="w">                            </span><span class="nt">&lt;period&gt;</span>
<span class="w">                                </span><span class="nt">&lt;sec&gt;</span>0<span class="nt">&lt;/sec&gt;</span>
<span class="w">                                </span><span class="nt">&lt;nanosec&gt;</span>100000000<span class="nt">&lt;/nanosec&gt;</span>
<span class="w">                            </span><span class="nt">&lt;/period&gt;</span>
<span class="w">                        </span><span class="nt">&lt;/initialAnnouncements&gt;</span>

<span class="w">                        </span><span class="cm">&lt;!-- ç§Ÿçº¦æ—¶é•¿ --&gt;</span>
<span class="w">                        </span><span class="nt">&lt;leaseDuration&gt;</span>
<span class="w">                            </span><span class="nt">&lt;sec&gt;</span>10<span class="nt">&lt;/sec&gt;</span>
<span class="w">                        </span><span class="nt">&lt;/leaseDuration&gt;</span>

<span class="w">                        </span><span class="cm">&lt;!-- å¿ƒè·³å‘¨æœŸ --&gt;</span>
<span class="w">                        </span><span class="nt">&lt;leaseAnnouncement&gt;</span>
<span class="w">                            </span><span class="nt">&lt;sec&gt;</span>3<span class="nt">&lt;/sec&gt;</span>
<span class="w">                        </span><span class="nt">&lt;/leaseAnnouncement&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/discovery_config&gt;</span>

<span class="w">                    </span><span class="cm">&lt;!-- ä½¿ç”¨æœåŠ¡å™¨è¾…åŠ©å‘ç° --&gt;</span>
<span class="w">                    </span><span class="nt">&lt;discovery_config&gt;</span>
<span class="w">                        </span><span class="nt">&lt;discoveryProtocol&gt;</span>SIMPLE<span class="nt">&lt;/discoveryProtocol&gt;</span>
<span class="w">                        </span><span class="nt">&lt;discoveryServersList&gt;</span>
<span class="w">                            </span><span class="nt">&lt;RemoteServer</span><span class="w"> </span><span class="na">prefix=</span><span class="s">&quot;44.53.00.5f.45.50.52.4f.53.49.4d.41&quot;</span><span class="nt">&gt;</span>
<span class="w">                                </span><span class="nt">&lt;metatrafficUnicastLocatorList&gt;</span>
<span class="w">                                    </span><span class="nt">&lt;locator&gt;</span>
<span class="w">                                        </span><span class="nt">&lt;udpv4&gt;</span>
<span class="w">                                            </span><span class="nt">&lt;address&gt;</span>192.168.1.100<span class="nt">&lt;/address&gt;</span>
<span class="w">                                            </span><span class="nt">&lt;port&gt;</span>11811<span class="nt">&lt;/port&gt;</span>
<span class="w">                                        </span><span class="nt">&lt;/udpv4&gt;</span>
<span class="w">                                    </span><span class="nt">&lt;/locator&gt;</span>
<span class="w">                                </span><span class="nt">&lt;/metatrafficUnicastLocatorList&gt;</span>
<span class="w">                            </span><span class="nt">&lt;/RemoteServer&gt;</span>
<span class="w">                        </span><span class="nt">&lt;/discoveryServersList&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/discovery_config&gt;</span>
<span class="w">                </span><span class="nt">&lt;/builtin&gt;</span>

<span class="w">                </span><span class="cm">&lt;!-- ä¼ è¾“å±‚é…ç½® --&gt;</span>
<span class="w">                </span><span class="nt">&lt;useBuiltinTransports&gt;</span>false<span class="nt">&lt;/useBuiltinTransports&gt;</span>
<span class="w">                </span><span class="nt">&lt;userTransports&gt;</span>
<span class="w">                    </span><span class="cm">&lt;!-- UDPä¼ è¾“é…ç½® --&gt;</span>
<span class="w">                    </span><span class="nt">&lt;transport_id&gt;</span>udp_transport<span class="nt">&lt;/transport_id&gt;</span>
<span class="w">                    </span><span class="nt">&lt;type&gt;</span>UDPv4<span class="nt">&lt;/type&gt;</span>
<span class="w">                    </span><span class="nt">&lt;socket_buffer_size&gt;</span>10485760<span class="nt">&lt;/socket_buffer_size&gt;</span>

<span class="w">                    </span><span class="cm">&lt;!-- å…±äº«å†…å­˜ä¼ è¾“ï¼ˆåŒä¸»æœºä¼˜åŒ–ï¼‰ --&gt;</span>
<span class="w">                    </span><span class="nt">&lt;transport_id&gt;</span>shm_transport<span class="nt">&lt;/transport_id&gt;</span>
<span class="w">                    </span><span class="nt">&lt;type&gt;</span>SHM<span class="nt">&lt;/type&gt;</span>
<span class="w">                    </span><span class="nt">&lt;segment_size&gt;</span>10485760<span class="nt">&lt;/segment_size&gt;</span>
<span class="w">                </span><span class="nt">&lt;/userTransports&gt;</span>
<span class="w">            </span><span class="nt">&lt;/rtps&gt;</span>
<span class="w">        </span><span class="nt">&lt;/participant&gt;</span>
<span class="w">    </span><span class="nt">&lt;/profiles&gt;</span>
<span class="nt">&lt;/dds&gt;</span>
</code></pre></div>

<p><strong>ç½‘ç»œæ¥å£ç»‘å®š</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># network_interface_config.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">configure_network_interfaces</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;é…ç½®ç‰¹å®šç½‘ç»œæ¥å£ç”¨äº ROS2 é€šä¿¡&quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="p">[</span>
        <span class="c1"># ç»‘å®šåˆ°ç‰¹å®šç½‘ç»œæ¥å£</span>
        <span class="n">SetEnvironmentVariable</span><span class="p">(</span>
            <span class="s1">&#39;CYCLONEDDS_URI&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;&lt;CycloneDDS&gt;</span>
<span class="sd">                &lt;Domain&gt;</span>
<span class="sd">                    &lt;General&gt;</span>
<span class="sd">                        &lt;NetworkInterfaceAddress&gt;eth0&lt;/NetworkInterfaceAddress&gt;</span>
<span class="sd">                        &lt;MulticastRecvNetworkInterfaceAddresses&gt;eth0&lt;/MulticastRecvNetworkInterfaceAddresses&gt;</span>
<span class="sd">                    &lt;/General&gt;</span>
<span class="sd">                &lt;/Domain&gt;</span>
<span class="sd">                &lt;Discovery&gt;</span>
<span class="sd">                    &lt;ParticipantIndex&gt;auto&lt;/ParticipantIndex&gt;</span>
<span class="sd">                    &lt;MaxAutoParticipantIndex&gt;1000&lt;/MaxAutoParticipantIndex&gt;</span>
<span class="sd">                &lt;/Discovery&gt;</span>
<span class="sd">            &lt;/CycloneDDS&gt;&#39;&#39;&#39;</span>
        <span class="p">),</span>

        <span class="c1"># FastDDS é…ç½®</span>
        <span class="n">SetEnvironmentVariable</span><span class="p">(</span>
            <span class="s1">&#39;FASTRTPS_DEFAULT_PROFILES_FILE&#39;</span><span class="p">,</span>
            <span class="n">FindPackageShare</span><span class="p">(</span><span class="s1">&#39;fleet_config&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;config/fastdds_profile.xml&#39;</span><span class="p">)</span>
        <span class="p">),</span>

        <span class="c1"># ç¦ç”¨å¤šæ’­ï¼ˆåœ¨æŸäº›ç½‘ç»œç¯å¢ƒä¸‹ï¼‰</span>
        <span class="n">SetEnvironmentVariable</span><span class="p">(</span>
            <span class="s1">&#39;ROS_DISABLE_MULTICAST&#39;</span><span class="p">,</span> <span class="s1">&#39;true&#39;</span>
        <span class="p">)</span>
    <span class="p">]</span>
</code></pre></div>

<p><strong>å‘ç°æœåŠ¡å™¨æ¨¡å¼</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># discovery_server_launch.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_launch_description</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ä½¿ç”¨ Discovery Server å‡å°‘ç½‘ç»œæµé‡&quot;&quot;&quot;</span>

    <span class="c1"># å¯åŠ¨å‘ç°æœåŠ¡å™¨</span>
    <span class="n">discovery_server</span> <span class="o">=</span> <span class="n">ExecuteProcess</span><span class="p">(</span>
        <span class="n">cmd</span><span class="o">=</span><span class="p">[</span>
            <span class="s1">&#39;fastdds&#39;</span><span class="p">,</span> <span class="s1">&#39;discovery&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--server-id&#39;</span><span class="p">,</span> <span class="s1">&#39;0&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--ip-address&#39;</span><span class="p">,</span> <span class="s1">&#39;192.168.1.100&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--port&#39;</span><span class="p">,</span> <span class="s1">&#39;11811&#39;</span><span class="p">,</span>
            <span class="s1">&#39;--backup-file&#39;</span><span class="p">,</span> <span class="s1">&#39;discovery_backup.json&#39;</span>
        <span class="p">],</span>
        <span class="n">output</span><span class="o">=</span><span class="s1">&#39;screen&#39;</span>
    <span class="p">)</span>

    <span class="c1"># é…ç½®å®¢æˆ·ç«¯è¿æ¥åˆ°å‘ç°æœåŠ¡å™¨</span>
    <span class="n">client_env</span> <span class="o">=</span> <span class="n">SetEnvironmentVariable</span><span class="p">(</span>
        <span class="s1">&#39;ROS_DISCOVERY_SERVER&#39;</span><span class="p">,</span>
        <span class="s1">&#39;192.168.1.100:11811&#39;</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">LaunchDescription</span><span class="p">([</span>
        <span class="n">discovery_server</span><span class="p">,</span>
        <span class="n">client_env</span><span class="p">,</span>
        <span class="c1"># å¯åŠ¨èŠ‚ç‚¹å°†è‡ªåŠ¨ä½¿ç”¨å‘ç°æœåŠ¡å™¨</span>
        <span class="n">Node</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="s1">&#39;demo_nodes_cpp&#39;</span><span class="p">,</span>
            <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;talker&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="s1">&#39;talker&#39;</span>
        <span class="p">)</span>
    <span class="p">])</span>
</code></pre></div>

<p><strong>ç½‘ç»œè´¨é‡ç›‘æ§</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># ç½‘ç»œè´¨é‡ç›‘æ§èŠ‚ç‚¹</span>
<span class="k">class</span><span class="w"> </span><span class="nc">NetworkQualityMonitor</span><span class="p">(</span><span class="n">Node</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="s1">&#39;network_monitor&#39;</span><span class="p">)</span>

        <span class="c1"># åˆ›å»ºè¯Šæ–­å‘å¸ƒå™¨</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics_pub</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_publisher</span><span class="p">(</span>
            <span class="n">DiagnosticArray</span><span class="p">,</span> <span class="s1">&#39;/diagnostics&#39;</span><span class="p">,</span> <span class="mi">10</span>
        <span class="p">)</span>

        <span class="c1"># ç½‘ç»œç»Ÿè®¡</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">packet_loss_threshold</span> <span class="o">=</span> <span class="mf">0.05</span>  <span class="c1"># 5%</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">latency_threshold</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># ms</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bandwidth_threshold</span> <span class="o">=</span> <span class="mi">1000000</span>  <span class="c1"># bytes/s</span>

        <span class="c1"># å®šæœŸæ£€æŸ¥ç½‘ç»œè´¨é‡</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_timer</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">check_network_quality</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">check_network_quality</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># æ”¶é›†ç½‘ç»œç»Ÿè®¡ä¿¡æ¯</span>
        <span class="n">stats</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collect_network_stats</span><span class="p">()</span>

        <span class="c1"># ç”Ÿæˆè¯Šæ–­æ¶ˆæ¯</span>
        <span class="n">diag_msg</span> <span class="o">=</span> <span class="n">DiagnosticArray</span><span class="p">()</span>
        <span class="n">diag_msg</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">stamp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_clock</span><span class="p">()</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">to_msg</span><span class="p">()</span>

        <span class="n">status</span> <span class="o">=</span> <span class="n">DiagnosticStatus</span><span class="p">()</span>
        <span class="n">status</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s2">&quot;Network Quality&quot;</span>
        <span class="n">status</span><span class="o">.</span><span class="n">hardware_id</span> <span class="o">=</span> <span class="s2">&quot;network_monitor&quot;</span>

        <span class="k">if</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;packet_loss&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">packet_loss_threshold</span><span class="p">:</span>
            <span class="n">status</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">DiagnosticStatus</span><span class="o">.</span><span class="n">WARN</span>
            <span class="n">status</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;High packet loss: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;packet_loss&#39;</span><span class="p">]</span><span class="o">*</span><span class="mi">100</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">%&quot;</span>
        <span class="k">elif</span> <span class="n">stats</span><span class="p">[</span><span class="s1">&#39;latency&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">latency_threshold</span><span class="p">:</span>
            <span class="n">status</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">DiagnosticStatus</span><span class="o">.</span><span class="n">WARN</span>
            <span class="n">status</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;High latency: </span><span class="si">{</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;latency&#39;</span><span class="p">]</span><span class="si">:</span><span class="s2">.1f</span><span class="si">}</span><span class="s2">ms&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">status</span><span class="o">.</span><span class="n">level</span> <span class="o">=</span> <span class="n">DiagnosticStatus</span><span class="o">.</span><span class="n">OK</span>
            <span class="n">status</span><span class="o">.</span><span class="n">message</span> <span class="o">=</span> <span class="s2">&quot;Network quality good&quot;</span>

        <span class="n">status</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">KeyValue</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;packet_loss&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;packet_loss&#39;</span><span class="p">])),</span>
            <span class="n">KeyValue</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;latency_ms&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;latency&#39;</span><span class="p">])),</span>
            <span class="n">KeyValue</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="s1">&#39;bandwidth_bps&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">stats</span><span class="p">[</span><span class="s1">&#39;bandwidth&#39;</span><span class="p">]))</span>
        <span class="p">]</span>

        <span class="n">diag_msg</span><span class="o">.</span><span class="n">status</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">status</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">diagnostics_pub</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span><span class="n">diag_msg</span><span class="p">)</span>
</code></pre></div>

<h3 id="743">7.4.3 è¿œç¨‹å¯åŠ¨ä¸ç›‘æ§</h3>
<p>è¿œç¨‹ç®¡ç†åˆ†å¸ƒå¼ç³»ç»Ÿéœ€è¦å®‰å…¨å¯é çš„å¯åŠ¨å’Œç›‘æ§æœºåˆ¶ã€‚</p>
<p><strong>SSH è¿œç¨‹å¯åŠ¨</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># remote_launch.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch.actions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExecuteProcess</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">paramiko</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RemoteLauncher</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;é€šè¿‡ SSH è¿œç¨‹å¯åŠ¨ ROS2 èŠ‚ç‚¹&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hosts_config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hosts</span> <span class="o">=</span> <span class="n">hosts_config</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh_clients</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">connect_to_host</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">username</span><span class="p">,</span> <span class="n">key_file</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;å»ºç«‹ SSH è¿æ¥&quot;&quot;&quot;</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">paramiko</span><span class="o">.</span><span class="n">SSHClient</span><span class="p">()</span>
        <span class="n">client</span><span class="o">.</span><span class="n">set_missing_host_key_policy</span><span class="p">(</span><span class="n">paramiko</span><span class="o">.</span><span class="n">AutoAddPolicy</span><span class="p">())</span>
        <span class="n">client</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="n">hostname</span><span class="o">=</span><span class="n">hostname</span><span class="p">,</span>
            <span class="n">username</span><span class="o">=</span><span class="n">username</span><span class="p">,</span>
            <span class="n">key_filename</span><span class="o">=</span><span class="n">key_file</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ssh_clients</span><span class="p">[</span><span class="n">hostname</span><span class="p">]</span> <span class="o">=</span> <span class="n">client</span>
        <span class="k">return</span> <span class="n">client</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_remote_launch_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">launch_cmd</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆ›å»ºè¿œç¨‹å¯åŠ¨åŠ¨ä½œ&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ExecuteProcess</span><span class="p">(</span>
            <span class="n">cmd</span><span class="o">=</span><span class="p">[</span>
                <span class="s1">&#39;ssh&#39;</span><span class="p">,</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">hosts</span><span class="p">[</span><span class="n">hostname</span><span class="p">][</span><span class="s2">&quot;user&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">@</span><span class="si">{</span><span class="n">hostname</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                <span class="s1">&#39;-i&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">hosts</span><span class="p">[</span><span class="n">hostname</span><span class="p">][</span><span class="s1">&#39;key_file&#39;</span><span class="p">],</span>
                <span class="sa">f</span><span class="s1">&#39;source /opt/ros/humble/setup.bash &amp;&amp; </span><span class="si">{</span><span class="n">launch_cmd</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">],</span>
            <span class="n">output</span><span class="o">=</span><span class="s1">&#39;screen&#39;</span><span class="p">,</span>
            <span class="c1"># é”™è¯¯å¤„ç†</span>
            <span class="n">on_exit</span><span class="o">=</span><span class="k">lambda</span> <span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="p">[</span>
                <span class="n">LogError</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Remote launch on </span><span class="si">{</span><span class="n">hostname</span><span class="si">}</span><span class="s1"> failed&#39;</span><span class="p">),</span>
                <span class="c1"># å°è¯•é‡æ–°è¿æ¥å’Œå¯åŠ¨</span>
                <span class="n">TimerAction</span><span class="p">(</span>
                    <span class="n">period</span><span class="o">=</span><span class="mf">5.0</span><span class="p">,</span>
                    <span class="n">actions</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">create_remote_launch_action</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">launch_cmd</span><span class="p">)]</span>
                <span class="p">)</span>
            <span class="p">]</span> <span class="k">if</span> <span class="n">event</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span> <span class="k">else</span> <span class="p">[]</span>
        <span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">generate_launch_description</span><span class="p">():</span>
    <span class="c1"># è¿œç¨‹ä¸»æœºé…ç½®</span>
    <span class="n">remote_hosts</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;robot1.local&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;ros&#39;</span><span class="p">,</span>
            <span class="s1">&#39;key_file&#39;</span><span class="p">:</span> <span class="s1">&#39;/home/operator/.ssh/id_rsa&#39;</span><span class="p">,</span>
            <span class="s1">&#39;launch_file&#39;</span><span class="p">:</span> <span class="s1">&#39;robot_bringup robot.launch.py&#39;</span>
        <span class="p">},</span>
        <span class="s1">&#39;robot2.local&#39;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s1">&#39;user&#39;</span><span class="p">:</span> <span class="s1">&#39;ros&#39;</span><span class="p">,</span>
            <span class="s1">&#39;key_file&#39;</span><span class="p">:</span> <span class="s1">&#39;/home/operator/.ssh/id_rsa&#39;</span><span class="p">,</span>
            <span class="s1">&#39;launch_file&#39;</span><span class="p">:</span> <span class="s1">&#39;robot_bringup robot.launch.py&#39;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="n">launcher</span> <span class="o">=</span> <span class="n">RemoteLauncher</span><span class="p">(</span><span class="n">remote_hosts</span><span class="p">)</span>

    <span class="c1"># ç”Ÿæˆè¿œç¨‹å¯åŠ¨åŠ¨ä½œ</span>
    <span class="n">remote_actions</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">hostname</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">remote_hosts</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">remote_actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">launcher</span><span class="o">.</span><span class="n">create_remote_launch_action</span><span class="p">(</span>
                <span class="n">hostname</span><span class="p">,</span>
                <span class="sa">f</span><span class="s2">&quot;ros2 launch </span><span class="si">{</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;launch_file&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="k">return</span> <span class="n">LaunchDescription</span><span class="p">(</span><span class="n">remote_actions</span><span class="p">)</span>
</code></pre></div>

<p><strong>åˆ†å¸ƒå¼ç›‘æ§ç³»ç»Ÿ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># distributed_monitor.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DistributedMonitor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;åˆ†å¸ƒå¼ç³»ç»Ÿç›‘æ§ä¸­å¿ƒ&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">monitored_nodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">alert_handlers</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_monitor_dashboard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆ›å»ºç›‘æ§ä»ªè¡¨æ¿&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Node</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="s1">&#39;fleet_monitor&#39;</span><span class="p">,</span>
            <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;monitor_dashboard&#39;</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span>
                <span class="s1">&#39;update_rate&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="c1"># Hz</span>
                <span class="s1">&#39;metrics&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;cpu_usage&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;memory_usage&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;network_bandwidth&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;message_frequency&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;latency&#39;</span>
                <span class="p">],</span>
                <span class="s1">&#39;alert_thresholds&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;cpu_usage&#39;</span><span class="p">:</span> <span class="mf">80.0</span><span class="p">,</span>  <span class="c1"># %</span>
                    <span class="s1">&#39;memory_usage&#39;</span><span class="p">:</span> <span class="mf">90.0</span><span class="p">,</span>  <span class="c1"># %</span>
                    <span class="s1">&#39;message_drop_rate&#39;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>  <span class="c1"># %</span>
                    <span class="s1">&#39;latency&#39;</span><span class="p">:</span> <span class="mf">100.0</span>  <span class="c1"># ms</span>
                <span class="p">},</span>
                <span class="s1">&#39;visualization&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;web_dashboard&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">8080</span><span class="p">,</span>
                    <span class="s1">&#39;update_interval&#39;</span><span class="p">:</span> <span class="mi">1000</span>  <span class="c1"># ms</span>
                <span class="p">}</span>
            <span class="p">}]</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_log_aggregator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ—¥å¿—èšåˆå™¨&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">Node</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="s1">&#39;log_aggregator&#39;</span><span class="p">,</span>
            <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;aggregator_node&#39;</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span>
                <span class="s1">&#39;log_sources&#39;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="s1">&#39;/robot_*/rosout&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;/*/diagnostics&#39;</span>
                <span class="p">],</span>
                <span class="s1">&#39;storage&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;elasticsearch&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;host&#39;</span><span class="p">:</span> <span class="s1">&#39;localhost:9200&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;index&#39;</span><span class="p">:</span> <span class="s1">&#39;ros2_logs&#39;</span>
                <span class="p">},</span>
                <span class="s1">&#39;filters&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;min_severity&#39;</span><span class="p">:</span> <span class="s1">&#39;WARN&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;exclude_nodes&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;rviz2&#39;</span><span class="p">,</span> <span class="s1">&#39;rqt&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">}]</span>
        <span class="p">)</span>
</code></pre></div>

<h3 id="744">7.4.4 å®¹å™¨åŒ–éƒ¨ç½²ç­–ç•¥</h3>
<p>å®¹å™¨åŒ–æä¾›äº†ä¸€è‡´çš„è¿è¡Œç¯å¢ƒå’Œç®€åŒ–çš„éƒ¨ç½²æµç¨‹ã€‚</p>
<p><strong>Docker å®¹å™¨é…ç½®</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c"># Dockerfile.ros2_robot</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">ros:humble-ros-base</span>

<span class="c"># å®‰è£…ä¾èµ–</span>
<span class="k">RUN</span><span class="w"> </span>apt-get<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>install<span class="w"> </span>-y<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>ros-humble-navigation2<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>ros-humble-moveit2<span class="w"> </span><span class="se">\</span>
<span class="w">    </span>ros-humble-gazebo-ros-pkgs<span class="w"> </span><span class="se">\</span>
<span class="w">    </span><span class="o">&amp;&amp;</span><span class="w"> </span>rm<span class="w"> </span>-rf<span class="w"> </span>/var/lib/apt/lists/*

<span class="c"># å¤åˆ¶å·¥ä½œç©ºé—´</span>
<span class="k">COPY</span><span class="w"> </span>--chown<span class="o">=</span>ros:ros<span class="w"> </span>./ws<span class="w"> </span>/home/ros/ws

<span class="c"># æ„å»ºå·¥ä½œç©ºé—´</span>
<span class="k">RUN</span><span class="w"> </span>/bin/bash<span class="w"> </span>-c<span class="w"> </span><span class="s2">&quot;source /opt/ros/humble/setup.bash &amp;&amp; \</span>
<span class="s2">    cd /home/ros/ws &amp;&amp; \</span>
<span class="s2">    colcon build --symlink-install&quot;</span>

<span class="c"># è®¾ç½®å…¥å£ç‚¹</span>
<span class="k">COPY</span><span class="w"> </span>./docker/entrypoint.sh<span class="w"> </span>/
<span class="k">ENTRYPOINT</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;/entrypoint.sh&quot;</span><span class="p">]</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;ros2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;launch&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;robot_bringup&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;robot.launch.py&quot;</span><span class="p">]</span>
</code></pre></div>

<p><strong>Docker Compose å¤šå®¹å™¨ç¼–æ’</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># docker-compose.yml</span>
<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.8&#39;</span>

<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># ROS2 ä¸»æ§èŠ‚ç‚¹</span>
<span class="w">  </span><span class="nt">ros_master</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ros2_fleet:humble</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ros_master</span>
<span class="w">    </span><span class="nt">network_mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ROS_DOMAIN_ID=0</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">RMW_IMPLEMENTATION=rmw_cyclonedds_cpp</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./config:/opt/ros/config:ro</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ros_logs:/var/log/ros2</span>
<span class="w">    </span><span class="nt">command</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ros2 launch fleet_manager master.launch.py</span>

<span class="w">  </span><span class="c1"># æœºå™¨äººå®ä¾‹</span>
<span class="w">  </span><span class="nt">robot_1</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ros2_robot:humble</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">robot_1</span>
<span class="w">    </span><span class="nt">network_mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">host</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ROS_DOMAIN_ID=101</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ROBOT_ID=1</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ROBOT_NAME=robot_1</span>
<span class="w">    </span><span class="nt">devices</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/ttyUSB0:/dev/ttyUSB0</span><span class="w">  </span><span class="c1"># ä¸²å£è®¾å¤‡</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/video0:/dev/video0</span><span class="w">      </span><span class="c1"># æ‘„åƒå¤´</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">./robot_configs/robot_1.yaml:/opt/ros/config/robot.yaml:ro</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ros_master</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>

<span class="w">  </span><span class="c1"># ç›‘æ§æœåŠ¡</span>
<span class="w">  </span><span class="nt">monitor</span><span class="p">:</span>
<span class="w">    </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ros2_monitor:humble</span>
<span class="w">    </span><span class="nt">container_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fleet_monitor</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;8080:8080&quot;</span><span class="w">  </span><span class="c1"># Web ä»ªè¡¨æ¿</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;9090:9090&quot;</span><span class="w">  </span><span class="c1"># Prometheus metrics</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ROS_DOMAIN_ID=0</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">monitor_data:/var/lib/monitor</span>
<span class="w">    </span><span class="nt">depends_on</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ros_master</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ros_logs</span><span class="p">:</span>
<span class="w">  </span><span class="nt">monitor_data</span><span class="p">:</span>
</code></pre></div>

<p><strong>Kubernetes éƒ¨ç½²</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># k8s-deployment.yaml</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">apps/v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Deployment</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ros2-robot-fleet</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">robotics</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">matchLabels</span><span class="p">:</span>
<span class="w">      </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ros2-robot</span>
<span class="w">  </span><span class="nt">template</span><span class="p">:</span>
<span class="w">    </span><span class="nt">metadata</span><span class="p">:</span>
<span class="w">      </span><span class="nt">labels</span><span class="p">:</span>
<span class="w">        </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ros2-robot</span>
<span class="w">    </span><span class="nt">spec</span><span class="p">:</span>
<span class="w">      </span><span class="nt">containers</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ros2-robot</span>
<span class="w">        </span><span class="nt">image</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ros2-robot:humble</span>
<span class="w">        </span><span class="nt">env</span><span class="p">:</span>

<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ROS_DOMAIN_ID</span>
<span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span>
<span class="w">            </span><span class="nt">fieldRef</span><span class="p">:</span>
<span class="w">              </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metadata.annotations[&#39;domain-id&#39;]</span>

<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ROBOT_NAME</span>
<span class="w">          </span><span class="nt">valueFrom</span><span class="p">:</span>
<span class="w">            </span><span class="nt">fieldRef</span><span class="p">:</span>
<span class="w">              </span><span class="nt">fieldPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">metadata.name</span>
<span class="w">        </span><span class="nt">resources</span><span class="p">:</span>
<span class="w">          </span><span class="nt">limits</span><span class="p">:</span>
<span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2Gi&quot;</span>
<span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;2&quot;</span>
<span class="w">          </span><span class="nt">requests</span><span class="p">:</span>
<span class="w">            </span><span class="nt">memory</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1Gi&quot;</span>
<span class="w">            </span><span class="nt">cpu</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;1&quot;</span>
<span class="w">        </span><span class="nt">volumeMounts</span><span class="p">:</span>

<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config</span>
<span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/opt/ros/config</span>

<span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shared-memory</span>
<span class="w">          </span><span class="nt">mountPath</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">/dev/shm</span>
<span class="w">      </span><span class="nt">volumes</span><span class="p">:</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">config</span>
<span class="w">        </span><span class="nt">configMap</span><span class="p">:</span>
<span class="w">          </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">robot-config</span>

<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">shared-memory</span>
<span class="w">        </span><span class="nt">emptyDir</span><span class="p">:</span>
<span class="w">          </span><span class="nt">medium</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Memory</span>
<span class="w">          </span><span class="nt">sizeLimit</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1Gi</span>
<span class="nn">---</span>
<span class="c1"># Service for robot communication</span>
<span class="nt">apiVersion</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="nt">kind</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="nt">metadata</span><span class="p">:</span>
<span class="w">  </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ros2-discovery</span>
<span class="w">  </span><span class="nt">namespace</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">robotics</span>
<span class="nt">spec</span><span class="p">:</span>
<span class="w">  </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ClusterIP</span>
<span class="w">  </span><span class="nt">ports</span><span class="p">:</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7400</span>
<span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7400</span>
<span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">UDP</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">discovery</span>

<span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">port</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7401</span>
<span class="w">    </span><span class="nt">targetPort</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">7401</span>
<span class="w">    </span><span class="nt">protocol</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">UDP</span>
<span class="w">    </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">user-multicast</span>
<span class="w">  </span><span class="nt">selector</span><span class="p">:</span>
<span class="w">    </span><span class="nt">app</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ros2-robot</span>
</code></pre></div>

<p><strong>å®¹å™¨åŒ–æœ€ä½³å®è·µ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># container_launch.py</span>
<span class="k">def</span><span class="w"> </span><span class="nf">generate_launch_description</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å®¹å™¨åŒ–ç¯å¢ƒçš„ Launch é…ç½®&quot;&quot;&quot;</span>

    <span class="c1"># æ£€æµ‹æ˜¯å¦åœ¨å®¹å™¨ä¸­è¿è¡Œ</span>
    <span class="n">in_container</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="s1">&#39;/.dockerenv&#39;</span><span class="p">)</span>

    <span class="c1"># å®¹å™¨ç‰¹å®šé…ç½®</span>
    <span class="n">container_config</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">in_container</span><span class="p">:</span>
        <span class="n">container_config</span> <span class="o">=</span> <span class="p">[</span>
            <span class="c1"># ä½¿ç”¨å®¹å™¨å†…çš„è®¾å¤‡æ˜ å°„</span>
            <span class="n">SetEnvironmentVariable</span><span class="p">(</span><span class="s1">&#39;DEVICE_PATH&#39;</span><span class="p">,</span> <span class="s1">&#39;/dev/mapped&#39;</span><span class="p">),</span>

            <span class="c1"># è°ƒæ•´å…±äº«å†…å­˜é™åˆ¶</span>
            <span class="n">ExecuteProcess</span><span class="p">(</span>
                <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mount&#39;</span><span class="p">,</span> <span class="s1">&#39;-o&#39;</span><span class="p">,</span> <span class="s1">&#39;remount,size=2G&#39;</span><span class="p">,</span> <span class="s1">&#39;/dev/shm&#39;</span><span class="p">]</span>
            <span class="p">),</span>

            <span class="c1"># é…ç½® DDS ä½¿ç”¨å…±äº«å†…å­˜</span>
            <span class="n">SetEnvironmentVariable</span><span class="p">(</span>
                <span class="s1">&#39;CYCLONEDDS_URI&#39;</span><span class="p">,</span>
<span class="w">                </span><span class="sd">&#39;&#39;&#39;&lt;CycloneDDS&gt;</span>
<span class="sd">                    &lt;Domain&gt;</span>
<span class="sd">                        &lt;SharedMemory&gt;</span>
<span class="sd">                            &lt;Enable&gt;true&lt;/Enable&gt;</span>
<span class="sd">                            &lt;LogLevel&gt;warning&lt;/LogLevel&gt;</span>
<span class="sd">                        &lt;/SharedMemory&gt;</span>
<span class="sd">                    &lt;/Domain&gt;</span>
<span class="sd">                &lt;/CycloneDDS&gt;&#39;&#39;&#39;</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="k">return</span> <span class="n">LaunchDescription</span><span class="p">([</span>
        <span class="o">*</span><span class="n">container_config</span><span class="p">,</span>

        <span class="c1"># å¥åº·æ£€æŸ¥èŠ‚ç‚¹</span>
        <span class="n">Node</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="s1">&#39;health_check&#39;</span><span class="p">,</span>
            <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;container_health&#39;</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span>
                <span class="s1">&#39;check_interval&#39;</span><span class="p">:</span> <span class="mf">5.0</span><span class="p">,</span>
                <span class="s1">&#39;health_endpoint&#39;</span><span class="p">:</span> <span class="s1">&#39;/health&#39;</span><span class="p">,</span>
                <span class="s1">&#39;port&#39;</span><span class="p">:</span> <span class="mi">8080</span>
            <span class="p">}]</span>
        <span class="p">),</span>

        <span class="c1"># ä¸»åº”ç”¨èŠ‚ç‚¹</span>
        <span class="n">Node</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="s1">&#39;robot_app&#39;</span><span class="p">,</span>
            <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;main&#39;</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span>
                <span class="s1">&#39;use_container_config&#39;</span><span class="p">:</span> <span class="n">in_container</span>
            <span class="p">}]</span>
        <span class="p">)</span>
    <span class="p">])</span>
</code></pre></div>

<h2 id="75-boston-dynamics-spot">7.5 äº§ä¸šæ¡ˆä¾‹ç ”ç©¶ï¼šBoston Dynamics Spot å¤šèŠ‚ç‚¹ç³»ç»Ÿå¯åŠ¨</h2>
<p>Boston Dynamics Spot æœºå™¨äººé‡‡ç”¨äº†å¤æ‚çš„å¤šèŠ‚ç‚¹æ¶æ„ï¼Œå…¶ Launch ç³»ç»Ÿè®¾è®¡ä½“ç°äº†å·¥ä¸šçº§æœºå™¨äººç³»ç»Ÿçš„æœ€ä½³å®è·µã€‚æœ¬æ¡ˆä¾‹æ·±å…¥åˆ†æ Spot çš„å¯åŠ¨æ¶æ„ã€æ•…éšœæ¢å¤æœºåˆ¶å’Œæ€§èƒ½ä¼˜åŒ–ç­–ç•¥ã€‚</p>
<h3 id="751">7.5.1 ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ</h3>
<p>Spot æœºå™¨äººçš„è½¯ä»¶æ ˆåŒ…å«è¶…è¿‡ 50 ä¸ªç‹¬ç«‹èŠ‚ç‚¹ï¼Œåˆ†å¸ƒåœ¨å¤šä¸ªè®¡ç®—å•å…ƒä¸Šï¼š</p>
<div class="codehilite"><pre><span></span><code>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Spot System Architecture             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ä¸»æ§åˆ¶å™¨ (Main Controller) - x86_64             â”‚
â”‚  â”œâ”€â”€ spot_driver (æ ¸å¿ƒé©±åŠ¨)                      â”‚
â”‚  â”œâ”€â”€ perception_engine (æ„ŸçŸ¥å¼•æ“)                â”‚
â”‚  â”œâ”€â”€ autonomy_core (è‡ªä¸»å¯¼èˆª)                    â”‚
â”‚  â””â”€â”€ mission_executor (ä»»åŠ¡æ‰§è¡Œå™¨)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  è¿åŠ¨æ§åˆ¶å™¨ (Motion Controller) - ARM            â”‚
â”‚  â”œâ”€â”€ locomotion_controller (æ­¥æ€æ§åˆ¶)            â”‚
â”‚  â”œâ”€â”€ balance_controller (å¹³è¡¡æ§åˆ¶)               â”‚
â”‚  â””â”€â”€ trajectory_optimizer (è½¨è¿¹ä¼˜åŒ–)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  æ„ŸçŸ¥å¤„ç†å™¨ (Perception Processor) - GPU         â”‚
â”‚  â”œâ”€â”€ stereo_processor (ç«‹ä½“è§†è§‰)                 â”‚
â”‚  â”œâ”€â”€ depth_estimator (æ·±åº¦ä¼°è®¡)                  â”‚
â”‚  â””â”€â”€ obstacle_detector (éšœç¢æ£€æµ‹)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="752">7.5.2 åˆ†å±‚å¯åŠ¨ç­–ç•¥</h3>
<p>Spot é‡‡ç”¨åˆ†å±‚å¯åŠ¨ç­–ç•¥ï¼Œç¡®ä¿å…³é”®ç³»ç»Ÿä¼˜å…ˆå¯åŠ¨å¹¶è¾¾åˆ°ç¨³å®šçŠ¶æ€ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># spot_bringup_launch.py</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch</span><span class="w"> </span><span class="kn">import</span> <span class="n">LaunchDescription</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch.actions</span><span class="w"> </span><span class="kn">import</span> <span class="n">GroupAction</span><span class="p">,</span> <span class="n">RegisterEventHandler</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch_ros.actions</span><span class="w"> </span><span class="kn">import</span> <span class="n">LifecycleNode</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">launch.event_handlers</span><span class="w"> </span><span class="kn">import</span> <span class="n">OnStateTransition</span>

<span class="k">class</span><span class="w"> </span><span class="nc">SpotLaunchOrchestrator</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Spot æœºå™¨äººå¯åŠ¨ç¼–æ’å™¨&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">launch_phases</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;phase_1_critical&#39;</span><span class="p">:</span> <span class="p">[],</span>     <span class="c1"># å…³é”®ç³»ç»Ÿ</span>
            <span class="s1">&#39;phase_2_motion&#39;</span><span class="p">:</span> <span class="p">[],</span>        <span class="c1"># è¿åŠ¨æ§åˆ¶</span>
            <span class="s1">&#39;phase_3_perception&#39;</span><span class="p">:</span> <span class="p">[],</span>    <span class="c1"># æ„ŸçŸ¥ç³»ç»Ÿ</span>
            <span class="s1">&#39;phase_4_autonomy&#39;</span><span class="p">:</span> <span class="p">[],</span>      <span class="c1"># è‡ªä¸»åŠŸèƒ½</span>
            <span class="s1">&#39;phase_5_auxiliary&#39;</span><span class="p">:</span> <span class="p">[]</span>      <span class="c1"># è¾…åŠ©åŠŸèƒ½</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_launch_description</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ld</span> <span class="o">=</span> <span class="n">LaunchDescription</span><span class="p">()</span>

        <span class="c1"># ç¬¬ä¸€é˜¶æ®µï¼šå…³é”®ç³»ç»Ÿå¯åŠ¨</span>
        <span class="n">phase_1_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_critical_nodes</span><span class="p">()</span>

        <span class="c1"># ç¬¬äºŒé˜¶æ®µï¼šè¿åŠ¨æ§åˆ¶ï¼ˆä¾èµ–ç¬¬ä¸€é˜¶æ®µï¼‰</span>
        <span class="n">phase_2_trigger</span> <span class="o">=</span> <span class="n">RegisterEventHandler</span><span class="p">(</span>
            <span class="n">OnStateTransition</span><span class="p">(</span>
                <span class="n">entities</span><span class="o">=</span><span class="n">phase_1_nodes</span><span class="p">,</span>
                <span class="n">goal_state</span><span class="o">=</span><span class="s1">&#39;active&#39;</span><span class="p">,</span>
                <span class="n">on_completion</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">LogInfo</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Phase 1 complete, starting motion control&#39;</span><span class="p">),</span>
                    <span class="n">GroupAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_motion_nodes</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># ç¬¬ä¸‰é˜¶æ®µï¼šæ„ŸçŸ¥ç³»ç»Ÿï¼ˆå¯å¹¶è¡Œå¯åŠ¨ï¼‰</span>
        <span class="n">phase_3_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_perception_nodes</span><span class="p">()</span>

        <span class="c1"># ç¬¬å››é˜¶æ®µï¼šè‡ªä¸»åŠŸèƒ½ï¼ˆä¾èµ–è¿åŠ¨å’Œæ„ŸçŸ¥ï¼‰</span>
        <span class="n">phase_4_trigger</span> <span class="o">=</span> <span class="n">RegisterEventHandler</span><span class="p">(</span>
            <span class="n">OnAllNodesActive</span><span class="p">(</span>
                <span class="n">nodes</span><span class="o">=</span><span class="p">[</span><span class="o">*</span><span class="n">phase_2_nodes</span><span class="p">,</span> <span class="o">*</span><span class="n">phase_3_nodes</span><span class="p">],</span>
                <span class="n">on_active</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">LogInfo</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="s1">&#39;Motion and perception ready, starting autonomy&#39;</span><span class="p">),</span>
                    <span class="n">GroupAction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_autonomy_nodes</span><span class="p">())</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">ld</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_critical_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆ›å»ºå…³é”®ç³»ç»ŸèŠ‚ç‚¹&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="c1"># ç¡¬ä»¶æ¥å£èŠ‚ç‚¹</span>
            <span class="n">LifecycleNode</span><span class="p">(</span>
                <span class="n">package</span><span class="o">=</span><span class="s1">&#39;spot_driver&#39;</span><span class="p">,</span>
                <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;hardware_interface&#39;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;hardware_interface&#39;</span><span class="p">,</span>
                <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span>
                    <span class="s1">&#39;update_rate&#39;</span><span class="p">:</span> <span class="mf">1000.0</span><span class="p">,</span>  <span class="c1"># 1kHz æ§åˆ¶é¢‘ç‡</span>
                    <span class="s1">&#39;timeout_ms&#39;</span><span class="p">:</span> <span class="mi">10</span><span class="p">,</span>
                    <span class="s1">&#39;watchdog_enabled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;emergency_stop_topic&#39;</span><span class="p">:</span> <span class="s1">&#39;/emergency_stop&#39;</span>
                <span class="p">}],</span>
                <span class="n">extra_arguments</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;--ros-args&#39;</span><span class="p">,</span> <span class="s1">&#39;--log-level&#39;</span><span class="p">,</span> <span class="s1">&#39;WARN&#39;</span><span class="p">]</span>
            <span class="p">),</span>

            <span class="c1"># çŠ¶æ€ä¼°è®¡å™¨</span>
            <span class="n">LifecycleNode</span><span class="p">(</span>
                <span class="n">package</span><span class="o">=</span><span class="s1">&#39;spot_driver&#39;</span><span class="p">,</span>
                <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;state_estimator&#39;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;state_estimator&#39;</span><span class="p">,</span>
                <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span>
                    <span class="s1">&#39;imu_rate&#39;</span><span class="p">:</span> <span class="mf">200.0</span><span class="p">,</span>
                    <span class="s1">&#39;joint_state_rate&#39;</span><span class="p">:</span> <span class="mf">100.0</span><span class="p">,</span>
                    <span class="s1">&#39;fusion_algorithm&#39;</span><span class="p">:</span> <span class="s1">&#39;ekf&#39;</span><span class="p">,</span>  <span class="c1"># Extended Kalman Filter</span>
                    <span class="s1">&#39;covariance_config&#39;</span><span class="p">:</span> <span class="s1">&#39;/opt/spot/config/ekf_covariance.yaml&#39;</span>
                <span class="p">}]</span>
            <span class="p">),</span>

            <span class="c1"># å®‰å…¨ç›‘æ§å™¨</span>
            <span class="n">Node</span><span class="p">(</span>
                <span class="n">package</span><span class="o">=</span><span class="s1">&#39;spot_safety&#39;</span><span class="p">,</span>
                <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;safety_monitor&#39;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;safety_monitor&#39;</span><span class="p">,</span>
                <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span>
                    <span class="s1">&#39;check_frequency&#39;</span><span class="p">:</span> <span class="mf">100.0</span><span class="p">,</span>
                    <span class="s1">&#39;fault_actions&#39;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s1">&#39;motor_overheat&#39;</span><span class="p">:</span> <span class="s1">&#39;reduce_power&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;battery_critical&#39;</span><span class="p">:</span> <span class="s1">&#39;safe_shutdown&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;communication_loss&#39;</span><span class="p">:</span> <span class="s1">&#39;freeze_in_place&#39;</span>
                    <span class="p">}</span>
                <span class="p">}]</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_motion_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆ›å»ºè¿åŠ¨æ§åˆ¶èŠ‚ç‚¹&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="c1"># æ­¥æ€ç”Ÿæˆå™¨</span>
            <span class="n">LifecycleNode</span><span class="p">(</span>
                <span class="n">package</span><span class="o">=</span><span class="s1">&#39;spot_locomotion&#39;</span><span class="p">,</span>
                <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;gait_generator&#39;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;gait_generator&#39;</span><span class="p">,</span>
                <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span>
                    <span class="s1">&#39;gait_library&#39;</span><span class="p">:</span> <span class="s1">&#39;/opt/spot/gaits/&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;default_gait&#39;</span><span class="p">:</span> <span class="s1">&#39;trot&#39;</span><span class="p">,</span>
                    <span class="s1">&#39;transition_time&#39;</span><span class="p">:</span> <span class="mf">0.5</span><span class="p">,</span>
                    <span class="s1">&#39;terrain_adaptation&#39;</span><span class="p">:</span> <span class="kc">True</span>
                <span class="p">}]</span>
            <span class="p">),</span>

            <span class="c1"># å¹³è¡¡æ§åˆ¶å™¨</span>
            <span class="n">LifecycleNode</span><span class="p">(</span>
                <span class="n">package</span><span class="o">=</span><span class="s1">&#39;spot_locomotion&#39;</span><span class="p">,</span>
                <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;balance_controller&#39;</span><span class="p">,</span>
                <span class="n">name</span><span class="o">=</span><span class="s1">&#39;balance_controller&#39;</span><span class="p">,</span>
                <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span>
                    <span class="s1">&#39;control_rate&#39;</span><span class="p">:</span> <span class="mf">500.0</span><span class="p">,</span>
                    <span class="s1">&#39;com_control&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Center of Mass control</span>
                    <span class="s1">&#39;zmp_constraint&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>  <span class="c1"># Zero Moment Point</span>
                    <span class="s1">&#39;disturbance_rejection&#39;</span><span class="p">:</span> <span class="s1">&#39;adaptive&#39;</span>
                <span class="p">}]</span>
            <span class="p">),</span>

            <span class="c1"># è…¿éƒ¨æ§åˆ¶å™¨ï¼ˆæ¯æ¡è…¿ä¸€ä¸ªå®ä¾‹ï¼‰</span>
            <span class="o">*</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_leg_controller</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">)]</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_leg_controller</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">leg_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆ›å»ºå•è…¿æ§åˆ¶å™¨&quot;&quot;&quot;</span>
        <span class="n">leg_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;front_left&#39;</span><span class="p">,</span> <span class="s1">&#39;front_right&#39;</span><span class="p">,</span> <span class="s1">&#39;rear_left&#39;</span><span class="p">,</span> <span class="s1">&#39;rear_right&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">LifecycleNode</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="s1">&#39;spot_locomotion&#39;</span><span class="p">,</span>
            <span class="n">executable</span><span class="o">=</span><span class="s1">&#39;leg_controller&#39;</span><span class="p">,</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;leg_controller_</span><span class="si">{</span><span class="n">leg_names</span><span class="p">[</span><span class="n">leg_id</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">namespace</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;/spot/legs/</span><span class="si">{</span><span class="n">leg_names</span><span class="p">[</span><span class="n">leg_id</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span>
                <span class="s1">&#39;leg_id&#39;</span><span class="p">:</span> <span class="n">leg_id</span><span class="p">,</span>
                <span class="s1">&#39;motor_ids&#39;</span><span class="p">:</span> <span class="p">[</span><span class="n">leg_id</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span> <span class="n">leg_id</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">leg_id</span><span class="o">*</span><span class="mi">3</span><span class="o">+</span><span class="mi">2</span><span class="p">],</span>  <span class="c1"># Hip, Knee, Ankle</span>
                <span class="s1">&#39;control_mode&#39;</span><span class="p">:</span> <span class="s1">&#39;impedance&#39;</span><span class="p">,</span>
                <span class="s1">&#39;stiffness&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">150.0</span><span class="p">,</span> <span class="mf">150.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">],</span>
                <span class="s1">&#39;damping&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">],</span>
                <span class="s1">&#39;force_limits&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mf">100.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">80.0</span><span class="p">]</span>
            <span class="p">}]</span>
        <span class="p">)</span>
</code></pre></div>

<h3 id="753">7.5.3 æ•…éšœæ¢å¤æœºåˆ¶</h3>
<p>Spot å®ç°äº†å¤šå±‚æ¬¡çš„æ•…éšœæ¢å¤æœºåˆ¶ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># spot_fault_recovery.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SpotFaultRecovery</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Spot æ•…éšœæ¢å¤ç³»ç»Ÿ&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_recovery_handlers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆ›å»ºæ•…éšœæ¢å¤å¤„ç†å™¨&quot;&quot;&quot;</span>
        <span class="n">handlers</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># èŠ‚ç‚¹çº§æ•…éšœæ¢å¤</span>
        <span class="k">for</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">config</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">critical_nodes</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">RegisterEventHandler</span><span class="p">(</span>
                    <span class="n">OnProcessExit</span><span class="p">(</span>
                        <span class="n">target_action</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;node&#39;</span><span class="p">],</span>
                        <span class="n">on_exit</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_node_recovery_action</span><span class="p">(</span>
                            <span class="n">node_name</span><span class="p">,</span> 
                            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;max_restarts&#39;</span><span class="p">],</span>
                            <span class="n">config</span><span class="p">[</span><span class="s1">&#39;recovery_strategy&#39;</span><span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="c1"># ç³»ç»Ÿçº§æ•…éšœæ¢å¤</span>
        <span class="n">handlers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">RegisterEventHandler</span><span class="p">(</span>
                <span class="n">OnSystemFault</span><span class="p">(</span>
                    <span class="n">fault_detector</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">fault_detector</span><span class="p">,</span>
                    <span class="n">on_fault</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_create_system_recovery_action</span><span class="p">()</span>
                <span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">handlers</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_node_recovery_action</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_name</span><span class="p">,</span> <span class="n">max_restarts</span><span class="p">,</span> <span class="n">strategy</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆ›å»ºèŠ‚ç‚¹æ¢å¤åŠ¨ä½œ&quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">recovery_action</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
            <span class="n">restart_count</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get_local_substitution</span><span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s1">_restart_count&#39;</span><span class="p">,</span> <span class="mi">0</span>
            <span class="p">)</span>

            <span class="k">if</span> <span class="n">restart_count</span> <span class="o">&gt;=</span> <span class="n">max_restarts</span><span class="p">:</span>
                <span class="c1"># è¶…è¿‡æœ€å¤§é‡å¯æ¬¡æ•°ï¼Œåˆ‡æ¢åˆ°é™çº§æ¨¡å¼</span>
                <span class="k">return</span> <span class="p">[</span>
                    <span class="n">LogError</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s1"> exceeded max restarts&#39;</span><span class="p">),</span>
                    <span class="n">EmitEvent</span><span class="p">(</span><span class="n">DegradedModeEvent</span><span class="p">(</span><span class="n">node_name</span><span class="p">))</span>
                <span class="p">]</span>

            <span class="c1"># æ ¹æ®ç­–ç•¥æ‰§è¡Œæ¢å¤</span>
            <span class="k">if</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;immediate&#39;</span><span class="p">:</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="k">elif</span> <span class="n">strategy</span> <span class="o">==</span> <span class="s1">&#39;exponential_backoff&#39;</span><span class="p">:</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="mi">2</span> <span class="o">**</span> <span class="n">restart_count</span><span class="p">,</span> <span class="mf">60.0</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># linear_backoff</span>
                <span class="n">delay</span> <span class="o">=</span> <span class="n">restart_count</span> <span class="o">*</span> <span class="mf">2.0</span>

            <span class="k">return</span> <span class="p">[</span>
                <span class="n">LogWarn</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Restarting </span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s1"> after </span><span class="si">{</span><span class="n">delay</span><span class="si">}</span><span class="s1">s&#39;</span><span class="p">),</span>
                <span class="n">TimerAction</span><span class="p">(</span>
                    <span class="n">period</span><span class="o">=</span><span class="n">delay</span><span class="p">,</span>
                    <span class="n">actions</span><span class="o">=</span><span class="p">[</span>
                        <span class="c1"># é‡å¯èŠ‚ç‚¹</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">node_configs</span><span class="p">[</span><span class="n">node_name</span><span class="p">][</span><span class="s1">&#39;node&#39;</span><span class="p">],</span>
                        <span class="c1"># æ›´æ–°é‡å¯è®¡æ•°</span>
                        <span class="n">SetLaunchConfiguration</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">node_name</span><span class="si">}</span><span class="s1">_restart_count&#39;</span><span class="p">,</span>
                            <span class="nb">str</span><span class="p">(</span><span class="n">restart_count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="n">recovery_action</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_create_system_recovery_action</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆ›å»ºç³»ç»Ÿçº§æ¢å¤åŠ¨ä½œ&quot;&quot;&quot;</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">system_recovery</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
            <span class="n">fault_type</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">fault_type</span>

            <span class="k">if</span> <span class="n">fault_type</span> <span class="o">==</span> <span class="s1">&#39;hardware_failure&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hardware_recovery_sequence</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">fault_type</span> <span class="o">==</span> <span class="s1">&#39;sensor_failure&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sensor_recovery_sequence</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">fault_type</span> <span class="o">==</span> <span class="s1">&#39;communication_failure&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_network_recovery_sequence</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_safe_mode_sequence</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">system_recovery</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_hardware_recovery_sequence</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç¡¬ä»¶æ•…éšœæ¢å¤åºåˆ—&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="c1"># 1. ç«‹å³åœæ­¢è¿åŠ¨</span>
            <span class="n">EmitEvent</span><span class="p">(</span><span class="n">EmergencyStopEvent</span><span class="p">()),</span>

            <span class="c1"># 2. ä¿å­˜å½“å‰çŠ¶æ€</span>
            <span class="n">ExecuteProcess</span><span class="p">(</span>
                <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ros2&#39;</span><span class="p">,</span> <span class="s1">&#39;service&#39;</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span> 
                     <span class="s1">&#39;/spot/save_state&#39;</span><span class="p">,</span> <span class="s1">&#39;std_srvs/srv/Trigger&#39;</span><span class="p">]</span>
            <span class="p">),</span>

            <span class="c1"># 3. é‡æ–°åˆå§‹åŒ–ç¡¬ä»¶</span>
            <span class="n">TimerAction</span><span class="p">(</span>
                <span class="n">period</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">actions</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">ExecuteProcess</span><span class="p">(</span>
                        <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ros2&#39;</span><span class="p">,</span> <span class="s1">&#39;service&#39;</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;/spot/reinit_hardware&#39;</span><span class="p">,</span> <span class="s1">&#39;std_srvs/srv/Trigger&#39;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="p">),</span>

            <span class="c1"># 4. æ¢å¤åˆ°å®‰å…¨å§¿æ€</span>
            <span class="n">TimerAction</span><span class="p">(</span>
                <span class="n">period</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span>
                <span class="n">actions</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">ExecuteProcess</span><span class="p">(</span>
                        <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ros2&#39;</span><span class="p">,</span> <span class="s1">&#39;service&#39;</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;/spot/safe_stance&#39;</span><span class="p">,</span> <span class="s1">&#39;std_srvs/srv/Trigger&#39;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">]</span>
</code></pre></div>

<h3 id="754">7.5.4 æ€§èƒ½ä¼˜åŒ–ç­–ç•¥</h3>
<p>Spot é‡‡ç”¨äº†å¤šç§ä¼˜åŒ–ç­–ç•¥ç¡®ä¿ç³»ç»Ÿæ€§èƒ½ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># spot_performance_optimization.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">SpotPerformanceOptimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Spot æ€§èƒ½ä¼˜åŒ–é…ç½®&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">apply_optimizations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åº”ç”¨æ€§èƒ½ä¼˜åŒ–&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="c1"># CPU äº²å’Œæ€§è®¾ç½®</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure_cpu_affinity</span><span class="p">(),</span>

            <span class="c1"># å†…å­˜é¢„åˆ†é…</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure_memory_allocation</span><span class="p">(),</span>

            <span class="c1"># DDS ä¼˜åŒ–</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure_dds_optimization</span><span class="p">(),</span>

            <span class="c1"># å®æ—¶ä¼˜å…ˆçº§è®¾ç½®</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_configure_realtime_priorities</span><span class="p">()</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_configure_cpu_affinity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;é…ç½® CPU äº²å’Œæ€§&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">ExecuteProcess</span><span class="p">(</span>
            <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;taskset&#39;</span><span class="p">,</span> <span class="s1">&#39;-c&#39;</span><span class="p">,</span> <span class="s1">&#39;0-3&#39;</span><span class="p">,</span>  <span class="c1"># ç»‘å®šåˆ° CPU 0-3</span>
                 <span class="s1">&#39;ros2&#39;</span><span class="p">,</span> <span class="s1">&#39;launch&#39;</span><span class="p">,</span> <span class="s1">&#39;spot_driver&#39;</span><span class="p">,</span> <span class="s1">&#39;critical_nodes.launch.py&#39;</span><span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_configure_memory_allocation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;é…ç½®å†…å­˜é¢„åˆ†é…&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="c1"># é”å®šå†…å­˜é˜²æ­¢äº¤æ¢</span>
            <span class="n">ExecuteProcess</span><span class="p">(</span><span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;mlockall&#39;</span><span class="p">]),</span>

            <span class="c1"># é¢„åˆ†é…å †å†…å­˜</span>
            <span class="n">SetEnvironmentVariable</span><span class="p">(</span><span class="s1">&#39;MALLOC_ARENA_MAX&#39;</span><span class="p">,</span> <span class="s1">&#39;2&#39;</span><span class="p">),</span>
            <span class="n">SetEnvironmentVariable</span><span class="p">(</span><span class="s1">&#39;MALLOC_MMAP_THRESHOLD_&#39;</span><span class="p">,</span> <span class="s1">&#39;131072&#39;</span><span class="p">),</span>

            <span class="c1"># é…ç½®å¤§é¡µå†…å­˜</span>
            <span class="n">ExecuteProcess</span><span class="p">(</span>
                <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;sysctl&#39;</span><span class="p">,</span> <span class="s1">&#39;-w&#39;</span><span class="p">,</span> <span class="s1">&#39;vm.nr_hugepages=128&#39;</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_configure_dds_optimization</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;DDS æ€§èƒ½ä¼˜åŒ–é…ç½®&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">SetEnvironmentVariable</span><span class="p">(</span>
            <span class="s1">&#39;CYCLONEDDS_URI&#39;</span><span class="p">,</span>
<span class="w">            </span><span class="sd">&#39;&#39;&#39;&lt;CycloneDDS&gt;</span>
<span class="sd">                &lt;Domain&gt;</span>
<span class="sd">                    &lt;General&gt;</span>
<span class="sd">                        &lt;NetworkInterfaceAddress&gt;eth0&lt;/NetworkInterfaceAddress&gt;</span>
<span class="sd">                        &lt;MaxMessageSize&gt;65536&lt;/MaxMessageSize&gt;</span>
<span class="sd">                    &lt;/General&gt;</span>
<span class="sd">                    &lt;Tracing&gt;</span>
<span class="sd">                        &lt;Verbosity&gt;error&lt;/Verbosity&gt;</span>
<span class="sd">                        &lt;OutputFile&gt;/dev/null&lt;/OutputFile&gt;</span>
<span class="sd">                    &lt;/Tracing&gt;</span>
<span class="sd">                &lt;/Domain&gt;</span>
<span class="sd">                &lt;DDSI2E&gt;</span>
<span class="sd">                    &lt;Internal&gt;</span>
<span class="sd">                        &lt;SocketReceiveBufferSize&gt;10485760&lt;/SocketReceiveBufferSize&gt;</span>
<span class="sd">                        &lt;SocketSendBufferSize&gt;10485760&lt;/SocketSendBufferSize&gt;</span>
<span class="sd">                        &lt;MaxParticipants&gt;120&lt;/MaxParticipants&gt;</span>
<span class="sd">                    &lt;/Internal&gt;</span>
<span class="sd">                    &lt;Discovery&gt;</span>
<span class="sd">                        &lt;ParticipantIndex&gt;auto&lt;/ParticipantIndex&gt;</span>
<span class="sd">                        &lt;MaxAutoParticipantIndex&gt;100&lt;/MaxAutoParticipantIndex&gt;</span>
<span class="sd">                    &lt;/Discovery&gt;</span>
<span class="sd">                &lt;/DDSI2E&gt;</span>
<span class="sd">            &lt;/CycloneDDS&gt;&#39;&#39;&#39;</span>
        <span class="p">)</span>
</code></pre></div>

<h3 id="755">7.5.5 å…³é”®æŒ‡æ ‡ä¸ç»éªŒæ•™è®­</h3>
<p><strong>æ€§èƒ½æŒ‡æ ‡</strong>ï¼š</p>
<ul>
<li>å¯åŠ¨æ—¶é—´ï¼šä»å†·å¯åŠ¨åˆ°å…¨åŠŸèƒ½å°±ç»ª &lt; 15 ç§’</li>
<li>èŠ‚ç‚¹é—´é€šä¿¡å»¶è¿Ÿï¼šP99 &lt; 1ms</li>
<li>æ§åˆ¶å¾ªç¯é¢‘ç‡ï¼š1kHzï¼ˆå…³é”®æ§åˆ¶ï¼‰ï¼Œ100Hzï¼ˆé«˜å±‚è§„åˆ’ï¼‰</li>
<li>æ•…éšœæ¢å¤æ—¶é—´ï¼š&lt; 2 ç§’ï¼ˆå•èŠ‚ç‚¹ï¼‰ï¼Œ&lt; 10 ç§’ï¼ˆç³»ç»Ÿçº§ï¼‰</li>
</ul>
<p><strong>ç»éªŒæ•™è®­</strong>ï¼š</p>
<ol>
<li><strong>åˆ†å±‚å¯åŠ¨è‡³å…³é‡è¦</strong>ï¼šé¿å…å¯åŠ¨é£æš´å’Œèµ„æºç«äº‰</li>
<li><strong>ç”Ÿå‘½å‘¨æœŸç®¡ç†</strong>ï¼šä½¿ç”¨ç”Ÿå‘½å‘¨æœŸèŠ‚ç‚¹ä¾¿äºçŠ¶æ€ç®¡ç†å’Œæ•…éšœæ¢å¤</li>
<li><strong>èµ„æºéš”ç¦»</strong>ï¼šCPU äº²å’Œæ€§å’Œå†…å­˜é¢„åˆ†é…æ˜¾è‘—æå‡å®æ—¶æ€§èƒ½</li>
<li><strong>ç›‘æ§å…ˆè¡Œ</strong>ï¼šå®Œå–„çš„ç›‘æ§ç³»ç»Ÿæ˜¯å¿«é€Ÿæ•…éšœå®šä½çš„å‰æ</li>
<li><strong>é™çº§æ¨¡å¼</strong>ï¼šè®¾è®¡å¤šçº§é™çº§æ¨¡å¼ç¡®ä¿åŸºæœ¬åŠŸèƒ½å¯ç”¨</li>
</ol>
<h2 id="76">7.6 é«˜çº§è¯é¢˜</h2>
<h3 id="761">7.6.1 åŠ¨æ€èŠ‚ç‚¹åŠ è½½ä¸çƒ­é‡å¯</h3>
<p>åŠ¨æ€èŠ‚ç‚¹ç®¡ç†å…è®¸åœ¨è¿è¡Œæ—¶æ·»åŠ ã€ç§»é™¤æˆ–é‡å¯èŠ‚ç‚¹ï¼Œæ— éœ€é‡å¯æ•´ä¸ªç³»ç»Ÿã€‚</p>
<p><strong>åŠ¨æ€åŠ è½½æ¶æ„</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># dynamic_node_loader.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DynamicNodeLoader</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;åŠ¨æ€èŠ‚ç‚¹åŠ è½½å™¨&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_registry</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">register_loadable_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">node_config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ³¨å†Œå¯åŠ¨æ€åŠ è½½çš„èŠ‚ç‚¹&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">node_registry</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;package&#39;</span><span class="p">:</span> <span class="n">node_config</span><span class="p">[</span><span class="s1">&#39;package&#39;</span><span class="p">],</span>
            <span class="s1">&#39;executable&#39;</span><span class="p">:</span> <span class="n">node_config</span><span class="p">[</span><span class="s1">&#39;executable&#39;</span><span class="p">],</span>
            <span class="s1">&#39;parameters&#39;</span><span class="p">:</span> <span class="n">node_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s1">&#39;remappings&#39;</span><span class="p">:</span> <span class="n">node_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;remappings&#39;</span><span class="p">,</span> <span class="p">[]),</span>
            <span class="s1">&#39;dependencies&#39;</span><span class="p">:</span> <span class="n">node_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dependencies&#39;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åŠ¨æ€åŠ è½½èŠ‚ç‚¹&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">LogWarn</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Node </span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s1"> already loaded&#39;</span><span class="p">)]</span>

        <span class="n">config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">node_registry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">config</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">LogError</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Unknown node </span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)]</span>

        <span class="c1"># æ£€æŸ¥ä¾èµ–</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">config</span><span class="p">[</span><span class="s1">&#39;dependencies&#39;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">dep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">LogError</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Dependency </span><span class="si">{</span><span class="n">dep</span><span class="si">}</span><span class="s1"> not loaded&#39;</span><span class="p">)]</span>

        <span class="c1"># åˆ›å»ºå¹¶å¯åŠ¨èŠ‚ç‚¹</span>
        <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;package&#39;</span><span class="p">],</span>
            <span class="n">executable</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;executable&#39;</span><span class="p">],</span>
            <span class="n">name</span><span class="o">=</span><span class="n">node_id</span><span class="p">,</span>
            <span class="n">parameters</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;parameters&#39;</span><span class="p">],</span>
            <span class="n">remappings</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;remappings&#39;</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">LogInfo</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Loading node </span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span>
            <span class="n">node</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">unload_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åŠ¨æ€å¸è½½èŠ‚ç‚¹&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">node_id</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">LogWarn</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Node </span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s1"> not loaded&#39;</span><span class="p">)]</span>

        <span class="c1"># æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–èŠ‚ç‚¹ä¾èµ–æ­¤èŠ‚ç‚¹</span>
        <span class="n">dependent_nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_dependent_nodes</span><span class="p">(</span><span class="n">node_id</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">dependent_nodes</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">LogError</span><span class="p">(</span>
                <span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Cannot unload </span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s1">, required by </span><span class="si">{</span><span class="n">dependent_nodes</span><span class="si">}</span><span class="s1">&#39;</span>
            <span class="p">)]</span>

        <span class="n">node</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span><span class="p">[</span><span class="n">node_id</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">[</span>
            <span class="n">LogInfo</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Unloading node </span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span>
            <span class="n">EmitEvent</span><span class="p">(</span><span class="n">ShutdownNode</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">reload_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_id</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;çƒ­é‡å¯èŠ‚ç‚¹&quot;&quot;&quot;</span>
        <span class="n">actions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># ä¿å­˜èŠ‚ç‚¹çŠ¶æ€</span>
        <span class="k">if</span> <span class="n">node_id</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">loaded_nodes</span><span class="p">:</span>
            <span class="n">actions</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                <span class="n">ExecuteProcess</span><span class="p">(</span>
                    <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ros2&#39;</span><span class="p">,</span> <span class="s1">&#39;service&#39;</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span>
                         <span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s1">/save_state&#39;</span><span class="p">,</span> <span class="s1">&#39;std_srvs/srv/Trigger&#39;</span><span class="p">]</span>
                <span class="p">),</span>
                <span class="n">TimerAction</span><span class="p">(</span><span class="n">period</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">actions</span><span class="o">=</span><span class="p">[])</span>  <span class="c1"># ç­‰å¾…çŠ¶æ€ä¿å­˜</span>
            <span class="p">])</span>

            <span class="c1"># å¸è½½æ—§èŠ‚ç‚¹</span>
            <span class="n">actions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unload_node</span><span class="p">(</span><span class="n">node_id</span><span class="p">))</span>

        <span class="c1"># åŠ è½½æ–°èŠ‚ç‚¹</span>
        <span class="n">actions</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">TimerAction</span><span class="p">(</span>
                <span class="n">period</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                <span class="n">actions</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">load_node</span><span class="p">(</span><span class="n">node_id</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">])</span>

        <span class="c1"># æ¢å¤çŠ¶æ€</span>
        <span class="n">actions</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
            <span class="n">TimerAction</span><span class="p">(</span>
                <span class="n">period</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                <span class="n">actions</span><span class="o">=</span><span class="p">[</span>
                    <span class="n">ExecuteProcess</span><span class="p">(</span>
                        <span class="n">cmd</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;ros2&#39;</span><span class="p">,</span> <span class="s1">&#39;service&#39;</span><span class="p">,</span> <span class="s1">&#39;call&#39;</span><span class="p">,</span>
                             <span class="sa">f</span><span class="s1">&#39;/</span><span class="si">{</span><span class="n">node_id</span><span class="si">}</span><span class="s1">/restore_state&#39;</span><span class="p">,</span> <span class="s1">&#39;std_srvs/srv/Trigger&#39;</span><span class="p">]</span>
                    <span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">])</span>

        <span class="k">return</span> <span class="n">actions</span>
</code></pre></div>

<p><strong>æ’ä»¶å¼èŠ‚ç‚¹ç³»ç»Ÿ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># plugin_node_system.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PluginNodeSystem</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;æ’ä»¶å¼èŠ‚ç‚¹ç®¡ç†ç³»ç»Ÿ&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plugin_paths</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;/opt/ros/plugins&#39;</span><span class="p">,</span> <span class="s1">&#39;~/.ros/plugins&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_plugins</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">scan_plugins</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ‰«æå¯ç”¨æ’ä»¶&quot;&quot;&quot;</span>
        <span class="n">plugins</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">plugin_paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.plugin.yaml&#39;</span><span class="p">):</span>
                        <span class="n">plugin_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_plugin_config</span><span class="p">(</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                        <span class="p">)</span>
                        <span class="n">plugins</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plugin_config</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">plugins</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">load_plugin</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plugin_name</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åŠ è½½æ’ä»¶èŠ‚ç‚¹&quot;&quot;&quot;</span>
        <span class="n">plugin_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_plugin</span><span class="p">(</span><span class="n">plugin_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">plugin_config</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Plugin </span><span class="si">{</span><span class="n">plugin_name</span><span class="si">}</span><span class="s1"> not found&#39;</span><span class="p">)</span>

        <span class="c1"># éªŒè¯æ’ä»¶ç­¾åï¼ˆå®‰å…¨æ€§ï¼‰</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_verify_plugin_signature</span><span class="p">(</span><span class="n">plugin_config</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SecurityError</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Plugin </span><span class="si">{</span><span class="n">plugin_name</span><span class="si">}</span><span class="s1"> signature invalid&#39;</span><span class="p">)</span>

        <span class="c1"># åˆ›å»ºéš”ç¦»çš„æ‰§è¡Œç¯å¢ƒ</span>
        <span class="n">container</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_create_plugin_container</span><span class="p">(</span><span class="n">plugin_config</span><span class="p">)</span>

        <span class="c1"># å¯åŠ¨æ’ä»¶èŠ‚ç‚¹</span>
        <span class="n">launch_actions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node_config</span> <span class="ow">in</span> <span class="n">plugin_config</span><span class="p">[</span><span class="s1">&#39;nodes&#39;</span><span class="p">]:</span>
            <span class="n">launch_actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">Node</span><span class="p">(</span>
                    <span class="n">package</span><span class="o">=</span><span class="n">node_config</span><span class="p">[</span><span class="s1">&#39;package&#39;</span><span class="p">],</span>
                    <span class="n">executable</span><span class="o">=</span><span class="n">node_config</span><span class="p">[</span><span class="s1">&#39;executable&#39;</span><span class="p">],</span>
                    <span class="n">namespace</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;/plugins/</span><span class="si">{</span><span class="n">plugin_name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
                    <span class="n">parameters</span><span class="o">=</span><span class="p">[</span>
                        <span class="p">{</span><span class="s1">&#39;plugin_mode&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
                        <span class="o">*</span><span class="n">node_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parameters&#39;</span><span class="p">,</span> <span class="p">[])</span>
                    <span class="p">],</span>
                    <span class="c1"># èµ„æºé™åˆ¶</span>
                    <span class="n">prefix</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;systemd-run&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;--uid=ros_plugin&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;--property=CPUQuota=50%&#39;</span><span class="p">,</span>
                           <span class="s1">&#39;--property=MemoryMax=500M&#39;</span><span class="p">]</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">loaded_plugins</span><span class="p">[</span><span class="n">plugin_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;config&#39;</span><span class="p">:</span> <span class="n">plugin_config</span><span class="p">,</span>
            <span class="s1">&#39;container&#39;</span><span class="p">:</span> <span class="n">container</span><span class="p">,</span>
            <span class="s1">&#39;nodes&#39;</span><span class="p">:</span> <span class="n">launch_actions</span>
        <span class="p">}</span>

        <span class="k">return</span> <span class="n">launch_actions</span>
</code></pre></div>

<h3 id="762-launch">7.6.2 Launch ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–</h3>
<p>ä¼˜åŒ– Launch ç³»ç»Ÿæ€§èƒ½å¯¹äºå¤§è§„æ¨¡éƒ¨ç½²è‡³å…³é‡è¦ã€‚</p>
<p><strong>å¹¶è¡Œå¯åŠ¨ä¼˜åŒ–</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># parallel_launch_optimizer.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ParallelLaunchOptimizer</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å¹¶è¡Œå¯åŠ¨ä¼˜åŒ–å™¨&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">launch_groups</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">analyze_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nodes</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆ†æèŠ‚ç‚¹ä¾èµ–å…³ç³»&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_dependencies</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">deps</span>

        <span class="c1"># æ‹“æ‰‘æ’åºæ‰¾å‡ºå¯å¹¶è¡Œå¯åŠ¨çš„ç»„</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">launch_groups</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_topological_grouping</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_topological_grouping</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ‹“æ‰‘åˆ†ç»„ï¼Œæœ€å¤§åŒ–å¹¶è¡Œåº¦&quot;&quot;&quot;</span>
        <span class="n">groups</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">in_degree</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">deps</span><span class="p">)</span> 
                    <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">deps</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">visited</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="p">):</span>
            <span class="c1"># æ‰¾å‡ºæ‰€æœ‰å…¥åº¦ä¸º 0 çš„èŠ‚ç‚¹ï¼ˆå¯å¹¶è¡Œå¯åŠ¨ï¼‰</span>
            <span class="n">current_group</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">node</span> <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">degree</span> <span class="ow">in</span> <span class="n">in_degree</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">degree</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">node</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">current_group</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Circular dependency detected&quot;</span><span class="p">)</span>

            <span class="n">groups</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_group</span><span class="p">)</span>

            <span class="c1"># æ›´æ–°å…¥åº¦</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">current_group</span><span class="p">:</span>
                <span class="n">visited</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">other_node</span><span class="p">,</span> <span class="n">deps</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependency_graph</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">deps</span><span class="p">:</span>
                        <span class="n">in_degree</span><span class="p">[</span><span class="n">other_node</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">groups</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_optimized_launch</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;ç”Ÿæˆä¼˜åŒ–çš„å¯åŠ¨åºåˆ—&quot;&quot;&quot;</span>
        <span class="n">launch_actions</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">launch_groups</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="c1"># ç¬¬ä¸€ç»„ç›´æ¥å¯åŠ¨</span>
                <span class="n">launch_actions</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span>
                    <span class="n">LogInfo</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Starting group </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span>
                    <span class="n">GroupAction</span><span class="p">([</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_create_node_action</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> 
                        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">group</span>
                    <span class="p">])</span>
                <span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># åç»­ç»„ç­‰å¾…å‰ä¸€ç»„å®Œæˆ</span>
                <span class="n">launch_actions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="n">RegisterEventHandler</span><span class="p">(</span>
                        <span class="n">OnGroupComplete</span><span class="p">(</span>
                            <span class="n">group_index</span><span class="o">=</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">on_complete</span><span class="o">=</span><span class="p">[</span>
                                <span class="n">LogInfo</span><span class="p">(</span><span class="n">msg</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Starting group </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">: </span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">),</span>
                                <span class="n">GroupAction</span><span class="p">([</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_create_node_action</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">group</span>
                                <span class="p">])</span>
                            <span class="p">]</span>
                        <span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">LaunchDescription</span><span class="p">(</span><span class="n">launch_actions</span><span class="p">)</span>
</code></pre></div>

<p><strong>å†…å­˜ä¼˜åŒ–</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># memory_optimized_launch.py</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MemoryOptimizedLaunch</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å†…å­˜ä¼˜åŒ–çš„å¯åŠ¨é…ç½®&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">configure_memory_limits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node_configs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;é…ç½®èŠ‚ç‚¹å†…å­˜é™åˆ¶&quot;&quot;&quot;</span>
        <span class="n">optimized_nodes</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">config</span> <span class="ow">in</span> <span class="n">node_configs</span><span class="p">:</span>
            <span class="n">memory_limit</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_memory_limit</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>

            <span class="n">node</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span>
                <span class="n">package</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;package&#39;</span><span class="p">],</span>
                <span class="n">executable</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;executable&#39;</span><span class="p">],</span>
                <span class="n">name</span><span class="o">=</span><span class="n">config</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">],</span>
                <span class="c1"># ä½¿ç”¨ cgroups é™åˆ¶å†…å­˜</span>
                <span class="n">prefix</span><span class="o">=</span><span class="p">[</span>
                    <span class="s1">&#39;systemd-run&#39;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;--property=MemoryMax=</span><span class="si">{</span><span class="n">memory_limit</span><span class="si">}</span><span class="s1">M&#39;</span><span class="p">,</span>
                    <span class="sa">f</span><span class="s1">&#39;--property=MemorySwapMax=0&#39;</span><span class="p">,</span>  <span class="c1"># ç¦ç”¨ swap</span>
                    <span class="s1">&#39;--property=MemoryAccounting=true&#39;</span>
                <span class="p">],</span>
                <span class="n">parameters</span><span class="o">=</span><span class="p">[{</span>
                    <span class="s1">&#39;preallocate_memory&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                    <span class="s1">&#39;memory_pool_size&#39;</span><span class="p">:</span> <span class="n">memory_limit</span> <span class="o">*</span> <span class="mf">0.8</span>
                <span class="p">}]</span>
            <span class="p">)</span>

            <span class="n">optimized_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">optimized_nodes</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_calculate_memory_limit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;æ ¹æ®èŠ‚ç‚¹ç±»å‹è®¡ç®—å†…å­˜é™åˆ¶&quot;&quot;&quot;</span>
        <span class="n">base_memory</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;sensor_driver&#39;</span><span class="p">:</span> <span class="mi">50</span><span class="p">,</span>
            <span class="s1">&#39;perception&#39;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span>
            <span class="s1">&#39;planning&#39;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span>
            <span class="s1">&#39;control&#39;</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="s1">&#39;visualization&#39;</span><span class="p">:</span> <span class="mi">300</span>
        <span class="p">}</span>

        <span class="n">node_type</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;default&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">base_memory</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node_type</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
</code></pre></div>

<h3 id="763">7.6.3 å‰æ²¿ç ”ç©¶ä¸è®ºæ–‡å¯¼è¯»</h3>
<p><strong>å…³é”®è®ºæ–‡</strong>ï¼š</p>
<ol>
<li>
<p><strong>"Orchestrating Complex Robot Behaviors with Hierarchical Launch Systems"</strong> (ICRA 2023)
   - æå‡ºäº†åˆ†å±‚å¯åŠ¨æ¶æ„ï¼Œæ”¯æŒå¤æ‚è¡Œä¸ºç¼–æ’
   - å¼•å…¥äº†è¡Œä¸ºæ ‘ä¸ Launch ç³»ç»Ÿçš„é›†æˆæ–¹æ³•
   - å®éªŒè¡¨æ˜å¯åŠ¨æ—¶é—´å‡å°‘ 40%ï¼Œæ•…éšœæ¢å¤æ—¶é—´å‡å°‘ 60%</p>
</li>
<li>
<p><strong>"Zero-Downtime Reconfiguration for Distributed Robot Systems"</strong> (IROS 2023)
   - è®¾è®¡äº†æ”¯æŒé›¶åœæœºé‡é…ç½®çš„ Launch æ¡†æ¶
   - é‡‡ç”¨è“ç»¿éƒ¨ç½²ç­–ç•¥å®ç°æ— ç¼åˆ‡æ¢
   - åœ¨ 100+ èŠ‚ç‚¹ç³»ç»Ÿä¸­éªŒè¯äº†å¯è¡Œæ€§</p>
</li>
<li>
<p><strong>"Formal Verification of Launch Configurations in ROS2"</strong> (RSS 2024)
   - ä½¿ç”¨å½¢å¼åŒ–æ–¹æ³•éªŒè¯ Launch é…ç½®çš„æ­£ç¡®æ€§
   - è‡ªåŠ¨æ£€æµ‹æ­»é”ã€èµ„æºå†²çªå’Œä¾èµ–å¾ªç¯
   - å¼€æºå·¥å…·ï¼šhttps://github.com/ros2/launch_verification</p>
</li>
</ol>
<p><strong>å‰æ²¿æŠ€æœ¯æ–¹å‘</strong>ï¼š</p>
<ol>
<li>
<p><strong>AI é©±åŠ¨çš„å¯åŠ¨ä¼˜åŒ–</strong>ï¼š
   - ä½¿ç”¨å¼ºåŒ–å­¦ä¹ ä¼˜åŒ–å¯åŠ¨åºåˆ—
   - åŸºäºå†å²æ•°æ®é¢„æµ‹æœ€ä½³èµ„æºåˆ†é…
   - è‡ªé€‚åº”è°ƒæ•´å¯åŠ¨å‚æ•°</p>
</li>
<li>
<p><strong>äº‘åŸç”Ÿ Launch ç³»ç»Ÿ</strong>ï¼š
   - ä¸ Kubernetes Operator æ·±åº¦é›†æˆ
   - æ”¯æŒå¼¹æ€§ä¼¸ç¼©å’Œè‡ªåŠ¨æ•…éšœè½¬ç§»
   - å¤šäº‘ç¯å¢ƒä¸‹çš„ç»Ÿä¸€ç®¡ç†</p>
</li>
<li>
<p><strong>é‡å­å¯å‘çš„å¹¶è¡Œè°ƒåº¦</strong>ï¼š
   - å€Ÿé‰´é‡å­é€€ç«ç®—æ³•ä¼˜åŒ–å¹¶è¡Œåº¦
   - è§£å†³å¤§è§„æ¨¡ç³»ç»Ÿçš„ NP-hard è°ƒåº¦é—®é¢˜</p>
</li>
</ol>
<h2 id="77">7.7 æœ¬ç« å°ç»“</h2>
<h2 id="78">7.8 ç»ƒä¹ é¢˜</h2>
<h2 id="79">7.9 å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<h2 id="710">7.10 æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
            </article>
            
            <nav class="page-nav"><a href="chapter6.html" class="nav-link prev">â† ç¬¬ 6 ç« ï¼šé€šä¿¡æœºåˆ¶æ·±åº¦è§£æ</a><a href="chapter8.html" class="nav-link next">ç¬¬ 8 ç« ï¼štf2 åæ ‡å˜æ¢æ¡†æ¶ â†’</a></nav>
        </main>
    </div>
</body>
</html>