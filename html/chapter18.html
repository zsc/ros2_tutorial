<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬ 18 ç« ï¼šå¤šæœºå™¨äººç³»ç»Ÿ</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ROS2 å®Œå…¨æ•™ç¨‹ï¼šä»åŸç†åˆ°å®è·µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 1 ç« ï¼šROS1 æ ¸å¿ƒæ¦‚å¿µå›é¡¾</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 2 ç« ï¼šROS1 çš„å±€é™æ€§åˆ†æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 3 ç« ï¼šä» ROS1 åˆ° ROS2 çš„è¿ç§»ç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 4 ç« ï¼šROS2 æ¶æ„ä¸è®¾è®¡ç†å¿µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 5 ç« ï¼šèŠ‚ç‚¹ä¸æ‰§è¡Œå™¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 6 ç« ï¼šé€šä¿¡æœºåˆ¶æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 7 ç« ï¼šLaunch ç³»ç»Ÿä¸é…ç½®ç®¡ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 8 ç« ï¼štf2 åæ ‡å˜æ¢æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 9 ç« ï¼šæ—¶é—´åŒæ­¥ä¸å›æ”¾ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 10 ç« ï¼šä¼ æ„Ÿå™¨æ•°æ®å¤„ç†ç®¡é“</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 11 ç« ï¼šSLAM ä¸å®šä½ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 12 ç« ï¼šå¯¼èˆªæ ˆ Nav2</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 13 ç« ï¼šros2_control æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 14 ç« ï¼šMoveIt2 è¿åŠ¨è§„åˆ’</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 15 ç« ï¼šå®æ—¶ç³»ç»Ÿä¸æ€§èƒ½ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 16 ç« ï¼šå®‰å…¨æ€§ä¸è¯Šæ–­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 17 ç« ï¼šä»¿çœŸé›†æˆï¼ˆGazebo/Ignitionï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 18 ç« ï¼šå¤šæœºå™¨äººç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 19 ç« ï¼šè®¡ç®—æœºè§†è§‰ä¸æ·±åº¦å­¦ä¹ </span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 20 ç« ï¼šæœºå™¨äººå¼ºåŒ–å­¦ä¹ </span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 21 ç« ï¼šå¤§è¯­è¨€æ¨¡å‹ä¸å…·èº«æ™ºèƒ½</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 22 ç« ï¼šç¥ç»ç½‘ç»œè¿åŠ¨æ§åˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="18">ç¬¬ 18 ç« ï¼šå¤šæœºå™¨äººç³»ç»Ÿ</h1>
<p>å¤šæœºå™¨äººç³»ç»Ÿï¼ˆMulti-Robot Systems, MRSï¼‰ä»£è¡¨äº†æœºå™¨äººæŠ€æœ¯çš„å‰æ²¿æ–¹å‘ï¼Œé€šè¿‡åè°ƒå¤šä¸ªæœºå™¨äººå…±åŒå®Œæˆå¤æ‚ä»»åŠ¡ï¼Œå®ç°å•æœºå™¨äººæ— æ³•è¾¾åˆ°çš„æ•ˆç‡ã€é²æ£’æ€§å’Œè¦†ç›–èŒƒå›´ã€‚æœ¬ç« æ·±å…¥æ¢è®¨ ROS2 ä¸­å¤šæœºå™¨äººç³»ç»Ÿçš„è®¾è®¡ä¸å®ç°ï¼Œä»åº•å±‚é€šä¿¡æ¶æ„åˆ°é«˜çº§ç¾¤ä½“æ™ºèƒ½ç®—æ³•ï¼Œä»ç†è®ºæ¨¡å‹åˆ°å·¥ä¸šéƒ¨ç½²å®è·µï¼Œå…¨é¢è¦†ç›–å¤šæœºå™¨äººç³»ç»Ÿçš„æ ¸å¿ƒæŠ€æœ¯æ ˆã€‚</p>
<h2 id="181-id">18.1 å‘½åç©ºé—´ä¸åŸŸ ID ç®¡ç†</h2>
<p>åœ¨å¤šæœºå™¨äººç³»ç»Ÿä¸­ï¼Œæ­£ç¡®çš„å‘½åç©ºé—´å’ŒåŸŸ ID ç®¡ç†æ˜¯é¿å…é€šä¿¡å†²çªã€å®ç°èµ„æºéš”ç¦»çš„åŸºç¡€ã€‚ä¸ ROS1 ä¾èµ–ä¸­å¿ƒåŒ– Master èŠ‚ç‚¹ä¸åŒï¼ŒROS2 é‡‡ç”¨ DDS çš„å»ä¸­å¿ƒåŒ–æ¶æ„ï¼Œä¸ºå¤šæœºå™¨äººç³»ç»Ÿæä¾›äº†å¤©ç„¶çš„æ”¯æŒã€‚æœ¬èŠ‚æ·±å…¥æ¢è®¨å¦‚ä½•åˆ©ç”¨è¿™äº›æœºåˆ¶æ„å»ºå¯æ‰©å±•ã€é«˜æ•ˆçš„å¤šæœºå™¨äººç³»ç»Ÿã€‚</p>
<h3 id="1811-ros2">18.1.1 ROS2 å¤šæœºå™¨äººæ¶æ„åŸºç¡€</h3>
<p>ROS2 ä»è®¾è®¡ä¹‹åˆå°±è€ƒè™‘äº†å¤šæœºå™¨äººç³»ç»Ÿçš„éœ€æ±‚ï¼Œé€šè¿‡ DDSï¼ˆData Distribution Serviceï¼‰æä¾›äº†å¼ºå¤§çš„åˆ†å¸ƒå¼é€šä¿¡èƒ½åŠ›ã€‚ç†è§£å…¶æ¶æ„å¯¹äºæ„å»ºé«˜æ•ˆçš„å¤šæœºå™¨äººç³»ç»Ÿè‡³å…³é‡è¦ã€‚</p>
<p><strong>æ ¸å¿ƒæ¦‚å¿µè¾¨æï¼š</strong></p>
<p>DDS åŸŸï¼ˆDomainï¼‰æ˜¯ ROS2 ä¸­æœ€é¡¶å±‚çš„éš”ç¦»æœºåˆ¶ã€‚ä¸åŒåŸŸä¸­çš„èŠ‚ç‚¹å®Œå…¨æ— æ³•ç›¸äº’å‘ç°å’Œé€šä¿¡ï¼Œè¿™ä¸ºå¤šæœºå™¨äººç³»ç»Ÿæä¾›äº†å¤©ç„¶çš„éš”ç¦»è¾¹ç•Œã€‚åŸŸ ID çš„å–å€¼èŒƒå›´æ˜¯ 0-232ï¼Œå…¶ä¸­ 0-32 é€šå¸¸ä¿ç•™ç»™ç³»ç»Ÿä½¿ç”¨ã€‚åœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œæˆ‘ä»¬é€šå¸¸é‡‡ç”¨ä»¥ä¸‹ç­–ç•¥ï¼š</p>
<ul>
<li><strong>å¼€å‘ç¯å¢ƒ</strong>ï¼šæ¯ä¸ªå¼€å‘è€…ä½¿ç”¨ç‹¬ç«‹åŸŸ IDï¼ˆå¦‚åŸºäºå‘˜å·¥ç¼–å·ï¼‰</li>
<li><strong>æµ‹è¯•ç¯å¢ƒ</strong>ï¼šä½¿ç”¨ 50-99 èŒƒå›´ï¼ŒæŒ‰æµ‹è¯•åœºæ™¯åˆ†é…</li>
<li><strong>ç”Ÿäº§ç¯å¢ƒ</strong>ï¼šä½¿ç”¨ 100+ èŒƒå›´ï¼ŒæŒ‰éƒ¨ç½²åŒºåŸŸæˆ–åŠŸèƒ½åˆ†ç»„</li>
</ul>
<p>DDS åˆ†åŒºï¼ˆPartitionï¼‰åˆ™æä¾›äº†åŸŸå†…çš„é€»è¾‘éš”ç¦»ã€‚åŒä¸€åŸŸå†…çš„ä¸åŒåˆ†åŒºå¯ä»¥é€‰æ‹©æ€§åœ°äº¤æ¢æ•°æ®ï¼Œè¿™ä¸ºç»†ç²’åº¦çš„é€šä¿¡æ§åˆ¶æä¾›äº†å¯èƒ½ã€‚åˆ†åŒºçš„ä½¿ç”¨åœºæ™¯åŒ…æ‹¬ï¼š</p>
<ul>
<li><strong>ä»»åŠ¡éš”ç¦»</strong>ï¼šä¸åŒä»»åŠ¡çš„æœºå™¨äººä½¿ç”¨ä¸åŒåˆ†åŒº</li>
<li><strong>æ•°æ®åˆ†çº§</strong>ï¼šæ§åˆ¶å‘½ä»¤ã€ä¼ æ„Ÿå™¨æ•°æ®ã€æ—¥å¿—ä¿¡æ¯ä½¿ç”¨ä¸åŒåˆ†åŒº</li>
<li><strong>å®‰å…¨éš”ç¦»</strong>ï¼šæ•æ„Ÿæ•°æ®å’Œå…¬å¼€æ•°æ®åˆ†ç¦»</li>
</ul>
<p><strong>DDS åŸŸä¸åˆ†åŒºæ¦‚å¿µï¼š</strong></p>
<div class="codehilite"><pre><span></span><code>DDS é€šä¿¡åŸŸæ¶æ„ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DDS Domain 0                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Partition A â”‚  Partition B  â”‚        â”‚
â”‚  â”‚  (Robot1)    â”‚  (Robot2)     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         Shared Topics/Services           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              DDS Domain 1                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Partition C â”‚  Partition D  â”‚        â”‚
â”‚  â”‚  (Robot3)    â”‚  (Robot4)     â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚         Isolated Communication           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<p><strong>åŸŸ ID æ™ºèƒ½åˆ†é…çš„æ•°å­¦æ¨¡å‹ï¼š</strong></p>
<p>åœ¨å¤§è§„æ¨¡å¤šæœºå™¨äººç³»ç»Ÿä¸­ï¼ŒåŸŸ ID çš„åˆ†é…ä¸ä»…è¦é¿å…å†²çªï¼Œè¿˜è¦ä¼˜åŒ–ç½‘ç»œæ€§èƒ½ã€‚æˆ‘ä»¬å¯ä»¥å°†å…¶å»ºæ¨¡ä¸ºå›¾ç€è‰²é—®é¢˜ï¼š</p>
<p>$$
\min \sum_{i,j \in E} w_{ij} \cdot \delta(c_i, c_j)
$$</p>
<p>å…¶ä¸­ $w_{ij}$ è¡¨ç¤ºæœºå™¨äºº $i$ å’Œ $j$ ä¹‹é—´çš„é€šä¿¡é¢‘ç‡ï¼Œ$c_i$ è¡¨ç¤ºåˆ†é…ç»™æœºå™¨äºº $i$ çš„åŸŸ IDï¼Œ$\delta$ æ˜¯æŒ‡ç¤ºå‡½æ•°ï¼Œå½“ä¸¤ä¸ªæœºå™¨äººåœ¨åŒä¸€åŸŸæ—¶ä¸º 1ã€‚è¿™ä¸ªä¼˜åŒ–é—®é¢˜çš„ç›®æ ‡æ˜¯æœ€å°åŒ–åŒåŸŸå†…çš„é€šä¿¡è´Ÿè½½ï¼Œä»è€Œæé«˜ç³»ç»Ÿæ•´ä½“æ€§èƒ½ã€‚</p>
<p><strong>åŸŸ ID åˆ†é…ç­–ç•¥å®ç°ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DomainManager</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">DomainAllocation</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">domainId</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">purpose</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">robots</span><span class="p">;</span>
<span class="w">        </span><span class="n">QoSProfile</span><span class="w"> </span><span class="n">qosProfile</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="kt">int</span><span class="p">,</span><span class="w"> </span><span class="n">DomainAllocation</span><span class="o">&gt;</span><span class="w"> </span><span class="n">domainMap</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// æ™ºèƒ½åŸŸåˆ†é…ç®—æ³•</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">allocateDomain</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">robotGroup</span><span class="p">,</span><span class="w"> </span>
<span class="w">                       </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">taskType</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åŸºäºä»»åŠ¡ç±»å‹å’Œç½‘ç»œæ‹“æ‰‘åˆ†é…åŸŸ</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">taskType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;swarm_coordination&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// ç¾¤ä½“åè°ƒä»»åŠ¡ä½¿ç”¨å…±äº«åŸŸ</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">taskType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;isolated_operation&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// ç‹¬ç«‹æ“ä½œä½¿ç”¨éš”ç¦»åŸŸ</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">generateUniqueDomain</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">taskType</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;hierarchical_control&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// åˆ†å±‚æ§åˆ¶ä½¿ç”¨å¤šåŸŸæ¶æ„</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">getHierarchicalDomain</span><span class="p">(</span><span class="n">robotGroup</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">  </span><span class="c1">// é»˜è®¤åŸŸ</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// åŠ¨æ€åŸŸè¿ç§»</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">migrateToDomain</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">robotId</span><span class="p">,</span><span class="w"> </span>
<span class="w">                        </span><span class="kt">int</span><span class="w"> </span><span class="n">fromDomain</span><span class="p">,</span><span class="w"> </span>
<span class="w">                        </span><span class="kt">int</span><span class="w"> </span><span class="n">toDomain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ä¼˜é›…å…³é—­å½“å‰åŸŸè¿æ¥</span>
<span class="w">        </span><span class="n">shutdownDomainParticipant</span><span class="p">(</span><span class="n">fromDomain</span><span class="p">,</span><span class="w"> </span><span class="n">robotId</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ç­‰å¾…æ¸…ç†å®Œæˆ</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">this_thread</span><span class="o">::</span><span class="n">sleep_for</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>

<span class="w">        </span><span class="c1">// åŠ å…¥æ–°åŸŸ</span>
<span class="w">        </span><span class="n">createDomainParticipant</span><span class="p">(</span><span class="n">toDomain</span><span class="p">,</span><span class="w"> </span><span class="n">robotId</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// é‡æ–°å‘ç°é‚»å±…</span>
<span class="w">        </span><span class="n">performDiscovery</span><span class="p">(</span><span class="n">toDomain</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">generateUniqueDomain</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åŸºäºç½‘ç»œæ®µå’Œæ—¶é—´æˆ³ç”Ÿæˆå”¯ä¸€åŸŸ ID</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">system_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">now</span><span class="p">.</span><span class="n">time_since_epoch</span><span class="p">()).</span><span class="n">count</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// åŸŸ ID èŒƒå›´ï¼š0-232ï¼ˆé¿å…ä¸ç³»ç»Ÿä¿ç•™åŸŸå†²çªï¼‰</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="p">(</span><span class="n">timestamp</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">200</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">33</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1812">18.1.2 å‘½åç©ºé—´è®¾è®¡æ¨¡å¼</h3>
<p>å‘½åç©ºé—´æ˜¯ ROS2 ä¸­ç»„ç»‡å¤šæœºå™¨äººç³»ç»Ÿçš„æ ¸å¿ƒæœºåˆ¶ï¼Œè‰¯å¥½çš„å‘½åç©ºé—´è®¾è®¡å¯ä»¥é¿å…å†²çªã€ç®€åŒ–ç®¡ç†å¹¶æé«˜ç³»ç»Ÿå¯æ‰©å±•æ€§ã€‚</p>
<p><strong>å‘½åç©ºé—´è®¾è®¡åŸåˆ™ï¼š</strong></p>
<ol>
<li>
<p><strong>å±‚æ¬¡æ€§åŸåˆ™</strong>ï¼šå‘½åç©ºé—´åº”è¯¥åæ˜ ç³»ç»Ÿçš„é€»è¾‘ç»“æ„ã€‚ä¾‹å¦‚ <code>/fleet/warehouse/zone_a/robot_001</code> æ¸…æ™°åœ°è¡¨è¾¾äº†æœºå™¨äººåœ¨ç»„ç»‡ç»“æ„ä¸­çš„ä½ç½®ã€‚</p>
</li>
<li>
<p><strong>å”¯ä¸€æ€§åŸåˆ™</strong>ï¼šæ¯ä¸ªæœºå™¨äººå¿…é¡»æœ‰å…¨å±€å”¯ä¸€çš„æ ‡è¯†ç¬¦ã€‚é€šå¸¸ä½¿ç”¨ UUID æˆ–ç¡¬ä»¶ MAC åœ°å€çš„å“ˆå¸Œå€¼ã€‚</p>
</li>
<li>
<p><strong>å¯é¢„æµ‹æ€§åŸåˆ™</strong>ï¼šå‘½åè§„åˆ™åº”è¯¥ä¸€è‡´ä¸”å¯é¢„æµ‹ï¼Œä¾¿äºè‡ªåŠ¨åŒ–å·¥å…·å¤„ç†ã€‚é¿å…ä½¿ç”¨éšæœºæˆ–ä¸´æ—¶ç”Ÿæˆçš„åç§°ã€‚</p>
</li>
<li>
<p><strong>è¯­ä¹‰åŒ–åŸåˆ™</strong>ï¼šåç§°åº”è¯¥å…·æœ‰æ˜ç¡®çš„è¯­ä¹‰ï¼Œå¦‚ <code>/navigation/robot_001</code> æ¯” <code>/nav/r1</code> æ›´å®¹æ˜“ç†è§£ã€‚</p>
</li>
<li>
<p><strong>ç‰ˆæœ¬åŒ–åŸåˆ™</strong>ï¼šåœ¨å‘½åç©ºé—´ä¸­åŒ…å«ç‰ˆæœ¬ä¿¡æ¯ï¼Œæ”¯æŒä¸åŒç‰ˆæœ¬çš„èŠ‚ç‚¹å…±å­˜ï¼Œå¦‚ <code>/v2/perception/robot_001</code>ã€‚</p>
</li>
</ol>
<p><strong>å‘½åç©ºé—´å†²çªæ£€æµ‹ç®—æ³•ï¼š</strong></p>
<p>åœ¨åŠ¨æ€ç¯å¢ƒä¸­ï¼Œå‘½åç©ºé—´å†²çªå¯èƒ½å¯¼è‡´ä¸¥é‡é—®é¢˜ã€‚æˆ‘ä»¬éœ€è¦å®æ—¶æ£€æµ‹å’Œè§£å†³å†²çªï¼š</p>
<p>$$
P(collision) = 1 - e^{-\frac{n^2}{2m}}
$$</p>
<p>å…¶ä¸­ $n$ æ˜¯æœºå™¨äººæ•°é‡ï¼Œ$m$ æ˜¯å‘½åç©ºé—´çš„æ€»æ•°ã€‚å½“ç¢°æ’æ¦‚ç‡è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œç³»ç»Ÿåº”è‡ªåŠ¨æ‰©å±•å‘½åç©ºé—´æˆ–è§¦å‘é‡å‘½åã€‚</p>
<p><strong>å±‚æ¬¡åŒ–å‘½åç©ºé—´æ¶æ„å®ç°ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NamespaceHierarchy</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;å¤šæœºå™¨äººç³»ç»Ÿå‘½åç©ºé—´ç®¡ç†å™¨&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">namespace_tree</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;fleet&#39;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s1">&#39;warehouse&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;zone_a&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;robot_001&#39;</span><span class="p">,</span> <span class="s1">&#39;robot_002&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;zone_b&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;robot_003&#39;</span><span class="p">,</span> <span class="s1">&#39;robot_004&#39;</span><span class="p">]</span>
                <span class="p">},</span>
                <span class="s1">&#39;delivery&#39;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s1">&#39;urban&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;robot_005&#39;</span><span class="p">,</span> <span class="s1">&#39;robot_006&#39;</span><span class="p">],</span>
                    <span class="s1">&#39;suburban&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;robot_007&#39;</span><span class="p">,</span> <span class="s1">&#39;robot_008&#39;</span><span class="p">]</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">generate_namespace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">robot_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">task_context</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åŸºäºä¸Šä¸‹æ–‡ç”Ÿæˆå‘½åç©ºé—´&quot;&quot;&quot;</span>
        <span class="c1"># åŸºç¡€å‘½åç©ºé—´</span>
        <span class="n">base_ns</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">robot_id</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># ä»»åŠ¡å‘½åç©ºé—´</span>
        <span class="k">if</span> <span class="n">task_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;collaborative&#39;</span><span class="p">):</span>
            <span class="c1"># åä½œä»»åŠ¡ä½¿ç”¨å…±äº«å‘½åç©ºé—´</span>
            <span class="n">task_ns</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;/collaborative/</span><span class="si">{</span><span class="n">task_context</span><span class="p">[</span><span class="s1">&#39;task_id&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">task_ns</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">robot_id</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># ä½ç½®å‘½åç©ºé—´</span>
        <span class="k">if</span> <span class="n">task_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;location&#39;</span><span class="p">):</span>
            <span class="n">location</span> <span class="o">=</span> <span class="n">task_context</span><span class="p">[</span><span class="s1">&#39;location&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">location</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">robot_id</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># åŠŸèƒ½å‘½åç©ºé—´</span>
        <span class="k">if</span> <span class="n">task_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">):</span>
            <span class="n">role</span> <span class="o">=</span> <span class="n">task_context</span><span class="p">[</span><span class="s1">&#39;role&#39;</span><span class="p">]</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;/</span><span class="si">{</span><span class="n">role</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">robot_id</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">return</span> <span class="n">base_ns</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">resolve_topic</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">namespace</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">topic_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;è§£æå®Œæ•´è¯é¢˜åç§°&quot;&quot;&quot;</span>
        <span class="c1"># å¤„ç†ç›¸å¯¹å’Œç»å¯¹è¯é¢˜å</span>
        <span class="k">if</span> <span class="n">topic_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">topic_name</span>  <span class="c1"># ç»å¯¹è¯é¢˜</span>
        <span class="k">elif</span> <span class="n">topic_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;~&#39;</span><span class="p">):</span>
            <span class="c1"># ç§æœ‰è¯é¢˜</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">namespace</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">topic_name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># ç›¸å¯¹è¯é¢˜</span>
            <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">namespace</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">topic_name</span><span class="si">}</span><span class="s2">&quot;</span>
</code></pre></div>

<p><strong>åŠ¨æ€å‘½åç©ºé—´é‡æ˜ å°„ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DynamicRemapper</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">RemapRule</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">source</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">target</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">condition</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">RemapRule</span><span class="o">&gt;</span><span class="w"> </span><span class="n">remapRules</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">PublisherBase</span><span class="o">::</span><span class="n">SharedPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="n">publishers</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">SubscriptionBase</span><span class="o">::</span><span class="n">SharedPtr</span><span class="o">&gt;</span><span class="w"> </span><span class="n">subscribers</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">DynamicRemapper</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="s">&quot;dynamic_remapper&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// é…ç½®é‡æ˜ å°„è§„åˆ™</span>
<span class="w">        </span><span class="n">setupRemapRules</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// å®šæ—¶å™¨æ£€æŸ¥å¹¶æ›´æ–°æ˜ å°„</span>
<span class="w">        </span><span class="n">timer_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_wall_timer</span><span class="p">(</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">bind</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DynamicRemapper</span><span class="o">::</span><span class="n">updateRemappings</span><span class="p">,</span><span class="w"> </span><span class="k">this</span><span class="p">)</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">addRemapRule</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w"> </span>
<span class="w">                      </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">target</span><span class="p">,</span>
<span class="w">                      </span><span class="n">std</span><span class="o">::</span><span class="n">function</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="p">)</span><span class="o">&gt;</span><span class="w"> </span><span class="n">condition</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">remapRules</span><span class="p">.</span><span class="n">push_back</span><span class="p">({</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="n">condition</span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">updateRemappings</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">remapRules</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">rule</span><span class="p">.</span><span class="n">condition</span><span class="p">(</span><span class="n">rule</span><span class="p">.</span><span class="n">source</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// åˆ›å»ºæ¡¥æ¥</span>
<span class="w">                </span><span class="n">createBridge</span><span class="p">(</span><span class="n">rule</span><span class="p">.</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">.</span><span class="n">target</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// ç§»é™¤æ¡¥æ¥</span>
<span class="w">                </span><span class="n">removeBridge</span><span class="p">(</span><span class="n">rule</span><span class="p">.</span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">.</span><span class="n">target</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">createBridge</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">publishers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">publishers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// åˆ›å»ºè®¢é˜…è€…</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">sub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">String</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">source</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">,</span>
<span class="w">            </span><span class="p">[</span><span class="k">this</span><span class="p">,</span><span class="w"> </span><span class="n">target</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">String</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// è½¬å‘æ¶ˆæ¯åˆ°ç›®æ ‡è¯é¢˜</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">publishers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">publishers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">publishers</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="o">*</span><span class="n">msg</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// åˆ›å»ºå‘å¸ƒè€…</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">pub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">String</span><span class="o">&gt;</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="mi">10</span><span class="p">);</span>

<span class="w">        </span><span class="n">subscribers</span><span class="p">[</span><span class="n">source</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sub</span><span class="p">;</span>
<span class="w">        </span><span class="n">publishers</span><span class="p">[</span><span class="n">target</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pub</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1813">18.1.3 å‘ç°æœºåˆ¶ä¸ç½‘ç»œé…ç½®</h3>
<p>ROS2 çš„è‡ªåŠ¨å‘ç°æœºåˆ¶åœ¨å¤šæœºå™¨äººç³»ç»Ÿä¸­æ—¢æ˜¯ä¼˜åŠ¿ä¹Ÿæ˜¯æŒ‘æˆ˜ã€‚æ­£ç¡®é…ç½®å‘ç°æœºåˆ¶å¯¹ç³»ç»Ÿæ€§èƒ½å’Œå®‰å…¨æ€§è‡³å…³é‡è¦ã€‚</p>
<p><strong>å‘ç°æœºåˆ¶çš„æ€§èƒ½å½±å“ï¼š</strong></p>
<p>DDS çš„è‡ªåŠ¨å‘ç°æœºåˆ¶åŸºäº Simple Discovery Protocol (SDP)ï¼Œå®ƒä½¿ç”¨å‘¨æœŸæ€§çš„å¹¿æ’­/å¤šæ’­æ¶ˆæ¯æ¥å‘ç°ç½‘ç»œä¸­çš„å…¶ä»–å‚ä¸è€…ã€‚åœ¨å¤šæœºå™¨äººç³»ç»Ÿä¸­ï¼Œå‘ç°æµé‡ä¼šéšç€èŠ‚ç‚¹æ•°é‡å‘ˆå¹³æ–¹çº§å¢é•¿ï¼š</p>
<p>$$
T_{discovery} = \frac{n(n-1)}{2} \cdot f \cdot s
$$</p>
<p>å…¶ä¸­ $n$ æ˜¯èŠ‚ç‚¹æ•°é‡ï¼Œ$f$ æ˜¯å‘ç°é¢‘ç‡ï¼Œ$s$ æ˜¯å•ä¸ªå‘ç°æ¶ˆæ¯çš„å¤§å°ã€‚å½“ $n &gt; 100$ æ—¶ï¼Œå‘ç°æµé‡å¯èƒ½å ç”¨æ˜¾è‘—çš„ç½‘ç»œå¸¦å®½ã€‚</p>
<p><strong>å‘ç°ä¼˜åŒ–ç­–ç•¥ï¼š</strong></p>
<ol>
<li><strong>é™æ€å‘ç°</strong>ï¼šå¯¹äºå·²çŸ¥çš„å›ºå®šæ‹“æ‰‘ï¼Œä½¿ç”¨ Discovery Server æ¨¡å¼æ›¿ä»£å¤šæ’­å‘ç°</li>
<li><strong>åˆ†çº§å‘ç°</strong>ï¼šå°†æœºå™¨äººåˆ†ç»„ï¼Œç»„å†…ä½¿ç”¨å¤šæ’­ï¼Œç»„é—´ä½¿ç”¨å•æ’­</li>
<li><strong>è‡ªé€‚åº”å‘ç°</strong>ï¼šæ ¹æ®ç½‘ç»œè´¨é‡åŠ¨æ€è°ƒæ•´å‘ç°é¢‘ç‡</li>
<li><strong>å‘ç°ç¼“å­˜</strong>ï¼šç¼“å­˜å·²å‘ç°çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œå‡å°‘é‡å¤å‘ç°</li>
</ol>
<p><strong>ç½‘ç»œé…ç½®æœ€ä½³å®è·µï¼š</strong></p>
<p>åœ¨å®é™…éƒ¨ç½²ä¸­ï¼Œç½‘ç»œé…ç½®ç›´æ¥å½±å“ç³»ç»Ÿæ€§èƒ½ã€‚ä»¥ä¸‹æ˜¯ç»è¿‡éªŒè¯çš„é…ç½®å‚æ•°ï¼š</p>
<ul>
<li><strong>MTU ä¼˜åŒ–</strong>ï¼šè®¾ç½® MTU ä¸º 9000ï¼ˆå·¨å‹å¸§ï¼‰å¯ä»¥å‡å°‘åˆ†ç‰‡ï¼Œæé«˜å¤§æ•°æ®ä¼ è¾“æ•ˆç‡</li>
<li><strong>QoS é…ç½®</strong>ï¼šæ ¹æ®æ•°æ®ç±»å‹é€‰æ‹©åˆé€‚çš„ QoS ç­–ç•¥</li>
<li>æ§åˆ¶å‘½ä»¤ï¼šRELIABLE + VOLATILEï¼ˆä½å»¶è¿Ÿä¼˜å…ˆï¼‰</li>
<li>ä¼ æ„Ÿå™¨æ•°æ®ï¼šBEST_EFFORT + VOLATILEï¼ˆååé‡ä¼˜å…ˆï¼‰</li>
<li>é…ç½®å‚æ•°ï¼šRELIABLE + TRANSIENT_LOCALï¼ˆæŒä¹…æ€§ä¼˜å…ˆï¼‰</li>
<li><strong>å¤šæ’­åœ°å€è§„åˆ’</strong>ï¼šé¿å…ä½¿ç”¨é»˜è®¤å¤šæ’­åœ°å€ï¼Œé˜²æ­¢ä¸å…¶ä»–ç³»ç»Ÿå†²çª</li>
</ul>
<p><strong>è‡ªå®šä¹‰å‘ç°ç­–ç•¥å®ç°ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">DiscoveryManager</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">PeerInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">robotId</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">ipAddress</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">domainId</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">lastSeen</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">signalStrength</span><span class="p">;</span><span class="w">  </span><span class="c1">// ç”¨äºæ— çº¿ç½‘ç»œ</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">latency</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">PeerInfo</span><span class="o">&gt;</span><span class="w"> </span><span class="n">discoveredPeers</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">set</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">trustedPeers</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// é…ç½® DDS å‘ç°å‚æ•°</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">configureDDSDiscovery</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// è®¾ç½®åˆå§‹å‘ç°åˆ—è¡¨ï¼ˆé¿å…å¹¿æ’­ï¼‰</span>
<span class="w">        </span><span class="n">setenv</span><span class="p">(</span><span class="s">&quot;ROS_DISCOVERY_SERVER&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;192.168.1.100:11811&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// é…ç½®å‘ç°åè®®</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">qos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rmw_qos_profile_default</span><span class="p">;</span>
<span class="w">        </span><span class="n">qos</span><span class="p">.</span><span class="n">liveliness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RMW_QOS_POLICY_LIVELINESS_AUTOMATIC</span><span class="p">;</span>
<span class="w">        </span><span class="n">qos</span><span class="p">.</span><span class="n">liveliness_lease_duration</span><span class="p">.</span><span class="n">sec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="n">qos</span><span class="p">.</span><span class="n">liveliness_lease_duration</span><span class="p">.</span><span class="n">nsec</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// é™åˆ¶å‘ç°èŒƒå›´</span>
<span class="w">        </span><span class="n">configureMulticast</span><span class="p">(</span><span class="s">&quot;239.255.0.1&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">7400</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// è‡ªé€‚åº”å‘ç°ç­–ç•¥</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">adaptiveDiscovery</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åŸºäºç½‘ç»œè´¨é‡è°ƒæ•´å‘ç°é¢‘ç‡</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">peer</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">discoveredPeers</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">peer</span><span class="p">.</span><span class="n">latency</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">100.0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// é«˜å»¶è¿Ÿ</span>
<span class="w">                </span><span class="c1">// é™ä½å‘ç°é¢‘ç‡</span>
<span class="w">                </span><span class="n">setDiscoveryPeriod</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">seconds</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">peer</span><span class="p">.</span><span class="n">signalStrength</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">-70</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// å¼±ä¿¡å·</span>
<span class="w">                </span><span class="c1">// å¢åŠ é‡è¯•æ¬¡æ•°</span>
<span class="w">                </span><span class="n">setDiscoveryRetries</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// å®‰å…¨å‘ç°è¿‡æ»¤</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">filterPeer</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">peerId</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">peerInfo</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ç™½åå•æ£€æŸ¥</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">trustedPeers</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">peerId</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">trustedPeers</span><span class="p">.</span><span class="n">end</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">RCLCPP_WARN</span><span class="p">(</span><span class="n">logger_</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Untrusted peer rejected: %s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">peerId</span><span class="p">.</span><span class="n">c_str</span><span class="p">());</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// éªŒè¯è¯ä¹¦ï¼ˆå¦‚æœå¯ç”¨ SROS2ï¼‰</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">verifyCertificate</span><span class="p">(</span><span class="n">peerId</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">configureMulticast</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">address</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">port</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// é…ç½®å¤šæ’­åœ°å€å’Œç«¯å£</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sa">R</span><span class="s">&quot;</span><span class="dl">(</span>
<span class="s">            &lt;dds&gt;</span>
<span class="s">                &lt;transport_descriptors&gt;</span>
<span class="s">                    &lt;transport_descriptor&gt;</span>
<span class="s">                        &lt;transport_id&gt;CustomMulticast&lt;/transport_id&gt;</span>
<span class="s">                        &lt;type&gt;UDPv4&lt;/type&gt;</span>
<span class="s">                        &lt;interfaceWhiteList&gt;</span>
<span class="s">                            &lt;address&gt;192.168.1.0/24&lt;/address&gt;</span>
<span class="s">                        &lt;/interfaceWhiteList&gt;</span>
<span class="s">                    &lt;/transport_descriptor&gt;</span>
<span class="s">                &lt;/transport_descriptors&gt;</span>
<span class="s">            &lt;/dds&gt;</span>
<span class="s">        </span><span class="dl">)</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// åº”ç”¨é…ç½®</span>
<span class="w">        </span><span class="n">applyDDSConfig</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>ç½‘ç»œåˆ†åŒºä¸éš”ç¦»ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">NetworkPartitioner</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;ç½‘ç»œåˆ†åŒºç®¡ç†å™¨forå¤šæœºå™¨äººç³»ç»Ÿ&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">partitions</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">routing_table</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_partition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partition_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> 
                        <span class="n">robots</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
                        <span class="n">isolation_level</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s1">&#39;soft&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆ›å»ºç½‘ç»œåˆ†åŒº&quot;&quot;&quot;</span>
        <span class="n">partition</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s1">&#39;id&#39;</span><span class="p">:</span> <span class="n">partition_id</span><span class="p">,</span>
            <span class="s1">&#39;robots&#39;</span><span class="p">:</span> <span class="n">robots</span><span class="p">,</span>
            <span class="s1">&#39;isolation&#39;</span><span class="p">:</span> <span class="n">isolation_level</span><span class="p">,</span>
            <span class="s1">&#39;vlan_id&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allocate_vlan</span><span class="p">()</span> <span class="k">if</span> <span class="n">isolation_level</span> <span class="o">==</span> <span class="s1">&#39;hard&#39;</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
            <span class="s1">&#39;multicast_group&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_allocate_multicast_group</span><span class="p">(),</span>
            <span class="s1">&#39;qos_profile&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_determine_qos</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">robots</span><span class="p">))</span>
        <span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">partitions</span><span class="p">[</span><span class="n">partition_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">partition</span>

        <span class="c1"># é…ç½®è·¯ç”±</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_configure_routing</span><span class="p">(</span><span class="n">partition</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">partition</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_configure_routing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partition</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;é…ç½®åˆ†åŒºè·¯ç”±è§„åˆ™&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">partition</span><span class="p">[</span><span class="s1">&#39;isolation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;hard&#39;</span><span class="p">:</span>
            <span class="c1"># ç¡¬éš”ç¦»ï¼šé…ç½® VLAN</span>
            <span class="k">for</span> <span class="n">robot</span> <span class="ow">in</span> <span class="n">partition</span><span class="p">[</span><span class="s1">&#39;robots&#39;</span><span class="p">]:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_set_vlan</span><span class="p">(</span><span class="n">robot</span><span class="p">,</span> <span class="n">partition</span><span class="p">[</span><span class="s1">&#39;vlan_id&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">partition</span><span class="p">[</span><span class="s1">&#39;isolation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;soft&#39;</span><span class="p">:</span>
            <span class="c1"># è½¯éš”ç¦»ï¼šé…ç½®é˜²ç«å¢™è§„åˆ™</span>
            <span class="n">rules</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_firewall_rules</span><span class="p">(</span><span class="n">partition</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_apply_firewall_rules</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">merge_partitions</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">partition_ids</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;åˆå¹¶å¤šä¸ªåˆ†åŒº&quot;&quot;&quot;</span>
        <span class="n">merged_robots</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pid</span> <span class="ow">in</span> <span class="n">partition_ids</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">partitions</span><span class="p">:</span>
                <span class="n">merged_robots</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">partitions</span><span class="p">[</span><span class="n">pid</span><span class="p">][</span><span class="s1">&#39;robots&#39;</span><span class="p">])</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">partitions</span><span class="p">[</span><span class="n">pid</span><span class="p">]</span>

        <span class="c1"># åˆ›å»ºæ–°çš„åˆå¹¶åˆ†åŒº</span>
        <span class="n">new_partition_id</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;merged_</span><span class="si">{</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">partition_ids</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">create_partition</span><span class="p">(</span><span class="n">new_partition_id</span><span class="p">,</span> <span class="n">merged_robots</span><span class="p">,</span> <span class="s1">&#39;soft&#39;</span><span class="p">)</span>
</code></pre></div>

<h2 id="182">18.2 åˆ†å¸ƒå¼é€šä¿¡æ¶æ„</h2>
<h3 id="1821">18.2.1 é€šä¿¡æ‹“æ‰‘è®¾è®¡</h3>
<p>å¤šæœºå™¨äººç³»ç»Ÿçš„é€šä¿¡æ‹“æ‰‘ç›´æ¥å½±å“ç³»ç»Ÿçš„å¯æ‰©å±•æ€§ã€é²æ£’æ€§å’Œæ€§èƒ½ã€‚é€‰æ‹©åˆé€‚çš„æ‹“æ‰‘ç»“æ„æ˜¯ç³»ç»Ÿè®¾è®¡çš„å…³é”®å†³ç­–ã€‚</p>
<p><strong>å¸¸è§é€šä¿¡æ‹“æ‰‘å¯¹æ¯”ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="mf">1.</span><span class="w"> </span><span class="n">æ˜Ÿå‹æ‹“æ‰‘</span><span class="err">ï¼ˆ</span><span class="n">Star</span><span class="w"> </span><span class="kr">To</span><span class="n">pology</span><span class="err">ï¼‰ï¼š</span>
<span class="w">     </span><span class="err">â”Œâ”€â”€</span><span class="n">R1</span><span class="err">â”€â”€â”</span>
<span class="w">     </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span>
<span class="w">   </span><span class="n">R2</span><span class="err">â”¤</span><span class="w">  </span><span class="n">C</span><span class="w">   </span><span class="err">â”œ</span><span class="n">R4</span>
<span class="w">     </span><span class="err">â”‚</span><span class="w">      </span><span class="err">â”‚</span>
<span class="w">     </span><span class="err">â””â”€â”€</span><span class="n">R3</span><span class="err">â”€â”€â”˜</span>
<span class="w">   </span><span class="n">ä¼˜ç‚¹</span><span class="err">ï¼š</span><span class="n">ç®€å•</span><span class="err">ã€</span><span class="n">æ˜“ç®¡ç†</span>
<span class="w">   </span><span class="n">ç¼ºç‚¹</span><span class="err">ï¼š</span><span class="n">å•ç‚¹æ•…éšœ</span><span class="err">ã€</span><span class="n">æ‰©å±•æ€§å·®</span>

<span class="mf">2.</span><span class="w"> </span><span class="n">ç½‘çŠ¶æ‹“æ‰‘</span><span class="err">ï¼ˆ</span><span class="n">Mesh</span><span class="w"> </span><span class="kr">To</span><span class="n">pology</span><span class="err">ï¼‰ï¼š</span>
<span class="w">   </span><span class="n">R1</span><span class="w"> </span><span class="err">â”€â”€â”€</span><span class="w"> </span><span class="n">R2</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â•²</span><span class="w">   </span><span class="err">â•±</span><span class="w"> </span><span class="err">â”‚</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w">   </span><span class="err">â•³</span><span class="w">   </span><span class="err">â”‚</span>
<span class="w">   </span><span class="err">â”‚</span><span class="w"> </span><span class="err">â•±</span><span class="w">   </span><span class="err">â•²</span><span class="w"> </span><span class="err">â”‚</span>
<span class="w">   </span><span class="n">R3</span><span class="w"> </span><span class="err">â”€â”€â”€</span><span class="w"> </span><span class="n">R4</span>
<span class="w">   </span><span class="n">ä¼˜ç‚¹</span><span class="err">ï¼š</span><span class="n">é«˜å†—ä½™</span><span class="err">ã€</span><span class="n">é²æ£’æ€§å¼º</span>
<span class="w">   </span><span class="n">ç¼ºç‚¹</span><span class="err">ï¼š</span><span class="n">å¤æ‚åº¦é«˜</span><span class="err">ã€</span><span class="n">å¼€é”€å¤§</span>

<span class="mf">3.</span><span class="w"> </span><span class="n">åˆ†å±‚æ‹“æ‰‘</span><span class="err">ï¼ˆ</span><span class="n">Hierarchical</span><span class="w"> </span><span class="kr">To</span><span class="n">pology</span><span class="err">ï¼‰ï¼š</span>
<span class="w">       </span><span class="n">M</span>
<span class="w">      </span><span class="err">â•±</span><span class="w"> </span><span class="err">â•²</span>
<span class="w">    </span><span class="n">L1</span><span class="w">   </span><span class="n">L2</span>
<span class="w">   </span><span class="err">â•±</span><span class="w"> </span><span class="err">â•²</span><span class="w">  </span><span class="err">â•±</span><span class="w"> </span><span class="err">â•²</span>
<span class="w">  </span><span class="n">R1</span><span class="w"> </span><span class="n">R2</span><span class="w"> </span><span class="n">R3</span><span class="w"> </span><span class="n">R4</span>
<span class="w">   </span><span class="n">ä¼˜ç‚¹</span><span class="err">ï¼š</span><span class="n">å¯æ‰©å±•</span><span class="err">ã€</span><span class="n">åˆ†çº§æ§åˆ¶</span>
<span class="w">   </span><span class="n">ç¼ºç‚¹</span><span class="err">ï¼š</span><span class="n">å±‚é—´ç“¶é¢ˆ</span><span class="err">ã€</span><span class="n">å»¶è¿Ÿå¢åŠ </span>
</code></pre></div>

<p><strong>è‡ªé€‚åº”æ‹“æ‰‘ç®¡ç†å™¨ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">AdaptiveTopologyManager</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">enum</span><span class="w"> </span><span class="k">class</span><span class="w"> </span><span class="nc">TopologyType</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">STAR</span><span class="p">,</span>
<span class="w">        </span><span class="n">MESH</span><span class="p">,</span>
<span class="w">        </span><span class="n">HIERARCHICAL</span><span class="p">,</span>
<span class="w">        </span><span class="n">HYBRID</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">NetworkMetrics</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">averageLatency</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">packetLossRate</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">bandwidth</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">nodeCount</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">networkDiameter</span><span class="p">;</span><span class="w">  </span><span class="c1">// æœ€å¤§è·³æ•°</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">TopologyType</span><span class="w"> </span><span class="n">currentTopology</span><span class="p">;</span>
<span class="w">    </span><span class="n">NetworkMetrics</span><span class="w"> </span><span class="n">metrics</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// åŠ¨æ€æ‹“æ‰‘é€‰æ‹©</span>
<span class="w">    </span><span class="n">TopologyType</span><span class="w"> </span><span class="n">selectOptimalTopology</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">updateNetworkMetrics</span><span class="p">();</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="n">nodeCount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// å°è§„æ¨¡ï¼šå…¨è¿æ¥ç½‘çŠ¶</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">TopologyType</span><span class="o">::</span><span class="n">MESH</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="n">nodeCount</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">20</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// ä¸­ç­‰è§„æ¨¡ï¼šåˆ†å±‚ç»“æ„</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">TopologyType</span><span class="o">::</span><span class="n">HIERARCHICAL</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">metrics</span><span class="p">.</span><span class="n">packetLossRate</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">0.05</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// é«˜ä¸¢åŒ…ç‡ï¼šå¢åŠ å†—ä½™çš„æ··åˆæ‹“æ‰‘</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">TopologyType</span><span class="o">::</span><span class="n">HYBRID</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// å¤§è§„æ¨¡ç¨³å®šç½‘ç»œï¼šæ˜Ÿå‹withå¤‡ä»½</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">TopologyType</span><span class="o">::</span><span class="n">STAR</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// æ‹“æ‰‘é‡æ„</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">reconfigureTopology</span><span class="p">(</span><span class="n">TopologyType</span><span class="w"> </span><span class="n">newTopology</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ä¿å­˜å½“å‰çŠ¶æ€</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">currentState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">captureSystemState</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// é€šçŸ¥æ‰€æœ‰èŠ‚ç‚¹å‡†å¤‡é‡æ„</span>
<span class="w">        </span><span class="n">broadcastReconfigurationNotice</span><span class="p">(</span><span class="n">newTopology</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ‰§è¡Œåˆ†é˜¶æ®µé‡æ„</span>
<span class="w">        </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">newTopology</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">TopologyType</span><span class="o">::</span><span class="no">STAR</span><span class="p">:</span>
<span class="w">                </span><span class="n">reconfigureToStar</span><span class="p">();</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">TopologyType</span><span class="o">::</span><span class="no">MESH</span><span class="p">:</span>
<span class="w">                </span><span class="n">reconfigureToMesh</span><span class="p">();</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">TopologyType</span><span class="o">::</span><span class="no">HIERARCHICAL</span><span class="p">:</span>
<span class="w">                </span><span class="n">reconfigureToHierarchical</span><span class="p">();</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="no">TopologyType</span><span class="o">::</span><span class="no">HYBRID</span><span class="p">:</span>
<span class="w">                </span><span class="n">reconfigureToHybrid</span><span class="p">();</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// éªŒè¯æ–°æ‹“æ‰‘</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">validateTopology</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// å›æ»šåˆ°ä¹‹å‰çŠ¶æ€</span>
<span class="w">            </span><span class="n">rollbackTopology</span><span class="p">(</span><span class="n">currentState</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">reconfigureToHierarchical</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// é€‰ä¸¾å±‚çº§é¢†å¯¼è€…</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">leaders</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">electLeaders</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// åˆ†é…èŠ‚ç‚¹åˆ°é›†ç¾¤</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">clusters</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">partitionNodes</span><span class="p">(</span><span class="n">leaders</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å»ºç«‹å±‚å†…è¿æ¥</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">cluster</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">clusters</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">establishIntraClusterConnections</span><span class="p">(</span><span class="n">cluster</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// å»ºç«‹å±‚é—´è¿æ¥</span>
<span class="w">        </span><span class="n">establishInterClusterConnections</span><span class="p">(</span><span class="n">leaders</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1822">18.2.2 æ¶ˆæ¯è·¯ç”±ä¸è´Ÿè½½å‡è¡¡</h3>
<p>åœ¨å¤šæœºå™¨äººç³»ç»Ÿä¸­ï¼Œé«˜æ•ˆçš„æ¶ˆæ¯è·¯ç”±å’Œè´Ÿè½½å‡è¡¡å¯¹äºç³»ç»Ÿæ€§èƒ½è‡³å…³é‡è¦ã€‚</p>
<p><strong>æ™ºèƒ½æ¶ˆæ¯è·¯ç”±å™¨å®ç°ï¼š</strong></p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">MessageRouter</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Route</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">source</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="w"> </span><span class="n">destination</span><span class="p">;</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">cost</span><span class="p">;</span><span class="w">  </span><span class="c1">// è·¯ç”±æˆæœ¬ï¼ˆå»¶è¿Ÿã€è·³æ•°ç­‰ï¼‰</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">steady_clock</span><span class="o">::</span><span class="n">time_point</span><span class="w"> </span><span class="n">lastUpdate</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">MessageQueue</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">deque</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">any</span><span class="o">&gt;</span><span class="w"> </span><span class="n">messages</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">size_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">size</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="w"> </span><span class="n">mutex</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">condition_variable</span><span class="w"> </span><span class="n">cv</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// è·¯ç”±è¡¨</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Route</span><span class="o">&gt;</span><span class="w"> </span><span class="n">routingTable</span><span class="p">;</span>
<span class="w">    </span><span class="c1">// æ¶ˆæ¯é˜Ÿåˆ—</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">MessageQueue</span><span class="o">&gt;</span><span class="w"> </span><span class="n">queues</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// åŸºäºå†…å®¹çš„è·¯ç”±</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">routeMessage</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">topic</span><span class="p">,</span><span class="w"> </span>
<span class="w">                     </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">any</span><span class="o">&amp;</span><span class="w"> </span><span class="n">message</span><span class="p">,</span>
<span class="w">                     </span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">any</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">metadata</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// æå–è·¯ç”±é”®</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">routingKey</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">extractRoutingKey</span><span class="p">(</span><span class="n">topic</span><span class="p">,</span><span class="w"> </span><span class="n">metadata</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æŸ¥æ‰¾æœ€ä½³è·¯ç”±</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">routes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">findRoutes</span><span class="p">(</span><span class="n">routingKey</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// è´Ÿè½½å‡è¡¡ç­–ç•¥</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">selectedRoute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loadBalance</span><span class="p">(</span><span class="n">routes</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å‘é€æ¶ˆæ¯</span>
<span class="w">        </span><span class="n">sendViaRoute</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">selectedRoute</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// åŠ¨æ€è´Ÿè½½å‡è¡¡ç®—æ³•</span>
<span class="w">    </span><span class="n">Route</span><span class="w"> </span><span class="n">loadBalance</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Route</span><span class="o">&gt;&amp;</span><span class="w"> </span><span class="n">routes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">routes</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">runtime_error</span><span class="p">(</span><span class="s">&quot;No available routes&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// åŠ æƒè½®è¯¢withåŠ¨æ€æƒé‡è°ƒæ•´</span>
<span class="w">        </span><span class="k">static</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">weights</span><span class="p">;</span>
<span class="w">        </span><span class="k">static</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">currentWeight</span><span class="p">;</span>

<span class="w">        </span><span class="n">Route</span><span class="w"> </span><span class="n">selectedRoute</span><span class="p">;</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">maxWeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">route</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">routes</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// åŠ¨æ€è®¡ç®—æƒé‡based onå»¶è¿Ÿå’Œé˜Ÿåˆ—é•¿åº¦</span>
<span class="w">            </span><span class="kt">int</span><span class="w"> </span><span class="n">weight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculateDynamicWeight</span><span class="p">(</span><span class="n">route</span><span class="p">);</span>
<span class="w">            </span><span class="n">weights</span><span class="p">[</span><span class="n">route</span><span class="p">.</span><span class="n">destination</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weight</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// åŠ æƒè½®è¯¢ç®—æ³•</span>
<span class="w">            </span><span class="n">currentWeight</span><span class="p">[</span><span class="n">route</span><span class="p">.</span><span class="n">destination</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">weight</span><span class="p">;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">currentWeight</span><span class="p">[</span><span class="n">route</span><span class="p">.</span><span class="n">destination</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxWeight</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">maxWeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">currentWeight</span><span class="p">[</span><span class="n">route</span><span class="p">.</span><span class="n">destination</span><span class="p">];</span>
<span class="w">                </span><span class="n">selectedRoute</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">route</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// æ›´æ–°å½“å‰æƒé‡</span>
<span class="w">        </span><span class="n">currentWeight</span><span class="p">[</span><span class="n">selectedRoute</span><span class="p">.</span><span class="n">destination</span><span class="p">]</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">accumulate</span><span class="p">(</span><span class="n">weights</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span><span class="w"> </span><span class="n">weights</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                          </span><span class="p">[](</span><span class="kt">int</span><span class="w"> </span><span class="n">sum</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">p</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">second</span><span class="p">;</span><span class="w"> </span><span class="p">});</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">selectedRoute</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">calculateDynamicWeight</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">Route</span><span class="o">&amp;</span><span class="w"> </span><span class="n">route</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åŸºç¡€æƒé‡</span>
<span class="w">        </span><span class="kt">int</span><span class="w"> </span><span class="n">baseWeight</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// å»¶è¿Ÿå› å­ï¼ˆå»¶è¿Ÿè¶Šä½ï¼Œæƒé‡è¶Šé«˜ï¼‰</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">latencyFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">route</span><span class="p">.</span><span class="n">cost</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// é˜Ÿåˆ—é•¿åº¦å› å­</span>
<span class="w">        </span><span class="kt">size_t</span><span class="w"> </span><span class="n">queueLength</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">queues</span><span class="p">[</span><span class="n">route</span><span class="p">.</span><span class="n">destination</span><span class="p">].</span><span class="n">size</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">queueFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="mf">1.0</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">queueLength</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">100.0</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// CPU è´Ÿè½½å› å­ï¼ˆéœ€è¦ç›‘æ§ç³»ç»Ÿï¼‰</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">cpuLoad</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getCPULoad</span><span class="p">(</span><span class="n">route</span><span class="p">.</span><span class="n">destination</span><span class="p">);</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">cpuFactor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">cpuLoad</span><span class="p">;</span>

<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">baseWeight</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">latencyFactor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">queueFactor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">cpuFactor</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>
            </article>
            
            <nav class="page-nav"><a href="chapter17.html" class="nav-link prev">â† ç¬¬ 17 ç« ï¼šä»¿çœŸé›†æˆï¼ˆGazebo/Ignitionï¼‰</a><a href="chapter19.html" class="nav-link next">ç¬¬ 19 ç« ï¼šè®¡ç®—æœºè§†è§‰ä¸æ·±åº¦å­¦ä¹  â†’</a></nav>
        </main>
    </div>
</body>
</html>