<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <base href="./">
    <title>ç¬¬ 15 ç« ï¼šå®æ—¶ç³»ç»Ÿä¸æ€§èƒ½ä¼˜åŒ–</title>
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="assets/highlight.css">
    <script src="assets/script.js" defer></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']],
                processEscapes: false,
                packages: {'[+]': ['noerrors', 'ams']}
            },
            options: {
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            loader: {
                load: ['[tex]/noerrors', '[tex]/ams']
            }
        };
    </script>
</head>
<body>
    <div class="container">
        <nav id="sidebar" class="sidebar">
            <div class="sidebar-header">
                <h3>ç›®å½•</h3>
                <button id="sidebar-toggle" class="sidebar-toggle">
                    <span></span>
                    <span></span>
                    <span></span>
                </button>
            </div>
            <div class="sidebar-search">
                <input type="text" id="sidebar-search-input" placeholder="æœç´¢..." autocomplete="off">
            </div>
            <div id="tree-container">
                <nav class="tree-nav" role="tree">
                    <div class="tree-item " >
                        <a href="index.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ROS2 å®Œå…¨æ•™ç¨‹ï¼šä»åŸç†åˆ°å®è·µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter1.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 1 ç« ï¼šROS1 æ ¸å¿ƒæ¦‚å¿µå›é¡¾</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter2.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 2 ç« ï¼šROS1 çš„å±€é™æ€§åˆ†æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter3.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 3 ç« ï¼šä» ROS1 åˆ° ROS2 çš„è¿ç§»ç­–ç•¥</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter4.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 4 ç« ï¼šROS2 æ¶æ„ä¸è®¾è®¡ç†å¿µ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter5.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 5 ç« ï¼šèŠ‚ç‚¹ä¸æ‰§è¡Œå™¨æ¨¡å‹</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter6.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 6 ç« ï¼šé€šä¿¡æœºåˆ¶æ·±åº¦è§£æ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter7.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 7 ç« ï¼šLaunch ç³»ç»Ÿä¸é…ç½®ç®¡ç†</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter8.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 8 ç« ï¼štf2 åæ ‡å˜æ¢æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter9.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 9 ç« ï¼šæ—¶é—´åŒæ­¥ä¸å›æ”¾ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter10.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 10 ç« ï¼šä¼ æ„Ÿå™¨æ•°æ®å¤„ç†ç®¡é“</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter11.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 11 ç« ï¼šSLAM ä¸å®šä½ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter12.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 12 ç« ï¼šå¯¼èˆªæ ˆ Nav2</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter13.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 13 ç« ï¼šros2_control æ¡†æ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter14.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 14 ç« ï¼šMoveIt2 è¿åŠ¨è§„åˆ’</span>
                        </a>
                    </div>
                
                    <div class="tree-item active" >
                        <a href="chapter15.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 15 ç« ï¼šå®æ—¶ç³»ç»Ÿä¸æ€§èƒ½ä¼˜åŒ–</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter16.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 16 ç« ï¼šå®‰å…¨æ€§ä¸è¯Šæ–­ç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter17.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 17 ç« ï¼šä»¿çœŸé›†æˆï¼ˆGazebo/Ignitionï¼‰</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter18.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 18 ç« ï¼šå¤šæœºå™¨äººç³»ç»Ÿ</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter19.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 19 ç« ï¼šè®¡ç®—æœºè§†è§‰ä¸æ·±åº¦å­¦ä¹ </span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter20.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 20 ç« ï¼šæœºå™¨äººå¼ºåŒ–å­¦ä¹ </span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter21.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 21 ç« ï¼šå¤§è¯­è¨€æ¨¡å‹ä¸å…·èº«æ™ºèƒ½</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="chapter22.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">ç¬¬ 22 ç« ï¼šç¥ç»ç½‘ç»œè¿åŠ¨æ§åˆ¶</span>
                        </a>
                    </div>
                
                    <div class="tree-item " >
                        <a href="CLAUDE.html" class="tree-link">
                            <span class="tree-icon">ğŸ“„</span>
                            <span class="tree-title">Untitled</span>
                        </a>
                    </div>
                </nav>
            </div>
        </nav>
        
        <main class="content">
            <article>
                <h1 id="15">ç¬¬ 15 ç« ï¼šå®æ—¶ç³»ç»Ÿä¸æ€§èƒ½ä¼˜åŒ–</h1>
<p>æœ¬ç« æ·±å…¥æ¢è®¨ ROS2 çš„å®æ—¶æ€§èƒ½ä¼˜åŒ–æŠ€æœ¯ï¼Œæ¶µç›–ä»å†…æ ¸é…ç½®åˆ° DDS è°ƒä¼˜çš„å…¨æ ˆä¼˜åŒ–ç­–ç•¥ã€‚æˆ‘ä»¬å°†å­¦ä¹ å¦‚ä½•æ„å»ºæ»¡è¶³ç¡¬å®æ—¶è¦æ±‚çš„æœºå™¨äººæ§åˆ¶ç³»ç»Ÿï¼Œå®ç°å¾®ç§’çº§å»¶è¿Ÿå’Œç¡®å®šæ€§è¡Œä¸ºã€‚å¯¹äºéœ€è¦é«˜é¢‘æ§åˆ¶å¾ªç¯çš„åº”ç”¨ï¼ˆå¦‚æ‰‹æœ¯æœºå™¨äººã€é«˜é€Ÿæœºæ¢°è‡‚ï¼‰ï¼Œè¿™äº›æŠ€æœ¯è‡³å…³é‡è¦ã€‚</p>
<h2 id="151">15.1 å®æ—¶å†…æ ¸é…ç½®</h2>
<h3 id="1511-linux">15.1.1 Linux å®æ—¶æ€§åŸºç¡€</h3>
<p>æ ‡å‡† Linux å†…æ ¸é‡‡ç”¨åˆ†æ—¶è°ƒåº¦ç­–ç•¥ï¼Œæ— æ³•ä¿è¯ä»»åŠ¡çš„ç¡®å®šæ€§æ‰§è¡Œæ—¶é—´ã€‚å®æ—¶æ€§è¦æ±‚ç³»ç»Ÿèƒ½å¤Ÿåœ¨è§„å®šçš„æ—¶é—´çº¦æŸå†…å“åº”å¤–éƒ¨äº‹ä»¶ï¼Œè¿™å¯¹æœºå™¨äººæ§åˆ¶è‡³å…³é‡è¦ã€‚</p>
<p>å®æ—¶ç³»ç»Ÿåˆ†ä¸ºä¸¤ç±»ï¼š</p>
<ul>
<li><strong>ç¡¬å®æ—¶ï¼ˆHard Real-timeï¼‰</strong>ï¼šå¿…é¡»åœ¨æˆªæ­¢æ—¶é—´å†…å®Œæˆä»»åŠ¡ï¼Œå¦åˆ™ä¼šå¯¼è‡´ç³»ç»Ÿå¤±è´¥</li>
<li><strong>è½¯å®æ—¶ï¼ˆSoft Real-timeï¼‰</strong>ï¼šå¶å°”é”™è¿‡æˆªæ­¢æ—¶é—´å¯ä»¥æ¥å—ï¼Œä½†ä¼šé™ä½ç³»ç»Ÿæ€§èƒ½</li>
</ul>
<p>å®æ—¶æ€§çš„å…³é”®æŒ‡æ ‡ï¼š</p>
<ul>
<li><strong>å»¶è¿Ÿï¼ˆLatencyï¼‰</strong>ï¼šä»äº‹ä»¶å‘ç”Ÿåˆ°ç³»ç»Ÿå“åº”çš„æ—¶é—´</li>
<li><strong>æŠ–åŠ¨ï¼ˆJitterï¼‰</strong>ï¼šå»¶è¿Ÿçš„å˜åŒ–èŒƒå›´</li>
<li><strong>ç¡®å®šæ€§ï¼ˆDeterminismï¼‰</strong>ï¼šç³»ç»Ÿè¡Œä¸ºçš„å¯é¢„æµ‹æ€§</li>
</ul>
<h3 id="1512-preempt-rt">15.1.2 PREEMPT-RT è¡¥ä¸</h3>
<p>PREEMPT-RT æ˜¯ Linux å†…æ ¸çš„å®æ—¶è¡¥ä¸ï¼Œå°†æ ‡å‡†å†…æ ¸è½¬æ¢ä¸ºå®Œå…¨å¯æŠ¢å çš„å®æ—¶å†…æ ¸ã€‚</p>
<p>ä¸»è¦ç‰¹æ€§ï¼š</p>
<ol>
<li><strong>å®Œå…¨å†…æ ¸æŠ¢å </strong>ï¼šé™¤äº†å°‘æ•°å…³é”®åŒºåŸŸï¼Œå†…æ ¸ä»£ç å¯ä»¥è¢«é«˜ä¼˜å…ˆçº§ä»»åŠ¡æŠ¢å </li>
<li><strong>ä¸­æ–­çº¿ç¨‹åŒ–</strong>ï¼šå°†ç¡¬ä¸­æ–­å¤„ç†ç¨‹åºè½¬æ¢ä¸ºå†…æ ¸çº¿ç¨‹</li>
<li><strong>ä¼˜å…ˆçº§ç»§æ‰¿</strong>ï¼šè§£å†³ä¼˜å…ˆçº§åè½¬é—®é¢˜</li>
<li><strong>é«˜ç²¾åº¦å®šæ—¶å™¨</strong>ï¼šæä¾›çº³ç§’çº§å®šæ—¶ç²¾åº¦</li>
</ol>
<p>å®‰è£…é…ç½®æ­¥éª¤ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># ä¸‹è½½å†…æ ¸æºç å’Œ RT è¡¥ä¸</span>
wget<span class="w"> </span>https://kernel.org/pub/linux/kernel/v5.x/linux-5.15.tar.xz
wget<span class="w"> </span>https://kernel.org/pub/linux/kernel/projects/rt/5.15/patch-5.15-rt.patch.xz

<span class="c1"># åº”ç”¨è¡¥ä¸</span>
<span class="nb">cd</span><span class="w"> </span>linux-5.15
xzcat<span class="w"> </span>../patch-5.15-rt.patch.xz<span class="w"> </span><span class="p">|</span><span class="w"> </span>patch<span class="w"> </span>-p1

<span class="c1"># é…ç½®å†…æ ¸</span>
make<span class="w"> </span>menuconfig
<span class="c1"># å¯ç”¨: Processor type -&gt; Preemption Model -&gt; Fully Preemptible Kernel (RT)</span>
<span class="c1"># ç¦ç”¨: Processor type -&gt; CPU Frequency scaling</span>
<span class="c1"># ç¦ç”¨: Power management options</span>
</code></pre></div>

<h3 id="1513">15.1.3 å®æ—¶è°ƒåº¦ç­–ç•¥</h3>
<p>Linux æä¾›å¤šç§è°ƒåº¦ç­–ç•¥ï¼ŒROS2 èŠ‚ç‚¹å¯ä»¥æ ¹æ®éœ€æ±‚é€‰æ‹©ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;pthread.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;sched.h&gt;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">RealtimeNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">RealtimeNode</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="s">&quot;realtime_node&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// è®¾ç½®å®æ—¶è°ƒåº¦ç­–ç•¥</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_param</span><span class="w"> </span><span class="n">param</span><span class="p">;</span>
<span class="w">        </span><span class="n">param</span><span class="p">.</span><span class="n">sched_priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">80</span><span class="p">;</span><span class="w">  </span><span class="c1">// ä¼˜å…ˆçº§èŒƒå›´ 1-99</span>

<span class="w">        </span><span class="c1">// SCHED_FIFO: å…ˆè¿›å…ˆå‡ºå®æ—¶è°ƒåº¦</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pthread_setschedparam</span><span class="p">(</span><span class="n">pthread_self</span><span class="p">(),</span><span class="w"> </span><span class="n">SCHED_FIFO</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">param</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">RCLCPP_WARN</span><span class="p">(</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Failed to set realtime priority&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// é”å®šå†…å­˜ï¼Œé˜²æ­¢é¡µé¢äº¤æ¢</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">mlockall</span><span class="p">(</span><span class="n">MCL_CURRENT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MCL_FUTURE</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">RCLCPP_WARN</span><span class="p">(</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="s">&quot;Failed to lock memory&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p>è°ƒåº¦ç­–ç•¥å¯¹æ¯”ï¼š</p>
<ul>
<li><strong>SCHED_OTHER</strong>ï¼šé»˜è®¤åˆ†æ—¶è°ƒåº¦ï¼Œé€‚åˆæ™®é€šä»»åŠ¡</li>
<li><strong>SCHED_FIFO</strong>ï¼šå®æ—¶å…ˆè¿›å…ˆå‡ºï¼ŒåŒä¼˜å…ˆçº§ä»»åŠ¡æŒ‰é¡ºåºæ‰§è¡Œ</li>
<li><strong>SCHED_RR</strong>ï¼šå®æ—¶è½®è½¬ï¼ŒåŒä¼˜å…ˆçº§ä»»åŠ¡æ—¶é—´ç‰‡è½®è½¬</li>
<li><strong>SCHED_DEADLINE</strong>ï¼šåŸºäºæˆªæ­¢æ—¶é—´çš„è°ƒåº¦ï¼Œä¿è¯ä»»åŠ¡åœ¨æˆªæ­¢æ—¶é—´å‰å®Œæˆ</li>
</ul>
<h3 id="1514-cpu">15.1.4 CPU éš”ç¦»ä¸äº²å’Œæ€§</h3>
<p>å°†ç‰¹å®š CPU æ ¸å¿ƒä¸“é—¨ç”¨äºå®æ—¶ä»»åŠ¡ï¼Œé¿å…ç³»ç»Ÿä»»åŠ¡å¹²æ‰°ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å†…æ ¸å¯åŠ¨å‚æ•°ï¼Œéš”ç¦» CPU 2-3</span>
<span class="nv">isolcpus</span><span class="o">=</span><span class="m">2</span>,3<span class="w"> </span><span class="nv">nohz_full</span><span class="o">=</span><span class="m">2</span>,3<span class="w"> </span><span class="nv">rcu_nocbs</span><span class="o">=</span><span class="m">2</span>,3

<span class="c1"># è®¾ç½® CPU äº²å’Œæ€§</span>
taskset<span class="w"> </span>-c<span class="w"> </span><span class="m">2</span><span class="w"> </span>ros2<span class="w"> </span>run<span class="w"> </span>my_package<span class="w"> </span>realtime_node
</code></pre></div>

<p>C++ ä»£ç ä¸­è®¾ç½® CPU äº²å’Œæ€§ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="kt">void</span><span class="w"> </span><span class="nf">setCPUAffinity</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">cpu_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">cpu_set_t</span><span class="w"> </span><span class="n">cpuset</span><span class="p">;</span>
<span class="w">    </span><span class="n">CPU_ZERO</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>
<span class="w">    </span><span class="n">CPU_SET</span><span class="p">(</span><span class="n">cpu_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">);</span>

<span class="w">    </span><span class="n">pthread_t</span><span class="w"> </span><span class="kr">thread</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">pthread_self</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pthread_setaffinity_np</span><span class="p">(</span><span class="kr">thread</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">cpu_set_t</span><span class="p">),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cpuset</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">cerr</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Error setting CPU affinity&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="152">15.2 å†…å­˜ç®¡ç†ä¸é›¶æ‹·è´</h2>
<h3 id="1521">15.2.1 å†…å­˜åˆ†é…ç­–ç•¥</h3>
<p>åŠ¨æ€å†…å­˜åˆ†é…æ˜¯å®æ—¶ç³»ç»Ÿçš„ä¸»è¦å»¶è¿Ÿæºã€‚ROS2 æä¾›å¤šç§ç­–ç•¥é¿å…è¿è¡Œæ—¶åˆ†é…ï¼š</p>
<p><strong>é¢„åˆ†é…å†…å­˜æ± </strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rclcpp/strategies/allocator_memory_strategy.hpp&gt;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PreallocatedNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// é¢„åˆ†é…æ¶ˆæ¯æ± </span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">MessageAllocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">allocator</span><span class="o">&lt;</span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">PointCloud2</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">MessageDeleter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">allocator</span><span class="o">::</span><span class="n">Deleter</span><span class="o">&lt;</span><span class="n">MessageAllocator</span><span class="p">,</span><span class="w"> </span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">PointCloud2</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">using</span><span class="w"> </span><span class="n">MessageUniquePtr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">PointCloud2</span><span class="p">,</span><span class="w"> </span><span class="n">MessageDeleter</span><span class="o">&gt;</span><span class="p">;</span>

<span class="w">    </span><span class="n">MessageAllocator</span><span class="w"> </span><span class="n">message_allocator_</span><span class="p">;</span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">LoanedMessage</span><span class="o">&lt;</span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">PointCloud2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">loaned_msg_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">PreallocatedNode</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="s">&quot;preallocated_node&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ä½¿ç”¨è‡ªå®šä¹‰å†…å­˜ç­–ç•¥</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">allocator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">CustomAllocator</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">memory_strategy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">memory_strategies</span><span class="o">::</span><span class="n">allocator_memory_strategy</span><span class="o">::</span><span class="n">AllocatorMemoryStrategy</span><span class="o">&lt;&gt;&gt;</span><span class="p">(</span><span class="n">allocator</span><span class="p">);</span>

<span class="w">        </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">ExecutorOptions</span><span class="w"> </span><span class="n">options</span><span class="p">;</span>
<span class="w">        </span><span class="n">options</span><span class="p">.</span><span class="n">memory_strategy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">memory_strategy</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>è‡ªå®šä¹‰åˆ†é…å™¨</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">template</span><span class="o">&lt;</span><span class="k">typename</span><span class="w"> </span><span class="nc">T</span><span class="o">&gt;</span>
<span class="k">class</span><span class="w"> </span><span class="nc">PoolAllocator</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">T</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pool_</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">queue</span><span class="o">&lt;</span><span class="n">T</span><span class="o">*&gt;</span><span class="w"> </span><span class="n">available_</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="w"> </span><span class="n">mutex_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">PoolAllocator</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">pool_size</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">pool_</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">pool_size</span><span class="p">);</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">pool_size</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">pool_</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">();</span>
<span class="w">            </span><span class="n">available_</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pool_</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">allocate</span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">available_</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">throw</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">bad_alloc</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">available_</span><span class="p">.</span><span class="n">front</span><span class="p">();</span>
<span class="w">        </span><span class="n">available_</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ptr</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">deallocate</span><span class="p">(</span><span class="n">T</span><span class="o">*</span><span class="w"> </span><span class="n">ptr</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">lock_guard</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">mutex</span><span class="o">&gt;</span><span class="w"> </span><span class="n">lock</span><span class="p">(</span><span class="n">mutex_</span><span class="p">);</span>
<span class="w">        </span><span class="n">available_</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1522">15.2.2 é›¶æ‹·è´é€šä¿¡</h3>
<p>é›¶æ‹·è´é€šä¿¡é¿å…äº†æ¶ˆæ¯åœ¨å‘å¸ƒè€…å’Œè®¢é˜…è€…ä¹‹é—´çš„å†…å­˜å¤åˆ¶ï¼Œæ˜¾è‘—é™ä½å»¶è¿Ÿå’Œ CPU ä½¿ç”¨ã€‚</p>
<p><strong>Loaned Messagesï¼ˆå€Ÿç”¨æ¶ˆæ¯ï¼‰</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ZeroCopyPublisher</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Image</span><span class="o">&gt;::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">publisher_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">ZeroCopyPublisher</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="s">&quot;zero_copy_publisher&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å¯ç”¨é›¶æ‹·è´</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">qos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">QoS</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="w">        </span><span class="n">publisher_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Image</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;image&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">qos</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">publishImage</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// ä» DDS å±‚å€Ÿç”¨æ¶ˆæ¯ç¼“å†²åŒº</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">loaned_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">publisher_</span><span class="o">-&gt;</span><span class="n">borrow_loaned_message</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// ç›´æ¥åœ¨å€Ÿç”¨çš„å†…å­˜ä¸­å¡«å……æ•°æ®</span>
<span class="w">        </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">loaned_msg</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
<span class="w">        </span><span class="n">msg</span><span class="p">.</span><span class="n">width</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1920</span><span class="p">;</span>
<span class="w">        </span><span class="n">msg</span><span class="p">.</span><span class="n">height</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1080</span><span class="p">;</span>
<span class="w">        </span><span class="n">msg</span><span class="p">.</span><span class="n">encoding</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;rgb8&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="n">msg</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">1920</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">1080</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">        </span><span class="c1">// å¡«å……å›¾åƒæ•°æ®...</span>

<span class="w">        </span><span class="c1">// å‘å¸ƒæ—¶ä¸éœ€è¦æ‹·è´</span>
<span class="w">        </span><span class="n">publisher_</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">loaned_msg</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1523">15.2.3 å…±äº«å†…å­˜ä¼ è¾“</h3>
<p>ä½¿ç”¨å…±äº«å†…å­˜åœ¨åŒä¸€ä¸»æœºä¸Šçš„èŠ‚ç‚¹é—´ä¼ è¾“å¤§æ•°æ®ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// é…ç½® Cyclone DDS ä½¿ç”¨å…±äº«å†…å­˜</span>
<span class="c1">// cyclone_dds.xml</span>
<span class="o">&lt;</span><span class="n">Domain</span><span class="w"> </span><span class="n">id</span><span class="o">=</span><span class="s">&quot;any&quot;</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">SharedMemory</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="n">Enable</span><span class="o">&gt;</span><span class="nb">true</span><span class="o">&lt;/</span><span class="n">Enable</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="n">LogLevel</span><span class="o">&gt;</span><span class="n">info</span><span class="o">&lt;/</span><span class="n">LogLevel</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;/</span><span class="n">SharedMemory</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">Domain</span><span class="o">&gt;</span>
</code></pre></div>

<p><strong>Iceoryx é›†æˆ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨ rmw_iceoryx_cpp å®ç°çœŸæ­£çš„é›¶æ‹·è´</span>
<span class="k">export</span><span class="w"> </span><span class="n">RMW_IMPLEMENTATION</span><span class="o">=</span><span class="n">rmw_iceoryx_cpp</span>

<span class="c1">// å¯åŠ¨ RouDi (Iceoryx å®ˆæŠ¤è¿›ç¨‹)</span>
<span class="n">iox</span><span class="o">-</span><span class="n">roudi</span>

<span class="c1">// è¿è¡ŒèŠ‚ç‚¹</span>
<span class="n">ros2</span><span class="w"> </span><span class="n">run</span><span class="w"> </span><span class="n">my_package</span><span class="w"> </span><span class="n">zero_copy_node</span>
</code></pre></div>

<h3 id="1524">15.2.4 å†…å­˜å¸ƒå±€ä¼˜åŒ–</h3>
<p>ä¼˜åŒ–æ•°æ®ç»“æ„ä»¥æé«˜ç¼“å­˜å‘½ä¸­ç‡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ç¼“å­˜å‹å¥½çš„æ•°æ®ç»“æ„</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">alignas</span><span class="p">(</span><span class="mi">64</span><span class="p">)</span><span class="w"> </span><span class="n">CacheAlignedData</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// 64 å­—èŠ‚ç¼“å­˜è¡Œå¯¹é½</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">float</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="o">&gt;</span><span class="w"> </span><span class="n">values</span><span class="p">;</span><span class="w">      </span><span class="c1">// çƒ­æ•°æ®æ”¾åœ¨ä¸€èµ·</span>

<span class="w">    </span><span class="c1">// å¡«å……ä»¥é¿å…ä¼ªå…±äº«</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">padding</span><span class="p">[</span><span class="mi">64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">values</span><span class="p">)];</span>
<span class="p">};</span>

<span class="c1">// Structure of Arrays (SoA) vs Array of Structures (AoS)</span>
<span class="c1">// SoA æ›´é€‚åˆ SIMD ä¼˜åŒ–</span>
<span class="k">struct</span><span class="w"> </span><span class="nc">PointCloudSoA</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">y</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">float</span><span class="o">&gt;</span><span class="w"> </span><span class="n">z</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint8_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">intensity</span><span class="p">;</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">processPoints</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// SIMD å‹å¥½çš„å†…å­˜è®¿é—®æ¨¡å¼</span>
<span class="w">        </span><span class="cp">#pragma omp simd</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">size_t</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">x</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mf">2.0f</span><span class="p">;</span>
<span class="w">            </span><span class="n">y</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mf">2.0f</span><span class="p">;</span>
<span class="w">            </span><span class="n">z</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mf">2.0f</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="153-dds">15.3 DDS è°ƒä¼˜</h2>
<h3 id="1531-qos">15.3.1 QoS ç­–ç•¥ä¼˜åŒ–</h3>
<p>Quality of Service (QoS) é…ç½®ç›´æ¥å½±å“é€šä¿¡æ€§èƒ½ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">OptimizedNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">OptimizedNode</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="s">&quot;optimized_node&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// å®æ—¶æ€§ä¼˜åŒ–çš„ QoS é…ç½®</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">qos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">QoS</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">KeepLast</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="n">reliability</span><span class="p">(</span><span class="n">RMW_QOS_POLICY_RELIABILITY_BEST_EFFORT</span><span class="p">)</span><span class="w">  </span><span class="c1">// ä½å»¶è¿Ÿ</span>
<span class="w">            </span><span class="p">.</span><span class="n">durability</span><span class="p">(</span><span class="n">RMW_QOS_POLICY_DURABILITY_VOLATILE</span><span class="p">)</span><span class="w">       </span><span class="c1">// ä¸æŒä¹…åŒ–</span>
<span class="w">            </span><span class="p">.</span><span class="n">deadline</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">10</span><span class="p">))</span><span class="w">              </span><span class="c1">// æˆªæ­¢æ—¶é—´</span>
<span class="w">            </span><span class="p">.</span><span class="n">lifespan</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span><span class="w">            </span><span class="c1">// æ¶ˆæ¯ç”Ÿå­˜æœŸ</span>

<span class="w">        </span><span class="c1">// å†å²æ·±åº¦ä¸º 1ï¼Œå‡å°‘å†…å­˜ä½¿ç”¨</span>
<span class="w">        </span><span class="n">qos</span><span class="p">.</span><span class="n">keep_last</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// åˆ›å»ºå‘å¸ƒè€…</span>
<span class="w">        </span><span class="n">publisher_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Float64</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;data&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">qos</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p>QoS ç­–ç•¥é€‰æ‹©æŒ‡å—ï¼š</p>
<ul>
<li><strong>Reliability</strong>ï¼š</li>
<li>BEST_EFFORTï¼šæœ€ä½å»¶è¿Ÿï¼Œå…è®¸ä¸¢åŒ…</li>
<li>RELIABLEï¼šä¿è¯é€è¾¾ï¼Œå»¶è¿Ÿè¾ƒé«˜</li>
<li><strong>History</strong>ï¼š</li>
<li>KEEP_LAST(1)ï¼šåªä¿ç•™æœ€æ–°æ¶ˆæ¯ï¼Œé€‚åˆå®æ—¶æ§åˆ¶</li>
<li>KEEP_ALLï¼šä¿ç•™æ‰€æœ‰æ¶ˆæ¯ï¼Œé€‚åˆæ•°æ®è®°å½•</li>
<li><strong>Durability</strong>ï¼š</li>
<li>VOLATILEï¼šä¸ä¿å­˜å†å²æ¶ˆæ¯</li>
<li>TRANSIENT_LOCALï¼šä¸ºååŠ å…¥çš„è®¢é˜…è€…ä¿ç•™æ¶ˆæ¯</li>
</ul>
<h3 id="1532-dds">15.3.2 DDS å®ç°é€‰æ‹©ä¸é…ç½®</h3>
<p>ä¸åŒ DDS å®ç°æœ‰ä¸åŒçš„æ€§èƒ½ç‰¹ç‚¹ï¼š</p>
<p><strong>Fast DDS (é»˜è®¤)</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">&lt;!-- fastrtps.xml --&gt;</span>
<span class="cp">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span>
<span class="nt">&lt;profiles</span><span class="w"> </span><span class="na">xmlns=</span><span class="s">&quot;http://www.eprosima.com/XMLSchemas/fastRTPS_Profiles&quot;</span><span class="nt">&gt;</span>
<span class="w">    </span><span class="nt">&lt;participant</span><span class="w"> </span><span class="na">profile_name=</span><span class="s">&quot;participant_profile&quot;</span><span class="w"> </span><span class="na">is_default_profile=</span><span class="s">&quot;true&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;rtps&gt;</span>
<span class="w">            </span><span class="nt">&lt;builtin&gt;</span>
<span class="w">                </span><span class="nt">&lt;discovery_config&gt;</span>
<span class="w">                    </span><span class="nt">&lt;leaseDuration&gt;</span>
<span class="w">                        </span><span class="nt">&lt;sec&gt;</span>1<span class="nt">&lt;/sec&gt;</span>
<span class="w">                        </span><span class="nt">&lt;nanosec&gt;</span>0<span class="nt">&lt;/nanosec&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/leaseDuration&gt;</span>
<span class="w">                </span><span class="nt">&lt;/discovery_config&gt;</span>
<span class="w">                </span><span class="nt">&lt;metatrafficUnicastLocatorList&gt;</span>
<span class="w">                    </span><span class="nt">&lt;locator&gt;</span>
<span class="w">                        </span><span class="nt">&lt;udpv4&gt;</span>
<span class="w">                            </span><span class="nt">&lt;address&gt;</span>127.0.0.1<span class="nt">&lt;/address&gt;</span>
<span class="w">                        </span><span class="nt">&lt;/udpv4&gt;</span>
<span class="w">                    </span><span class="nt">&lt;/locator&gt;</span>
<span class="w">                </span><span class="nt">&lt;/metatrafficUnicastLocatorList&gt;</span>
<span class="w">            </span><span class="nt">&lt;/builtin&gt;</span>
<span class="w">            </span><span class="nt">&lt;sendSocketBufferSize&gt;</span>1048576<span class="nt">&lt;/sendSocketBufferSize&gt;</span>
<span class="w">            </span><span class="nt">&lt;receiveSocketBufferSize&gt;</span>4194304<span class="nt">&lt;/receiveSocketBufferSize&gt;</span>
<span class="w">        </span><span class="nt">&lt;/rtps&gt;</span>
<span class="w">    </span><span class="nt">&lt;/participant&gt;</span>

<span class="w">    </span><span class="nt">&lt;data_writer</span><span class="w"> </span><span class="na">profile_name=</span><span class="s">&quot;datawriter_profile&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;historyMemoryPolicy&gt;</span>PREALLOCATED_WITH_REALLOC<span class="nt">&lt;/historyMemoryPolicy&gt;</span>
<span class="w">        </span><span class="nt">&lt;qos&gt;</span>
<span class="w">            </span><span class="nt">&lt;publishMode&gt;</span>
<span class="w">                </span><span class="nt">&lt;kind&gt;</span>ASYNCHRONOUS<span class="nt">&lt;/kind&gt;</span>
<span class="w">            </span><span class="nt">&lt;/publishMode&gt;</span>
<span class="w">        </span><span class="nt">&lt;/qos&gt;</span>
<span class="w">    </span><span class="nt">&lt;/data_writer&gt;</span>
<span class="nt">&lt;/profiles&gt;</span>
</code></pre></div>

<p><strong>Cyclone DDS (ä½å»¶è¿Ÿä¼˜åŒ–)</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="cm">&lt;!-- cyclonedds.xml --&gt;</span>
<span class="nt">&lt;CycloneDDS&gt;</span>
<span class="w">    </span><span class="nt">&lt;Domain</span><span class="w"> </span><span class="na">id=</span><span class="s">&quot;any&quot;</span><span class="nt">&gt;</span>
<span class="w">        </span><span class="nt">&lt;General&gt;</span>
<span class="w">            </span><span class="nt">&lt;NetworkInterfaceAddress&gt;</span>auto<span class="nt">&lt;/NetworkInterfaceAddress&gt;</span>
<span class="w">            </span><span class="nt">&lt;MaxMessageSize&gt;</span>65500B<span class="nt">&lt;/MaxMessageSize&gt;</span>
<span class="w">            </span><span class="nt">&lt;FragmentSize&gt;</span>4000B<span class="nt">&lt;/FragmentSize&gt;</span>
<span class="w">        </span><span class="nt">&lt;/General&gt;</span>
<span class="w">        </span><span class="nt">&lt;Tracing&gt;</span>
<span class="w">            </span><span class="nt">&lt;Verbosity&gt;</span>warning<span class="nt">&lt;/Verbosity&gt;</span>
<span class="w">            </span><span class="nt">&lt;OutputFile&gt;</span>stdout<span class="nt">&lt;/OutputFile&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Tracing&gt;</span>
<span class="w">        </span><span class="nt">&lt;Internal&gt;</span>
<span class="w">            </span><span class="nt">&lt;SocketReceiveBufferSize&gt;</span>4MB<span class="nt">&lt;/SocketReceiveBufferSize&gt;</span>
<span class="w">            </span><span class="nt">&lt;SocketSendBufferSize&gt;</span>1MB<span class="nt">&lt;/SocketSendBufferSize&gt;</span>
<span class="w">            </span><span class="nt">&lt;MaxQueuedMessages&gt;</span>500<span class="nt">&lt;/MaxQueuedMessages&gt;</span>
<span class="w">        </span><span class="nt">&lt;/Internal&gt;</span>
<span class="w">    </span><span class="nt">&lt;/Domain&gt;</span>
<span class="nt">&lt;/CycloneDDS&gt;</span>
</code></pre></div>

<p>æ€§èƒ½å¯¹æ¯”æµ‹è¯•ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æµ‹è¯•ä¸åŒ DDS å®ç°</span>
<span class="nb">export</span><span class="w"> </span><span class="nv">RMW_IMPLEMENTATION</span><span class="o">=</span>rmw_fastrtps_cpp
ros2<span class="w"> </span>run<span class="w"> </span>performance_test<span class="w"> </span>perf_test<span class="w"> </span>-c<span class="w"> </span>ROS2<span class="w"> </span>-t<span class="w"> </span>Array1k

<span class="nb">export</span><span class="w"> </span><span class="nv">RMW_IMPLEMENTATION</span><span class="o">=</span>rmw_cyclonedds_cpp<span class="w">  </span>
ros2<span class="w"> </span>run<span class="w"> </span>performance_test<span class="w"> </span>perf_test<span class="w"> </span>-c<span class="w"> </span>ROS2<span class="w"> </span>-t<span class="w"> </span>Array1k
</code></pre></div>

<h3 id="1533">15.3.3 ç½‘ç»œä¼˜åŒ–</h3>
<p><strong>UDP ç¼“å†²åŒºè°ƒä¼˜</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å¢åŠ ç³»ç»Ÿ UDP ç¼“å†²åŒºå¤§å°</span>
sudo<span class="w"> </span>sysctl<span class="w"> </span>-w<span class="w"> </span>net.core.rmem_max<span class="o">=</span><span class="m">134217728</span>
sudo<span class="w"> </span>sysctl<span class="w"> </span>-w<span class="w"> </span>net.core.wmem_max<span class="o">=</span><span class="m">134217728</span>
sudo<span class="w"> </span>sysctl<span class="w"> </span>-w<span class="w"> </span>net.ipv4.udp_mem<span class="o">=</span><span class="s2">&quot;102400 873800 16777216&quot;</span>
sudo<span class="w"> </span>sysctl<span class="w"> </span>-w<span class="w"> </span>net.core.netdev_max_backlog<span class="o">=</span><span class="m">30000</span>

<span class="c1"># æ°¸ä¹…ç”Ÿæ•ˆ</span>
<span class="nb">echo</span><span class="w"> </span><span class="s2">&quot;net.core.rmem_max=134217728&quot;</span><span class="w"> </span>&gt;&gt;<span class="w"> </span>/etc/sysctl.conf
</code></pre></div>

<p><strong>å¤šæ’­é…ç½®ä¼˜åŒ–</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ç¦ç”¨å¤šæ’­å‘ç°ï¼Œä½¿ç”¨å•æ’­</span>
<span class="k">export</span><span class="w"> </span><span class="n">ROS_DISCOVERY_SERVER</span><span class="o">=</span><span class="mf">127.0.0.1</span><span class="o">:</span><span class="mi">11811</span>

<span class="c1">// æˆ–é…ç½®é™æ€èŠ‚ç‚¹</span>
<span class="o">&lt;</span><span class="n">participant</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;</span><span class="n">rtps</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;</span><span class="n">builtin</span><span class="o">&gt;</span>
<span class="w">            </span><span class="o">&lt;</span><span class="n">initialPeersList</span><span class="o">&gt;</span>
<span class="w">                </span><span class="o">&lt;</span><span class="n">locator</span><span class="o">&gt;</span>
<span class="w">                    </span><span class="o">&lt;</span><span class="n">udpv4</span><span class="o">&gt;</span>
<span class="w">                        </span><span class="o">&lt;</span><span class="n">address</span><span class="o">&gt;</span><span class="mf">192.168.1.100</span><span class="o">&lt;/</span><span class="n">address</span><span class="o">&gt;</span>
<span class="w">                    </span><span class="o">&lt;/</span><span class="n">udpv4</span><span class="o">&gt;</span>
<span class="w">                </span><span class="o">&lt;/</span><span class="n">locator</span><span class="o">&gt;</span>
<span class="w">            </span><span class="o">&lt;/</span><span class="n">initialPeersList</span><span class="o">&gt;</span>
<span class="w">        </span><span class="o">&lt;/</span><span class="n">builtin</span><span class="o">&gt;</span>
<span class="w">    </span><span class="o">&lt;/</span><span class="n">rtps</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">participant</span><span class="o">&gt;</span>
</code></pre></div>

<h3 id="1534">15.3.4 åˆ†åŒºä¸åŸŸéš”ç¦»</h3>
<p>ä½¿ç”¨åˆ†åŒºéš”ç¦»ä¸åŒå­ç³»ç»Ÿçš„é€šä¿¡ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">PartitionedNode</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">PartitionedNode</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="s">&quot;partitioned_node&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// è®¾ç½®åˆ†åŒº</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">qos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">QoS</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// ä½¿ç”¨ rmw ç‰¹å®šçš„ QoS è®¾ç½®åˆ†åŒº</span>
<span class="w">        </span><span class="n">rmw_qos_profile_t</span><span class="w"> </span><span class="n">rmw_qos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">qos</span><span class="p">.</span><span class="n">get_rmw_qos_profile</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// æ§åˆ¶ç³»ç»Ÿåˆ†åŒº</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">control_pub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Float64</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;control_command&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">qos</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// æ„ŸçŸ¥ç³»ç»Ÿåˆ†åŒº  </span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">sensor_sub</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">LaserScan</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;scan&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">qos</span><span class="p">,</span>
<span class="w">            </span><span class="p">[](</span><span class="k">const</span><span class="w"> </span><span class="n">sensor_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">LaserScan</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// å¤„ç†æ¿€å…‰æ•°æ®</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h2 id="154">15.4 æ€§èƒ½åˆ†æå·¥å…·</h2>
<h3 id="1541">15.4.1 ç³»ç»Ÿçº§æ€§èƒ½åˆ†æ</h3>
<p><strong>perf å·¥å…·</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># CPU æ€§èƒ½åˆ†æ</span>
sudo<span class="w"> </span>perf<span class="w"> </span>record<span class="w"> </span>-g<span class="w"> </span>ros2<span class="w"> </span>run<span class="w"> </span>my_package<span class="w"> </span>my_node
sudo<span class="w"> </span>perf<span class="w"> </span>report

<span class="c1"># ç¼“å­˜å‘½ä¸­ç‡åˆ†æ</span>
sudo<span class="w"> </span>perf<span class="w"> </span>stat<span class="w"> </span>-e<span class="w"> </span>cache-references,cache-misses<span class="w"> </span>ros2<span class="w"> </span>run<span class="w"> </span>my_package<span class="w"> </span>my_node

<span class="c1"># è°ƒåº¦å»¶è¿Ÿåˆ†æ</span>
sudo<span class="w"> </span>perf<span class="w"> </span>sched<span class="w"> </span>record<span class="w"> </span>ros2<span class="w"> </span>run<span class="w"> </span>my_package<span class="w"> </span>my_node
sudo<span class="w"> </span>perf<span class="w"> </span>sched<span class="w"> </span>latency
</code></pre></div>

<p><strong>ftrace å†…æ ¸è·Ÿè¸ª</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å¯ç”¨å‡½æ•°è·Ÿè¸ª</span>
<span class="nb">echo</span><span class="w"> </span><span class="k">function</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/debug/tracing/current_tracer
<span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/kernel/debug/tracing/tracing_on

<span class="c1"># è¿è¡ŒèŠ‚ç‚¹</span>
ros2<span class="w"> </span>run<span class="w"> </span>my_package<span class="w"> </span>my_node

<span class="c1"># æŸ¥çœ‹è·Ÿè¸ªç»“æœ</span>
cat<span class="w"> </span>/sys/kernel/debug/tracing/trace
</code></pre></div>

<h3 id="1542-ros2">15.4.2 ROS2 ä¸“ç”¨å·¥å…·</h3>
<p><strong>ros2_tracing (LTTng)</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// åœ¨ä»£ç ä¸­æ·»åŠ è·Ÿè¸ªç‚¹</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;tracetools/tracetools.h&gt;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">myCallback</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">TRACEPOINT</span><span class="p">(</span><span class="n">callback_start</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="k">this</span><span class="p">);</span>
<span class="w">    </span><span class="c1">// å¤„ç†é€»è¾‘</span>
<span class="w">    </span><span class="n">TRACEPOINT</span><span class="p">(</span><span class="n">callback_end</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="k">this</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># å¯åŠ¨è·Ÿè¸ªä¼šè¯</span>
ros2<span class="w"> </span>trace<span class="w"> </span>start<span class="w"> </span>my_session

<span class="c1"># è¿è¡ŒèŠ‚ç‚¹</span>
ros2<span class="w"> </span>run<span class="w"> </span>my_package<span class="w"> </span>my_node

<span class="c1"># åœæ­¢è·Ÿè¸ª</span>
ros2<span class="w"> </span>trace<span class="w"> </span>stop

<span class="c1"># åˆ†æç»“æœ</span>
babeltrace<span class="w"> </span>~/ros2_tracing/my_session
</code></pre></div>

<p><strong>ros2 topicå»¶è¿Ÿæµ‹é‡</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># æµ‹é‡è¯é¢˜å»¶è¿Ÿ</span>
ros2<span class="w"> </span>topic<span class="w"> </span>delay<span class="w"> </span>/scan

<span class="c1"># å¸¦å®½æµ‹é‡</span>
ros2<span class="w"> </span>topic<span class="w"> </span>bw<span class="w"> </span>/image

<span class="c1"># é¢‘ç‡æµ‹é‡</span>
ros2<span class="w"> </span>topic<span class="w"> </span>hz<span class="w"> </span>/cmd_vel
</code></pre></div>

<h3 id="1543">15.4.3 è‡ªå®šä¹‰æ€§èƒ½ç›‘æ§</h3>
<div class="codehilite"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;chrono&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;rclcpp/rclcpp.hpp&gt;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PerformanceMonitor</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">Metrics</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">message_count</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">total_latency_us</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">max_latency_us</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">uint64_t</span><span class="o">&gt;</span><span class="w"> </span><span class="n">min_latency_us</span><span class="p">{</span><span class="n">UINT64_MAX</span><span class="p">};</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="p">,</span><span class="w"> </span><span class="n">Metrics</span><span class="o">&gt;</span><span class="w"> </span><span class="n">metrics_</span><span class="p">;</span>
<span class="w">    </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">TimerBase</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">report_timer_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">recordLatency</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&amp;</span><span class="w"> </span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">latency_us</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metrics_</span><span class="p">[</span><span class="n">name</span><span class="p">];</span>
<span class="w">        </span><span class="n">m</span><span class="p">.</span><span class="n">message_count</span><span class="o">++</span><span class="p">;</span>
<span class="w">        </span><span class="n">m</span><span class="p">.</span><span class="n">total_latency_us</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">latency_us</span><span class="p">;</span>

<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">old_max</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">max_latency_us</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">latency_us</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">old_max</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">               </span><span class="o">!</span><span class="n">m</span><span class="p">.</span><span class="n">max_latency_us</span><span class="p">.</span><span class="n">compare_exchange_weak</span><span class="p">(</span><span class="n">old_max</span><span class="p">,</span><span class="w"> </span><span class="n">latency_us</span><span class="p">));</span>

<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">old_min</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">min_latency_us</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">latency_us</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">old_min</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>
<span class="w">               </span><span class="o">!</span><span class="n">m</span><span class="p">.</span><span class="n">min_latency_us</span><span class="p">.</span><span class="n">compare_exchange_weak</span><span class="p">(</span><span class="n">old_min</span><span class="p">,</span><span class="w"> </span><span class="n">latency_us</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">printReport</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="p">[</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">m</span><span class="p">]</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">metrics_</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">message_count</span><span class="p">.</span><span class="n">load</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">double</span><span class="w"> </span><span class="n">avg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">m</span><span class="p">.</span><span class="n">total_latency_us</span><span class="p">.</span><span class="n">load</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="p">)</span><span class="n">count</span><span class="p">;</span>
<span class="w">                </span><span class="n">RCLCPP_INFO</span><span class="p">(</span><span class="n">rclcpp</span><span class="o">::</span><span class="n">get_logger</span><span class="p">(</span><span class="s">&quot;performance&quot;</span><span class="p">),</span>
<span class="w">                    </span><span class="s">&quot;%s: avg=%.2fus, max=%ldus, min=%ldus, count=%ld&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">name</span><span class="p">.</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">avg</span><span class="p">,</span><span class="w"> </span>
<span class="w">                    </span><span class="n">m</span><span class="p">.</span><span class="n">max_latency_us</span><span class="p">.</span><span class="n">load</span><span class="p">(),</span>
<span class="w">                    </span><span class="n">m</span><span class="p">.</span><span class="n">min_latency_us</span><span class="p">.</span><span class="n">load</span><span class="p">(),</span><span class="w"> </span>
<span class="w">                    </span><span class="n">count</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1544">15.4.4 å¯è§†åŒ–å·¥å…·</h3>
<p><strong>PlotJuggler å®æ—¶ç»˜å›¾</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å®‰è£…</span>
sudo<span class="w"> </span>apt<span class="w"> </span>install<span class="w"> </span>ros-humble-plotjuggler-ros

<span class="c1"># å¯åŠ¨</span>
ros2<span class="w"> </span>run<span class="w"> </span>plotjuggler<span class="w"> </span>plotjuggler

<span class="c1"># å‘å¸ƒæ€§èƒ½æ•°æ®</span>
ros2<span class="w"> </span>topic<span class="w"> </span>pub<span class="w"> </span>/performance<span class="w"> </span>std_msgs/Float64MultiArray<span class="w"> </span><span class="s2">&quot;{data: [1.2, 3.4, 5.6]}&quot;</span>
</code></pre></div>

<p><strong>Trace Compass åˆ†æ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># å¯¼å…¥ LTTng è·Ÿè¸ªæ•°æ®åˆ° Trace Compass</span>
<span class="c1"># å¯è§†åŒ–æ—¶é—´çº¿ã€å»¶è¿Ÿåˆ†å¸ƒã€CPU ä½¿ç”¨ç‡ç­‰</span>
</code></pre></div>

<h2 id="155-1khz">15.5 äº§ä¸šæ¡ˆä¾‹ç ”ç©¶ï¼šæ‰‹æœ¯æœºå™¨äºº 1kHz æ§åˆ¶å¾ªç¯å®ç°</h2>
<h3 id="1551">15.5.1 é¡¹ç›®èƒŒæ™¯</h3>
<p>æŸåŒ»ç–—ç§‘æŠ€å…¬å¸å¼€å‘çš„ç¥ç»å¤–ç§‘æ‰‹æœ¯æœºå™¨äººç³»ç»Ÿéœ€è¦å®ç° 1kHz çš„æ§åˆ¶é¢‘ç‡ï¼Œä»¥ç¡®ä¿æ‰‹æœ¯å™¨æ¢°çš„ç²¾ç¡®å®šä½å’Œç¨³å®šæ§åˆ¶ã€‚ç³»ç»Ÿè¦æ±‚ï¼š</p>
<ul>
<li><strong>æ§åˆ¶å‘¨æœŸ</strong>ï¼š1ms Â± 50Î¼s</li>
<li><strong>ç«¯åˆ°ç«¯å»¶è¿Ÿ</strong>ï¼š&lt; 500Î¼s</li>
<li><strong>ä½ç½®ç²¾åº¦</strong>ï¼š&lt; 0.1mm</li>
<li><strong>åŠ›åé¦ˆå»¶è¿Ÿ</strong>ï¼š&lt; 2ms</li>
<li><strong>å®‰å…¨è®¤è¯</strong>ï¼šIEC 60601-1 åŒ»ç–—è®¾å¤‡æ ‡å‡†</li>
</ul>
<h3 id="1552">15.5.2 ç³»ç»Ÿæ¶æ„</h3>
<div class="codehilite"><pre><span></span><code><span class="w">                    </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<span class="w">                    </span>â”‚<span class="w">  </span>ä¸»æ§åˆ¶å™¨èŠ‚ç‚¹<span class="w">    </span>â”‚
<span class="w">                    </span>â”‚<span class="w">   </span><span class="ss">(</span><span class="mi">1</span><span class="nv">kHz</span><span class="w"> </span><span class="k">Loop</span><span class="ss">)</span><span class="w">   </span>â”‚
<span class="w">                    </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
<span class="w">                             </span>â”‚
<span class="w">                 </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<span class="w">                 </span>â”‚<span class="w">           </span>â”‚<span class="w">           </span>â”‚
<span class="w">         </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”<span class="w"> </span>â”Œâ”€â–¼â”€â”€â”<span class="w"> </span>â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
<span class="w">         </span>â”‚<span class="w"> </span>è¿åŠ¨è§„åˆ’èŠ‚ç‚¹<span class="w">  </span>â”‚<span class="w"> </span>â”‚åŠ›æ§â”‚<span class="w"> </span>â”‚<span class="w"> </span>å®‰å…¨ç›‘æ§èŠ‚ç‚¹<span class="w"> </span>â”‚
<span class="w">         </span>â”‚<span class="w">   </span><span class="ss">(</span><span class="mi">100</span><span class="nv">Hz</span><span class="ss">)</span><span class="w">    </span>â”‚<span class="w"> </span>â”‚èŠ‚ç‚¹â”‚<span class="w"> </span>â”‚<span class="w">   </span><span class="ss">(</span><span class="mi">1</span><span class="nv">kHz</span><span class="ss">)</span><span class="w">    </span>â”‚
<span class="w">         </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w"> </span>â””â”€â”€â”€â”€â”˜<span class="w"> </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
<span class="w">                             </span>â”‚
<span class="w">                    </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
<span class="w">                    </span>â”‚<span class="w">  </span><span class="nv">EtherCAT</span><span class="w"> </span>æ€»çº¿<span class="w">   </span>â”‚
<span class="w">                    </span>â”‚<span class="w">     </span><span class="ss">(</span><span class="o">&lt;</span><span class="mi">100</span>Î¼<span class="nv">s</span><span class="ss">)</span><span class="w">    </span>â”‚
<span class="w">                    </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
<span class="w">                             </span>â”‚
<span class="w">                 </span>â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
<span class="w">                 </span>â”‚<span class="w">           </span>â”‚<span class="w">           </span>â”‚
<span class="w">            </span>â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”<span class="w"> </span>â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”<span class="w"> </span>â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”
<span class="w">            </span>â”‚ç”µæœºé©±åŠ¨â”‚<span class="w"> </span>â”‚ç”µæœºé©±åŠ¨â”‚<span class="w"> </span>â”‚åŠ›ä¼ æ„Ÿå™¨â”‚
<span class="w">            </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w"> </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜<span class="w"> </span>â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="1553">15.5.3 å®ç°ç»†èŠ‚</h3>
<ol>
<li><strong>å®æ—¶å†…æ ¸é…ç½®</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1"># ä½¿ç”¨ Ubuntu 22.04 + PREEMPT-RT</span>
uname<span class="w"> </span>-a
<span class="c1"># Linux surgical-robot 5.15.0-rt17 #1 SMP PREEMPT_RT</span>

<span class="c1"># CPU éš”ç¦»é…ç½®</span>
<span class="c1"># /etc/default/grub</span>
<span class="nv">GRUB_CMDLINE_LINUX</span><span class="o">=</span><span class="s2">&quot;isolcpus=2,3,4,5 nohz_full=2,3,4,5 rcu_nocbs=2,3,4,5&quot;</span>

<span class="c1"># IRQ äº²å’Œæ€§è®¾ç½®</span>
<span class="nb">echo</span><span class="w"> </span><span class="m">2</span><span class="w"> </span>&gt;<span class="w"> </span>/proc/irq/24/smp_affinity<span class="w">  </span><span class="c1"># EtherCAT ä¸­æ–­ç»‘å®šåˆ° CPU2</span>
</code></pre></div>

<ol start="2">
<li><strong>æ§åˆ¶èŠ‚ç‚¹å®ç°</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">SurgicalRobotController</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="c1">// EtherCAT ä¸»ç«™</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">EthercatMaster</span><span class="o">&gt;</span><span class="w"> </span><span class="n">ethercat_master_</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// å®æ—¶ç¼“å†²åŒº</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">RealtimeBuffer</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="o">&gt;</span><span class="w"> </span><span class="n">joint_positions</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="o">&gt;</span><span class="w"> </span><span class="n">joint_velocities</span><span class="p">;</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="mi">6</span><span class="o">&gt;</span><span class="w"> </span><span class="n">wrench</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint64_t</span><span class="w"> </span><span class="n">timestamp</span><span class="p">;</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">RealtimeBuffer</span><span class="w"> </span><span class="n">rt_buffer_</span><span class="p">;</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">atomic</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">emergency_stop_</span><span class="p">{</span><span class="nb">false</span><span class="p">};</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">SurgicalRobotController</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="s">&quot;surgical_controller&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// è®¾ç½®å®æ—¶ä¼˜å…ˆçº§</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">sched_param</span><span class="w"> </span><span class="n">param</span><span class="p">;</span>
<span class="w">        </span><span class="n">param</span><span class="p">.</span><span class="n">sched_priority</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">95</span><span class="p">;</span>
<span class="w">        </span><span class="n">pthread_setschedparam</span><span class="p">(</span><span class="n">pthread_self</span><span class="p">(),</span><span class="w"> </span><span class="n">SCHED_FIFO</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">param</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// é”å®šæ‰€æœ‰å†…å­˜é¡µ</span>
<span class="w">        </span><span class="n">mlockall</span><span class="p">(</span><span class="n">MCL_CURRENT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MCL_FUTURE</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// é¢„åˆ†é…å†…å­˜</span>
<span class="w">        </span><span class="n">rt_buffer_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>

<span class="w">        </span><span class="c1">// åˆå§‹åŒ– EtherCAT</span>
<span class="w">        </span><span class="n">ethercat_master_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">EthercatMaster</span><span class="o">&gt;</span><span class="p">();</span>
<span class="w">        </span><span class="n">ethercat_master_</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// åˆ›å»º 1kHz å®šæ—¶å™¨</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">timer_callback</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="k">this</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">controlLoop</span><span class="p">();</span><span class="w"> </span><span class="p">};</span>
<span class="w">        </span><span class="n">timer_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_wall_timer</span><span class="p">(</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="p">(</span><span class="mi">1000</span><span class="p">),</span><span class="w"> </span>
<span class="w">            </span><span class="n">timer_callback</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">controlLoop</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">start</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 1. è¯»å–ä¼ æ„Ÿå™¨æ•°æ® (&lt; 50Î¼s)</span>
<span class="w">        </span><span class="n">ethercat_master_</span><span class="o">-&gt;</span><span class="n">readInputs</span><span class="p">(</span><span class="n">rt_buffer_</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 2. å®‰å…¨æ£€æŸ¥ (&lt; 10Î¼s)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">checkSafetyLimits</span><span class="p">())</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">emergency_stop_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">            </span><span class="n">stopAllMotors</span><span class="p">();</span>
<span class="w">            </span><span class="k">return</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 3. æ§åˆ¶è®¡ç®— (&lt; 200Î¼s)</span>
<span class="w">        </span><span class="n">std</span><span class="o">::</span><span class="n">array</span><span class="o">&lt;</span><span class="kt">double</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="o">&gt;</span><span class="w"> </span><span class="n">torques</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">computeControl</span><span class="p">(</span><span class="n">rt_buffer_</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 4. å‘é€æ§åˆ¶å‘½ä»¤ (&lt; 50Î¼s)</span>
<span class="w">        </span><span class="n">ethercat_master_</span><span class="o">-&gt;</span><span class="n">writeOutputs</span><span class="p">(</span><span class="n">torques</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 5. æ€§èƒ½ç›‘æ§</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">end</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">high_resolution_clock</span><span class="o">::</span><span class="n">now</span><span class="p">();</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">duration_cast</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">microseconds</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="n">end</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">start</span><span class="p">).</span><span class="n">count</span><span class="p">();</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">duration</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1100</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w">  </span><span class="c1">// è¶…è¿‡ 1.1ms è­¦å‘Š</span>
<span class="w">            </span><span class="n">RCLCPP_WARN_THROTTLE</span><span class="p">(</span><span class="n">get_logger</span><span class="p">(),</span><span class="w"> </span><span class="o">*</span><span class="n">get_clock</span><span class="p">(),</span><span class="w"> </span><span class="mi">1000</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;Control loop took %ld us&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">duration</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<ol start="3">
<li><strong>é›¶æ‹·è´æ•°æ®ä¼ è¾“</strong></li>
</ol>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨ Iceoryx å®ç°è¿›ç¨‹é—´é›¶æ‹·è´</span>
<span class="k">class</span><span class="w"> </span><span class="nc">ZeroCopyDataExchange</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="n">iox</span><span class="o">::</span><span class="n">popo</span><span class="o">::</span><span class="n">Publisher</span><span class="o">&lt;</span><span class="n">SensorData</span><span class="o">&gt;</span><span class="w"> </span><span class="n">sensor_publisher_</span><span class="p">;</span>
<span class="w">    </span><span class="n">iox</span><span class="o">::</span><span class="n">popo</span><span class="o">::</span><span class="n">Subscriber</span><span class="o">&lt;</span><span class="n">ControlCommand</span><span class="o">&gt;</span><span class="w"> </span><span class="n">command_subscriber_</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">publishSensorData</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">SensorData</span><span class="o">&amp;</span><span class="w"> </span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">sensor_publisher_</span><span class="p">.</span><span class="n">loan</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">and_then</span><span class="p">([</span><span class="o">&amp;</span><span class="p">](</span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">sample</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="o">*</span><span class="n">sample</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">;</span>
<span class="w">                </span><span class="n">sample</span><span class="p">.</span><span class="n">publish</span><span class="p">();</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">receiveCommand</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">command_subscriber_</span><span class="p">.</span><span class="n">take</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">and_then</span><span class="p">([</span><span class="k">this</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="o">&amp;</span><span class="w"> </span><span class="n">sample</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">processCommand</span><span class="p">(</span><span class="o">*</span><span class="n">sample</span><span class="p">);</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1554">15.5.4 æ€§èƒ½ä¼˜åŒ–æªæ–½</h3>
<ol>
<li>
<p><strong>CPU æ ¸å¿ƒåˆ†é…</strong>ï¼š
   - CPU 0-1ï¼šç³»ç»Ÿä»»åŠ¡
   - CPU 2ï¼šEtherCAT ä¸»ç«™
   - CPU 3ï¼šæ§åˆ¶ç®—æ³•
   - CPU 4ï¼šè¿åŠ¨è§„åˆ’
   - CPU 5ï¼šå®‰å…¨ç›‘æ§</p>
</li>
<li>
<p><strong>å†…å­˜ä¼˜åŒ–</strong>ï¼š
   - ä½¿ç”¨å¤§é¡µå†…å­˜å‡å°‘ TLB miss
   - é¢„åˆ†é…æ‰€æœ‰åŠ¨æ€å†…å­˜
   - ç¦ç”¨å†…å­˜äº¤æ¢</p>
</li>
<li>
<p><strong>DDS é…ç½®</strong>ï¼š
   - ä½¿ç”¨ Cyclone DDS çš„å®æ—¶é…ç½®
   - ç¦ç”¨å¤šæ’­ï¼Œä½¿ç”¨ç‚¹å¯¹ç‚¹é€šä¿¡
   - QoSï¼šBEST_EFFORT + VOLATILE</p>
</li>
</ol>
<h3 id="1555">15.5.5 æµ‹è¯•ç»“æœ</h3>
<div class="codehilite"><pre><span></span><code>æ€§èƒ½æŒ‡æ ‡æµ‹è¯•ç»“æœï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æŒ‡æ ‡                â”‚ è¦æ±‚     â”‚ å®æµ‹å¹³å‡  â”‚ æœ€å·®æƒ…å†µ  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ§åˆ¶å‘¨æœŸ            â”‚ 1msÂ±50Î¼s â”‚ 1.002ms  â”‚ 1.048ms  â”‚
â”‚ ç«¯åˆ°ç«¯å»¶è¿Ÿ          â”‚ &lt;500Î¼s   â”‚ 380Î¼s    â”‚ 495Î¼s    â”‚
â”‚ æŠ–åŠ¨ (Jitter)       â”‚ &lt;50Î¼s    â”‚ 12Î¼s     â”‚ 48Î¼s     â”‚
â”‚ CPU ä½¿ç”¨ç‡          â”‚ &lt;50%     â”‚ 35%      â”‚ 42%      â”‚
â”‚ å†…å­˜ä½¿ç”¨            â”‚ &lt;2GB     â”‚ 1.2GB    â”‚ 1.2GB    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
</code></pre></div>

<h3 id="1556">15.5.6 ç»éªŒæ•™è®­</h3>
<ol>
<li><strong>ç¡¬ä»¶é€‰æ‹©è‡³å…³é‡è¦</strong>ï¼šä½¿ç”¨æ”¯æŒ TSN çš„ç½‘ç»œç¡¬ä»¶å’Œä½å»¶è¿Ÿ EtherCAT ä»ç«™</li>
<li><strong>æ¸è¿›å¼ä¼˜åŒ–</strong>ï¼šå…ˆå®ç°åŠŸèƒ½ï¼Œå†é€æ­¥ä¼˜åŒ–æ€§èƒ½</li>
<li><strong>å…¨é¢æµ‹è¯•</strong>ï¼šåŒ…æ‹¬é•¿æ—¶é—´ç¨³å®šæ€§æµ‹è¯•å’Œæç«¯æƒ…å†µæµ‹è¯•</li>
<li><strong>å†—ä½™è®¾è®¡</strong>ï¼šå…³é”®ç»„ä»¶é‡‡ç”¨åŒé‡å†—ä½™ï¼Œç¡®ä¿å®‰å…¨</li>
</ol>
<h2 id="156">15.6 é«˜çº§è¯é¢˜</h2>
<h3 id="1561-cyclone-dds-vs-fast-dds">15.6.1 Cyclone DDS vs Fast DDS æ€§èƒ½å¯¹æ¯”</h3>
<p><strong>æµ‹è¯•ç¯å¢ƒ</strong>ï¼š</p>
<ul>
<li>Intel i7-10700K, 32GB RAM</li>
<li>Ubuntu 22.04 + PREEMPT-RT</li>
<li>éš”ç¦» CPU æ ¸å¿ƒï¼Œç¦ç”¨è¶…çº¿ç¨‹</li>
</ul>
<p><strong>æµ‹è¯•æ–¹æ³•</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// æ€§èƒ½æµ‹è¯•èŠ‚ç‚¹</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DdsPerformanceTest</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">Node</span><span class="w"> </span><span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">DdsPerformanceTest</span><span class="p">()</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">Node</span><span class="p">(</span><span class="s">&quot;dds_test&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// é…ç½® QoS</span>
<span class="w">        </span><span class="k">auto</span><span class="w"> </span><span class="n">qos</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rclcpp</span><span class="o">::</span><span class="n">QoS</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">reliability</span><span class="p">(</span><span class="n">RMW_QOS_POLICY_RELIABILITY_BEST_EFFORT</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">durability</span><span class="p">(</span><span class="n">RMW_QOS_POLICY_DURABILITY_VOLATILE</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// åˆ›å»ºå‘å¸ƒè€…å’Œè®¢é˜…è€…</span>
<span class="w">        </span><span class="n">publisher_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_publisher</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Header</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;test&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">qos</span><span class="p">);</span>

<span class="w">        </span><span class="n">subscription_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_subscription</span><span class="o">&lt;</span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Header</span><span class="o">&gt;</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;test&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">qos</span><span class="p">,</span>
<span class="w">            </span><span class="p">[</span><span class="k">this</span><span class="p">](</span><span class="k">const</span><span class="w"> </span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Header</span><span class="o">::</span><span class="n">SharedPtr</span><span class="w"> </span><span class="n">msg</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">now</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">();</span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">latency</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">now</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">stamp</span><span class="p">).</span><span class="n">nanoseconds</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mf">1000.0</span><span class="p">;</span>
<span class="w">                </span><span class="n">latencies_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">latency</span><span class="p">);</span>
<span class="w">            </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// 1kHz å‘å¸ƒå®šæ—¶å™¨</span>
<span class="w">        </span><span class="n">timer_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">create_wall_timer</span><span class="p">(</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">chrono</span><span class="o">::</span><span class="n">milliseconds</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="w">            </span><span class="p">[</span><span class="k">this</span><span class="p">]()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">auto</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std_msgs</span><span class="o">::</span><span class="n">msg</span><span class="o">::</span><span class="n">Header</span><span class="p">();</span>
<span class="w">                </span><span class="n">msg</span><span class="p">.</span><span class="n">stamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">now</span><span class="p">();</span>
<span class="w">                </span><span class="n">publisher_</span><span class="o">-&gt;</span><span class="n">publish</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<p><strong>æµ‹è¯•ç»“æœ</strong>ï¼š</p>
<p>| æŒ‡æ ‡ | Cyclone DDS | Fast DDS | Connext DDS |</p>
<table>
<thead>
<tr>
<th>æŒ‡æ ‡</th>
<th>Cyclone DDS</th>
<th>Fast DDS</th>
<th>Connext DDS</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>å¹³å‡å»¶è¿Ÿ</strong></td>
<td>45Î¼s</td>
<td>62Î¼s</td>
<td>38Î¼s</td>
</tr>
<tr>
<td><strong>P99 å»¶è¿Ÿ</strong></td>
<td>89Î¼s</td>
<td>145Î¼s</td>
<td>72Î¼s</td>
</tr>
<tr>
<td><strong>æœ€å¤§å»¶è¿Ÿ</strong></td>
<td>210Î¼s</td>
<td>520Î¼s</td>
<td>180Î¼s</td>
</tr>
<tr>
<td><strong>CPU ä½¿ç”¨ç‡</strong></td>
<td>8%</td>
<td>12%</td>
<td>10%</td>
</tr>
<tr>
<td><strong>å†…å­˜å ç”¨</strong></td>
<td>45MB</td>
<td>78MB</td>
<td>95MB</td>
</tr>
<tr>
<td><strong>å¯åŠ¨æ—¶é—´</strong></td>
<td>0.8s</td>
<td>1.2s</td>
<td>2.1s</td>
</tr>
</tbody>
</table>
<p><strong>ä¸åŒæ¶ˆæ¯å¤§å°çš„å¯¹æ¯”</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="err">æ¶ˆæ¯å¤§å°</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="n">KB</span>
<span class="err">â”œâ”€</span><span class="w"> </span><span class="n">Cyclone</span><span class="w"> </span><span class="n">DDS</span><span class="o">:</span><span class="w"> </span><span class="mi">48</span><span class="err">Î¼</span><span class="n">s</span><span class="w"> </span><span class="o">(</span><span class="n">avg</span><span class="o">),</span><span class="w"> </span><span class="mi">12</span><span class="n">Mbps</span>
<span class="err">â”œâ”€</span><span class="w"> </span><span class="n">Fast</span><span class="w"> </span><span class="n">DDS</span><span class="o">:</span><span class="w"> </span><span class="mi">65</span><span class="err">Î¼</span><span class="n">s</span><span class="w"> </span><span class="o">(</span><span class="n">avg</span><span class="o">),</span><span class="w"> </span><span class="mi">11</span><span class="n">Mbps</span>
<span class="err">â””â”€</span><span class="w"> </span><span class="n">Connext</span><span class="w"> </span><span class="n">DDS</span><span class="o">:</span><span class="w"> </span><span class="mi">41</span><span class="err">Î¼</span><span class="n">s</span><span class="w"> </span><span class="o">(</span><span class="n">avg</span><span class="o">),</span><span class="w"> </span><span class="mi">13</span><span class="n">Mbps</span>

<span class="err">æ¶ˆæ¯å¤§å°</span><span class="o">:</span><span class="w"> </span><span class="mi">1</span><span class="n">MB</span>
<span class="err">â”œâ”€</span><span class="w"> </span><span class="n">Cyclone</span><span class="w"> </span><span class="n">DDS</span><span class="o">:</span><span class="w"> </span><span class="mi">820</span><span class="err">Î¼</span><span class="n">s</span><span class="w"> </span><span class="o">(</span><span class="n">avg</span><span class="o">),</span><span class="w"> </span><span class="mi">980</span><span class="n">Mbps</span>
<span class="err">â”œâ”€</span><span class="w"> </span><span class="n">Fast</span><span class="w"> </span><span class="n">DDS</span><span class="o">:</span><span class="w"> </span><span class="mi">1100</span><span class="err">Î¼</span><span class="n">s</span><span class="w"> </span><span class="o">(</span><span class="n">avg</span><span class="o">),</span><span class="w"> </span><span class="mi">890</span><span class="n">Mbps</span>
<span class="err">â””â”€</span><span class="w"> </span><span class="n">Connext</span><span class="w"> </span><span class="n">DDS</span><span class="o">:</span><span class="w"> </span><span class="mi">750</span><span class="err">Î¼</span><span class="n">s</span><span class="w"> </span><span class="o">(</span><span class="n">avg</span><span class="o">),</span><span class="w"> </span><span class="mi">1050</span><span class="n">Mbps</span>

<span class="err">æ¶ˆæ¯å¤§å°</span><span class="o">:</span><span class="w"> </span><span class="mi">10</span><span class="n">MB</span>
<span class="err">â”œâ”€</span><span class="w"> </span><span class="n">Cyclone</span><span class="w"> </span><span class="n">DDS</span><span class="o">:</span><span class="w"> </span><span class="mi">12</span><span class="n">ms</span><span class="w"> </span><span class="o">(</span><span class="n">avg</span><span class="o">),</span><span class="w"> </span><span class="mi">820</span><span class="n">Mbps</span>
<span class="err">â”œâ”€</span><span class="w"> </span><span class="n">Fast</span><span class="w"> </span><span class="n">DDS</span><span class="o">:</span><span class="w"> </span><span class="mi">18</span><span class="n">ms</span><span class="w"> </span><span class="o">(</span><span class="n">avg</span><span class="o">),</span><span class="w"> </span><span class="mi">680</span><span class="n">Mbps</span>
<span class="err">â””â”€</span><span class="w"> </span><span class="n">Connext</span><span class="w"> </span><span class="n">DDS</span><span class="o">:</span><span class="w"> </span><span class="mi">10</span><span class="n">ms</span><span class="w"> </span><span class="o">(</span><span class="n">avg</span><span class="o">),</span><span class="w"> </span><span class="mi">920</span><span class="n">Mbps</span>
</code></pre></div>

<h3 id="1562-dpdk">15.6.2 ç¡¬ä»¶åŠ é€Ÿä¸ DPDK é›†æˆ</h3>
<p><strong>DPDK (Data Plane Development Kit) é›†æˆ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨ DPDK åŠ é€Ÿç½‘ç»œé€šä¿¡</span>
<span class="k">class</span><span class="w"> </span><span class="nc">DpdkAcceleratedNode</span><span class="w"> </span><span class="p">{</span>
<span class="k">private</span><span class="o">:</span>
<span class="w">    </span><span class="k">struct</span><span class="w"> </span><span class="nc">rte_mempool</span><span class="o">*</span><span class="w"> </span><span class="n">mbuf_pool_</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint16_t</span><span class="w"> </span><span class="n">port_id_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="k">public</span><span class="o">:</span>
<span class="w">    </span><span class="n">DpdkAcceleratedNode</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// åˆå§‹åŒ– DPDK</span>
<span class="w">        </span><span class="n">rte_eal_init</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// åˆ›å»ºå†…å­˜æ± </span>
<span class="w">        </span><span class="n">mbuf_pool_</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rte_pktmbuf_pool_create</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;MBUF_POOL&quot;</span><span class="p">,</span><span class="w"> </span><span class="mi">8192</span><span class="p">,</span>
<span class="w">            </span><span class="n">MBUF_CACHE_SIZE</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="n">RTE_MBUF_DEFAULT_BUF_SIZE</span><span class="p">,</span>
<span class="w">            </span><span class="n">rte_socket_id</span><span class="p">());</span>

<span class="w">        </span><span class="c1">// é…ç½®ç«¯å£</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">rte_eth_conf</span><span class="w"> </span><span class="n">port_conf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{};</span>
<span class="w">        </span><span class="n">rte_eth_dev_configure</span><span class="p">(</span><span class="n">port_id_</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">port_conf</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="n">sendPacket</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="kt">uint8_t</span><span class="o">*</span><span class="w"> </span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="kt">size_t</span><span class="w"> </span><span class="n">len</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">struct</span><span class="w"> </span><span class="nc">rte_mbuf</span><span class="o">*</span><span class="w"> </span><span class="n">mbuf</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rte_pktmbuf_alloc</span><span class="p">(</span><span class="n">mbuf_pool_</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// é›¶æ‹·è´æ•°æ®ä¼ è¾“</span>
<span class="w">        </span><span class="n">rte_pktmbuf_attach_extbuf</span><span class="p">(</span><span class="n">mbuf</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">,</span><span class="w"> </span>
<span class="w">            </span><span class="n">rte_malloc_virt2iova</span><span class="p">(</span><span class="n">data</span><span class="p">),</span><span class="w"> </span><span class="n">len</span><span class="p">,</span><span class="w"> </span><span class="k">nullptr</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// å‘é€æ•°æ®åŒ…</span>
<span class="w">        </span><span class="n">rte_eth_tx_burst</span><span class="p">(</span><span class="n">port_id_</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mbuf</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">};</span>
</code></pre></div>

<h3 id="1563-paper-reading-guide">15.6.3 Paper Reading Guide</h3>
<p><strong>å¿…è¯»è®ºæ–‡</strong>ï¼š</p>
<ol>
<li>
<p><strong>"Design and Performance Evaluation of a ROS2 Compliant Real-time Control Architecture"</strong> (2021)
   - ä½œè€…ï¼šPuck et al.
   - è´¡çŒ®ï¼šæå‡ºäº† ROS2 å®æ—¶æ§åˆ¶æ¶æ„è®¾è®¡æ¨¡å¼
   - å…³é”®ç‚¹ï¼šæ‰§è¡Œå™¨è®¾è®¡ã€å†…å­˜ç®¡ç†ã€è°ƒåº¦ç­–ç•¥</p>
</li>
<li>
<p><strong>"Towards Real-time Robot Control with ROS2: A Comparative Study"</strong> (2020)
   - ä½œè€…ï¼šKronauer et al.
   - è´¡çŒ®ï¼šä¸åŒ DDS å®ç°çš„ç³»ç»Ÿæ€§å¯¹æ¯”
   - å…³é”®ç‚¹ï¼šå»¶è¿Ÿæµ‹é‡æ–¹æ³•ã€QoS é…ç½®å½±å“</p>
</li>
<li>
<p><strong>"Deterministic Memory Allocation for Real-time Robot Control"</strong> (2022)
   - ä½œè€…ï¼šWei et al.
   - è´¡çŒ®ï¼šå®æ—¶å†…å­˜åˆ†é…å™¨è®¾è®¡
   - å…³é”®ç‚¹ï¼šå†…å­˜æ± ç®¡ç†ã€ç¢ç‰‡åŒ–é¿å…</p>
</li>
</ol>
<h3 id="1564">15.6.4 å¼€æºé¡¹ç›®æ¨è</h3>
<ol>
<li><strong>realtime_tools</strong>ï¼šROS2 å®æ—¶å·¥å…·é›†</li>
</ol>
<div class="codehilite"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/ros-controls/realtime_tools
</code></pre></div>

<ol start="2">
<li><strong>ros2_control</strong>ï¼šå®æ—¶æ§åˆ¶æ¡†æ¶</li>
</ol>
<div class="codehilite"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/ros-controls/ros2_control
</code></pre></div>

<ol start="3">
<li><strong>performance_test</strong>ï¼šæ€§èƒ½æµ‹è¯•å·¥å…·</li>
</ol>
<div class="codehilite"><pre><span></span><code>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/ApexAI/performance_test
</code></pre></div>

<h2 id="157">15.7 æœ¬ç« å°ç»“</h2>
<p>æœ¬ç« æ·±å…¥æ¢è®¨äº† ROS2 å®æ—¶ç³»ç»Ÿä¼˜åŒ–çš„å…³é”®æŠ€æœ¯ï¼š</p>
<p><strong>æ ¸å¿ƒæ¦‚å¿µ</strong>ï¼š</p>
<ul>
<li>ç¡¬å®æ—¶ vs è½¯å®æ—¶çš„åŒºåˆ«ä¸åº”ç”¨åœºæ™¯</li>
<li>PREEMPT-RT å†…æ ¸çš„é…ç½®ä¸è°ƒä¼˜</li>
<li>å®æ—¶è°ƒåº¦ç­–ç•¥ï¼ˆSCHED_FIFOã€SCHED_RRã€SCHED_DEADLINEï¼‰</li>
</ul>
<p><strong>å…³é”®å…¬å¼</strong>ï¼š</p>
<ol>
<li>
<p><strong>å»¶è¿Ÿè®¡ç®—</strong>ï¼š
   $$L_{total} = L_{kernel} + L_{scheduler} + L_{network} + L_{application}$$</p>
</li>
<li>
<p><strong>æŠ–åŠ¨ï¼ˆJitterï¼‰</strong>ï¼š
$$J = \max(T_i) - \min(T_i), \quad i \in [1, n]$$</p>
</li>
<li>
<p><strong>CPU åˆ©ç”¨ç‡ç•Œé™ï¼ˆRate Monotonicï¼‰</strong>ï¼š
$$U = \sum_{i=1}^{n} \frac{C_i}{T_i} \leq n(2^{1/n} - 1)$$
å…¶ä¸­ $C_i$ æ˜¯ä»»åŠ¡æ‰§è¡Œæ—¶é—´ï¼Œ$T_i$ æ˜¯ä»»åŠ¡å‘¨æœŸ</p>
</li>
<li>
<p><strong>å†…å­˜å¸¦å®½éœ€æ±‚</strong>ï¼š
$$BW = \frac{Message_Size \times Frequency}{Zero_Copy_Factor}$$</p>
</li>
</ol>
<p><strong>æ€§èƒ½ä¼˜åŒ–è¦ç‚¹</strong>ï¼š</p>
<ul>
<li>å†…å­˜é¢„åˆ†é…å’Œé›¶æ‹·è´é€šä¿¡</li>
<li>DDS QoS ç­–ç•¥ä¼˜åŒ–</li>
<li>CPU éš”ç¦»ä¸äº²å’Œæ€§è®¾ç½®</li>
<li>ç³»ç»Ÿçº§æ€§èƒ½åˆ†æå·¥å…·ä½¿ç”¨</li>
</ul>
<h2 id="158">15.8 ç»ƒä¹ é¢˜</h2>
<h3 id="_1">åŸºç¡€é¢˜</h3>
<p><strong>ç»ƒä¹  15.1</strong>ï¼šé…ç½®å®æ—¶å†…æ ¸
è®¾è®¡ä¸€ä¸ª bash è„šæœ¬ï¼Œè‡ªåŠ¨æ£€æµ‹ç³»ç»Ÿæ˜¯å¦å®‰è£…äº† PREEMPT-RT å†…æ ¸ï¼Œå¹¶æŠ¥å‘Šå½“å‰çš„å®æ—¶æ€§é…ç½®çŠ¶æ€ã€‚</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>è„šæœ¬åº”æ£€æŸ¥ï¼š</p>
<ol>
<li><code>uname -v</code> è¾“å‡ºä¸­æ˜¯å¦åŒ…å« "PREEMPT_RT"</li>
<li><code>/proc/sys/kernel/sched_rt_runtime_us</code> çš„å€¼</li>
<li>CPU éš”ç¦»é…ç½®ï¼ˆ/proc/cmdline ä¸­çš„ isolcpusï¼‰</li>
<li>å†…å­˜é”å®šé™åˆ¶ï¼ˆulimit -lï¼‰</li>
</ol>
<p>å…³é”®æ£€æŸ¥ç‚¹ï¼š</p>
<ul>
<li>RT å†…æ ¸ç‰ˆæœ¬</li>
<li>å®æ—¶è°ƒåº¦å™¨é…ç½®</li>
<li>CPU æ ¸å¿ƒåˆ†é…</li>
<li>å†…å­˜é™åˆ¶è®¾ç½®</li>
</ul>
</details>
<p><strong>ç»ƒä¹  15.2</strong>ï¼šQoS ç­–ç•¥é€‰æ‹©
ç»™å®šä»¥ä¸‹åœºæ™¯ï¼Œé€‰æ‹©åˆé€‚çš„ QoS é…ç½®ï¼š
a) æœºæ¢°è‡‚åŠ›æ§åˆ¶ï¼ˆ1kHzï¼‰
b) è§†è§‰æ•°æ®æµï¼ˆ30Hzï¼Œæ¯å¸§ 2MBï¼‰
c) çŠ¶æ€ç›‘æ§ï¼ˆ1Hzï¼‰</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>a) æœºæ¢°è‡‚åŠ›æ§åˆ¶ï¼š</p>
<ul>
<li>Reliability: BEST_EFFORT</li>
<li>Durability: VOLATILE</li>
<li>History: KEEP_LAST(1)</li>
<li>Deadline: 1ms</li>
</ul>
<p>b) è§†è§‰æ•°æ®æµï¼š</p>
<ul>
<li>Reliability: BEST_EFFORT</li>
<li>Durability: VOLATILE</li>
<li>History: KEEP_LAST(2)</li>
<li>ä½¿ç”¨é›¶æ‹·è´ä¼ è¾“</li>
</ul>
<p>c) çŠ¶æ€ç›‘æ§ï¼š</p>
<ul>
<li>Reliability: RELIABLE</li>
<li>Durability: TRANSIENT_LOCAL</li>
<li>History: KEEP_LAST(10)</li>
</ul>
</details>
<p><strong>ç»ƒä¹  15.3</strong>ï¼šå»¶è¿Ÿæµ‹é‡
ç¼–å†™ä¸€ä¸ª ROS2 èŠ‚ç‚¹ï¼Œæµ‹é‡è¯é¢˜é€šä¿¡çš„å¾€è¿”å»¶è¿Ÿï¼ˆRTTï¼‰ï¼Œå¹¶è®¡ç®—å¹³å‡å€¼ã€æœ€å¤§å€¼ã€æœ€å°å€¼å’Œæ ‡å‡†å·®ã€‚</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>å…³é”®å®ç°è¦ç‚¹ï¼š</p>
<ol>
<li>ä½¿ç”¨é«˜ç²¾åº¦æ—¶é’Ÿï¼ˆstd::chrono::high_resolution_clockï¼‰</li>
<li>åœ¨æ¶ˆæ¯ä¸­åµŒå…¥æ—¶é—´æˆ³</li>
<li>è®¡ç®—æ¥æ”¶æ—¶é—´ä¸å‘é€æ—¶é—´çš„å·®å€¼</li>
<li>ä½¿ç”¨å¾ªç¯ç¼“å†²åŒºå­˜å‚¨æœ€è¿‘ N ä¸ªæµ‹é‡å€¼</li>
<li>å®æ—¶è®¡ç®—ç»Ÿè®¡æŒ‡æ ‡</li>
<li>è€ƒè™‘æ—¶é’ŸåŒæ­¥é—®é¢˜</li>
</ol>
</details>
<p><strong>ç»ƒä¹  15.4</strong>ï¼šå†…å­˜æ± è®¾è®¡
è®¾è®¡ä¸€ä¸ªå›ºå®šå¤§å°çš„å†…å­˜æ± åˆ†é…å™¨ï¼Œæ”¯æŒ O(1) çš„åˆ†é…å’Œé‡Šæ”¾æ“ä½œã€‚</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>è®¾è®¡è¦ç‚¹ï¼š</p>
<ol>
<li>ä½¿ç”¨è‡ªç”±é“¾è¡¨ç®¡ç†ç©ºé—²å—</li>
<li>é¢„åˆ†é…è¿ç»­å†…å­˜åŒºåŸŸ</li>
<li>æ¯ä¸ªå—åŒ…å«æŒ‡å‘ä¸‹ä¸€ä¸ªç©ºé—²å—çš„æŒ‡é’ˆ</li>
<li>åˆ†é…ï¼šä»é“¾è¡¨å¤´å–å‡º</li>
<li>é‡Šæ”¾ï¼šæ’å…¥é“¾è¡¨å¤´</li>
<li>çº¿ç¨‹å®‰å…¨ï¼šä½¿ç”¨æ— é”é˜Ÿåˆ—æˆ–äº’æ–¥é”</li>
</ol>
</details>
<h3 id="_2">æŒ‘æˆ˜é¢˜</h3>
<p><strong>ç»ƒä¹  15.5</strong>ï¼šå¤šæ ¸ä¼˜åŒ–
è®¾è®¡ä¸€ä¸ªå¤šç”Ÿäº§è€…-å¤šæ¶ˆè´¹è€…ç³»ç»Ÿï¼Œä½¿ç”¨æ— é”é˜Ÿåˆ—åœ¨ 4 ä¸ª CPU æ ¸å¿ƒé—´ä¼ é€’æ•°æ®ï¼Œå®ç°æœ€å°å»¶è¿Ÿã€‚</p>
<p><em>æç¤º</em>ï¼šè€ƒè™‘ SPSC é˜Ÿåˆ—ç»„åˆã€ç¼“å­˜è¡Œå¯¹é½ã€NUMA äº²å’Œæ€§</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä¼˜åŒ–ç­–ç•¥ï¼š</p>
<ol>
<li>ä½¿ç”¨ SPSC æ— é”é˜Ÿåˆ—çŸ©é˜µï¼ˆ4x4ï¼‰</li>
<li>æ¯ä¸ªé˜Ÿåˆ—ç¼“å­˜è¡Œå¯¹é½ï¼ˆ64 å­—èŠ‚ï¼‰</li>
<li>ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…ç»‘å®šåˆ°ç‰¹å®šæ ¸å¿ƒ</li>
<li>ä½¿ç”¨ memory_order_relaxed è¿›è¡ŒåŸå­æ“ä½œ</li>
<li>æ‰¹é‡å¤„ç†å‡å°‘åŒæ­¥å¼€é”€</li>
<li>è€ƒè™‘ NUMA èŠ‚ç‚¹çš„å†…å­˜åˆ†é…</li>
</ol>
</details>
<p><strong>ç»ƒä¹  15.6</strong>ï¼šå®æ—¶æ€§èƒ½è¯Šæ–­
æŸæœºå™¨äººç³»ç»Ÿå¶å°”å‡ºç°æ§åˆ¶å»¶è¿Ÿå³°å€¼ï¼ˆä»å¹³å‡ 200Î¼s çªå¢åˆ° 5msï¼‰ã€‚è®¾è®¡ä¸€ä¸ªè¯Šæ–­æ–¹æ¡ˆæ‰¾å‡ºåŸå› ã€‚</p>
<p><em>æç¤º</em>ï¼šè€ƒè™‘å†…æ ¸è·Ÿè¸ªã€ä¸­æ–­ç»Ÿè®¡ã€å†…å­˜åˆ†é…</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>è¯Šæ–­æ­¥éª¤ï¼š</p>
<ol>
<li>ä½¿ç”¨ ftrace è·Ÿè¸ªå»¶è¿Ÿå³°å€¼æ—¶çš„å†…æ ¸æ´»åŠ¨</li>
<li>æ£€æŸ¥ /proc/interrupts ä¸­çš„ä¸­æ–­åˆ†å¸ƒ</li>
<li>ä½¿ç”¨ perf ç›‘æ§é¡µé¢é”™è¯¯å’Œç¼“å­˜æœªå‘½ä¸­</li>
<li>æ£€æŸ¥æ˜¯å¦æœ‰å†…å­˜åˆ†é…æˆ–åƒåœ¾å›æ”¶</li>
<li>åˆ†æ DDS çš„é‡ä¼ å’Œå‘ç°æœºåˆ¶</li>
<li>æ£€æŸ¥ CPU é¢‘ç‡è°ƒèŠ‚å’Œçƒ­èŠ‚æµ</li>
</ol>
<p>å¯èƒ½åŸå› ï¼š</p>
<ul>
<li>å†…æ ¸æŠ¢å è¢«ç¦ç”¨çš„ä»£ç è·¯å¾„</li>
<li>SMIï¼ˆç³»ç»Ÿç®¡ç†ä¸­æ–­ï¼‰</li>
<li>å†…å­˜é¡µé¢é”™è¯¯</li>
<li>DDS å‘ç°é£æš´</li>
<li>CPU çƒ­èŠ‚æµ</li>
</ul>
</details>
<p><strong>ç»ƒä¹  15.7</strong>ï¼šç«¯åˆ°ç«¯ä¼˜åŒ–
ä¼˜åŒ–ä¸€ä¸ªè§†è§‰ä¼ºæœç³»ç»Ÿï¼Œå°†"ç›¸æœºé‡‡é›†â†’å¤„ç†â†’æ§åˆ¶è¾“å‡º"çš„ç«¯åˆ°ç«¯å»¶è¿Ÿä» 50ms é™ä½åˆ° 10msã€‚</p>
<p><em>æç¤º</em>ï¼šåˆ†ææ¯ä¸ªé˜¶æ®µçš„è€—æ—¶ï¼Œè¯†åˆ«ç“¶é¢ˆ</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>ä¼˜åŒ–æ–¹æ¡ˆï¼š</p>
<ol>
<li>
<p><strong>ç›¸æœºé‡‡é›†</strong>ï¼ˆåŸ 20ms â†’ 3msï¼‰ï¼š
   - ä½¿ç”¨ç¡¬ä»¶è§¦å‘
   - é›¶æ‹·è´ DMA ä¼ è¾“
   - é™ä½æ›å…‰æ—¶é—´</p>
</li>
<li>
<p><strong>å›¾åƒå¤„ç†</strong>ï¼ˆåŸ 25ms â†’ 5msï¼‰ï¼š
   - GPU åŠ é€Ÿï¼ˆCUDA/OpenCLï¼‰
   - å¹¶è¡ŒåŒ–ç®—æ³•
   - é™ä½å›¾åƒåˆ†è¾¨ç‡æˆ– ROI å¤„ç†</p>
</li>
<li>
<p><strong>æ§åˆ¶è®¡ç®—</strong>ï¼ˆåŸ 5ms â†’ 2msï¼‰ï¼š
   - é¢„è®¡ç®—æŸ¥æ‰¾è¡¨
   - SIMD ä¼˜åŒ–
   - é¿å…åŠ¨æ€å†…å­˜åˆ†é…</p>
</li>
<li>
<p><strong>ç³»ç»Ÿçº§ä¼˜åŒ–</strong>ï¼š
   - æµæ°´çº¿å¹¶è¡Œå¤„ç†
   - é¢„æµ‹æ€§è®¡ç®—
   - ç¡¬ä»¶æ—¶é—´åŒæ­¥</p>
</li>
</ol>
</details>
<p><strong>ç»ƒä¹  15.8</strong>ï¼šDDS å®ç°é€‰å‹
ä¸ºä»¥ä¸‹åº”ç”¨åœºæ™¯é€‰æ‹©æœ€é€‚åˆçš„ DDS å®ç°å¹¶è¯´æ˜ç†ç”±ï¼š
a) ä½å»¶è¿Ÿäº¤æ˜“æœºå™¨äºº
b) å¤§è§„æ¨¡ä¼ æ„Ÿå™¨ç½‘ç»œ
c) åµŒå…¥å¼å®æ—¶æ§åˆ¶</p>
<details>
<summary>ç­”æ¡ˆ</summary>
<p>a) <strong>ä½å»¶è¿Ÿäº¤æ˜“æœºå™¨äºº</strong>ï¼šConnext DDS</p>
<ul>
<li>æœ€ä½çš„å¹³å‡å»¶è¿Ÿ</li>
<li>æ”¯æŒç¡¬ä»¶åŠ é€Ÿ</li>
<li>ä¸°å¯Œçš„ QoS é…ç½®</li>
</ul>
<p>b) <strong>å¤§è§„æ¨¡ä¼ æ„Ÿå™¨ç½‘ç»œ</strong>ï¼šCyclone DDS</p>
<ul>
<li>è½»é‡çº§å®ç°</li>
<li>ä¼˜ç§€çš„å¯æ‰©å±•æ€§</li>
<li>è¾ƒä½çš„å†…å­˜å ç”¨</li>
</ul>
<p>c) <strong>åµŒå…¥å¼å®æ—¶æ§åˆ¶</strong>ï¼šMicro-ROS (embeddedRTPS)</p>
<ul>
<li>æœ€å°çš„å†…å­˜å ç”¨</li>
<li>æ”¯æŒ MCU å¹³å°</li>
<li>å¯è£å‰ªçš„åŠŸèƒ½é›†</li>
</ul>
</details>
<h2 id="159">15.9 å¸¸è§é™·é˜±ä¸é”™è¯¯</h2>
<h3 id="1">é™·é˜± 1ï¼šä¼˜å…ˆçº§åè½¬</h3>
<p><strong>é—®é¢˜</strong>ï¼šä½ä¼˜å…ˆçº§ä»»åŠ¡æŒæœ‰é«˜ä¼˜å…ˆçº§ä»»åŠ¡éœ€è¦çš„èµ„æºï¼Œå¯¼è‡´é«˜ä¼˜å…ˆçº§ä»»åŠ¡è¢«é˜»å¡ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// ä½¿ç”¨ä¼˜å…ˆçº§ç»§æ‰¿äº’æ–¥é”</span>
<span class="n">pthread_mutexattr_t</span><span class="w"> </span><span class="n">attr</span><span class="p">;</span>
<span class="n">pthread_mutexattr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
<span class="n">pthread_mutexattr_setprotocol</span><span class="p">(</span><span class="o">&amp;</span><span class="n">attr</span><span class="p">,</span><span class="w"> </span><span class="n">PTHREAD_PRIO_INHERIT</span><span class="p">);</span>
<span class="n">pthread_mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mutex</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">attr</span><span class="p">);</span>
</code></pre></div>

<h3 id="2">é™·é˜± 2ï¼šå†…å­˜é¡µé¢é”™è¯¯</h3>
<p><strong>é—®é¢˜</strong>ï¼šé¦–æ¬¡è®¿é—®æœªæ˜ å°„çš„å†…å­˜é¡µé¢å¯¼è‡´å»¶è¿Ÿå³°å€¼ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1">// é¢„è§¦æ‘¸æ‰€æœ‰å†…å­˜é¡µé¢</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">prefaultStack</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="n">dummy</span><span class="p">[</span><span class="mi">8192</span><span class="p">];</span>
<span class="w">    </span><span class="n">memset</span><span class="p">(</span><span class="n">dummy</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">dummy</span><span class="p">));</span>
<span class="p">}</span>

<span class="c1">// é”å®šå†…å­˜é˜²æ­¢äº¤æ¢</span>
<span class="n">mlockall</span><span class="p">(</span><span class="n">MCL_CURRENT</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">MCL_FUTURE</span><span class="p">);</span>
</code></pre></div>

<h3 id="3dds">é™·é˜± 3ï¼šDDS å‘ç°é£æš´</h3>
<p><strong>é—®é¢˜</strong>ï¼šå¤§é‡èŠ‚ç‚¹åŒæ—¶å¯åŠ¨å¯¼è‡´ç½‘ç»œæ‹¥å¡ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<ul>
<li>ä½¿ç”¨ Discovery Server æ›¿ä»£å¤šæ’­å‘ç°</li>
<li>é…ç½®å‘ç°åè®®çš„æ—¶é—´å‚æ•°</li>
<li>å®æ–½åˆ†é˜¶æ®µå¯åŠ¨ç­–ç•¥</li>
</ul>
<h3 id="4">é™·é˜± 4ï¼šæ—¶é’Ÿä¸åŒæ­¥</h3>
<p><strong>é—®é¢˜</strong>ï¼šåˆ†å¸ƒå¼ç³»ç»Ÿä¸­æ—¶é’Ÿåå·®å¯¼è‡´æ—¶åºé”™è¯¯ã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<ul>
<li>éƒ¨ç½² PTP (Precision Time Protocol)</li>
<li>ä½¿ç”¨ç¡¬ä»¶æ—¶é—´æˆ³</li>
<li>å®ç°æ—¶é’ŸåŒæ­¥ç›‘æ§</li>
</ul>
<h3 id="5cpu">é™·é˜± 5ï¼šCPU é¢‘ç‡è°ƒèŠ‚</h3>
<p><strong>é—®é¢˜</strong>ï¼šCPU åŠ¨æ€è°ƒé¢‘å¯¼è‡´æ€§èƒ½ä¸ç¨³å®šã€‚</p>
<p><strong>è§£å†³æ–¹æ¡ˆ</strong>ï¼š</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># è®¾ç½® CPU ä¸ºæ€§èƒ½æ¨¡å¼</span>
cpupower<span class="w"> </span>frequency-set<span class="w"> </span>-g<span class="w"> </span>performance

<span class="c1"># ç¦ç”¨ Intel Turbo Boost</span>
<span class="nb">echo</span><span class="w"> </span><span class="m">1</span><span class="w"> </span>&gt;<span class="w"> </span>/sys/devices/system/cpu/intel_pstate/no_turbo
</code></pre></div>

<h2 id="1510">15.10 æœ€ä½³å®è·µæ£€æŸ¥æ¸…å•</h2>
<h3 id="_3">è®¾è®¡é˜¶æ®µ</h3>
<ul>
<li>[ ] æ˜ç¡®å®šä¹‰å®æ—¶æ€§éœ€æ±‚ï¼ˆç¡¬å®æ—¶/è½¯å®æ—¶ï¼‰</li>
<li>[ ] è¯†åˆ«å…³é”®è·¯å¾„å’Œæ€§èƒ½ç“¶é¢ˆ</li>
<li>[ ] é€‰æ‹©åˆé€‚çš„ç¡¬ä»¶å¹³å°</li>
<li>[ ] è®¾è®¡ç¡®å®šæ€§çš„ç®—æ³•</li>
<li>[ ] è§„åˆ’å†…å­˜ä½¿ç”¨å’Œåˆ†é…ç­–ç•¥</li>
</ul>
<h3 id="_4">å®ç°é˜¶æ®µ</h3>
<ul>
<li>[ ] ä½¿ç”¨å®æ—¶å†…æ ¸ï¼ˆPREEMPT-RTï¼‰</li>
<li>[ ] é…ç½® CPU éš”ç¦»å’Œäº²å’Œæ€§</li>
<li>[ ] å®ç°å†…å­˜é¢„åˆ†é…</li>
<li>[ ] ä½¿ç”¨é›¶æ‹·è´é€šä¿¡</li>
<li>[ ] é€‰æ‹©åˆé€‚çš„ DDS å®ç°å’Œ QoS é…ç½®</li>
<li>[ ] é¿å…åŠ¨æ€å†…å­˜åˆ†é…</li>
<li>[ ] ä½¿ç”¨æ— é”æ•°æ®ç»“æ„</li>
</ul>
<h3 id="_5">æµ‹è¯•é˜¶æ®µ</h3>
<ul>
<li>[ ] æµ‹é‡æœ€åæƒ…å†µæ‰§è¡Œæ—¶é—´ï¼ˆWCETï¼‰</li>
<li>[ ] è¿›è¡Œé•¿æ—¶é—´ç¨³å®šæ€§æµ‹è¯•</li>
<li>[ ] æµ‹è¯•å„ç§è´Ÿè½½æ¡ä»¶</li>
<li>[ ] éªŒè¯æ•…éšœæ¢å¤æœºåˆ¶</li>
<li>[ ] è®°å½•æ€§èƒ½åŸºå‡†æ•°æ®</li>
</ul>
<h3 id="_6">éƒ¨ç½²é˜¶æ®µ</h3>
<ul>
<li>[ ] é…ç½®ç³»ç»Ÿå‚æ•°ï¼ˆå†…æ ¸ã€ç½‘ç»œï¼‰</li>
<li>[ ] å®æ–½ç›‘æ§å’Œå‘Šè­¦</li>
<li>[ ] å‡†å¤‡æ€§èƒ½è°ƒè¯•å·¥å…·</li>
<li>[ ] æ–‡æ¡£åŒ–é…ç½®å’Œè°ƒä¼˜å‚æ•°</li>
<li>[ ] å»ºç«‹æ€§èƒ½å›å½’æµ‹è¯•</li>
</ul>
<h3 id="_7">ç»´æŠ¤é˜¶æ®µ</h3>
<ul>
<li>[ ] å®šæœŸæ€§èƒ½å®¡æŸ¥</li>
<li>[ ] ç›‘æ§ç³»ç»ŸæŒ‡æ ‡</li>
<li>[ ] æ›´æ–°å’Œä¼˜åŒ–é…ç½®</li>
<li>[ ] è·Ÿè¸ªæ€§èƒ½é€€åŒ–</li>
<li>[ ] ä¿æŒæ–‡æ¡£æ›´æ–°</li>
</ul>
            </article>
            
            <nav class="page-nav"><a href="chapter14.html" class="nav-link prev">â† ç¬¬ 14 ç« ï¼šMoveIt2 è¿åŠ¨è§„åˆ’</a><a href="chapter16.html" class="nav-link next">ç¬¬ 16 ç« ï¼šå®‰å…¨æ€§ä¸è¯Šæ–­ç³»ç»Ÿ â†’</a></nav>
        </main>
    </div>
</body>
</html>